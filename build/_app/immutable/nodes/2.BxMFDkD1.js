import{T as ks,i as Aa,L as ss,r as k_,N as Ia,d as Di,a as Os,K as Fc,O as Ca,Z as Ap,F as ao,c as Sp,D as En,V as ME,o as J_,b as Q_,s as IE,e as zl,_ as Hh,M as CE,$ as B_,t as xx,W as AE,a0 as SE,a1 as PE}from"../chunks/disclose-version.CccwOmTt.js";import{p as Sa,a as Pa,l as Tn,h as Br,$ as jc,u as lo,j as pn}from"../chunks/runtime.Ch61WCaa.js";import{u as LE,a as DE,s as zE}from"../chunks/store.VCXucVei.js";import{a as RE,e as F_}from"../chunks/each.DJas7fU6.js";import{o as Pp}from"../chunks/main-client.XUdVwPDQ.js";import{w as OE}from"../chunks/index.B-5YvJxK.js";function cp(y,E){return y==null||E==null?NaN:y<E?-1:y>E?1:y>=E?0:NaN}function kE(y,E){return y==null||E==null?NaN:E<y?-1:E>y?1:E>=y?0:NaN}function iv(y){let E,A,L;y.length!==2?(E=cp,A=(ee,s)=>cp(y(ee),s),L=(ee,s)=>y(ee)-s):(E=y===cp||y===kE?y:BE,A=y,L=y);function k(ee,s,te=0,ae=ee.length){if(te<ae){if(E(s,s)!==0)return ae;do{const se=te+ae>>>1;A(ee[se],s)<0?te=se+1:ae=se}while(te<ae)}return te}function Z(ee,s,te=0,ae=ee.length){if(te<ae){if(E(s,s)!==0)return ae;do{const se=te+ae>>>1;A(ee[se],s)<=0?te=se+1:ae=se}while(te<ae)}return te}function Y(ee,s,te=0,ae=ee.length){const se=k(ee,s,te,ae-1);return se>te&&L(ee[se-1],s)>-L(ee[se],s)?se-1:se}return{left:k,center:Y,right:Z}}function BE(){return 0}function FE(y){return y===null?NaN:+y}const NE=iv(cp),UE=NE.right;iv(FE).center;class N_ extends Map{constructor(E,A=ZE){if(super(),Object.defineProperties(this,{_intern:{value:new Map},_key:{value:A}}),E!=null)for(const[L,k]of E)this.set(L,k)}get(E){return super.get(vx(this,E))}has(E){return super.has(vx(this,E))}set(E,A){return super.set(VE(this,E),A)}delete(E){return super.delete(jE(this,E))}}function vx({_intern:y,_key:E},A){const L=E(A);return y.has(L)?y.get(L):A}function VE({_intern:y,_key:E},A){const L=E(A);return y.has(L)?y.get(L):(y.set(L,A),A)}function jE({_intern:y,_key:E},A){const L=E(A);return y.has(L)&&(A=y.get(L),y.delete(L)),A}function ZE(y){return y!==null&&typeof y=="object"?y.valueOf():y}function nv(y,E,...A){return GE(y,Array.from,E,A)}function GE(y,E,A,L){return function k(Z,Y){if(Y>=L.length)return A(Z);const ee=new N_,s=L[Y++];let te=-1;for(const ae of Z){const se=s(ae,++te,Z),fe=ee.get(se);fe?fe.push(ae):ee.set(se,[ae])}for(const[ae,se]of ee)ee.set(ae,k(se,Y));return E(ee)}(y,0)}const $E=Math.sqrt(50),qE=Math.sqrt(10),WE=Math.sqrt(2);function pp(y,E,A){const L=(E-y)/Math.max(0,A),k=Math.floor(Math.log10(L)),Z=L/Math.pow(10,k),Y=Z>=$E?10:Z>=qE?5:Z>=WE?2:1;let ee,s,te;return k<0?(te=Math.pow(10,-k)/Y,ee=Math.round(y*te),s=Math.round(E*te),ee/te<y&&++ee,s/te>E&&--s,te=-te):(te=Math.pow(10,k)*Y,ee=Math.round(y/te),s=Math.round(E/te),ee*te<y&&++ee,s*te>E&&--s),s<ee&&.5<=A&&A<2?pp(y,E,A*2):[ee,s,te]}function HE(y,E,A){if(E=+E,y=+y,A=+A,!(A>0))return[];if(y===E)return[y];const L=E<y,[k,Z,Y]=L?pp(E,y,A):pp(y,E,A);if(!(Z>=k))return[];const ee=Z-k+1,s=new Array(ee);if(L)if(Y<0)for(let te=0;te<ee;++te)s[te]=(Z-te)/-Y;else for(let te=0;te<ee;++te)s[te]=(Z-te)*Y;else if(Y<0)for(let te=0;te<ee;++te)s[te]=(k+te)/-Y;else for(let te=0;te<ee;++te)s[te]=(k+te)*Y;return s}function U_(y,E,A){return E=+E,y=+y,A=+A,pp(y,E,A)[2]}function XE(y,E,A){E=+E,y=+y,A=+A;const L=E<y,k=L?U_(E,y,A):U_(y,E,A);return(L?-1:1)*(k<0?1/-k:k)}function ov(y,E){let A;if(E===void 0)for(const L of y)L!=null&&(A<L||A===void 0&&L>=L)&&(A=L);else{let L=-1;for(let k of y)(k=E(k,++L,y))!=null&&(A<k||A===void 0&&k>=k)&&(A=k)}return A}function YE(y,E,A){y=+y,E=+E,A=(k=arguments.length)<2?(E=y,y=0,1):k<3?1:+A;for(var L=-1,k=Math.max(0,Math.ceil((E-y)/A))|0,Z=new Array(k);++L<k;)Z[L]=y+L*A;return Z}function sv(y,E){let A=0;if(E===void 0)for(let L of y)(L=+L)&&(A+=L);else{let L=-1;for(let k of y)(k=+E(k,++L,y))&&(A+=k)}return A}function KE(y){return y}var M_=1,I_=2,V_=3,Kh=4,bx=1e-6;function JE(y){return"translate("+y+",0)"}function QE(y){return"translate(0,"+y+")"}function eM(y){return E=>+y(E)}function tM(y,E){return E=Math.max(0,y.bandwidth()-E*2)/2,y.round()&&(E=Math.round(E)),A=>+y(A)+E}function rM(){return!this.__axis}function av(y,E){var A=[],L=null,k=null,Z=6,Y=6,ee=3,s=typeof window<"u"&&window.devicePixelRatio>1?0:.5,te=y===M_||y===Kh?-1:1,ae=y===Kh||y===I_?"x":"y",se=y===M_||y===V_?JE:QE;function fe(_e){var qe=L??(E.ticks?E.ticks.apply(E,A):E.domain()),nt=k??(E.tickFormat?E.tickFormat.apply(E,A):KE),xt=Math.max(Z,0)+ee,lt=E.range(),$e=+lt[0]+s,ft=+lt[lt.length-1]+s,Nt=(E.bandwidth?tM:eM)(E.copy(),s),Ot=_e.selection?_e.selection():_e,lr=Ot.selectAll(".domain").data([null]),Lr=Ot.selectAll(".tick").data(qe,E).order(),Er=Lr.exit(),Ge=Lr.enter().append("g").attr("class","tick"),qr=Lr.select("line"),Gt=Lr.select("text");lr=lr.merge(lr.enter().insert("path",".tick").attr("class","domain").attr("stroke","currentColor")),Lr=Lr.merge(Ge),qr=qr.merge(Ge.append("line").attr("stroke","currentColor").attr(ae+"2",te*Z)),Gt=Gt.merge(Ge.append("text").attr("fill","currentColor").attr(ae,te*xt).attr("dy",y===M_?"0em":y===V_?"0.71em":"0.32em")),_e!==Ot&&(lr=lr.transition(_e),Lr=Lr.transition(_e),qr=qr.transition(_e),Gt=Gt.transition(_e),Er=Er.transition(_e).attr("opacity",bx).attr("transform",function(St){return isFinite(St=Nt(St))?se(St+s):this.getAttribute("transform")}),Ge.attr("opacity",bx).attr("transform",function(St){var At=this.parentNode.__axis;return se((At&&isFinite(At=At(St))?At:Nt(St))+s)})),Er.remove(),lr.attr("d",y===Kh||y===I_?Y?"M"+te*Y+","+$e+"H"+s+"V"+ft+"H"+te*Y:"M"+s+","+$e+"V"+ft:Y?"M"+$e+","+te*Y+"V"+s+"H"+ft+"V"+te*Y:"M"+$e+","+s+"H"+ft),Lr.attr("opacity",1).attr("transform",function(St){return se(Nt(St)+s)}),qr.attr(ae+"2",te*Z),Gt.attr(ae,te*xt).text(nt),Ot.filter(rM).attr("fill","none").attr("font-size",10).attr("font-family","sans-serif").attr("text-anchor",y===I_?"start":y===Kh?"end":"middle"),Ot.each(function(){this.__axis=Nt})}return fe.scale=function(_e){return arguments.length?(E=_e,fe):E},fe.ticks=function(){return A=Array.from(arguments),fe},fe.tickArguments=function(_e){return arguments.length?(A=_e==null?[]:Array.from(_e),fe):A.slice()},fe.tickValues=function(_e){return arguments.length?(L=_e==null?null:Array.from(_e),fe):L&&L.slice()},fe.tickFormat=function(_e){return arguments.length?(k=_e,fe):k},fe.tickSize=function(_e){return arguments.length?(Z=Y=+_e,fe):Z},fe.tickSizeInner=function(_e){return arguments.length?(Z=+_e,fe):Z},fe.tickSizeOuter=function(_e){return arguments.length?(Y=+_e,fe):Y},fe.tickPadding=function(_e){return arguments.length?(ee=+_e,fe):ee},fe.offset=function(_e){return arguments.length?(s=+_e,fe):s},fe}function lv(y){return av(V_,y)}function cv(y){return av(Kh,y)}var iM={value:()=>{}};function uv(){for(var y=0,E=arguments.length,A={},L;y<E;++y){if(!(L=arguments[y]+"")||L in A||/[\s.]/.test(L))throw new Error("illegal type: "+L);A[L]=[]}return new up(A)}function up(y){this._=y}function nM(y,E){return y.trim().split(/^|\s+/).map(function(A){var L="",k=A.indexOf(".");if(k>=0&&(L=A.slice(k+1),A=A.slice(0,k)),A&&!E.hasOwnProperty(A))throw new Error("unknown type: "+A);return{type:A,name:L}})}up.prototype=uv.prototype={constructor:up,on:function(y,E){var A=this._,L=nM(y+"",A),k,Z=-1,Y=L.length;if(arguments.length<2){for(;++Z<Y;)if((k=(y=L[Z]).type)&&(k=oM(A[k],y.name)))return k;return}if(E!=null&&typeof E!="function")throw new Error("invalid callback: "+E);for(;++Z<Y;)if(k=(y=L[Z]).type)A[k]=wx(A[k],y.name,E);else if(E==null)for(k in A)A[k]=wx(A[k],y.name,null);return this},copy:function(){var y={},E=this._;for(var A in E)y[A]=E[A].slice();return new up(y)},call:function(y,E){if((k=arguments.length-2)>0)for(var A=new Array(k),L=0,k,Z;L<k;++L)A[L]=arguments[L+2];if(!this._.hasOwnProperty(y))throw new Error("unknown type: "+y);for(Z=this._[y],L=0,k=Z.length;L<k;++L)Z[L].value.apply(E,A)},apply:function(y,E,A){if(!this._.hasOwnProperty(y))throw new Error("unknown type: "+y);for(var L=this._[y],k=0,Z=L.length;k<Z;++k)L[k].value.apply(E,A)}};function oM(y,E){for(var A=0,L=y.length,k;A<L;++A)if((k=y[A]).name===E)return k.value}function wx(y,E,A){for(var L=0,k=y.length;L<k;++L)if(y[L].name===E){y[L]=iM,y=y.slice(0,L).concat(y.slice(L+1));break}return A!=null&&y.push({name:E,value:A}),y}var j_="http://www.w3.org/1999/xhtml";const Tx={svg:"http://www.w3.org/2000/svg",xhtml:j_,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function Lp(y){var E=y+="",A=E.indexOf(":");return A>=0&&(E=y.slice(0,A))!=="xmlns"&&(y=y.slice(A+1)),Tx.hasOwnProperty(E)?{space:Tx[E],local:y}:y}function sM(y){return function(){var E=this.ownerDocument,A=this.namespaceURI;return A===j_&&E.documentElement.namespaceURI===j_?E.createElement(y):E.createElementNS(A,y)}}function aM(y){return function(){return this.ownerDocument.createElementNS(y.space,y.local)}}function hv(y){var E=Lp(y);return(E.local?aM:sM)(E)}function lM(){}function eg(y){return y==null?lM:function(){return this.querySelector(y)}}function cM(y){typeof y!="function"&&(y=eg(y));for(var E=this._groups,A=E.length,L=new Array(A),k=0;k<A;++k)for(var Z=E[k],Y=Z.length,ee=L[k]=new Array(Y),s,te,ae=0;ae<Y;++ae)(s=Z[ae])&&(te=y.call(s,s.__data__,ae,Z))&&("__data__"in s&&(te.__data__=s.__data__),ee[ae]=te);return new Qn(L,this._parents)}function uM(y){return y==null?[]:Array.isArray(y)?y:Array.from(y)}function hM(){return[]}function dv(y){return y==null?hM:function(){return this.querySelectorAll(y)}}function dM(y){return function(){return uM(y.apply(this,arguments))}}function fM(y){typeof y=="function"?y=dM(y):y=dv(y);for(var E=this._groups,A=E.length,L=[],k=[],Z=0;Z<A;++Z)for(var Y=E[Z],ee=Y.length,s,te=0;te<ee;++te)(s=Y[te])&&(L.push(y.call(s,s.__data__,te,Y)),k.push(s));return new Qn(L,k)}function fv(y){return function(){return this.matches(y)}}function pv(y){return function(E){return E.matches(y)}}var pM=Array.prototype.find;function mM(y){return function(){return pM.call(this.children,y)}}function _M(){return this.firstElementChild}function gM(y){return this.select(y==null?_M:mM(typeof y=="function"?y:pv(y)))}var yM=Array.prototype.filter;function xM(){return Array.from(this.children)}function vM(y){return function(){return yM.call(this.children,y)}}function bM(y){return this.selectAll(y==null?xM:vM(typeof y=="function"?y:pv(y)))}function wM(y){typeof y!="function"&&(y=fv(y));for(var E=this._groups,A=E.length,L=new Array(A),k=0;k<A;++k)for(var Z=E[k],Y=Z.length,ee=L[k]=[],s,te=0;te<Y;++te)(s=Z[te])&&y.call(s,s.__data__,te,Z)&&ee.push(s);return new Qn(L,this._parents)}function mv(y){return new Array(y.length)}function TM(){return new Qn(this._enter||this._groups.map(mv),this._parents)}function mp(y,E){this.ownerDocument=y.ownerDocument,this.namespaceURI=y.namespaceURI,this._next=null,this._parent=y,this.__data__=E}mp.prototype={constructor:mp,appendChild:function(y){return this._parent.insertBefore(y,this._next)},insertBefore:function(y,E){return this._parent.insertBefore(y,E)},querySelector:function(y){return this._parent.querySelector(y)},querySelectorAll:function(y){return this._parent.querySelectorAll(y)}};function EM(y){return function(){return y}}function MM(y,E,A,L,k,Z){for(var Y=0,ee,s=E.length,te=Z.length;Y<te;++Y)(ee=E[Y])?(ee.__data__=Z[Y],L[Y]=ee):A[Y]=new mp(y,Z[Y]);for(;Y<s;++Y)(ee=E[Y])&&(k[Y]=ee)}function IM(y,E,A,L,k,Z,Y){var ee,s,te=new Map,ae=E.length,se=Z.length,fe=new Array(ae),_e;for(ee=0;ee<ae;++ee)(s=E[ee])&&(fe[ee]=_e=Y.call(s,s.__data__,ee,E)+"",te.has(_e)?k[ee]=s:te.set(_e,s));for(ee=0;ee<se;++ee)_e=Y.call(y,Z[ee],ee,Z)+"",(s=te.get(_e))?(L[ee]=s,s.__data__=Z[ee],te.delete(_e)):A[ee]=new mp(y,Z[ee]);for(ee=0;ee<ae;++ee)(s=E[ee])&&te.get(fe[ee])===s&&(k[ee]=s)}function CM(y){return y.__data__}function AM(y,E){if(!arguments.length)return Array.from(this,CM);var A=E?IM:MM,L=this._parents,k=this._groups;typeof y!="function"&&(y=EM(y));for(var Z=k.length,Y=new Array(Z),ee=new Array(Z),s=new Array(Z),te=0;te<Z;++te){var ae=L[te],se=k[te],fe=se.length,_e=SM(y.call(ae,ae&&ae.__data__,te,L)),qe=_e.length,nt=ee[te]=new Array(qe),xt=Y[te]=new Array(qe),lt=s[te]=new Array(fe);A(ae,se,nt,xt,lt,_e,E);for(var $e=0,ft=0,Nt,Ot;$e<qe;++$e)if(Nt=nt[$e]){for($e>=ft&&(ft=$e+1);!(Ot=xt[ft])&&++ft<qe;);Nt._next=Ot||null}}return Y=new Qn(Y,L),Y._enter=ee,Y._exit=s,Y}function SM(y){return typeof y=="object"&&"length"in y?y:Array.from(y)}function PM(){return new Qn(this._exit||this._groups.map(mv),this._parents)}function LM(y,E,A){var L=this.enter(),k=this,Z=this.exit();return typeof y=="function"?(L=y(L),L&&(L=L.selection())):L=L.append(y+""),E!=null&&(k=E(k),k&&(k=k.selection())),A==null?Z.remove():A(Z),L&&k?L.merge(k).order():k}function DM(y){for(var E=y.selection?y.selection():y,A=this._groups,L=E._groups,k=A.length,Z=L.length,Y=Math.min(k,Z),ee=new Array(k),s=0;s<Y;++s)for(var te=A[s],ae=L[s],se=te.length,fe=ee[s]=new Array(se),_e,qe=0;qe<se;++qe)(_e=te[qe]||ae[qe])&&(fe[qe]=_e);for(;s<k;++s)ee[s]=A[s];return new Qn(ee,this._parents)}function zM(){for(var y=this._groups,E=-1,A=y.length;++E<A;)for(var L=y[E],k=L.length-1,Z=L[k],Y;--k>=0;)(Y=L[k])&&(Z&&Y.compareDocumentPosition(Z)^4&&Z.parentNode.insertBefore(Y,Z),Z=Y);return this}function RM(y){y||(y=OM);function E(se,fe){return se&&fe?y(se.__data__,fe.__data__):!se-!fe}for(var A=this._groups,L=A.length,k=new Array(L),Z=0;Z<L;++Z){for(var Y=A[Z],ee=Y.length,s=k[Z]=new Array(ee),te,ae=0;ae<ee;++ae)(te=Y[ae])&&(s[ae]=te);s.sort(E)}return new Qn(k,this._parents).order()}function OM(y,E){return y<E?-1:y>E?1:y>=E?0:NaN}function kM(){var y=arguments[0];return arguments[0]=this,y.apply(null,arguments),this}function BM(){return Array.from(this)}function FM(){for(var y=this._groups,E=0,A=y.length;E<A;++E)for(var L=y[E],k=0,Z=L.length;k<Z;++k){var Y=L[k];if(Y)return Y}return null}function NM(){let y=0;for(const E of this)++y;return y}function UM(){return!this.node()}function VM(y){for(var E=this._groups,A=0,L=E.length;A<L;++A)for(var k=E[A],Z=0,Y=k.length,ee;Z<Y;++Z)(ee=k[Z])&&y.call(ee,ee.__data__,Z,k);return this}function jM(y){return function(){this.removeAttribute(y)}}function ZM(y){return function(){this.removeAttributeNS(y.space,y.local)}}function GM(y,E){return function(){this.setAttribute(y,E)}}function $M(y,E){return function(){this.setAttributeNS(y.space,y.local,E)}}function qM(y,E){return function(){var A=E.apply(this,arguments);A==null?this.removeAttribute(y):this.setAttribute(y,A)}}function WM(y,E){return function(){var A=E.apply(this,arguments);A==null?this.removeAttributeNS(y.space,y.local):this.setAttributeNS(y.space,y.local,A)}}function HM(y,E){var A=Lp(y);if(arguments.length<2){var L=this.node();return A.local?L.getAttributeNS(A.space,A.local):L.getAttribute(A)}return this.each((E==null?A.local?ZM:jM:typeof E=="function"?A.local?WM:qM:A.local?$M:GM)(A,E))}function _v(y){return y.ownerDocument&&y.ownerDocument.defaultView||y.document&&y||y.defaultView}function XM(y){return function(){this.style.removeProperty(y)}}function YM(y,E,A){return function(){this.style.setProperty(y,E,A)}}function KM(y,E,A){return function(){var L=E.apply(this,arguments);L==null?this.style.removeProperty(y):this.style.setProperty(y,L,A)}}function JM(y,E,A){return arguments.length>1?this.each((E==null?XM:typeof E=="function"?KM:YM)(y,E,A??"")):Zc(this.node(),y)}function Zc(y,E){return y.style.getPropertyValue(E)||_v(y).getComputedStyle(y,null).getPropertyValue(E)}function QM(y){return function(){delete this[y]}}function eI(y,E){return function(){this[y]=E}}function tI(y,E){return function(){var A=E.apply(this,arguments);A==null?delete this[y]:this[y]=A}}function rI(y,E){return arguments.length>1?this.each((E==null?QM:typeof E=="function"?tI:eI)(y,E)):this.node()[y]}function gv(y){return y.trim().split(/^|\s+/)}function tg(y){return y.classList||new yv(y)}function yv(y){this._node=y,this._names=gv(y.getAttribute("class")||"")}yv.prototype={add:function(y){var E=this._names.indexOf(y);E<0&&(this._names.push(y),this._node.setAttribute("class",this._names.join(" ")))},remove:function(y){var E=this._names.indexOf(y);E>=0&&(this._names.splice(E,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(y){return this._names.indexOf(y)>=0}};function xv(y,E){for(var A=tg(y),L=-1,k=E.length;++L<k;)A.add(E[L])}function vv(y,E){for(var A=tg(y),L=-1,k=E.length;++L<k;)A.remove(E[L])}function iI(y){return function(){xv(this,y)}}function nI(y){return function(){vv(this,y)}}function oI(y,E){return function(){(E.apply(this,arguments)?xv:vv)(this,y)}}function sI(y,E){var A=gv(y+"");if(arguments.length<2){for(var L=tg(this.node()),k=-1,Z=A.length;++k<Z;)if(!L.contains(A[k]))return!1;return!0}return this.each((typeof E=="function"?oI:E?iI:nI)(A,E))}function aI(){this.textContent=""}function lI(y){return function(){this.textContent=y}}function cI(y){return function(){var E=y.apply(this,arguments);this.textContent=E??""}}function uI(y){return arguments.length?this.each(y==null?aI:(typeof y=="function"?cI:lI)(y)):this.node().textContent}function hI(){this.innerHTML=""}function dI(y){return function(){this.innerHTML=y}}function fI(y){return function(){var E=y.apply(this,arguments);this.innerHTML=E??""}}function pI(y){return arguments.length?this.each(y==null?hI:(typeof y=="function"?fI:dI)(y)):this.node().innerHTML}function mI(){this.nextSibling&&this.parentNode.appendChild(this)}function _I(){return this.each(mI)}function gI(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function yI(){return this.each(gI)}function xI(y){var E=typeof y=="function"?y:hv(y);return this.select(function(){return this.appendChild(E.apply(this,arguments))})}function vI(){return null}function bI(y,E){var A=typeof y=="function"?y:hv(y),L=E==null?vI:typeof E=="function"?E:eg(E);return this.select(function(){return this.insertBefore(A.apply(this,arguments),L.apply(this,arguments)||null)})}function wI(){var y=this.parentNode;y&&y.removeChild(this)}function TI(){return this.each(wI)}function EI(){var y=this.cloneNode(!1),E=this.parentNode;return E?E.insertBefore(y,this.nextSibling):y}function MI(){var y=this.cloneNode(!0),E=this.parentNode;return E?E.insertBefore(y,this.nextSibling):y}function II(y){return this.select(y?MI:EI)}function CI(y){return arguments.length?this.property("__data__",y):this.node().__data__}function AI(y){return function(E){y.call(this,E,this.__data__)}}function SI(y){return y.trim().split(/^|\s+/).map(function(E){var A="",L=E.indexOf(".");return L>=0&&(A=E.slice(L+1),E=E.slice(0,L)),{type:E,name:A}})}function PI(y){return function(){var E=this.__on;if(E){for(var A=0,L=-1,k=E.length,Z;A<k;++A)Z=E[A],(!y.type||Z.type===y.type)&&Z.name===y.name?this.removeEventListener(Z.type,Z.listener,Z.options):E[++L]=Z;++L?E.length=L:delete this.__on}}}function LI(y,E,A){return function(){var L=this.__on,k,Z=AI(E);if(L){for(var Y=0,ee=L.length;Y<ee;++Y)if((k=L[Y]).type===y.type&&k.name===y.name){this.removeEventListener(k.type,k.listener,k.options),this.addEventListener(k.type,k.listener=Z,k.options=A),k.value=E;return}}this.addEventListener(y.type,Z,A),k={type:y.type,name:y.name,value:E,listener:Z,options:A},L?L.push(k):this.__on=[k]}}function DI(y,E,A){var L=SI(y+""),k,Z=L.length,Y;if(arguments.length<2){var ee=this.node().__on;if(ee){for(var s=0,te=ee.length,ae;s<te;++s)for(k=0,ae=ee[s];k<Z;++k)if((Y=L[k]).type===ae.type&&Y.name===ae.name)return ae.value}return}for(ee=E?LI:PI,k=0;k<Z;++k)this.each(ee(L[k],E,A));return this}function bv(y,E,A){var L=_v(y),k=L.CustomEvent;typeof k=="function"?k=new k(E,A):(k=L.document.createEvent("Event"),A?(k.initEvent(E,A.bubbles,A.cancelable),k.detail=A.detail):k.initEvent(E,!1,!1)),y.dispatchEvent(k)}function zI(y,E){return function(){return bv(this,y,E)}}function RI(y,E){return function(){return bv(this,y,E.apply(this,arguments))}}function OI(y,E){return this.each((typeof E=="function"?RI:zI)(y,E))}function*kI(){for(var y=this._groups,E=0,A=y.length;E<A;++E)for(var L=y[E],k=0,Z=L.length,Y;k<Z;++k)(Y=L[k])&&(yield Y)}var wv=[null];function Qn(y,E){this._groups=y,this._parents=E}function sd(){return new Qn([[document.documentElement]],wv)}function BI(){return this}Qn.prototype=sd.prototype={constructor:Qn,select:cM,selectAll:fM,selectChild:gM,selectChildren:bM,filter:wM,data:AM,enter:TM,exit:PM,join:LM,merge:DM,selection:BI,order:zM,sort:RM,call:kM,nodes:BM,node:FM,size:NM,empty:UM,each:VM,attr:HM,style:JM,property:rI,classed:sI,text:uI,html:pI,raise:_I,lower:yI,append:xI,insert:bI,remove:TI,clone:II,datum:CI,on:DI,dispatch:OI,[Symbol.iterator]:kI};function Ma(y){return typeof y=="string"?new Qn([[document.querySelector(y)]],[document.documentElement]):new Qn([[y]],wv)}function rg(y,E,A){y.prototype=E.prototype=A,A.constructor=y}function Tv(y,E){var A=Object.create(y.prototype);for(var L in E)A[L]=E[L];return A}function ad(){}var rd=.7,_p=1/rd,Vc="\\s*([+-]?\\d+)\\s*",id="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",as="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",FI=/^#([0-9a-f]{3,8})$/,NI=new RegExp(`^rgb\\(${Vc},${Vc},${Vc}\\)$`),UI=new RegExp(`^rgb\\(${as},${as},${as}\\)$`),VI=new RegExp(`^rgba\\(${Vc},${Vc},${Vc},${id}\\)$`),jI=new RegExp(`^rgba\\(${as},${as},${as},${id}\\)$`),ZI=new RegExp(`^hsl\\(${id},${as},${as}\\)$`),GI=new RegExp(`^hsla\\(${id},${as},${as},${id}\\)$`),Ex={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};rg(ad,Ll,{copy(y){return Object.assign(new this.constructor,this,y)},displayable(){return this.rgb().displayable()},hex:Mx,formatHex:Mx,formatHex8:$I,formatHsl:qI,formatRgb:Ix,toString:Ix});function Mx(){return this.rgb().formatHex()}function $I(){return this.rgb().formatHex8()}function qI(){return Ev(this).formatHsl()}function Ix(){return this.rgb().formatRgb()}function Ll(y){var E,A;return y=(y+"").trim().toLowerCase(),(E=FI.exec(y))?(A=E[1].length,E=parseInt(E[1],16),A===6?Cx(E):A===3?new Bn(E>>8&15|E>>4&240,E>>4&15|E&240,(E&15)<<4|E&15,1):A===8?rp(E>>24&255,E>>16&255,E>>8&255,(E&255)/255):A===4?rp(E>>12&15|E>>8&240,E>>8&15|E>>4&240,E>>4&15|E&240,((E&15)<<4|E&15)/255):null):(E=NI.exec(y))?new Bn(E[1],E[2],E[3],1):(E=UI.exec(y))?new Bn(E[1]*255/100,E[2]*255/100,E[3]*255/100,1):(E=VI.exec(y))?rp(E[1],E[2],E[3],E[4]):(E=jI.exec(y))?rp(E[1]*255/100,E[2]*255/100,E[3]*255/100,E[4]):(E=ZI.exec(y))?Px(E[1],E[2]/100,E[3]/100,1):(E=GI.exec(y))?Px(E[1],E[2]/100,E[3]/100,E[4]):Ex.hasOwnProperty(y)?Cx(Ex[y]):y==="transparent"?new Bn(NaN,NaN,NaN,0):null}function Cx(y){return new Bn(y>>16&255,y>>8&255,y&255,1)}function rp(y,E,A,L){return L<=0&&(y=E=A=NaN),new Bn(y,E,A,L)}function WI(y){return y instanceof ad||(y=Ll(y)),y?(y=y.rgb(),new Bn(y.r,y.g,y.b,y.opacity)):new Bn}function Z_(y,E,A,L){return arguments.length===1?WI(y):new Bn(y,E,A,L??1)}function Bn(y,E,A,L){this.r=+y,this.g=+E,this.b=+A,this.opacity=+L}rg(Bn,Z_,Tv(ad,{brighter(y){return y=y==null?_p:Math.pow(_p,y),new Bn(this.r*y,this.g*y,this.b*y,this.opacity)},darker(y){return y=y==null?rd:Math.pow(rd,y),new Bn(this.r*y,this.g*y,this.b*y,this.opacity)},rgb(){return this},clamp(){return new Bn(Pl(this.r),Pl(this.g),Pl(this.b),gp(this.opacity))},displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:Ax,formatHex:Ax,formatHex8:HI,formatRgb:Sx,toString:Sx}));function Ax(){return`#${Sl(this.r)}${Sl(this.g)}${Sl(this.b)}`}function HI(){return`#${Sl(this.r)}${Sl(this.g)}${Sl(this.b)}${Sl((isNaN(this.opacity)?1:this.opacity)*255)}`}function Sx(){const y=gp(this.opacity);return`${y===1?"rgb(":"rgba("}${Pl(this.r)}, ${Pl(this.g)}, ${Pl(this.b)}${y===1?")":`, ${y})`}`}function gp(y){return isNaN(y)?1:Math.max(0,Math.min(1,y))}function Pl(y){return Math.max(0,Math.min(255,Math.round(y)||0))}function Sl(y){return y=Pl(y),(y<16?"0":"")+y.toString(16)}function Px(y,E,A,L){return L<=0?y=E=A=NaN:A<=0||A>=1?y=E=NaN:E<=0&&(y=NaN),new Do(y,E,A,L)}function Ev(y){if(y instanceof Do)return new Do(y.h,y.s,y.l,y.opacity);if(y instanceof ad||(y=Ll(y)),!y)return new Do;if(y instanceof Do)return y;y=y.rgb();var E=y.r/255,A=y.g/255,L=y.b/255,k=Math.min(E,A,L),Z=Math.max(E,A,L),Y=NaN,ee=Z-k,s=(Z+k)/2;return ee?(E===Z?Y=(A-L)/ee+(A<L)*6:A===Z?Y=(L-E)/ee+2:Y=(E-A)/ee+4,ee/=s<.5?Z+k:2-Z-k,Y*=60):ee=s>0&&s<1?0:Y,new Do(Y,ee,s,y.opacity)}function XI(y,E,A,L){return arguments.length===1?Ev(y):new Do(y,E,A,L??1)}function Do(y,E,A,L){this.h=+y,this.s=+E,this.l=+A,this.opacity=+L}rg(Do,XI,Tv(ad,{brighter(y){return y=y==null?_p:Math.pow(_p,y),new Do(this.h,this.s,this.l*y,this.opacity)},darker(y){return y=y==null?rd:Math.pow(rd,y),new Do(this.h,this.s,this.l*y,this.opacity)},rgb(){var y=this.h%360+(this.h<0)*360,E=isNaN(y)||isNaN(this.s)?0:this.s,A=this.l,L=A+(A<.5?A:1-A)*E,k=2*A-L;return new Bn(C_(y>=240?y-240:y+120,k,L),C_(y,k,L),C_(y<120?y+240:y-120,k,L),this.opacity)},clamp(){return new Do(Lx(this.h),ip(this.s),ip(this.l),gp(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){const y=gp(this.opacity);return`${y===1?"hsl(":"hsla("}${Lx(this.h)}, ${ip(this.s)*100}%, ${ip(this.l)*100}%${y===1?")":`, ${y})`}`}}));function Lx(y){return y=(y||0)%360,y<0?y+360:y}function ip(y){return Math.max(0,Math.min(1,y||0))}function C_(y,E,A){return(y<60?E+(A-E)*y/60:y<180?A:y<240?E+(A-E)*(240-y)/60:E)*255}const ig=y=>()=>y;function YI(y,E){return function(A){return y+A*E}}function KI(y,E,A){return y=Math.pow(y,A),E=Math.pow(E,A)-y,A=1/A,function(L){return Math.pow(y+L*E,A)}}function JI(y){return(y=+y)==1?Mv:function(E,A){return A-E?KI(E,A,y):ig(isNaN(E)?A:E)}}function Mv(y,E){var A=E-y;return A?YI(y,A):ig(isNaN(y)?E:y)}const yp=function y(E){var A=JI(E);function L(k,Z){var Y=A((k=Z_(k)).r,(Z=Z_(Z)).r),ee=A(k.g,Z.g),s=A(k.b,Z.b),te=Mv(k.opacity,Z.opacity);return function(ae){return k.r=Y(ae),k.g=ee(ae),k.b=s(ae),k.opacity=te(ae),k+""}}return L.gamma=y,L}(1);function QI(y,E){E||(E=[]);var A=y?Math.min(E.length,y.length):0,L=E.slice(),k;return function(Z){for(k=0;k<A;++k)L[k]=y[k]*(1-Z)+E[k]*Z;return L}}function eC(y){return ArrayBuffer.isView(y)&&!(y instanceof DataView)}function tC(y,E){var A=E?E.length:0,L=y?Math.min(A,y.length):0,k=new Array(L),Z=new Array(A),Y;for(Y=0;Y<L;++Y)k[Y]=ng(y[Y],E[Y]);for(;Y<A;++Y)Z[Y]=E[Y];return function(ee){for(Y=0;Y<L;++Y)Z[Y]=k[Y](ee);return Z}}function rC(y,E){var A=new Date;return y=+y,E=+E,function(L){return A.setTime(y*(1-L)+E*L),A}}function Lo(y,E){return y=+y,E=+E,function(A){return y*(1-A)+E*A}}function iC(y,E){var A={},L={},k;(y===null||typeof y!="object")&&(y={}),(E===null||typeof E!="object")&&(E={});for(k in E)k in y?A[k]=ng(y[k],E[k]):L[k]=E[k];return function(Z){for(k in A)L[k]=A[k](Z);return L}}var G_=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,A_=new RegExp(G_.source,"g");function nC(y){return function(){return y}}function oC(y){return function(E){return y(E)+""}}function Iv(y,E){var A=G_.lastIndex=A_.lastIndex=0,L,k,Z,Y=-1,ee=[],s=[];for(y=y+"",E=E+"";(L=G_.exec(y))&&(k=A_.exec(E));)(Z=k.index)>A&&(Z=E.slice(A,Z),ee[Y]?ee[Y]+=Z:ee[++Y]=Z),(L=L[0])===(k=k[0])?ee[Y]?ee[Y]+=k:ee[++Y]=k:(ee[++Y]=null,s.push({i:Y,x:Lo(L,k)})),A=A_.lastIndex;return A<E.length&&(Z=E.slice(A),ee[Y]?ee[Y]+=Z:ee[++Y]=Z),ee.length<2?s[0]?oC(s[0].x):nC(E):(E=s.length,function(te){for(var ae=0,se;ae<E;++ae)ee[(se=s[ae]).i]=se.x(te);return ee.join("")})}function ng(y,E){var A=typeof E,L;return E==null||A==="boolean"?ig(E):(A==="number"?Lo:A==="string"?(L=Ll(E))?(E=L,yp):Iv:E instanceof Ll?yp:E instanceof Date?rC:eC(E)?QI:Array.isArray(E)?tC:typeof E.valueOf!="function"&&typeof E.toString!="function"||isNaN(E)?iC:Lo)(y,E)}function sC(y,E){return y=+y,E=+E,function(A){return Math.round(y*(1-A)+E*A)}}var Dx=180/Math.PI,$_={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1};function Cv(y,E,A,L,k,Z){var Y,ee,s;return(Y=Math.sqrt(y*y+E*E))&&(y/=Y,E/=Y),(s=y*A+E*L)&&(A-=y*s,L-=E*s),(ee=Math.sqrt(A*A+L*L))&&(A/=ee,L/=ee,s/=ee),y*L<E*A&&(y=-y,E=-E,s=-s,Y=-Y),{translateX:k,translateY:Z,rotate:Math.atan2(E,y)*Dx,skewX:Math.atan(s)*Dx,scaleX:Y,scaleY:ee}}var np;function aC(y){const E=new(typeof DOMMatrix=="function"?DOMMatrix:WebKitCSSMatrix)(y+"");return E.isIdentity?$_:Cv(E.a,E.b,E.c,E.d,E.e,E.f)}function lC(y){return y==null||(np||(np=document.createElementNS("http://www.w3.org/2000/svg","g")),np.setAttribute("transform",y),!(y=np.transform.baseVal.consolidate()))?$_:(y=y.matrix,Cv(y.a,y.b,y.c,y.d,y.e,y.f))}function Av(y,E,A,L){function k(te){return te.length?te.pop()+" ":""}function Z(te,ae,se,fe,_e,qe){if(te!==se||ae!==fe){var nt=_e.push("translate(",null,E,null,A);qe.push({i:nt-4,x:Lo(te,se)},{i:nt-2,x:Lo(ae,fe)})}else(se||fe)&&_e.push("translate("+se+E+fe+A)}function Y(te,ae,se,fe){te!==ae?(te-ae>180?ae+=360:ae-te>180&&(te+=360),fe.push({i:se.push(k(se)+"rotate(",null,L)-2,x:Lo(te,ae)})):ae&&se.push(k(se)+"rotate("+ae+L)}function ee(te,ae,se,fe){te!==ae?fe.push({i:se.push(k(se)+"skewX(",null,L)-2,x:Lo(te,ae)}):ae&&se.push(k(se)+"skewX("+ae+L)}function s(te,ae,se,fe,_e,qe){if(te!==se||ae!==fe){var nt=_e.push(k(_e)+"scale(",null,",",null,")");qe.push({i:nt-4,x:Lo(te,se)},{i:nt-2,x:Lo(ae,fe)})}else(se!==1||fe!==1)&&_e.push(k(_e)+"scale("+se+","+fe+")")}return function(te,ae){var se=[],fe=[];return te=y(te),ae=y(ae),Z(te.translateX,te.translateY,ae.translateX,ae.translateY,se,fe),Y(te.rotate,ae.rotate,se,fe),ee(te.skewX,ae.skewX,se,fe),s(te.scaleX,te.scaleY,ae.scaleX,ae.scaleY,se,fe),te=ae=null,function(_e){for(var qe=-1,nt=fe.length,xt;++qe<nt;)se[(xt=fe[qe]).i]=xt.x(_e);return se.join("")}}}var cC=Av(aC,"px, ","px)","deg)"),uC=Av(lC,", ",")",")"),Gc=0,Jh=0,Xh=0,Sv=1e3,xp,Qh,vp=0,Dl=0,Dp=0,nd=typeof performance=="object"&&performance.now?performance:Date,Pv=typeof window=="object"&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(y){setTimeout(y,17)};function og(){return Dl||(Pv(hC),Dl=nd.now()+Dp)}function hC(){Dl=0}function bp(){this._call=this._time=this._next=null}bp.prototype=Lv.prototype={constructor:bp,restart:function(y,E,A){if(typeof y!="function")throw new TypeError("callback is not a function");A=(A==null?og():+A)+(E==null?0:+E),!this._next&&Qh!==this&&(Qh?Qh._next=this:xp=this,Qh=this),this._call=y,this._time=A,q_()},stop:function(){this._call&&(this._call=null,this._time=1/0,q_())}};function Lv(y,E,A){var L=new bp;return L.restart(y,E,A),L}function dC(){og(),++Gc;for(var y=xp,E;y;)(E=Dl-y._time)>=0&&y._call.call(void 0,E),y=y._next;--Gc}function zx(){Dl=(vp=nd.now())+Dp,Gc=Jh=0;try{dC()}finally{Gc=0,pC(),Dl=0}}function fC(){var y=nd.now(),E=y-vp;E>Sv&&(Dp-=E,vp=y)}function pC(){for(var y,E=xp,A,L=1/0;E;)E._call?(L>E._time&&(L=E._time),y=E,E=E._next):(A=E._next,E._next=null,E=y?y._next=A:xp=A);Qh=y,q_(L)}function q_(y){if(!Gc){Jh&&(Jh=clearTimeout(Jh));var E=y-Dl;E>24?(y<1/0&&(Jh=setTimeout(zx,y-nd.now()-Dp)),Xh&&(Xh=clearInterval(Xh))):(Xh||(vp=nd.now(),Xh=setInterval(fC,Sv)),Gc=1,Pv(zx))}}function Rx(y,E,A){var L=new bp;return E=E==null?0:+E,L.restart(k=>{L.stop(),y(k+E)},E,A),L}var mC=uv("start","end","cancel","interrupt"),_C=[],Dv=0,Ox=1,W_=2,hp=3,kx=4,H_=5,dp=6;function zp(y,E,A,L,k,Z){var Y=y.__transition;if(!Y)y.__transition={};else if(A in Y)return;gC(y,A,{name:E,index:L,group:k,on:mC,tween:_C,time:Z.time,delay:Z.delay,duration:Z.duration,ease:Z.ease,timer:null,state:Dv})}function sg(y,E){var A=zo(y,E);if(A.state>Dv)throw new Error("too late; already scheduled");return A}function ls(y,E){var A=zo(y,E);if(A.state>hp)throw new Error("too late; already running");return A}function zo(y,E){var A=y.__transition;if(!A||!(A=A[E]))throw new Error("transition not found");return A}function gC(y,E,A){var L=y.__transition,k;L[E]=A,A.timer=Lv(Z,0,A.time);function Z(te){A.state=Ox,A.timer.restart(Y,A.delay,A.time),A.delay<=te&&Y(te-A.delay)}function Y(te){var ae,se,fe,_e;if(A.state!==Ox)return s();for(ae in L)if(_e=L[ae],_e.name===A.name){if(_e.state===hp)return Rx(Y);_e.state===kx?(_e.state=dp,_e.timer.stop(),_e.on.call("interrupt",y,y.__data__,_e.index,_e.group),delete L[ae]):+ae<E&&(_e.state=dp,_e.timer.stop(),_e.on.call("cancel",y,y.__data__,_e.index,_e.group),delete L[ae])}if(Rx(function(){A.state===hp&&(A.state=kx,A.timer.restart(ee,A.delay,A.time),ee(te))}),A.state=W_,A.on.call("start",y,y.__data__,A.index,A.group),A.state===W_){for(A.state=hp,k=new Array(fe=A.tween.length),ae=0,se=-1;ae<fe;++ae)(_e=A.tween[ae].value.call(y,y.__data__,A.index,A.group))&&(k[++se]=_e);k.length=se+1}}function ee(te){for(var ae=te<A.duration?A.ease.call(null,te/A.duration):(A.timer.restart(s),A.state=H_,1),se=-1,fe=k.length;++se<fe;)k[se].call(y,ae);A.state===H_&&(A.on.call("end",y,y.__data__,A.index,A.group),s())}function s(){A.state=dp,A.timer.stop(),delete L[E];for(var te in L)return;delete y.__transition}}function yC(y,E){var A=y.__transition,L,k,Z=!0,Y;if(A){E=E==null?null:E+"";for(Y in A){if((L=A[Y]).name!==E){Z=!1;continue}k=L.state>W_&&L.state<H_,L.state=dp,L.timer.stop(),L.on.call(k?"interrupt":"cancel",y,y.__data__,L.index,L.group),delete A[Y]}Z&&delete y.__transition}}function xC(y){return this.each(function(){yC(this,y)})}function vC(y,E){var A,L;return function(){var k=ls(this,y),Z=k.tween;if(Z!==A){L=A=Z;for(var Y=0,ee=L.length;Y<ee;++Y)if(L[Y].name===E){L=L.slice(),L.splice(Y,1);break}}k.tween=L}}function bC(y,E,A){var L,k;if(typeof A!="function")throw new Error;return function(){var Z=ls(this,y),Y=Z.tween;if(Y!==L){k=(L=Y).slice();for(var ee={name:E,value:A},s=0,te=k.length;s<te;++s)if(k[s].name===E){k[s]=ee;break}s===te&&k.push(ee)}Z.tween=k}}function wC(y,E){var A=this._id;if(y+="",arguments.length<2){for(var L=zo(this.node(),A).tween,k=0,Z=L.length,Y;k<Z;++k)if((Y=L[k]).name===y)return Y.value;return null}return this.each((E==null?vC:bC)(A,y,E))}function ag(y,E,A){var L=y._id;return y.each(function(){var k=ls(this,L);(k.value||(k.value={}))[E]=A.apply(this,arguments)}),function(k){return zo(k,L).value[E]}}function zv(y,E){var A;return(typeof E=="number"?Lo:E instanceof Ll?yp:(A=Ll(E))?(E=A,yp):Iv)(y,E)}function TC(y){return function(){this.removeAttribute(y)}}function EC(y){return function(){this.removeAttributeNS(y.space,y.local)}}function MC(y,E,A){var L,k=A+"",Z;return function(){var Y=this.getAttribute(y);return Y===k?null:Y===L?Z:Z=E(L=Y,A)}}function IC(y,E,A){var L,k=A+"",Z;return function(){var Y=this.getAttributeNS(y.space,y.local);return Y===k?null:Y===L?Z:Z=E(L=Y,A)}}function CC(y,E,A){var L,k,Z;return function(){var Y,ee=A(this),s;return ee==null?void this.removeAttribute(y):(Y=this.getAttribute(y),s=ee+"",Y===s?null:Y===L&&s===k?Z:(k=s,Z=E(L=Y,ee)))}}function AC(y,E,A){var L,k,Z;return function(){var Y,ee=A(this),s;return ee==null?void this.removeAttributeNS(y.space,y.local):(Y=this.getAttributeNS(y.space,y.local),s=ee+"",Y===s?null:Y===L&&s===k?Z:(k=s,Z=E(L=Y,ee)))}}function SC(y,E){var A=Lp(y),L=A==="transform"?uC:zv;return this.attrTween(y,typeof E=="function"?(A.local?AC:CC)(A,L,ag(this,"attr."+y,E)):E==null?(A.local?EC:TC)(A):(A.local?IC:MC)(A,L,E))}function PC(y,E){return function(A){this.setAttribute(y,E.call(this,A))}}function LC(y,E){return function(A){this.setAttributeNS(y.space,y.local,E.call(this,A))}}function DC(y,E){var A,L;function k(){var Z=E.apply(this,arguments);return Z!==L&&(A=(L=Z)&&LC(y,Z)),A}return k._value=E,k}function zC(y,E){var A,L;function k(){var Z=E.apply(this,arguments);return Z!==L&&(A=(L=Z)&&PC(y,Z)),A}return k._value=E,k}function RC(y,E){var A="attr."+y;if(arguments.length<2)return(A=this.tween(A))&&A._value;if(E==null)return this.tween(A,null);if(typeof E!="function")throw new Error;var L=Lp(y);return this.tween(A,(L.local?DC:zC)(L,E))}function OC(y,E){return function(){sg(this,y).delay=+E.apply(this,arguments)}}function kC(y,E){return E=+E,function(){sg(this,y).delay=E}}function BC(y){var E=this._id;return arguments.length?this.each((typeof y=="function"?OC:kC)(E,y)):zo(this.node(),E).delay}function FC(y,E){return function(){ls(this,y).duration=+E.apply(this,arguments)}}function NC(y,E){return E=+E,function(){ls(this,y).duration=E}}function UC(y){var E=this._id;return arguments.length?this.each((typeof y=="function"?FC:NC)(E,y)):zo(this.node(),E).duration}function VC(y,E){if(typeof E!="function")throw new Error;return function(){ls(this,y).ease=E}}function jC(y){var E=this._id;return arguments.length?this.each(VC(E,y)):zo(this.node(),E).ease}function ZC(y,E){return function(){var A=E.apply(this,arguments);if(typeof A!="function")throw new Error;ls(this,y).ease=A}}function GC(y){if(typeof y!="function")throw new Error;return this.each(ZC(this._id,y))}function $C(y){typeof y!="function"&&(y=fv(y));for(var E=this._groups,A=E.length,L=new Array(A),k=0;k<A;++k)for(var Z=E[k],Y=Z.length,ee=L[k]=[],s,te=0;te<Y;++te)(s=Z[te])&&y.call(s,s.__data__,te,Z)&&ee.push(s);return new Bs(L,this._parents,this._name,this._id)}function qC(y){if(y._id!==this._id)throw new Error;for(var E=this._groups,A=y._groups,L=E.length,k=A.length,Z=Math.min(L,k),Y=new Array(L),ee=0;ee<Z;++ee)for(var s=E[ee],te=A[ee],ae=s.length,se=Y[ee]=new Array(ae),fe,_e=0;_e<ae;++_e)(fe=s[_e]||te[_e])&&(se[_e]=fe);for(;ee<L;++ee)Y[ee]=E[ee];return new Bs(Y,this._parents,this._name,this._id)}function WC(y){return(y+"").trim().split(/^|\s+/).every(function(E){var A=E.indexOf(".");return A>=0&&(E=E.slice(0,A)),!E||E==="start"})}function HC(y,E,A){var L,k,Z=WC(E)?sg:ls;return function(){var Y=Z(this,y),ee=Y.on;ee!==L&&(k=(L=ee).copy()).on(E,A),Y.on=k}}function XC(y,E){var A=this._id;return arguments.length<2?zo(this.node(),A).on.on(y):this.each(HC(A,y,E))}function YC(y){return function(){var E=this.parentNode;for(var A in this.__transition)if(+A!==y)return;E&&E.removeChild(this)}}function KC(){return this.on("end.remove",YC(this._id))}function JC(y){var E=this._name,A=this._id;typeof y!="function"&&(y=eg(y));for(var L=this._groups,k=L.length,Z=new Array(k),Y=0;Y<k;++Y)for(var ee=L[Y],s=ee.length,te=Z[Y]=new Array(s),ae,se,fe=0;fe<s;++fe)(ae=ee[fe])&&(se=y.call(ae,ae.__data__,fe,ee))&&("__data__"in ae&&(se.__data__=ae.__data__),te[fe]=se,zp(te[fe],E,A,fe,te,zo(ae,A)));return new Bs(Z,this._parents,E,A)}function QC(y){var E=this._name,A=this._id;typeof y!="function"&&(y=dv(y));for(var L=this._groups,k=L.length,Z=[],Y=[],ee=0;ee<k;++ee)for(var s=L[ee],te=s.length,ae,se=0;se<te;++se)if(ae=s[se]){for(var fe=y.call(ae,ae.__data__,se,s),_e,qe=zo(ae,A),nt=0,xt=fe.length;nt<xt;++nt)(_e=fe[nt])&&zp(_e,E,A,nt,fe,qe);Z.push(fe),Y.push(ae)}return new Bs(Z,Y,E,A)}var eA=sd.prototype.constructor;function tA(){return new eA(this._groups,this._parents)}function rA(y,E){var A,L,k;return function(){var Z=Zc(this,y),Y=(this.style.removeProperty(y),Zc(this,y));return Z===Y?null:Z===A&&Y===L?k:k=E(A=Z,L=Y)}}function Rv(y){return function(){this.style.removeProperty(y)}}function iA(y,E,A){var L,k=A+"",Z;return function(){var Y=Zc(this,y);return Y===k?null:Y===L?Z:Z=E(L=Y,A)}}function nA(y,E,A){var L,k,Z;return function(){var Y=Zc(this,y),ee=A(this),s=ee+"";return ee==null&&(s=ee=(this.style.removeProperty(y),Zc(this,y))),Y===s?null:Y===L&&s===k?Z:(k=s,Z=E(L=Y,ee))}}function oA(y,E){var A,L,k,Z="style."+E,Y="end."+Z,ee;return function(){var s=ls(this,y),te=s.on,ae=s.value[Z]==null?ee||(ee=Rv(E)):void 0;(te!==A||k!==ae)&&(L=(A=te).copy()).on(Y,k=ae),s.on=L}}function sA(y,E,A){var L=(y+="")=="transform"?cC:zv;return E==null?this.styleTween(y,rA(y,L)).on("end.style."+y,Rv(y)):typeof E=="function"?this.styleTween(y,nA(y,L,ag(this,"style."+y,E))).each(oA(this._id,y)):this.styleTween(y,iA(y,L,E),A).on("end.style."+y,null)}function aA(y,E,A){return function(L){this.style.setProperty(y,E.call(this,L),A)}}function lA(y,E,A){var L,k;function Z(){var Y=E.apply(this,arguments);return Y!==k&&(L=(k=Y)&&aA(y,Y,A)),L}return Z._value=E,Z}function cA(y,E,A){var L="style."+(y+="");if(arguments.length<2)return(L=this.tween(L))&&L._value;if(E==null)return this.tween(L,null);if(typeof E!="function")throw new Error;return this.tween(L,lA(y,E,A??""))}function uA(y){return function(){this.textContent=y}}function hA(y){return function(){var E=y(this);this.textContent=E??""}}function dA(y){return this.tween("text",typeof y=="function"?hA(ag(this,"text",y)):uA(y==null?"":y+""))}function fA(y){return function(E){this.textContent=y.call(this,E)}}function pA(y){var E,A;function L(){var k=y.apply(this,arguments);return k!==A&&(E=(A=k)&&fA(k)),E}return L._value=y,L}function mA(y){var E="text";if(arguments.length<1)return(E=this.tween(E))&&E._value;if(y==null)return this.tween(E,null);if(typeof y!="function")throw new Error;return this.tween(E,pA(y))}function _A(){for(var y=this._name,E=this._id,A=Ov(),L=this._groups,k=L.length,Z=0;Z<k;++Z)for(var Y=L[Z],ee=Y.length,s,te=0;te<ee;++te)if(s=Y[te]){var ae=zo(s,E);zp(s,y,A,te,Y,{time:ae.time+ae.delay+ae.duration,delay:0,duration:ae.duration,ease:ae.ease})}return new Bs(L,this._parents,y,A)}function gA(){var y,E,A=this,L=A._id,k=A.size();return new Promise(function(Z,Y){var ee={value:Y},s={value:function(){--k===0&&Z()}};A.each(function(){var te=ls(this,L),ae=te.on;ae!==y&&(E=(y=ae).copy(),E._.cancel.push(ee),E._.interrupt.push(ee),E._.end.push(s)),te.on=E}),k===0&&Z()})}var yA=0;function Bs(y,E,A,L){this._groups=y,this._parents=E,this._name=A,this._id=L}function Ov(){return++yA}var Rs=sd.prototype;Bs.prototype={constructor:Bs,select:JC,selectAll:QC,selectChild:Rs.selectChild,selectChildren:Rs.selectChildren,filter:$C,merge:qC,selection:tA,transition:_A,call:Rs.call,nodes:Rs.nodes,node:Rs.node,size:Rs.size,empty:Rs.empty,each:Rs.each,on:XC,attr:SC,attrTween:RC,style:sA,styleTween:cA,text:dA,textTween:mA,remove:KC,tween:wC,delay:BC,duration:UC,ease:jC,easeVarying:GC,end:gA,[Symbol.iterator]:Rs[Symbol.iterator]};function xA(y){return((y*=2)<=1?y*y*y:(y-=2)*y*y+2)/2}var vA={time:null,delay:0,duration:250,ease:xA};function bA(y,E){for(var A;!(A=y.__transition)||!(A=A[E]);)if(!(y=y.parentNode))throw new Error(`transition ${E} not found`);return A}function wA(y){var E,A;y instanceof Bs?(E=y._id,y=y._name):(E=Ov(),(A=vA).time=og(),y=y==null?null:y+"");for(var L=this._groups,k=L.length,Z=0;Z<k;++Z)for(var Y=L[Z],ee=Y.length,s,te=0;te<ee;++te)(s=Y[te])&&zp(s,y,E,te,Y,A||bA(s,E));return new Bs(L,this._parents,y,E)}sd.prototype.interrupt=xC;sd.prototype.transition=wA;const X_=Math.PI,Y_=2*X_,Al=1e-6,TA=Y_-Al;function kv(y){this._+=y[0];for(let E=1,A=y.length;E<A;++E)this._+=arguments[E]+y[E]}function EA(y){let E=Math.floor(y);if(!(E>=0))throw new Error(`invalid digits: ${y}`);if(E>15)return kv;const A=10**E;return function(L){this._+=L[0];for(let k=1,Z=L.length;k<Z;++k)this._+=Math.round(arguments[k]*A)/A+L[k]}}class MA{constructor(E){this._x0=this._y0=this._x1=this._y1=null,this._="",this._append=E==null?kv:EA(E)}moveTo(E,A){this._append`M${this._x0=this._x1=+E},${this._y0=this._y1=+A}`}closePath(){this._x1!==null&&(this._x1=this._x0,this._y1=this._y0,this._append`Z`)}lineTo(E,A){this._append`L${this._x1=+E},${this._y1=+A}`}quadraticCurveTo(E,A,L,k){this._append`Q${+E},${+A},${this._x1=+L},${this._y1=+k}`}bezierCurveTo(E,A,L,k,Z,Y){this._append`C${+E},${+A},${+L},${+k},${this._x1=+Z},${this._y1=+Y}`}arcTo(E,A,L,k,Z){if(E=+E,A=+A,L=+L,k=+k,Z=+Z,Z<0)throw new Error(`negative radius: ${Z}`);let Y=this._x1,ee=this._y1,s=L-E,te=k-A,ae=Y-E,se=ee-A,fe=ae*ae+se*se;if(this._x1===null)this._append`M${this._x1=E},${this._y1=A}`;else if(fe>Al)if(!(Math.abs(se*s-te*ae)>Al)||!Z)this._append`L${this._x1=E},${this._y1=A}`;else{let _e=L-Y,qe=k-ee,nt=s*s+te*te,xt=_e*_e+qe*qe,lt=Math.sqrt(nt),$e=Math.sqrt(fe),ft=Z*Math.tan((X_-Math.acos((nt+fe-xt)/(2*lt*$e)))/2),Nt=ft/$e,Ot=ft/lt;Math.abs(Nt-1)>Al&&this._append`L${E+Nt*ae},${A+Nt*se}`,this._append`A${Z},${Z},0,0,${+(se*_e>ae*qe)},${this._x1=E+Ot*s},${this._y1=A+Ot*te}`}}arc(E,A,L,k,Z,Y){if(E=+E,A=+A,L=+L,Y=!!Y,L<0)throw new Error(`negative radius: ${L}`);let ee=L*Math.cos(k),s=L*Math.sin(k),te=E+ee,ae=A+s,se=1^Y,fe=Y?k-Z:Z-k;this._x1===null?this._append`M${te},${ae}`:(Math.abs(this._x1-te)>Al||Math.abs(this._y1-ae)>Al)&&this._append`L${te},${ae}`,L&&(fe<0&&(fe=fe%Y_+Y_),fe>TA?this._append`A${L},${L},0,1,${se},${E-ee},${A-s}A${L},${L},0,1,${se},${this._x1=te},${this._y1=ae}`:fe>Al&&this._append`A${L},${L},0,${+(fe>=X_)},${se},${this._x1=E+L*Math.cos(Z)},${this._y1=A+L*Math.sin(Z)}`)}rect(E,A,L,k){this._append`M${this._x0=this._x1=+E},${this._y0=this._y1=+A}h${L=+L}v${+k}h${-L}Z`}toString(){return this._}}var Bx={},S_={},P_=34,Yh=10,L_=13;function Bv(y){return new Function("d","return {"+y.map(function(E,A){return JSON.stringify(E)+": d["+A+'] || ""'}).join(",")+"}")}function IA(y,E){var A=Bv(y);return function(L,k){return E(A(L),k,y)}}function Fx(y){var E=Object.create(null),A=[];return y.forEach(function(L){for(var k in L)k in E||A.push(E[k]=k)}),A}function kn(y,E){var A=y+"",L=A.length;return L<E?new Array(E-L+1).join(0)+A:A}function CA(y){return y<0?"-"+kn(-y,6):y>9999?"+"+kn(y,6):kn(y,4)}function AA(y){var E=y.getUTCHours(),A=y.getUTCMinutes(),L=y.getUTCSeconds(),k=y.getUTCMilliseconds();return isNaN(y)?"Invalid Date":CA(y.getUTCFullYear())+"-"+kn(y.getUTCMonth()+1,2)+"-"+kn(y.getUTCDate(),2)+(k?"T"+kn(E,2)+":"+kn(A,2)+":"+kn(L,2)+"."+kn(k,3)+"Z":L?"T"+kn(E,2)+":"+kn(A,2)+":"+kn(L,2)+"Z":A||E?"T"+kn(E,2)+":"+kn(A,2)+"Z":"")}function SA(y){var E=new RegExp('["'+y+`
\r]`),A=y.charCodeAt(0);function L(se,fe){var _e,qe,nt=k(se,function(xt,lt){if(_e)return _e(xt,lt-1);qe=xt,_e=fe?IA(xt,fe):Bv(xt)});return nt.columns=qe||[],nt}function k(se,fe){var _e=[],qe=se.length,nt=0,xt=0,lt,$e=qe<=0,ft=!1;se.charCodeAt(qe-1)===Yh&&--qe,se.charCodeAt(qe-1)===L_&&--qe;function Nt(){if($e)return S_;if(ft)return ft=!1,Bx;var lr,Lr=nt,Er;if(se.charCodeAt(Lr)===P_){for(;nt++<qe&&se.charCodeAt(nt)!==P_||se.charCodeAt(++nt)===P_;);return(lr=nt)>=qe?$e=!0:(Er=se.charCodeAt(nt++))===Yh?ft=!0:Er===L_&&(ft=!0,se.charCodeAt(nt)===Yh&&++nt),se.slice(Lr+1,lr-1).replace(/""/g,'"')}for(;nt<qe;){if((Er=se.charCodeAt(lr=nt++))===Yh)ft=!0;else if(Er===L_)ft=!0,se.charCodeAt(nt)===Yh&&++nt;else if(Er!==A)continue;return se.slice(Lr,lr)}return $e=!0,se.slice(Lr,qe)}for(;(lt=Nt())!==S_;){for(var Ot=[];lt!==Bx&&lt!==S_;)Ot.push(lt),lt=Nt();fe&&(Ot=fe(Ot,xt++))==null||_e.push(Ot)}return _e}function Z(se,fe){return se.map(function(_e){return fe.map(function(qe){return ae(_e[qe])}).join(y)})}function Y(se,fe){return fe==null&&(fe=Fx(se)),[fe.map(ae).join(y)].concat(Z(se,fe)).join(`
`)}function ee(se,fe){return fe==null&&(fe=Fx(se)),Z(se,fe).join(`
`)}function s(se){return se.map(te).join(`
`)}function te(se){return se.map(ae).join(y)}function ae(se){return se==null?"":se instanceof Date?AA(se):E.test(se+="")?'"'+se.replace(/"/g,'""')+'"':se}return{parse:L,parseRows:k,format:Y,formatBody:ee,formatRows:s,formatRow:te,formatValue:ae}}var PA=SA(","),LA=PA.parse;function DA(y){if(!y.ok)throw new Error(y.status+" "+y.statusText);return y.text()}function zA(y,E){return fetch(y,E).then(DA)}function RA(y){return function(E,A,L){return arguments.length===2&&typeof A=="function"&&(L=A,A=void 0),zA(E,A).then(function(k){return y(k,L)})}}var wp=RA(LA);function OA(y){return Math.abs(y=Math.round(y))>=1e21?y.toLocaleString("en").replace(/,/g,""):y.toString(10)}function Tp(y,E){if((A=(y=E?y.toExponential(E-1):y.toExponential()).indexOf("e"))<0)return null;var A,L=y.slice(0,A);return[L.length>1?L[0]+L.slice(2):L,+y.slice(A+1)]}function $c(y){return y=Tp(Math.abs(y)),y?y[1]:NaN}function kA(y,E){return function(A,L){for(var k=A.length,Z=[],Y=0,ee=y[0],s=0;k>0&&ee>0&&(s+ee+1>L&&(ee=Math.max(1,L-s)),Z.push(A.substring(k-=ee,k+ee)),!((s+=ee+1)>L));)ee=y[Y=(Y+1)%y.length];return Z.reverse().join(E)}}function BA(y){return function(E){return E.replace(/[0-9]/g,function(A){return y[+A]})}}var FA=/^(?:(.)?([<>=^]))?([+\-( ])?([$#])?(0)?(\d+)?(,)?(\.\d+)?(~)?([a-z%])?$/i;function Ep(y){if(!(E=FA.exec(y)))throw new Error("invalid format: "+y);var E;return new lg({fill:E[1],align:E[2],sign:E[3],symbol:E[4],zero:E[5],width:E[6],comma:E[7],precision:E[8]&&E[8].slice(1),trim:E[9],type:E[10]})}Ep.prototype=lg.prototype;function lg(y){this.fill=y.fill===void 0?" ":y.fill+"",this.align=y.align===void 0?">":y.align+"",this.sign=y.sign===void 0?"-":y.sign+"",this.symbol=y.symbol===void 0?"":y.symbol+"",this.zero=!!y.zero,this.width=y.width===void 0?void 0:+y.width,this.comma=!!y.comma,this.precision=y.precision===void 0?void 0:+y.precision,this.trim=!!y.trim,this.type=y.type===void 0?"":y.type+""}lg.prototype.toString=function(){return this.fill+this.align+this.sign+this.symbol+(this.zero?"0":"")+(this.width===void 0?"":Math.max(1,this.width|0))+(this.comma?",":"")+(this.precision===void 0?"":"."+Math.max(0,this.precision|0))+(this.trim?"~":"")+this.type};function NA(y){e:for(var E=y.length,A=1,L=-1,k;A<E;++A)switch(y[A]){case".":L=k=A;break;case"0":L===0&&(L=A),k=A;break;default:if(!+y[A])break e;L>0&&(L=0);break}return L>0?y.slice(0,L)+y.slice(k+1):y}var Fv;function UA(y,E){var A=Tp(y,E);if(!A)return y+"";var L=A[0],k=A[1],Z=k-(Fv=Math.max(-8,Math.min(8,Math.floor(k/3)))*3)+1,Y=L.length;return Z===Y?L:Z>Y?L+new Array(Z-Y+1).join("0"):Z>0?L.slice(0,Z)+"."+L.slice(Z):"0."+new Array(1-Z).join("0")+Tp(y,Math.max(0,E+Z-1))[0]}function Nx(y,E){var A=Tp(y,E);if(!A)return y+"";var L=A[0],k=A[1];return k<0?"0."+new Array(-k).join("0")+L:L.length>k+1?L.slice(0,k+1)+"."+L.slice(k+1):L+new Array(k-L.length+2).join("0")}const Ux={"%":(y,E)=>(y*100).toFixed(E),b:y=>Math.round(y).toString(2),c:y=>y+"",d:OA,e:(y,E)=>y.toExponential(E),f:(y,E)=>y.toFixed(E),g:(y,E)=>y.toPrecision(E),o:y=>Math.round(y).toString(8),p:(y,E)=>Nx(y*100,E),r:Nx,s:UA,X:y=>Math.round(y).toString(16).toUpperCase(),x:y=>Math.round(y).toString(16)};function Vx(y){return y}var jx=Array.prototype.map,Zx=["y","z","a","f","p","n","","m","","k","M","G","T","P","E","Z","Y"];function VA(y){var E=y.grouping===void 0||y.thousands===void 0?Vx:kA(jx.call(y.grouping,Number),y.thousands+""),A=y.currency===void 0?"":y.currency[0]+"",L=y.currency===void 0?"":y.currency[1]+"",k=y.decimal===void 0?".":y.decimal+"",Z=y.numerals===void 0?Vx:BA(jx.call(y.numerals,String)),Y=y.percent===void 0?"%":y.percent+"",ee=y.minus===void 0?"":y.minus+"",s=y.nan===void 0?"NaN":y.nan+"";function te(se){se=Ep(se);var fe=se.fill,_e=se.align,qe=se.sign,nt=se.symbol,xt=se.zero,lt=se.width,$e=se.comma,ft=se.precision,Nt=se.trim,Ot=se.type;Ot==="n"?($e=!0,Ot="g"):Ux[Ot]||(ft===void 0&&(ft=12),Nt=!0,Ot="g"),(xt||fe==="0"&&_e==="=")&&(xt=!0,fe="0",_e="=");var lr=nt==="$"?A:nt==="#"&&/[boxX]/.test(Ot)?"0"+Ot.toLowerCase():"",Lr=nt==="$"?L:/[%p]/.test(Ot)?Y:"",Er=Ux[Ot],Ge=/[defgprs%]/.test(Ot);ft=ft===void 0?6:/[gprs]/.test(Ot)?Math.max(1,Math.min(21,ft)):Math.max(0,Math.min(20,ft));function qr(Gt){var St=lr,At=Lr,Sr,it,Ti;if(Ot==="c")At=Er(Gt)+At,Gt="";else{Gt=+Gt;var oi=Gt<0||1/Gt<0;if(Gt=isNaN(Gt)?s:Er(Math.abs(Gt),ft),Nt&&(Gt=NA(Gt)),oi&&+Gt==0&&qe!=="+"&&(oi=!1),St=(oi?qe==="("?qe:ee:qe==="-"||qe==="("?"":qe)+St,At=(Ot==="s"?Zx[8+Fv/3]:"")+At+(oi&&qe==="("?")":""),Ge){for(Sr=-1,it=Gt.length;++Sr<it;)if(Ti=Gt.charCodeAt(Sr),48>Ti||Ti>57){At=(Ti===46?k+Gt.slice(Sr+1):Gt.slice(Sr))+At,Gt=Gt.slice(0,Sr);break}}}$e&&!xt&&(Gt=E(Gt,1/0));var Ut=St.length+Gt.length+At.length,Ei=Ut<lt?new Array(lt-Ut+1).join(fe):"";switch($e&&xt&&(Gt=E(Ei+Gt,Ei.length?lt-At.length:1/0),Ei=""),_e){case"<":Gt=St+Gt+At+Ei;break;case"=":Gt=St+Ei+Gt+At;break;case"^":Gt=Ei.slice(0,Ut=Ei.length>>1)+St+Gt+At+Ei.slice(Ut);break;default:Gt=Ei+St+Gt+At;break}return Z(Gt)}return qr.toString=function(){return se+""},qr}function ae(se,fe){var _e=te((se=Ep(se),se.type="f",se)),qe=Math.max(-8,Math.min(8,Math.floor($c(fe)/3)))*3,nt=Math.pow(10,-qe),xt=Zx[8+qe/3];return function(lt){return _e(nt*lt)+xt}}return{format:te,formatPrefix:ae}}var op,cg,Nv;jA({thousands:",",grouping:[3],currency:["$",""]});function jA(y){return op=VA(y),cg=op.format,Nv=op.formatPrefix,op}function ZA(y){return Math.max(0,-$c(Math.abs(y)))}function GA(y,E){return Math.max(0,Math.max(-8,Math.min(8,Math.floor($c(E)/3)))*3-$c(Math.abs(y)))}function $A(y,E){return y=Math.abs(y),E=Math.abs(E)-y,Math.max(0,$c(E)-$c(y))+1}function qA(y){var E=0,A=y.children,L=A&&A.length;if(!L)E=1;else for(;--L>=0;)E+=A[L].value;y.value=E}function WA(){return this.eachAfter(qA)}function HA(y,E){let A=-1;for(const L of this)y.call(E,L,++A,this);return this}function XA(y,E){for(var A=this,L=[A],k,Z,Y=-1;A=L.pop();)if(y.call(E,A,++Y,this),k=A.children)for(Z=k.length-1;Z>=0;--Z)L.push(k[Z]);return this}function YA(y,E){for(var A=this,L=[A],k=[],Z,Y,ee,s=-1;A=L.pop();)if(k.push(A),Z=A.children)for(Y=0,ee=Z.length;Y<ee;++Y)L.push(Z[Y]);for(;A=k.pop();)y.call(E,A,++s,this);return this}function KA(y,E){let A=-1;for(const L of this)if(y.call(E,L,++A,this))return L}function JA(y){return this.eachAfter(function(E){for(var A=+y(E.data)||0,L=E.children,k=L&&L.length;--k>=0;)A+=L[k].value;E.value=A})}function QA(y){return this.eachBefore(function(E){E.children&&E.children.sort(y)})}function eS(y){for(var E=this,A=tS(E,y),L=[E];E!==A;)E=E.parent,L.push(E);for(var k=L.length;y!==A;)L.splice(k,0,y),y=y.parent;return L}function tS(y,E){if(y===E)return y;var A=y.ancestors(),L=E.ancestors(),k=null;for(y=A.pop(),E=L.pop();y===E;)k=y,y=A.pop(),E=L.pop();return k}function rS(){for(var y=this,E=[y];y=y.parent;)E.push(y);return E}function iS(){return Array.from(this)}function nS(){var y=[];return this.eachBefore(function(E){E.children||y.push(E)}),y}function oS(){var y=this,E=[];return y.each(function(A){A!==y&&E.push({source:A.parent,target:A})}),E}function*sS(){var y=this,E,A=[y],L,k,Z;do for(E=A.reverse(),A=[];y=E.pop();)if(yield y,L=y.children)for(k=0,Z=L.length;k<Z;++k)A.push(L[k]);while(A.length)}function Mp(y,E){y instanceof Map?(y=[void 0,y],E===void 0&&(E=cS)):E===void 0&&(E=lS);for(var A=new Ip(y),L,k=[A],Z,Y,ee,s;L=k.pop();)if((Y=E(L.data))&&(s=(Y=Array.from(Y)).length))for(L.children=Y,ee=s-1;ee>=0;--ee)k.push(Z=Y[ee]=new Ip(Y[ee])),Z.parent=L,Z.depth=L.depth+1;return A.eachBefore(hS)}function aS(){return Mp(this).eachBefore(uS)}function lS(y){return y.children}function cS(y){return Array.isArray(y)?y[1]:null}function uS(y){y.data.value!==void 0&&(y.value=y.data.value),y.data=y.data.data}function hS(y){var E=0;do y.height=E;while((y=y.parent)&&y.height<++E)}function Ip(y){this.data=y,this.depth=this.height=0,this.parent=null}Ip.prototype=Mp.prototype={constructor:Ip,count:WA,each:HA,eachAfter:YA,eachBefore:XA,find:KA,sum:JA,sort:QA,path:eS,ancestors:rS,descendants:iS,leaves:nS,links:oS,copy:aS,[Symbol.iterator]:sS};function dS(y){return y==null?null:fS(y)}function fS(y){if(typeof y!="function")throw new Error;return y}function Gx(){return 0}function pS(y){return function(){return y}}const mS=1664525,_S=1013904223,$x=4294967296;function gS(){let y=1;return()=>(y=(mS*y+_S)%$x)/$x}function yS(y){return typeof y=="object"&&"length"in y?y:Array.from(y)}function xS(y,E){let A=y.length,L,k;for(;A;)k=E()*A--|0,L=y[A],y[A]=y[k],y[k]=L;return y}function vS(y,E){for(var A=0,L=(y=xS(Array.from(y),E)).length,k=[],Z,Y;A<L;)Z=y[A],Y&&Uv(Y,Z)?++A:(Y=wS(k=bS(k,Z)),A=0);return Y}function bS(y,E){var A,L;if(D_(E,y))return[E];for(A=0;A<y.length;++A)if(sp(E,y[A])&&D_(ed(y[A],E),y))return[y[A],E];for(A=0;A<y.length-1;++A)for(L=A+1;L<y.length;++L)if(sp(ed(y[A],y[L]),E)&&sp(ed(y[A],E),y[L])&&sp(ed(y[L],E),y[A])&&D_(Vv(y[A],y[L],E),y))return[y[A],y[L],E];throw new Error}function sp(y,E){var A=y.r-E.r,L=E.x-y.x,k=E.y-y.y;return A<0||A*A<L*L+k*k}function Uv(y,E){var A=y.r-E.r+Math.max(y.r,E.r,1)*1e-9,L=E.x-y.x,k=E.y-y.y;return A>0&&A*A>L*L+k*k}function D_(y,E){for(var A=0;A<E.length;++A)if(!Uv(y,E[A]))return!1;return!0}function wS(y){switch(y.length){case 1:return TS(y[0]);case 2:return ed(y[0],y[1]);case 3:return Vv(y[0],y[1],y[2])}}function TS(y){return{x:y.x,y:y.y,r:y.r}}function ed(y,E){var A=y.x,L=y.y,k=y.r,Z=E.x,Y=E.y,ee=E.r,s=Z-A,te=Y-L,ae=ee-k,se=Math.sqrt(s*s+te*te);return{x:(A+Z+s/se*ae)/2,y:(L+Y+te/se*ae)/2,r:(se+k+ee)/2}}function Vv(y,E,A){var L=y.x,k=y.y,Z=y.r,Y=E.x,ee=E.y,s=E.r,te=A.x,ae=A.y,se=A.r,fe=L-Y,_e=L-te,qe=k-ee,nt=k-ae,xt=s-Z,lt=se-Z,$e=L*L+k*k-Z*Z,ft=$e-Y*Y-ee*ee+s*s,Nt=$e-te*te-ae*ae+se*se,Ot=_e*qe-fe*nt,lr=(qe*Nt-nt*ft)/(Ot*2)-L,Lr=(nt*xt-qe*lt)/Ot,Er=(_e*ft-fe*Nt)/(Ot*2)-k,Ge=(fe*lt-_e*xt)/Ot,qr=Lr*Lr+Ge*Ge-1,Gt=2*(Z+lr*Lr+Er*Ge),St=lr*lr+Er*Er-Z*Z,At=-(Math.abs(qr)>1e-6?(Gt+Math.sqrt(Gt*Gt-4*qr*St))/(2*qr):St/Gt);return{x:L+lr+Lr*At,y:k+Er+Ge*At,r:At}}function qx(y,E,A){var L=y.x-E.x,k,Z,Y=y.y-E.y,ee,s,te=L*L+Y*Y;te?(Z=E.r+A.r,Z*=Z,s=y.r+A.r,s*=s,Z>s?(k=(te+s-Z)/(2*te),ee=Math.sqrt(Math.max(0,s/te-k*k)),A.x=y.x-k*L-ee*Y,A.y=y.y-k*Y+ee*L):(k=(te+Z-s)/(2*te),ee=Math.sqrt(Math.max(0,Z/te-k*k)),A.x=E.x+k*L-ee*Y,A.y=E.y+k*Y+ee*L)):(A.x=E.x+A.r,A.y=E.y)}function Wx(y,E){var A=y.r+E.r-1e-6,L=E.x-y.x,k=E.y-y.y;return A>0&&A*A>L*L+k*k}function Hx(y){var E=y._,A=y.next._,L=E.r+A.r,k=(E.x*A.r+A.x*E.r)/L,Z=(E.y*A.r+A.y*E.r)/L;return k*k+Z*Z}function ap(y){this._=y,this.next=null,this.previous=null}function ES(y,E){if(!(Z=(y=yS(y)).length))return 0;var A,L,k,Z,Y,ee,s,te,ae,se,fe;if(A=y[0],A.x=0,A.y=0,!(Z>1))return A.r;if(L=y[1],A.x=-L.r,L.x=A.r,L.y=0,!(Z>2))return A.r+L.r;qx(L,A,k=y[2]),A=new ap(A),L=new ap(L),k=new ap(k),A.next=k.previous=L,L.next=A.previous=k,k.next=L.previous=A;e:for(s=3;s<Z;++s){qx(A._,L._,k=y[s]),k=new ap(k),te=L.next,ae=A.previous,se=L._.r,fe=A._.r;do if(se<=fe){if(Wx(te._,k._)){L=te,A.next=L,L.previous=A,--s;continue e}se+=te._.r,te=te.next}else{if(Wx(ae._,k._)){A=ae,A.next=L,L.previous=A,--s;continue e}fe+=ae._.r,ae=ae.previous}while(te!==ae.next);for(k.previous=A,k.next=L,A.next=L.previous=L=k,Y=Hx(A);(k=k.next)!==L;)(ee=Hx(k))<Y&&(A=k,Y=ee);L=A.next}for(A=[L._],k=L;(k=k.next)!==L;)A.push(k._);for(k=vS(A,E),s=0;s<Z;++s)A=y[s],A.x-=k.x,A.y-=k.y;return k.r}function MS(y){return Math.sqrt(y.value)}function Xx(){var y=null,E=1,A=1,L=Gx;function k(Z){const Y=gS();return Z.x=E/2,Z.y=A/2,y?Z.eachBefore(Yx(y)).eachAfter(z_(L,.5,Y)).eachBefore(Kx(1)):Z.eachBefore(Yx(MS)).eachAfter(z_(Gx,1,Y)).eachAfter(z_(L,Z.r/Math.min(E,A),Y)).eachBefore(Kx(Math.min(E,A)/(2*Z.r))),Z}return k.radius=function(Z){return arguments.length?(y=dS(Z),k):y},k.size=function(Z){return arguments.length?(E=+Z[0],A=+Z[1],k):[E,A]},k.padding=function(Z){return arguments.length?(L=typeof Z=="function"?Z:pS(+Z),k):L},k}function Yx(y){return function(E){E.children||(E.r=Math.max(0,+y(E)||0))}}function z_(y,E,A){return function(L){if(k=L.children){var k,Z,Y=k.length,ee=y(L)*E||0,s;if(ee)for(Z=0;Z<Y;++Z)k[Z].r+=ee;if(s=ES(k,A),ee)for(Z=0;Z<Y;++Z)k[Z].r-=ee;L.r=s+ee}}}function Kx(y){return function(E){var A=E.parent;E.r*=y,A&&(E.x=A.x+y*E.x,E.y=A.y+y*E.y)}}function ug(y,E){switch(arguments.length){case 0:break;case 1:this.range(y);break;default:this.range(E).domain(y);break}return this}const Jx=Symbol("implicit");function ld(){var y=new N_,E=[],A=[],L=Jx;function k(Z){let Y=y.get(Z);if(Y===void 0){if(L!==Jx)return L;y.set(Z,Y=E.push(Z)-1)}return A[Y%A.length]}return k.domain=function(Z){if(!arguments.length)return E.slice();E=[],y=new N_;for(const Y of Z)y.has(Y)||y.set(Y,E.push(Y)-1);return k},k.range=function(Z){return arguments.length?(A=Array.from(Z),k):A.slice()},k.unknown=function(Z){return arguments.length?(L=Z,k):L},k.copy=function(){return ld(E,A).unknown(L)},ug.apply(k,arguments),k}function hg(){var y=ld().unknown(void 0),E=y.domain,A=y.range,L=0,k=1,Z,Y,ee=!1,s=0,te=0,ae=.5;delete y.unknown;function se(){var fe=E().length,_e=k<L,qe=_e?k:L,nt=_e?L:k;Z=(nt-qe)/Math.max(1,fe-s+te*2),ee&&(Z=Math.floor(Z)),qe+=(nt-qe-Z*(fe-s))*ae,Y=Z*(1-s),ee&&(qe=Math.round(qe),Y=Math.round(Y));var xt=YE(fe).map(function(lt){return qe+Z*lt});return A(_e?xt.reverse():xt)}return y.domain=function(fe){return arguments.length?(E(fe),se()):E()},y.range=function(fe){return arguments.length?([L,k]=fe,L=+L,k=+k,se()):[L,k]},y.rangeRound=function(fe){return[L,k]=fe,L=+L,k=+k,ee=!0,se()},y.bandwidth=function(){return Y},y.step=function(){return Z},y.round=function(fe){return arguments.length?(ee=!!fe,se()):ee},y.padding=function(fe){return arguments.length?(s=Math.min(1,te=+fe),se()):s},y.paddingInner=function(fe){return arguments.length?(s=Math.min(1,fe),se()):s},y.paddingOuter=function(fe){return arguments.length?(te=+fe,se()):te},y.align=function(fe){return arguments.length?(ae=Math.max(0,Math.min(1,fe)),se()):ae},y.copy=function(){return hg(E(),[L,k]).round(ee).paddingInner(s).paddingOuter(te).align(ae)},ug.apply(se(),arguments)}function IS(y){return function(){return y}}function CS(y){return+y}var Qx=[0,1];function Nc(y){return y}function K_(y,E){return(E-=y=+y)?function(A){return(A-y)/E}:IS(isNaN(E)?NaN:.5)}function AS(y,E){var A;return y>E&&(A=y,y=E,E=A),function(L){return Math.max(y,Math.min(E,L))}}function SS(y,E,A){var L=y[0],k=y[1],Z=E[0],Y=E[1];return k<L?(L=K_(k,L),Z=A(Y,Z)):(L=K_(L,k),Z=A(Z,Y)),function(ee){return Z(L(ee))}}function PS(y,E,A){var L=Math.min(y.length,E.length)-1,k=new Array(L),Z=new Array(L),Y=-1;for(y[L]<y[0]&&(y=y.slice().reverse(),E=E.slice().reverse());++Y<L;)k[Y]=K_(y[Y],y[Y+1]),Z[Y]=A(E[Y],E[Y+1]);return function(ee){var s=UE(y,ee,1,L)-1;return Z[s](k[s](ee))}}function LS(y,E){return E.domain(y.domain()).range(y.range()).interpolate(y.interpolate()).clamp(y.clamp()).unknown(y.unknown())}function DS(){var y=Qx,E=Qx,A=ng,L,k,Z,Y=Nc,ee,s,te;function ae(){var fe=Math.min(y.length,E.length);return Y!==Nc&&(Y=AS(y[0],y[fe-1])),ee=fe>2?PS:SS,s=te=null,se}function se(fe){return fe==null||isNaN(fe=+fe)?Z:(s||(s=ee(y.map(L),E,A)))(L(Y(fe)))}return se.invert=function(fe){return Y(k((te||(te=ee(E,y.map(L),Lo)))(fe)))},se.domain=function(fe){return arguments.length?(y=Array.from(fe,CS),ae()):y.slice()},se.range=function(fe){return arguments.length?(E=Array.from(fe),ae()):E.slice()},se.rangeRound=function(fe){return E=Array.from(fe),A=sC,ae()},se.clamp=function(fe){return arguments.length?(Y=fe?!0:Nc,ae()):Y!==Nc},se.interpolate=function(fe){return arguments.length?(A=fe,ae()):A},se.unknown=function(fe){return arguments.length?(Z=fe,se):Z},function(fe,_e){return L=fe,k=_e,ae()}}function zS(){return DS()(Nc,Nc)}function RS(y,E,A,L){var k=XE(y,E,A),Z;switch(L=Ep(L??",f"),L.type){case"s":{var Y=Math.max(Math.abs(y),Math.abs(E));return L.precision==null&&!isNaN(Z=GA(k,Y))&&(L.precision=Z),Nv(L,Y)}case"":case"e":case"g":case"p":case"r":{L.precision==null&&!isNaN(Z=$A(k,Math.max(Math.abs(y),Math.abs(E))))&&(L.precision=Z-(L.type==="e"));break}case"f":case"%":{L.precision==null&&!isNaN(Z=ZA(k))&&(L.precision=Z-(L.type==="%")*2);break}}return cg(L)}function OS(y){var E=y.domain;return y.ticks=function(A){var L=E();return HE(L[0],L[L.length-1],A??10)},y.tickFormat=function(A,L){var k=E();return RS(k[0],k[k.length-1],A??10,L)},y.nice=function(A){A==null&&(A=10);var L=E(),k=0,Z=L.length-1,Y=L[k],ee=L[Z],s,te,ae=10;for(ee<Y&&(te=Y,Y=ee,ee=te,te=k,k=Z,Z=te);ae-- >0;){if(te=U_(Y,ee,A),te===s)return L[k]=Y,L[Z]=ee,E(L);if(te>0)Y=Math.floor(Y/te)*te,ee=Math.ceil(ee/te)*te;else if(te<0)Y=Math.ceil(Y*te)/te,ee=Math.floor(ee*te)/te;else break;s=te}return y},y}function dg(){var y=zS();return y.copy=function(){return LS(y,dg())},ug.apply(y,arguments),OS(y)}function jv(y){for(var E=y.length/6|0,A=new Array(E),L=0;L<E;)A[L]="#"+y.slice(L*6,++L*6);return A}const kS=jv("1f77b4ff7f0e2ca02cd627289467bd8c564be377c27f7f7fbcbd2217becf"),Zv=jv("4e79a7f28e2ce1575976b7b259a14fedc949af7aa1ff9da79c755fbab0ab");function Fi(y){return function(){return y}}const ev=Math.abs,fn=Math.atan2,Cl=Math.cos,BS=Math.max,R_=Math.min,os=Math.sin,Uc=Math.sqrt,On=1e-12,od=Math.PI,Cp=od/2,fp=2*od;function FS(y){return y>1?0:y<-1?od:Math.acos(y)}function tv(y){return y>=1?Cp:y<=-1?-Cp:Math.asin(y)}function Gv(y){let E=3;return y.digits=function(A){if(!arguments.length)return E;if(A==null)E=null;else{const L=Math.floor(A);if(!(L>=0))throw new RangeError(`invalid digits: ${A}`);E=L}return y},()=>new MA(E)}function NS(y){return y.innerRadius}function US(y){return y.outerRadius}function VS(y){return y.startAngle}function jS(y){return y.endAngle}function ZS(y){return y&&y.padAngle}function GS(y,E,A,L,k,Z,Y,ee){var s=A-y,te=L-E,ae=Y-k,se=ee-Z,fe=se*s-ae*te;if(!(fe*fe<On))return fe=(ae*(E-Z)-se*(y-k))/fe,[y+fe*s,E+fe*te]}function lp(y,E,A,L,k,Z,Y){var ee=y-A,s=E-L,te=(Y?Z:-Z)/Uc(ee*ee+s*s),ae=te*s,se=-te*ee,fe=y+ae,_e=E+se,qe=A+ae,nt=L+se,xt=(fe+qe)/2,lt=(_e+nt)/2,$e=qe-fe,ft=nt-_e,Nt=$e*$e+ft*ft,Ot=k-Z,lr=fe*nt-qe*_e,Lr=(ft<0?-1:1)*Uc(BS(0,Ot*Ot*Nt-lr*lr)),Er=(lr*ft-$e*Lr)/Nt,Ge=(-lr*$e-ft*Lr)/Nt,qr=(lr*ft+$e*Lr)/Nt,Gt=(-lr*$e+ft*Lr)/Nt,St=Er-xt,At=Ge-lt,Sr=qr-xt,it=Gt-lt;return St*St+At*At>Sr*Sr+it*it&&(Er=qr,Ge=Gt),{cx:Er,cy:Ge,x01:-ae,y01:-se,x11:Er*(k/Ot-1),y11:Ge*(k/Ot-1)}}function $S(){var y=NS,E=US,A=Fi(0),L=null,k=VS,Z=jS,Y=ZS,ee=null,s=Gv(te);function te(){var ae,se,fe=+y.apply(this,arguments),_e=+E.apply(this,arguments),qe=k.apply(this,arguments)-Cp,nt=Z.apply(this,arguments)-Cp,xt=ev(nt-qe),lt=nt>qe;if(ee||(ee=ae=s()),_e<fe&&(se=_e,_e=fe,fe=se),!(_e>On))ee.moveTo(0,0);else if(xt>fp-On)ee.moveTo(_e*Cl(qe),_e*os(qe)),ee.arc(0,0,_e,qe,nt,!lt),fe>On&&(ee.moveTo(fe*Cl(nt),fe*os(nt)),ee.arc(0,0,fe,nt,qe,lt));else{var $e=qe,ft=nt,Nt=qe,Ot=nt,lr=xt,Lr=xt,Er=Y.apply(this,arguments)/2,Ge=Er>On&&(L?+L.apply(this,arguments):Uc(fe*fe+_e*_e)),qr=R_(ev(_e-fe)/2,+A.apply(this,arguments)),Gt=qr,St=qr,At,Sr;if(Ge>On){var it=tv(Ge/fe*os(Er)),Ti=tv(Ge/_e*os(Er));(lr-=it*2)>On?(it*=lt?1:-1,Nt+=it,Ot-=it):(lr=0,Nt=Ot=(qe+nt)/2),(Lr-=Ti*2)>On?(Ti*=lt?1:-1,$e+=Ti,ft-=Ti):(Lr=0,$e=ft=(qe+nt)/2)}var oi=_e*Cl($e),Ut=_e*os($e),Ei=fe*Cl(Ot),mn=fe*os(Ot);if(qr>On){var qi=_e*Cl(ft),gi=_e*os(ft),Fn=fe*Cl(Nt),eo=fe*os(Nt),Yi;if(xt<od)if(Yi=GS(oi,Ut,Fn,eo,qi,gi,Ei,mn)){var co=oi-Yi[0],uo=Ut-Yi[1],Nn=qi-Yi[0],_n=gi-Yi[1],Ci=1/os(FS((co*Nn+uo*_n)/(Uc(co*co+uo*uo)*Uc(Nn*Nn+_n*_n)))/2),Ki=Uc(Yi[0]*Yi[0]+Yi[1]*Yi[1]);Gt=R_(qr,(fe-Ki)/(Ci-1)),St=R_(qr,(_e-Ki)/(Ci+1))}else Gt=St=0}Lr>On?St>On?(At=lp(Fn,eo,oi,Ut,_e,St,lt),Sr=lp(qi,gi,Ei,mn,_e,St,lt),ee.moveTo(At.cx+At.x01,At.cy+At.y01),St<qr?ee.arc(At.cx,At.cy,St,fn(At.y01,At.x01),fn(Sr.y01,Sr.x01),!lt):(ee.arc(At.cx,At.cy,St,fn(At.y01,At.x01),fn(At.y11,At.x11),!lt),ee.arc(0,0,_e,fn(At.cy+At.y11,At.cx+At.x11),fn(Sr.cy+Sr.y11,Sr.cx+Sr.x11),!lt),ee.arc(Sr.cx,Sr.cy,St,fn(Sr.y11,Sr.x11),fn(Sr.y01,Sr.x01),!lt))):(ee.moveTo(oi,Ut),ee.arc(0,0,_e,$e,ft,!lt)):ee.moveTo(oi,Ut),!(fe>On)||!(lr>On)?ee.lineTo(Ei,mn):Gt>On?(At=lp(Ei,mn,qi,gi,fe,-Gt,lt),Sr=lp(oi,Ut,Fn,eo,fe,-Gt,lt),ee.lineTo(At.cx+At.x01,At.cy+At.y01),Gt<qr?ee.arc(At.cx,At.cy,Gt,fn(At.y01,At.x01),fn(Sr.y01,Sr.x01),!lt):(ee.arc(At.cx,At.cy,Gt,fn(At.y01,At.x01),fn(At.y11,At.x11),!lt),ee.arc(0,0,fe,fn(At.cy+At.y11,At.cx+At.x11),fn(Sr.cy+Sr.y11,Sr.cx+Sr.x11),lt),ee.arc(Sr.cx,Sr.cy,Gt,fn(Sr.y11,Sr.x11),fn(Sr.y01,Sr.x01),!lt))):ee.arc(0,0,fe,Ot,Nt,lt)}if(ee.closePath(),ae)return ee=null,ae+""||null}return te.centroid=function(){var ae=(+y.apply(this,arguments)+ +E.apply(this,arguments))/2,se=(+k.apply(this,arguments)+ +Z.apply(this,arguments))/2-od/2;return[Cl(se)*ae,os(se)*ae]},te.innerRadius=function(ae){return arguments.length?(y=typeof ae=="function"?ae:Fi(+ae),te):y},te.outerRadius=function(ae){return arguments.length?(E=typeof ae=="function"?ae:Fi(+ae),te):E},te.cornerRadius=function(ae){return arguments.length?(A=typeof ae=="function"?ae:Fi(+ae),te):A},te.padRadius=function(ae){return arguments.length?(L=ae==null?null:typeof ae=="function"?ae:Fi(+ae),te):L},te.startAngle=function(ae){return arguments.length?(k=typeof ae=="function"?ae:Fi(+ae),te):k},te.endAngle=function(ae){return arguments.length?(Z=typeof ae=="function"?ae:Fi(+ae),te):Z},te.padAngle=function(ae){return arguments.length?(Y=typeof ae=="function"?ae:Fi(+ae),te):Y},te.context=function(ae){return arguments.length?(ee=ae??null,te):ee},te}function $v(y){return typeof y=="object"&&"length"in y?y:Array.from(y)}function qv(y){this._context=y}qv.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){(this._line||this._line!==0&&this._point===1)&&this._context.closePath(),this._line=1-this._line},point:function(y,E){switch(y=+y,E=+E,this._point){case 0:this._point=1,this._line?this._context.lineTo(y,E):this._context.moveTo(y,E);break;case 1:this._point=2;default:this._context.lineTo(y,E);break}}};function qS(y){return new qv(y)}function WS(y){return y[0]}function HS(y){return y[1]}function rv(y,E){var A=Fi(!0),L=null,k=qS,Z=null,Y=Gv(ee);y=typeof y=="function"?y:y===void 0?WS:Fi(y),E=typeof E=="function"?E:E===void 0?HS:Fi(E);function ee(s){var te,ae=(s=$v(s)).length,se,fe=!1,_e;for(L==null&&(Z=k(_e=Y())),te=0;te<=ae;++te)!(te<ae&&A(se=s[te],te,s))===fe&&((fe=!fe)?Z.lineStart():Z.lineEnd()),fe&&Z.point(+y(se,te,s),+E(se,te,s));if(_e)return Z=null,_e+""||null}return ee.x=function(s){return arguments.length?(y=typeof s=="function"?s:Fi(+s),ee):y},ee.y=function(s){return arguments.length?(E=typeof s=="function"?s:Fi(+s),ee):E},ee.defined=function(s){return arguments.length?(A=typeof s=="function"?s:Fi(!!s),ee):A},ee.curve=function(s){return arguments.length?(k=s,L!=null&&(Z=k(L)),ee):k},ee.context=function(s){return arguments.length?(s==null?L=Z=null:Z=k(L=s),ee):L},ee}function XS(y,E){return E<y?-1:E>y?1:E>=y?0:NaN}function YS(y){return y}function KS(){var y=YS,E=XS,A=null,L=Fi(0),k=Fi(fp),Z=Fi(0);function Y(ee){var s,te=(ee=$v(ee)).length,ae,se,fe=0,_e=new Array(te),qe=new Array(te),nt=+L.apply(this,arguments),xt=Math.min(fp,Math.max(-fp,k.apply(this,arguments)-nt)),lt,$e=Math.min(Math.abs(xt)/te,Z.apply(this,arguments)),ft=$e*(xt<0?-1:1),Nt;for(s=0;s<te;++s)(Nt=qe[_e[s]=s]=+y(ee[s],s,ee))>0&&(fe+=Nt);for(E!=null?_e.sort(function(Ot,lr){return E(qe[Ot],qe[lr])}):A!=null&&_e.sort(function(Ot,lr){return A(ee[Ot],ee[lr])}),s=0,se=fe?(xt-te*ft)/fe:0;s<te;++s,nt=lt)ae=_e[s],Nt=qe[ae],lt=nt+(Nt>0?Nt*se:0)+ft,qe[ae]={data:ee[ae],index:s,value:Nt,startAngle:nt,endAngle:lt,padAngle:$e};return qe}return Y.value=function(ee){return arguments.length?(y=typeof ee=="function"?ee:Fi(+ee),Y):y},Y.sortValues=function(ee){return arguments.length?(E=ee,A=null,Y):E},Y.sort=function(ee){return arguments.length?(A=ee,E=null,Y):A},Y.startAngle=function(ee){return arguments.length?(L=typeof ee=="function"?ee:Fi(+ee),Y):L},Y.endAngle=function(ee){return arguments.length?(k=typeof ee=="function"?ee:Fi(+ee),Y):k},Y.padAngle=function(ee){return arguments.length?(Z=typeof ee=="function"?ee:Fi(+ee),Y):Z},Y}function td(y,E,A){this.k=y,this.x=E,this.y=A}td.prototype={constructor:td,scale:function(y){return y===1?this:new td(this.k*y,this.x,this.y)},translate:function(y,E){return y===0&E===0?this:new td(this.k,this.x+this.k*y,this.y+this.k*E)},apply:function(y){return[y[0]*this.k+this.x,y[1]*this.k+this.y]},applyX:function(y){return y*this.k+this.x},applyY:function(y){return y*this.k+this.y},invert:function(y){return[(y[0]-this.x)/this.k,(y[1]-this.y)/this.k]},invertX:function(y){return(y-this.x)/this.k},invertY:function(y){return(y-this.y)/this.k},rescaleX:function(y){return y.copy().domain(y.range().map(this.invertX,this).map(y.invert,y))},rescaleY:function(y){return y.copy().domain(y.range().map(this.invertY,this).map(y.invert,y))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};td.prototype;const JS=[{ZIPCODE:"02238",count_of_address:1,Latitude_generated:42.375,longitude_generated:-71.10610199},{ZIPCODE:"02215",count_of_address:28,Latitude_generated:42.3472,longitude_generated:-71.099688298},{ZIPCODE:"02210",count_of_address:10,Latitude_generated:42.347000122,longitude_generated:-71.041000366},{ZIPCODE:"02199",count_of_address:1,Latitude_generated:42.346599579,longitude_generated:-71.082702637},{ZIPCODE:"02142",count_of_address:5,Latitude_generated:42.36289978,longitude_generated:-71.084701538},{ZIPCODE:"02141",count_of_address:24,Latitude_generated:42.370399475,longitude_generated:-71.082199097},{ZIPCODE:"02140-1841",count_of_address:1,Latitude_generated:42.393398285,longitude_generated:-71.134101868},{ZIPCODE:"02140-1124",count_of_address:1,Latitude_generated:42.393398285,longitude_generated:-71.134101868},{ZIPCODE:"02140",count_of_address:24,Latitude_generated:42.393398285,longitude_generated:-71.134101868},{ZIPCODE:"02139-4745",count_of_address:1,Latitude_generated:42.363498688,longitude_generated:-71.103500366},{ZIPCODE:"02139-4019",count_of_address:1,Latitude_generated:42.363498688,longitude_generated:-71.103500366},{ZIPCODE:"02139-3928",count_of_address:1,Latitude_generated:42.363498688,longitude_generated:-71.103500366},{ZIPCODE:"02139-1116",count_of_address:1,Latitude_generated:42.363498688,longitude_generated:-71.103500366},{ZIPCODE:"02139-1113",count_of_address:1,Latitude_generated:42.363498688,longitude_generated:-71.103500366},{ZIPCODE:"02139-1017",count_of_address:1,Latitude_generated:42.363498688,longitude_generated:-71.103500366},{ZIPCODE:"02139",count_of_address:50,Latitude_generated:42.363498688,longitude_generated:-71.103500366},{ZIPCODE:"02138-6832",count_of_address:1,Latitude_generated:42.379299164,longitude_generated:-71.13469696},{ZIPCODE:"02138-4646",count_of_address:1,Latitude_generated:42.379299164,longitude_generated:-71.13469696},{ZIPCODE:"02138-4531",count_of_address:1,Latitude_generated:42.379299164,longitude_generated:-71.13469696},{ZIPCODE:"02138-2121",count_of_address:1,Latitude_generated:42.379299164,longitude_generated:-71.13469696},{ZIPCODE:"02138",count_of_address:48,Latitude_generated:42.379299164,longitude_generated:-71.13469696},{ZIPCODE:"02136",count_of_address:115,Latitude_generated:42.254573275,longitude_generated:-71.125281891},{ZIPCODE:"02133",count_of_address:1,Latitude_generated:42.357898712,longitude_generated:-71.063499451},{ZIPCODE:"02132",count_of_address:75,Latitude_generated:42.278388487,longitude_generated:-71.16006103},{ZIPCODE:"02131",count_of_address:233,Latitude_generated:42.28275,longitude_generated:-71.125859439},{ZIPCODE:"02130",count_of_address:255,Latitude_generated:42.307899475,longitude_generated:-71.112701416},{ZIPCODE:"02129",count_of_address:89,Latitude_generated:42.379199982,longitude_generated:-71.064399719},{ZIPCODE:"02128",count_of_address:212,Latitude_generated:42.37275,longitude_generated:-71.02818},{ZIPCODE:"02127",count_of_address:277,Latitude_generated:42.3357,longitude_generated:-71.040740733},{ZIPCODE:"02126",count_of_address:26,Latitude_generated:42.276500702,longitude_generated:-71.093002319},{ZIPCODE:"02125",count_of_address:136,Latitude_generated:42.31865,longitude_generated:-71.057624145},{ZIPCODE:"02124",count_of_address:121,Latitude_generated:42.285853705,longitude_generated:-71.071814029},{ZIPCODE:"02122",count_of_address:126,Latitude_generated:42.29445,longitude_generated:-71.052695703},{ZIPCODE:"02121",count_of_address:55,Latitude_generated:42.307373545,longitude_generated:-71.082806865},{ZIPCODE:"02120",count_of_address:37,Latitude_generated:42.332656641,longitude_generated:-71.095659537},{ZIPCODE:"02119",count_of_address:111,Latitude_generated:42.3238,longitude_generated:-71.083608708},{ZIPCODE:"02118",count_of_address:82,Latitude_generated:42.3379156,longitude_generated:-71.069753417},{ZIPCODE:"02116",count_of_address:56,Latitude_generated:42.349179535,longitude_generated:-71.074520575},{ZIPCODE:"02115",count_of_address:31,Latitude_generated:42.34155,longitude_generated:-71.088459936},{ZIPCODE:"02114",count_of_address:20,Latitude_generated:42.362201691,longitude_generated:-71.066398621},{ZIPCODE:"02113",count_of_address:18,Latitude_generated:42.364299774,longitude_generated:-71.057502747},{ZIPCODE:"02111",count_of_address:3,Latitude_generated:42.350741429,longitude_generated:-71.05914918},{ZIPCODE:"02110",count_of_address:6,Latitude_generated:42.355850624,longitude_generated:-71.055570374},{ZIPCODE:"02109",count_of_address:6,Latitude_generated:42.3632,longitude_generated:-71.053075619},{ZIPCODE:"02108",count_of_address:23,Latitude_generated:42.356001176,longitude_generated:-71.066357458}],QS=[{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:1,1890:0,1900:0,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"01742"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:1,1880:0,1890:0,1900:0,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"01757"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:1,1880:0,1890:0,1900:0,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"01760"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:0,1900:0,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:1,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"01824"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:0,1900:0,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:1,2020:0,ZIPCODE:"01845"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:1,1890:0,1900:0,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"01880"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:0,1900:0,1910:0,1920:1,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"01890"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:1,1880:0,1890:0,1900:0,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"01940"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:1,1890:0,1900:0,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"01945"},{1800:1,1810:0,1820:1,1830:0,1840:1,1850:0,1860:0,1870:1,1880:0,1890:12,1900:3,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:1,2020:0,ZIPCODE:"02108"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:1,1870:0,1880:0,1890:0,1900:1,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:1,2010:0,2020:0,ZIPCODE:"02109"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:1,1880:0,1890:0,1900:0,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:1,2e3:0,2010:0,2020:0,ZIPCODE:"02110"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:1,1900:0,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:1,2020:0,ZIPCODE:"02111"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:4,1900:3,1910:3,1920:3,1930:0,1940:1,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:1,ZIPCODE:"02113"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:2,1860:1,1870:0,1880:1,1890:3,1900:2,1910:0,1920:0,1930:0,1940:0,1950:0,1960:1,1970:0,1980:0,1990:0,2e3:0,2010:4,2020:0,ZIPCODE:"02114"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:9,1900:1,1910:2,1920:2,1930:2,1940:0,1950:0,1960:1,1970:1,1980:1,1990:1,2e3:0,2010:1,2020:0,ZIPCODE:"02115"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:1,1860:2,1870:1,1880:3,1890:26,1900:6,1910:4,1920:2,1930:1,1940:0,1950:0,1960:1,1970:0,1980:1,1990:2,2e3:3,2010:0,2020:2,ZIPCODE:"02116"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:4,1860:14,1870:2,1880:0,1890:27,1900:10,1910:3,1920:4,1930:1,1940:0,1950:1,1960:0,1970:2,1980:2,1990:1,2e3:2,2010:2,2020:0,ZIPCODE:"02118"},{1800:0,1810:0,1820:0,1830:0,1840:1,1850:1,1860:0,1870:3,1880:7,1890:16,1900:26,1910:3,1920:1,1930:1,1940:0,1950:1,1960:3,1970:3,1980:2,1990:4,2e3:18,2010:5,2020:2,ZIPCODE:"02119"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:1,1890:1,1900:6,1910:1,1920:1,1930:1,1940:0,1950:0,1960:3,1970:0,1980:11,1990:1,2e3:7,2010:0,2020:2,ZIPCODE:"02120"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:1,1890:4,1900:15,1910:9,1920:7,1930:1,1940:0,1950:0,1960:0,1970:0,1980:1,1990:0,2e3:5,2010:5,2020:2,ZIPCODE:"02121"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:1,1860:0,1870:1,1880:2,1890:6,1900:45,1910:11,1920:16,1930:3,1940:1,1950:0,1960:0,1970:0,1980:6,1990:2,2e3:8,2010:9,2020:7,ZIPCODE:"02122"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:3,1890:15,1900:32,1910:9,1920:18,1930:7,1940:2,1950:1,1960:0,1970:0,1980:2,1990:7,2e3:11,2010:5,2020:3,ZIPCODE:"02124"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:7,1890:14,1900:48,1910:7,1920:6,1930:3,1940:0,1950:0,1960:0,1970:0,1980:5,1990:1,2e3:16,2010:15,2020:5,ZIPCODE:"02125"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:0,1900:2,1910:4,1920:6,1930:4,1940:0,1950:1,1960:0,1970:1,1980:1,1990:0,2e3:3,2010:2,2020:1,ZIPCODE:"02126"},{1800:1,1810:0,1820:0,1830:1,1840:0,1850:0,1860:1,1870:7,1880:5,1890:49,1900:62,1910:18,1920:8,1930:2,1940:1,1950:0,1960:5,1970:1,1980:21,1990:7,2e3:16,2010:45,2020:16,ZIPCODE:"02127"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:4,1860:1,1870:5,1880:11,1890:12,1900:81,1910:28,1920:8,1930:1,1940:2,1950:0,1960:2,1970:0,1980:4,1990:1,2e3:2,2010:29,2020:13,ZIPCODE:"02128"},{1800:1,1810:0,1820:1,1830:2,1840:1,1850:5,1860:7,1870:15,1880:13,1890:9,1900:5,1910:3,1920:2,1930:1,1940:0,1950:0,1960:1,1970:0,1980:0,1990:2,2e3:7,2010:7,2020:3,ZIPCODE:"02129"},{1800:1,1810:0,1820:0,1830:0,1840:1,1850:0,1860:2,1870:5,1880:12,1890:15,1900:74,1910:24,1920:30,1930:7,1940:1,1950:2,1960:2,1970:0,1980:5,1990:7,2e3:29,2010:19,2020:7,ZIPCODE:"02130"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:1,1880:9,1890:11,1900:36,1910:37,1920:51,1930:9,1940:0,1950:0,1960:6,1970:2,1980:15,1990:3,2e3:18,2010:15,2020:10,ZIPCODE:"02131"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:5,1900:4,1910:7,1920:23,1930:3,1940:4,1950:4,1960:8,1970:2,1980:3,1990:3,2e3:4,2010:0,2020:1,ZIPCODE:"02132"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:2,1880:2,1890:5,1900:13,1910:16,1920:10,1930:6,1940:4,1950:5,1960:9,1970:1,1980:9,1990:4,2e3:19,2010:4,2020:2,ZIPCODE:"02136"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:2,1860:2,1870:2,1880:1,1890:3,1900:5,1910:8,1920:7,1930:1,1940:0,1950:0,1960:0,1970:0,1980:0,1990:1,2e3:0,2010:3,2020:0,ZIPCODE:"02138"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:0,1900:0,1910:0,1920:1,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"02138-1915"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:0,1900:0,1910:1,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"02138-4531"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:0,1900:0,1910:1,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"02138-4646"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:0,1900:0,1910:0,1920:1,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"02138-6832"},{1800:0,1810:0,1820:0,1830:1,1840:2,1850:0,1860:0,1870:4,1880:4,1890:6,1900:7,1910:6,1920:1,1930:0,1940:0,1950:0,1960:0,1970:1,1980:1,1990:1,2e3:0,2010:0,2020:0,ZIPCODE:"02139"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:0,1900:1,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"02139-1017"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:0,1900:1,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"02139-1113"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:1,1870:0,1880:0,1890:0,1900:0,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"02139-1116"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:1,1900:0,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"02139-3125"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:1,1890:0,1900:0,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"02139-4019"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:0,1900:0,1910:0,1920:0,1930:0,1940:0,1950:0,1960:1,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"02139-4423"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:1,1860:0,1870:0,1880:0,1890:0,1900:0,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"02139-4430"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:0,1900:0,1910:1,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"02139-4745"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:2,1900:2,1910:1,1920:3,1930:1,1940:0,1950:0,1960:1,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:1,ZIPCODE:"02140"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:0,1900:0,1910:1,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"02140-1124"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:0,1900:0,1910:0,1920:1,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"02140-1610"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:0,1900:0,1910:1,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"02140-1841"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:1,1880:0,1890:0,1900:0,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"02140-3304"},{1800:0,1810:0,1820:0,1830:1,1840:0,1850:1,1860:0,1870:0,1880:0,1890:2,1900:5,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:1,1980:0,1990:0,2e3:2,2010:2,2020:1,ZIPCODE:"02141"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:1,1890:0,1900:0,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"02141-1931"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:0,1900:2,1910:0,1920:1,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:1,2020:0,ZIPCODE:"02142"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:1,1900:0,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"02199"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:0,1900:0,1910:1,1920:0,1930:1,1940:1,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:1,2020:0,ZIPCODE:"02210"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:10,1900:7,1910:4,1920:0,1930:0,1940:0,1950:0,1960:1,1970:0,1980:0,1990:1,2e3:1,2010:1,2020:0,ZIPCODE:"02215"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:0,1900:1,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"02421"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:1,1880:0,1890:0,1900:0,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"02458"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:1,1890:0,1900:0,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"02460"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:0,1900:1,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"02461"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:1,1900:0,1910:0,1920:0,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"02472"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:1,1880:0,1890:0,1900:0,1910:0,1920:1,1930:0,1940:0,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"02474"},{1800:0,1810:0,1820:0,1830:0,1840:0,1850:0,1860:0,1870:0,1880:0,1890:0,1900:0,1910:0,1920:0,1930:0,1940:1,1950:0,1960:0,1970:0,1980:0,1990:0,2e3:0,2010:0,2020:0,ZIPCODE:"03246"}];var eP=Ap('<rect class="bar svelte-76qd0p" fill="orange"></rect>'),tP=Ap('<svg id="barchart-svg"><g><!><g class="x-axis svelte-76qd0p"><text text-anchor="middle" style="font-size: 16px" class="svelte-76qd0p">Year Built</text></g><g class="y-axis svelte-76qd0p"><text transform="rotate(-90)" text-anchor="middle" style="font-size: 16px" class="svelte-76qd0p">Number of Buildings</text></g></g></svg>');function rP(y,E){Pa(E,!1);let A=ks(E,"dataArray",8,()=>[]),L={top:20,right:30,bottom:70,left:60},k=960-L.left-L.right,Z=500-L.top-L.bottom;const Y=hg().domain(A().map(Ot=>Ot.year)).range([0,k]).padding(.1),ee=dg().domain([0,ov(A(),Ot=>Ot.count)]).range([Z,0]),s=lv(Y).tickFormat(cg("d")),te=cv(ee).ticks(5);function ae(){Ma(".x-axis").call(s),Ma(".y-axis").call(te)}Pp(()=>{ae()}),Aa();var se=Ca(y,!0,tP),fe=Os(se),_e=Os(fe),qe=Di(_e);ss(qe,"transform",`translate(0, ${Z})`);var nt=Os(qe);ss(nt,"x",k/2),ss(nt,"y",40);var xt=Di(qe),lt=Os(xt);ss(lt,"x",-Z/2),ss(lt,"y",-50);var $e,ft,Nt;k_(()=>{$e!==($e=k+L.left+L.right)&&ss(se,"width",$e),ft!==(ft=Z+L.top+L.bottom)&&ss(se,"height",ft),Nt!==(Nt=`translate(${L.left},${L.top})`)&&ss(fe,"transform",Nt)}),RE(_e,A,7,(Ot,lr)=>Tn(Ot).year,(Ot,lr,Lr)=>{var Er=Ca(Ot,!0,eP);Fc(Er,"x",()=>Y(Tn(lr).year)),Fc(Er,"y",()=>ee(Tn(lr).count)),Fc(Er,"width",()=>Y.bandwidth()),Fc(Er,"height",()=>Z-ee(Tn(lr).count)),Ia(Ot,Er)},null),Ia(y,se),Sa()}var iP=zl("<p> </p>"),nP=zl('<div class="about svelte-oabmb2"></div> <h1>Year Converted Property was Built</h1> <!>',!0);function oP(y,E){Pa(E,!1),ks(E,"hLevel",0,2);let A=ks(E,"query",0,""),L=En(),k=En(),Z,Y=En(),ee=En(),s=En(),te=-1,ae=En(),se=En(),fe=En();function _e($e){const ft={};return $e.forEach(Nt=>{const Ot=Nt.substring(0,5);ft[Ot]||(ft[Ot]=[]),ft[Ot].push(Nt.substring(0,5))}),ft}ao(()=>{jc(A()),lo(()=>{pn(L,JS.filter($e=>A()?Object.values($e).join(`
`).toLowerCase().includes(A().toLowerCase()):!0))})}),ao(()=>{jc(A()),lo(()=>{pn(k,QS.filter($e=>A()?Object.values($e).join(`
`).toLowerCase().includes(A().toLowerCase()):!0))})}),ao(()=>{Br(Y),Br(L),Br(ee),Br(k),Br(s),lo(()=>{pn(Y,nv(Br(L),$e=>sv($e,ft=>ft.Count_of_LU_prior),$e=>$e.LU_prior_group)),console.log("Rolled ",Br(Y)),pn(ee,Br(k).reduce(($e,ft)=>(Object.keys(ft).forEach(Nt=>{Nt!=="ZIPCODE"&&($e[Nt]||($e[Nt]=0),$e[Nt]+=ft[Nt])}),$e),{})),console.log("Agg Year Built",Br(ee)),pn(s,Object.keys(Br(ee)).map($e=>({year:parseInt($e),count:Br(ee)[$e]})).sort(($e,ft)=>$e.year-ft.year)),console.log("Year Built Data Array ",Br(s))})}),ao(()=>{lo(()=>{pn(ae,te>-1?Z[te].label:null)})}),ao(()=>{Br(se),Br(L),lo(()=>{pn(se,Br(L).map($e=>$e.ZIPCODE)),pn(fe,new Set(Object.values(_e(Br(se))).flat()))})}),Aa();var qe=J_(y,!0,nP),nt=Q_(qe),xt=Di(Di(nt,!0)),lt=Di(Di(xt,!0));F_(nt,()=>Br(fe),9,($e,ft,Nt)=>{var Ot=Ca($e,!0,iP),lr=IE(Os(Ot));ME(lr,()=>Tn(ft)),Ia($e,Ot)},null),rP(lt,{get dataArray(){return Br(s)}}),Sp(y,qe),Sa()}var sP=zl('<h1>Complaints by Zipcode</h1> <svg id="bubblechart-svg"></svg> <div class="legend"></div>',!0);function aP(y,E){Pa(E,!1);let A=ks(E,"query",0,""),L,k=960,Z=500;const Y={top:20,right:20,bottom:30,left:40},ee=ld(kS);async function s(se){const fe=await wp("complaints_count_zipcode.csv");fe.columns=fe.columns.map($e=>$e.trim().replace(/[^\x20-\x7E]+/g,""));const _e=fe.filter($e=>se?$e["Zip Code"]===se:!0),qe=Xx().size([k-Y.left-Y.right,Z-Y.top-Y.bottom]).padding(10),nt=Mp({children:_e}).sum($e=>+$e["Count of Description"]),xt=qe(nt).descendants();L=Ma("#bubblechart-svg").attr("width",k).attr("height",Z).append("g").attr("transform",`translate(${Y.left}, ${Y.top})`),L.selectAll("circle").data(xt.slice(1)).enter().append("circle").attr("cx",$e=>$e.x).attr("cy",$e=>$e.y).attr("r",$e=>$e.r).attr("fill",$e=>ee($e.data["Description (group)"])).attr("opacity",.7).on("mouseover",function($e,ft){Ma(this).append("title").text(ft.data["Description (group)"])}).on("mouseout",function(){Ma(this).select("title").remove()}),console.log(ee.domain())}function te(se){se?wp("complaints_count_zipcode.csv").then(fe=>{fe.columns=fe.columns.map(lt=>lt.trim().replace(/[^\x20-\x7E]+/g,""));const _e=fe.filter(lt=>se?lt["Zip Code"]===se:!0),qe=Mp({children:_e}).sum(lt=>+lt["Count of Description"]),nt=Xx().size([k-Y.left-Y.right,Z-Y.top-Y.bottom]).padding(10)(qe).descendants(),xt=L.selectAll("circle").data(nt.slice(1));xt.transition().duration(750).attr("cx",lt=>lt.x).attr("cy",lt=>lt.y).attr("r",lt=>lt.r),xt.enter().append("circle").attr("cx",lt=>lt.x).attr("cy",lt=>lt.y).attr("r",lt=>lt.r).attr("fill",lt=>ee(lt.data["Description (group)"])).attr("opacity",.7).transition().duration(750).attr("r",lt=>lt.r),xt.exit().remove(),xt.on("mouseover",function(lt,$e){Ma(this).append("title").text($e.data["Description (group)"])}).on("mouseout",function(){Ma(this).select("title").remove()})}):alert("Please enter a zipcode.")}Pp(()=>{s(A())}),ao(()=>{jc(A()),lo(()=>{A()&&te(A())})}),Aa();var ae=J_(y,!0,sP);Sp(y,ae),Sa()}var lP=Ap('<svg id="linechart-svg" width="960" height="500"></svg>');function cP(y,E){Pa(E,!1);let A=ks(E,"query",0,""),L,k,Z;function Y(){const ae={top:50,right:250,bottom:80,left:70},se=960-ae.left-ae.right,fe=500-ae.top-ae.bottom;L=Ma("#linechart-svg").attr("viewBox",`0 0 1000 ${fe+ae.top+ae.bottom}`).append("g").attr("transform",`translate(${ae.left},${ae.top})`),k=hg().range([0,se]).padding(.2),L.append("g").attr("class","x-axis").attr("transform",`translate(0,${fe})`),L.append("text").attr("class","x label").attr("text-anchor","middle").attr("x",se/2).attr("y",fe+40).text("Year"),Z=dg().range([fe,0]),L.append("g").attr("class","y-axis"),L.append("text").attr("class","y label").attr("text-anchor","middle").attr("transform","rotate(-90)").attr("y",-50).attr("x",-fe/2).text("Number of Distinct Buildings or Complaints in a Year"),L.append("text").attr("class","chart title").attr("x",se/2).attr("y",-20).attr("text-anchor","middle").style("font-size","16px").style("font-weight","bold").text("Complaints Filed about Condominium Buildings in the Boston and Cambridge Area");const _e=L.append("g").attr("class","legend").attr("transform",`translate(${se+50}, 20)`),qe=[{color:"steelblue",label:"# of Complaints Filed Per Year"},{color:"red",label:"# of Distinct Buildings the Complaints are Filed About"}];let nt=0;qe.forEach(xt=>{const lt=xt.label.length*8;nt=Math.max(nt,lt)}),nt+=40,_e.append("rect").attr("class","legend-box").attr("x",0).attr("y",0).attr("width",nt).attr("height",qe.length*20+10).attr("fill","none").attr("stroke","black"),qe.forEach((xt,lt)=>{const $e=_e.append("g").attr("transform",`translate(0, ${lt*20+10})`);$e.append("rect").attr("x",0).attr("y",0).attr("width",10).attr("height",10).attr("fill",xt.color),$e.append("text").attr("x",20).attr("y",9).attr("font-size","10px").text(xt.label)}),ee(A())}async function ee(te){const ae=await wp("complaints_year_zipcode.csv");ae.columns=ae.columns.map($e=>$e.trim().replace(/[^\x20-\x7E]+/g,""));const se=ae.filter($e=>te?$e["Zip Code"]===te:!0);let fe={};se.forEach($e=>{const ft=$e["Date (Years)"];fe[ft]||(fe[ft]={count:0,discounted:0}),fe[ft].count+=+$e["Number of Complaints Filed Per Year"],fe[ft].discounted+=+$e["Number of Distinct Condominum Buildings the Complaints are Filed About"]});let _e=Object.keys(fe).map($e=>({year:$e,count:fe[$e].count,discounted:fe[$e].discounted}));const qe=rv().x($e=>k($e.year)+k.bandwidth()/2).y($e=>Z($e.count)),nt=rv().x($e=>k($e.year)+k.bandwidth()/2).y($e=>Z($e.discounted));k.domain(_e.map($e=>$e.year)),L.select(".x-axis").transition().duration(750).call(lv(k)).selectAll("text").attr("transform","translate(-10,0)rotate(-45)").style("text-anchor","end"),Z.domain([0,ov(_e,$e=>Math.max($e.count,$e.discounted))]),L.select(".y-axis").transition().duration(750).call(cv(Z));let xt=L.selectAll(".line-count").data([_e],$e=>$e.year),lt=L.selectAll(".line-discounted").data([_e],$e=>$e.year);xt.transition().duration(750).attr("d",qe(_e)),lt.transition().duration(750).attr("d",nt(_e)),xt.empty()&&L.append("path").data([_e]).attr("class","line-count").attr("fill","none").attr("stroke","steelblue").attr("stroke-width",1.5).attr("d",qe),lt.empty()&&L.append("path").data([_e]).attr("class","line-discounted").attr("fill","none").attr("stroke","red").attr("stroke-width",1.5).attr("d",nt)}Pp(()=>{Y()}),ao(()=>{jc(A()),lo(()=>{A()&&ee(A())})}),Aa();var s=Ca(y,!0,lP);Ia(y,s),Sa()}const uP=[{"ZIPCODE post (group)":"02215","LU prior groups":"CM","Count of LU prior":1},{"ZIPCODE post (group)":"02215","LU prior groups":"R2","Count of LU prior":1},{"ZIPCODE post (group)":"02210","LU prior groups":"RC","Count of LU prior":1},{"ZIPCODE post (group)":"02142","LU prior groups":"C","Count of LU prior":1},{"ZIPCODE post (group)":"02142","LU prior groups":"A","Count of LU prior":1},{"ZIPCODE post (group)":"02141","LU prior groups":"R1","Count of LU prior":2},{"ZIPCODE post (group)":"02141","LU prior groups":"RC","Count of LU prior":1},{"ZIPCODE post (group)":"02141","LU prior groups":"R4","Count of LU prior":1},{"ZIPCODE post (group)":"02141","LU prior groups":"R2","Count of LU prior":8},{"ZIPCODE post (group)":"02141","LU prior groups":"R3","Count of LU prior":7},{"ZIPCODE post (group)":"02140","LU prior groups":"E","Count of LU prior":1},{"ZIPCODE post (group)":"02140","LU prior groups":"RC","Count of LU prior":1},{"ZIPCODE post (group)":"02140","LU prior groups":"A","Count of LU prior":1},{"ZIPCODE post (group)":"02140","LU prior groups":"CM","Count of LU prior":1},{"ZIPCODE post (group)":"02140","LU prior groups":"R2","Count of LU prior":13},{"ZIPCODE post (group)":"02140","LU prior groups":"R3","Count of LU prior":4},{"ZIPCODE post (group)":"02139","LU prior groups":"E","Count of LU prior":1},{"ZIPCODE post (group)":"02139","LU prior groups":"R1","Count of LU prior":2},{"ZIPCODE post (group)":"02139","LU prior groups":"R4","Count of LU prior":2},{"ZIPCODE post (group)":"02139","LU prior groups":"CM","Count of LU prior":5},{"ZIPCODE post (group)":"02139","LU prior groups":"CD","Count of LU prior":1},{"ZIPCODE post (group)":"02139","LU prior groups":"R2","Count of LU prior":21},{"ZIPCODE post (group)":"02139","LU prior groups":"R3","Count of LU prior":10},{"ZIPCODE post (group)":"02138","LU prior groups":"RL","Count of LU prior":1},{"ZIPCODE post (group)":"02138","LU prior groups":"R1","Count of LU prior":3},{"ZIPCODE post (group)":"02138","LU prior groups":"RC","Count of LU prior":1},{"ZIPCODE post (group)":"02138","LU prior groups":"CM","Count of LU prior":4},{"ZIPCODE post (group)":"02138","LU prior groups":"R2","Count of LU prior":20},{"ZIPCODE post (group)":"02138","LU prior groups":"R3","Count of LU prior":4},{"ZIPCODE post (group)":"02136","LU prior groups":"R1","Count of LU prior":1},{"ZIPCODE post (group)":"02136","LU prior groups":"RC","Count of LU prior":2},{"ZIPCODE post (group)":"02136","LU prior groups":"A","Count of LU prior":1},{"ZIPCODE post (group)":"02136","LU prior groups":"CM","Count of LU prior":6},{"ZIPCODE post (group)":"02136","LU prior groups":"CD","Count of LU prior":20},{"ZIPCODE post (group)":"02136","LU prior groups":"R2","Count of LU prior":22},{"ZIPCODE post (group)":"02136","LU prior groups":"R3","Count of LU prior":8},{"ZIPCODE post (group)":"02132","LU prior groups":"E","Count of LU prior":1},{"ZIPCODE post (group)":"02132","LU prior groups":"RC","Count of LU prior":1},{"ZIPCODE post (group)":"02132","LU prior groups":"A","Count of LU prior":1},{"ZIPCODE post (group)":"02132","LU prior groups":"R4","Count of LU prior":1},{"ZIPCODE post (group)":"02132","LU prior groups":"CM","Count of LU prior":6},{"ZIPCODE post (group)":"02132","LU prior groups":"CD","Count of LU prior":11},{"ZIPCODE post (group)":"02132","LU prior groups":"R2","Count of LU prior":18},{"ZIPCODE post (group)":"02132","LU prior groups":"R3","Count of LU prior":4},{"ZIPCODE post (group)":"02131","LU prior groups":"CC","Count of LU prior":3},{"ZIPCODE post (group)":"02131","LU prior groups":"RL","Count of LU prior":3},{"ZIPCODE post (group)":"02131","LU prior groups":"R1","Count of LU prior":1},{"ZIPCODE post (group)":"02131","LU prior groups":"RC","Count of LU prior":1},{"ZIPCODE post (group)":"02131","LU prior groups":"A","Count of LU prior":5},{"ZIPCODE post (group)":"02131","LU prior groups":"R4","Count of LU prior":3},{"ZIPCODE post (group)":"02131","LU prior groups":"CM","Count of LU prior":11},{"ZIPCODE post (group)":"02131","LU prior groups":"CD","Count of LU prior":70},{"ZIPCODE post (group)":"02131","LU prior groups":"R2","Count of LU prior":65},{"ZIPCODE post (group)":"02131","LU prior groups":"R3","Count of LU prior":32},{"ZIPCODE post (group)":"02130","LU prior groups":"E","Count of LU prior":1},{"ZIPCODE post (group)":"02130","LU prior groups":"C","Count of LU prior":1},{"ZIPCODE post (group)":"02130","LU prior groups":"CC","Count of LU prior":1},{"ZIPCODE post (group)":"02130","LU prior groups":"RL","Count of LU prior":2},{"ZIPCODE post (group)":"02130","LU prior groups":"R1","Count of LU prior":5},{"ZIPCODE post (group)":"02130","LU prior groups":"RC","Count of LU prior":3},{"ZIPCODE post (group)":"02130","LU prior groups":"A","Count of LU prior":3},{"ZIPCODE post (group)":"02130","LU prior groups":"R4","Count of LU prior":5},{"ZIPCODE post (group)":"02130","LU prior groups":"CM","Count of LU prior":16},{"ZIPCODE post (group)":"02130","LU prior groups":"CD","Count of LU prior":59},{"ZIPCODE post (group)":"02130","LU prior groups":"R2","Count of LU prior":43},{"ZIPCODE post (group)":"02130","LU prior groups":"R3","Count of LU prior":63},{"ZIPCODE post (group)":"02129","LU prior groups":"RL","Count of LU prior":2},{"ZIPCODE post (group)":"02129","LU prior groups":"R1","Count of LU prior":2},{"ZIPCODE post (group)":"02129","LU prior groups":"A","Count of LU prior":1},{"ZIPCODE post (group)":"02129","LU prior groups":"R4","Count of LU prior":1},{"ZIPCODE post (group)":"02129","LU prior groups":"CM","Count of LU prior":5},{"ZIPCODE post (group)":"02129","LU prior groups":"CD","Count of LU prior":11},{"ZIPCODE post (group)":"02129","LU prior groups":"R2","Count of LU prior":20},{"ZIPCODE post (group)":"02129","LU prior groups":"R3","Count of LU prior":26},{"ZIPCODE post (group)":"02128","LU prior groups":"CC","Count of LU prior":1},{"ZIPCODE post (group)":"02128","LU prior groups":"RL","Count of LU prior":2},{"ZIPCODE post (group)":"02128","LU prior groups":"R1","Count of LU prior":3},{"ZIPCODE post (group)":"02128","LU prior groups":"RC","Count of LU prior":5},{"ZIPCODE post (group)":"02128","LU prior groups":"A","Count of LU prior":12},{"ZIPCODE post (group)":"02128","LU prior groups":"R4","Count of LU prior":18},{"ZIPCODE post (group)":"02128","LU prior groups":"CM","Count of LU prior":2},{"ZIPCODE post (group)":"02128","LU prior groups":"CD","Count of LU prior":7},{"ZIPCODE post (group)":"02128","LU prior groups":"R2","Count of LU prior":40},{"ZIPCODE post (group)":"02128","LU prior groups":"R3","Count of LU prior":101},{"ZIPCODE post (group)":"02127","LU prior groups":"E","Count of LU prior":1},{"ZIPCODE post (group)":"02127","LU prior groups":"C","Count of LU prior":2},{"ZIPCODE post (group)":"02127","LU prior groups":"RL","Count of LU prior":3},{"ZIPCODE post (group)":"02127","LU prior groups":"R1","Count of LU prior":8},{"ZIPCODE post (group)":"02127","LU prior groups":"RC","Count of LU prior":12},{"ZIPCODE post (group)":"02127","LU prior groups":"A","Count of LU prior":15},{"ZIPCODE post (group)":"02127","LU prior groups":"R4","Count of LU prior":15},{"ZIPCODE post (group)":"02127","LU prior groups":"CM","Count of LU prior":18},{"ZIPCODE post (group)":"02127","LU prior groups":"CD","Count of LU prior":36},{"ZIPCODE post (group)":"02127","LU prior groups":"R2","Count of LU prior":53},{"ZIPCODE post (group)":"02127","LU prior groups":"R3","Count of LU prior":55},{"ZIPCODE post (group)":"02126","LU prior groups":"A","Count of LU prior":3},{"ZIPCODE post (group)":"02126","LU prior groups":"R4","Count of LU prior":2},{"ZIPCODE post (group)":"02126","LU prior groups":"CM","Count of LU prior":3},{"ZIPCODE post (group)":"02126","LU prior groups":"CD","Count of LU prior":2},{"ZIPCODE post (group)":"02126","LU prior groups":"R2","Count of LU prior":7},{"ZIPCODE post (group)":"02126","LU prior groups":"R3","Count of LU prior":1},{"ZIPCODE post (group)":"02125","LU prior groups":"RL","Count of LU prior":1},{"ZIPCODE post (group)":"02125","LU prior groups":"A","Count of LU prior":4},{"ZIPCODE post (group)":"02125","LU prior groups":"R4","Count of LU prior":4},{"ZIPCODE post (group)":"02125","LU prior groups":"CM","Count of LU prior":8},{"ZIPCODE post (group)":"02125","LU prior groups":"CD","Count of LU prior":16},{"ZIPCODE post (group)":"02125","LU prior groups":"R2","Count of LU prior":17},{"ZIPCODE post (group)":"02125","LU prior groups":"R3","Count of LU prior":53},{"ZIPCODE post (group)":"02124","LU prior groups":"CL","Count of LU prior":1},{"ZIPCODE post (group)":"02124","LU prior groups":"C","Count of LU prior":1},{"ZIPCODE post (group)":"02124","LU prior groups":"CC","Count of LU prior":1},{"ZIPCODE post (group)":"02124","LU prior groups":"RC","Count of LU prior":1},{"ZIPCODE post (group)":"02124","LU prior groups":"A","Count of LU prior":3},{"ZIPCODE post (group)":"02124","LU prior groups":"R4","Count of LU prior":2},{"ZIPCODE post (group)":"02124","LU prior groups":"CM","Count of LU prior":7},{"ZIPCODE post (group)":"02124","LU prior groups":"CD","Count of LU prior":12},{"ZIPCODE post (group)":"02124","LU prior groups":"R2","Count of LU prior":29},{"ZIPCODE post (group)":"02124","LU prior groups":"R3","Count of LU prior":28},{"ZIPCODE post (group)":"02122","LU prior groups":"C","Count of LU prior":1},{"ZIPCODE post (group)":"02122","LU prior groups":"RL","Count of LU prior":1},{"ZIPCODE post (group)":"02122","LU prior groups":"R1","Count of LU prior":1},{"ZIPCODE post (group)":"02122","LU prior groups":"R4","Count of LU prior":10},{"ZIPCODE post (group)":"02122","LU prior groups":"CM","Count of LU prior":6},{"ZIPCODE post (group)":"02122","LU prior groups":"CD","Count of LU prior":17},{"ZIPCODE post (group)":"02122","LU prior groups":"R2","Count of LU prior":22},{"ZIPCODE post (group)":"02122","LU prior groups":"R3","Count of LU prior":36},{"ZIPCODE post (group)":"02121","LU prior groups":"A","Count of LU prior":2},{"ZIPCODE post (group)":"02121","LU prior groups":"R4","Count of LU prior":3},{"ZIPCODE post (group)":"02121","LU prior groups":"CM","Count of LU prior":1},{"ZIPCODE post (group)":"02121","LU prior groups":"CD","Count of LU prior":5},{"ZIPCODE post (group)":"02121","LU prior groups":"R2","Count of LU prior":6},{"ZIPCODE post (group)":"02121","LU prior groups":"R3","Count of LU prior":16},{"ZIPCODE post (group)":"02120","LU prior groups":"E","Count of LU prior":1},{"ZIPCODE post (group)":"02120","LU prior groups":"CC","Count of LU prior":1},{"ZIPCODE post (group)":"02120","LU prior groups":"RC","Count of LU prior":1},{"ZIPCODE post (group)":"02120","LU prior groups":"A","Count of LU prior":1},{"ZIPCODE post (group)":"02120","LU prior groups":"R4","Count of LU prior":1},{"ZIPCODE post (group)":"02120","LU prior groups":"CD","Count of LU prior":13},{"ZIPCODE post (group)":"02119","LU prior groups":"I","Count of LU prior":1},{"ZIPCODE post (group)":"02119","LU prior groups":"RL","Count of LU prior":2},{"ZIPCODE post (group)":"02119","LU prior groups":"R1","Count of LU prior":2},{"ZIPCODE post (group)":"02119","LU prior groups":"RC","Count of LU prior":2},{"ZIPCODE post (group)":"02119","LU prior groups":"A","Count of LU prior":2},{"ZIPCODE post (group)":"02119","LU prior groups":"R4","Count of LU prior":4},{"ZIPCODE post (group)":"02119","LU prior groups":"CM","Count of LU prior":5},{"ZIPCODE post (group)":"02119","LU prior groups":"CD","Count of LU prior":20},{"ZIPCODE post (group)":"02119","LU prior groups":"R2","Count of LU prior":12},{"ZIPCODE post (group)":"02119","LU prior groups":"R3","Count of LU prior":17},{"ZIPCODE post (group)":"02118","LU prior groups":"CC","Count of LU prior":3},{"ZIPCODE post (group)":"02118","LU prior groups":"RC","Count of LU prior":3},{"ZIPCODE post (group)":"02118","LU prior groups":"A","Count of LU prior":3},{"ZIPCODE post (group)":"02118","LU prior groups":"R4","Count of LU prior":11},{"ZIPCODE post (group)":"02118","LU prior groups":"CM","Count of LU prior":5},{"ZIPCODE post (group)":"02118","LU prior groups":"CD","Count of LU prior":2},{"ZIPCODE post (group)":"02118","LU prior groups":"R2","Count of LU prior":19},{"ZIPCODE post (group)":"02118","LU prior groups":"R3","Count of LU prior":15},{"ZIPCODE post (group)":"02116","LU prior groups":"C","Count of LU prior":3},{"ZIPCODE post (group)":"02116","LU prior groups":"R1","Count of LU prior":1},{"ZIPCODE post (group)":"02116","LU prior groups":"RC","Count of LU prior":2},{"ZIPCODE post (group)":"02116","LU prior groups":"A","Count of LU prior":2},{"ZIPCODE post (group)":"02116","LU prior groups":"R4","Count of LU prior":6},{"ZIPCODE post (group)":"02116","LU prior groups":"CM","Count of LU prior":5},{"ZIPCODE post (group)":"02116","LU prior groups":"CD","Count of LU prior":7},{"ZIPCODE post (group)":"02116","LU prior groups":"R2","Count of LU prior":7},{"ZIPCODE post (group)":"02116","LU prior groups":"R3","Count of LU prior":9},{"ZIPCODE post (group)":"02115","LU prior groups":"CC","Count of LU prior":2},{"ZIPCODE post (group)":"02115","LU prior groups":"RL","Count of LU prior":1},{"ZIPCODE post (group)":"02115","LU prior groups":"R4","Count of LU prior":3},{"ZIPCODE post (group)":"02115","LU prior groups":"CM","Count of LU prior":2},{"ZIPCODE post (group)":"02115","LU prior groups":"R2","Count of LU prior":1},{"ZIPCODE post (group)":"02115","LU prior groups":"R3","Count of LU prior":2},{"ZIPCODE post (group)":"02114","LU prior groups":"R2","Count of LU prior":1},{"ZIPCODE post (group)":"02113","LU prior groups":"CC","Count of LU prior":1},{"ZIPCODE post (group)":"02113","LU prior groups":"R4","Count of LU prior":5},{"ZIPCODE post (group)":"02113","LU prior groups":"CM","Count of LU prior":1},{"ZIPCODE post (group)":"02113","LU prior groups":"CD","Count of LU prior":1},{"ZIPCODE post (group)":"02113","LU prior groups":"R2","Count of LU prior":1},{"ZIPCODE post (group)":"02113","LU prior groups":"R3","Count of LU prior":2},{"ZIPCODE post (group)":"02111","LU prior groups":"RC","Count of LU prior":1},{"ZIPCODE post (group)":"02110","LU prior groups":"R2","Count of LU prior":1},{"ZIPCODE post (group)":"02110","LU prior groups":"R3","Count of LU prior":1},{"ZIPCODE post (group)":"02109","LU prior groups":"C","Count of LU prior":2},{"ZIPCODE post (group)":"02109","LU prior groups":"CM","Count of LU prior":1},{"ZIPCODE post (group)":"02109","LU prior groups":"R2","Count of LU prior":1},{"ZIPCODE post (group)":"02108","LU prior groups":"C","Count of LU prior":1},{"ZIPCODE post (group)":"02108","LU prior groups":"CC","Count of LU prior":2},{"ZIPCODE post (group)":"02108","LU prior groups":"R1","Count of LU prior":1},{"ZIPCODE post (group)":"02108","LU prior groups":"A","Count of LU prior":3},{"ZIPCODE post (group)":"02108","LU prior groups":"R4","Count of LU prior":2},{"ZIPCODE post (group)":"02108","LU prior groups":"R2","Count of LU prior":2},{"ZIPCODE post (group)":"02108","LU prior groups":"R3","Count of LU prior":6}];var hP=Ap('<path tabindex="0" role="button" aria-label="pie wedge" class="svelte-19yj5i9"></path>'),dP=zl('<li class="legend-item"><span class="swatch svelte-19yj5i9"></span> <em> </em></li>'),fP=zl('<div class="container svelte-19yj5i9"><svg id="piechart-svg" viewBox="-50 -50 100 100" class="svelte-19yj5i9"></svg> <ul class="legend svelte-19yj5i9"></ul></div>');function pP(y,E){Pa(E,!1);let A=ks(E,"selectedIndex",12,()=>-1),L=ks(E,"data",8,()=>[]),k=$S().innerRadius(0).outerRadius(50),Z=En(),Y=En(),ee=KS().value(_e=>_e.value),s=ld(Zv);function te(_e,qe){(!qe.key||qe.key==="Enter")&&A(A()===_e?-1:_e)}ao(()=>{jc(L()),lo(()=>{pn(Z,ee(L()))})}),ao(()=>{Br(Z),lo(()=>{pn(Y,Br(Z).map(_e=>k(_e)))})}),Aa();var ae=Ca(y,!0,fP),se=Os(ae),fe=Di(Di(se,!0));F_(se,()=>Br(Y),9,(_e,qe,nt)=>{var xt=Ca(_e,!0,hP);Fc(xt,"fill",()=>s(Tn(nt)));var lt,$e;k_(()=>{var ft,Nt;lt!==(lt=Tn(qe))&&ss(xt,"d",lt),$e!==($e=`--start-angle: ${Hh((ft=Br(Z)[Tn(nt)])==null?void 0:ft.startAngle)}rad;
                    --end-angle: ${Hh((Nt=Br(Z)[Tn(nt)])==null?void 0:Nt.endAngle)}rad;`)&&ss(xt,"style",$e),CE(xt,"selected",A()===Tn(nt))}),B_("click",xt,ft=>te(Tn(nt),ft),!1),B_("keyup",xt,ft=>te(Tn(nt),ft),!1),Ia(_e,xt)},null),F_(fe,L,9,(_e,qe,nt)=>{var xt=Ca(_e,!0,dP),lt=Os(xt),$e=Di(lt,!0),ft=Di($e),Nt=Os(ft);Fc(xt,"style",()=>`--color: ${Hh(s(Tn(nt)))}`),k_(()=>{xx($e,` ${Hh(Tn(qe).label)} `),xx(Nt,`(${Hh(Tn(qe).value)})`)}),Ia(_e,xt)},null),Ia(y,ae),Sa()}function mP(y,E){Pa(E,!1);let A=ks(E,"query",0,""),L=En(),k=En(),Z=En(),Y=En(-1),ee=En();ao(()=>{jc(A()),lo(()=>{pn(L,uP.filter(ae=>A()?Object.values(ae).join(`
`).toLowerCase().includes(A().toLowerCase()):!0))})}),ao(()=>{Br(k),Br(L),Br(Z),lo(()=>{pn(k,{}),console.log(Br(L)),pn(Z,nv(Br(L),ae=>sv(ae,se=>se["Count of LU prior"]),ae=>ae["LU prior groups"])),console.log("Rolled ",Br(Z)),pn(k,Br(Z).map(([ae,se])=>({value:se,label:ae}))),console.log("pied ",Br(k))})}),ao(()=>{Br(Y),Br(k),lo(()=>{pn(ee,Br(Y)>-1?Br(k)[Br(Y)].label:null)})}),Aa();var s=AE(y),te=Q_(s);pP(te,{get data(){return Br(k)},get selectedIndex(){return Br(Y)},set selectedIndex(ae){pn(Y,ae)}}),Sp(y,s),Sa()}var _P=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function gP(y){return y&&y.__esModule&&Object.prototype.hasOwnProperty.call(y,"default")?y.default:y}var Wv={exports:{}};(function(y,E){var A={};(function(L,k){y.exports=k()})(_P,function(){var L,k,Z;function Y(s,te){if(!L)L=te;else if(!k)k=te;else{var ae="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+L+")(sharedChunk); ("+k+")(sharedChunk); self.onerror = null;",se={};L(se),Z=te(se),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(Z.workerUrl=window.URL.createObjectURL(new Blob([ae],{type:"text/javascript"})))}}Y(["exports"],function(s){var te="3.3.0";let ae;const se={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(ae==null){const t=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{ae=A.API_URL_REGEX!=null?new RegExp(A.API_URL_REGEX):t}catch{ae=t}}return ae},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!se.API_URL)return null;try{const t=new URL(se.API_URL);return t.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":t.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"};function fe(t){return se.API_URL_REGEX.test(t)}function _e(t){return t.indexOf("mapbox:")===0}function qe(t){return se.API_CDN_URL_REGEX.test(t)}function nt(t){return se.API_SPRITE_REGEX.test(t)}function xt(t){return se.API_STYLE_REGEX.test(t)&&!nt(t)}const lt={create:"create",load:"load",fullLoad:"fullLoad"};function $e(t){const e=t.name.split("?")[0];return qe(e)&&e.includes("mapbox-gl.js")?"javascript":qe(e)&&e.includes("mapbox-gl.css")?"css":function(r){return se.API_FONTS_REGEX.test(r)}(e)?"fontRange":nt(e)?"sprite":xt(e)?"style":function(r){return se.API_TILEJSON_REGEX.test(r)}(e)?"tilejson":"other"}function ft(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Nt=Ot;function Ot(t,e,r,n){this.cx=3*t,this.bx=3*(r-t)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*e,this.by=3*(n-e)-this.cy,this.ay=1-this.cy-this.by,this.p1x=t,this.p1y=e,this.p2x=r,this.p2y=n}Ot.prototype={sampleCurveX:function(t){return((this.ax*t+this.bx)*t+this.cx)*t},sampleCurveY:function(t){return((this.ay*t+this.by)*t+this.cy)*t},sampleCurveDerivativeX:function(t){return(3*this.ax*t+2*this.bx)*t+this.cx},solveCurveX:function(t,e){if(e===void 0&&(e=1e-6),t<0)return 0;if(t>1)return 1;for(var r=t,n=0;n<8;n++){var a=this.sampleCurveX(r)-t;if(Math.abs(a)<e)return r;var l=this.sampleCurveDerivativeX(r);if(Math.abs(l)<1e-6)break;r-=a/l}var h=0,f=1;for(r=t,n=0;n<20&&(a=this.sampleCurveX(r),!(Math.abs(a-t)<e));n++)t>a?h=r:f=r,r=.5*(f-h)+h;return r},solve:function(t,e){return this.sampleCurveY(this.solveCurveX(t,e))}};var lr=ft(Nt),Lr=Er;function Er(t,e){this.x=t,this.y=e}Er.prototype={clone:function(){return new Er(this.x,this.y)},add:function(t){return this.clone()._add(t)},sub:function(t){return this.clone()._sub(t)},multByPoint:function(t){return this.clone()._multByPoint(t)},divByPoint:function(t){return this.clone()._divByPoint(t)},mult:function(t){return this.clone()._mult(t)},div:function(t){return this.clone()._div(t)},rotate:function(t){return this.clone()._rotate(t)},rotateAround:function(t,e){return this.clone()._rotateAround(t,e)},matMult:function(t){return this.clone()._matMult(t)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(t){return this.x===t.x&&this.y===t.y},dist:function(t){return Math.sqrt(this.distSqr(t))},distSqr:function(t){var e=t.x-this.x,r=t.y-this.y;return e*e+r*r},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(t){return Math.atan2(this.y-t.y,this.x-t.x)},angleWith:function(t){return this.angleWithSep(t.x,t.y)},angleWithSep:function(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},_matMult:function(t){var e=t[2]*this.x+t[3]*this.y;return this.x=t[0]*this.x+t[1]*this.y,this.y=e,this},_add:function(t){return this.x+=t.x,this.y+=t.y,this},_sub:function(t){return this.x-=t.x,this.y-=t.y,this},_mult:function(t){return this.x*=t,this.y*=t,this},_div:function(t){return this.x/=t,this.y/=t,this},_multByPoint:function(t){return this.x*=t.x,this.y*=t.y,this},_divByPoint:function(t){return this.x/=t.x,this.y/=t.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var t=this.y;return this.y=this.x,this.x=-t,this},_rotate:function(t){var e=Math.cos(t),r=Math.sin(t),n=r*this.x+e*this.y;return this.x=e*this.x-r*this.y,this.y=n,this},_rotateAround:function(t,e){var r=Math.cos(t),n=Math.sin(t),a=e.y+n*(this.x-e.x)+r*(this.y-e.y);return this.x=e.x+r*(this.x-e.x)-n*(this.y-e.y),this.y=a,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},Er.convert=function(t){return t instanceof Er?t:Array.isArray(t)?new Er(t[0],t[1]):t};var Ge=ft(Lr);const qr=Math.PI/180,Gt=180/Math.PI;function St(t){return t*qr}function At(t){return t*Gt}const Sr=[[0,0],[1,0],[1,1],[0,1]];function it(t){if(t<=0)return 0;if(t>=1)return 1;const e=t*t,r=e*t;return 4*(t<.5?r:3*(t-e)+r-.75)}function Ti(t,e,r,n){const a=new lr(t,e,r,n);return function(l){return a.solve(l)}}const oi=Ti(.25,.1,.25,1);function Ut(t,e,r){return Math.min(r,Math.max(e,t))}function Ei(t,e,r){return(r=Ut((r-t)/(e-t),0,1))*r*(3-2*r)}function mn(t,e,r){const n=r-e,a=((t-e)%n+n)%n+e;return a===e?r:a}function qi(t,e,r){if(!t.length)return r(null,[]);let n=t.length;const a=new Array(t.length);let l=null;t.forEach((h,f)=>{e(h,(m,_)=>{m&&(l=m),a[f]=_,--n==0&&r(l,a)})})}function gi(t,...e){for(const r of e)for(const n in r)t[n]=r[n];return t}let Fn=1;function eo(){return Fn++}function Yi(){return function t(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,t)}()}function co(t){return t<=1?1:Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))}function uo(t){return!!t&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(t)}function Nn(t,e){t.forEach(r=>{e[r]&&(e[r]=e[r].bind(e))})}function _n(t,e){return t.indexOf(e,t.length-e.length)!==-1}function Ci(t,e,r){const n={};for(const a in t)n[a]=e.call(r||this,t[a],a,t);return n}function Ki(t,e,r){const n={};for(const a in t)e.call(r||this,t[a],a,t)&&(n[a]=t[a]);return n}function gn(t){return Array.isArray(t)?t.map(gn):typeof t=="object"&&t?Ci(t,gn):t}const Rl={};function li(t){Rl[t]||(typeof console<"u"&&console.warn(t),Rl[t]=!0)}function Mn(t,e,r){return(r.y-t.y)*(e.x-t.x)>(e.y-t.y)*(r.x-t.x)}function cs(t){let e=0;for(let r,n,a=0,l=t.length,h=l-1;a<l;h=a++)r=t[a],n=t[h],e+=(n.x-r.x)*(r.y+n.y);return e}function ho([t,e,r]){const n=St(e+90),a=St(r);return{x:t*Math.cos(n)*Math.sin(a),y:t*Math.sin(n)*Math.sin(a),z:t*Math.cos(a),azimuthal:e,polar:r}}function to(){return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope}function us(t){const e={};if(t.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(r,n,a,l)=>{const h=a||l;return e[n]=!h||h.toLowerCase(),""}),e["max-age"]){const r=parseInt(e["max-age"],10);isNaN(r)?delete e["max-age"]:e["max-age"]=r}return e}let fi,Fs,Ns,In,fo,Ro,ke=null;function W(t){try{const e=self[t];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch{return!1}}function ie(t,e){return[t[4*e],t[4*e+1],t[4*e+2],t[4*e+3]]}function de(t,e,r,n){for(;e<r;){const a=e+r>>1;t[a]<n?e=a+1:r=a}return e}function Le(t,e,r,n){for(;e<r;){const a=e+r>>1;t[a]<=n?e=a+1:r=a}return e}function Fe(){return fi==null&&(fi=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),fi}const We={now:()=>In!==void 0?In:performance.now(),setNow(t){In=t},restoreNow(){In=void 0},frame(t){const e=requestAnimationFrame(t);return{cancel:()=>cancelAnimationFrame(e)}},getImageData(t,e=0){const{width:r,height:n}=t;fo||(fo=document.createElement("canvas"));const a=fo.getContext("2d",{willReadFrequently:!0});if(!a)throw new Error("failed to create canvas 2d context");return(r>fo.width||n>fo.height)&&(fo.width=r,fo.height=n),a.clearRect(-e,-e,r+2*e,n+2*e),a.drawImage(t,0,0,r,n),a.getImageData(-e,-e,r+2*e,n+2*e)},resolveURL:t=>(Fs||(Fs=document.createElement("a")),Fs.href=t,Fs.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(Ns==null&&(Ns=window.matchMedia("(prefers-reduced-motion: reduce)")),Ns.matches)},hasCanvasFingerprintNoise(){if(Ro!==void 0)return Ro;if(!Fe())return Ro=!1,!1;const t=new OffscreenCanvas(85,1),e=t.getContext("2d",{willReadFrequently:!0});let r=0;for(let a=0;a<t.width;++a)e.fillStyle=`rgba(${r++},${r++},${r++}, 255)`,e.fillRect(a,0,1,1);const n=e.getImageData(0,0,t.width,t.height);r=0;for(let a=0;a<n.data.length;++a)if(a%4!=3&&r++!==n.data[a])return Ro=!0,!0;return Ro=!1,!1}},vt="mapbox-tiles";let De=500,wt=50,pt,Et;function tr(){try{return caches}catch{}}function Or(){const t=tr();t&&!pt&&(pt=t.open(vt))}function Hr(t){const e=t.indexOf("?");if(e<0)return t;const r=["language","worldview"],n=new URLSearchParams,a=new URLSearchParams(t.slice(e));for(const l of r){const h=a.get(l);h&&n.set(l,h)}return`${t.slice(0,e)}?${n.toString()}`}function kr(t,e){const r=t.indexOf("?");if(r<0)return`${t}?${new URLSearchParams(e).toString()}`;const n=new URLSearchParams(t.slice(r));for(const a in e)n.set(a,e[a]);return`${t.slice(0,r)}?${n.toString()}`}let Pr=1/0;const Mr={supported:!1,testSupport:function(t){!Ai&&Zr&&(Wr?Wi(t):zr=t)}};let zr,Zr,Ai=!1,Wr=!1;const Ji=typeof self<"u"?self:{};function Wi(t){const e=t.createTexture();t.bindTexture(t.TEXTURE_2D,e);try{if(t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,Zr),t.isContextLost())return;Mr.supported=!0}catch{}t.deleteTexture(e),Ai=!0}Ji.document&&(Zr=Ji.document.createElement("img"),Zr.onload=function(){zr&&Wi(zr),zr=null,Wr=!0},Zr.onerror=function(){Ai=!0,zr=null},Zr.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const nn={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(nn);class yi extends Error{constructor(e,r,n){r===401&&fe(n)&&(e+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(e),this.status=r,this.url=n}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const pi=to()?()=>self.worker&&self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,Pe=function(t,e){if(!(/^file:/.test(r=t.url)||/^file:/.test(pi())&&!/^\w+:/.test(r))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(n,a){const l=new AbortController,h=new Request(n.url,{method:n.method||"GET",body:n.body,credentials:n.credentials,headers:n.headers,referrer:pi(),referrerPolicy:n.referrerPolicy,signal:l.signal});let f=!1,m=!1;const _=(x=h.url).indexOf("sku=")>0&&fe(x);var x;n.type==="json"&&h.headers.set("Accept","application/json");const b=(C,P,D)=>{if(m)return;if(C&&C.message!=="SecurityError"&&li(C.toString()),P&&D)return T(P);const O=Date.now();fetch(h).then(F=>{if(F.ok){const $=_?F.clone():null;return T(F,$,O)}return a(new yi(F.statusText,F.status,n.url))}).catch(F=>{F.name!=="AbortError"&&a(new Error(`${F.message} ${n.url}`))})},T=(C,P,D)=>{(n.type==="arrayBuffer"?C.arrayBuffer():n.type==="json"?C.json():C.text()).then(O=>{m||(P&&D&&function(F,$,X){if(Or(),!pt)return;const H=us($.headers.get("Cache-Control")||"");if(H["no-store"])return;const ne={status:$.status,statusText:$.statusText,headers:new Headers};$.headers.forEach((pe,ye)=>ne.headers.set(ye,pe)),H["max-age"]&&ne.headers.set("Expires",new Date(X+1e3*H["max-age"]).toUTCString());const re=ne.headers.get("Expires");if(!re||new Date(re).getTime()-X<42e4)return;let ce=Hr(F.url);if($.status===206){const pe=F.headers.get("Range");if(!pe)return;ne.status=200,ce=kr(ce,{range:pe})}(function(pe,ye){if(Et===void 0)try{new Response(new ReadableStream),Et=!0}catch{Et=!1}Et?ye(pe.body):pe.blob().then(ye)})($,pe=>{const ye=new Response(pe,ne);Or(),pt&&pt.then(Te=>Te.put(ce,ye)).catch(Te=>li(Te.message))})}(h,P,D),f=!0,a(null,O,C.headers.get("Cache-Control"),C.headers.get("Expires")))}).catch(O=>{m||a(new Error(O.message))})};return _?function(C,P){if(Or(),!pt)return P(null);pt.then(D=>{let O=Hr(C.url);const F=C.headers.get("Range");F&&(O=kr(O,{range:F})),D.match(O).then($=>{const X=function(H){if(!H)return!1;const ne=new Date(H.headers.get("Expires")||0),re=us(H.headers.get("Cache-Control")||"");return ne>Date.now()&&!re["no-cache"]}($);D.delete(O),X&&D.put(O,$.clone()),P(null,$,X)}).catch(P)}).catch(P)}(h,b):b(null,null),{cancel:()=>{m=!0,f||l.abort()}}}(t,e);if(to()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",t,e,void 0,!0)}var r;return function(n,a){const l=new XMLHttpRequest;l.open(n.method||"GET",n.url,!0),n.type==="arrayBuffer"&&(l.responseType="arraybuffer");for(const h in n.headers)l.setRequestHeader(h,n.headers[h]);return n.type==="json"&&(l.responseType="text",l.setRequestHeader("Accept","application/json")),l.withCredentials=n.credentials==="include",l.onerror=()=>{a(new Error(l.statusText))},l.onload=()=>{if((l.status>=200&&l.status<300||l.status===0)&&l.response!==null){let h=l.response;if(n.type==="json")try{h=JSON.parse(l.response)}catch(f){return a(f)}a(null,h,l.getResponseHeader("Cache-Control"),l.getResponseHeader("Expires"))}else a(new yi(l.statusText,l.status,n.url))},l.send(n.body),{cancel:()=>l.abort()}}(t,e)},ze=function(t,e){return Pe(gi(t,{type:"arrayBuffer"}),e)};function He(t){const e=document.createElement("a");return e.href=t,e.protocol===location.protocol&&e.host===location.host}const tt="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let Ke,st;Ke=[],st=0;const at=function(t,e){if(Mr.supported&&(t.headers||(t.headers={}),t.headers.accept="image/webp,*/*"),st>=se.MAX_PARALLEL_IMAGE_REQUESTS){const l={requestParameters:t,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return Ke.push(l),l}st++;let r=!1;const n=()=>{if(!r)for(r=!0,st--;Ke.length&&st<se.MAX_PARALLEL_IMAGE_REQUESTS;){const l=Ke.shift(),{requestParameters:h,callback:f,cancelled:m}=l;m||(l.cancel=at(h,f).cancel)}},a=ze(t,(l,h,f,m)=>{n(),l?e(l):h&&(self.createImageBitmap?function(_,x){const b=new Blob([new Uint8Array(_)],{type:"image/png"});createImageBitmap(b).then(T=>{x(null,T)}).catch(T=>{x(new Error(`Could not load image because of ${T.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(h,(_,x)=>e(_,x,f,m)):function(_,x){const b=new Image;b.onload=()=>{x(null,b),URL.revokeObjectURL(b.src),b.onload=null,requestAnimationFrame(()=>{b.src=tt})},b.onerror=()=>x(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const T=new Blob([new Uint8Array(_)],{type:"image/png"});b.src=_.byteLength?URL.createObjectURL(T):tt}(h,(_,x)=>e(_,x,f,m)))});return{cancel:()=>{a.cancel(),n()}}},Qe="01",ut="NO_ACCESS_TOKEN",rt=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function Ft(t){const e=t.match(rt);if(!e)throw new Error("Unable to parse URL object");return{protocol:e[1],authority:e[2],path:e[3]||"/",params:e[4]?e[4].split("&"):[]}}function cr(t){const e=t.params.length?`?${t.params.join("&")}`:"";return`${t.protocol}://${t.authority}${t.path}${e}`}const Ct="mapbox.eventData";function Fr(t){if(!t)return null;const e=t.split(".");if(!e||e.length!==3)return null;try{return JSON.parse(decodeURIComponent(atob(e[1]).split("").map(r=>"%"+("00"+r.charCodeAt(0).toString(16)).slice(-2)).join("")))}catch{return null}}class Kr{constructor(e){this.type=e,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(e){const r=Fr(se.ACCESS_TOKEN);let n="";return n=r&&r.u?btoa(encodeURIComponent(r.u).replace(/%([0-9A-F]{2})/g,(a,l)=>String.fromCharCode(+("0x"+l)))):se.ACCESS_TOKEN||"",e?`${Ct}.${e}:${n}`:`${Ct}:${n}`}fetchEventData(){const e=W("localStorage"),r=this.getStorageKey(),n=this.getStorageKey("uuid");if(e)try{const a=localStorage.getItem(r);a&&(this.eventData=JSON.parse(a));const l=localStorage.getItem(n);l&&(this.anonId=l)}catch{li("Unable to read from LocalStorage")}}saveEventData(){const e=W("localStorage"),r=this.getStorageKey(),n=this.getStorageKey("uuid"),a=this.anonId;if(e&&a)try{localStorage.setItem(n,a),Object.keys(this.eventData).length>=1&&localStorage.setItem(r,JSON.stringify(this.eventData))}catch{li("Unable to write to LocalStorage")}}processRequests(e){}postEvent(e,r,n,a){if(!se.EVENTS_URL)return;const l=Ft(se.EVENTS_URL);l.params.push(`access_token=${a||se.ACCESS_TOKEN||""}`);const h={event:this.type,created:new Date(e).toISOString()},f=r?gi(h,r):h,m={url:cr(l),headers:{"Content-Type":"text/plain"},body:JSON.stringify([f])};this.pendingRequest=function(_,x){return Pe(gi(_,{method:"POST"}),x)}(m,_=>{this.pendingRequest=null,n(_),this.saveEventData(),this.processRequests(a)})}queueRequest(e,r){this.queue.push(e),this.processRequests(r)}}const jr=new class extends Kr{constructor(t){super("appUserTurnstile"),this._customAccessToken=t}postTurnstileEvent(t,e){se.EVENTS_URL&&se.ACCESS_TOKEN&&Array.isArray(t)&&t.some(r=>_e(r)||fe(r))&&this.queueRequest(Date.now(),e)}processRequests(t){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const e=Fr(se.ACCESS_TOKEN),r=e?e.u:se.ACCESS_TOKEN;let n=r!==this.eventData.tokenU;uo(this.anonId)||(this.anonId=Yi(),n=!0);const a=this.queue.shift();if(this.eventData.lastSuccess){const l=new Date(this.eventData.lastSuccess),h=new Date(a),f=(a-this.eventData.lastSuccess)/864e5;n=n||f>=1||f<-1||l.getDate()!==h.getDate()}else n=!0;n?this.postEvent(a,{sdkIdentifier:"mapbox-gl-js",sdkVersion:te,skuId:Qe,"enabled.telemetry":!1,userId:this.anonId},l=>{l||(this.eventData.lastSuccess=a,this.eventData.tokenU=r)},t):this.processRequests()}},xi=jr.postTurnstileEvent.bind(jr),Ni=new class extends Kr{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(t,e,r,n){this.skuToken=e,this.errorCb=n,se.EVENTS_URL&&(r||se.ACCESS_TOKEN?this.queueRequest({id:t,timestamp:Date.now()},r):this.errorCb(new Error(ut)))}processRequests(t){if(this.pendingRequest||this.queue.length===0)return;const{id:e,timestamp:r}=this.queue.shift();e&&this.success[e]||(this.anonId||this.fetchEventData(),uo(this.anonId)||(this.anonId=Yi()),this.postEvent(r,{sdkIdentifier:"mapbox-gl-js",sdkVersion:te,skuId:Qe,skuToken:this.skuToken,userId:this.anonId},n=>{n?this.errorCb(n):e&&(this.success[e]=!0)},t))}remove(){this.errorCb=null}},wr=Ni.postMapLoadEvent.bind(Ni),yn=new class extends Kr{constructor(){super("gljs.performance")}postPerformanceEvent(t,e){se.EVENTS_URL&&(t||se.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:e},t)}processRequests(t){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:e,performanceData:r}=this.queue.shift(),n=function(a){const l=performance.getEntriesByType("resource"),h=performance.getEntriesByType("mark"),f=function(C){const P={};if(C){for(const D in C)if(D!=="other")for(const O of C[D]){const F=`${D}ResolveRangeMin`,$=`${D}ResolveRangeMax`,X=`${D}RequestCount`,H=`${D}RequestCachedCount`;P[F]=Math.min(P[F]||1/0,O.startTime),P[$]=Math.max(P[$]||-1/0,O.responseEnd);const ne=re=>{P[re]===void 0&&(P[re]=0),++P[re]};O.transferSize!==void 0&&O.transferSize===0&&ne(H),ne(X)}}return P}(function(C,P){const D={};if(C)for(const O of C){const F=P(O);D[F]===void 0&&(D[F]=[]),D[F].push(O)}return D}(l,$e)),m=window.devicePixelRatio,_=navigator.connection||navigator.mozConnection||navigator.webkitConnection,x=_?_.effectiveType:void 0,b={counters:[],metadata:[],attributes:[]},T=(C,P,D)=>{D!=null&&C.push({name:P,value:D.toString()})};for(const C in f)T(b.counters,C,f[C]);if(a.interactionRange[0]!==1/0&&a.interactionRange[1]!==-1/0&&(T(b.counters,"interactionRangeMin",a.interactionRange[0]),T(b.counters,"interactionRangeMax",a.interactionRange[1])),h)for(const C of Object.keys(lt)){const P=lt[C],D=h.find(O=>O.name===P);D&&T(b.counters,P,D.startTime)}return T(b.counters,"visibilityHidden",a.visibilityHidden),T(b.attributes,"style",function(C){if(C)for(const P of C){const D=P.name.split("?")[0];if(xt(D)){const O=D.split("/").slice(-2);if(O.length===2)return`mapbox://styles/${O[0]}/${O[1]}`}}}(l)),T(b.attributes,"terrainEnabled",a.terrainEnabled?"true":"false"),T(b.attributes,"fogEnabled",a.fogEnabled?"true":"false"),T(b.attributes,"projection",a.projection),T(b.attributes,"zoom",a.zoom),T(b.metadata,"devicePixelRatio",m),T(b.metadata,"connectionEffectiveType",x),T(b.metadata,"navigatorUserAgent",navigator.userAgent),T(b.metadata,"screenWidth",window.screen.width),T(b.metadata,"screenHeight",window.screen.height),T(b.metadata,"windowWidth",window.innerWidth),T(b.metadata,"windowHeight",window.innerHeight),T(b.metadata,"mapWidth",a.width/m),T(b.metadata,"mapHeight",a.height/m),T(b.metadata,"webglRenderer",a.renderer),T(b.metadata,"webglVendor",a.vendor),T(b.metadata,"sdkVersion",te),T(b.metadata,"sdkIdentifier","mapbox-gl-js"),b}(r);for(const a of n.metadata);for(const a of n.counters);for(const a of n.attributes);this.postEvent(e,n,()=>{},t)}},Un=yn.postPerformanceEvent.bind(yn),Ui=new class extends Kr{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(t,e,r,n){if(!se.API_URL||!se.SESSION_PATH)return;const a=Ft(se.API_URL+se.SESSION_PATH);a.params.push(`sku=${e||""}`),a.params.push(`access_token=${n||se.ACCESS_TOKEN||""}`);const l={url:cr(a),headers:{"Content-Type":"text/plain"}};this.pendingRequest=function(h,f){return Pe(gi(h,{method:"GET"}),f)}(l,h=>{this.pendingRequest=null,r(h),this.saveEventData(),this.processRequests(n)})}getSessionAPI(t,e,r,n){this.skuToken=e,this.errorCb=n,se.SESSION_PATH&&se.API_URL&&(r||se.ACCESS_TOKEN?this.queueRequest({id:t,timestamp:Date.now()},r):this.errorCb(new Error(ut)))}processRequests(t){if(this.pendingRequest||this.queue.length===0)return;const{id:e,timestamp:r}=this.queue.shift();e&&this.success[e]||this.getSession(r,this.skuToken,n=>{n?this.errorCb(n):e&&(this.success[e]=!0)},t)}remove(){this.errorCb=null}},La=Ui.getSessionAPI.bind(Ui),Oo=new Set;function Us(t,e,r){r[t]&&r[t].indexOf(e)!==-1||(r[t]=r[t]||[],r[t].push(e))}function qc(t,e,r){if(r&&r[t]){const n=r[t].indexOf(e);n!==-1&&r[t].splice(n,1)}}class hs{constructor(e,r={}){gi(this,r),this.type=e}}class Wc extends hs{constructor(e,r={}){super("error",gi({error:e},r))}}class Vs{on(e,r){return this._listeners=this._listeners||{},Us(e,r,this._listeners),this}off(e,r){return qc(e,r,this._listeners),qc(e,r,this._oneTimeListeners),this}once(e,r){return r?(this._oneTimeListeners=this._oneTimeListeners||{},Us(e,r,this._oneTimeListeners),this):new Promise(n=>this.once(e,n))}fire(e,r){typeof e=="string"&&(e=new hs(e,r||{}));const n=e.type;if(this.listens(n)){e.target=this;const a=this._listeners&&this._listeners[n]?this._listeners[n].slice():[];for(const f of a)f.call(this,e);const l=this._oneTimeListeners&&this._oneTimeListeners[n]?this._oneTimeListeners[n].slice():[];for(const f of l)qc(n,f,this._oneTimeListeners),f.call(this,e);const h=this._eventedParent;h&&(gi(e,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),h.fire(e))}else e instanceof Wc&&console.error(e.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,r){return this._eventedParent=e,this._eventedParentData=r,this}}s.y=void 0;var cd={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function Ol(t){return(t=Math.round(t))<0?0:t>255?255:t}function Hc(t){return Ol(t[t.length-1]==="%"?parseFloat(t)/100*255:parseInt(t))}function kl(t){return(e=t[t.length-1]==="%"?parseFloat(t)/100:parseFloat(t))<0?0:e>1?1:e;var e}function Xc(t,e,r){return r<0?r+=1:r>1&&(r-=1),6*r<1?t+(e-t)*r*6:2*r<1?e:3*r<2?t+(e-t)*(2/3-r)*6:t}try{s.y={}.parseCSSColor=function(t){var e,r=t.replace(/ /g,"").toLowerCase();if(r in cd)return cd[r].slice();if(r[0]==="#")return r.length===4?(e=parseInt(r.substr(1),16))>=0&&e<=4095?[(3840&e)>>4|(3840&e)>>8,240&e|(240&e)>>4,15&e|(15&e)<<4,1]:null:r.length===7&&(e=parseInt(r.substr(1),16))>=0&&e<=16777215?[(16711680&e)>>16,(65280&e)>>8,255&e,1]:null;var n=r.indexOf("("),a=r.indexOf(")");if(n!==-1&&a+1===r.length){var l=r.substr(0,n),h=r.substr(n+1,a-(n+1)).split(","),f=1;switch(l){case"rgba":if(h.length!==4)return null;f=kl(h.pop());case"rgb":return h.length!==3?null:[Hc(h[0]),Hc(h[1]),Hc(h[2]),f];case"hsla":if(h.length!==4)return null;f=kl(h.pop());case"hsl":if(h.length!==3)return null;var m=(parseFloat(h[0])%360+360)%360/360,_=kl(h[1]),x=kl(h[2]),b=x<=.5?x*(_+1):x+_-x*_,T=2*x-b;return[Ol(255*Xc(T,b,m+1/3)),Ol(255*Xc(T,b,m)),Ol(255*Xc(T,b,m-1/3)),f];default:return null}}return null}}catch{}class on{constructor(e,r,n,a=1){this.r=e,this.g=r,this.b=n,this.a=a}static parse(e){if(!e)return;if(e instanceof on)return e;if(typeof e!="string")return;const r=s.y(e);return r?new on(r[0]/255*r[3],r[1]/255*r[3],r[2]/255*r[3],r[3]):void 0}toString(){const[e,r,n,a]=this.toArray();return`rgba(${Math.round(e)},${Math.round(r)},${Math.round(n)},${a})`}toArray(){const{r:e,g:r,b:n,a}=this;return a===0?[0,0,0,0]:[255*e/a,255*r/a,255*n/a,a]}toArray01(){const{r:e,g:r,b:n,a}=this;return a===0?[0,0,0,0]:[e/a,r/a,n/a,a]}toArray01Scaled(e){const{r,g:n,b:a,a:l}=this;return l===0?[0,0,0]:[r/l*e,n/l*e,a/l*e]}toArray01PremultipliedAlpha(){const{r:e,g:r,b:n,a}=this;return[e,r,n,a]}toArray01Linear(){const{r:e,g:r,b:n,a}=this;return a===0?[0,0,0,0]:[Math.pow(e/a,2.2),Math.pow(r/a,2.2),Math.pow(n/a,2.2),a]}}on.black=new on(0,0,0,1),on.white=new on(1,1,1,1),on.transparent=new on(0,0,0,0),on.red=new on(1,0,0,1),on.blue=new on(0,0,1,1);var mi=on;function ur(t,e,r){return t*(1-r)+e*r}function ud(t,e,r){return t.map((n,a)=>ur(n,e[a],r))}var Bl=Object.freeze({__proto__:null,array:ud,color:function(t,e,r){return new mi(ur(t.r,e.r,r),ur(t.g,e.g,r),ur(t.b,e.b,r),ur(t.a,e.a,r))},number:ur});function Yc(t,...e){for(const r of e)for(const n in r)t[n]=r[n];return t}class Rp extends Error{constructor(e,r){super(r),this.message=r,this.key=e}}var ro=Rp;class Kc{constructor(e,r=[]){this.parent=e,this.bindings={};for(const[n,a]of r)this.bindings[n]=a}concat(e){return new Kc(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}var Op=Kc;const js={kind:"null"},dt={kind:"number"},Ir={kind:"string"},Cr={kind:"boolean"},Cn={kind:"color"},Zs={kind:"object"},mr={kind:"value"},Fl={kind:"collator"},Gs={kind:"formatted"},Da={kind:"resolvedImage"};function sn(t,e){return{kind:"array",itemType:t,N:e}}function di(t){if(t.kind==="array"){const e=di(t.itemType);return typeof t.N=="number"?`array<${e}, ${t.N}>`:t.itemType.kind==="value"?"array":`array<${e}>`}return t.kind}const zt=[js,dt,Ir,Cr,Cn,Gs,Zs,sn(mr),Da];function ds(t,e){if(e.kind==="error")return null;if(t.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!ds(t.itemType,e.itemType))&&(typeof t.N!="number"||t.N===e.N))return null}else{if(t.kind===e.kind)return null;if(t.kind==="value"){for(const r of zt)if(!ds(r,e))return null}}return`Expected ${di(t)} but found ${di(e)} instead.`}function jt(t,e){return e.some(r=>r.kind===t.kind)}function ko(t,e){return e.some(r=>r==="null"?t===null:r==="array"?Array.isArray(t):r==="object"?t&&!Array.isArray(t)&&typeof t=="object":r===typeof t)}class rr{constructor(e,r,n){this.sensitivity=e?r?"variant":"case":r?"accent":"base",this.locale=n,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,r){return this.collator.compare(e,r)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class $s{constructor(e,r,n,a,l){this.text=e.normalize?e.normalize():e,this.image=r,this.scale=n,this.fontStack=a,this.textColor=l}}class Vi{constructor(e){this.sections=e}static fromString(e){return new Vi([new $s(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(e=>e.text.length!==0||e.image&&e.image.namePrimary.length!==0)}static factory(e){return e instanceof Vi?e:Vi.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}serialize(){const e=["format"];for(const r of this.sections){if(r.image){e.push(["image",r.image.namePrimary]);continue}e.push(r.text);const n={};r.fontStack&&(n["text-font"]=["literal",r.fontStack.split(",")]),r.scale&&(n["font-scale"]=r.scale),r.textColor&&(n["text-color"]=["rgba"].concat(r.textColor.toArray())),e.push(n)}return e}}class Rt{constructor(e){this.namePrimary=e.namePrimary,e.nameSecondary&&(this.nameSecondary=e.nameSecondary),this.available=e.available}toString(){return this.nameSecondary?`[${this.namePrimary},${this.nameSecondary}]`:this.namePrimary}static fromString(e,r){return e?new Rt({namePrimary:e,nameSecondary:r,available:!1}):null}serialize(){return this.nameSecondary?["image",this.namePrimary,this.nameSecondary]:["image",this.namePrimary]}}function hd(t,e,r,n){return typeof t=="number"&&t>=0&&t<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof r=="number"&&r>=0&&r<=255?n===void 0||typeof n=="number"&&n>=0&&n<=1?null:`Invalid rgba value [${[t,e,r,n].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof n=="number"?[t,e,r,n]:[t,e,r]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function fs(t){if(t===null||typeof t=="string"||typeof t=="boolean"||typeof t=="number"||t instanceof mi||t instanceof rr||t instanceof Vi||t instanceof Rt)return!0;if(Array.isArray(t)){for(const e of t)if(!fs(e))return!1;return!0}if(typeof t=="object"){for(const e in t)if(!fs(t[e]))return!1;return!0}return!1}function vi(t){if(t===null)return js;if(typeof t=="string")return Ir;if(typeof t=="boolean")return Cr;if(typeof t=="number")return dt;if(t instanceof mi)return Cn;if(t instanceof rr)return Fl;if(t instanceof Vi)return Gs;if(t instanceof Rt)return Da;if(Array.isArray(t)){const e=t.length;let r;for(const n of t){const a=vi(n);if(r){if(r===a)continue;r=mr;break}r=a}return sn(r||mr,e)}return Zs}function An(t){const e=typeof t;return t===null?"":e==="string"||e==="number"||e==="boolean"?String(t):t instanceof mi||t instanceof Vi||t instanceof Rt?t.toString():JSON.stringify(t)}class Bo{constructor(e,r){this.type=e,this.value=r}static parse(e,r){if(e.length!==2)return r.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!fs(e[1]))return r.error("invalid value");const n=e[1];let a=vi(n);const l=r.expectedType;return a.kind!=="array"||a.N!==0||!l||l.kind!=="array"||typeof l.N=="number"&&l.N!==0||(a=l),new Bo(a,n)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof mi?["rgba"].concat(this.value.toArray()):this.value instanceof Vi?this.value.serialize():this.value}}var po=Bo,bi=class{constructor(t){this.name="ExpressionEvaluationError",this.message=t}toJSON(){return this.message}};const Jc={string:Ir,number:dt,boolean:Cr,object:Zs};class Qc{constructor(e,r){this.type=e,this.args=r}static parse(e,r){if(e.length<2)return r.error("Expected at least one argument.");let n,a=1;const l=e[0];if(l==="array"){let f,m;if(e.length>2){const _=e[1];if(typeof _!="string"||!(_ in Jc)||_==="object")return r.error('The item type argument of "array" must be one of string, number, boolean',1);f=Jc[_],a++}else f=mr;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return r.error('The length argument to "array" must be a positive integer literal',2);m=e[2],a++}n=sn(f,m)}else n=Jc[l];const h=[];for(;a<e.length;a++){const f=r.parse(e[a],a,mr);if(!f)return null;h.push(f)}return new Qc(n,h)}evaluate(e){for(let r=0;r<this.args.length;r++){const n=this.args[r].evaluate(e);if(!ds(this.type,vi(n)))return n;if(r===this.args.length-1)throw new bi(`Expected value to be of type ${di(this.type)}, but found ${di(vi(n))} instead.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=this.type,r=[e.kind];if(e.kind==="array"){const n=e.itemType;if(n.kind==="string"||n.kind==="number"||n.kind==="boolean"){r.push(n.kind);const a=e.N;(typeof a=="number"||this.args.length>1)&&r.push(a)}}return r.concat(this.args.map(n=>n.serialize()))}}var mo=Qc;class qs{constructor(e){this.type=Gs,this.sections=e}static parse(e,r){if(e.length<2)return r.error("Expected at least one argument.");const n=e[1];if(!Array.isArray(n)&&typeof n=="object")return r.error("First argument must be an image or text section.");const a=[];let l=!1;for(let h=1;h<=e.length-1;++h){const f=e[h];if(l&&typeof f=="object"&&!Array.isArray(f)){l=!1;let m=null;if(f["font-scale"]&&(m=r.parse(f["font-scale"],1,dt),!m))return null;let _=null;if(f["text-font"]&&(_=r.parse(f["text-font"],1,sn(Ir)),!_))return null;let x=null;if(f["text-color"]&&(x=r.parse(f["text-color"],1,Cn),!x))return null;const b=a[a.length-1];b.scale=m,b.font=_,b.textColor=x}else{const m=r.parse(e[h],1,mr);if(!m)return null;const _=m.type.kind;if(_!=="string"&&_!=="value"&&_!=="null"&&_!=="resolvedImage")return r.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");l=!0,a.push({content:m,scale:null,font:null,textColor:null})}}return new qs(a)}evaluate(e){return new Vi(this.sections.map(r=>{const n=r.content.evaluate(e);return vi(n)===Da?new $s("",n,null,null,null):new $s(An(n),null,r.scale?r.scale.evaluate(e):null,r.font?r.font.evaluate(e).join(","):null,r.textColor?r.textColor.evaluate(e):null)}))}eachChild(e){for(const r of this.sections)e(r.content),r.scale&&e(r.scale),r.font&&e(r.font),r.textColor&&e(r.textColor)}outputDefined(){return!1}serialize(){const e=["format"];for(const r of this.sections){e.push(r.content.serialize());const n={};r.scale&&(n["font-scale"]=r.scale.serialize()),r.font&&(n["text-font"]=r.font.serialize()),r.textColor&&(n["text-color"]=r.textColor.serialize()),e.push(n)}return e}}class ps{constructor(e,r){this.type=Da,this.inputPrimary=e,this.inputSecondary=r}static parse(e,r){if(e.length<2)return r.error("Expected two or more arguments.");const n=r.parse(e[1],1,Ir);if(!n)return r.error("No image name provided.");if(e.length===2)return new ps(n);const a=r.parse(e[2],1,Ir);return a?new ps(n,a):r.error("Secondary image variant is not a string.")}evaluate(e){const r=Rt.fromString(this.inputPrimary.evaluate(e),this.inputSecondary?this.inputSecondary.evaluate(e):void 0);return r&&e.availableImages&&(r.available=e.availableImages.indexOf(r.namePrimary)>-1,r.nameSecondary&&r.available&&e.availableImages&&(r.available=e.availableImages.indexOf(r.nameSecondary)>-1)),r}eachChild(e){e(this.inputPrimary),this.inputSecondary&&e(this.inputSecondary)}outputDefined(){return!1}serialize(){return this.inputSecondary?["image",this.inputPrimary.serialize(),this.inputSecondary.serialize()]:["image",this.inputPrimary.serialize()]}}function Ws(t){return t instanceof Number?"number":t instanceof String?"string":t instanceof Boolean?"boolean":Array.isArray(t)?"array":t===null?"null":typeof t}const Vn={"to-boolean":Cr,"to-color":Cn,"to-number":dt,"to-string":Ir};class Nl{constructor(e,r){this.type=e,this.args=r}static parse(e,r){if(e.length<2)return r.error("Expected at least one argument.");const n=e[0],a=[];let l=js;if(n==="to-array"){if(!Array.isArray(e[1]))return null;const h=e[1].length;if(r.expectedType){if(r.expectedType.kind!=="array")return r.error(`Expected ${r.expectedType.kind} but found array.`);l=sn(r.expectedType.itemType,h)}else{if(!(h>0&&fs(e[1][0])))return null;l=sn(vi(e[1][0]),h)}for(let f=0;f<h;f++){const m=e[1][f];let _;if(Ws(m)==="array")_=r.parse(m,void 0,l.itemType);else{const x=Ws(m);if(x!==l.itemType.kind)return r.error(`Expected ${l.itemType.kind} but found ${x}.`);_=r.registry.literal.parse(["literal",m===void 0?null:m],r)}if(!_)return null;a.push(_)}}else{if((n==="to-boolean"||n==="to-string")&&e.length!==2)return r.error("Expected one argument.");l=Vn[n];for(let h=1;h<e.length;h++){const f=r.parse(e[h],h,mr);if(!f)return null;a.push(f)}}return new Nl(l,a)}evaluate(e){if(this.type.kind==="boolean")return!!this.args[0].evaluate(e);if(this.type.kind==="color"){let r,n;for(const a of this.args){if(r=a.evaluate(e),n=null,r instanceof mi)return r;if(typeof r=="string"){const l=e.parseColor(r);if(l)return l}else if(Array.isArray(r)&&(n=r.length<3||r.length>4?`Invalid rbga value ${JSON.stringify(r)}: expected an array containing either three or four numeric values.`:hd(r[0],r[1],r[2],r[3]),!n))return new mi(r[0]/255,r[1]/255,r[2]/255,r[3])}throw new bi(n||`Could not parse color from value '${typeof r=="string"?r:String(JSON.stringify(r))}'`)}if(this.type.kind==="number"){let r=null;for(const n of this.args){if(r=n.evaluate(e),r===null)return 0;const a=Number(r);if(!isNaN(a))return a}throw new bi(`Could not convert ${JSON.stringify(r)} to number.`)}return this.type.kind==="formatted"?Vi.fromString(An(this.args[0].evaluate(e))):this.type.kind==="resolvedImage"?Rt.fromString(An(this.args[0].evaluate(e))):this.type.kind==="array"?this.args.map(r=>r.evaluate(e)):An(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){if(this.type.kind==="formatted")return new qs([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new ps(this.args[0]).serialize();const e=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild(r=>{e.push(r.serialize())}),e}}var _o=Nl;const za=["Unknown","Point","LineString","Polygon"];var dd=class{constructor(t,e){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=t,this.options=e}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?za[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(t){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const t=this.featureDistanceData.center,e=this.featureDistanceData.scale,{x:r,y:n}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(r*e-t[0])+this.featureDistanceData.bearing[1]*(n*e-t[1])}return 0}parseColor(t){let e=this._parseColorCache[t];return e||(e=this._parseColorCache[t]=mi.parse(t)),e}getConfig(t){return this.options?this.options.get(t):null}};class ms{constructor(e,r,n,a,l){this.name=e,this.type=r,this._evaluate=n,this.args=a,this._overloadIndex=l}evaluate(e){if(!this._evaluate){const r=ms.definitions[this.name];this._evaluate=Array.isArray(r)?r[2]:r.overloads[this._overloadIndex][1]}return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(e=>e.serialize()))}static parse(e,r){const n=e[0],a=ms.definitions[n];if(!a)return r.error(`Unknown expression "${n}". If you wanted a literal array, use ["literal", [...]].`,0);const l=Array.isArray(a)?a[0]:a.type,h=Array.isArray(a)?[[a[1],a[2]]]:a.overloads,f=[];let m=null,_=-1;for(const[x,b]of h){if(Array.isArray(x)&&x.length!==e.length-1)continue;f.push(x),_++,m=new xd(r.registry,r.path,null,r.scope,void 0,r._scope,r.options);const T=[];let C=!1;for(let P=1;P<e.length;P++){const D=e[P],O=Array.isArray(x)?x[P-1]:x.type,F=m.parse(D,1+T.length,O);if(!F){C=!0;break}T.push(F)}if(!C)if(Array.isArray(x)&&x.length!==T.length)m.error(`Expected ${x.length} arguments, but found ${T.length} instead.`);else{for(let P=0;P<T.length;P++){const D=Array.isArray(x)?x[P]:x.type,O=T[P];m.concat(P+1).checkSubtype(D,O.type)}if(m.errors.length===0)return new ms(n,l,b,T,_)}}if(f.length===1)r.errors.push(...m.errors);else{const x=(f.length?f:h.map(([T])=>T)).map(fd).join(" | "),b=[];for(let T=1;T<e.length;T++){const C=r.parse(e[T],1+b.length);if(!C)return null;b.push(di(C.type))}r.error(`Expected arguments of type ${x}, but found (${b.join(", ")}) instead.`)}return null}static register(e,r){ms.definitions=r;for(const n in r)e[n]=ms}}function fd(t){return Array.isArray(t)?`(${t.map(di).join(", ")})`:`(${di(t.type)}...)`}var dr=ms;class Ra{constructor(e,r,n){this.type=Fl,this.locale=n,this.caseSensitive=e,this.diacriticSensitive=r}static parse(e,r){if(e.length!==2)return r.error("Expected one argument.");const n=e[1];if(typeof n!="object"||Array.isArray(n))return r.error("Collator options argument must be an object.");const a=r.parse(n["case-sensitive"]!==void 0&&n["case-sensitive"],1,Cr);if(!a)return null;const l=r.parse(n["diacritic-sensitive"]!==void 0&&n["diacritic-sensitive"],1,Cr);if(!l)return null;let h=null;return n.locale&&(h=r.parse(n.locale,1,Ir),!h)?null:new Ra(a,l,h)}evaluate(e){return new rr(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){const e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}var eu={exports:{}};eu.exports=function(){function t(n,a,l,h,f){for(;h>l;){if(h-l>600){var m=h-l+1,_=a-l+1,x=Math.log(m),b=.5*Math.exp(2*x/3),T=.5*Math.sqrt(x*b*(m-b)/m)*(_-m/2<0?-1:1);t(n,a,Math.max(l,Math.floor(a-_*b/m+T)),Math.min(h,Math.floor(a+(m-_)*b/m+T)),f)}var C=n[a],P=l,D=h;for(e(n,l,a),f(n[h],C)>0&&e(n,l,h);P<D;){for(e(n,P,D),P++,D--;f(n[P],C)<0;)P++;for(;f(n[D],C)>0;)D--}f(n[l],C)===0?e(n,l,D):e(n,++D,h),D<=a&&(l=D+1),a<=D&&(h=D-1)}}function e(n,a,l){var h=n[a];n[a]=n[l],n[l]=h}function r(n,a){return n<a?-1:n>a?1:0}return function(n,a,l,h,f){t(n,a,l||0,h||n.length-1,f||r)}}();var kp=ft(eu.exports);function Bp(t){let e=0;for(let r,n,a=0,l=t.length,h=l-1;a<l;h=a++)r=t[a],n=t[h],e+=(n.x-r.x)*(r.y+n.y);return e}function Fo(t,e){t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.max(t[2],e[0]),t[3]=Math.max(t[3],e[1])}function No(t,e){return!(t[0]<=e[0]||t[2]>=e[2]||t[1]<=e[1]||t[3]>=e[3])}function Ul(t,e,r){const n=t[0]-e[0],a=t[1]-e[1],l=t[0]-r[0],h=t[1]-r[1];return n*h-l*a==0&&n*l<=0&&a*h<=0}function Hs(t,e,r=!1){let n=!1;for(let f=0,m=e.length;f<m;f++){const _=e[f];for(let x=0,b=_.length,T=b-1;x<b;T=x++){const C=_[T],P=_[x];if(Ul(t,C,P))return r;(l=C)[1]>(a=t)[1]!=(h=P)[1]>a[1]&&a[0]<(h[0]-l[0])*(a[1]-l[1])/(h[1]-l[1])+l[0]&&(n=!n)}}var a,l,h;return n}function tu(t,e,r,n){const a=n[0]-r[0],l=n[1]-r[1],h=(t[0]-r[0])*l-a*(t[1]-r[1]),f=(e[0]-r[0])*l-a*(e[1]-r[1]);return h>0&&f<0||h<0&&f>0}function go(t,e,r,n){return(a=[n[0]-r[0],n[1]-r[1]])[0]*(l=[e[0]-t[0],e[1]-t[1]])[1]-a[1]*l[0]!=0&&!(!tu(t,e,r,n)||!tu(r,n,t,e));var a,l}const Uo=8192;function Oa(t,e){const r=(180+t[0])/360,n=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+t[1]*Math.PI/360)))/360,a=Math.pow(2,e.z);return[Math.round(r*a*Uo),Math.round(n*a*Uo)]}function ru(t,e){for(let r=0;r<e.length;r++)if(Hs(t,e[r]))return!0;return!1}function iu(t,e,r){for(const n of r)for(let a=0,l=n.length,h=l-1;a<l;h=a++)if(go(t,e,n[h],n[a]))return!0;return!1}function Sn(t,e){for(let r=0;r<t.length;++r)if(!Hs(t[r],e))return!1;for(let r=0;r<t.length-1;++r)if(iu(t[r],t[r+1],e))return!1;return!0}function pd(t,e){for(let r=0;r<e.length;r++)if(Sn(t,e[r]))return!0;return!1}function nu(t,e,r){const n=[];for(let a=0;a<t.length;a++){const l=[];for(let h=0;h<t[a].length;h++){const f=Oa(t[a][h],r);Fo(e,f),l.push(f)}n.push(l)}return n}function ou(t,e,r){const n=[];for(let a=0;a<t.length;a++){const l=nu(t[a],e,r);n.push(l)}return n}function su(t,e,r,n){if(t[0]<r[0]||t[0]>r[2]){const a=.5*n;let l=t[0]-r[0]>a?-n:r[0]-t[0]>a?n:0;l===0&&(l=t[0]-r[2]>a?-n:r[2]-t[0]>a?n:0),t[0]+=l}Fo(e,t)}function au(t,e,r,n){const a=Math.pow(2,n.z)*Uo,l=[n.x*Uo,n.y*Uo],h=[];if(!t)return h;for(const f of t)for(const m of f){const _=[m.x+l[0],m.y+l[1]];su(_,e,r,a),h.push(_)}return h}function lu(t,e,r,n){const a=Math.pow(2,n.z)*Uo,l=[n.x*Uo,n.y*Uo],h=[];if(!t)return h;for(const m of t){const _=[];for(const x of m){const b=[x.x+l[0],x.y+l[1]];Fo(e,b),_.push(b)}h.push(_)}if(e[2]-e[0]<=a/2){(f=e)[0]=f[1]=1/0,f[2]=f[3]=-1/0;for(const m of h)for(const _ of m)su(_,e,r,a)}var f;return h}class Xs{constructor(e,r){this.type=Cr,this.geojson=e,this.geometries=r}static parse(e,r){if(e.length!==2)return r.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(fs(e[1])){const n=e[1];if(n.type==="FeatureCollection")for(let a=0;a<n.features.length;++a){const l=n.features[a].geometry.type;if(l==="Polygon"||l==="MultiPolygon")return new Xs(n,n.features[a].geometry)}else if(n.type==="Feature"){const a=n.geometry.type;if(a==="Polygon"||a==="MultiPolygon")return new Xs(n,n.geometry)}else if(n.type==="Polygon"||n.type==="MultiPolygon")return new Xs(n,n)}return r.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return function(r,n){const a=[1/0,1/0,-1/0,-1/0],l=[1/0,1/0,-1/0,-1/0],h=r.canonicalID();if(!h)return!1;if(n.type==="Polygon"){const f=nu(n.coordinates,l,h),m=au(r.geometry(),a,l,h);if(!No(a,l))return!1;for(const _ of m)if(!Hs(_,f))return!1}if(n.type==="MultiPolygon"){const f=ou(n.coordinates,l,h),m=au(r.geometry(),a,l,h);if(!No(a,l))return!1;for(const _ of m)if(!ru(_,f))return!1}return!0}(e,this.geometries);if(e.geometryType()==="LineString")return function(r,n){const a=[1/0,1/0,-1/0,-1/0],l=[1/0,1/0,-1/0,-1/0],h=r.canonicalID();if(!h)return!1;if(n.type==="Polygon"){const f=nu(n.coordinates,l,h),m=lu(r.geometry(),a,l,h);if(!No(a,l))return!1;for(const _ of m)if(!Sn(_,f))return!1}if(n.type==="MultiPolygon"){const f=ou(n.coordinates,l,h),m=lu(r.geometry(),a,l,h);if(!No(a,l))return!1;for(const _ of m)if(!pd(_,f))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}var Vl=Xs,ka={exports:{}};ka.exports=function(){var t={kilometers:1,miles:.621371192237334,nauticalmiles:.5399568034557235,meters:1e3,metres:1e3,yards:1093.6132983377079,feet:3280.839895013123,inches:39370.078740157485},e=1/298.257223563,r=e*(2-e),n=Math.PI/180,a=function(_,x){if(_===void 0)throw new Error("No latitude given.");if(x&&!t[x])throw new Error("Unknown unit "+x+". Use one of: "+Object.keys(t).join(", "));var b=6378.137*n*(x?t[x]:1),T=Math.cos(_*n),C=1/(1-r*(1-T*T)),P=Math.sqrt(C);this.kx=b*P*T,this.ky=b*P*C*(1-r)},l={units:{configurable:!0}};function h(_,x){return _[0]===x[0]&&_[1]===x[1]}function f(_,x,b){var T=m(x[0]-_[0]);return[_[0]+T*b,_[1]+(x[1]-_[1])*b]}function m(_){for(;_<-180;)_+=360;for(;_>180;)_-=360;return _}return a.fromTile=function(_,x,b){var T=Math.PI*(1-2*(_+.5)/Math.pow(2,x)),C=Math.atan(.5*(Math.exp(T)-Math.exp(-T)))/n;return new a(C,b)},l.units.get=function(){return t},a.prototype.distance=function(_,x){var b=m(_[0]-x[0])*this.kx,T=(_[1]-x[1])*this.ky;return Math.sqrt(b*b+T*T)},a.prototype.bearing=function(_,x){var b=m(x[0]-_[0])*this.kx;return Math.atan2(b,(x[1]-_[1])*this.ky)/n},a.prototype.destination=function(_,x,b){var T=b*n;return this.offset(_,Math.sin(T)*x,Math.cos(T)*x)},a.prototype.offset=function(_,x,b){return[_[0]+x/this.kx,_[1]+b/this.ky]},a.prototype.lineDistance=function(_){for(var x=0,b=0;b<_.length-1;b++)x+=this.distance(_[b],_[b+1]);return x},a.prototype.area=function(_){for(var x=0,b=0;b<_.length;b++)for(var T=_[b],C=0,P=T.length,D=P-1;C<P;D=C++)x+=m(T[C][0]-T[D][0])*(T[C][1]+T[D][1])*(b?-1:1);return Math.abs(x)/2*this.kx*this.ky},a.prototype.along=function(_,x){var b=0;if(x<=0)return _[0];for(var T=0;T<_.length-1;T++){var C=_[T],P=_[T+1],D=this.distance(C,P);if((b+=D)>x)return f(C,P,(x-(b-D))/D)}return _[_.length-1]},a.prototype.pointToSegmentDistance=function(_,x,b){var T=x[0],C=x[1],P=m(b[0]-T)*this.kx,D=(b[1]-C)*this.ky,O=0;return P===0&&D===0||((O=(m(_[0]-T)*this.kx*P+(_[1]-C)*this.ky*D)/(P*P+D*D))>1?(T=b[0],C=b[1]):O>0&&(T+=P/this.kx*O,C+=D/this.ky*O)),P=m(_[0]-T)*this.kx,D=(_[1]-C)*this.ky,Math.sqrt(P*P+D*D)},a.prototype.pointOnLine=function(_,x){for(var b,T,C,P,D=1/0,O=0;O<_.length-1;O++){var F=_[O][0],$=_[O][1],X=m(_[O+1][0]-F)*this.kx,H=(_[O+1][1]-$)*this.ky,ne=0;X===0&&H===0||((ne=(m(x[0]-F)*this.kx*X+(x[1]-$)*this.ky*H)/(X*X+H*H))>1?(F=_[O+1][0],$=_[O+1][1]):ne>0&&(F+=X/this.kx*ne,$+=H/this.ky*ne));var re=(X=m(x[0]-F)*this.kx)*X+(H=(x[1]-$)*this.ky)*H;re<D&&(D=re,b=F,T=$,C=O,P=ne)}return{point:[b,T],index:C,t:Math.max(0,Math.min(1,P))}},a.prototype.lineSlice=function(_,x,b){var T=this.pointOnLine(b,_),C=this.pointOnLine(b,x);if(T.index>C.index||T.index===C.index&&T.t>C.t){var P=T;T=C,C=P}var D=[T.point],O=T.index+1,F=C.index;!h(b[O],D[0])&&O<=F&&D.push(b[O]);for(var $=O+1;$<=F;$++)D.push(b[$]);return h(b[F],C.point)||D.push(C.point),D},a.prototype.lineSliceAlong=function(_,x,b){for(var T=0,C=[],P=0;P<b.length-1;P++){var D=b[P],O=b[P+1],F=this.distance(D,O);if((T+=F)>_&&C.length===0&&C.push(f(D,O,(_-(T-F))/F)),T>=x)return C.push(f(D,O,(x-(T-F))/F)),C;T>_&&C.push(O)}return C},a.prototype.bufferPoint=function(_,x){var b=x/this.ky,T=x/this.kx;return[_[0]-T,_[1]-b,_[0]+T,_[1]+b]},a.prototype.bufferBBox=function(_,x){var b=x/this.ky,T=x/this.kx;return[_[0]-T,_[1]-b,_[2]+T,_[3]+b]},a.prototype.insideBBox=function(_,x){return m(_[0]-x[0])>=0&&m(_[0]-x[2])<=0&&_[1]>=x[1]&&_[1]<=x[3]},Object.defineProperties(a,l),a}();var Vo=ft(ka.exports),cu={exports:{}};cu.exports=function(){var t=function(r,n){if(r===void 0&&(r=[]),n===void 0&&(n=e),this.data=r,this.length=this.data.length,this.compare=n,this.length>0)for(var a=(this.length>>1)-1;a>=0;a--)this._down(a)};function e(r,n){return r<n?-1:r>n?1:0}return t.prototype.push=function(r){this.data.push(r),this.length++,this._up(this.length-1)},t.prototype.pop=function(){if(this.length!==0){var r=this.data[0],n=this.data.pop();return this.length--,this.length>0&&(this.data[0]=n,this._down(0)),r}},t.prototype.peek=function(){return this.data[0]},t.prototype._up=function(r){for(var n=this.data,a=this.compare,l=n[r];r>0;){var h=r-1>>1,f=n[h];if(a(l,f)>=0)break;n[r]=f,r=h}n[r]=l},t.prototype._down=function(r){for(var n=this.data,a=this.compare,l=this.length>>1,h=n[r];r<l;){var f=1+(r<<1),m=n[f],_=f+1;if(_<this.length&&a(n[_],m)<0&&(f=_,m=n[_]),a(m,h)>=0)break;n[r]=m,r=f}n[r]=h},t}();var Pn=ft(cu.exports),ct=8192;function jl(t,e){return e.dist-t.dist}const uu=100,Ba=50;function hu(t){const e=[1/0,1/0,-1/0,-1/0];if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}function jo(t){return t[1]-t[0]+1}function jn(t,e){const r=t[1]>=t[0]&&t[1]<e;return r||console.warn("Distance Expression: Index is out of range"),r}function du(t,e){if(t[0]>t[1])return[null,null];const r=jo(t);if(e){if(r===2)return[t,null];const n=Math.floor(r/2);return[[t[0],t[0]+n],[t[0]+n,t[1]]]}{if(r===1)return[t,null];const n=Math.floor(r/2)-1;return[[t[0],t[0]+n],[t[0]+n+1,t[1]]]}}function _s(t,e){const r=[1/0,1/0,-1/0,-1/0];if(!jn(e,t.length))return r;for(let n=e[0];n<=e[1];++n)Fo(r,t[n]);return r}function Zl(t){const e=[1/0,1/0,-1/0,-1/0];for(let r=0;r<t.length;++r)for(let n=0;n<t[r].length;++n)Fo(e,t[r][n]);return e}function gs(t,e,r){if(hu(t)||hu(e))return NaN;let n=0,a=0;return t[2]<e[0]&&(n=e[0]-t[2]),t[0]>e[2]&&(n=t[0]-e[2]),t[1]>e[3]&&(a=t[1]-e[3]),t[3]<e[1]&&(a=e[1]-t[3]),r.distance([0,0],[n,a])}function fu(t){return 360*t-180}function Fp(t){return 360/Math.PI*Math.atan(Math.exp((180-360*t)*Math.PI/180))-90}function Ys(t,e){const r=Math.pow(2,e.z),n=(t.y/ct+e.y)/r;return[fu((t.x/ct+e.x)/r),Fp(n)]}function Np(t,e){const r=[];for(let n=0;n<t.length;++n)r.push(Ys(t[n],e));return r}function md(t,e,r){const n=r.pointOnLine(e,t).point;return r.distance(t,n)}function _d(t,e,r,n,a){const l=r.slice(n[0],n[1]+1);let h=1/0;for(let f=e[0];f<=e[1];++f)if((h=Math.min(h,md(t[f],l,a)))===0)return 0;return h}function pu(t,e,r,n,a){const l=Math.min(a.pointToSegmentDistance(t,r,n),a.pointToSegmentDistance(e,r,n)),h=Math.min(a.pointToSegmentDistance(r,t,e),a.pointToSegmentDistance(n,t,e));return Math.min(l,h)}function Up(t,e,r,n,a){if(!jn(e,t.length)||!jn(n,r.length))return NaN;let l=1/0;for(let h=e[0];h<e[1];++h)for(let f=n[0];f<n[1];++f){if(go(t[h],t[h+1],r[f],r[f+1]))return 0;l=Math.min(l,pu(t[h],t[h+1],r[f],r[f+1],a))}return l}function Vp(t,e,r,n,a){if(!jn(e,t.length)||!jn(n,r.length))return NaN;let l=1/0;for(let h=e[0];h<=e[1];++h)for(let f=n[0];f<=n[1];++f)if((l=Math.min(l,a.distance(t[h],r[f])))===0)return l;return l}function jp(t,e,r){if(Hs(t,e,!0))return 0;let n=1/0;for(const a of e){const l=a.length;if(l<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(a[0]!==a[l-1]&&(n=Math.min(n,r.pointToSegmentDistance(t,a[l-1],a[0])))===0||(n=Math.min(n,md(t,a,r)))===0)return n}return n}function gd(t,e,r,n){if(!jn(e,t.length))return NaN;for(let l=e[0];l<=e[1];++l)if(Hs(t[l],r,!0))return 0;let a=1/0;for(let l=e[0];l<e[1];++l)for(const h of r)for(let f=0,m=h.length,_=m-1;f<m;_=f++){if(go(t[l],t[l+1],h[_],h[f]))return 0;a=Math.min(a,pu(t[l],t[l+1],h[_],h[f],n))}return a}function Fa(t,e){for(const r of t)for(let n=0;n<=r.length-1;++n)if(Hs(r[n],e,!0))return!0;return!1}function Zp(t,e,r,n=1/0){const a=Zl(t),l=Zl(e);if(n!==1/0&&gs(a,l,r)>=n)return n;if(No(a,l)){if(Fa(t,e))return 0}else if(Fa(e,t))return 0;let h=n;for(const f of t)for(let m=0,_=f.length,x=_-1;m<_;x=m++)for(const b of e)for(let T=0,C=b.length,P=C-1;T<C;P=T++){if(go(f[x],f[m],b[P],b[T]))return 0;h=Math.min(h,pu(f[x],f[m],b[P],b[T],r))}return h}function Gl(t,e,r,n,a,l,h){if(l===null||h===null)return;const f=gs(_s(n,l),_s(a,h),r);f<e&&t.push({dist:f,range1:l,range2:h})}function mu(t,e,r,n,a=1/0){let l=Math.min(n.distance(t[0],r[0][0]),a);if(l===0)return l;const h=new Pn([{dist:0,range1:[0,t.length-1],range2:[0,0]}],jl),f=e?Ba:uu,m=Zl(r);for(;h.length;){const _=h.pop();if(_.dist>=l)continue;const x=_.range1;if(jo(x)<=f){if(!jn(x,t.length))return NaN;if(e){const b=gd(t,x,r,n);if((l=Math.min(l,b))===0)return l}else for(let b=x[0];b<=x[1];++b){const T=jp(t[b],r,n);if((l=Math.min(l,T))===0)return l}}else{const b=du(x,e);if(b[0]!==null){const T=gs(_s(t,b[0]),m,n);T<l&&h.push({dist:T,range1:b[0],range2:[0,0]})}if(b[1]!==null){const T=gs(_s(t,b[1]),m,n);T<l&&h.push({dist:T,range1:b[1],range2:[0,0]})}}}return l}function yd(t,e,r,n,a,l=1/0){let h=Math.min(l,a.distance(t[0],r[0]));if(h===0)return h;const f=new Pn([{dist:0,range1:[0,t.length-1],range2:[0,r.length-1]}],jl),m=e?Ba:uu,_=n?Ba:uu;for(;f.length;){const x=f.pop();if(x.dist>=h)continue;const b=x.range1,T=x.range2;if(jo(b)<=m&&jo(T)<=_){if(!jn(b,t.length)||!jn(T,r.length))return NaN;if(e&&n?h=Math.min(h,Up(t,b,r,T,a)):e||n?e&&!n?h=Math.min(h,_d(r,T,t,b,a)):!e&&n&&(h=Math.min(h,_d(t,b,r,T,a))):h=Math.min(h,Vp(t,b,r,T,a)),h===0)return h}else{const C=du(b,e),P=du(T,n);Gl(f,h,a,t,r,C[0],P[0]),Gl(f,h,a,t,r,C[0],P[1]),Gl(f,h,a,t,r,C[1],P[0]),Gl(f,h,a,t,r,C[1],P[1])}}return h}function _u(t,e,r,n,a=1/0){let l=a;const h=_s(t,[0,t.length-1]);for(const f of r)if(!(l!==1/0&&gs(h,_s(f,[0,f.length-1]),n)>=l)&&(l=Math.min(l,yd(t,e,f,!0,n,l)),l===0))return l;return l}function $l(t,e,r,n,a=1/0){let l=a;const h=_s(t,[0,t.length-1]);for(const f of r){if(l!==1/0&&gs(h,Zl(f),n)>=l)continue;const m=mu(t,e,f,n,l);if(isNaN(m))return m;if((l=Math.min(l,m))===0)return l}return l}function gu(t){return t==="Point"||t==="MultiPoint"||t==="LineString"||t==="MultiLineString"||t==="Polygon"||t==="MultiPolygon"}class ys{constructor(e,r){this.type=dt,this.geojson=e,this.geometries=r}static parse(e,r){if(e.length!==2)return r.error(`'distance' expression requires either one argument, but found ' ${e.length-1} instead.`);if(fs(e[1])){const n=e[1];if(n.type==="FeatureCollection"){for(let a=0;a<n.features.length;++a)if(gu(n.features[a].geometry.type))return new ys(n,n.features[a].geometry)}else if(n.type==="Feature"){if(gu(n.geometry.type))return new ys(n,n.geometry)}else if(gu(n.type))return new ys(n,n)}return r.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(e){const r=e.geometry(),n=e.canonicalID();if(r!=null&&n!=null){if(e.geometryType()==="Point")return function(a,l,h){const f=[];for(const _ of a)for(const x of _)f.push(Ys(x,l));const m=new Vo(f[0][1],"meters");return h.type==="Point"||h.type==="MultiPoint"||h.type==="LineString"?yd(f,!1,h.type==="Point"?[h.coordinates]:h.coordinates,h.type==="LineString",m):h.type==="MultiLineString"?_u(f,!1,h.coordinates,m):h.type==="Polygon"||h.type==="MultiPolygon"?$l(f,!1,h.type==="Polygon"?[h.coordinates]:h.coordinates,m):null}(r,n,this.geometries);if(e.geometryType()==="LineString")return function(a,l,h){const f=[];for(const _ of a){const x=[];for(const b of _)x.push(Ys(b,l));f.push(x)}const m=new Vo(f[0][0][1],"meters");if(h.type==="Point"||h.type==="MultiPoint"||h.type==="LineString")return _u(h.type==="Point"?[h.coordinates]:h.coordinates,h.type==="LineString",f,m);if(h.type==="MultiLineString"){let _=1/0;for(let x=0;x<h.coordinates.length;x++){const b=_u(h.coordinates[x],!0,f,m,_);if(isNaN(b))return b;if((_=Math.min(_,b))===0)return _}return _}if(h.type==="Polygon"||h.type==="MultiPolygon"){let _=1/0;for(let x=0;x<f.length;x++){const b=$l(f[x],!0,h.type==="Polygon"?[h.coordinates]:h.coordinates,m,_);if(isNaN(b))return b;if((_=Math.min(_,b))===0)return _}return _}return null}(r,n,this.geometries);if(e.geometryType()==="Polygon")return function(a,l,h){const f=[];for(const _ of function(x,b){const T=x.length;if(T<=1)return[x];const C=[];let P,D;for(let O=0;O<T;O++){const F=Bp(x[O]);F!==0&&(x[O].area=Math.abs(F),D===void 0&&(D=F<0),D===F<0?(P&&C.push(P),P=[x[O]]):P.push(x[O]))}return P&&C.push(P),C}(a)){const x=[];for(let b=0;b<_.length;++b)x.push(Np(_[b],l));f.push(x)}const m=new Vo(f[0][0][0][1],"meters");if(h.type==="Point"||h.type==="MultiPoint"||h.type==="LineString")return $l(h.type==="Point"?[h.coordinates]:h.coordinates,h.type==="LineString",f,m);if(h.type==="MultiLineString"){let _=1/0;for(let x=0;x<h.coordinates.length;x++){const b=$l(h.coordinates[x],!0,f,m,_);if(isNaN(b))return b;if((_=Math.min(_,b))===0)return _}return _}return h.type==="Polygon"||h.type==="MultiPolygon"?function(_,x,b){let T=1/0;for(const C of _)for(const P of x){const D=Zp(C,P,b,T);if(isNaN(D))return D;if((T=Math.min(T,D))===0)return T}return T}(h.type==="Polygon"?[h.coordinates]:h.coordinates,f,m):null}(r,n,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}var ql=ys;function Na(t,e){switch(t){case"string":return An(e);case"number":return+e;case"boolean":return!!e;case"color":return mi.parse(e);case"formatted":return Vi.fromString(An(e));case"resolvedImage":return Rt.fromString(An(e))}return e}function yu(t,e,r,n){return n!==void 0&&(t=n*Math.round(t/n)),e!==void 0&&t<e&&(t=e),r!==void 0&&t>r&&(t=r),t}class Ua{constructor(e,r,n){this.type=e,this.key=r,this.scope=n}static parse(e,r){let n=r.expectedType;if(n==null&&(n=mr),e.length<2||e.length>3)return r.error("Invalid number of arguments for 'config' expression.");const a=r.parse(e[1],1);if(!(a instanceof po))return r.error("Key name of 'config' expression must be a string literal.");if(e.length>=3){const l=r.parse(e[2],2);return l instanceof po?new Ua(n,An(a.value),An(l.value)):r.error("Scope of 'config' expression must be a string literal.")}return new Ua(n,An(a.value))}evaluate(e){const r=[this.key,this.scope,e.scope].filter(Boolean).join(""),n=e.getConfig(r);if(!n)return null;const{type:a,value:l,values:h,minValue:f,maxValue:m,stepValue:_}=n,x=n.default.evaluate(e);let b=x;if(l){const T=e.scope;e.scope=(T||"").split("").slice(1).join(""),b=l.evaluate(e),e.scope=T}return a&&(b=Na(a,b)),b===void 0||f===void 0&&m===void 0&&_===void 0||(typeof b=="number"?b=yu(b,f,m,_):Array.isArray(b)&&(b=b.map(T=>typeof T=="number"?yu(T,f,m,_):T))),l!==void 0&&b!==void 0&&h&&!h.includes(b)&&(b=x,a&&(b=Na(a,b))),(a&&a!==this.type||b!==void 0&&vi(b)!==this.type)&&(b=Na(this.type.kind,b)),b}eachChild(){}outputDefined(){return!1}serialize(){const e=["config",this.key];return this.scope&&e.concat(this.key),e}}var Ks=Ua;function Js(t){if(t instanceof dr&&(t.name==="get"&&t.args.length===1||t.name==="feature-state"||t.name==="has"&&t.args.length===1||t.name==="properties"||t.name==="geometry-type"||t.name==="id"||/^filter-/.test(t.name))||t instanceof Vl||t instanceof ql)return!1;let e=!0;return t.eachChild(r=>{e&&!Js(r)&&(e=!1)}),e}function Va(t){if(t instanceof dr&&t.name==="feature-state")return!1;let e=!0;return t.eachChild(r=>{e&&!Va(r)&&(e=!1)}),e}function ja(t){if(t instanceof Ks)return!1;let e=!0;return t.eachChild(r=>{e&&!ja(r)&&(e=!1)}),e}function ji(t,e){if(t instanceof dr&&e.indexOf(t.name)>=0)return!1;let r=!0;return t.eachChild(n=>{r&&!ji(n,e)&&(r=!1)}),r}class Zo{constructor(e,r){this.type=r.type,this.name=e,this.boundExpression=r}static parse(e,r){if(e.length!==2||typeof e[1]!="string")return r.error("'var' expression requires exactly one string literal argument.");const n=e[1];return r.scope.has(n)?new Zo(n,r.scope.get(n)):r.error(`Unknown variable "${n}". Make sure "${n}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}var Qi=Zo;class xu{constructor(e,r=[],n,a=new Op,l=[],h,f){this.registry=e,this.path=r,this.key=r.map(m=>`[${m}]`).join(""),this.scope=a,this.errors=l,this.expectedType=n,this._scope=h,this.options=f}parse(e,r,n,a,l={}){return r||n?this.concat(r,n,a)._parse(e,l):this._parse(e,l)}_parse(e,r){function n(a,l,h){return h==="assert"?new mo(l,[a]):h==="coerce"?new _o(l,[a]):a}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const a=typeof e[0]=="string"?this.registry[e[0]]:void 0;if(a){let l=a.parse(e,this);if(!l)return null;if(this.expectedType){const h=this.expectedType,f=l.type;if(h.kind!=="string"&&h.kind!=="number"&&h.kind!=="boolean"&&h.kind!=="object"&&h.kind!=="array"||f.kind!=="value")if(h.kind!=="color"&&h.kind!=="formatted"&&h.kind!=="resolvedImage"||f.kind!=="value"&&f.kind!=="string"){if(this.checkSubtype(h,f))return null}else l=n(l,h,r.typeAnnotation||"coerce");else l=n(l,h,r.typeAnnotation||"assert")}if(!(l instanceof po)&&l.type.kind!=="resolvedImage"&&vu(l)){const h=new dd(this._scope,this.options);try{l=new po(l.type,l.evaluate(h))}catch(f){return this.error(f.message),null}}return l}return _o.parse(["to-array",e],this)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,r,n){const a=typeof e=="number"?this.path.concat(e):this.path,l=n?this.scope.concat(n):this.scope;return new xu(this.registry,a,r||null,l,this.errors,this._scope,this.options)}error(e,...r){const n=`${this.key}${r.map(a=>`[${a}]`).join("")}`;this.errors.push(new ro(n,e))}checkSubtype(e,r){const n=ds(e,r);return n&&this.error(n),n}}var xd=xu;function vu(t){if(t instanceof Qi)return vu(t.boundExpression);if(t instanceof dr&&t.name==="error"||t instanceof Ra||t instanceof Vl||t instanceof ql||t instanceof Ks)return!1;const e=t instanceof _o||t instanceof mo;let r=!0;return t.eachChild(n=>{r=e?r&&vu(n):r&&n instanceof po}),!!r&&Js(t)&&ji(t,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function xs(t,e){const r=t.length-1;let n,a,l=0,h=r,f=0;for(;l<=h;)if(f=Math.floor((l+h)/2),n=t[f],a=t[f+1],n<=e){if(f===r||e<a)return f;l=f+1}else{if(!(n>e))throw new bi("Input is not a number.");h=f-1}return 0}class Wl{constructor(e,r,n){this.type=e,this.input=r,this.labels=[],this.outputs=[];for(const[a,l]of n)this.labels.push(a),this.outputs.push(l)}static parse(e,r){if(e.length-1<4)return r.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return r.error("Expected an even number of arguments.");const n=r.parse(e[1],1,dt);if(!n)return null;const a=[];let l=null;r.expectedType&&r.expectedType.kind!=="value"&&(l=r.expectedType);for(let h=1;h<e.length;h+=2){const f=h===1?-1/0:e[h],m=e[h+1],_=h,x=h+1;if(typeof f!="number")return r.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',_);if(a.length&&a[a.length-1][0]>=f)return r.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',_);const b=r.parse(m,x,l);if(!b)return null;l=l||b.type,a.push([f,b])}return new Wl(l,n,a)}evaluate(e){const r=this.labels,n=this.outputs;if(r.length===1)return n[0].evaluate(e);const a=this.input.evaluate(e);if(a<=r[0])return n[0].evaluate(e);const l=r.length;return a>=r[l-1]?n[l-1].evaluate(e):n[xs(r,a)].evaluate(e)}eachChild(e){e(this.input);for(const r of this.outputs)e(r)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){const e=["step",this.input.serialize()];for(let r=0;r<this.labels.length;r++)r>0&&e.push(this.labels[r]),e.push(this.outputs[r].serialize());return e}}var Za=Wl;const vd=.95047,Go=1.08883,bd=4/29,Qs=6/29,bu=3*Qs*Qs,wd=Qs*Qs*Qs,Gp=Math.PI/180,Zn=180/Math.PI;function Hl(t){return t>wd?Math.pow(t,1/3):t/bu+bd}function Xl(t){return t>Qs?t*t*t:bu*(t-bd)}function Yl(t){return 255*(t<=.0031308?12.92*t:1.055*Math.pow(t,1/2.4)-.055)}function Kl(t){return(t/=255)<=.04045?t/12.92:Math.pow((t+.055)/1.055,2.4)}function wu(t){const e=Kl(t.r),r=Kl(t.g),n=Kl(t.b),a=Hl((.4124564*e+.3575761*r+.1804375*n)/vd),l=Hl((.2126729*e+.7151522*r+.072175*n)/1);return{l:116*l-16,a:500*(a-l),b:200*(l-Hl((.0193339*e+.119192*r+.9503041*n)/Go)),alpha:t.a}}function Tu(t){let e=(t.l+16)/116,r=isNaN(t.a)?e:e+t.a/500,n=isNaN(t.b)?e:e-t.b/200;return e=1*Xl(e),r=vd*Xl(r),n=Go*Xl(n),new mi(Yl(3.2404542*r-1.5371385*e-.4985314*n),Yl(-.969266*r+1.8760108*e+.041556*n),Yl(.0556434*r-.2040259*e+1.0572252*n),t.alpha)}function Td(t,e,r){const n=e-t;return t+r*(n>180||n<-180?n-360*Math.round(n/360):n)}const ea={forward:wu,reverse:Tu,interpolate:function(t,e,r){return{l:ur(t.l,e.l,r),a:ur(t.a,e.a,r),b:ur(t.b,e.b,r),alpha:ur(t.alpha,e.alpha,r)}}},ta={forward:function(t){const{l:e,a:r,b:n}=wu(t),a=Math.atan2(n,r)*Zn;return{h:a<0?a+360:a,c:Math.sqrt(r*r+n*n),l:e,alpha:t.a}},reverse:function(t){const e=t.h*Gp,r=t.c;return Tu({l:t.l,a:Math.cos(e)*r,b:Math.sin(e)*r,alpha:t.alpha})},interpolate:function(t,e,r){return{h:Td(t.h,e.h,r),c:ur(t.c,e.c,r),l:ur(t.l,e.l,r),alpha:ur(t.alpha,e.alpha,r)}}};var Eu=Object.freeze({__proto__:null,hcl:ta,lab:ea});class Ga{constructor(e,r,n,a,l){this.type=e,this.operator=r,this.interpolation=n,this.input=a,this.labels=[],this.outputs=[];for(const[h,f]of l)this.labels.push(h),this.outputs.push(f)}static interpolationFactor(e,r,n,a){let l=0;if(e.name==="exponential")l=ra(r,e.base,n,a);else if(e.name==="linear")l=ra(r,1,n,a);else if(e.name==="cubic-bezier"){const h=e.controlPoints;l=new lr(h[0],h[1],h[2],h[3]).solve(ra(r,1,n,a))}return l}static parse(e,r){let[n,a,l,...h]=e;if(!Array.isArray(a)||a.length===0)return r.error("Expected an interpolation type expression.",1);if(a[0]==="linear")a={name:"linear"};else if(a[0]==="exponential"){const _=a[1];if(typeof _!="number")return r.error("Exponential interpolation requires a numeric base.",1,1);a={name:"exponential",base:_}}else{if(a[0]!=="cubic-bezier")return r.error(`Unknown interpolation type ${String(a[0])}`,1,0);{const _=a.slice(1);if(_.length!==4||_.some(x=>typeof x!="number"||x<0||x>1))return r.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);a={name:"cubic-bezier",controlPoints:_}}}if(e.length-1<4)return r.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return r.error("Expected an even number of arguments.");if(l=r.parse(l,2,dt),!l)return null;const f=[];let m=null;n==="interpolate-hcl"||n==="interpolate-lab"?m=Cn:r.expectedType&&r.expectedType.kind!=="value"&&(m=r.expectedType);for(let _=0;_<h.length;_+=2){const x=h[_],b=h[_+1],T=_+3,C=_+4;if(typeof x!="number")return r.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',T);if(f.length&&f[f.length-1][0]>=x)return r.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',T);const P=r.parse(b,C,m);if(!P)return null;m=m||P.type,f.push([x,P])}return m.kind==="number"||m.kind==="color"||m.kind==="array"&&m.itemType.kind==="number"&&typeof m.N=="number"?new Ga(m,n,a,l,f):r.error(`Type ${di(m)} is not interpolatable.`)}evaluate(e){const r=this.labels,n=this.outputs;if(r.length===1)return n[0].evaluate(e);const a=this.input.evaluate(e);if(a<=r[0])return n[0].evaluate(e);const l=r.length;if(a>=r[l-1])return n[l-1].evaluate(e);const h=xs(r,a),f=Ga.interpolationFactor(this.interpolation,a,r[h],r[h+1]),m=n[h].evaluate(e),_=n[h+1].evaluate(e);return this.operator==="interpolate"?Bl[this.type.kind.toLowerCase()](m,_,f):this.operator==="interpolate-hcl"?ta.reverse(ta.interpolate(ta.forward(m),ta.forward(_),f)):ea.reverse(ea.interpolate(ea.forward(m),ea.forward(_),f))}eachChild(e){e(this.input);for(const r of this.outputs)e(r)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e;e=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const r=[this.operator,e,this.input.serialize()];for(let n=0;n<this.labels.length;n++)r.push(this.labels[n],this.outputs[n].serialize());return r}}function ra(t,e,r,n){const a=n-r,l=t-r;return a===0?0:e===1?l/a:(Math.pow(e,l)-1)/(Math.pow(e,a)-1)}var xn=Ga;class ia{constructor(e,r){this.type=e,this.args=r}static parse(e,r){if(e.length<2)return r.error("Expectected at least one argument.");let n=null;const a=r.expectedType;a&&a.kind!=="value"&&(n=a);const l=[];for(const f of e.slice(1)){const m=r.parse(f,1+l.length,n,void 0,{typeAnnotation:"omit"});if(!m)return null;n=n||m.type,l.push(m)}const h=a&&l.some(f=>ds(a,f.type));return new ia(h?mr:n,l)}evaluate(e){let r,n=null,a=0;for(const l of this.args){if(a++,n=l.evaluate(e),n&&n instanceof Rt&&!n.available&&(r||(r=n),n=null,a===this.args.length))return r;if(n!==null)break}return n}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=["coalesce"];return this.eachChild(r=>{e.push(r.serialize())}),e}}var Mu=ia;class Jl{constructor(e,r){this.type=r.type,this.bindings=[].concat(e),this.result=r}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const r of this.bindings)e(r[1]);e(this.result)}static parse(e,r){if(e.length<4)return r.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const n=[];for(let l=1;l<e.length-1;l+=2){const h=e[l];if(typeof h!="string")return r.error(`Expected string, but found ${typeof h} instead.`,l);if(/[^a-zA-Z0-9_]/.test(h))return r.error("Variable names must contain only alphanumeric characters or '_'.",l);const f=r.parse(e[l+1],l+1);if(!f)return null;n.push([h,f])}const a=r.parse(e[e.length-1],e.length-1,r.expectedType,n);return a?new Jl(n,a):null}outputDefined(){return this.result.outputDefined()}serialize(){const e=["let"];for(const[r,n]of this.bindings)e.push(r,n.serialize());return e.push(this.result.serialize()),e}}var Iu=Jl;class $o{constructor(e,r,n){this.type=e,this.index=r,this.input=n}static parse(e,r){if(e.length!==3)return r.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const n=r.parse(e[1],1,dt),a=r.parse(e[2],2,sn(r.expectedType||mr));return n&&a?new $o(a.type.itemType,n,a):null}evaluate(e){const r=this.index.evaluate(e),n=this.input.evaluate(e);if(r<0)throw new bi(`Array index out of bounds: ${r} < 0.`);if(r>=n.length)throw new bi(`Array index out of bounds: ${r} > ${n.length-1}.`);if(r!==Math.floor(r))throw new bi(`Array index must be an integer, but found ${r} instead.`);return n[r]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}var _r=$o;class Cu{constructor(e,r){this.type=Cr,this.needle=e,this.haystack=r}static parse(e,r){if(e.length!==3)return r.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const n=r.parse(e[1],1,mr),a=r.parse(e[2],2,mr);return n&&a?jt(n.type,[Cr,Ir,dt,js,mr])?new Cu(n,a):r.error(`Expected first argument to be of type boolean, string, number or null, but found ${di(n.type)} instead`):null}evaluate(e){const r=this.needle.evaluate(e),n=this.haystack.evaluate(e);if(n==null)return!1;if(!ko(r,["boolean","string","number","null"]))throw new bi(`Expected first argument to be of type boolean, string, number or null, but found ${di(vi(r))} instead.`);if(!ko(n,["string","array"]))throw new bi(`Expected second argument to be of type array or string, but found ${di(vi(n))} instead.`);return n.indexOf(r)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}var $p=Cu;class Ql{constructor(e,r,n){this.type=dt,this.needle=e,this.haystack=r,this.fromIndex=n}static parse(e,r){if(e.length<=2||e.length>=5)return r.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const n=r.parse(e[1],1,mr),a=r.parse(e[2],2,mr);if(!n||!a)return null;if(!jt(n.type,[Cr,Ir,dt,js,mr]))return r.error(`Expected first argument to be of type boolean, string, number or null, but found ${di(n.type)} instead`);if(e.length===4){const l=r.parse(e[3],3,dt);return l?new Ql(n,a,l):null}return new Ql(n,a)}evaluate(e){const r=this.needle.evaluate(e),n=this.haystack.evaluate(e);if(!ko(r,["boolean","string","number","null"]))throw new bi(`Expected first argument to be of type boolean, string, number or null, but found ${di(vi(r))} instead.`);if(!ko(n,["string","array"]))throw new bi(`Expected second argument to be of type array or string, but found ${di(vi(n))} instead.`);if(this.fromIndex){const a=this.fromIndex.evaluate(e);return n.indexOf(r,a)}return n.indexOf(r)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}var Ed=Ql;class Au{constructor(e,r,n,a,l,h){this.inputType=e,this.type=r,this.input=n,this.cases=a,this.outputs=l,this.otherwise=h}static parse(e,r){if(e.length<5)return r.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return r.error("Expected an even number of arguments.");let n,a;r.expectedType&&r.expectedType.kind!=="value"&&(a=r.expectedType);const l={},h=[];for(let _=2;_<e.length-1;_+=2){let x=e[_];const b=e[_+1];Array.isArray(x)||(x=[x]);const T=r.concat(_);if(x.length===0)return T.error("Expected at least one branch label.");for(const P of x){if(typeof P!="number"&&typeof P!="string")return T.error("Branch labels must be numbers or strings.");if(typeof P=="number"&&Math.abs(P)>Number.MAX_SAFE_INTEGER)return T.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof P=="number"&&Math.floor(P)!==P)return T.error("Numeric branch labels must be integer values.");if(n){if(T.checkSubtype(n,vi(P)))return null}else n=vi(P);if(l[String(P)]!==void 0)return T.error("Branch labels must be unique.");l[String(P)]=h.length}const C=r.parse(b,_,a);if(!C)return null;a=a||C.type,h.push(C)}const f=r.parse(e[1],1,mr);if(!f)return null;const m=r.parse(e[e.length-1],e.length-1,a);return m?f.type.kind!=="value"&&r.concat(1).checkSubtype(n,f.type)?null:new Au(n,a,f,l,h,m):null}evaluate(e){const r=this.input.evaluate(e);return(vi(r)===this.inputType&&this.outputs[this.cases[r]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["match",this.input.serialize()],r=Object.keys(this.cases).sort(),n=[],a={};for(const h of r){const f=a[this.cases[h]];f===void 0?(a[this.cases[h]]=n.length,n.push([this.cases[h],[h]])):n[f][1].push(h)}const l=h=>this.inputType.kind==="number"?Number(h):h;for(const[h,f]of n)e.push(f.length===1?l(f[0]):f.map(l)),e.push(this.outputs[h].serialize());return e.push(this.otherwise.serialize()),e}}var Md=Au;class ec{constructor(e,r,n){this.type=e,this.branches=r,this.otherwise=n}static parse(e,r){if(e.length<4)return r.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return r.error("Expected an odd number of arguments.");let n;r.expectedType&&r.expectedType.kind!=="value"&&(n=r.expectedType);const a=[];for(let h=1;h<e.length-1;h+=2){const f=r.parse(e[h],h,Cr);if(!f)return null;const m=r.parse(e[h+1],h+1,n);if(!m)return null;a.push([f,m]),n=n||m.type}const l=r.parse(e[e.length-1],e.length-1,n);return l?new ec(n,a,l):null}evaluate(e){for(const[r,n]of this.branches)if(r.evaluate(e))return n.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[r,n]of this.branches)e(r),e(n);e(this.otherwise)}outputDefined(){return this.branches.every(([e,r])=>r.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["case"];return this.eachChild(r=>{e.push(r.serialize())}),e}}var Id=ec;class $a{constructor(e,r,n,a){this.type=e,this.input=r,this.beginIndex=n,this.endIndex=a}static parse(e,r){if(e.length<=2||e.length>=5)return r.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const n=r.parse(e[1],1,mr),a=r.parse(e[2],2,dt);if(!n||!a)return null;if(!jt(n.type,[sn(mr),Ir,mr]))return r.error(`Expected first argument to be of type array or string, but found ${di(n.type)} instead`);if(e.length===4){const l=r.parse(e[3],3,dt);return l?new $a(n.type,n,a,l):null}return new $a(n.type,n,a)}evaluate(e){const r=this.input.evaluate(e),n=this.beginIndex.evaluate(e);if(!ko(r,["string","array"]))throw new bi(`Expected first argument to be of type array or string, but found ${di(vi(r))} instead.`);if(this.endIndex){const a=this.endIndex.evaluate(e);return r.slice(n,a)}return r.slice(n)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}var na=$a;function Su(t,e){return t==="=="||t==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function Pu(t,e,r,n){return n.compare(e,r)===0}function oa(t,e,r){const n=t!=="=="&&t!=="!=";return class Hv{constructor(l,h,f){this.type=Cr,this.lhs=l,this.rhs=h,this.collator=f,this.hasUntypedArgument=l.type.kind==="value"||h.type.kind==="value"}static parse(l,h){if(l.length!==3&&l.length!==4)return h.error("Expected two or three arguments.");const f=l[0];let m=h.parse(l[1],1,mr);if(!m)return null;if(!Su(f,m.type))return h.concat(1).error(`"${f}" comparisons are not supported for type '${di(m.type)}'.`);let _=h.parse(l[2],2,mr);if(!_)return null;if(!Su(f,_.type))return h.concat(2).error(`"${f}" comparisons are not supported for type '${di(_.type)}'.`);if(m.type.kind!==_.type.kind&&m.type.kind!=="value"&&_.type.kind!=="value")return h.error(`Cannot compare types '${di(m.type)}' and '${di(_.type)}'.`);n&&(m.type.kind==="value"&&_.type.kind!=="value"?m=new mo(_.type,[m]):m.type.kind!=="value"&&_.type.kind==="value"&&(_=new mo(m.type,[_])));let x=null;if(l.length===4){if(m.type.kind!=="string"&&_.type.kind!=="string"&&m.type.kind!=="value"&&_.type.kind!=="value")return h.error("Cannot use collator to compare non-string types.");if(x=h.parse(l[3],3,Fl),!x)return null}return new Hv(m,_,x)}evaluate(l){const h=this.lhs.evaluate(l),f=this.rhs.evaluate(l);if(n&&this.hasUntypedArgument){const m=vi(h),_=vi(f);if(m.kind!==_.kind||m.kind!=="string"&&m.kind!=="number")throw new bi(`Expected arguments for "${t}" to be (string, string) or (number, number), but found (${m.kind}, ${_.kind}) instead.`)}if(this.collator&&!n&&this.hasUntypedArgument){const m=vi(h),_=vi(f);if(m.kind!=="string"||_.kind!=="string")return e(l,h,f)}return this.collator?r(l,h,f,this.collator.evaluate(l)):e(l,h,f)}eachChild(l){l(this.lhs),l(this.rhs),this.collator&&l(this.collator)}outputDefined(){return!0}serialize(){const l=[t];return this.eachChild(h=>{l.push(h.serialize())}),l}}}const Lu=oa("==",function(t,e,r){return e===r},Pu),Du=oa("!=",function(t,e,r){return e!==r},function(t,e,r,n){return!Pu(0,e,r,n)}),qp=oa("<",function(t,e,r){return e<r},function(t,e,r,n){return n.compare(e,r)<0}),Wp=oa(">",function(t,e,r){return e>r},function(t,e,r,n){return n.compare(e,r)>0}),Cd=oa("<=",function(t,e,r){return e<=r},function(t,e,r,n){return n.compare(e,r)<=0}),Hp=oa(">=",function(t,e,r){return e>=r},function(t,e,r,n){return n.compare(e,r)>=0});class zu{constructor(e,r,n,a,l,h){this.type=Ir,this.number=e,this.locale=r,this.currency=n,this.unit=a,this.minFractionDigits=l,this.maxFractionDigits=h}static parse(e,r){if(e.length!==3)return r.error("Expected two arguments.");const n=r.parse(e[1],1,dt);if(!n)return null;const a=e[2];if(typeof a!="object"||Array.isArray(a))return r.error("NumberFormat options argument must be an object.");let l=null;if(a.locale&&(l=r.parse(a.locale,1,Ir),!l))return null;let h=null;if(a.currency&&(h=r.parse(a.currency,1,Ir),!h))return null;let f=null;if(a.unit&&(f=r.parse(a.unit,1,Ir),!f))return null;let m=null;if(a["min-fraction-digits"]&&(m=r.parse(a["min-fraction-digits"],1,dt),!m))return null;let _=null;return a["max-fraction-digits"]&&(_=r.parse(a["max-fraction-digits"],1,dt),!_)?null:new zu(n,l,h,f,m,_)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class Ru{constructor(e){this.type=dt,this.input=e}static parse(e,r){if(e.length!==2)return r.error(`Expected 1 argument, but found ${e.length-1} instead.`);const n=r.parse(e[1],1);return n?n.type.kind!=="array"&&n.type.kind!=="string"&&n.type.kind!=="value"?r.error(`Expected argument of type string or array, but found ${di(n.type)} instead.`):new Ru(n):null}evaluate(e){const r=this.input.evaluate(e);if(typeof r=="string"||Array.isArray(r))return r.length;throw new bi(`Expected value to be of type string or array, but found ${di(vi(r))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){const e=["length"];return this.eachChild(r=>{e.push(r.serialize())}),e}}function Ad(t){return function(){t=1831565813+(t|=0)|0;let e=Math.imul(t^t>>>15,1|t);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}const Ou={"==":Lu,"!=":Du,">":Wp,"<":qp,">=":Hp,"<=":Cd,array:mo,at:_r,boolean:mo,case:Id,coalesce:Mu,collator:Ra,format:qs,image:ps,in:$p,"index-of":Ed,interpolate:xn,"interpolate-hcl":xn,"interpolate-lab":xn,length:Ru,let:Iu,literal:po,match:Md,number:mo,"number-format":zu,object:mo,slice:na,step:Za,string:mo,"to-boolean":_o,"to-color":_o,"to-number":_o,"to-string":_o,var:Qi,within:Vl,distance:ql,config:Ks};function ku(t,[e,r,n,a]){e=e.evaluate(t),r=r.evaluate(t),n=n.evaluate(t);const l=a?a.evaluate(t):1,h=hd(e,r,n,l);if(h)throw new bi(h);return new mi(e/255*l,r/255*l,n/255*l,l)}function Sd(t,[e,r,n,a]){e=e.evaluate(t),r=r.evaluate(t),n=n.evaluate(t);const l=a?a.evaluate(t):1,h=function(_,x,b,T){return typeof _=="number"&&_>=0&&_<=360?typeof x=="number"&&x>=0&&x<=100&&typeof b=="number"&&b>=0&&b<=100?T===void 0||typeof T=="number"&&T>=0&&T<=1?null:`Invalid hsla value [${[_,x,b,T].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof T=="number"?[_,x,b,T]:[_,x,b]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof T=="number"?[_,x,b,T]:[_,x,b]).join(", ")}]: 'h' must be between 0 and 360.`}(e,r,n,l);if(h)throw new bi(h);const f=`hsla(${e}, ${r}%, ${n}%, ${l})`,m=mi.parse(f);if(!m)throw new bi(`Failed to parse HSLA color: ${f}`);return m}function Bu(t,e){return t in e}function Fu(t,e){const r=e[t];return r===void 0?null:r}function vs(t){return{type:t}}dr.register(Ou,{error:[{kind:"error"},[Ir],(t,[e])=>{throw new bi(e.evaluate(t))}],typeof:[Ir,[mr],(t,[e])=>di(vi(e.evaluate(t)))],"to-rgba":[sn(dt,4),[Cn],(t,[e])=>e.evaluate(t).toArray()],rgb:[Cn,[dt,dt,dt],ku],rgba:[Cn,[dt,dt,dt,dt],ku],hsl:[Cn,[dt,dt,dt],Sd],hsla:[Cn,[dt,dt,dt,dt],Sd],has:{type:Cr,overloads:[[[Ir],(t,[e])=>Bu(e.evaluate(t),t.properties())],[[Ir,Zs],(t,[e,r])=>Bu(e.evaluate(t),r.evaluate(t))]]},get:{type:mr,overloads:[[[Ir],(t,[e])=>Fu(e.evaluate(t),t.properties())],[[Ir,Zs],(t,[e,r])=>Fu(e.evaluate(t),r.evaluate(t))]]},"feature-state":[mr,[Ir],(t,[e])=>Fu(e.evaluate(t),t.featureState||{})],properties:[Zs,[],t=>t.properties()],"geometry-type":[Ir,[],t=>t.geometryType()],id:[mr,[],t=>t.id()],zoom:[dt,[],t=>t.globals.zoom],pitch:[dt,[],t=>t.globals.pitch||0],"distance-from-center":[dt,[],t=>t.distanceFromCenter()],"measure-light":[dt,[Ir],(t,[e])=>t.measureLight(e.evaluate(t))],"heatmap-density":[dt,[],t=>t.globals.heatmapDensity||0],"line-progress":[dt,[],t=>t.globals.lineProgress||0],"raster-value":[dt,[],t=>t.globals.rasterValue||0],"raster-particle-speed":[dt,[],t=>t.globals.rasterParticleSpeed||0],"sky-radial-progress":[dt,[],t=>t.globals.skyRadialProgress||0],accumulated:[mr,[],t=>t.globals.accumulated===void 0?null:t.globals.accumulated],"+":[dt,vs(dt),(t,e)=>{let r=0;for(const n of e)r+=n.evaluate(t);return r}],"*":[dt,vs(dt),(t,e)=>{let r=1;for(const n of e)r*=n.evaluate(t);return r}],"-":{type:dt,overloads:[[[dt,dt],(t,[e,r])=>e.evaluate(t)-r.evaluate(t)],[[dt],(t,[e])=>-e.evaluate(t)]]},"/":[dt,[dt,dt],(t,[e,r])=>e.evaluate(t)/r.evaluate(t)],"%":[dt,[dt,dt],(t,[e,r])=>e.evaluate(t)%r.evaluate(t)],ln2:[dt,[],()=>Math.LN2],pi:[dt,[],()=>Math.PI],e:[dt,[],()=>Math.E],"^":[dt,[dt,dt],(t,[e,r])=>Math.pow(e.evaluate(t),r.evaluate(t))],sqrt:[dt,[dt],(t,[e])=>Math.sqrt(e.evaluate(t))],log10:[dt,[dt],(t,[e])=>Math.log(e.evaluate(t))/Math.LN10],ln:[dt,[dt],(t,[e])=>Math.log(e.evaluate(t))],log2:[dt,[dt],(t,[e])=>Math.log(e.evaluate(t))/Math.LN2],sin:[dt,[dt],(t,[e])=>Math.sin(e.evaluate(t))],cos:[dt,[dt],(t,[e])=>Math.cos(e.evaluate(t))],tan:[dt,[dt],(t,[e])=>Math.tan(e.evaluate(t))],asin:[dt,[dt],(t,[e])=>Math.asin(e.evaluate(t))],acos:[dt,[dt],(t,[e])=>Math.acos(e.evaluate(t))],atan:[dt,[dt],(t,[e])=>Math.atan(e.evaluate(t))],min:[dt,vs(dt),(t,e)=>Math.min(...e.map(r=>r.evaluate(t)))],max:[dt,vs(dt),(t,e)=>Math.max(...e.map(r=>r.evaluate(t)))],abs:[dt,[dt],(t,[e])=>Math.abs(e.evaluate(t))],round:[dt,[dt],(t,[e])=>{const r=e.evaluate(t);return r<0?-Math.round(-r):Math.round(r)}],floor:[dt,[dt],(t,[e])=>Math.floor(e.evaluate(t))],ceil:[dt,[dt],(t,[e])=>Math.ceil(e.evaluate(t))],"filter-==":[Cr,[Ir,mr],(t,[e,r])=>t.properties()[e.value]===r.value],"filter-id-==":[Cr,[mr],(t,[e])=>t.id()===e.value],"filter-type-==":[Cr,[Ir],(t,[e])=>t.geometryType()===e.value],"filter-<":[Cr,[Ir,mr],(t,[e,r])=>{const n=t.properties()[e.value],a=r.value;return typeof n==typeof a&&n<a}],"filter-id-<":[Cr,[mr],(t,[e])=>{const r=t.id(),n=e.value;return typeof r==typeof n&&r<n}],"filter->":[Cr,[Ir,mr],(t,[e,r])=>{const n=t.properties()[e.value],a=r.value;return typeof n==typeof a&&n>a}],"filter-id->":[Cr,[mr],(t,[e])=>{const r=t.id(),n=e.value;return typeof r==typeof n&&r>n}],"filter-<=":[Cr,[Ir,mr],(t,[e,r])=>{const n=t.properties()[e.value],a=r.value;return typeof n==typeof a&&n<=a}],"filter-id-<=":[Cr,[mr],(t,[e])=>{const r=t.id(),n=e.value;return typeof r==typeof n&&r<=n}],"filter->=":[Cr,[Ir,mr],(t,[e,r])=>{const n=t.properties()[e.value],a=r.value;return typeof n==typeof a&&n>=a}],"filter-id->=":[Cr,[mr],(t,[e])=>{const r=t.id(),n=e.value;return typeof r==typeof n&&r>=n}],"filter-has":[Cr,[mr],(t,[e])=>e.value in t.properties()],"filter-has-id":[Cr,[],t=>t.id()!==null&&t.id()!==void 0],"filter-type-in":[Cr,[sn(Ir)],(t,[e])=>e.value.indexOf(t.geometryType())>=0],"filter-id-in":[Cr,[sn(mr)],(t,[e])=>e.value.indexOf(t.id())>=0],"filter-in-small":[Cr,[Ir,sn(mr)],(t,[e,r])=>r.value.indexOf(t.properties()[e.value])>=0],"filter-in-large":[Cr,[Ir,sn(mr)],(t,[e,r])=>function(n,a,l,h){for(;l<=h;){const f=l+h>>1;if(a[f]===n)return!0;a[f]>n?h=f-1:l=f+1}return!1}(t.properties()[e.value],r.value,0,r.value.length-1)],all:{type:Cr,overloads:[[[Cr,Cr],(t,[e,r])=>e.evaluate(t)&&r.evaluate(t)],[vs(Cr),(t,e)=>{for(const r of e)if(!r.evaluate(t))return!1;return!0}]]},any:{type:Cr,overloads:[[[Cr,Cr],(t,[e,r])=>e.evaluate(t)||r.evaluate(t)],[vs(Cr),(t,e)=>{for(const r of e)if(r.evaluate(t))return!0;return!1}]]},"!":[Cr,[Cr],(t,[e])=>!e.evaluate(t)],"is-supported-script":[Cr,[Ir],(t,[e])=>{const r=t.globals&&t.globals.isSupportedScript;return!r||r(e.evaluate(t))}],upcase:[Ir,[Ir],(t,[e])=>e.evaluate(t).toUpperCase()],downcase:[Ir,[Ir],(t,[e])=>e.evaluate(t).toLowerCase()],concat:[Ir,vs(mr),(t,e)=>e.map(r=>An(r.evaluate(t))).join("")],"resolved-locale":[Ir,[Fl],(t,[e])=>e.evaluate(t).resolvedLocale()],random:[dt,[dt,dt,mr],(t,e)=>{const[r,n,a]=e.map(h=>h.evaluate(t));if(r>n||r===n)return r;let l;if(typeof a=="string")l=function(h){let f=0;if(h.length===0)return f;for(let m=0;m<h.length;m++)f=(f<<5)-f+h.charCodeAt(m),f|=0;return f}(a);else{if(typeof a!="number")throw new bi(`Invalid seed input: ${a}`);l=a}return r+Ad(l)()*(n-r)}]});var sa=Ou;function Nu(t){return{result:"success",value:t}}function bs(t){return{result:"error",value:t}}function Pd(t,e){return!!t&&!!t.parameters&&t.parameters.indexOf(e)>-1}function tc(t){return t["property-type"]==="data-driven"}function Uu(t){return Pd(t.expression,"measure-light")}function Ld(t){return Pd(t.expression,"zoom")}function Vu(t){return!!t.expression&&t.expression.interpolated}function rc(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}function Dd(t){return t}function ju(t,e){const r=e.type==="color",n=t.stops&&typeof t.stops[0][0]=="object",a=n||!(n||t.property!==void 0),l=t.type||(Vu(e)?"exponential":"interval");if(r&&((t=Yc({},t)).stops&&(t.stops=t.stops.map(_=>[_[0],mi.parse(_[1])])),t.default=mi.parse(t.default?t.default:e.default)),t.colorSpace&&t.colorSpace!=="rgb"&&!Eu[t.colorSpace])throw new Error(`Unknown color space: ${t.colorSpace}`);let h,f,m;if(l==="exponential")h=zd;else if(l==="interval")h=Yp;else if(l==="categorical"){h=Xp,f=Object.create(null);for(const _ of t.stops)f[_[0]]=_[1];m=typeof t.stops[0][0]}else{if(l!=="identity")throw new Error(`Unknown function type "${l}"`);h=Rd}if(n){const _={},x=[];for(let C=0;C<t.stops.length;C++){const P=t.stops[C],D=P[0].zoom;_[D]===void 0&&(_[D]={zoom:D,type:t.type,property:t.property,default:t.default,stops:[]},x.push(D)),_[D].stops.push([P[0].value,P[1]])}const b=[];for(const C of x)b.push([_[C].zoom,ju(_[C],e)]);const T={name:"linear"};return{kind:"composite",interpolationType:T,interpolationFactor:xn.interpolationFactor.bind(void 0,T),zoomStops:b.map(C=>C[0]),evaluate:({zoom:C},P)=>zd({stops:b,base:t.base},e,C).evaluate(C,P)}}if(a){const _=l==="exponential"?{name:"exponential",base:t.base!==void 0?t.base:1}:null;return{kind:"camera",interpolationType:_,interpolationFactor:xn.interpolationFactor.bind(void 0,_),zoomStops:t.stops.map(x=>x[0]),evaluate:({zoom:x})=>h(t,e,x,f,m)}}return{kind:"source",evaluate(_,x){const b=x&&x.properties?x.properties[t.property]:void 0;return b===void 0?qa(t.default,e.default):h(t,e,b,f,m)}}}function qa(t,e,r){return t!==void 0?t:e!==void 0?e:r!==void 0?r:void 0}function Xp(t,e,r,n,a){return qa(typeof r===a?n[r]:void 0,t.default,e.default)}function Yp(t,e,r){if(Ws(r)!=="number")return qa(t.default,e.default);const n=t.stops.length;if(n===1||r<=t.stops[0][0])return t.stops[0][1];if(r>=t.stops[n-1][0])return t.stops[n-1][1];const a=xs(t.stops.map(l=>l[0]),r);return t.stops[a][1]}function zd(t,e,r){const n=t.base!==void 0?t.base:1;if(Ws(r)!=="number")return qa(t.default,e.default);const a=t.stops.length;if(a===1||r<=t.stops[0][0])return t.stops[0][1];if(r>=t.stops[a-1][0])return t.stops[a-1][1];const l=xs(t.stops.map(x=>x[0]),r),h=function(x,b,T,C){const P=C-T,D=x-T;return P===0?0:b===1?D/P:(Math.pow(b,D)-1)/(Math.pow(b,P)-1)}(r,n,t.stops[l][0],t.stops[l+1][0]),f=t.stops[l][1],m=t.stops[l+1][1];let _=Bl[e.type]||Dd;if(t.colorSpace&&t.colorSpace!=="rgb"){const x=Eu[t.colorSpace];_=(b,T)=>x.reverse(x.interpolate(x.forward(b),x.forward(T),h))}return typeof f.evaluate=="function"?{evaluate(...x){const b=f.evaluate.apply(void 0,x),T=m.evaluate.apply(void 0,x);if(b!==void 0&&T!==void 0)return _(b,T,h)}}:_(f,m,h)}function Rd(t,e,r){return e.type==="color"?r=mi.parse(r):e.type==="formatted"?r=Vi.fromString(r.toString()):e.type==="resolvedImage"?r=Rt.fromString(r.toString()):Ws(r)===e.type||e.type==="enum"&&e.values[r]||(r=void 0),qa(r,t.default,e.default)}class ic{constructor(e,r,n,a){this.expression=e,this._warningHistory={},this._evaluator=new dd(n,a),this._defaultValue=r?function(l){return l.type==="color"&&(rc(l.default)||Array.isArray(l.default))?new mi(0,0,0,0):l.type==="color"?mi.parse(l.default)||null:l.default===void 0?null:l.default}(r):null,this._enumValues=r&&r.type==="enum"?r.values:null}evaluateWithoutErrorHandling(e,r,n,a,l,h,f,m){return this._evaluator.globals=e,this._evaluator.feature=r,this._evaluator.featureState=n,this._evaluator.canonical=a||null,this._evaluator.availableImages=l||null,this._evaluator.formattedSection=h,this._evaluator.featureTileCoord=f||null,this._evaluator.featureDistanceData=m||null,this.expression.evaluate(this._evaluator)}evaluate(e,r,n,a,l,h,f,m){this._evaluator.globals=e,this._evaluator.feature=r||null,this._evaluator.featureState=n||null,this._evaluator.canonical=a||null,this._evaluator.availableImages=l||null,this._evaluator.formattedSection=h||null,this._evaluator.featureTileCoord=f||null,this._evaluator.featureDistanceData=m||null;try{const _=this.expression.evaluate(this._evaluator);if(_==null||typeof _=="number"&&_!=_)return this._defaultValue;if(this._enumValues&&!(_ in this._enumValues))throw new bi(`Expected value to be one of ${Object.keys(this._enumValues).map(x=>JSON.stringify(x)).join(", ")}, but found ${JSON.stringify(_)} instead.`);return _}catch(_){return this._warningHistory[_.message]||(this._warningHistory[_.message]=!0,typeof console<"u"&&console.warn(_.message)),this._defaultValue}}}function Wa(t){return Array.isArray(t)&&t.length>0&&typeof t[0]=="string"&&t[0]in sa}function nc(t,e,r,n){const a=new xd(sa,[],e?function(h){const f={color:Cn,string:Ir,number:dt,enum:Ir,boolean:Cr,formatted:Gs,resolvedImage:Da};return h.type==="array"?sn(f[h.value]||mr,h.length):f[h.type]}(e):void 0,void 0,void 0,r,n),l=a.parse(t,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return l?Nu(new ic(l,e,r,n)):bs(a.errors)}class Zu{constructor(e,r,n){this.kind=e,this._styleExpression=r,this.isLightConstant=n,this.isStateDependent=e!=="constant"&&!Va(r.expression),this.isConfigDependent=!ja(r.expression)}evaluateWithoutErrorHandling(e,r,n,a,l,h){return this._styleExpression.evaluateWithoutErrorHandling(e,r,n,a,l,h)}evaluate(e,r,n,a,l,h){return this._styleExpression.evaluate(e,r,n,a,l,h)}}class Ha{constructor(e,r,n,a,l){this.kind=e,this.zoomStops=n,this._styleExpression=r,this.isStateDependent=e!=="camera"&&!Va(r.expression),this.isLightConstant=l,this.isConfigDependent=!ja(r.expression),this.interpolationType=a}evaluateWithoutErrorHandling(e,r,n,a,l,h){return this._styleExpression.evaluateWithoutErrorHandling(e,r,n,a,l,h)}evaluate(e,r,n,a,l,h){return this._styleExpression.evaluate(e,r,n,a,l,h)}interpolationFactor(e,r,n){return this.interpolationType?xn.interpolationFactor(this.interpolationType,e,r,n):0}}function oc(t,e,r,n){if((t=nc(t,e,r,n)).result==="error")return t;const a=t.value.expression,l=Js(a);if(!l&&!tc(e))return bs([new ro("","data expressions not supported")]);const h=ji(a,["zoom","pitch","distance-from-center"]);if(!h&&!Ld(e))return bs([new ro("","zoom expressions not supported")]);const f=ji(a,["measure-light"]);if(!f&&!Uu(e))return bs([new ro("","measure-light expression not supported")]);const m=e.expression&&e.expression.relaxZoomRestriction,_=Ya(a);return _||h||m?_ instanceof ro?bs([_]):_ instanceof xn&&!Vu(e)?bs([new ro("",'"interpolate" expressions cannot be used with this property')]):Nu(_?new Ha(l?"camera":"composite",t.value,_.labels,_ instanceof xn?_.interpolation:void 0,f):new Zu(l?"constant":"source",t.value,f)):bs([new ro("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class Xa{constructor(e,r){this._parameters=e,this._specification=r,Yc(this,ju(this._parameters,this._specification))}static deserialize(e){return new Xa(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function Ya(t){let e=null;if(t instanceof Iu)e=Ya(t.result);else if(t instanceof Mu){for(const r of t.args)if(e=Ya(r),e)break}else(t instanceof Za||t instanceof xn)&&t.input instanceof dr&&t.input.name==="zoom"&&(e=t);return e instanceof ro||t.eachChild(r=>{const n=Ya(r);n instanceof ro?e=n:e&&n&&e!==n&&(e=new ro("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}var Kp=$n,Gn=3;function $n(t,e,r){var n=this.cells=[];if(t instanceof ArrayBuffer){this.arrayBuffer=t;var a=new Int32Array(this.arrayBuffer);t=a[0],this.d=(e=a[1])+2*(r=a[2]);for(var l=0;l<this.d*this.d;l++){var h=a[Gn+l],f=a[Gn+l+1];n.push(h===f?null:a.subarray(h,f))}var m=a[Gn+n.length+1];this.keys=a.subarray(a[Gn+n.length],m),this.bboxes=a.subarray(m),this.insert=this._insertReadonly}else{this.d=e+2*r;for(var _=0;_<this.d*this.d;_++)n.push([]);this.keys=[],this.bboxes=[]}this.n=e,this.extent=t,this.padding=r,this.scale=e/t,this.uid=0;var x=r/e*t;this.min=-x,this.max=t+x}$n.prototype.insert=function(t,e,r,n,a){this._forEachCell(e,r,n,a,this._insertCell,this.uid++),this.keys.push(t),this.bboxes.push(e),this.bboxes.push(r),this.bboxes.push(n),this.bboxes.push(a)},$n.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},$n.prototype._insertCell=function(t,e,r,n,a,l){this.cells[a].push(l)},$n.prototype.query=function(t,e,r,n,a){var l=this.min,h=this.max;if(t<=l&&e<=l&&h<=r&&h<=n&&!a)return Array.prototype.slice.call(this.keys);var f=[];return this._forEachCell(t,e,r,n,this._queryCell,f,{},a),f},$n.prototype._queryCell=function(t,e,r,n,a,l,h,f){var m=this.cells[a];if(m!==null)for(var _=this.keys,x=this.bboxes,b=0;b<m.length;b++){var T=m[b];if(h[T]===void 0){var C=4*T;(f?f(x[C+0],x[C+1],x[C+2],x[C+3]):t<=x[C+2]&&e<=x[C+3]&&r>=x[C+0]&&n>=x[C+1])?(h[T]=!0,l.push(_[T])):h[T]=!1}}},$n.prototype._forEachCell=function(t,e,r,n,a,l,h,f){for(var m=this._convertToCellCoord(t),_=this._convertToCellCoord(e),x=this._convertToCellCoord(r),b=this._convertToCellCoord(n),T=m;T<=x;T++)for(var C=_;C<=b;C++){var P=this.d*C+T;if((!f||f(this._convertFromCellCoord(T),this._convertFromCellCoord(C),this._convertFromCellCoord(T+1),this._convertFromCellCoord(C+1)))&&a.call(this,t,e,r,n,P,l,h,f))return}},$n.prototype._convertFromCellCoord=function(t){return(t-this.padding)/this.scale},$n.prototype._convertToCellCoord=function(t){return Math.max(0,Math.min(this.d-1,Math.floor(t*this.scale)+this.padding))},$n.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var t=this.cells,e=Gn+this.cells.length+1+1,r=0,n=0;n<this.cells.length;n++)r+=this.cells[n].length;var a=new Int32Array(e+r+this.keys.length+this.bboxes.length);a[0]=this.extent,a[1]=this.n,a[2]=this.padding;for(var l=e,h=0;h<t.length;h++){var f=t[h];a[Gn+h]=l,a.set(f,l),l+=f.length}return a[Gn+t.length]=l,a.set(this.keys,l),a[Gn+t.length+1]=l+=this.keys.length,a.set(this.bboxes,l),l+=this.bboxes.length,a.buffer};var yo=ft(Kp);const Ka={};function mt(t,e,r={}){Object.defineProperty(t,"_classRegistryKey",{value:e,writeable:!1}),Ka[e]={klass:t,omit:r.omit||[]}}mt(Object,"Object"),yo.serialize=function(t,e){const r=t.toArrayBuffer();return e&&e.add(r),{buffer:r}},yo.deserialize=function(t){return new yo(t.buffer)},Object.defineProperty(yo,"name",{value:"Grid"}),mt(yo,"Grid"),mt(mi,"Color"),mt(Error,"Error"),mt(Vi,"Formatted"),mt($s,"FormattedSection"),mt(yi,"AJAXError"),mt(Rt,"ResolvedImage"),mt(Xa,"StylePropertyFunction"),mt(ic,"StyleExpression",{omit:["_evaluator"]}),mt(Ha,"ZoomDependentExpression"),mt(Zu,"ZoomConstantExpression"),mt(dr,"CompoundExpression",{omit:["_evaluate"]});for(const t in sa)Ka[sa[t]._classRegistryKey]||mt(sa[t],`Expression${t}`);function Od(t){return t&&typeof ArrayBuffer<"u"&&(t instanceof ArrayBuffer||t.constructor&&t.constructor.name==="ArrayBuffer")}function sc(t){return self.ImageBitmap&&t instanceof ImageBitmap}function qo(t,e){if(t==null||typeof t=="boolean"||typeof t=="number"||typeof t=="string"||t instanceof Boolean||t instanceof Number||t instanceof String||t instanceof Date||t instanceof RegExp)return t;if(Od(t)||sc(t))return e&&e.add(t),t;if(ArrayBuffer.isView(t)){const r=t;return e&&e.add(r.buffer),r}if(t instanceof ImageData)return e&&e.add(t.data.buffer),t;if(Array.isArray(t)){const r=[];for(const n of t)r.push(qo(n,e));return r}if(t instanceof Map){const r={$name:"Map"};for(const[n,a]of t.entries())r[n]=qo(a);return r}if(typeof t=="object"){const r=t.constructor,n=r._classRegistryKey;if(!n)throw new Error(`can't serialize object of unregistered class ${n}`);const a=r.serialize?r.serialize(t,e):{};if(!r.serialize){for(const l in t)t.hasOwnProperty(l)&&(Ka[n].omit.indexOf(l)>=0||(a[l]=qo(t[l],e)));t instanceof Error&&(a.message=t.message)}if(a.$name)throw new Error("$name property is reserved for worker serialization logic.");return n!=="Object"&&(a.$name=n),a}throw new Error("can't serialize object of type "+typeof t)}function ws(t){if(t==null||typeof t=="boolean"||typeof t=="number"||typeof t=="string"||t instanceof Boolean||t instanceof Number||t instanceof String||t instanceof Date||t instanceof RegExp||Od(t)||sc(t)||ArrayBuffer.isView(t)||t instanceof ImageData)return t;if(Array.isArray(t))return t.map(ws);if(typeof t=="object"){const e=t.$name||"Object";if(e==="Map"){const a=new Map;for(const l of Object.keys(t))l!=="$name"&&a.set(l,ws(t[l]));return a}const{klass:r}=Ka[e];if(!r)throw new Error(`can't deserialize unregistered class ${e}`);if(r.deserialize)return r.deserialize(t);const n=Object.create(r.prototype);for(const a of Object.keys(t))a!=="$name"&&(n[a]=ws(t[a]));return n}throw new Error("can't deserialize object of type "+typeof t)}const bt={"Latin-1 Supplement":t=>t>=128&&t<=255,Arabic:t=>t>=1536&&t<=1791,"Arabic Supplement":t=>t>=1872&&t<=1919,"Arabic Extended-A":t=>t>=2208&&t<=2303,"Hangul Jamo":t=>t>=4352&&t<=4607,"Unified Canadian Aboriginal Syllabics":t=>t>=5120&&t<=5759,Khmer:t=>t>=6016&&t<=6143,"Unified Canadian Aboriginal Syllabics Extended":t=>t>=6320&&t<=6399,"General Punctuation":t=>t>=8192&&t<=8303,"Letterlike Symbols":t=>t>=8448&&t<=8527,"Number Forms":t=>t>=8528&&t<=8591,"Miscellaneous Technical":t=>t>=8960&&t<=9215,"Control Pictures":t=>t>=9216&&t<=9279,"Optical Character Recognition":t=>t>=9280&&t<=9311,"Enclosed Alphanumerics":t=>t>=9312&&t<=9471,"Geometric Shapes":t=>t>=9632&&t<=9727,"Miscellaneous Symbols":t=>t>=9728&&t<=9983,"Miscellaneous Symbols and Arrows":t=>t>=11008&&t<=11263,"CJK Radicals Supplement":t=>t>=11904&&t<=12031,"Kangxi Radicals":t=>t>=12032&&t<=12255,"Ideographic Description Characters":t=>t>=12272&&t<=12287,"CJK Symbols and Punctuation":t=>t>=12288&&t<=12351,Hiragana:t=>t>=12352&&t<=12447,Katakana:t=>t>=12448&&t<=12543,Bopomofo:t=>t>=12544&&t<=12591,"Hangul Compatibility Jamo":t=>t>=12592&&t<=12687,Kanbun:t=>t>=12688&&t<=12703,"Bopomofo Extended":t=>t>=12704&&t<=12735,"CJK Strokes":t=>t>=12736&&t<=12783,"Katakana Phonetic Extensions":t=>t>=12784&&t<=12799,"Enclosed CJK Letters and Months":t=>t>=12800&&t<=13055,"CJK Compatibility":t=>t>=13056&&t<=13311,"CJK Unified Ideographs Extension A":t=>t>=13312&&t<=19903,"Yijing Hexagram Symbols":t=>t>=19904&&t<=19967,"CJK Unified Ideographs":t=>t>=19968&&t<=40959,"Yi Syllables":t=>t>=40960&&t<=42127,"Yi Radicals":t=>t>=42128&&t<=42191,"Hangul Jamo Extended-A":t=>t>=43360&&t<=43391,"Hangul Syllables":t=>t>=44032&&t<=55215,"Hangul Jamo Extended-B":t=>t>=55216&&t<=55295,"Private Use Area":t=>t>=57344&&t<=63743,"CJK Compatibility Ideographs":t=>t>=63744&&t<=64255,"Arabic Presentation Forms-A":t=>t>=64336&&t<=65023,"Vertical Forms":t=>t>=65040&&t<=65055,"CJK Compatibility Forms":t=>t>=65072&&t<=65103,"Small Form Variants":t=>t>=65104&&t<=65135,"Arabic Presentation Forms-B":t=>t>=65136&&t<=65279,"Halfwidth and Fullwidth Forms":t=>t>=65280&&t<=65519,"CJK Unified Ideographs Extension B":t=>t>=131072&&t<=173791};function Wo(t){for(const e of t)if(Gu(e.charCodeAt(0)))return!0;return!1}function Jp(t){for(const e of t)if(!Qp(e.charCodeAt(0)))return!1;return!0}function Qp(t){return!(bt.Arabic(t)||bt["Arabic Supplement"](t)||bt["Arabic Extended-A"](t)||bt["Arabic Presentation Forms-A"](t)||bt["Arabic Presentation Forms-B"](t))}function Gu(t){return!(t!==746&&t!==747&&(t<4352||!(bt["Bopomofo Extended"](t)||bt.Bopomofo(t)||bt["CJK Compatibility Forms"](t)&&!(t>=65097&&t<=65103)||bt["CJK Compatibility Ideographs"](t)||bt["CJK Compatibility"](t)||bt["CJK Radicals Supplement"](t)||bt["CJK Strokes"](t)||!(!bt["CJK Symbols and Punctuation"](t)||t>=12296&&t<=12305||t>=12308&&t<=12319||t===12336)||bt["CJK Unified Ideographs Extension A"](t)||bt["CJK Unified Ideographs"](t)||bt["Enclosed CJK Letters and Months"](t)||bt["Hangul Compatibility Jamo"](t)||bt["Hangul Jamo Extended-A"](t)||bt["Hangul Jamo Extended-B"](t)||bt["Hangul Jamo"](t)||bt["Hangul Syllables"](t)||bt.Hiragana(t)||bt["Ideographic Description Characters"](t)||bt.Kanbun(t)||bt["Kangxi Radicals"](t)||bt["Katakana Phonetic Extensions"](t)||bt.Katakana(t)&&t!==12540||!(!bt["Halfwidth and Fullwidth Forms"](t)||t===65288||t===65289||t===65293||t>=65306&&t<=65310||t===65339||t===65341||t===65343||t>=65371&&t<=65503||t===65507||t>=65512&&t<=65519)||!(!bt["Small Form Variants"](t)||t>=65112&&t<=65118||t>=65123&&t<=65126)||bt["Unified Canadian Aboriginal Syllabics"](t)||bt["Unified Canadian Aboriginal Syllabics Extended"](t)||bt["Vertical Forms"](t)||bt["Yijing Hexagram Symbols"](t)||bt["Yi Syllables"](t)||bt["Yi Radicals"](t))))}function kd(t){return!(Gu(t)||function(e){return!!(bt["Latin-1 Supplement"](e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||bt["General Punctuation"](e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||bt["Letterlike Symbols"](e)||bt["Number Forms"](e)||bt["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||bt["Control Pictures"](e)&&e!==9251||bt["Optical Character Recognition"](e)||bt["Enclosed Alphanumerics"](e)||bt["Geometric Shapes"](e)||bt["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||bt["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||bt["CJK Symbols and Punctuation"](e)||bt.Katakana(e)||bt["Private Use Area"](e)||bt["CJK Compatibility Forms"](e)||bt["Small Form Variants"](e)||bt["Halfwidth and Fullwidth Forms"](e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)}(t))}function Bd(t){return t>=1424&&t<=2303||bt["Arabic Presentation Forms-A"](t)||bt["Arabic Presentation Forms-B"](t)}function Fd(t,e){return!(!e&&Bd(t)||t>=2304&&t<=3583||t>=3840&&t<=4255||bt.Khmer(t))}function $u(t){for(const e of t)if(Bd(e.charCodeAt(0)))return!0;return!1}const qu="deferred",Wu="loading",Hu="loaded";let Xu=null,an="unavailable",Ho=null;const Nd=function(t){t&&typeof t=="string"&&t.indexOf("NetworkError")>-1&&(an="error"),Xu&&Xu(t)};function Yu(){Ku.fire(new hs("pluginStateChange",{pluginStatus:an,pluginURL:Ho}))}const Ku=new Vs,Xo=function(){return an},Ju=function(){if(an!==qu||!Ho)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");an=Wu,Yu(),Ho&&ze({url:Ho},t=>{t?Nd(t):(an=Hu,Yu())})},vn={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>an===Hu||vn.applyArabicShaping!=null,isLoading:()=>an===Wu,setState(t){an=t.pluginStatus,Ho=t.pluginURL},isParsed:()=>vn.applyArabicShaping!=null&&vn.processBidirectionalText!=null&&vn.processStyledBidirectionalText!=null,getPluginURL:()=>Ho};class ei{constructor(e,r){this.zoom=e,r?(this.now=r.now,this.fadeDuration=r.fadeDuration,this.transition=r.transition,this.pitch=r.pitch,this.brightness=r.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(e){return function(r,n){for(const a of r)if(!Fd(a.charCodeAt(0),n))return!1;return!0}(e,vn.isLoaded())}}class ac{constructor(e,r,n,a){this.property=e,this.value=r,this.expression=function(l,h,f,m){if(rc(l))return new Xa(l,h);if(Wa(l)||Array.isArray(l)&&l.length>0){const _=oc(l,h,f,m);if(_.result==="error")throw new Error(_.value.map(x=>`${x.key}: ${x.message}`).join(", "));return _.value}{let _=l;return typeof l=="string"&&h.type==="color"&&(_=mi.parse(l)),{kind:"constant",isConfigDependent:!1,evaluate:()=>_}}}(r===void 0?e.specification.default:r,e.specification,n,a)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,r,n){return this.property.possiblyEvaluate(this,e,r,n)}}class Qu{constructor(e,r,n){this.property=e,this.value=new ac(e,void 0,r,n)}transitioned(e,r){return new eh(this.property,this.value,r,gi({},e.transition,this.transition),e.now)}untransitioned(){return new eh(this.property,this.value,null,{},0)}}class xo{constructor(e,r,n){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._scope=r,this._options=n,this.isConfigDependent=!1}getValue(e){return gn(this._values[e].value.value)}setValue(e,r){this._values.hasOwnProperty(e)||(this._values[e]=new Qu(this._values[e].property,this._scope,this._options)),this._values[e].value=new ac(this._values[e].property,r===null?void 0:gn(r),this._scope,this._options),this.isConfigDependent=this.isConfigDependent||this._values[e].value.expression.isConfigDependent}setTransitionOrValue(e,r){r&&(this._options=r);const n=this._properties.properties;if(e)for(const a in e){const l=e[a];if(_n(a,"-transition")){const h=a.slice(0,-11);n[h]&&this.setTransition(h,l)}else n[a]&&this.setValue(a,l)}}getTransition(e){return gn(this._values[e].transition)}setTransition(e,r){this._values.hasOwnProperty(e)||(this._values[e]=new Qu(this._values[e].property)),this._values[e].transition=gn(r)||void 0}serialize(){const e={};for(const r of Object.keys(this._values)){const n=this.getValue(r);n!==void 0&&(e[r]=n);const a=this.getTransition(r);a!==void 0&&(e[`${r}-transition`]=a)}return e}transitioned(e,r){const n=new Ts(this._properties);for(const a of Object.keys(this._values))n._values[a]=this._values[a].transitioned(e,r._values[a]);return n}untransitioned(){const e=new Ts(this._properties);for(const r of Object.keys(this._values))e._values[r]=this._values[r].untransitioned();return e}}class eh{constructor(e,r,n,a,l){const h=a.delay||0,f=a.duration||0;l=l||0,this.property=e,this.value=r,this.begin=l+h,this.end=this.begin+f,e.specification.transition&&(a.delay||a.duration)&&(this.prior=n)}possiblyEvaluate(e,r,n){const a=e.now||0,l=this.value.possiblyEvaluate(e,r,n),h=this.prior;if(h){if(a>this.end)return this.prior=null,l;if(this.value.isDataDriven())return this.prior=null,l;if(a<this.begin)return h.possiblyEvaluate(e,r,n);{const f=(a-this.begin)/(this.end-this.begin);return this.property.interpolate(h.possiblyEvaluate(e,r,n),l,it(f))}}return l}}class Ts{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,r,n){const a=new Ja(this._properties);for(const l of Object.keys(this._values))a._values[l]=this._values[l].possiblyEvaluate(e,r,n);return a}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class em{constructor(e,r,n){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._scope=r,this._options=n,this.isConfigDependent=!1}getValue(e){return gn(this._values[e].value)}setValue(e,r){this._values[e]=new ac(this._values[e].property,r===null?void 0:gn(r),this._scope,this._options),this.isConfigDependent=this.isConfigDependent||this._values[e].expression.isConfigDependent}serialize(){const e={};for(const r of Object.keys(this._values)){const n=this.getValue(r);n!==void 0&&(e[r]=n)}return e}possiblyEvaluate(e,r,n){const a=new Ja(this._properties);for(const l of Object.keys(this._values))a._values[l]=this._values[l].possiblyEvaluate(e,r,n);return a}}class aa{constructor(e,r,n){this.property=e,this.value=r,this.parameters=n}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,r,n,a){return this.property.evaluate(this.value,this.parameters,e,r,n,a)}}class Ja{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class Je{constructor(e){this.specification=e}possiblyEvaluate(e,r){return e.expression.evaluate(r)}interpolate(e,r,n){const a=Bl[this.specification.type];return a?a(e,r,n):e}}class Lt{constructor(e,r){this.specification=e,this.overrides=r}possiblyEvaluate(e,r,n,a){return new aa(this,e.expression.kind==="constant"||e.expression.kind==="camera"?{kind:"constant",value:e.expression.evaluate(r,null,{},n,a)}:e.expression,r)}interpolate(e,r,n){if(e.value.kind!=="constant"||r.value.kind!=="constant")return e;if(e.value.value===void 0||r.value.value===void 0)return new aa(this,{kind:"constant",value:void 0},e.parameters);const a=Bl[this.specification.type];return a?new aa(this,{kind:"constant",value:a(e.value.value,r.value.value,n)},e.parameters):e}evaluate(e,r,n,a,l,h){return e.kind==="constant"?e.value:e.evaluate(r,n,a,l,h)}}class Es{constructor(e){this.specification=e}possiblyEvaluate(e,r,n,a){return!!e.expression.evaluate(r,null,{},n,a)}interpolate(){return!1}}class ti{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const r=new ei(0,{});for(const n in e){const a=e[n];a.specification.overridable&&this.overridableProperties.push(n);const l=this.defaultPropertyValues[n]=new ac(a,void 0),h=this.defaultTransitionablePropertyValues[n]=new Qu(a);this.defaultTransitioningPropertyValues[n]=h.untransitioned(),this.defaultPossiblyEvaluatedValues[n]=l.possiblyEvaluate(r)}}}function Qa(t){return t instanceof Number||t instanceof String||t instanceof Boolean?t.valueOf():t}function el(t){if(Array.isArray(t))return t.map(el);if(t instanceof Object&&!(t instanceof Number||t instanceof String||t instanceof Boolean)){const e={};for(const r in t)e[r]=el(t[r]);return e}return Qa(t)}mt(Lt,"DataDrivenProperty"),mt(Je,"DataConstantProperty"),mt(Es,"ColorRampProperty");var be=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"required":false,"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"camera":{"type":"camera"},"imports":{"type":"array","value":"import"},"schema":{"type":"schema"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"},"models":{"type":"models"}},"model":{"type":"string","required":true},"import":{"id":{"type":"string","required":true},"url":{"type":"string","required":true},"config":{"type":"config"},"data":{"type":"$root"}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","required":true},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string","required":true},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false,"expression":{},"property-type":"data-constant"},"shadow-intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"required":true,"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":1}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":1}},"url":{"required":false,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"required":true,"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective","property-type":"data-constant"}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","private":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"property-type":"data-constant","type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"property-type":"data-constant","type":"color","default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"property-type":"data-constant","type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"property-type":"data-constant","type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"property-type":"data-constant","type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"property-type":"data-constant","type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"property-type":"constant"},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-border-width":{"type":"number","private":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","private":true,"default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-image-cross-fade":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-color-saturation":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-value"]},"property-type":"color-ramp"},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"raster-array-band":{"type":"string","required":false,"property-type":"data-constant"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string","required":false,"property-type":"data-constant"},"raster-particle-count":{"type":"number","default":512,"minimum":1,"property-type":"data-constant"},"raster-particle-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-particle-speed"]},"property-type":"color-ramp"},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1,"property-type":"data-constant"},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1,"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_background":{"background-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d","property-type":"data-constant"},"model-cast-shadows":{"type":"boolean","default":true,"expression":{},"property-type":"data-constant"},"model-receive-shadows":{"type":"boolean","default":true,"expression":{},"property-type":"data-constant"},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant","transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');function th(t){if(t===!0||t===!1)return!0;if(!Array.isArray(t)||t.length===0)return!1;switch(t[0]){case"has":return t.length>=2&&t[1]!=="$id"&&t[1]!=="$type";case"in":return t.length>=3&&(typeof t[1]!="string"||Array.isArray(t[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return t.length!==3||Array.isArray(t[1])||Array.isArray(t[2]);case"any":case"all":for(const e of t.slice(1))if(!th(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}function bn(t,e="fill"){if(t==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};th(t)||(t=tl(t));const r=t;let n=!0;try{n=function(_){if(!la(_))return _;let x=el(_);return rh(x),x=Ud(x),x}(r)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(r,null,2)}
        `)}const a=be[`filter_${e}`],l=nc(n,a);let h=null;if(l.result==="error")throw new Error(l.value.map(_=>`${_.key}: ${_.message}`).join(", "));h=(_,x,b)=>l.value.evaluate(_,x,{},b);let f=null,m=null;if(n!==r){const _=nc(r,a);if(_.result==="error")throw new Error(_.value.map(x=>`${x.key}: ${x.message}`).join(", "));f=(x,b,T,C,P)=>_.value.evaluate(x,b,{},T,void 0,void 0,C,P),m=!Js(_.value.expression)}return{filter:h,dynamicFilter:f||void 0,needGeometry:Vd(n),needFeature:!!m}}function Ud(t){if(!Array.isArray(t))return t;const e=function(r){if(tm.has(r[0])){for(let n=1;n<r.length;n++)if(la(r[n]))return!0}return r}(t);return e===!0?e:e.map(r=>Ud(r))}function rh(t){let e=!1;const r=[];if(t[0]==="case"){for(let n=1;n<t.length-1;n+=2)e=e||la(t[n]),r.push(t[n+1]);r.push(t[t.length-1])}else if(t[0]==="match"){e=e||la(t[1]);for(let n=2;n<t.length-1;n+=2)r.push(t[n+1]);r.push(t[t.length-1])}else if(t[0]==="step"){e=e||la(t[1]);for(let n=1;n<t.length-1;n+=2)r.push(t[n+1])}e&&(t.length=0,t.push("any",...r));for(let n=1;n<t.length;n++)rh(t[n])}function la(t){if(!Array.isArray(t))return!1;if((e=t[0])==="pitch"||e==="distance-from-center")return!0;var e;for(let r=1;r<t.length;r++)if(la(t[r]))return!0;return!1}const tm=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function rm(t,e){return t<e?-1:t>e?1:0}function Vd(t){if(!Array.isArray(t))return!1;if(t[0]==="within"||t[0]==="distance")return!0;for(let e=1;e<t.length;e++)if(Vd(t[e]))return!0;return!1}function tl(t){if(!t)return!0;const e=t[0];return t.length<=1?e!=="any":e==="=="?rl(t[1],t[2],"=="):e==="!="?il(rl(t[1],t[2],"==")):e==="<"||e===">"||e==="<="||e===">="?rl(t[1],t[2],e):e==="any"?(r=t.slice(1),["any"].concat(r.map(tl))):e==="all"?["all"].concat(t.slice(1).map(tl)):e==="none"?["all"].concat(t.slice(1).map(tl).map(il)):e==="in"?ih(t[1],t.slice(2)):e==="!in"?il(ih(t[1],t.slice(2))):e==="has"?jd(t[1]):e!=="!has"||il(jd(t[1]));var r}function rl(t,e,r){switch(t){case"$type":return[`filter-type-${r}`,e];case"$id":return[`filter-id-${r}`,e];default:return[`filter-${r}`,t,e]}}function ih(t,e){if(e.length===0)return!1;switch(t){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(r=>typeof r!=typeof e[0])?["filter-in-large",t,["literal",e.sort(rm)]]:["filter-in-small",t,["literal",e]]}}function jd(t){switch(t){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",t]}}function il(t){return["!",t]}const lc="";function nh(t,e){return e?`${t}${lc}${e}`:t}const nl="-transition";class ln extends Vs{constructor(e,r,n,a){if(super(),this.id=e.id,this.fqid=nh(this.id,n),this.type=e.type,this.scope=n,this.options=a,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.isConfigDependent=!1,e.type!=="custom"&&(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type!=="background"&&e.type!=="sky"&&e.type!=="slot"&&(this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter),e.slot&&(this.slot=e.slot),r.layout&&(this._unevaluatedLayout=new em(r.layout,this.scope,a),this.isConfigDependent=this.isConfigDependent||this._unevaluatedLayout.isConfigDependent),r.paint)){this._transitionablePaint=new xo(r.paint,this.scope,a);for(const l in e.paint)this.setPaintProperty(l,e.paint[l]);for(const l in e.layout)this.setLayoutProperty(l,e.layout[l]);this.isConfigDependent=this.isConfigDependent||this._transitionablePaint.isConfigDependent,this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Ja(r.paint)}}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,r){if(this.type==="custom"&&e==="visibility")return void(this.visibility=r);const n=this._unevaluatedLayout;n._properties.properties[e]&&(n.setValue(e,r),this.isConfigDependent=this.isConfigDependent||n.isConfigDependent,e==="visibility"&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0})}getPaintProperty(e){return _n(e,nl)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}setPaintProperty(e,r){const n=this._transitionablePaint,a=n._properties.properties;if(_n(e,nl)){const b=e.slice(0,-11);return a[b]&&n.setTransition(b,r||void 0),!1}if(!a[e])return!1;const l=n._values[e],h=l.value.isDataDriven(),f=l.value;n.setValue(e,r),this.isConfigDependent=this.isConfigDependent||n.isConfigDependent,this._handleSpecialPaintPropertyUpdate(e);const m=n._values[e].value,_=m.isDataDriven(),x=_n(e,"pattern")||e==="line-dasharray";return _||h||x||this._handleOverridablePaintPropertyUpdate(e,f,m)}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getDefaultProgramParams(e,r){return null}_handleOverridablePaintPropertyUpdate(e,r,n){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,r){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,r)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,r)}serialize(){return Ki({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(e,r)=>!(e===void 0||r==="layout"&&!Object.keys(e).length||r==="paint"&&!Object.keys(e).length))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}isStateDependent(){for(const e in this.paint._values){const r=this.paint.get(e);if(r instanceof aa&&tc(r.property.specification)&&(r.value.kind==="source"||r.value.kind==="composite")&&r.value.isStateDependent)return!0}return!1}compileFilter(){this._filterCompiled||(this._featureFilter=bn(this.filter),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(e){this._stats&&(e.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}}const im={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class cc{constructor(e,r){this._structArray=e,this._pos1=r*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class Xr{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(e,r){return e._trim(),r&&(e.isTransferred=!0,r.add(e.arrayBuffer)),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const r=Object.create(this.prototype);return r.arrayBuffer=e.arrayBuffer,r.length=e.length,r.capacity=e.arrayBuffer.byteLength/r.bytesPerElement,r._refreshViews(),r}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const r=this.uint8;this._refreshViews(),r&&this.uint8.set(r)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...e){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...e){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function Dr(t,e=1){let r=0,n=0;return{members:t.map(a=>{const l=im[a.type].BYTES_PER_ELEMENT,h=r=ol(r,Math.max(e,l)),f=a.components||1;return n=Math.max(n,l),r+=l*f,{name:a.name,type:a.type,components:f,offset:h}}),size:ol(r,Math.max(n,e)),alignment:e}}function ol(t,e){return Math.ceil(t/e)*e}class qn extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r){const n=this.length;return this.resize(n+1),this.emplace(n,e,r)}emplace(e,r,n){const a=2*e;return this.int16[a+0]=r,this.int16[a+1]=n,e}}qn.prototype.bytesPerElement=4,mt(qn,"StructArrayLayout2i4");class en extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,n){const a=this.length;return this.resize(a+1),this.emplace(a,e,r,n)}emplace(e,r,n,a){const l=3*e;return this.int16[l+0]=r,this.int16[l+1]=n,this.int16[l+2]=a,e}}en.prototype.bytesPerElement=6,mt(en,"StructArrayLayout3i6");class vo extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,n,a){const l=this.length;return this.resize(l+1),this.emplace(l,e,r,n,a)}emplace(e,r,n,a,l){const h=4*e;return this.int16[h+0]=r,this.int16[h+1]=n,this.int16[h+2]=a,this.int16[h+3]=l,e}}vo.prototype.bytesPerElement=8,mt(vo,"StructArrayLayout4i8");class oh extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,n,a,l){const h=this.length;return this.resize(h+1),this.emplace(h,e,r,n,a,l)}emplace(e,r,n,a,l,h){const f=5*e;return this.int16[f+0]=r,this.int16[f+1]=n,this.int16[f+2]=a,this.int16[f+3]=l,this.int16[f+4]=h,e}}oh.prototype.bytesPerElement=10,mt(oh,"StructArrayLayout5i10");class sh extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,n,a,l,h,f){const m=this.length;return this.resize(m+1),this.emplace(m,e,r,n,a,l,h,f)}emplace(e,r,n,a,l,h,f,m){const _=6*e,x=12*e,b=3*e;return this.int16[_+0]=r,this.int16[_+1]=n,this.uint8[x+4]=a,this.uint8[x+5]=l,this.uint8[x+6]=h,this.uint8[x+7]=f,this.float32[b+2]=m,e}}sh.prototype.bytesPerElement=12,mt(sh,"StructArrayLayout2i4ub1f12");class Yo extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,n,a){const l=this.length;return this.resize(l+1),this.emplace(l,e,r,n,a)}emplace(e,r,n,a,l){const h=4*e;return this.float32[h+0]=r,this.float32[h+1]=n,this.float32[h+2]=a,this.float32[h+3]=l,e}}Yo.prototype.bytesPerElement=16,mt(Yo,"StructArrayLayout4f16");class Ko extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,n,a,l){const h=this.length;return this.resize(h+1),this.emplace(h,e,r,n,a,l)}emplace(e,r,n,a,l,h){const f=6*e,m=3*e;return this.uint16[f+0]=r,this.uint16[f+1]=n,this.uint16[f+2]=a,this.uint16[f+3]=l,this.float32[m+2]=h,e}}Ko.prototype.bytesPerElement=12,mt(Ko,"StructArrayLayout4ui1f12");class ca extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,n,a){const l=this.length;return this.resize(l+1),this.emplace(l,e,r,n,a)}emplace(e,r,n,a,l){const h=4*e;return this.uint16[h+0]=r,this.uint16[h+1]=n,this.uint16[h+2]=a,this.uint16[h+3]=l,e}}ca.prototype.bytesPerElement=8,mt(ca,"StructArrayLayout4ui8");class uc extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,n,a,l,h){const f=this.length;return this.resize(f+1),this.emplace(f,e,r,n,a,l,h)}emplace(e,r,n,a,l,h,f){const m=6*e;return this.int16[m+0]=r,this.int16[m+1]=n,this.int16[m+2]=a,this.int16[m+3]=l,this.int16[m+4]=h,this.int16[m+5]=f,e}}uc.prototype.bytesPerElement=12,mt(uc,"StructArrayLayout6i12");class sl extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,n,a,l,h,f,m,_,x,b,T){const C=this.length;return this.resize(C+1),this.emplace(C,e,r,n,a,l,h,f,m,_,x,b,T)}emplace(e,r,n,a,l,h,f,m,_,x,b,T,C){const P=12*e;return this.int16[P+0]=r,this.int16[P+1]=n,this.int16[P+2]=a,this.int16[P+3]=l,this.uint16[P+4]=h,this.uint16[P+5]=f,this.uint16[P+6]=m,this.uint16[P+7]=_,this.int16[P+8]=x,this.int16[P+9]=b,this.int16[P+10]=T,this.int16[P+11]=C,e}}sl.prototype.bytesPerElement=24,mt(sl,"StructArrayLayout4i4ui4i24");class ah extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,n,a,l,h){const f=this.length;return this.resize(f+1),this.emplace(f,e,r,n,a,l,h)}emplace(e,r,n,a,l,h,f){const m=10*e,_=5*e;return this.int16[m+0]=r,this.int16[m+1]=n,this.int16[m+2]=a,this.float32[_+2]=l,this.float32[_+3]=h,this.float32[_+4]=f,e}}ah.prototype.bytesPerElement=20,mt(ah,"StructArrayLayout3i3f20");class lh extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const r=this.length;return this.resize(r+1),this.emplace(r,e)}emplace(e,r){return this.uint32[1*e+0]=r,e}}lh.prototype.bytesPerElement=4,mt(lh,"StructArrayLayout1ul4");class io extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r){const n=this.length;return this.resize(n+1),this.emplace(n,e,r)}emplace(e,r,n){const a=2*e;return this.uint16[a+0]=r,this.uint16[a+1]=n,e}}io.prototype.bytesPerElement=4,mt(io,"StructArrayLayout2ui4");class ch extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,n,a,l,h,f,m,_,x,b,T,C){const P=this.length;return this.resize(P+1),this.emplace(P,e,r,n,a,l,h,f,m,_,x,b,T,C)}emplace(e,r,n,a,l,h,f,m,_,x,b,T,C,P){const D=20*e,O=10*e;return this.int16[D+0]=r,this.int16[D+1]=n,this.int16[D+2]=a,this.int16[D+3]=l,this.int16[D+4]=h,this.float32[O+3]=f,this.float32[O+4]=m,this.float32[O+5]=_,this.float32[O+6]=x,this.int16[D+14]=b,this.uint32[O+8]=T,this.uint16[D+18]=C,this.uint16[D+19]=P,e}}ch.prototype.bytesPerElement=40,mt(ch,"StructArrayLayout5i4f1i1ul2ui40");class al extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,n,a,l,h,f){const m=this.length;return this.resize(m+1),this.emplace(m,e,r,n,a,l,h,f)}emplace(e,r,n,a,l,h,f,m){const _=8*e;return this.int16[_+0]=r,this.int16[_+1]=n,this.int16[_+2]=a,this.int16[_+4]=l,this.int16[_+5]=h,this.int16[_+6]=f,this.int16[_+7]=m,e}}al.prototype.bytesPerElement=16,mt(al,"StructArrayLayout3i2i2i16");class hc extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,n,a,l){const h=this.length;return this.resize(h+1),this.emplace(h,e,r,n,a,l)}emplace(e,r,n,a,l,h){const f=4*e,m=8*e;return this.float32[f+0]=r,this.float32[f+1]=n,this.float32[f+2]=a,this.int16[m+6]=l,this.int16[m+7]=h,e}}hc.prototype.bytesPerElement=16,mt(hc,"StructArrayLayout2f1f2i16");class uh extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,n,a){const l=this.length;return this.resize(l+1),this.emplace(l,e,r,n,a)}emplace(e,r,n,a,l){const h=12*e,f=3*e;return this.uint8[h+0]=r,this.uint8[h+1]=n,this.float32[f+1]=a,this.float32[f+2]=l,e}}uh.prototype.bytesPerElement=12,mt(uh,"StructArrayLayout2ub2f12");class Si extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,n){const a=this.length;return this.resize(a+1),this.emplace(a,e,r,n)}emplace(e,r,n,a){const l=3*e;return this.uint16[l+0]=r,this.uint16[l+1]=n,this.uint16[l+2]=a,e}}Si.prototype.bytesPerElement=6,mt(Si,"StructArrayLayout3ui6");class ua extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,r,n,a,l,h,f,m,_,x,b,T,C,P,D,O,F,$,X,H,ne){const re=this.length;return this.resize(re+1),this.emplace(re,e,r,n,a,l,h,f,m,_,x,b,T,C,P,D,O,F,$,X,H,ne)}emplace(e,r,n,a,l,h,f,m,_,x,b,T,C,P,D,O,F,$,X,H,ne,re){const ce=30*e,pe=15*e,ye=60*e;return this.int16[ce+0]=r,this.int16[ce+1]=n,this.int16[ce+2]=a,this.float32[pe+2]=l,this.float32[pe+3]=h,this.uint16[ce+8]=f,this.uint16[ce+9]=m,this.uint32[pe+5]=_,this.uint32[pe+6]=x,this.uint32[pe+7]=b,this.uint16[ce+16]=T,this.uint16[ce+17]=C,this.uint16[ce+18]=P,this.float32[pe+10]=D,this.float32[pe+11]=O,this.uint8[ye+48]=F,this.uint8[ye+49]=$,this.uint8[ye+50]=X,this.uint32[pe+13]=H,this.int16[ce+28]=ne,this.uint8[ye+58]=re,e}}ua.prototype.bytesPerElement=60,mt(ua,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class dc extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,r,n,a,l,h,f,m,_,x,b,T,C,P,D,O,F,$,X,H,ne,re,ce,pe,ye,Te,xe,Se,Be,Ce,Oe,Me){const Re=this.length;return this.resize(Re+1),this.emplace(Re,e,r,n,a,l,h,f,m,_,x,b,T,C,P,D,O,F,$,X,H,ne,re,ce,pe,ye,Te,xe,Se,Be,Ce,Oe,Me)}emplace(e,r,n,a,l,h,f,m,_,x,b,T,C,P,D,O,F,$,X,H,ne,re,ce,pe,ye,Te,xe,Se,Be,Ce,Oe,Me,Re){const et=20*e,Ne=40*e,gt=80*e;return this.float32[et+0]=r,this.float32[et+1]=n,this.int16[Ne+4]=a,this.int16[Ne+5]=l,this.int16[Ne+6]=h,this.int16[Ne+7]=f,this.int16[Ne+8]=m,this.int16[Ne+9]=_,this.int16[Ne+10]=x,this.int16[Ne+11]=b,this.int16[Ne+12]=T,this.uint16[Ne+13]=C,this.uint16[Ne+14]=P,this.uint16[Ne+15]=D,this.uint16[Ne+16]=O,this.uint16[Ne+17]=F,this.uint16[Ne+18]=$,this.uint16[Ne+19]=X,this.uint16[Ne+20]=H,this.uint16[Ne+21]=ne,this.uint16[Ne+22]=re,this.uint16[Ne+23]=ce,this.uint16[Ne+24]=pe,this.uint16[Ne+25]=ye,this.uint16[Ne+26]=Te,this.uint16[Ne+27]=xe,this.uint32[et+14]=Se,this.float32[et+15]=Be,this.float32[et+16]=Ce,this.float32[et+17]=Oe,this.float32[et+18]=Me,this.uint8[gt+76]=Re,e}}dc.prototype.bytesPerElement=80,mt(dc,"StructArrayLayout2f9i15ui1ul4f1ub80");class ll extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const r=this.length;return this.resize(r+1),this.emplace(r,e)}emplace(e,r){return this.float32[1*e+0]=r,e}}ll.prototype.bytesPerElement=4,mt(ll,"StructArrayLayout1f4");class Jo extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,n,a,l){const h=this.length;return this.resize(h+1),this.emplace(h,e,r,n,a,l)}emplace(e,r,n,a,l,h){const f=5*e;return this.float32[f+0]=r,this.float32[f+1]=n,this.float32[f+2]=a,this.float32[f+3]=l,this.float32[f+4]=h,e}}Jo.prototype.bytesPerElement=20,mt(Jo,"StructArrayLayout5f20");class hh extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,n,a,l,h,f){const m=this.length;return this.resize(m+1),this.emplace(m,e,r,n,a,l,h,f)}emplace(e,r,n,a,l,h,f,m){const _=7*e;return this.float32[_+0]=r,this.float32[_+1]=n,this.float32[_+2]=a,this.float32[_+3]=l,this.float32[_+4]=h,this.float32[_+5]=f,this.float32[_+6]=m,e}}hh.prototype.bytesPerElement=28,mt(hh,"StructArrayLayout7f28");class cl extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,n,a){const l=this.length;return this.resize(l+1),this.emplace(l,e,r,n,a)}emplace(e,r,n,a,l){const h=6*e;return this.uint32[3*e+0]=r,this.uint16[h+2]=n,this.uint16[h+3]=a,this.uint16[h+4]=l,e}}cl.prototype.bytesPerElement=12,mt(cl,"StructArrayLayout1ul3ui12");class dh extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const r=this.length;return this.resize(r+1),this.emplace(r,e)}emplace(e,r){return this.uint16[1*e+0]=r,e}}dh.prototype.bytesPerElement=2,mt(dh,"StructArrayLayout1ui2");class Ms extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,n){const a=this.length;return this.resize(a+1),this.emplace(a,e,r,n)}emplace(e,r,n,a){const l=3*e;return this.float32[l+0]=r,this.float32[l+1]=n,this.float32[l+2]=a,e}}Ms.prototype.bytesPerElement=12,mt(Ms,"StructArrayLayout3f12");class ul extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r){const n=this.length;return this.resize(n+1),this.emplace(n,e,r)}emplace(e,r,n){const a=2*e;return this.float32[a+0]=r,this.float32[a+1]=n,e}}ul.prototype.bytesPerElement=8,mt(ul,"StructArrayLayout2f8");class fh extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,n,a,l,h,f,m,_,x,b,T,C,P,D,O){const F=this.length;return this.resize(F+1),this.emplace(F,e,r,n,a,l,h,f,m,_,x,b,T,C,P,D,O)}emplace(e,r,n,a,l,h,f,m,_,x,b,T,C,P,D,O,F){const $=16*e;return this.float32[$+0]=r,this.float32[$+1]=n,this.float32[$+2]=a,this.float32[$+3]=l,this.float32[$+4]=h,this.float32[$+5]=f,this.float32[$+6]=m,this.float32[$+7]=_,this.float32[$+8]=x,this.float32[$+9]=b,this.float32[$+10]=T,this.float32[$+11]=C,this.float32[$+12]=P,this.float32[$+13]=D,this.float32[$+14]=O,this.float32[$+15]=F,e}}fh.prototype.bytesPerElement=64,mt(fh,"StructArrayLayout16f64");class hl extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,n,a,l,h,f){const m=this.length;return this.resize(m+1),this.emplace(m,e,r,n,a,l,h,f)}emplace(e,r,n,a,l,h,f,m){const _=10*e,x=5*e;return this.uint16[_+0]=r,this.uint16[_+1]=n,this.uint16[_+2]=a,this.uint16[_+3]=l,this.float32[x+2]=h,this.float32[x+3]=f,this.float32[x+4]=m,e}}hl.prototype.bytesPerElement=20,mt(hl,"StructArrayLayout4ui3f20");class ph extends Xr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(e){const r=this.length;return this.resize(r+1),this.emplace(r,e)}emplace(e,r){return this.uint8[1*e+0]=r,e}}ph.prototype.bytesPerElement=1,mt(ph,"StructArrayLayout1ub1");class Zd extends cc{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}Zd.prototype.size=40;class Gd extends ch{get(e){return new Zd(this,e)}}mt(Gd,"CollisionBoxArray");class $d extends cc{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}$d.prototype.size=60;class qd extends ua{get(e){return new $d(this,e)}}mt(qd,"PlacedSymbolArray");class Wd extends cc{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(e){this._structArray.uint32[this._pos4+14]=e}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(e){this._structArray.float32[this._pos4+18]=e}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}}Wd.prototype.size=80;class Hd extends dc{get(e){return new Wd(this,e)}}mt(Hd,"SymbolInstanceArray");class Xd extends ll{getoffsetX(e){return this.float32[1*e+0]}}mt(Xd,"GlyphOffsetArray");class dl extends qn{getx(e){return this.int16[2*e+0]}gety(e){return this.int16[2*e+1]}}mt(dl,"SymbolLineVertexArray");class Yd extends cc{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}Yd.prototype.size=12;class Kd extends cl{get(e){return new Yd(this,e)}}mt(Kd,"FeatureIndexArray");class fl extends io{geta_centroid_pos0(e){return this.uint16[2*e+0]}geta_centroid_pos1(e){return this.uint16[2*e+1]}}mt(fl,"FillExtrusionCentroidArray");const nm=Dr([{name:"a_pos",components:2,type:"Int16"}],4),Jd=Dr([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class ci{constructor(e=[]){this.segments=e}_prepareSegment(e,r,n,a){let l=this.segments[this.segments.length-1];return e>ci.MAX_VERTEX_ARRAY_LENGTH&&li(`Max vertices per segment is ${ci.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!l||l.vertexLength+e>ci.MAX_VERTEX_ARRAY_LENGTH||l.sortKey!==a)&&(l={vertexOffset:r,primitiveOffset:n,vertexLength:0,primitiveLength:0},a!==void 0&&(l.sortKey=a),this.segments.push(l)),l}prepareSegment(e,r,n,a){return this._prepareSegment(e,r.length,n.length,a)}get(){return this.segments}destroy(){for(const e of this.segments)for(const r in e.vaos)e.vaos[r].destroy()}static simpleSegment(e,r,n,a){return new ci([{vertexOffset:e,primitiveOffset:r,vertexLength:n,primitiveLength:a,vaos:{},sortKey:0}])}}function mh(t,e){return 256*(t=Ut(Math.floor(t),0,255))+Ut(Math.floor(e),0,255)}ci.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,mt(ci,"SegmentVector");const Qd=Dr([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),ef=Dr([{name:"a_dash",components:4,type:"Uint16"}]);var pl={exports:{}},fc={exports:{}};(function(t){t.exports=function(e,r){var n,a,l,h,f,m,_,x;for(a=e.length-(n=3&e.length),l=r,f=3432918353,m=461845907,x=0;x<a;)_=255&e.charCodeAt(x)|(255&e.charCodeAt(++x))<<8|(255&e.charCodeAt(++x))<<16|(255&e.charCodeAt(++x))<<24,++x,l=27492+(65535&(h=5*(65535&(l=(l^=_=(65535&(_=(_=(65535&_)*f+(((_>>>16)*f&65535)<<16)&4294967295)<<15|_>>>17))*m+(((_>>>16)*m&65535)<<16)&4294967295)<<13|l>>>19))+((5*(l>>>16)&65535)<<16)&4294967295))+((58964+(h>>>16)&65535)<<16);switch(_=0,n){case 3:_^=(255&e.charCodeAt(x+2))<<16;case 2:_^=(255&e.charCodeAt(x+1))<<8;case 1:l^=_=(65535&(_=(_=(65535&(_^=255&e.charCodeAt(x)))*f+(((_>>>16)*f&65535)<<16)&4294967295)<<15|_>>>17))*m+(((_>>>16)*m&65535)<<16)&4294967295}return l^=e.length,l=2246822507*(65535&(l^=l>>>16))+((2246822507*(l>>>16)&65535)<<16)&4294967295,l=3266489909*(65535&(l^=l>>>13))+((3266489909*(l>>>16)&65535)<<16)&4294967295,(l^=l>>>16)>>>0}})(fc);var _h=fc.exports,tf={exports:{}};(function(t){t.exports=function(e,r){for(var n,a=e.length,l=r^a,h=0;a>=4;)n=1540483477*(65535&(n=255&e.charCodeAt(h)|(255&e.charCodeAt(++h))<<8|(255&e.charCodeAt(++h))<<16|(255&e.charCodeAt(++h))<<24))+((1540483477*(n>>>16)&65535)<<16),l=1540483477*(65535&l)+((1540483477*(l>>>16)&65535)<<16)^(n=1540483477*(65535&(n^=n>>>24))+((1540483477*(n>>>16)&65535)<<16)),a-=4,++h;switch(a){case 3:l^=(255&e.charCodeAt(h+2))<<16;case 2:l^=(255&e.charCodeAt(h+1))<<8;case 1:l=1540483477*(65535&(l^=255&e.charCodeAt(h)))+((1540483477*(l>>>16)&65535)<<16)}return l=1540483477*(65535&(l^=l>>>13))+((1540483477*(l>>>16)&65535)<<16),(l^=l>>>15)>>>0}})(tf);var rf=_h,nf=tf.exports;pl.exports=rf,pl.exports.murmur3=rf,pl.exports.murmur2=nf;var gh=ft(pl.exports);class ml{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(e,r,n,a){this.ids.push(of(e)),this.positions.push(r,n,a)}eachPosition(e,r){const n=of(e);let a=0,l=this.ids.length-1;for(;a<l;){const h=a+l>>1;this.ids[h]>=n?l=h:a=h+1}for(;this.ids[a]===n;)r(this.positions[3*a],this.positions[3*a+1],this.positions[3*a+2]),a++}static serialize(e,r){const n=new Float64Array(e.ids),a=new Uint32Array(e.positions);return yh(n,a,0,n.length-1),r&&(r.add(n.buffer),r.add(a.buffer)),{ids:n,positions:a}}static deserialize(e){const r=new ml;let n;r.ids=e.ids,r.positions=e.positions;for(const a of r.ids)a!==n&&r.uniqueIds.push(a),n=a;return r.indexed=!0,r}}function of(t){const e=+t;return!isNaN(e)&&Number.MIN_SAFE_INTEGER<=e&&e<=Number.MAX_SAFE_INTEGER?e:gh(String(t))}function yh(t,e,r,n){for(;r<n;){const a=t[r+n>>1];let l=r-1,h=n+1;for(;;){do l++;while(t[l]<a);do h--;while(t[h]>a);if(l>=h)break;pc(t,l,h),pc(e,3*l,3*h),pc(e,3*l+1,3*h+1),pc(e,3*l+2,3*h+2)}h-r<n-h?(yh(t,e,r,h),r=h+1):(yh(t,e,h+1,n),n=h)}}function pc(t,e,r){const n=t[e];t[e]=t[r],t[r]=n}mt(ml,"FeaturePositionMap");class bo{constructor(e){this.gl=e.gl,this.initialized=!1}fetchUniformLocation(e,r){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(e,r),this.initialized=!0),!!this.location}}class mc extends bo{constructor(e){super(e),this.current=0}set(e,r,n){this.fetchUniformLocation(e,r)&&this.current!==n&&(this.current=n,this.gl.uniform1i(this.location,n))}}class Hi extends bo{constructor(e){super(e),this.current=0}set(e,r,n){this.fetchUniformLocation(e,r)&&this.current!==n&&(this.current=n,this.gl.uniform1f(this.location,n))}}class Qo extends bo{constructor(e){super(e),this.current=[0,0]}set(e,r,n){this.fetchUniformLocation(e,r)&&(n[0]===this.current[0]&&n[1]===this.current[1]||(this.current=n,this.gl.uniform2f(this.location,n[0],n[1])))}}class sf extends bo{constructor(e){super(e),this.current=[0,0,0]}set(e,r,n){this.fetchUniformLocation(e,r)&&(n[0]===this.current[0]&&n[1]===this.current[1]&&n[2]===this.current[2]||(this.current=n,this.gl.uniform3f(this.location,n[0],n[1],n[2])))}}class c extends bo{constructor(e){super(e),this.current=[0,0,0,0]}set(e,r,n){this.fetchUniformLocation(e,r)&&(n[0]===this.current[0]&&n[1]===this.current[1]&&n[2]===this.current[2]&&n[3]===this.current[3]||(this.current=n,this.gl.uniform4f(this.location,n[0],n[1],n[2],n[3])))}}class i extends bo{constructor(e){super(e),this.current=mi.transparent}set(e,r,n){this.fetchUniformLocation(e,r)&&(n.r===this.current.r&&n.g===this.current.g&&n.b===this.current.b&&n.a===this.current.a||(this.current=n,this.gl.uniform4f(this.location,n.r,n.g,n.b,n.a)))}}const o=new Float32Array(16);class u extends bo{constructor(e){super(e),this.current=o}set(e,r,n){if(this.fetchUniformLocation(e,r)){if(n[12]!==this.current[12]||n[0]!==this.current[0])return this.current=n,void this.gl.uniformMatrix4fv(this.location,!1,n);for(let a=1;a<16;a++)if(n[a]!==this.current[a]){this.current=n,this.gl.uniformMatrix4fv(this.location,!1,n);break}}}}const d=new Float32Array(9),p=new Float32Array(4);class g extends bo{constructor(e){super(e),this.current=p}set(e,r,n){if(this.fetchUniformLocation(e,r)){for(let a=0;a<4;a++)if(n[a]!==this.current[a]){this.current=n,this.gl.uniformMatrix2fv(this.location,!1,n);break}}}}function v(t){return[mh(255*t.r,255*t.g),mh(255*t.b,255*t.a)]}class w{constructor(e,r,n){this.value=e,this.uniformNames=r.map(a=>`u_${a}`),this.type=n}setUniform(e,r,n,a,l){r.set(e,l,a.constantOr(this.value))}getBinding(e,r){return this.type==="color"?new i(e):new Hi(e)}}class M{constructor(e,r){this.uniformNames=r.map(n=>`u_${n}`),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(e){this.pixelRatio=e.pixelRatio||1,this.pattern=e.tl.concat(e.br)}setUniform(e,r,n,a,l){const h=l==="u_pattern"||l==="u_dash"?this.pattern:l==="u_pixel_ratio"?this.pixelRatio:null;h&&r.set(e,l,h)}getBinding(e,r){return r==="u_pattern"||r==="u_dash"?new c(e):new Hi(e)}}class I{constructor(e,r,n,a){this.expression=e,this.type=n,this.maxValue=0,this.paintVertexAttributes=r.map(l=>({name:`a_${l}`,type:"Float32",components:n==="color"?2:1,offset:0})),this.paintVertexArray=new a}populatePaintArray(e,r,n,a,l,h,f){const m=this.paintVertexArray.length,_=this.expression.evaluate(new ei(0,{brightness:h}),r,{},l,a,f);this.paintVertexArray.resize(e),this._setPaintValue(m,e,_)}updatePaintArray(e,r,n,a,l,h,f){const m=this.expression.evaluate({zoom:0,brightness:f},n,a,void 0,l);this._setPaintValue(e,r,m)}_setPaintValue(e,r,n){if(this.type==="color"){const a=v(n);for(let l=e;l<r;l++)this.paintVertexArray.emplace(l,a[0],a[1])}else{for(let a=e;a<r;a++)this.paintVertexArray.emplace(a,n);this.maxValue=Math.max(this.maxValue,Math.abs(n))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class S{constructor(e,r,n,a,l,h){this.expression=e,this.uniformNames=r.map(f=>`u_${f}_t`),this.type=n,this.useIntegerZoom=a,this.zoom=l,this.maxValue=0,this.paintVertexAttributes=r.map(f=>({name:`a_${f}`,type:"Float32",components:n==="color"?4:2,offset:0})),this.paintVertexArray=new h}populatePaintArray(e,r,n,a,l,h,f){const m=this.expression.evaluate(new ei(this.zoom,{brightness:h}),r,{},l,a,f),_=this.expression.evaluate(new ei(this.zoom+1,{brightness:h}),r,{},l,a,f),x=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(x,e,m,_)}updatePaintArray(e,r,n,a,l,h,f){const m=this.expression.evaluate({zoom:this.zoom,brightness:f},n,a,void 0,l),_=this.expression.evaluate({zoom:this.zoom+1,brightness:f},n,a,void 0,l);this._setPaintValue(e,r,m,_)}_setPaintValue(e,r,n,a){if(this.type==="color"){const l=v(n),h=v(a);for(let f=e;f<r;f++)this.paintVertexArray.emplace(f,l[0],l[1],h[0],h[1])}else{for(let l=e;l<r;l++)this.paintVertexArray.emplace(l,n,a);this.maxValue=Math.max(this.maxValue,Math.abs(n),Math.abs(a))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,r,n,a,l){const h=this.useIntegerZoom?Math.floor(n.zoom):n.zoom,f=Ut(this.expression.interpolationFactor(h,this.zoom,this.zoom+1),0,1);r.set(e,l,f)}getBinding(e,r){return new Hi(e)}}class z{constructor(e,r,n,a,l){this.expression=e,this.layerId=l,this.paintVertexAttributes=(n==="array"?ef:Qd).members;for(let h=0;h<r.length;++h);this.paintVertexArray=new a}populatePaintArray(e,r,n){const a=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValues(a,e,r.patterns&&r.patterns[this.layerId],n)}updatePaintArray(e,r,n,a,l,h,f){this._setPaintValues(e,r,n.patterns&&n.patterns[this.layerId],h)}_setPaintValues(e,r,n,a){if(!a||!n)return;const l=a[n];if(!l)return;const{tl:h,br:f,pixelRatio:m}=l;for(let _=e;_<r;_++)this.paintVertexArray.emplace(_,h[0],h[1],f[0],f[1],m)}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class R{constructor(e,r,n=()=>!0){this.binders={},this._buffers=[];const a=[];for(const l in e.paint._values){const h=e.paint.get(l);if(!n(l)||!(h instanceof aa&&tc(h.property.specification)))continue;const f=V(l,e.type),m=h.value,_=h.property.specification.type,x=!!h.property.useIntegerZoom,b=l==="line-dasharray"||l.endsWith("pattern"),T=l==="line-dasharray"&&e.layout.get("line-cap").value.kind!=="constant";if(m.kind!=="constant"||T)if(m.kind==="source"||T||b){const C=K(l,_,"source");this.binders[l]=b?new z(m,f,_,C,e.id):new I(m,f,_,C),a.push(`/a_${l}`)}else{const C=K(l,_,"composite");this.binders[l]=new S(m,f,_,x,r,C),a.push(`/z_${l}`)}else this.binders[l]=b?new M(m.value,f):new w(m.value,f,_),a.push(`/u_${l}`)}this.cacheKey=a.sort().join("")}getMaxValue(e){const r=this.binders[e];return r instanceof I||r instanceof S?r.maxValue:0}populatePaintArrays(e,r,n,a,l,h,f){for(const m in this.binders){const _=this.binders[m];(_ instanceof I||_ instanceof S||_ instanceof z)&&_.populatePaintArray(e,r,n,a,l,h,f)}}setConstantPatternPositions(e){for(const r in this.binders){const n=this.binders[r];n instanceof M&&n.setConstantPatternPositions(e)}}updatePaintArrays(e,r,n,a,l,h,f,m){let _=!1;const x=Object.keys(e),b=x.length!==0,T=b?x:r.uniqueIds;for(const C in this.binders){const P=this.binders[C];if((P instanceof I||P instanceof S||P instanceof z)&&(P.expression.isStateDependent===!0||P.expression.isLightConstant===!1)){const D=l.paint.get(C);P.expression=D.value;for(const O of T){const F=e[O.toString()];r.eachPosition(O,($,X,H)=>{const ne=a.feature($);P.updatePaintArray(X,H,ne,F,h,f,m)})}if(!b)for(const O of n.uniqueIds){const F=e[O.toString()];n.eachPosition(O,($,X,H)=>{const ne=a.feature($);P.updatePaintArray(X,H,ne,F,h,f,m)})}_=!0}}return _}defines(){const e=[];for(const r in this.binders){const n=this.binders[r];(n instanceof w||n instanceof M)&&e.push(...n.uniformNames.map(a=>`#define HAS_UNIFORM_${a}`))}return e}getBinderAttributes(){const e=[];for(const r in this.binders){const n=this.binders[r];if(n instanceof I||n instanceof S||n instanceof z)for(let a=0;a<n.paintVertexAttributes.length;a++)e.push(n.paintVertexAttributes[a].name)}return e}getBinderUniforms(){const e=[];for(const r in this.binders){const n=this.binders[r];if(n instanceof w||n instanceof M||n instanceof S)for(const a of n.uniformNames)e.push(a)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e){const r=[];for(const n in this.binders){const a=this.binders[n];if(a instanceof w||a instanceof M||a instanceof S)for(const l of a.uniformNames)r.push({name:l,property:n,binding:a.getBinding(e,l)})}return r}setUniforms(e,r,n,a,l){for(const{name:h,property:f,binding:m}of n)this.binders[f].setUniform(e,m,l,a.get(f),h)}updatePaintBuffers(){this._buffers=[];for(const e in this.binders){const r=this.binders[e];(r instanceof I||r instanceof S||r instanceof z)&&r.paintVertexBuffer&&this._buffers.push(r.paintVertexBuffer)}}upload(e){for(const r in this.binders){const n=this.binders[r];(n instanceof I||n instanceof S||n instanceof z)&&n.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const r=this.binders[e];(r instanceof I||r instanceof S||r instanceof z)&&r.destroy()}}}class U{constructor(e,r,n=()=>!0){this.programConfigurations={};for(const a of e)this.programConfigurations[a.id]=new R(a,r,n);this.needsUpload=!1,this._featureMap=new ml,this._featureMapWithoutIds=new ml,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(e,r,n,a,l,h,f,m){for(const _ in this.programConfigurations)this.programConfigurations[_].populatePaintArrays(e,r,a,l,h,f,m);r.id!==void 0?this._featureMap.add(r.id,n,this._bufferOffset,e):(this._featureMapWithoutIds.add(this._idlessCounter,n,this._bufferOffset,e),this._idlessCounter+=1),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,r,n,a,l,h){for(const f of n)this.needsUpload=this.programConfigurations[f.id].updatePaintArrays(e,this._featureMap,this._featureMapWithoutIds,r,f,a,l,h||0)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const r in this.programConfigurations)this.programConfigurations[r].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}const N={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]};function V(t,e){return N[t]||[t.replace(`${e}-`,"").replace(/-/g,"_")]}const B={"line-pattern":{source:Ko,composite:Ko},"fill-pattern":{source:Ko,composite:Ko},"fill-extrusion-pattern":{source:Ko,composite:Ko},"line-dasharray":{source:ca,composite:ca}},G={color:{source:ul,composite:Yo},number:{source:ll,composite:ul}};function K(t,e,r){const n=B[t];return n&&n[r]||G[e][r]}mt(w,"ConstantBinder"),mt(M,"PatternConstantBinder"),mt(I,"SourceExpressionBinder"),mt(z,"PatternCompositeBinder"),mt(S,"CompositeExpressionBinder"),mt(R,"ProgramConfiguration",{omit:["_buffers"]}),mt(U,"ProgramConfigurationSet");const q=ct/Math.PI/2,J=5,j=6,Q=16383,oe=64,le=[oe,32,16],he=-q,we=q;function me(t,e,r,n=q){return r=St(r),[t*Math.sin(r)*n,-e*n,t*Math.cos(r)*n]}function Ae(t,e,r){return me(Math.cos(St(t)),Math.sin(St(t)),e,r)}const Ie=63710088e-1,Ue=2*Math.PI*Ie;class ge{constructor(e,r){if(isNaN(e)||isNaN(r))throw new Error(`Invalid LngLat object: (${e}, ${r})`);if(this.lng=+e,this.lat=+r,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new ge(mn(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){const r=Math.PI/180,n=this.lat*r,a=e.lat*r,l=Math.sin(n)*Math.sin(a)+Math.cos(n)*Math.cos(a)*Math.cos((e.lng-this.lng)*r);return Ie*Math.acos(Math.min(l,1))}toBounds(e=0){const r=360*e/40075017,n=r/Math.cos(Math.PI/180*this.lat);return new Ee({lng:this.lng-n,lat:this.lat-r},{lng:this.lng+n,lat:this.lat+r})}toEcef(e){return Ae(this.lat,this.lng,q+e*q/Ie)}static convert(e){if(e instanceof ge)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new ge(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new ge(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class Ee{constructor(e,r){e&&(r?this.setSouthWest(e).setNorthEast(r):e.length===4?this.setSouthWest([e[0],e[1]]).setNorthEast([e[2],e[3]]):this.setSouthWest(e[0]).setNorthEast(e[1]))}setNorthEast(e){return this._ne=e instanceof ge?new ge(e.lng,e.lat):ge.convert(e),this}setSouthWest(e){return this._sw=e instanceof ge?new ge(e.lng,e.lat):ge.convert(e),this}extend(e){const r=this._sw,n=this._ne;let a,l;if(e instanceof ge)a=e,l=e;else{if(!(e instanceof Ee))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(Ee.convert(e)):this.extend(ge.convert(e)):typeof e=="object"&&e!==null&&e.hasOwnProperty("lat")&&(e.hasOwnProperty("lon")||e.hasOwnProperty("lng"))?this.extend(ge.convert(e)):this;if(a=e._sw,l=e._ne,!a||!l)return this}return r||n?(r.lng=Math.min(a.lng,r.lng),r.lat=Math.min(a.lat,r.lat),n.lng=Math.max(l.lng,n.lng),n.lat=Math.max(l.lat,n.lat)):(this._sw=new ge(a.lng,a.lat),this._ne=new ge(l.lng,l.lat)),this}getCenter(){return new ge((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new ge(this.getWest(),this.getNorth())}getSouthEast(){return new ge(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:r,lat:n}=ge.convert(e);let a=this._sw.lng<=r&&r<=this._ne.lng;return this._sw.lng>this._ne.lng&&(a=this._sw.lng>=r&&r>=this._ne.lng),this._sw.lat<=n&&n<=this._ne.lat&&a}static convert(e){return!e||e instanceof Ee?e:new Ee(e)}}var ue={};(function(t,e){(function(r){function n(l,h,f){var m=a(256*l,256*(h=Math.pow(2,f)-h-1),f),_=a(256*(l+1),256*(h+1),f);return m[0]+","+m[1]+","+_[0]+","+_[1]}function a(l,h,f){var m=2*Math.PI*6378137/256/Math.pow(2,f);return[l*m-2*Math.PI*6378137/2,h*m-2*Math.PI*6378137/2]}r.getURL=function(l,h,f,m,_,x){return x=x||{},l+"?"+["bbox="+n(f,m,_),"format="+(x.format||"image/png"),"service="+(x.service||"WMS"),"version="+(x.version||"1.1.1"),"request="+(x.request||"GetMap"),"srs="+(x.srs||"EPSG:3857"),"width="+(x.width||256),"height="+(x.height||256),"layers="+h].join("&")},r.getTileBBox=n,r.getMercCoords=a,Object.defineProperty(r,"__esModule",{value:!0})})(e)})(0,ue);var ve=ue;class Ve{constructor(e,r,n){this.z=e,this.x=r,this.y=n,this.key=ot(0,e,e,r,n)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}url(e,r){const n=ve.getTileBBox(this.x,this.y,this.z),a=function(l,h,f){let m,_="";for(let x=l;x>0;x--)m=1<<x-1,_+=(h&m?1:0)+(f&m?2:0);return _}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(r==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",a).replace("{bbox-epsg-3857}",n)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Ye{constructor(e,r){this.wrap=e,this.canonical=r,this.key=ot(e,r.z,r.z,r.x,r.y)}}class Xe{constructor(e,r,n,a,l){this.overscaledZ=e,this.wrap=r,this.canonical=new Ve(n,+a,+l),this.key=r===0&&e===n?this.canonical.key:ot(r,e,n,a,l)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){const r=this.canonical.z-e;return e>this.canonical.z?new Xe(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new Xe(e,this.wrap,e,this.canonical.x>>r,this.canonical.y>>r)}calculateScaledKey(e,r=!0){if(this.overscaledZ===e&&r)return this.key;if(e>this.canonical.z)return ot(this.wrap*+r,e,this.canonical.z,this.canonical.x,this.canonical.y);{const n=this.canonical.z-e;return ot(this.wrap*+r,e,e,this.canonical.x>>n,this.canonical.y>>n)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;const r=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.z<this.canonical.z&&e.canonical.x===this.canonical.x>>r&&e.canonical.y===this.canonical.y>>r}children(e){if(this.overscaledZ>=e)return[new Xe(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const r=this.canonical.z+1,n=2*this.canonical.x,a=2*this.canonical.y;return[new Xe(r,this.wrap,r,n,a),new Xe(r,this.wrap,r,n+1,a),new Xe(r,this.wrap,r,n,a+1),new Xe(r,this.wrap,r,n+1,a+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new Xe(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new Xe(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Ye(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function ot(t,e,r,n,a){const l=1<<Math.min(r,22);let h=l*(a%l)+n%l;return t&&r<22&&(h+=l*l*((t<0?-2*t-1:2*t)%(1<<2*(22-r)))),16*(32*h+r)+(e-r)}const yt=[t=>{let e=t.canonical.x-1,r=t.wrap;return e<0&&(e=(1<<t.canonical.z)-1,r--),new Xe(t.overscaledZ,r,t.canonical.z,e,t.canonical.y)},t=>{let e=t.canonical.x+1,r=t.wrap;return e===1<<t.canonical.z&&(e=0,r++),new Xe(t.overscaledZ,r,t.canonical.z,e,t.canonical.y)},t=>new Xe(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,(t.canonical.y===0?1<<t.canonical.z:t.canonical.y)-1),t=>new Xe(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y===(1<<t.canonical.z)-1?0:t.canonical.y+1)];mt(Ve,"CanonicalTileID"),mt(Xe,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const Pt=0,Tt=25.5;function It(t){return Ue*Math.cos(t*Math.PI/180)}function Yt(t){return(180+t)/360}function Vt(t){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+t*Math.PI/360)))/360}function qt(t,e){return t/It(e)}function $t(t){return 360*t-180}function fr(t){return 360/Math.PI*Math.atan(Math.exp((180-360*t)*Math.PI/180))-90}function Vr(t,e){return t*It(fr(e))}const nr=85.051129;function ri(t){return Math.cos(St(Ut(t,-nr,nr)))}function or(t,e){const r=Ut(e,Pt,Tt),n=Math.pow(2,r);return ri(t)*Ue/(512*n)}function yr(t){return 1/Math.cos(t*Math.PI/180)}function sr(t,e=0){const r=Math.exp(Math.PI*(1-(t.y+e/ct)/(1<<t.z)*2));return 80150034*r/(r*r+1)/ct/(1<<t.z)}class gr{constructor(e,r,n=0){this.x=+e,this.y=+r,this.z=+n}static fromLngLat(e,r=0){const n=ge.convert(e);return new gr(Yt(n.lng),Vt(n.lat),qt(r,n.lat))}toLngLat(){return new ge($t(this.x),fr(this.y))}toAltitude(){return Vr(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/Ue*yr(fr(this.y))}}function Gr(t,e,r,n,a,l,h,f,m){const _=(e+n)/2,x=(r+a)/2,b=new Ge(_,x);f(b),function(T,C,P,D,O,F){const $=P-O,X=D-F;return Math.abs((D-C)*$-(P-T)*X)/Math.hypot($,X)}(b.x,b.y,l.x,l.y,h.x,h.y)>=m?(Gr(t,e,r,_,x,l,b,f,m),Gr(t,_,x,n,a,b,h,f,m)):t.push(h)}function Tr(t,e,r){let n=t[0],a=n.x,l=n.y;e(n);const h=[n];for(let f=1;f<t.length;f++){const m=t[f],{x:_,y:x}=m;e(m),Gr(h,a,l,_,x,n,m,e,r),a=_,l=x,n=m}return h}function Pi(t,e,r,n){if(n(e,r)){const a=e.add(r)._mult(.5);Pi(t,e,a,n),Pi(t,a,r,n)}else t.push(r)}function Zi(t,e){let r=t[0];const n=[r];for(let a=1;a<t.length;a++){const l=t[a];Pi(n,r,l,e),r=l}return n}const cn=Math.pow(2,14)-1,no=-cn-1;function un(t,e){const r=Math.round(t.x*e),n=Math.round(t.y*e);return t.x=Ut(r,no,cn),t.y=Ut(n,no,cn),(r<t.x||r>t.x+1||n<t.y||n>t.y+1)&&li("Geometry exceeds allowed extent, reduce your vector tile buffer size"),t}function Li(t,e,r){const n=t.loadGeometry(),a=t.extent,l=ct/a;if(e&&r&&r.projection.isReprojectedInTileSpace){const h=1<<e.z,{scale:f,x:m,y:_,projection:x}=r,b=T=>{const C=$t((e.x+T.x/a)/h),P=fr((e.y+T.y/a)/h),D=x.project(C,P);T.x=(D.x*f-m)*a,T.y=(D.y*f-_)*a};for(let T=0;T<n.length;T++)if(t.type!==1)n[T]=Tr(n[T],b,1);else{const C=[];for(const P of n[T])P.x<0||P.x>=a||P.y<0||P.y>=a||(b(P),C.push(P));n[T]=C}}for(const h of n)for(const f of h)un(f,l);return n}function wi(t,e){return{type:t.type,id:t.id,properties:t.properties,geometry:e?Li(t):[]}}function Xi(t,e,r,n,a){t.emplaceBack(2*e+(n+1)/2,2*r+(a+1)/2)}function tn(t,e,r){t.emplaceBack(e.x,e.y,e.z,r[0]*16384,r[1]*16384,r[2]*16384)}class hn{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.fqid),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new qn,this.indexArray=new Si,this.segments=new ci,this.programConfigurations=new U(e.layers,e.zoom),this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(e,r,n,a){const l=this.layers[0],h=[];let f=null;l.type==="circle"&&(f=l.layout.get("circle-sort-key"));for(const{feature:_,id:x,index:b,sourceLayerIndex:T}of e){const C=this.layers[0]._featureFilter.needGeometry,P=wi(_,C);if(!this.layers[0]._featureFilter.filter(new ei(this.zoom),P,n))continue;const D=f?f.evaluate(P,{},n):void 0,O={id:x,properties:_.properties,type:_.type,sourceLayerIndex:T,index:b,geometry:C?P.geometry:Li(_,n,a),patterns:{},sortKey:D};h.push(O)}f&&h.sort((_,x)=>_.sortKey-x.sortKey);let m=null;a.projection.name==="globe"&&(this.globeExtVertexArray=new uc,m=a.projection);for(const _ of h){const{geometry:x,index:b,sourceLayerIndex:T}=_,C=e[b].feature;this.addFeature(_,x,b,r.availableImages,n,m,r.brightness),r.featureIndex.insert(C,x,b,T,this.index)}}update(e,r,n,a,l){const h=Object.keys(e).length!==0;h&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(e,r,h?this.stateDependentLayers:this.layers,n,a,l)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,nm.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,Jd.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(e,r,n,a,l,h,f){for(const m of r)for(const _ of m){const x=_.x,b=_.y;if(x<0||x>=ct||b<0||b>=ct)continue;if(h){const P=h.projectTilePoint(x,b,l),D=h.upVector(l,x,b),O=this.globeExtVertexArray;tn(O,P,D),tn(O,P,D),tn(O,P,D),tn(O,P,D)}const T=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),C=T.vertexLength;Xi(this.layoutVertexArray,x,b,-1,-1),Xi(this.layoutVertexArray,x,b,1,-1),Xi(this.layoutVertexArray,x,b,1,1),Xi(this.layoutVertexArray,x,b,-1,1),this.indexArray.emplaceBack(C,C+1,C+2),this.indexArray.emplaceBack(C,C+2,C+3),T.vertexLength+=4,T.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,n,{},a,l,f)}}function oo(t,e){for(let r=0;r<t.length;r++)if(wo(e,t[r]))return!0;for(let r=0;r<e.length;r++)if(wo(t,e[r]))return!0;return!!gl(t,e)}function es(t,e,r){return!!wo(t,e)||!!yl(e,t,r)}function Is(t,e){if(t.length===1)return _c(e,t[0]);for(let r=0;r<e.length;r++){const n=e[r];for(let a=0;a<n.length;a++)if(wo(t,n[a]))return!0}for(let r=0;r<t.length;r++)if(_c(e,t[r]))return!0;for(let r=0;r<e.length;r++)if(gl(t,e[r]))return!0;return!1}function _l(t,e,r){if(t.length>1){if(gl(t,e))return!0;for(let n=0;n<e.length;n++)if(yl(e[n],t,r))return!0}for(let n=0;n<t.length;n++)if(yl(t[n],e,r))return!0;return!1}function gl(t,e){if(t.length===0||e.length===0)return!1;for(let r=0;r<t.length-1;r++){const n=t[r],a=t[r+1];for(let l=0;l<e.length-1;l++)if(xh(n,a,e[l],e[l+1]))return!0}return!1}function xh(t,e,r,n){return Mn(t,r,n)!==Mn(e,r,n)&&Mn(t,e,r)!==Mn(t,e,n)}function yl(t,e,r){const n=r*r;if(e.length===1)return t.distSqr(e[0])<n;for(let a=1;a<e.length;a++)if(ha(t,e[a-1],e[a])<n)return!0;return!1}function ha(t,e,r){const n=e.distSqr(r);if(n===0)return t.distSqr(e);const a=((t.x-e.x)*(r.x-e.x)+(t.y-e.y)*(r.y-e.y))/n;return t.distSqr(a<0?e:a>1?r:r.sub(e)._mult(a)._add(e))}function _c(t,e){let r,n,a,l=!1;for(let h=0;h<t.length;h++){r=t[h];for(let f=0,m=r.length-1;f<r.length;m=f++)n=r[f],a=r[m],n.y>e.y!=a.y>e.y&&e.x<(a.x-n.x)*(e.y-n.y)/(a.y-n.y)+n.x&&(l=!l)}return l}function wo(t,e){let r=!1;for(let n=0,a=t.length-1;n<t.length;a=n++){const l=t[n],h=t[a];l.y>e.y!=h.y>e.y&&e.x<(h.x-l.x)*(e.y-l.y)/(h.y-l.y)+l.x&&(r=!r)}return r}function fg(t,e,r,n,a){for(const h of t)if(e<=h.x&&r<=h.y&&n>=h.x&&a>=h.y)return!0;const l=[new Ge(e,r),new Ge(e,a),new Ge(n,a),new Ge(n,r)];if(t.length>2){for(const h of l)if(wo(t,h))return!0}for(let h=0;h<t.length-1;h++)if(Xv(t[h],t[h+1],l))return!0;return!1}function Xv(t,e,r){const n=r[0],a=r[2];if(t.x<n.x&&e.x<n.x||t.x>a.x&&e.x>a.x||t.y<n.y&&e.y<n.y||t.y>a.y&&e.y>a.y)return!1;const l=Mn(t,e,r[0]);return l!==Mn(t,e,r[1])||l!==Mn(t,e,r[2])||l!==Mn(t,e,r[3])}function gc(t,e,r,n,a,l){let h=e.y-t.y,f=t.x-e.x;if(l=l||0){const m=h*h+f*f;if(m===0)return!0;const _=Math.sqrt(m);h/=_,f/=_}return!((r.x-t.x)*h+(r.y-t.y)*f-l<0||(n.x-t.x)*h+(n.y-t.y)*f-l<0||(a.x-t.x)*h+(a.y-t.y)*f-l<0)}function om(t,e,r,n,a,l,h){return!(gc(t,e,n,a,l,h)||gc(e,r,n,a,l,h)||gc(r,t,n,a,l,h)||gc(n,a,t,e,r,h)||gc(a,l,t,e,r,h)||gc(l,n,t,e,r,h))}function yc(t,e,r){const n=e.paint.get(t).value;return n.kind==="constant"?n.value:r.programConfigurations.get(e.id).getMaxValue(t)}function af(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])}function pg(t,e,r,n,a){if(!e[0]&&!e[1])return t;const l=Ge.convert(e)._mult(a);r==="viewport"&&l._rotate(-n);const h=[];for(let f=0;f<t.length;f++)h.push(t[f].sub(l));return h}function mg(t,e,r,n){const a=Ge.convert(t)._mult(n);return e==="viewport"&&a._rotate(-r),a}mt(hn,"CircleBucket",{omit:["layers"]});const Yv=new ti({"circle-sort-key":new Lt(be.layout_circle["circle-sort-key"]),visibility:new Je(be.layout_circle.visibility)});var Kv={paint:new ti({"circle-radius":new Lt(be.paint_circle["circle-radius"]),"circle-color":new Lt(be.paint_circle["circle-color"]),"circle-blur":new Lt(be.paint_circle["circle-blur"]),"circle-opacity":new Lt(be.paint_circle["circle-opacity"]),"circle-translate":new Je(be.paint_circle["circle-translate"]),"circle-translate-anchor":new Je(be.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Je(be.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Je(be.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Lt(be.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Lt(be.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Lt(be.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new Je(be.paint_circle["circle-emissive-strength"])}),layout:Yv},zi={},Ri={};Object.defineProperty(Ri,"__esModule",{value:!0}),Ri.setMatrixArrayType=function(t){Ri.ARRAY_TYPE=gg=t},Ri.toRadian=function(t){return t*Qv},Ri.equals=function(t,e){return Math.abs(t-e)<=_g*Math.max(1,Math.abs(t),Math.abs(e))},Ri.RANDOM=Ri.ARRAY_TYPE=Ri.EPSILON=void 0;var _g=1e-6;Ri.EPSILON=_g;var gg=typeof Float32Array<"u"?Float32Array:Array;Ri.ARRAY_TYPE=gg;var Jv=Math.random;Ri.RANDOM=Jv;var Qv=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var ii={};function sm(t){return sm=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},sm(t)}Object.defineProperty(ii,"__esModule",{value:!0}),ii.create=function(){var t=new da.ARRAY_TYPE(4);return da.ARRAY_TYPE!=Float32Array&&(t[1]=0,t[2]=0),t[0]=1,t[3]=1,t},ii.clone=function(t){var e=new da.ARRAY_TYPE(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},ii.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},ii.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t},ii.fromValues=function(t,e,r,n){var a=new da.ARRAY_TYPE(4);return a[0]=t,a[1]=e,a[2]=r,a[3]=n,a},ii.set=function(t,e,r,n,a){return t[0]=e,t[1]=r,t[2]=n,t[3]=a,t},ii.transpose=function(t,e){if(t===e){var r=e[1];t[1]=e[2],t[2]=r}else t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3];return t},ii.invert=function(t,e){var r=e[0],n=e[1],a=e[2],l=e[3],h=r*l-a*n;return h?(t[0]=l*(h=1/h),t[1]=-n*h,t[2]=-a*h,t[3]=r*h,t):null},ii.adjoint=function(t,e){var r=e[0];return t[0]=e[3],t[1]=-e[1],t[2]=-e[2],t[3]=r,t},ii.determinant=function(t){return t[0]*t[3]-t[2]*t[1]},ii.multiply=xg,ii.rotate=function(t,e,r){var n=e[0],a=e[1],l=e[2],h=e[3],f=Math.sin(r),m=Math.cos(r);return t[0]=n*m+l*f,t[1]=a*m+h*f,t[2]=n*-f+l*m,t[3]=a*-f+h*m,t},ii.scale=function(t,e,r){var n=e[1],a=e[2],l=e[3],h=r[0],f=r[1];return t[0]=e[0]*h,t[1]=n*h,t[2]=a*f,t[3]=l*f,t},ii.fromRotation=function(t,e){var r=Math.sin(e),n=Math.cos(e);return t[0]=n,t[1]=r,t[2]=-r,t[3]=n,t},ii.fromScaling=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t},ii.str=function(t){return"mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},ii.frob=function(t){return Math.hypot(t[0],t[1],t[2],t[3])},ii.LDU=function(t,e,r,n){return t[2]=n[2]/n[0],r[0]=n[0],r[1]=n[1],r[3]=n[3]-t[2]*r[1],[t,e,r]},ii.add=function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t},ii.subtract=vg,ii.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]},ii.equals=function(t,e){var r=t[0],n=t[1],a=t[2],l=t[3],h=e[0],f=e[1],m=e[2],_=e[3];return Math.abs(r-h)<=da.EPSILON*Math.max(1,Math.abs(r),Math.abs(h))&&Math.abs(n-f)<=da.EPSILON*Math.max(1,Math.abs(n),Math.abs(f))&&Math.abs(a-m)<=da.EPSILON*Math.max(1,Math.abs(a),Math.abs(m))&&Math.abs(l-_)<=da.EPSILON*Math.max(1,Math.abs(l),Math.abs(_))},ii.multiplyScalar=function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t},ii.multiplyScalarAndAdd=function(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t[2]=e[2]+r[2]*n,t[3]=e[3]+r[3]*n,t},ii.sub=ii.mul=void 0;var da=function(t,e){if(t&&t.__esModule)return t;if(t===null||sm(t)!=="object"&&typeof t!="function")return{default:t};var r=yg(void 0);if(r&&r.has(t))return r.get(t);var n={},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var l in t)if(l!=="default"&&Object.prototype.hasOwnProperty.call(t,l)){var h=a?Object.getOwnPropertyDescriptor(t,l):null;h&&(h.get||h.set)?Object.defineProperty(n,l,h):n[l]=t[l]}return n.default=t,r&&r.set(t,n),n}(Ri);function yg(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,r=new WeakMap;return(yg=function(n){return n?r:e})(t)}function xg(t,e,r){var n=e[0],a=e[1],l=e[2],h=e[3],f=r[0],m=r[1],_=r[2],x=r[3];return t[0]=n*f+l*m,t[1]=a*f+h*m,t[2]=n*_+l*x,t[3]=a*_+h*x,t}function vg(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t}ii.mul=xg,ii.sub=vg;var si={};function am(t){return am=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},am(t)}Object.defineProperty(si,"__esModule",{value:!0}),si.create=function(){var t=new ts.ARRAY_TYPE(6);return ts.ARRAY_TYPE!=Float32Array&&(t[1]=0,t[2]=0,t[4]=0,t[5]=0),t[0]=1,t[3]=1,t},si.clone=function(t){var e=new ts.ARRAY_TYPE(6);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},si.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},si.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t},si.fromValues=function(t,e,r,n,a,l){var h=new ts.ARRAY_TYPE(6);return h[0]=t,h[1]=e,h[2]=r,h[3]=n,h[4]=a,h[5]=l,h},si.set=function(t,e,r,n,a,l,h){return t[0]=e,t[1]=r,t[2]=n,t[3]=a,t[4]=l,t[5]=h,t},si.invert=function(t,e){var r=e[0],n=e[1],a=e[2],l=e[3],h=e[4],f=e[5],m=r*l-n*a;return m?(t[0]=l*(m=1/m),t[1]=-n*m,t[2]=-a*m,t[3]=r*m,t[4]=(a*f-l*h)*m,t[5]=(n*h-r*f)*m,t):null},si.determinant=function(t){return t[0]*t[3]-t[1]*t[2]},si.multiply=wg,si.rotate=function(t,e,r){var n=e[0],a=e[1],l=e[2],h=e[3],f=e[4],m=e[5],_=Math.sin(r),x=Math.cos(r);return t[0]=n*x+l*_,t[1]=a*x+h*_,t[2]=n*-_+l*x,t[3]=a*-_+h*x,t[4]=f,t[5]=m,t},si.scale=function(t,e,r){var n=e[1],a=e[2],l=e[3],h=e[4],f=e[5],m=r[0],_=r[1];return t[0]=e[0]*m,t[1]=n*m,t[2]=a*_,t[3]=l*_,t[4]=h,t[5]=f,t},si.translate=function(t,e,r){var n=e[0],a=e[1],l=e[2],h=e[3],f=e[4],m=e[5],_=r[0],x=r[1];return t[0]=n,t[1]=a,t[2]=l,t[3]=h,t[4]=n*_+l*x+f,t[5]=a*_+h*x+m,t},si.fromRotation=function(t,e){var r=Math.sin(e),n=Math.cos(e);return t[0]=n,t[1]=r,t[2]=-r,t[3]=n,t[4]=0,t[5]=0,t},si.fromScaling=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t[4]=0,t[5]=0,t},si.fromTranslation=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=e[0],t[5]=e[1],t},si.str=function(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"},si.frob=function(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],1)},si.add=function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t[4]=e[4]+r[4],t[5]=e[5]+r[5],t},si.subtract=Tg,si.multiplyScalar=function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*r,t[5]=e[5]*r,t},si.multiplyScalarAndAdd=function(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t[2]=e[2]+r[2]*n,t[3]=e[3]+r[3]*n,t[4]=e[4]+r[4]*n,t[5]=e[5]+r[5]*n,t},si.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]},si.equals=function(t,e){var r=t[0],n=t[1],a=t[2],l=t[3],h=t[4],f=t[5],m=e[0],_=e[1],x=e[2],b=e[3],T=e[4],C=e[5];return Math.abs(r-m)<=ts.EPSILON*Math.max(1,Math.abs(r),Math.abs(m))&&Math.abs(n-_)<=ts.EPSILON*Math.max(1,Math.abs(n),Math.abs(_))&&Math.abs(a-x)<=ts.EPSILON*Math.max(1,Math.abs(a),Math.abs(x))&&Math.abs(l-b)<=ts.EPSILON*Math.max(1,Math.abs(l),Math.abs(b))&&Math.abs(h-T)<=ts.EPSILON*Math.max(1,Math.abs(h),Math.abs(T))&&Math.abs(f-C)<=ts.EPSILON*Math.max(1,Math.abs(f),Math.abs(C))},si.sub=si.mul=void 0;var ts=function(t,e){if(t&&t.__esModule)return t;if(t===null||am(t)!=="object"&&typeof t!="function")return{default:t};var r=bg(void 0);if(r&&r.has(t))return r.get(t);var n={},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var l in t)if(l!=="default"&&Object.prototype.hasOwnProperty.call(t,l)){var h=a?Object.getOwnPropertyDescriptor(t,l):null;h&&(h.get||h.set)?Object.defineProperty(n,l,h):n[l]=t[l]}return n.default=t,r&&r.set(t,n),n}(Ri);function bg(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,r=new WeakMap;return(bg=function(n){return n?r:e})(t)}function wg(t,e,r){var n=e[0],a=e[1],l=e[2],h=e[3],f=e[4],m=e[5],_=r[0],x=r[1],b=r[2],T=r[3],C=r[4],P=r[5];return t[0]=n*_+l*x,t[1]=a*_+h*x,t[2]=n*b+l*T,t[3]=a*b+h*T,t[4]=n*C+l*P+f,t[5]=a*C+h*P+m,t}function Tg(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t[4]=e[4]-r[4],t[5]=e[5]-r[5],t}si.mul=wg,si.sub=Tg;var Nr={};function lm(t){return lm=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},lm(t)}Object.defineProperty(Nr,"__esModule",{value:!0}),Nr.create=function(){var t=new Wn.ARRAY_TYPE(9);return Wn.ARRAY_TYPE!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t},Nr.fromMat4=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},Nr.clone=function(t){var e=new Wn.ARRAY_TYPE(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},Nr.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},Nr.fromValues=function(t,e,r,n,a,l,h,f,m){var _=new Wn.ARRAY_TYPE(9);return _[0]=t,_[1]=e,_[2]=r,_[3]=n,_[4]=a,_[5]=l,_[6]=h,_[7]=f,_[8]=m,_},Nr.set=function(t,e,r,n,a,l,h,f,m,_){return t[0]=e,t[1]=r,t[2]=n,t[3]=a,t[4]=l,t[5]=h,t[6]=f,t[7]=m,t[8]=_,t},Nr.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},Nr.transpose=function(t,e){if(t===e){var r=e[1],n=e[2],a=e[5];t[1]=e[3],t[2]=e[6],t[3]=r,t[5]=e[7],t[6]=n,t[7]=a}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},Nr.invert=function(t,e){var r=e[0],n=e[1],a=e[2],l=e[3],h=e[4],f=e[5],m=e[6],_=e[7],x=e[8],b=x*h-f*_,T=-x*l+f*m,C=_*l-h*m,P=r*b+n*T+a*C;return P?(t[0]=b*(P=1/P),t[1]=(-x*n+a*_)*P,t[2]=(f*n-a*h)*P,t[3]=T*P,t[4]=(x*r-a*m)*P,t[5]=(-f*r+a*l)*P,t[6]=C*P,t[7]=(-_*r+n*m)*P,t[8]=(h*r-n*l)*P,t):null},Nr.adjoint=function(t,e){var r=e[0],n=e[1],a=e[2],l=e[3],h=e[4],f=e[5],m=e[6],_=e[7],x=e[8];return t[0]=h*x-f*_,t[1]=a*_-n*x,t[2]=n*f-a*h,t[3]=f*m-l*x,t[4]=r*x-a*m,t[5]=a*l-r*f,t[6]=l*_-h*m,t[7]=n*m-r*_,t[8]=r*h-n*l,t},Nr.determinant=function(t){var e=t[3],r=t[4],n=t[5],a=t[6],l=t[7],h=t[8];return t[0]*(h*r-n*l)+t[1]*(-h*e+n*a)+t[2]*(l*e-r*a)},Nr.multiply=Mg,Nr.translate=function(t,e,r){var n=e[0],a=e[1],l=e[2],h=e[3],f=e[4],m=e[5],_=e[6],x=e[7],b=e[8],T=r[0],C=r[1];return t[0]=n,t[1]=a,t[2]=l,t[3]=h,t[4]=f,t[5]=m,t[6]=T*n+C*h+_,t[7]=T*a+C*f+x,t[8]=T*l+C*m+b,t},Nr.rotate=function(t,e,r){var n=e[0],a=e[1],l=e[2],h=e[3],f=e[4],m=e[5],_=e[6],x=e[7],b=e[8],T=Math.sin(r),C=Math.cos(r);return t[0]=C*n+T*h,t[1]=C*a+T*f,t[2]=C*l+T*m,t[3]=C*h-T*n,t[4]=C*f-T*a,t[5]=C*m-T*l,t[6]=_,t[7]=x,t[8]=b,t},Nr.scale=function(t,e,r){var n=r[0],a=r[1];return t[0]=n*e[0],t[1]=n*e[1],t[2]=n*e[2],t[3]=a*e[3],t[4]=a*e[4],t[5]=a*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},Nr.fromTranslation=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=e[0],t[7]=e[1],t[8]=1,t},Nr.fromRotation=function(t,e){var r=Math.sin(e),n=Math.cos(e);return t[0]=n,t[1]=r,t[2]=0,t[3]=-r,t[4]=n,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},Nr.fromScaling=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=e[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},Nr.fromMat2d=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t},Nr.fromQuat=function(t,e){var r=e[0],n=e[1],a=e[2],l=e[3],h=r+r,f=n+n,m=a+a,_=r*h,x=n*h,b=n*f,T=a*h,C=a*f,P=a*m,D=l*h,O=l*f,F=l*m;return t[0]=1-b-P,t[3]=x-F,t[6]=T+O,t[1]=x+F,t[4]=1-_-P,t[7]=C-D,t[2]=T-O,t[5]=C+D,t[8]=1-_-b,t},Nr.normalFromMat4=function(t,e){var r=e[0],n=e[1],a=e[2],l=e[3],h=e[4],f=e[5],m=e[6],_=e[7],x=e[8],b=e[9],T=e[10],C=e[11],P=e[12],D=e[13],O=e[14],F=e[15],$=r*f-n*h,X=r*m-a*h,H=r*_-l*h,ne=n*m-a*f,re=n*_-l*f,ce=a*_-l*m,pe=x*D-b*P,ye=x*O-T*P,Te=x*F-C*P,xe=b*O-T*D,Se=b*F-C*D,Be=T*F-C*O,Ce=$*Be-X*Se+H*xe+ne*Te-re*ye+ce*pe;return Ce?(t[0]=(f*Be-m*Se+_*xe)*(Ce=1/Ce),t[1]=(m*Te-h*Be-_*ye)*Ce,t[2]=(h*Se-f*Te+_*pe)*Ce,t[3]=(a*Se-n*Be-l*xe)*Ce,t[4]=(r*Be-a*Te+l*ye)*Ce,t[5]=(n*Te-r*Se-l*pe)*Ce,t[6]=(D*ce-O*re+F*ne)*Ce,t[7]=(O*H-P*ce-F*X)*Ce,t[8]=(P*re-D*H+F*$)*Ce,t):null},Nr.projection=function(t,e,r){return t[0]=2/e,t[1]=0,t[2]=0,t[3]=0,t[4]=-2/r,t[5]=0,t[6]=-1,t[7]=1,t[8]=1,t},Nr.str=function(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"},Nr.frob=function(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])},Nr.add=function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t[4]=e[4]+r[4],t[5]=e[5]+r[5],t[6]=e[6]+r[6],t[7]=e[7]+r[7],t[8]=e[8]+r[8],t},Nr.subtract=Ig,Nr.multiplyScalar=function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*r,t},Nr.multiplyScalarAndAdd=function(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t[2]=e[2]+r[2]*n,t[3]=e[3]+r[3]*n,t[4]=e[4]+r[4]*n,t[5]=e[5]+r[5]*n,t[6]=e[6]+r[6]*n,t[7]=e[7]+r[7]*n,t[8]=e[8]+r[8]*n,t},Nr.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]},Nr.equals=function(t,e){var r=t[0],n=t[1],a=t[2],l=t[3],h=t[4],f=t[5],m=t[6],_=t[7],x=t[8],b=e[0],T=e[1],C=e[2],P=e[3],D=e[4],O=e[5],F=e[6],$=e[7],X=e[8];return Math.abs(r-b)<=Wn.EPSILON*Math.max(1,Math.abs(r),Math.abs(b))&&Math.abs(n-T)<=Wn.EPSILON*Math.max(1,Math.abs(n),Math.abs(T))&&Math.abs(a-C)<=Wn.EPSILON*Math.max(1,Math.abs(a),Math.abs(C))&&Math.abs(l-P)<=Wn.EPSILON*Math.max(1,Math.abs(l),Math.abs(P))&&Math.abs(h-D)<=Wn.EPSILON*Math.max(1,Math.abs(h),Math.abs(D))&&Math.abs(f-O)<=Wn.EPSILON*Math.max(1,Math.abs(f),Math.abs(O))&&Math.abs(m-F)<=Wn.EPSILON*Math.max(1,Math.abs(m),Math.abs(F))&&Math.abs(_-$)<=Wn.EPSILON*Math.max(1,Math.abs(_),Math.abs($))&&Math.abs(x-X)<=Wn.EPSILON*Math.max(1,Math.abs(x),Math.abs(X))},Nr.sub=Nr.mul=void 0;var Wn=function(t,e){if(t&&t.__esModule)return t;if(t===null||lm(t)!=="object"&&typeof t!="function")return{default:t};var r=Eg(void 0);if(r&&r.has(t))return r.get(t);var n={},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var l in t)if(l!=="default"&&Object.prototype.hasOwnProperty.call(t,l)){var h=a?Object.getOwnPropertyDescriptor(t,l):null;h&&(h.get||h.set)?Object.defineProperty(n,l,h):n[l]=t[l]}return n.default=t,r&&r.set(t,n),n}(Ri);function Eg(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,r=new WeakMap;return(Eg=function(n){return n?r:e})(t)}function Mg(t,e,r){var n=e[0],a=e[1],l=e[2],h=e[3],f=e[4],m=e[5],_=e[6],x=e[7],b=e[8],T=r[0],C=r[1],P=r[2],D=r[3],O=r[4],F=r[5],$=r[6],X=r[7],H=r[8];return t[0]=T*n+C*h+P*_,t[1]=T*a+C*f+P*x,t[2]=T*l+C*m+P*b,t[3]=D*n+O*h+F*_,t[4]=D*a+O*f+F*x,t[5]=D*l+O*m+F*b,t[6]=$*n+X*h+H*_,t[7]=$*a+X*f+H*x,t[8]=$*l+X*m+H*b,t}function Ig(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t[4]=e[4]-r[4],t[5]=e[5]-r[5],t[6]=e[6]-r[6],t[7]=e[7]-r[7],t[8]=e[8]-r[8],t}Nr.mul=Mg,Nr.sub=Ig;var Jt={};function cm(t){return cm=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},cm(t)}Object.defineProperty(Jt,"__esModule",{value:!0}),Jt.create=function(){var t=new hi.ARRAY_TYPE(16);return hi.ARRAY_TYPE!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t},Jt.clone=function(t){var e=new hi.ARRAY_TYPE(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},Jt.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},Jt.fromValues=function(t,e,r,n,a,l,h,f,m,_,x,b,T,C,P,D){var O=new hi.ARRAY_TYPE(16);return O[0]=t,O[1]=e,O[2]=r,O[3]=n,O[4]=a,O[5]=l,O[6]=h,O[7]=f,O[8]=m,O[9]=_,O[10]=x,O[11]=b,O[12]=T,O[13]=C,O[14]=P,O[15]=D,O},Jt.set=function(t,e,r,n,a,l,h,f,m,_,x,b,T,C,P,D,O){return t[0]=e,t[1]=r,t[2]=n,t[3]=a,t[4]=l,t[5]=h,t[6]=f,t[7]=m,t[8]=_,t[9]=x,t[10]=b,t[11]=T,t[12]=C,t[13]=P,t[14]=D,t[15]=O,t},Jt.identity=Ag,Jt.transpose=function(t,e){if(t===e){var r=e[1],n=e[2],a=e[3],l=e[6],h=e[7],f=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=r,t[6]=e[9],t[7]=e[13],t[8]=n,t[9]=l,t[11]=e[14],t[12]=a,t[13]=h,t[14]=f}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t},Jt.invert=function(t,e){var r=e[0],n=e[1],a=e[2],l=e[3],h=e[4],f=e[5],m=e[6],_=e[7],x=e[8],b=e[9],T=e[10],C=e[11],P=e[12],D=e[13],O=e[14],F=e[15],$=r*f-n*h,X=r*m-a*h,H=r*_-l*h,ne=n*m-a*f,re=n*_-l*f,ce=a*_-l*m,pe=x*D-b*P,ye=x*O-T*P,Te=x*F-C*P,xe=b*O-T*D,Se=b*F-C*D,Be=T*F-C*O,Ce=$*Be-X*Se+H*xe+ne*Te-re*ye+ce*pe;return Ce?(t[0]=(f*Be-m*Se+_*xe)*(Ce=1/Ce),t[1]=(a*Se-n*Be-l*xe)*Ce,t[2]=(D*ce-O*re+F*ne)*Ce,t[3]=(T*re-b*ce-C*ne)*Ce,t[4]=(m*Te-h*Be-_*ye)*Ce,t[5]=(r*Be-a*Te+l*ye)*Ce,t[6]=(O*H-P*ce-F*X)*Ce,t[7]=(x*ce-T*H+C*X)*Ce,t[8]=(h*Se-f*Te+_*pe)*Ce,t[9]=(n*Te-r*Se-l*pe)*Ce,t[10]=(P*re-D*H+F*$)*Ce,t[11]=(b*H-x*re-C*$)*Ce,t[12]=(f*ye-h*xe-m*pe)*Ce,t[13]=(r*xe-n*ye+a*pe)*Ce,t[14]=(D*X-P*ne-O*$)*Ce,t[15]=(x*ne-b*X+T*$)*Ce,t):null},Jt.adjoint=function(t,e){var r=e[0],n=e[1],a=e[2],l=e[3],h=e[4],f=e[5],m=e[6],_=e[7],x=e[8],b=e[9],T=e[10],C=e[11],P=e[12],D=e[13],O=e[14],F=e[15];return t[0]=f*(T*F-C*O)-b*(m*F-_*O)+D*(m*C-_*T),t[1]=-(n*(T*F-C*O)-b*(a*F-l*O)+D*(a*C-l*T)),t[2]=n*(m*F-_*O)-f*(a*F-l*O)+D*(a*_-l*m),t[3]=-(n*(m*C-_*T)-f*(a*C-l*T)+b*(a*_-l*m)),t[4]=-(h*(T*F-C*O)-x*(m*F-_*O)+P*(m*C-_*T)),t[5]=r*(T*F-C*O)-x*(a*F-l*O)+P*(a*C-l*T),t[6]=-(r*(m*F-_*O)-h*(a*F-l*O)+P*(a*_-l*m)),t[7]=r*(m*C-_*T)-h*(a*C-l*T)+x*(a*_-l*m),t[8]=h*(b*F-C*D)-x*(f*F-_*D)+P*(f*C-_*b),t[9]=-(r*(b*F-C*D)-x*(n*F-l*D)+P*(n*C-l*b)),t[10]=r*(f*F-_*D)-h*(n*F-l*D)+P*(n*_-l*f),t[11]=-(r*(f*C-_*b)-h*(n*C-l*b)+x*(n*_-l*f)),t[12]=-(h*(b*O-T*D)-x*(f*O-m*D)+P*(f*T-m*b)),t[13]=r*(b*O-T*D)-x*(n*O-a*D)+P*(n*T-a*b),t[14]=-(r*(f*O-m*D)-h*(n*O-a*D)+P*(n*m-a*f)),t[15]=r*(f*T-m*b)-h*(n*T-a*b)+x*(n*m-a*f),t},Jt.determinant=function(t){var e=t[0],r=t[1],n=t[2],a=t[3],l=t[4],h=t[5],f=t[6],m=t[7],_=t[8],x=t[9],b=t[10],T=t[11],C=t[12],P=t[13],D=t[14],O=t[15];return(e*h-r*l)*(b*O-T*D)-(e*f-n*l)*(x*O-T*P)+(e*m-a*l)*(x*D-b*P)+(r*f-n*h)*(_*O-T*C)-(r*m-a*h)*(_*D-b*C)+(n*m-a*f)*(_*P-x*C)},Jt.multiply=Sg,Jt.translate=function(t,e,r){var n,a,l,h,f,m,_,x,b,T,C,P,D=r[0],O=r[1],F=r[2];return e===t?(t[12]=e[0]*D+e[4]*O+e[8]*F+e[12],t[13]=e[1]*D+e[5]*O+e[9]*F+e[13],t[14]=e[2]*D+e[6]*O+e[10]*F+e[14],t[15]=e[3]*D+e[7]*O+e[11]*F+e[15]):(a=e[1],l=e[2],h=e[3],f=e[4],m=e[5],_=e[6],x=e[7],b=e[8],T=e[9],C=e[10],P=e[11],t[0]=n=e[0],t[1]=a,t[2]=l,t[3]=h,t[4]=f,t[5]=m,t[6]=_,t[7]=x,t[8]=b,t[9]=T,t[10]=C,t[11]=P,t[12]=n*D+f*O+b*F+e[12],t[13]=a*D+m*O+T*F+e[13],t[14]=l*D+_*O+C*F+e[14],t[15]=h*D+x*O+P*F+e[15]),t},Jt.scale=function(t,e,r){var n=r[0],a=r[1],l=r[2];return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*a,t[5]=e[5]*a,t[6]=e[6]*a,t[7]=e[7]*a,t[8]=e[8]*l,t[9]=e[9]*l,t[10]=e[10]*l,t[11]=e[11]*l,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},Jt.rotate=function(t,e,r,n){var a,l,h,f,m,_,x,b,T,C,P,D,O,F,$,X,H,ne,re,ce,pe,ye,Te,xe,Se=n[0],Be=n[1],Ce=n[2],Oe=Math.hypot(Se,Be,Ce);return Oe<hi.EPSILON?null:(Se*=Oe=1/Oe,Be*=Oe,Ce*=Oe,a=Math.sin(r),l=Math.cos(r),m=e[1],_=e[2],x=e[3],T=e[5],C=e[6],P=e[7],O=e[9],F=e[10],$=e[11],X=Se*Se*(h=1-l)+l,re=Se*Be*h-Ce*a,ce=Be*Be*h+l,pe=Ce*Be*h+Se*a,ye=Se*Ce*h+Be*a,Te=Be*Ce*h-Se*a,xe=Ce*Ce*h+l,t[0]=(f=e[0])*X+(b=e[4])*(H=Be*Se*h+Ce*a)+(D=e[8])*(ne=Ce*Se*h-Be*a),t[1]=m*X+T*H+O*ne,t[2]=_*X+C*H+F*ne,t[3]=x*X+P*H+$*ne,t[4]=f*re+b*ce+D*pe,t[5]=m*re+T*ce+O*pe,t[6]=_*re+C*ce+F*pe,t[7]=x*re+P*ce+$*pe,t[8]=f*ye+b*Te+D*xe,t[9]=m*ye+T*Te+O*xe,t[10]=_*ye+C*Te+F*xe,t[11]=x*ye+P*Te+$*xe,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)},Jt.rotateX=function(t,e,r){var n=Math.sin(r),a=Math.cos(r),l=e[4],h=e[5],f=e[6],m=e[7],_=e[8],x=e[9],b=e[10],T=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=l*a+_*n,t[5]=h*a+x*n,t[6]=f*a+b*n,t[7]=m*a+T*n,t[8]=_*a-l*n,t[9]=x*a-h*n,t[10]=b*a-f*n,t[11]=T*a-m*n,t},Jt.rotateY=function(t,e,r){var n=Math.sin(r),a=Math.cos(r),l=e[0],h=e[1],f=e[2],m=e[3],_=e[8],x=e[9],b=e[10],T=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=l*a-_*n,t[1]=h*a-x*n,t[2]=f*a-b*n,t[3]=m*a-T*n,t[8]=l*n+_*a,t[9]=h*n+x*a,t[10]=f*n+b*a,t[11]=m*n+T*a,t},Jt.rotateZ=function(t,e,r){var n=Math.sin(r),a=Math.cos(r),l=e[0],h=e[1],f=e[2],m=e[3],_=e[4],x=e[5],b=e[6],T=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=l*a+_*n,t[1]=h*a+x*n,t[2]=f*a+b*n,t[3]=m*a+T*n,t[4]=_*a-l*n,t[5]=x*a-h*n,t[6]=b*a-f*n,t[7]=T*a-m*n,t},Jt.fromTranslation=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t},Jt.fromScaling=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},Jt.fromRotation=function(t,e,r){var n,a,l,h=r[0],f=r[1],m=r[2],_=Math.hypot(h,f,m);return _<hi.EPSILON?null:(h*=_=1/_,f*=_,m*=_,n=Math.sin(e),a=Math.cos(e),t[0]=h*h*(l=1-a)+a,t[1]=f*h*l+m*n,t[2]=m*h*l-f*n,t[3]=0,t[4]=h*f*l-m*n,t[5]=f*f*l+a,t[6]=m*f*l+h*n,t[7]=0,t[8]=h*m*l+f*n,t[9]=f*m*l-h*n,t[10]=m*m*l+a,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)},Jt.fromXRotation=function(t,e){var r=Math.sin(e),n=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n,t[6]=r,t[7]=0,t[8]=0,t[9]=-r,t[10]=n,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},Jt.fromYRotation=function(t,e){var r=Math.sin(e),n=Math.cos(e);return t[0]=n,t[1]=0,t[2]=-r,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=r,t[9]=0,t[10]=n,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},Jt.fromZRotation=function(t,e){var r=Math.sin(e),n=Math.cos(e);return t[0]=n,t[1]=r,t[2]=0,t[3]=0,t[4]=-r,t[5]=n,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},Jt.fromRotationTranslation=Pg,Jt.fromQuat2=function(t,e){var r=new hi.ARRAY_TYPE(3),n=-e[0],a=-e[1],l=-e[2],h=e[3],f=e[4],m=e[5],_=e[6],x=e[7],b=n*n+a*a+l*l+h*h;return b>0?(r[0]=2*(f*h+x*n+m*l-_*a)/b,r[1]=2*(m*h+x*a+_*n-f*l)/b,r[2]=2*(_*h+x*l+f*a-m*n)/b):(r[0]=2*(f*h+x*n+m*l-_*a),r[1]=2*(m*h+x*a+_*n-f*l),r[2]=2*(_*h+x*l+f*a-m*n)),Pg(t,e,r),t},Jt.getTranslation=function(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t},Jt.getScaling=Lg,Jt.getRotation=function(t,e){var r=new hi.ARRAY_TYPE(3);Lg(r,e);var n=1/r[0],a=1/r[1],l=1/r[2],h=e[0]*n,f=e[1]*a,m=e[2]*l,_=e[4]*n,x=e[5]*a,b=e[6]*l,T=e[8]*n,C=e[9]*a,P=e[10]*l,D=h+x+P,O=0;return D>0?(O=2*Math.sqrt(D+1),t[3]=.25*O,t[0]=(b-C)/O,t[1]=(T-m)/O,t[2]=(f-_)/O):h>x&&h>P?(O=2*Math.sqrt(1+h-x-P),t[3]=(b-C)/O,t[0]=.25*O,t[1]=(f+_)/O,t[2]=(T+m)/O):x>P?(O=2*Math.sqrt(1+x-h-P),t[3]=(T-m)/O,t[0]=(f+_)/O,t[1]=.25*O,t[2]=(b+C)/O):(O=2*Math.sqrt(1+P-h-x),t[3]=(f-_)/O,t[0]=(T+m)/O,t[1]=(b+C)/O,t[2]=.25*O),t},Jt.fromRotationTranslationScale=function(t,e,r,n){var a=e[0],l=e[1],h=e[2],f=e[3],m=a+a,_=l+l,x=h+h,b=a*m,T=a*_,C=a*x,P=l*_,D=l*x,O=h*x,F=f*m,$=f*_,X=f*x,H=n[0],ne=n[1],re=n[2];return t[0]=(1-(P+O))*H,t[1]=(T+X)*H,t[2]=(C-$)*H,t[3]=0,t[4]=(T-X)*ne,t[5]=(1-(b+O))*ne,t[6]=(D+F)*ne,t[7]=0,t[8]=(C+$)*re,t[9]=(D-F)*re,t[10]=(1-(b+P))*re,t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t},Jt.fromRotationTranslationScaleOrigin=function(t,e,r,n,a){var l=e[0],h=e[1],f=e[2],m=e[3],_=l+l,x=h+h,b=f+f,T=l*_,C=l*x,P=l*b,D=h*x,O=h*b,F=f*b,$=m*_,X=m*x,H=m*b,ne=n[0],re=n[1],ce=n[2],pe=a[0],ye=a[1],Te=a[2],xe=(1-(D+F))*ne,Se=(C+H)*ne,Be=(P-X)*ne,Ce=(C-H)*re,Oe=(1-(T+F))*re,Me=(O+$)*re,Re=(P+X)*ce,et=(O-$)*ce,Ne=(1-(T+D))*ce;return t[0]=xe,t[1]=Se,t[2]=Be,t[3]=0,t[4]=Ce,t[5]=Oe,t[6]=Me,t[7]=0,t[8]=Re,t[9]=et,t[10]=Ne,t[11]=0,t[12]=r[0]+pe-(xe*pe+Ce*ye+Re*Te),t[13]=r[1]+ye-(Se*pe+Oe*ye+et*Te),t[14]=r[2]+Te-(Be*pe+Me*ye+Ne*Te),t[15]=1,t},Jt.fromQuat=function(t,e){var r=e[0],n=e[1],a=e[2],l=e[3],h=r+r,f=n+n,m=a+a,_=r*h,x=n*h,b=n*f,T=a*h,C=a*f,P=a*m,D=l*h,O=l*f,F=l*m;return t[0]=1-b-P,t[1]=x+F,t[2]=T-O,t[3]=0,t[4]=x-F,t[5]=1-_-P,t[6]=C+D,t[7]=0,t[8]=T+O,t[9]=C-D,t[10]=1-_-b,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},Jt.frustum=function(t,e,r,n,a,l,h){var f=1/(r-e),m=1/(a-n),_=1/(l-h);return t[0]=2*l*f,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*l*m,t[6]=0,t[7]=0,t[8]=(r+e)*f,t[9]=(a+n)*m,t[10]=(h+l)*_,t[11]=-1,t[12]=0,t[13]=0,t[14]=h*l*2*_,t[15]=0,t},Jt.perspectiveNO=Dg,Jt.perspectiveZO=function(t,e,r,n,a){var l,h=1/Math.tan(e/2);return t[0]=h/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,a!=null&&a!==1/0?(t[10]=a*(l=1/(n-a)),t[14]=a*n*l):(t[10]=-1,t[14]=-n),t},Jt.perspectiveFromFieldOfView=function(t,e,r,n){var a=Math.tan(e.upDegrees*Math.PI/180),l=Math.tan(e.downDegrees*Math.PI/180),h=Math.tan(e.leftDegrees*Math.PI/180),f=Math.tan(e.rightDegrees*Math.PI/180),m=2/(h+f),_=2/(a+l);return t[0]=m,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=_,t[6]=0,t[7]=0,t[8]=-(h-f)*m*.5,t[9]=(a-l)*_*.5,t[10]=n/(r-n),t[11]=-1,t[12]=0,t[13]=0,t[14]=n*r/(r-n),t[15]=0,t},Jt.orthoNO=zg,Jt.orthoZO=function(t,e,r,n,a,l,h){var f=1/(e-r),m=1/(n-a),_=1/(l-h);return t[0]=-2*f,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*m,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=_,t[11]=0,t[12]=(e+r)*f,t[13]=(a+n)*m,t[14]=l*_,t[15]=1,t},Jt.lookAt=function(t,e,r,n){var a,l,h,f,m,_,x,b,T,C,P=e[0],D=e[1],O=e[2],F=n[0],$=n[1],X=n[2],H=r[0],ne=r[1],re=r[2];return Math.abs(P-H)<hi.EPSILON&&Math.abs(D-ne)<hi.EPSILON&&Math.abs(O-re)<hi.EPSILON?Ag(t):(x=P-H,b=D-ne,T=O-re,a=$*(T*=C=1/Math.hypot(x,b,T))-X*(b*=C),l=X*(x*=C)-F*T,h=F*b-$*x,(C=Math.hypot(a,l,h))?(a*=C=1/C,l*=C,h*=C):(a=0,l=0,h=0),f=b*h-T*l,m=T*a-x*h,_=x*l-b*a,(C=Math.hypot(f,m,_))?(f*=C=1/C,m*=C,_*=C):(f=0,m=0,_=0),t[0]=a,t[1]=f,t[2]=x,t[3]=0,t[4]=l,t[5]=m,t[6]=b,t[7]=0,t[8]=h,t[9]=_,t[10]=T,t[11]=0,t[12]=-(a*P+l*D+h*O),t[13]=-(f*P+m*D+_*O),t[14]=-(x*P+b*D+T*O),t[15]=1,t)},Jt.targetTo=function(t,e,r,n){var a=e[0],l=e[1],h=e[2],f=n[0],m=n[1],_=n[2],x=a-r[0],b=l-r[1],T=h-r[2],C=x*x+b*b+T*T;C>0&&(x*=C=1/Math.sqrt(C),b*=C,T*=C);var P=m*T-_*b,D=_*x-f*T,O=f*b-m*x;return(C=P*P+D*D+O*O)>0&&(P*=C=1/Math.sqrt(C),D*=C,O*=C),t[0]=P,t[1]=D,t[2]=O,t[3]=0,t[4]=b*O-T*D,t[5]=T*P-x*O,t[6]=x*D-b*P,t[7]=0,t[8]=x,t[9]=b,t[10]=T,t[11]=0,t[12]=a,t[13]=l,t[14]=h,t[15]=1,t},Jt.str=function(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"},Jt.frob=function(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])},Jt.add=function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t[4]=e[4]+r[4],t[5]=e[5]+r[5],t[6]=e[6]+r[6],t[7]=e[7]+r[7],t[8]=e[8]+r[8],t[9]=e[9]+r[9],t[10]=e[10]+r[10],t[11]=e[11]+r[11],t[12]=e[12]+r[12],t[13]=e[13]+r[13],t[14]=e[14]+r[14],t[15]=e[15]+r[15],t},Jt.subtract=Rg,Jt.multiplyScalar=function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*r,t[9]=e[9]*r,t[10]=e[10]*r,t[11]=e[11]*r,t[12]=e[12]*r,t[13]=e[13]*r,t[14]=e[14]*r,t[15]=e[15]*r,t},Jt.multiplyScalarAndAdd=function(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t[2]=e[2]+r[2]*n,t[3]=e[3]+r[3]*n,t[4]=e[4]+r[4]*n,t[5]=e[5]+r[5]*n,t[6]=e[6]+r[6]*n,t[7]=e[7]+r[7]*n,t[8]=e[8]+r[8]*n,t[9]=e[9]+r[9]*n,t[10]=e[10]+r[10]*n,t[11]=e[11]+r[11]*n,t[12]=e[12]+r[12]*n,t[13]=e[13]+r[13]*n,t[14]=e[14]+r[14]*n,t[15]=e[15]+r[15]*n,t},Jt.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]},Jt.equals=function(t,e){var r=t[0],n=t[1],a=t[2],l=t[3],h=t[4],f=t[5],m=t[6],_=t[7],x=t[8],b=t[9],T=t[10],C=t[11],P=t[12],D=t[13],O=t[14],F=t[15],$=e[0],X=e[1],H=e[2],ne=e[3],re=e[4],ce=e[5],pe=e[6],ye=e[7],Te=e[8],xe=e[9],Se=e[10],Be=e[11],Ce=e[12],Oe=e[13],Me=e[14],Re=e[15];return Math.abs(r-$)<=hi.EPSILON*Math.max(1,Math.abs(r),Math.abs($))&&Math.abs(n-X)<=hi.EPSILON*Math.max(1,Math.abs(n),Math.abs(X))&&Math.abs(a-H)<=hi.EPSILON*Math.max(1,Math.abs(a),Math.abs(H))&&Math.abs(l-ne)<=hi.EPSILON*Math.max(1,Math.abs(l),Math.abs(ne))&&Math.abs(h-re)<=hi.EPSILON*Math.max(1,Math.abs(h),Math.abs(re))&&Math.abs(f-ce)<=hi.EPSILON*Math.max(1,Math.abs(f),Math.abs(ce))&&Math.abs(m-pe)<=hi.EPSILON*Math.max(1,Math.abs(m),Math.abs(pe))&&Math.abs(_-ye)<=hi.EPSILON*Math.max(1,Math.abs(_),Math.abs(ye))&&Math.abs(x-Te)<=hi.EPSILON*Math.max(1,Math.abs(x),Math.abs(Te))&&Math.abs(b-xe)<=hi.EPSILON*Math.max(1,Math.abs(b),Math.abs(xe))&&Math.abs(T-Se)<=hi.EPSILON*Math.max(1,Math.abs(T),Math.abs(Se))&&Math.abs(C-Be)<=hi.EPSILON*Math.max(1,Math.abs(C),Math.abs(Be))&&Math.abs(P-Ce)<=hi.EPSILON*Math.max(1,Math.abs(P),Math.abs(Ce))&&Math.abs(D-Oe)<=hi.EPSILON*Math.max(1,Math.abs(D),Math.abs(Oe))&&Math.abs(O-Me)<=hi.EPSILON*Math.max(1,Math.abs(O),Math.abs(Me))&&Math.abs(F-Re)<=hi.EPSILON*Math.max(1,Math.abs(F),Math.abs(Re))},Jt.sub=Jt.mul=Jt.ortho=Jt.perspective=void 0;var hi=function(t,e){if(t&&t.__esModule)return t;if(t===null||cm(t)!=="object"&&typeof t!="function")return{default:t};var r=Cg(void 0);if(r&&r.has(t))return r.get(t);var n={},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var l in t)if(l!=="default"&&Object.prototype.hasOwnProperty.call(t,l)){var h=a?Object.getOwnPropertyDescriptor(t,l):null;h&&(h.get||h.set)?Object.defineProperty(n,l,h):n[l]=t[l]}return n.default=t,r&&r.set(t,n),n}(Ri);function Cg(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,r=new WeakMap;return(Cg=function(n){return n?r:e})(t)}function Ag(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Sg(t,e,r){var n=e[0],a=e[1],l=e[2],h=e[3],f=e[4],m=e[5],_=e[6],x=e[7],b=e[8],T=e[9],C=e[10],P=e[11],D=e[12],O=e[13],F=e[14],$=e[15],X=r[0],H=r[1],ne=r[2],re=r[3];return t[0]=X*n+H*f+ne*b+re*D,t[1]=X*a+H*m+ne*T+re*O,t[2]=X*l+H*_+ne*C+re*F,t[3]=X*h+H*x+ne*P+re*$,t[4]=(X=r[4])*n+(H=r[5])*f+(ne=r[6])*b+(re=r[7])*D,t[5]=X*a+H*m+ne*T+re*O,t[6]=X*l+H*_+ne*C+re*F,t[7]=X*h+H*x+ne*P+re*$,t[8]=(X=r[8])*n+(H=r[9])*f+(ne=r[10])*b+(re=r[11])*D,t[9]=X*a+H*m+ne*T+re*O,t[10]=X*l+H*_+ne*C+re*F,t[11]=X*h+H*x+ne*P+re*$,t[12]=(X=r[12])*n+(H=r[13])*f+(ne=r[14])*b+(re=r[15])*D,t[13]=X*a+H*m+ne*T+re*O,t[14]=X*l+H*_+ne*C+re*F,t[15]=X*h+H*x+ne*P+re*$,t}function Pg(t,e,r){var n=e[0],a=e[1],l=e[2],h=e[3],f=n+n,m=a+a,_=l+l,x=n*f,b=n*m,T=n*_,C=a*m,P=a*_,D=l*_,O=h*f,F=h*m,$=h*_;return t[0]=1-(C+D),t[1]=b+$,t[2]=T-F,t[3]=0,t[4]=b-$,t[5]=1-(x+D),t[6]=P+O,t[7]=0,t[8]=T+F,t[9]=P-O,t[10]=1-(x+C),t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t}function Lg(t,e){var r=e[4],n=e[5],a=e[6],l=e[8],h=e[9],f=e[10];return t[0]=Math.hypot(e[0],e[1],e[2]),t[1]=Math.hypot(r,n,a),t[2]=Math.hypot(l,h,f),t}function Dg(t,e,r,n,a){var l,h=1/Math.tan(e/2);return t[0]=h/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,a!=null&&a!==1/0?(t[10]=(a+n)*(l=1/(n-a)),t[14]=2*a*n*l):(t[10]=-1,t[14]=-2*n),t}function zg(t,e,r,n,a,l,h){var f=1/(e-r),m=1/(n-a),_=1/(l-h);return t[0]=-2*f,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*m,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*_,t[11]=0,t[12]=(e+r)*f,t[13]=(a+n)*m,t[14]=(h+l)*_,t[15]=1,t}function Rg(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t[4]=e[4]-r[4],t[5]=e[5]-r[5],t[6]=e[6]-r[6],t[7]=e[7]-r[7],t[8]=e[8]-r[8],t[9]=e[9]-r[9],t[10]=e[10]-r[10],t[11]=e[11]-r[11],t[12]=e[12]-r[12],t[13]=e[13]-r[13],t[14]=e[14]-r[14],t[15]=e[15]-r[15],t}Jt.perspective=Dg,Jt.ortho=zg,Jt.mul=Sg,Jt.sub=Rg;var Ht={},Kt={};function um(t){return um=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},um(t)}Object.defineProperty(Kt,"__esModule",{value:!0}),Kt.create=kg,Kt.clone=function(t){var e=new Cs.ARRAY_TYPE(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},Kt.length=Bg,Kt.fromValues=function(t,e,r){var n=new Cs.ARRAY_TYPE(3);return n[0]=t,n[1]=e,n[2]=r,n},Kt.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},Kt.set=function(t,e,r,n){return t[0]=e,t[1]=r,t[2]=n,t},Kt.add=function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t},Kt.subtract=Fg,Kt.multiply=Ng,Kt.divide=Ug,Kt.ceil=function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t},Kt.floor=function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t},Kt.min=function(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t[2]=Math.min(e[2],r[2]),t},Kt.max=function(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t[2]=Math.max(e[2],r[2]),t},Kt.round=function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t},Kt.scale=function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t},Kt.scaleAndAdd=function(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t[2]=e[2]+r[2]*n,t},Kt.distance=Vg,Kt.squaredDistance=jg,Kt.squaredLength=Zg,Kt.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},Kt.inverse=function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t},Kt.normalize=function(t,e){var r=e[0],n=e[1],a=e[2],l=r*r+n*n+a*a;return l>0&&(l=1/Math.sqrt(l)),t[0]=e[0]*l,t[1]=e[1]*l,t[2]=e[2]*l,t},Kt.dot=Gg,Kt.cross=function(t,e,r){var n=e[0],a=e[1],l=e[2],h=r[0],f=r[1],m=r[2];return t[0]=a*m-l*f,t[1]=l*h-n*m,t[2]=n*f-a*h,t},Kt.lerp=function(t,e,r,n){var a=e[0],l=e[1],h=e[2];return t[0]=a+n*(r[0]-a),t[1]=l+n*(r[1]-l),t[2]=h+n*(r[2]-h),t},Kt.hermite=function(t,e,r,n,a,l){var h=l*l,f=h*(2*l-3)+1,m=h*(l-2)+l,_=h*(l-1),x=h*(3-2*l);return t[0]=e[0]*f+r[0]*m+n[0]*_+a[0]*x,t[1]=e[1]*f+r[1]*m+n[1]*_+a[1]*x,t[2]=e[2]*f+r[2]*m+n[2]*_+a[2]*x,t},Kt.bezier=function(t,e,r,n,a,l){var h=1-l,f=h*h,m=l*l,_=f*h,x=3*l*f,b=3*m*h,T=m*l;return t[0]=e[0]*_+r[0]*x+n[0]*b+a[0]*T,t[1]=e[1]*_+r[1]*x+n[1]*b+a[1]*T,t[2]=e[2]*_+r[2]*x+n[2]*b+a[2]*T,t},Kt.random=function(t,e){e=e||1;var r=2*Cs.RANDOM()*Math.PI,n=2*Cs.RANDOM()-1,a=Math.sqrt(1-n*n)*e;return t[0]=Math.cos(r)*a,t[1]=Math.sin(r)*a,t[2]=n*e,t},Kt.transformMat4=function(t,e,r){var n=e[0],a=e[1],l=e[2],h=r[3]*n+r[7]*a+r[11]*l+r[15];return t[0]=(r[0]*n+r[4]*a+r[8]*l+r[12])/(h=h||1),t[1]=(r[1]*n+r[5]*a+r[9]*l+r[13])/h,t[2]=(r[2]*n+r[6]*a+r[10]*l+r[14])/h,t},Kt.transformMat3=function(t,e,r){var n=e[0],a=e[1],l=e[2];return t[0]=n*r[0]+a*r[3]+l*r[6],t[1]=n*r[1]+a*r[4]+l*r[7],t[2]=n*r[2]+a*r[5]+l*r[8],t},Kt.transformQuat=function(t,e,r){var n=r[0],a=r[1],l=r[2],h=e[0],f=e[1],m=e[2],_=a*m-l*f,x=l*h-n*m,b=n*f-a*h,T=a*b-l*x,C=l*_-n*b,P=n*x-a*_,D=2*r[3];return x*=D,b*=D,C*=2,P*=2,t[0]=h+(_*=D)+(T*=2),t[1]=f+x+C,t[2]=m+b+P,t},Kt.rotateX=function(t,e,r,n){var a=[],l=[];return a[0]=e[0]-r[0],a[1]=e[1]-r[1],a[2]=e[2]-r[2],l[0]=a[0],l[1]=a[1]*Math.cos(n)-a[2]*Math.sin(n),l[2]=a[1]*Math.sin(n)+a[2]*Math.cos(n),t[0]=l[0]+r[0],t[1]=l[1]+r[1],t[2]=l[2]+r[2],t},Kt.rotateY=function(t,e,r,n){var a=[],l=[];return a[0]=e[0]-r[0],a[1]=e[1]-r[1],a[2]=e[2]-r[2],l[0]=a[2]*Math.sin(n)+a[0]*Math.cos(n),l[1]=a[1],l[2]=a[2]*Math.cos(n)-a[0]*Math.sin(n),t[0]=l[0]+r[0],t[1]=l[1]+r[1],t[2]=l[2]+r[2],t},Kt.rotateZ=function(t,e,r,n){var a=[],l=[];return a[0]=e[0]-r[0],a[1]=e[1]-r[1],a[2]=e[2]-r[2],l[0]=a[0]*Math.cos(n)-a[1]*Math.sin(n),l[1]=a[0]*Math.sin(n)+a[1]*Math.cos(n),l[2]=a[2],t[0]=l[0]+r[0],t[1]=l[1]+r[1],t[2]=l[2]+r[2],t},Kt.angle=function(t,e){var r=t[0],n=t[1],a=t[2],l=e[0],h=e[1],f=e[2],m=Math.sqrt(r*r+n*n+a*a)*Math.sqrt(l*l+h*h+f*f),_=m&&Gg(t,e)/m;return Math.acos(Math.min(Math.max(_,-1),1))},Kt.zero=function(t){return t[0]=0,t[1]=0,t[2]=0,t},Kt.str=function(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"},Kt.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]},Kt.equals=function(t,e){var r=t[0],n=t[1],a=t[2],l=e[0],h=e[1],f=e[2];return Math.abs(r-l)<=Cs.EPSILON*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(n-h)<=Cs.EPSILON*Math.max(1,Math.abs(n),Math.abs(h))&&Math.abs(a-f)<=Cs.EPSILON*Math.max(1,Math.abs(a),Math.abs(f))},Kt.forEach=Kt.sqrLen=Kt.len=Kt.sqrDist=Kt.dist=Kt.div=Kt.mul=Kt.sub=void 0;var Cs=function(t,e){if(t&&t.__esModule)return t;if(t===null||um(t)!=="object"&&typeof t!="function")return{default:t};var r=Og(void 0);if(r&&r.has(t))return r.get(t);var n={},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var l in t)if(l!=="default"&&Object.prototype.hasOwnProperty.call(t,l)){var h=a?Object.getOwnPropertyDescriptor(t,l):null;h&&(h.get||h.set)?Object.defineProperty(n,l,h):n[l]=t[l]}return n.default=t,r&&r.set(t,n),n}(Ri);function Og(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,r=new WeakMap;return(Og=function(n){return n?r:e})(t)}function kg(){var t=new Cs.ARRAY_TYPE(3);return Cs.ARRAY_TYPE!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function Bg(t){return Math.hypot(t[0],t[1],t[2])}function Fg(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t}function Ng(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t[2]=e[2]*r[2],t}function Ug(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t[2]=e[2]/r[2],t}function Vg(t,e){return Math.hypot(e[0]-t[0],e[1]-t[1],e[2]-t[2])}function jg(t,e){var r=e[0]-t[0],n=e[1]-t[1],a=e[2]-t[2];return r*r+n*n+a*a}function Zg(t){var e=t[0],r=t[1],n=t[2];return e*e+r*r+n*n}function Gg(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}Kt.sub=Fg,Kt.mul=Ng,Kt.div=Ug,Kt.dist=Vg,Kt.sqrDist=jg,Kt.len=Bg,Kt.sqrLen=Zg;var As,eb=(As=kg(),function(t,e,r,n,a,l){var h,f;for(e||(e=3),r||(r=0),f=n?Math.min(n*e+r,t.length):t.length,h=r;h<f;h+=e)As[0]=t[h],As[1]=t[h+1],As[2]=t[h+2],a(As,As,l),t[h]=As[0],t[h+1]=As[1],t[h+2]=As[2];return t});Kt.forEach=eb;var ar={};function hm(t){return hm=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},hm(t)}Object.defineProperty(ar,"__esModule",{value:!0}),ar.create=qg,ar.clone=function(t){var e=new so.ARRAY_TYPE(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},ar.fromValues=function(t,e,r,n){var a=new so.ARRAY_TYPE(4);return a[0]=t,a[1]=e,a[2]=r,a[3]=n,a},ar.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},ar.set=function(t,e,r,n,a){return t[0]=e,t[1]=r,t[2]=n,t[3]=a,t},ar.add=function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t},ar.subtract=Wg,ar.multiply=Hg,ar.divide=Xg,ar.ceil=function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t[3]=Math.ceil(e[3]),t},ar.floor=function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t[3]=Math.floor(e[3]),t},ar.min=function(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t[2]=Math.min(e[2],r[2]),t[3]=Math.min(e[3],r[3]),t},ar.max=function(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t[2]=Math.max(e[2],r[2]),t[3]=Math.max(e[3],r[3]),t},ar.round=function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t[3]=Math.round(e[3]),t},ar.scale=function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t},ar.scaleAndAdd=function(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t[2]=e[2]+r[2]*n,t[3]=e[3]+r[3]*n,t},ar.distance=Yg,ar.squaredDistance=Kg,ar.length=Jg,ar.squaredLength=Qg,ar.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},ar.inverse=function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t},ar.normalize=function(t,e){var r=e[0],n=e[1],a=e[2],l=e[3],h=r*r+n*n+a*a+l*l;return h>0&&(h=1/Math.sqrt(h)),t[0]=r*h,t[1]=n*h,t[2]=a*h,t[3]=l*h,t},ar.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},ar.cross=function(t,e,r,n){var a=r[0]*n[1]-r[1]*n[0],l=r[0]*n[2]-r[2]*n[0],h=r[0]*n[3]-r[3]*n[0],f=r[1]*n[2]-r[2]*n[1],m=r[1]*n[3]-r[3]*n[1],_=r[2]*n[3]-r[3]*n[2],x=e[0],b=e[1],T=e[2],C=e[3];return t[0]=b*_-T*m+C*f,t[1]=-x*_+T*h-C*l,t[2]=x*m-b*h+C*a,t[3]=-x*f+b*l-T*a,t},ar.lerp=function(t,e,r,n){var a=e[0],l=e[1],h=e[2],f=e[3];return t[0]=a+n*(r[0]-a),t[1]=l+n*(r[1]-l),t[2]=h+n*(r[2]-h),t[3]=f+n*(r[3]-f),t},ar.random=function(t,e){var r,n,a,l,h,f;e=e||1;do h=(r=2*so.RANDOM()-1)*r+(n=2*so.RANDOM()-1)*n;while(h>=1);do f=(a=2*so.RANDOM()-1)*a+(l=2*so.RANDOM()-1)*l;while(f>=1);var m=Math.sqrt((1-h)/f);return t[0]=e*r,t[1]=e*n,t[2]=e*a*m,t[3]=e*l*m,t},ar.transformMat4=function(t,e,r){var n=e[0],a=e[1],l=e[2],h=e[3];return t[0]=r[0]*n+r[4]*a+r[8]*l+r[12]*h,t[1]=r[1]*n+r[5]*a+r[9]*l+r[13]*h,t[2]=r[2]*n+r[6]*a+r[10]*l+r[14]*h,t[3]=r[3]*n+r[7]*a+r[11]*l+r[15]*h,t},ar.transformQuat=function(t,e,r){var n=e[0],a=e[1],l=e[2],h=r[0],f=r[1],m=r[2],_=r[3],x=_*n+f*l-m*a,b=_*a+m*n-h*l,T=_*l+h*a-f*n,C=-h*n-f*a-m*l;return t[0]=x*_+C*-h+b*-m-T*-f,t[1]=b*_+C*-f+T*-h-x*-m,t[2]=T*_+C*-m+x*-f-b*-h,t[3]=e[3],t},ar.zero=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t},ar.str=function(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},ar.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]},ar.equals=function(t,e){var r=t[0],n=t[1],a=t[2],l=t[3],h=e[0],f=e[1],m=e[2],_=e[3];return Math.abs(r-h)<=so.EPSILON*Math.max(1,Math.abs(r),Math.abs(h))&&Math.abs(n-f)<=so.EPSILON*Math.max(1,Math.abs(n),Math.abs(f))&&Math.abs(a-m)<=so.EPSILON*Math.max(1,Math.abs(a),Math.abs(m))&&Math.abs(l-_)<=so.EPSILON*Math.max(1,Math.abs(l),Math.abs(_))},ar.forEach=ar.sqrLen=ar.len=ar.sqrDist=ar.dist=ar.div=ar.mul=ar.sub=void 0;var so=function(t,e){if(t&&t.__esModule)return t;if(t===null||hm(t)!=="object"&&typeof t!="function")return{default:t};var r=$g(void 0);if(r&&r.has(t))return r.get(t);var n={},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var l in t)if(l!=="default"&&Object.prototype.hasOwnProperty.call(t,l)){var h=a?Object.getOwnPropertyDescriptor(t,l):null;h&&(h.get||h.set)?Object.defineProperty(n,l,h):n[l]=t[l]}return n.default=t,r&&r.set(t,n),n}(Ri);function $g(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,r=new WeakMap;return($g=function(n){return n?r:e})(t)}function qg(){var t=new so.ARRAY_TYPE(4);return so.ARRAY_TYPE!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function Wg(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t}function Hg(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t[2]=e[2]*r[2],t[3]=e[3]*r[3],t}function Xg(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t[2]=e[2]/r[2],t[3]=e[3]/r[3],t}function Yg(t,e){return Math.hypot(e[0]-t[0],e[1]-t[1],e[2]-t[2],e[3]-t[3])}function Kg(t,e){var r=e[0]-t[0],n=e[1]-t[1],a=e[2]-t[2],l=e[3]-t[3];return r*r+n*n+a*a+l*l}function Jg(t){return Math.hypot(t[0],t[1],t[2],t[3])}function Qg(t){var e=t[0],r=t[1],n=t[2],a=t[3];return e*e+r*r+n*n+a*a}ar.sub=Wg,ar.mul=Hg,ar.div=Xg,ar.dist=Yg,ar.sqrDist=Kg,ar.len=Jg,ar.sqrLen=Qg;var tb=function(){var t=qg();return function(e,r,n,a,l,h){var f,m;for(r||(r=4),n||(n=0),m=a?Math.min(a*r+n,e.length):e.length,f=n;f<m;f+=r)t[0]=e[f],t[1]=e[f+1],t[2]=e[f+2],t[3]=e[f+3],l(t,t,h),e[f]=t[0],e[f+1]=t[1],e[f+2]=t[2],e[f+3]=t[3];return e}}();function dm(t){return dm=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},dm(t)}ar.forEach=tb,Object.defineProperty(Ht,"__esModule",{value:!0}),Ht.create=fm,Ht.identity=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t},Ht.setAxisAngle=t0,Ht.getAxisAngle=function(t,e){var r=2*Math.acos(e[3]),n=Math.sin(r/2);return n>xl.EPSILON?(t[0]=e[0]/n,t[1]=e[1]/n,t[2]=e[2]/n):(t[0]=1,t[1]=0,t[2]=0),r},Ht.getAngle=function(t,e){var r=a0(t,e);return Math.acos(2*r*r-1)},Ht.multiply=r0,Ht.rotateX=function(t,e,r){r*=.5;var n=e[0],a=e[1],l=e[2],h=e[3],f=Math.sin(r),m=Math.cos(r);return t[0]=n*m+h*f,t[1]=a*m+l*f,t[2]=l*m-a*f,t[3]=h*m-n*f,t},Ht.rotateY=function(t,e,r){r*=.5;var n=e[0],a=e[1],l=e[2],h=e[3],f=Math.sin(r),m=Math.cos(r);return t[0]=n*m-l*f,t[1]=a*m+h*f,t[2]=l*m+n*f,t[3]=h*m-a*f,t},Ht.rotateZ=function(t,e,r){r*=.5;var n=e[0],a=e[1],l=e[2],h=e[3],f=Math.sin(r),m=Math.cos(r);return t[0]=n*m+a*f,t[1]=a*m-n*f,t[2]=l*m+h*f,t[3]=h*m-l*f,t},Ht.calculateW=function(t,e){var r=e[0],n=e[1],a=e[2];return t[0]=r,t[1]=n,t[2]=a,t[3]=Math.sqrt(Math.abs(1-r*r-n*n-a*a)),t},Ht.exp=i0,Ht.ln=n0,Ht.pow=function(t,e,r){return n0(t,e),s0(t,t,r),i0(t,t),t},Ht.slerp=cf,Ht.random=function(t){var e=xl.RANDOM(),r=xl.RANDOM(),n=xl.RANDOM(),a=Math.sqrt(1-e),l=Math.sqrt(e);return t[0]=a*Math.sin(2*Math.PI*r),t[1]=a*Math.cos(2*Math.PI*r),t[2]=l*Math.sin(2*Math.PI*n),t[3]=l*Math.cos(2*Math.PI*n),t},Ht.invert=function(t,e){var r=e[0],n=e[1],a=e[2],l=e[3],h=r*r+n*n+a*a+l*l,f=h?1/h:0;return t[0]=-r*f,t[1]=-n*f,t[2]=-a*f,t[3]=l*f,t},Ht.conjugate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t},Ht.fromMat3=o0,Ht.fromEuler=function(t,e,r,n){var a=.5*Math.PI/180;e*=a,r*=a,n*=a;var l=Math.sin(e),h=Math.cos(e),f=Math.sin(r),m=Math.cos(r),_=Math.sin(n),x=Math.cos(n);return t[0]=l*m*x-h*f*_,t[1]=h*f*x+l*m*_,t[2]=h*m*_-l*f*x,t[3]=h*m*x+l*f*_,t},Ht.str=function(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},Ht.setAxes=Ht.sqlerp=Ht.rotationTo=Ht.equals=Ht.exactEquals=Ht.normalize=Ht.sqrLen=Ht.squaredLength=Ht.len=Ht.length=Ht.lerp=Ht.dot=Ht.scale=Ht.mul=Ht.add=Ht.set=Ht.copy=Ht.fromValues=Ht.clone=void 0;var xl=lf(Ri),rb=lf(Nr),Ss=lf(Kt),Hn=lf(ar);function e0(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,r=new WeakMap;return(e0=function(n){return n?r:e})(t)}function lf(t,e){if(!e&&t&&t.__esModule)return t;if(t===null||dm(t)!=="object"&&typeof t!="function")return{default:t};var r=e0(e);if(r&&r.has(t))return r.get(t);var n={},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var l in t)if(l!=="default"&&Object.prototype.hasOwnProperty.call(t,l)){var h=a?Object.getOwnPropertyDescriptor(t,l):null;h&&(h.get||h.set)?Object.defineProperty(n,l,h):n[l]=t[l]}return n.default=t,r&&r.set(t,n),n}function fm(){var t=new xl.ARRAY_TYPE(4);return xl.ARRAY_TYPE!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function t0(t,e,r){r*=.5;var n=Math.sin(r);return t[0]=n*e[0],t[1]=n*e[1],t[2]=n*e[2],t[3]=Math.cos(r),t}function r0(t,e,r){var n=e[0],a=e[1],l=e[2],h=e[3],f=r[0],m=r[1],_=r[2],x=r[3];return t[0]=n*x+h*f+a*_-l*m,t[1]=a*x+h*m+l*f-n*_,t[2]=l*x+h*_+n*m-a*f,t[3]=h*x-n*f-a*m-l*_,t}function i0(t,e){var r=e[0],n=e[1],a=e[2],l=e[3],h=Math.sqrt(r*r+n*n+a*a),f=Math.exp(l),m=h>0?f*Math.sin(h)/h:0;return t[0]=r*m,t[1]=n*m,t[2]=a*m,t[3]=f*Math.cos(h),t}function n0(t,e){var r=e[0],n=e[1],a=e[2],l=e[3],h=Math.sqrt(r*r+n*n+a*a),f=h>0?Math.atan2(h,l)/h:0;return t[0]=r*f,t[1]=n*f,t[2]=a*f,t[3]=.5*Math.log(r*r+n*n+a*a+l*l),t}function cf(t,e,r,n){var a,l,h,f,m,_=e[0],x=e[1],b=e[2],T=e[3],C=r[0],P=r[1],D=r[2],O=r[3];return(l=_*C+x*P+b*D+T*O)<0&&(l=-l,C=-C,P=-P,D=-D,O=-O),1-l>xl.EPSILON?(a=Math.acos(l),h=Math.sin(a),f=Math.sin((1-n)*a)/h,m=Math.sin(n*a)/h):(f=1-n,m=n),t[0]=f*_+m*C,t[1]=f*x+m*P,t[2]=f*b+m*D,t[3]=f*T+m*O,t}function o0(t,e){var r,n=e[0]+e[4]+e[8];if(n>0)r=Math.sqrt(n+1),t[3]=.5*r,t[0]=(e[5]-e[7])*(r=.5/r),t[1]=(e[6]-e[2])*r,t[2]=(e[1]-e[3])*r;else{var a=0;e[4]>e[0]&&(a=1),e[8]>e[3*a+a]&&(a=2);var l=(a+1)%3,h=(a+2)%3;r=Math.sqrt(e[3*a+a]-e[3*l+l]-e[3*h+h]+1),t[a]=.5*r,t[3]=(e[3*l+h]-e[3*h+l])*(r=.5/r),t[l]=(e[3*l+a]+e[3*a+l])*r,t[h]=(e[3*h+a]+e[3*a+h])*r}return t}Ht.clone=Hn.clone,Ht.fromValues=Hn.fromValues,Ht.copy=Hn.copy,Ht.set=Hn.set,Ht.add=Hn.add,Ht.mul=r0;var s0=Hn.scale;Ht.scale=s0;var a0=Hn.dot;Ht.dot=a0,Ht.lerp=Hn.lerp;var l0=Hn.length;Ht.length=l0,Ht.len=l0;var c0=Hn.squaredLength;Ht.squaredLength=c0,Ht.sqrLen=c0;var pm=Hn.normalize;Ht.normalize=pm,Ht.exactEquals=Hn.exactEquals,Ht.equals=Hn.equals;var To,u0,h0,ib=(To=Ss.create(),u0=Ss.fromValues(1,0,0),h0=Ss.fromValues(0,1,0),function(t,e,r){var n=Ss.dot(e,r);return n<-.999999?(Ss.cross(To,u0,e),Ss.len(To)<1e-6&&Ss.cross(To,h0,e),Ss.normalize(To,To),t0(t,To,Math.PI),t):n>.999999?(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t):(Ss.cross(To,e,r),t[0]=To[0],t[1]=To[1],t[2]=To[2],t[3]=1+n,pm(t,t))});Ht.rotationTo=ib;var mm,_m,nb=(mm=fm(),_m=fm(),function(t,e,r,n,a,l){return cf(mm,e,a,l),cf(_m,r,n,l),cf(t,mm,_m,2*l*(1-l)),t});Ht.sqlerp=nb;var Eo,ob=(Eo=rb.create(),function(t,e,r,n){return Eo[0]=r[0],Eo[3]=r[1],Eo[6]=r[2],Eo[1]=n[0],Eo[4]=n[1],Eo[7]=n[2],Eo[2]=-e[0],Eo[5]=-e[1],Eo[8]=-e[2],pm(t,o0(t,Eo))});Ht.setAxes=ob;var pr={};function gm(t){return gm=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},gm(t)}Object.defineProperty(pr,"__esModule",{value:!0}),pr.create=function(){var t=new wn.ARRAY_TYPE(8);return wn.ARRAY_TYPE!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0),t[3]=1,t},pr.clone=function(t){var e=new wn.ARRAY_TYPE(8);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e},pr.fromValues=function(t,e,r,n,a,l,h,f){var m=new wn.ARRAY_TYPE(8);return m[0]=t,m[1]=e,m[2]=r,m[3]=n,m[4]=a,m[5]=l,m[6]=h,m[7]=f,m},pr.fromRotationTranslationValues=function(t,e,r,n,a,l,h){var f=new wn.ARRAY_TYPE(8);f[0]=t,f[1]=e,f[2]=r,f[3]=n;var m=.5*a,_=.5*l,x=.5*h;return f[4]=m*n+_*r-x*e,f[5]=_*n+x*t-m*r,f[6]=x*n+m*e-_*t,f[7]=-m*t-_*e-x*r,f},pr.fromRotationTranslation=p0,pr.fromTranslation=function(t,e){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=.5*e[0],t[5]=.5*e[1],t[6]=.5*e[2],t[7]=0,t},pr.fromRotation=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=0,t[5]=0,t[6]=0,t[7]=0,t},pr.fromMat4=function(t,e){var r=Ps.create();d0.getRotation(r,e);var n=new wn.ARRAY_TYPE(3);return d0.getTranslation(n,e),p0(t,r,n),t},pr.copy=m0,pr.identity=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t},pr.set=function(t,e,r,n,a,l,h,f,m){return t[0]=e,t[1]=r,t[2]=n,t[3]=a,t[4]=l,t[5]=h,t[6]=f,t[7]=m,t},pr.getDual=function(t,e){return t[0]=e[4],t[1]=e[5],t[2]=e[6],t[3]=e[7],t},pr.setDual=function(t,e){return t[4]=e[0],t[5]=e[1],t[6]=e[2],t[7]=e[3],t},pr.getTranslation=function(t,e){var r=e[4],n=e[5],a=e[6],l=e[7],h=-e[0],f=-e[1],m=-e[2],_=e[3];return t[0]=2*(r*_+l*h+n*m-a*f),t[1]=2*(n*_+l*f+a*h-r*m),t[2]=2*(a*_+l*m+r*f-n*h),t},pr.translate=function(t,e,r){var n=e[0],a=e[1],l=e[2],h=e[3],f=.5*r[0],m=.5*r[1],_=.5*r[2],x=e[4],b=e[5],T=e[6],C=e[7];return t[0]=n,t[1]=a,t[2]=l,t[3]=h,t[4]=h*f+a*_-l*m+x,t[5]=h*m+l*f-n*_+b,t[6]=h*_+n*m-a*f+T,t[7]=-n*f-a*m-l*_+C,t},pr.rotateX=function(t,e,r){var n=-e[0],a=-e[1],l=-e[2],h=e[3],f=e[4],m=e[5],_=e[6],x=e[7],b=f*h+x*n+m*l-_*a,T=m*h+x*a+_*n-f*l,C=_*h+x*l+f*a-m*n,P=x*h-f*n-m*a-_*l;return Ps.rotateX(t,e,r),t[4]=b*(h=t[3])+P*(n=t[0])+T*(l=t[2])-C*(a=t[1]),t[5]=T*h+P*a+C*n-b*l,t[6]=C*h+P*l+b*a-T*n,t[7]=P*h-b*n-T*a-C*l,t},pr.rotateY=function(t,e,r){var n=-e[0],a=-e[1],l=-e[2],h=e[3],f=e[4],m=e[5],_=e[6],x=e[7],b=f*h+x*n+m*l-_*a,T=m*h+x*a+_*n-f*l,C=_*h+x*l+f*a-m*n,P=x*h-f*n-m*a-_*l;return Ps.rotateY(t,e,r),t[4]=b*(h=t[3])+P*(n=t[0])+T*(l=t[2])-C*(a=t[1]),t[5]=T*h+P*a+C*n-b*l,t[6]=C*h+P*l+b*a-T*n,t[7]=P*h-b*n-T*a-C*l,t},pr.rotateZ=function(t,e,r){var n=-e[0],a=-e[1],l=-e[2],h=e[3],f=e[4],m=e[5],_=e[6],x=e[7],b=f*h+x*n+m*l-_*a,T=m*h+x*a+_*n-f*l,C=_*h+x*l+f*a-m*n,P=x*h-f*n-m*a-_*l;return Ps.rotateZ(t,e,r),t[4]=b*(h=t[3])+P*(n=t[0])+T*(l=t[2])-C*(a=t[1]),t[5]=T*h+P*a+C*n-b*l,t[6]=C*h+P*l+b*a-T*n,t[7]=P*h-b*n-T*a-C*l,t},pr.rotateByQuatAppend=function(t,e,r){var n=r[0],a=r[1],l=r[2],h=r[3],f=e[0],m=e[1],_=e[2],x=e[3];return t[0]=f*h+x*n+m*l-_*a,t[1]=m*h+x*a+_*n-f*l,t[2]=_*h+x*l+f*a-m*n,t[3]=x*h-f*n-m*a-_*l,t[4]=(f=e[4])*h+(x=e[7])*n+(m=e[5])*l-(_=e[6])*a,t[5]=m*h+x*a+_*n-f*l,t[6]=_*h+x*l+f*a-m*n,t[7]=x*h-f*n-m*a-_*l,t},pr.rotateByQuatPrepend=function(t,e,r){var n=e[0],a=e[1],l=e[2],h=e[3],f=r[0],m=r[1],_=r[2],x=r[3];return t[0]=n*x+h*f+a*_-l*m,t[1]=a*x+h*m+l*f-n*_,t[2]=l*x+h*_+n*m-a*f,t[3]=h*x-n*f-a*m-l*_,t[4]=n*(x=r[7])+h*(f=r[4])+a*(_=r[6])-l*(m=r[5]),t[5]=a*x+h*m+l*f-n*_,t[6]=l*x+h*_+n*m-a*f,t[7]=h*x-n*f-a*m-l*_,t},pr.rotateAroundAxis=function(t,e,r,n){if(Math.abs(n)<wn.EPSILON)return m0(t,e);var a=Math.hypot(r[0],r[1],r[2]);n*=.5;var l=Math.sin(n),h=l*r[0]/a,f=l*r[1]/a,m=l*r[2]/a,_=Math.cos(n),x=e[0],b=e[1],T=e[2],C=e[3];t[0]=x*_+C*h+b*m-T*f,t[1]=b*_+C*f+T*h-x*m,t[2]=T*_+C*m+x*f-b*h,t[3]=C*_-x*h-b*f-T*m;var P=e[4],D=e[5],O=e[6],F=e[7];return t[4]=P*_+F*h+D*m-O*f,t[5]=D*_+F*f+O*h-P*m,t[6]=O*_+F*m+P*f-D*h,t[7]=F*_-P*h-D*f-O*m,t},pr.add=function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t[4]=e[4]+r[4],t[5]=e[5]+r[5],t[6]=e[6]+r[6],t[7]=e[7]+r[7],t},pr.multiply=_0,pr.scale=function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t},pr.lerp=function(t,e,r,n){var a=1-n;return g0(e,r)<0&&(n=-n),t[0]=e[0]*a+r[0]*n,t[1]=e[1]*a+r[1]*n,t[2]=e[2]*a+r[2]*n,t[3]=e[3]*a+r[3]*n,t[4]=e[4]*a+r[4]*n,t[5]=e[5]*a+r[5]*n,t[6]=e[6]*a+r[6]*n,t[7]=e[7]*a+r[7]*n,t},pr.invert=function(t,e){var r=uf(e);return t[0]=-e[0]/r,t[1]=-e[1]/r,t[2]=-e[2]/r,t[3]=e[3]/r,t[4]=-e[4]/r,t[5]=-e[5]/r,t[6]=-e[6]/r,t[7]=e[7]/r,t},pr.conjugate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=e[7],t},pr.normalize=function(t,e){var r=uf(e);if(r>0){r=Math.sqrt(r);var n=e[0]/r,a=e[1]/r,l=e[2]/r,h=e[3]/r,f=e[4],m=e[5],_=e[6],x=e[7],b=n*f+a*m+l*_+h*x;t[0]=n,t[1]=a,t[2]=l,t[3]=h,t[4]=(f-n*b)/r,t[5]=(m-a*b)/r,t[6]=(_-l*b)/r,t[7]=(x-h*b)/r}return t},pr.str=function(t){return"quat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+")"},pr.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]},pr.equals=function(t,e){var r=t[0],n=t[1],a=t[2],l=t[3],h=t[4],f=t[5],m=t[6],_=t[7],x=e[0],b=e[1],T=e[2],C=e[3],P=e[4],D=e[5],O=e[6],F=e[7];return Math.abs(r-x)<=wn.EPSILON*Math.max(1,Math.abs(r),Math.abs(x))&&Math.abs(n-b)<=wn.EPSILON*Math.max(1,Math.abs(n),Math.abs(b))&&Math.abs(a-T)<=wn.EPSILON*Math.max(1,Math.abs(a),Math.abs(T))&&Math.abs(l-C)<=wn.EPSILON*Math.max(1,Math.abs(l),Math.abs(C))&&Math.abs(h-P)<=wn.EPSILON*Math.max(1,Math.abs(h),Math.abs(P))&&Math.abs(f-D)<=wn.EPSILON*Math.max(1,Math.abs(f),Math.abs(D))&&Math.abs(m-O)<=wn.EPSILON*Math.max(1,Math.abs(m),Math.abs(O))&&Math.abs(_-F)<=wn.EPSILON*Math.max(1,Math.abs(_),Math.abs(F))},pr.sqrLen=pr.squaredLength=pr.len=pr.length=pr.dot=pr.mul=pr.setReal=pr.getReal=void 0;var wn=ym(Ri),Ps=ym(Ht),d0=ym(Jt);function f0(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,r=new WeakMap;return(f0=function(n){return n?r:e})(t)}function ym(t,e){if(!e&&t&&t.__esModule)return t;if(t===null||gm(t)!=="object"&&typeof t!="function")return{default:t};var r=f0(e);if(r&&r.has(t))return r.get(t);var n={},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var l in t)if(l!=="default"&&Object.prototype.hasOwnProperty.call(t,l)){var h=a?Object.getOwnPropertyDescriptor(t,l):null;h&&(h.get||h.set)?Object.defineProperty(n,l,h):n[l]=t[l]}return n.default=t,r&&r.set(t,n),n}function p0(t,e,r){var n=.5*r[0],a=.5*r[1],l=.5*r[2],h=e[0],f=e[1],m=e[2],_=e[3];return t[0]=h,t[1]=f,t[2]=m,t[3]=_,t[4]=n*_+a*m-l*f,t[5]=a*_+l*h-n*m,t[6]=l*_+n*f-a*h,t[7]=-n*h-a*f-l*m,t}function m0(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t}function _0(t,e,r){var n=e[0],a=e[1],l=e[2],h=e[3],f=r[4],m=r[5],_=r[6],x=r[7],b=e[4],T=e[5],C=e[6],P=e[7],D=r[0],O=r[1],F=r[2],$=r[3];return t[0]=n*$+h*D+a*F-l*O,t[1]=a*$+h*O+l*D-n*F,t[2]=l*$+h*F+n*O-a*D,t[3]=h*$-n*D-a*O-l*F,t[4]=n*x+h*f+a*_-l*m+b*$+P*D+T*F-C*O,t[5]=a*x+h*m+l*f-n*_+T*$+P*O+C*D-b*F,t[6]=l*x+h*_+n*m-a*f+C*$+P*F+b*O-T*D,t[7]=h*x-n*f-a*m-l*_+P*$-b*D-T*O-C*F,t}pr.getReal=Ps.copy,pr.setReal=Ps.copy,pr.mul=_0;var g0=Ps.dot;pr.dot=g0;var y0=Ps.length;pr.length=y0,pr.len=y0;var uf=Ps.squaredLength;pr.squaredLength=uf,pr.sqrLen=uf;var ir={};function xm(t){return xm=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},xm(t)}Object.defineProperty(ir,"__esModule",{value:!0}),ir.create=v0,ir.clone=function(t){var e=new vl.ARRAY_TYPE(2);return e[0]=t[0],e[1]=t[1],e},ir.fromValues=function(t,e){var r=new vl.ARRAY_TYPE(2);return r[0]=t,r[1]=e,r},ir.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t},ir.set=function(t,e,r){return t[0]=e,t[1]=r,t},ir.add=function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t},ir.subtract=b0,ir.multiply=w0,ir.divide=T0,ir.ceil=function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t},ir.floor=function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t},ir.min=function(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t},ir.max=function(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t},ir.round=function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t},ir.scale=function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t},ir.scaleAndAdd=function(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t},ir.distance=E0,ir.squaredDistance=M0,ir.length=I0,ir.squaredLength=C0,ir.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t},ir.inverse=function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t},ir.normalize=function(t,e){var r=e[0],n=e[1],a=r*r+n*n;return a>0&&(a=1/Math.sqrt(a)),t[0]=e[0]*a,t[1]=e[1]*a,t},ir.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]},ir.cross=function(t,e,r){var n=e[0]*r[1]-e[1]*r[0];return t[0]=t[1]=0,t[2]=n,t},ir.lerp=function(t,e,r,n){var a=e[0],l=e[1];return t[0]=a+n*(r[0]-a),t[1]=l+n*(r[1]-l),t},ir.random=function(t,e){e=e||1;var r=2*vl.RANDOM()*Math.PI;return t[0]=Math.cos(r)*e,t[1]=Math.sin(r)*e,t},ir.transformMat2=function(t,e,r){var n=e[0],a=e[1];return t[0]=r[0]*n+r[2]*a,t[1]=r[1]*n+r[3]*a,t},ir.transformMat2d=function(t,e,r){var n=e[0],a=e[1];return t[0]=r[0]*n+r[2]*a+r[4],t[1]=r[1]*n+r[3]*a+r[5],t},ir.transformMat3=function(t,e,r){var n=e[0],a=e[1];return t[0]=r[0]*n+r[3]*a+r[6],t[1]=r[1]*n+r[4]*a+r[7],t},ir.transformMat4=function(t,e,r){var n=e[0],a=e[1];return t[0]=r[0]*n+r[4]*a+r[12],t[1]=r[1]*n+r[5]*a+r[13],t},ir.rotate=function(t,e,r,n){var a=e[0]-r[0],l=e[1]-r[1],h=Math.sin(n),f=Math.cos(n);return t[0]=a*f-l*h+r[0],t[1]=a*h+l*f+r[1],t},ir.angle=function(t,e){var r=t[0],n=t[1],a=e[0],l=e[1],h=Math.sqrt(r*r+n*n)*Math.sqrt(a*a+l*l);return Math.acos(Math.min(Math.max(h&&(r*a+n*l)/h,-1),1))},ir.zero=function(t){return t[0]=0,t[1]=0,t},ir.str=function(t){return"vec2("+t[0]+", "+t[1]+")"},ir.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]},ir.equals=function(t,e){var r=t[0],n=t[1],a=e[0],l=e[1];return Math.abs(r-a)<=vl.EPSILON*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(n-l)<=vl.EPSILON*Math.max(1,Math.abs(n),Math.abs(l))},ir.forEach=ir.sqrLen=ir.sqrDist=ir.dist=ir.div=ir.mul=ir.sub=ir.len=void 0;var vl=function(t,e){if(t&&t.__esModule)return t;if(t===null||xm(t)!=="object"&&typeof t!="function")return{default:t};var r=x0(void 0);if(r&&r.has(t))return r.get(t);var n={},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var l in t)if(l!=="default"&&Object.prototype.hasOwnProperty.call(t,l)){var h=a?Object.getOwnPropertyDescriptor(t,l):null;h&&(h.get||h.set)?Object.defineProperty(n,l,h):n[l]=t[l]}return n.default=t,r&&r.set(t,n),n}(Ri);function x0(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,r=new WeakMap;return(x0=function(n){return n?r:e})(t)}function v0(){var t=new vl.ARRAY_TYPE(2);return vl.ARRAY_TYPE!=Float32Array&&(t[0]=0,t[1]=0),t}function b0(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t}function w0(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t}function T0(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t}function E0(t,e){return Math.hypot(e[0]-t[0],e[1]-t[1])}function M0(t,e){var r=e[0]-t[0],n=e[1]-t[1];return r*r+n*n}function I0(t){return Math.hypot(t[0],t[1])}function C0(t){var e=t[0],r=t[1];return e*e+r*r}ir.len=I0,ir.sub=b0,ir.mul=w0,ir.div=T0,ir.dist=E0,ir.sqrDist=M0,ir.sqrLen=C0;var sb=function(){var t=v0();return function(e,r,n,a,l,h){var f,m;for(r||(r=2),n||(n=0),m=a?Math.min(a*r+n,e.length):e.length,f=n;f<m;f+=r)t[0]=e[f],t[1]=e[f+1],l(t,t,h),e[f]=t[0],e[f+1]=t[1];return e}}();function vm(t){return vm=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},vm(t)}ir.forEach=sb,Object.defineProperty(zi,"__esModule",{value:!0}),s.a7=zi.vec4=s.N=zi.vec3=zi.vec2=zi.quat2=s.bi=zi.quat=s.a6=zi.mat4=s.co=zi.mat3=zi.mat2d=s.b4=zi.mat2=zi.glMatrix=void 0;var ab=rs(Ri);zi.glMatrix=ab;var lb=rs(ii);s.b4=zi.mat2=lb;var cb=rs(si);zi.mat2d=cb;var ub=rs(Nr);s.co=zi.mat3=ub;var hb=rs(Jt);s.a6=zi.mat4=hb;var db=rs(Ht);s.bi=zi.quat=db;var fb=rs(pr);zi.quat2=fb;var pb=rs(ir);zi.vec2=pb;var mb=rs(Kt);s.N=zi.vec3=mb;var _b=rs(ar);function A0(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,r=new WeakMap;return(A0=function(n){return n?r:e})(t)}function rs(t,e){if(!e&&t&&t.__esModule)return t;if(t===null||vm(t)!=="object"&&typeof t!="function")return{default:t};var r=A0(e);if(r&&r.has(t))return r.get(t);var n={},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var l in t)if(l!=="default"&&Object.prototype.hasOwnProperty.call(t,l)){var h=a?Object.getOwnPropertyDescriptor(t,l):null;h&&(h.get||h.set)?Object.defineProperty(n,l,h):n[l]=t[l]}return n.default=t,r&&r.set(t,n),n}s.a7=zi.vec4=_b;class bm{constructor(e,r){this.pos=e,this.dir=r}intersectsPlane(e,r,n){const a=s.N.dot(r,this.dir);if(Math.abs(a)<1e-6)return!1;const l=((e[0]-this.pos[0])*r[0]+(e[1]-this.pos[1])*r[1]+(e[2]-this.pos[2])*r[2])/a;return n[0]=this.pos[0]+this.dir[0]*l,n[1]=this.pos[1]+this.dir[1]*l,n[2]=this.pos[2]+this.dir[2]*l,!0}closestPointOnSphere(e,r,n){if(s.N.equals(this.pos,e)||r===0)return n[0]=n[1]=n[2]=0,!1;const[a,l,h]=this.dir,f=this.pos[0]-e[0],m=this.pos[1]-e[1],_=this.pos[2]-e[2],x=a*a+l*l+h*h,b=2*(f*a+m*l+_*h),T=b*b-4*x*(f*f+m*m+_*_-r*r);if(T<0){const C=Math.max(-b/2,0),P=f+a*C,D=m+l*C,O=_+h*C,F=Math.hypot(P,D,O);return n[0]=P*r/F,n[1]=D*r/F,n[2]=O*r/F,!1}{const C=(-b-Math.sqrt(T))/(2*x);if(C<0){const P=Math.hypot(f,m,_);return n[0]=f*r/P,n[1]=m*r/P,n[2]=_*r/P,!1}return n[0]=f+a*C,n[1]=m+l*C,n[2]=_+h*C,!0}}}class wm{constructor(e,r,n,a,l){this.TL=e,this.TR=r,this.BR=n,this.BL=a,this.horizon=l}static fromInvProjectionMatrix(e,r,n){const a=[-1,1,1],l=[1,1,1],h=[1,-1,1],f=[-1,-1,1],m=s.N.transformMat4(a,a,e),_=s.N.transformMat4(l,l,e),x=s.N.transformMat4(h,h,e),b=s.N.transformMat4(f,f,e);return new wm(m,_,x,b,r/n)}}function vh(t,e,r){let n=1/0,a=-1/0;const l=[];for(const h of t){s.N.sub(l,h,e);const f=s.N.dot(l,r);n=Math.min(n,f),a=Math.max(a,f)}return[n,a]}function S0(t,e){let r=!0;for(let n=0;n<t.planes.length;n++){const a=t.planes[n];let l=0;for(let h=0;h<e.length;h++)l+=s.N.dot(a,e[h])+a[3]>=0;if(l===0)return 0;l!==e.length&&(r=!1)}return r?2:1}function P0(t,e){for(const r of t.projections){const n=vh(e,t.points[0],r.axis);if(r.projection[1]<n[0]||r.projection[0]>n[1])return 0}return 1}function L0(t,e){let r=0;const n=[0,0,0,0];for(let a=0;a<t.length;a++)n[0]=t[a][0],n[1]=t[a][1],n[2]=t[a][2],n[3]=1,s.a7.dot(n,e)>=0&&r++;return r}class Tm{constructor(e,r){this.points=e||new Array(8).fill([0,0,0]),this.planes=r||new Array(6).fill([0,0,0,0]),this.bounds=ai.fromPoints(this.points),this.projections=[],this.frustumEdges=[s.N.sub([],this.points[2],this.points[3]),s.N.sub([],this.points[0],this.points[3]),s.N.sub([],this.points[4],this.points[0]),s.N.sub([],this.points[5],this.points[1]),s.N.sub([],this.points[6],this.points[2]),s.N.sub([],this.points[7],this.points[3])];for(const n of this.frustumEdges){const a=[0,-n[2],n[1]],l=[n[2],0,-n[0]];this.projections.push({axis:a,projection:vh(this.points,this.points[0],a)}),this.projections.push({axis:l,projection:vh(this.points,this.points[0],l)})}}static fromInvProjectionMatrix(e,r,n,a){const l=Math.pow(2,n),h=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(_=>{const x=s.a7.transformMat4([],_,e),b=1/x[3]/r*l;return s.a7.mul(x,x,[b,b,a?1/x[3]:b,b])}),f=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(_=>{const x=s.N.sub([],h[_[0]],h[_[1]]),b=s.N.sub([],h[_[2]],h[_[1]]),T=s.N.normalize([],s.N.cross([],x,b)),C=-s.N.dot(T,h[_[1]]);return T.concat(C)}),m=[];for(let _=0;_<h.length;_++)m.push([h[_][0],h[_][1],h[_][2]]);return new Tm(m,f)}intersectsPrecise(e,r,n){for(let a=0;a<r.length;a++)if(!L0(e,r[a]))return 0;for(let a=0;a<this.planes.length;a++)if(!L0(e,this.planes[a]))return 0;for(const a of n)for(const l of this.frustumEdges){const h=s.N.cross([],a,l),f=s.N.length(h);if(f===0)continue;s.N.scale(h,h,1/f);const m=vh(this.points,this.points[0],h),_=vh(e,this.points[0],h);if(m[0]>_[1]||_[0]>m[1])return 0}return 1}}class ai{static fromPoints(e){const r=[1/0,1/0,1/0],n=[-1/0,-1/0,-1/0];for(const a of e)s.N.min(r,r,a),s.N.max(n,n,a);return new ai(r,n)}static fromTileIdAndHeight(e,r,n){const a=1<<e.canonical.z,l=e.canonical.x,h=e.canonical.y;return new ai([l/a,h/a,r],[(l+1)/a,(h+1)/a,n])}static applyTransform(e,r){const n=e.getCorners();for(let a=0;a<n.length;++a)s.N.transformMat4(n[a],n[a],r);return ai.fromPoints(n)}static projectAabbCorners(e,r){const n=e.getCorners();for(let a=0;a<n.length;++a)s.N.transformMat4(n[a],n[a],r);return n}constructor(e,r){this.min=e,this.max=r,this.center=s.N.scale([],s.N.add([],this.min,this.max),.5)}quadrant(e){const r=[e%2==0,e<2],n=s.N.clone(this.min),a=s.N.clone(this.max);for(let l=0;l<r.length;l++)n[l]=r[l]?this.min[l]:this.center[l],a[l]=r[l]?this.center[l]:this.max[l];return a[2]=this.max[2],new ai(n,a)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){const e=this.min,r=this.max;return[[e[0],e[1],e[2]],[r[0],e[1],e[2]],[r[0],r[1],e[2]],[e[0],r[1],e[2]],[e[0],e[1],r[2]],[r[0],e[1],r[2]],[r[0],r[1],r[2]],[e[0],r[1],r[2]]]}intersects(e){return this.intersectsAabb(e.bounds)?S0(e,this.getCorners()):0}intersectsFlat(e){return this.intersectsAabb(e.bounds)?S0(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(e,r){return r||this.intersects(e)?P0(e,this.getCorners()):0}intersectsPreciseFlat(e,r){return r||this.intersectsFlat(e)?P0(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(e){for(let r=0;r<3;++r)if(this.min[r]>e.max[r]||e.min[r]>this.max[r])return!1;return!0}intersectsAabbXY(e){return!(this.min[0]>e.max[0]||e.min[0]>this.max[0]||this.min[1]>e.max[1]||e.min[1]>this.max[1])}encapsulate(e){for(let r=0;r<3;r++)this.min[r]=Math.min(this.min[r],e.min[r]),this.max[r]=Math.max(this.max[r],e.max[r])}encapsulatePoint(e){for(let r=0;r<3;r++)this.min[r]=Math.min(this.min[r],e[r]),this.max[r]=Math.max(this.max[r],e[r])}closestPoint(e){return[Math.max(Math.min(this.max[0],e[0]),this.min[0]),Math.max(Math.min(this.max[1],e[1]),this.min[1]),Math.max(Math.min(this.max[2],e[2]),this.min[2])]}}mt(ai,"Aabb");const gb=Dr([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:hf}=gb,yb=Dr([{name:"a_pos_3",components:3,type:"Int16"}]);var D0=Dr([{name:"a_pos",type:"Int16",components:2}]);function df(t){return t*q/Ie}const xb=[new ai([he,he,he],[we,we,we]),new ai([he,he,he],[0,0,we]),new ai([0,he,he],[we,0,we]),new ai([he,0,he],[0,we,we]),new ai([0,0,he],[we,we,we])];function z0(t,e,r,n=!0){const a=s.N.scale([],t._camera.position,t.worldSize),l=[e,r,1,1];s.a7.transformMat4(l,l,t.pixelMatrixInverse),s.a7.scale(l,l,1/l[3]);const h=s.N.sub([],l,a),f=s.N.normalize([],h),m=t.globeMatrix,_=[m[12],m[13],m[14]],x=s.N.sub([],_,a),b=s.N.length(x),T=s.N.normalize([],x),C=t.worldSize/(2*Math.PI),P=s.N.dot(T,f),D=Math.asin(C/b);if(D<Math.acos(P)){if(!n)return null;const xe=[],Se=[];s.N.scale(xe,f,b/P),s.N.normalize(Se,s.N.sub(Se,xe,x)),s.N.normalize(f,s.N.add(f,x,s.N.scale(f,Se,Math.tan(D)*b)))}const O=[];new bm(a,f).closestPointOnSphere(_,C,O);const F=s.N.normalize([],ie(m,0)),$=s.N.normalize([],ie(m,1)),X=s.N.normalize([],ie(m,2)),H=s.N.dot(F,O),ne=s.N.dot($,O),re=s.N.dot(X,O),ce=At(Math.asin(-ne/C));let pe=At(Math.atan2(H,re));pe=t.center.lng+function(xe,Se){const Be=(Se-xe+180)%360-180;return Be<-180?Be+360:Be}(t.center.lng,pe);const ye=Yt(pe),Te=Ut(Vt(ce),0,1);return new gr(ye,Te)}class vb{constructor(e,r,n){this.a=s.N.sub([],e,n),this.b=s.N.sub([],r,n),this.center=n;const a=s.N.normalize([],this.a),l=s.N.normalize([],this.b);this.angle=Math.acos(s.N.dot(a,l))}}function Em(t,e){if(t.angle===0)return null;let r;return r=t.a[e]===0?1/t.angle*.5*Math.PI:1/t.angle*Math.atan(t.b[e]/t.a[e]/Math.sin(t.angle)-1/Math.tan(t.angle)),r<0||r>1?null:function(n,a,l,h){const f=Math.sin(l);return n*(Math.sin((1-h)*l)/f)+a*(Math.sin(h*l)/f)}(t.a[e],t.b[e],t.angle,Ut(r,0,1))+t.center[e]}function is(t){if(t.z<=1)return xb[t.z+2*t.y+t.x];const e=Mm(ff(t));return ai.fromPoints(e)}function Ls(t,e,r){return s.N.scale(t,t,1-r),s.N.scaleAndAdd(t,t,e,r)}function R0(t,e,r){for(const n of t)s.N.transformMat4(n,n,e),s.N.scale(n,n,r)}function O0(t,e,r,n){const a=e/t.worldSize,l=t.globeMatrix;if(r.z<=1){const ye=is(r).getCorners();return R0(ye,l,a),ai.fromPoints(ye)}const h=ff(r,n),f=Mm(h,q+df(t._tileCoverLift));R0(f,l,a);const m=Number.MAX_VALUE,_=[-m,-m,-m],x=[m,m,m];if(h.contains(t.center)){for(const xe of f)s.N.min(x,x,xe),s.N.max(_,_,xe);_[2]=0;const ye=t.point,Te=[ye.x*a,ye.y*a,0];return s.N.min(x,x,Te),s.N.max(_,_,Te),new ai(x,_)}if(t._tileCoverLift>0){for(const ye of f)s.N.min(x,x,ye),s.N.max(_,_,ye);return new ai(x,_)}const b=[l[12]*a,l[13]*a,l[14]*a],T=h.getCenter(),C=Ut(t.center.lat,-nr,nr),P=Ut(T.lat,-nr,nr),D=Yt(t.center.lng),O=Vt(C);let F=D-Yt(T.lng);const $=O-Vt(P);F>.5?F-=1:F<-.5&&(F+=1);let X=0;if(Math.abs(F)>Math.abs($))X=F>=0?1:3;else{X=$>=0?0:2;const ye=[l[4]*a,l[5]*a,l[6]*a],Te=-Math.sin(St($>=0?h.getSouth():h.getNorth()))*q;s.N.scaleAndAdd(b,b,ye,Te)}const H=f[X],ne=f[(X+1)%4],re=new vb(H,ne,b),ce=[Em(re,0)||H[0],Em(re,1)||H[1],Em(re,2)||H[2]],pe=fa(t.zoom);if(pe>0){const ye=function({x:xe,y:Se,z:Be},Ce,Oe,Me,Re){const et=1/(1<<Be);let Ne=xe*et,gt=Ne+et,ht=Se*et,je=ht+et,kt=0;const Mt=(Ne+gt)/2-Me;return Mt>.5?kt=-1:Mt<-.5&&(kt=1),Ne=((Ne+kt)*Ce-(Me*=Ce))*Oe+Me,gt=((gt+kt)*Ce-Me)*Oe+Me,ht=(ht*Ce-(Re*=Ce))*Oe+Re,je=(je*Ce-Re)*Oe+Re,[[Ne,je,0],[gt,je,0],[gt,ht,0],[Ne,ht,0]]}(r,e,t._pixelsPerMercatorPixel,D,O);for(let xe=0;xe<f.length;xe++)Ls(f[xe],ye[xe],pe);const Te=s.N.add([],ye[X],ye[(X+1)%4]);s.N.scale(Te,Te,.5),Ls(ce,Te,pe)}for(const ye of f)s.N.min(x,x,ye),s.N.max(_,_,ye);return x[2]=Math.min(H[2],ne[2]),s.N.min(x,x,ce),s.N.max(_,_,ce),new ai(x,_)}function ff({x:t,y:e,z:r},n=!1){const a=1/(1<<r),l=new ge($t(t*a),e===(1<<r)-1&&n?-90:fr((e+1)*a)),h=new ge($t((t+1)*a),e===0&&n?90:fr(e*a));return new Ee(l,h)}function Mm(t,e=q){const r=St(t.getNorth()),n=St(t.getSouth()),a=Math.cos(r),l=Math.cos(n),h=Math.sin(r),f=Math.sin(n),m=t.getWest(),_=t.getEast();return[me(l,f,m,e),me(l,f,_,e),me(a,h,_,e),me(a,h,m,e)]}function bh(t,e,r,n){const a=1<<r.z,l=(t/ct+r.x)/a;return Ae(fr((e/ct+r.y)/a),$t(l),n)}function pf({min:t,max:e}){return Q/Math.max(e[0]-t[0],e[1]-t[1],e[2]-t[2])}const k0=new Float64Array(16);function mf(t){const e=pf(t),r=s.a6.fromScaling(k0,[e,e,e]);return s.a6.translate(r,r,s.N.negate([],t.min))}function Im(t){const e=s.a6.fromTranslation(k0,t.min),r=1/pf(t);return s.a6.scale(e,e,[r,r,r])}function Cm(t){const e=ct/(2*Math.PI);return t/(2*Math.PI)/e}function B0(t,e){return ct/(512*Math.pow(2,t))*pf(is(e))}function F0(t,e,r,n,a){const l=Cm(r),h=[t,e,-r/(2*Math.PI)],f=s.a6.identity(new Float64Array(16));return s.a6.translate(f,f,h),s.a6.scale(f,f,[l,l,l]),s.a6.rotateX(f,f,St(-a)),s.a6.rotateY(f,f,St(-n)),f}function fa(t){return Ei(J,j,t)}function N0(t,e){const r=Ae(e.lat,e.lng),n=function(l){const h=Ae(l._center.lat,l._center.lng),f=s.N.fromValues(0,1,0);let m=s.N.cross([],f,h);const _=s.a6.fromRotation([],-l.angle,h);m=s.N.transformMat4(m,m,_),s.a6.fromRotation(_,-l._pitch,m);const x=s.N.normalize([],h);return s.N.scale(x,x,df(l.cameraToCenterDistance/l.pixelsPerMeter)),s.N.transformMat4(x,x,_),s.N.add([],h,x)}(t),a=s.N.subtract([],n,r);return s.N.angle(a,r)}function Am(t,e){return N0(t,e)>Math.PI/2*1.01}const U0=St(85),bb=Math.cos(U0),wb=Math.sin(U0),Tb=s.a6.create(),V0=t=>{const e=[];return t.paint.get("circle-pitch-alignment")==="map"&&e.push("PITCH_WITH_MAP"),t.paint.get("circle-pitch-scale")==="map"&&e.push("SCALE_WITH_MAP"),e};function j0(t,e,r,n,a,l,h,f,m){if(l&&t.queryGeometry.isAboveHorizon)return!1;l&&(m*=t.pixelToTileUnitsFactor);const _=t.tileID.canonical,x=r.projection.upVectorScale(_,r.center.lat,r.worldSize).metersToTile;for(const b of e)for(const T of b){const C=T.add(f),P=a&&r.elevation?r.elevation.exaggeration()*a.getElevationAt(C.x,C.y,!0):0,D=r.projection.projectTilePoint(C.x,C.y,_);if(P>0){const X=r.projection.upVector(_,C.x,C.y);D.x+=X[0]*x*P,D.y+=X[1]*x*P,D.z+=X[2]*x*P}const O=l?C:Eb(D.x,D.y,D.z,n),F=l?t.tilespaceRays.map(X=>Ib(X,P)):t.queryGeometry.screenGeometry,$=s.a7.transformMat4([],[D.x,D.y,D.z,1],n);if(!h&&l?m*=$[3]/r.cameraToCenterDistance:h&&!l&&(m*=r.cameraToCenterDistance/$[3]),l){const X=fr((T.y/ct+_.y)/(1<<_.z));m/=r.projection.pixelsPerMeter(X,1)/qt(1,X)}if(es(F,O,m))return!0}return!1}function Eb(t,e,r,n){const a=s.a7.transformMat4([],[t,e,r,1],n);return new Ge(a[0]/a[3],a[1]/a[3])}const Z0=s.N.fromValues(0,0,0),Mb=s.N.fromValues(0,0,1);function Ib(t,e){const r=s.N.create();return Z0[2]=e,t.intersectsPlane(Z0,Mb,r),new Ge(r[0],r[1])}class G0 extends hn{}function $0(t,{width:e,height:r},n,a){if(a){if(a instanceof Uint8ClampedArray)a=new Uint8Array(a.buffer);else if(a.length!==e*r*n)throw new RangeError("mismatched image size")}else a=new Uint8Array(e*r*n);return t.width=e,t.height=r,t.data=a,t}function q0(t,e,r){const{width:n,height:a}=e;n===t.width&&a===t.height||(Sm(t,e,{x:0,y:0},{x:0,y:0},{width:Math.min(t.width,n),height:Math.min(t.height,a)},r),t.width=n,t.height=a,t.data=e.data)}function Sm(t,e,r,n,a,l,h){if(a.width===0||a.height===0)return e;if(a.width>t.width||a.height>t.height||r.x>t.width-a.width||r.y>t.height-a.height)throw new RangeError("out of range source coordinates for image copy");if(a.width>e.width||a.height>e.height||n.x>e.width-a.width||n.y>e.height-a.height)throw new RangeError("out of range destination coordinates for image copy");const f=t.data,m=e.data,_=l===4&&h;for(let x=0;x<a.height;x++){const b=((r.y+x)*t.width+r.x)*l,T=((n.y+x)*e.width+n.x)*l;if(_)for(let C=0;C<a.width;C++){const P=b+C*l+3,D=T+C*l;m[D+0]=255,m[D+1]=255,m[D+2]=255,m[D+3]=f[P]}else for(let C=0;C<a.width*l;C++)m[T+C]=f[b+C]}return e}mt(G0,"HeatmapBucket",{omit:["layers"]});class pa{constructor(e,r){$0(this,e,1,r)}resize(e){q0(this,new pa(e),1)}clone(){return new pa({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,r,n,a,l){Sm(e,r,n,a,l,1)}}class Xn{constructor(e,r){$0(this,e,4,r)}resize(e){q0(this,new Xn(e),4)}replace(e,r){r?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new Xn({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,r,n,a,l,h){Sm(e,r,n,a,l,4,h)}}class W0{constructor(e,r){this.width=e.width,this.height=e.height,this.data=r instanceof Uint8Array?new Float32Array(r.buffer):r}}mt(pa,"AlphaImage"),mt(Xn,"RGBAImage");const Cb=new ti({visibility:new Je(be.layout_heatmap.visibility)});var Ab={paint:new ti({"heatmap-radius":new Lt(be.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Lt(be.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Je(be.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Es(be.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Je(be.paint_heatmap["heatmap-opacity"])}),layout:Cb};function wh(t){const e={},r=t.resolution||256,n=t.clips?t.clips.length:1,a=t.image||new Xn({width:r,height:n}),l=(h,f,m)=>{e[t.evaluationKey]=m;const _=t.expression.evaluate(e);_&&(a.data[h+f+0]=Math.floor(255*_.r/_.a),a.data[h+f+1]=Math.floor(255*_.g/_.a),a.data[h+f+2]=Math.floor(255*_.b/_.a),a.data[h+f+3]=Math.floor(255*_.a))};if(t.clips)for(let h=0,f=0;h<n;++h,f+=4*r)for(let m=0,_=0;m<r;m++,_+=4){const x=m/(r-1),{start:b,end:T}=t.clips[h];l(f,_,b*(1-x)+T*x)}else for(let h=0,f=0;h<r;h++,f+=4)l(0,f,h/(r-1));return a}const Sb=new ti({visibility:new Je(be.layout_hillshade.visibility)});var Pb={paint:new ti({"hillshade-illumination-direction":new Je(be.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new Je(be.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new Je(be.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new Je(be.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new Je(be.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new Je(be.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new Je(be.paint_hillshade["hillshade-emissive-strength"])}),layout:Sb};const Lb=Dr([{name:"a_pos",components:2,type:"Int16"}],4),{members:Db}=Lb;var Pm={exports:{}};function _f(t,e,r){r=r||2;var n,a,l,h,f,m,_,x=e&&e.length,b=x?e[0]*r:t.length,T=H0(t,0,b,r,!0),C=[];if(!T||T.next===T.prev)return C;if(x&&(T=function(D,O,F,$){var X,H,ne,re=[];for(X=0,H=O.length;X<H;X++)(ne=H0(D,O[X]*$,X<H-1?O[X+1]*$:D.length,$,!1))===ne.next&&(ne.steiner=!0),re.push(Ub(ne));for(re.sort(Bb),X=0;X<re.length;X++)F=Fb(re[X],F);return F}(t,e,T,r)),t.length>80*r){n=l=t[0],a=h=t[1];for(var P=r;P<b;P+=r)(f=t[P])<n&&(n=f),(m=t[P+1])<a&&(a=m),f>l&&(l=f),m>h&&(h=m);_=(_=Math.max(l-n,h-a))!==0?32767/_:0}return Th(T,C,r,n,a,_,0),C}function H0(t,e,r,n,a){var l,h;if(a===zm(t,e,r,n)>0)for(l=e;l<r;l+=n)h=K0(l,t[l],t[l+1],h);else for(l=r-n;l>=e;l-=n)h=K0(l,t[l],t[l+1],h);return h&&gf(h,h.next)&&(Mh(h),h=h.next),h}function bl(t,e){if(!t)return t;e||(e=t);var r,n=t;do if(r=!1,n.steiner||!gf(n,n.next)&&Mi(n.prev,n,n.next)!==0)n=n.next;else{if(Mh(n),(n=e=n.prev)===n.next)break;r=!0}while(r||n!==e);return e}function Th(t,e,r,n,a,l,h){if(t){!h&&l&&function(x,b,T,C){var P=x;do P.z===0&&(P.z=Lm(P.x,P.y,b,T,C)),P.prevZ=P.prev,P.nextZ=P.next,P=P.next;while(P!==x);P.prevZ.nextZ=null,P.prevZ=null,function(D){var O,F,$,X,H,ne,re,ce,pe=1;do{for(F=D,D=null,H=null,ne=0;F;){for(ne++,$=F,re=0,O=0;O<pe&&(re++,$=$.nextZ);O++);for(ce=pe;re>0||ce>0&&$;)re!==0&&(ce===0||!$||F.z<=$.z)?(X=F,F=F.nextZ,re--):(X=$,$=$.nextZ,ce--),H?H.nextZ=X:D=X,X.prevZ=H,H=X;F=$}H.nextZ=null,pe*=2}while(ne>1)}(P)}(t,n,a,l);for(var f,m,_=t;t.prev!==t.next;)if(f=t.prev,m=t.next,l?Rb(t,n,a,l):zb(t))e.push(f.i/r|0),e.push(t.i/r|0),e.push(m.i/r|0),Mh(t),t=m.next,_=m.next;else if((t=m)===_){h?h===1?Th(t=Ob(bl(t),e,r),e,r,n,a,l,2):h===2&&kb(t,e,r,n,a,l):Th(bl(t),e,r,n,a,l,1);break}}}function zb(t){var e=t.prev,r=t,n=t.next;if(Mi(e,r,n)>=0)return!1;for(var a=e.x,l=r.x,h=n.x,f=e.y,m=r.y,_=n.y,x=a<l?a<h?a:h:l<h?l:h,b=f<m?f<_?f:_:m<_?m:_,T=a>l?a>h?a:h:l>h?l:h,C=f>m?f>_?f:_:m>_?m:_,P=n.next;P!==e;){if(P.x>=x&&P.x<=T&&P.y>=b&&P.y<=C&&xc(a,f,l,m,h,_,P.x,P.y)&&Mi(P.prev,P,P.next)>=0)return!1;P=P.next}return!0}function Rb(t,e,r,n){var a=t.prev,l=t,h=t.next;if(Mi(a,l,h)>=0)return!1;for(var f=a.x,m=l.x,_=h.x,x=a.y,b=l.y,T=h.y,C=f<m?f<_?f:_:m<_?m:_,P=x<b?x<T?x:T:b<T?b:T,D=f>m?f>_?f:_:m>_?m:_,O=x>b?x>T?x:T:b>T?b:T,F=Lm(C,P,e,r,n),$=Lm(D,O,e,r,n),X=t.prevZ,H=t.nextZ;X&&X.z>=F&&H&&H.z<=$;){if(X.x>=C&&X.x<=D&&X.y>=P&&X.y<=O&&X!==a&&X!==h&&xc(f,x,m,b,_,T,X.x,X.y)&&Mi(X.prev,X,X.next)>=0||(X=X.prevZ,H.x>=C&&H.x<=D&&H.y>=P&&H.y<=O&&H!==a&&H!==h&&xc(f,x,m,b,_,T,H.x,H.y)&&Mi(H.prev,H,H.next)>=0))return!1;H=H.nextZ}for(;X&&X.z>=F;){if(X.x>=C&&X.x<=D&&X.y>=P&&X.y<=O&&X!==a&&X!==h&&xc(f,x,m,b,_,T,X.x,X.y)&&Mi(X.prev,X,X.next)>=0)return!1;X=X.prevZ}for(;H&&H.z<=$;){if(H.x>=C&&H.x<=D&&H.y>=P&&H.y<=O&&H!==a&&H!==h&&xc(f,x,m,b,_,T,H.x,H.y)&&Mi(H.prev,H,H.next)>=0)return!1;H=H.nextZ}return!0}function Ob(t,e,r){var n=t;do{var a=n.prev,l=n.next.next;!gf(a,l)&&X0(a,n,n.next,l)&&Eh(a,l)&&Eh(l,a)&&(e.push(a.i/r|0),e.push(n.i/r|0),e.push(l.i/r|0),Mh(n),Mh(n.next),n=t=l),n=n.next}while(n!==t);return bl(n)}function kb(t,e,r,n,a,l){var h=t;do{for(var f=h.next.next;f!==h.prev;){if(h.i!==f.i&&Vb(h,f)){var m=Y0(h,f);return h=bl(h,h.next),m=bl(m,m.next),Th(h,e,r,n,a,l,0),void Th(m,e,r,n,a,l,0)}f=f.next}h=h.next}while(h!==t)}function Bb(t,e){return t.x-e.x}function Fb(t,e){var r=function(a,l){var h,f=l,m=a.x,_=a.y,x=-1/0;do{if(_<=f.y&&_>=f.next.y&&f.next.y!==f.y){var b=f.x+(_-f.y)*(f.next.x-f.x)/(f.next.y-f.y);if(b<=m&&b>x&&(x=b,h=f.x<f.next.x?f:f.next,b===m))return h}f=f.next}while(f!==l);if(!h)return null;var T,C=h,P=h.x,D=h.y,O=1/0;f=h;do m>=f.x&&f.x>=P&&m!==f.x&&xc(_<D?m:x,_,P,D,_<D?x:m,_,f.x,f.y)&&(T=Math.abs(_-f.y)/(m-f.x),Eh(f,a)&&(T<O||T===O&&(f.x>h.x||f.x===h.x&&Nb(h,f)))&&(h=f,O=T)),f=f.next;while(f!==C);return h}(t,e);if(!r)return e;var n=Y0(r,t);return bl(n,n.next),bl(r,r.next)}function Nb(t,e){return Mi(t.prev,t,e.prev)<0&&Mi(e.next,t,t.next)<0}function Lm(t,e,r,n,a){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-r)*a|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-n)*a|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Ub(t){var e=t,r=t;do(e.x<r.x||e.x===r.x&&e.y<r.y)&&(r=e),e=e.next;while(e!==t);return r}function xc(t,e,r,n,a,l,h,f){return(a-h)*(e-f)>=(t-h)*(l-f)&&(t-h)*(n-f)>=(r-h)*(e-f)&&(r-h)*(l-f)>=(a-h)*(n-f)}function Vb(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(r,n){var a=r;do{if(a.i!==r.i&&a.next.i!==r.i&&a.i!==n.i&&a.next.i!==n.i&&X0(a,a.next,r,n))return!0;a=a.next}while(a!==r);return!1}(t,e)&&(Eh(t,e)&&Eh(e,t)&&function(r,n){var a=r,l=!1,h=(r.x+n.x)/2,f=(r.y+n.y)/2;do a.y>f!=a.next.y>f&&a.next.y!==a.y&&h<(a.next.x-a.x)*(f-a.y)/(a.next.y-a.y)+a.x&&(l=!l),a=a.next;while(a!==r);return l}(t,e)&&(Mi(t.prev,t,e.prev)||Mi(t,e.prev,e))||gf(t,e)&&Mi(t.prev,t,t.next)>0&&Mi(e.prev,e,e.next)>0)}function Mi(t,e,r){return(e.y-t.y)*(r.x-e.x)-(e.x-t.x)*(r.y-e.y)}function gf(t,e){return t.x===e.x&&t.y===e.y}function X0(t,e,r,n){var a=xf(Mi(t,e,r)),l=xf(Mi(t,e,n)),h=xf(Mi(r,n,t)),f=xf(Mi(r,n,e));return a!==l&&h!==f||!(a!==0||!yf(t,r,e))||!(l!==0||!yf(t,n,e))||!(h!==0||!yf(r,t,n))||!(f!==0||!yf(r,e,n))}function yf(t,e,r){return e.x<=Math.max(t.x,r.x)&&e.x>=Math.min(t.x,r.x)&&e.y<=Math.max(t.y,r.y)&&e.y>=Math.min(t.y,r.y)}function xf(t){return t>0?1:t<0?-1:0}function Eh(t,e){return Mi(t.prev,t,t.next)<0?Mi(t,e,t.next)>=0&&Mi(t,t.prev,e)>=0:Mi(t,e,t.prev)<0||Mi(t,t.next,e)<0}function Y0(t,e){var r=new Dm(t.i,t.x,t.y),n=new Dm(e.i,e.x,e.y),a=t.next,l=e.prev;return t.next=e,e.prev=t,r.next=a,a.prev=r,n.next=r,r.prev=n,l.next=n,n.prev=l,n}function K0(t,e,r,n){var a=new Dm(t,e,r);return n?(a.next=n.next,a.prev=n,n.next.prev=a,n.next=a):(a.prev=a,a.next=a),a}function Mh(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Dm(t,e,r){this.i=t,this.x=e,this.y=r,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function zm(t,e,r,n){for(var a=0,l=e,h=r-n;l<r;l+=n)a+=(t[h]-t[l])*(t[l+1]+t[h+1]),h=l;return a}Pm.exports=_f,Pm.exports.default=_f,_f.deviation=function(t,e,r,n){var a=e&&e.length,l=Math.abs(zm(t,0,a?e[0]*r:t.length,r));if(a)for(var h=0,f=e.length;h<f;h++)l-=Math.abs(zm(t,e[h]*r,h<f-1?e[h+1]*r:t.length,r));var m=0;for(h=0;h<n.length;h+=3){var _=n[h]*r,x=n[h+1]*r,b=n[h+2]*r;m+=Math.abs((t[_]-t[b])*(t[x+1]-t[_+1])-(t[_]-t[x])*(t[b+1]-t[_+1]))}return l===0&&m===0?0:Math.abs((m-l)/l)},_f.flatten=function(t){for(var e=t[0][0].length,r={vertices:[],holes:[],dimensions:e},n=0,a=0;a<t.length;a++){for(var l=0;l<t[a].length;l++)for(var h=0;h<e;h++)r.vertices.push(t[a][l][h]);a>0&&r.holes.push(n+=t[a-1].length)}return r};var vf=ft(Pm.exports);function Rm(t,e){const r=t.length;if(r<=1)return[t];const n=[];let a,l;for(let h=0;h<r;h++){const f=cs(t[h]);f!==0&&(t[h].area=Math.abs(f),l===void 0&&(l=f<0),l===f<0?(a&&n.push(a),a=[t[h]]):a.push(t[h]))}if(a&&n.push(a),e>1)for(let h=0;h<n.length;h++)n[h].length<=e||(kp(n[h],e,1,n[h].length-1,jb),n[h]=n[h].slice(0,e));return n}function jb(t,e){return e.area-t.area}function Om(t,e,r){const n=r.patternDependencies;let a=!1;for(const l of e){const h=l.paint.get(`${t}-pattern`);h.isConstant()||(a=!0);const f=h.constantOr(null);f&&(a=!0,n[f]=!0)}return a}function km(t,e,r,n,a){const l=a.patternDependencies;for(const h of e){const f=h.paint.get(`${t}-pattern`).value;if(f.kind!=="constant"){let m=f.evaluate({zoom:n},r,{},a.availableImages);m=m&&m.name?m.name:m,l[m]=!0,r.patterns[h.id]=m}}return r}class Bm{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.fqid),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new qn,this.indexArray=new Si,this.indexArray2=new io,this.programConfigurations=new U(e.layers,e.zoom),this.segments=new ci,this.segments2=new ci,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id),this.projection=e.projection}populate(e,r,n,a){this.hasPattern=Om("fill",this.layers,r);const l=this.layers[0].layout.get("fill-sort-key"),h=[];for(const{feature:f,id:m,index:_,sourceLayerIndex:x}of e){const b=this.layers[0]._featureFilter.needGeometry,T=wi(f,b);if(!this.layers[0]._featureFilter.filter(new ei(this.zoom),T,n))continue;const C=l?l.evaluate(T,{},n,r.availableImages):void 0,P={id:m,properties:f.properties,type:f.type,sourceLayerIndex:x,index:_,geometry:b?T.geometry:Li(f,n,a),patterns:{},sortKey:C};h.push(P)}l&&h.sort((f,m)=>f.sortKey-m.sortKey);for(const f of h){const{geometry:m,index:_,sourceLayerIndex:x}=f;if(this.hasPattern){const b=km("fill",this.layers,f,this.zoom,r);this.patternFeatures.push(b)}else this.addFeature(f,m,_,n,{},r.availableImages,r.brightness);r.featureIndex.insert(e[_].feature,m,_,x,this.index)}}update(e,r,n,a,l){const h=Object.keys(e).length!==0;h&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(e,r,h?this.stateDependentLayers:this.layers,n,a,l)}addFeatures(e,r,n,a,l,h){for(const f of this.patternFeatures)this.addFeature(f,f.geometry,f.index,r,n,a,h)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Db),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.indexBuffer2=e.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(e,r,n,a,l,h=[],f){for(const m of Rm(r,500)){let _=0;for(const D of m)_+=D.length;const x=this.segments.prepareSegment(_,this.layoutVertexArray,this.indexArray),b=x.vertexLength,T=[],C=[];for(const D of m){if(D.length===0)continue;D!==m[0]&&C.push(T.length/2);const O=this.segments2.prepareSegment(D.length,this.layoutVertexArray,this.indexArray2),F=O.vertexLength;this.layoutVertexArray.emplaceBack(D[0].x,D[0].y),this.indexArray2.emplaceBack(F+D.length-1,F),T.push(D[0].x),T.push(D[0].y);for(let $=1;$<D.length;$++)this.layoutVertexArray.emplaceBack(D[$].x,D[$].y),this.indexArray2.emplaceBack(F+$-1,F+$),T.push(D[$].x),T.push(D[$].y);O.vertexLength+=D.length,O.primitiveLength+=D.length}const P=vf(T,C);for(let D=0;D<P.length;D+=3)this.indexArray.emplaceBack(b+P[D],b+P[D+1],b+P[D+2]);x.vertexLength+=_,x.primitiveLength+=P.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,n,l,h,a,f)}}mt(Bm,"FillBucket",{omit:["layers","patternFeatures"]});const Zb=new ti({"fill-sort-key":new Lt(be.layout_fill["fill-sort-key"]),visibility:new Je(be.layout_fill.visibility)});var Gb={paint:new ti({"fill-antialias":new Je(be.paint_fill["fill-antialias"]),"fill-opacity":new Lt(be.paint_fill["fill-opacity"]),"fill-color":new Lt(be.paint_fill["fill-color"]),"fill-outline-color":new Lt(be.paint_fill["fill-outline-color"]),"fill-translate":new Je(be.paint_fill["fill-translate"]),"fill-translate-anchor":new Je(be.paint_fill["fill-translate-anchor"]),"fill-pattern":new Lt(be.paint_fill["fill-pattern"]),"fill-emissive-strength":new Je(be.paint_fill["fill-emissive-strength"])}),layout:Zb};const $b=Dr([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),qb=Dr([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),Wb=Dr([{name:"a_centroid_pos",components:2,type:"Uint16"}]),Hb=Dr([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),Xb=Dr([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:Yb}=$b;var bf={},Kb=Lr,J0=vc;function vc(t,e,r,n,a){this.properties={},this.extent=r,this.type=0,this._pbf=t,this._geometry=-1,this._keys=n,this._values=a,t.readFields(Jb,this,e)}function Jb(t,e,r){t==1?e.id=r.readVarint():t==2?function(n,a){for(var l=n.readVarint()+n.pos;n.pos<l;){var h=a._keys[n.readVarint()],f=a._values[n.readVarint()];a.properties[h]=f}}(r,e):t==3?e.type=r.readVarint():t==4&&(e._geometry=r.pos)}function Qb(t){for(var e,r,n=0,a=0,l=t.length,h=l-1;a<l;h=a++)n+=((r=t[h]).x-(e=t[a]).x)*(e.y+r.y);return n}vc.types=["Unknown","Point","LineString","Polygon"],vc.prototype.loadGeometry=function(){var t=this._pbf;t.pos=this._geometry;for(var e,r=t.readVarint()+t.pos,n=1,a=0,l=0,h=0,f=[];t.pos<r;){if(a<=0){var m=t.readVarint();n=7&m,a=m>>3}if(a--,n===1||n===2)l+=t.readSVarint(),h+=t.readSVarint(),n===1&&(e&&f.push(e),e=[]),e.push(new Kb(l,h));else{if(n!==7)throw new Error("unknown command "+n);e&&e.push(e[0].clone())}}return e&&f.push(e),f},vc.prototype.bbox=function(){var t=this._pbf;t.pos=this._geometry;for(var e=t.readVarint()+t.pos,r=1,n=0,a=0,l=0,h=1/0,f=-1/0,m=1/0,_=-1/0;t.pos<e;){if(n<=0){var x=t.readVarint();r=7&x,n=x>>3}if(n--,r===1||r===2)(a+=t.readSVarint())<h&&(h=a),a>f&&(f=a),(l+=t.readSVarint())<m&&(m=l),l>_&&(_=l);else if(r!==7)throw new Error("unknown command "+r)}return[h,m,f,_]},vc.prototype.toGeoJSON=function(t,e,r){var n,a,l=this.extent*Math.pow(2,r),h=this.extent*t,f=this.extent*e,m=this.loadGeometry(),_=vc.types[this.type];function x(C){for(var P=0;P<C.length;P++){var D=C[P];C[P]=[360*(D.x+h)/l-180,360/Math.PI*Math.atan(Math.exp((180-360*(D.y+f)/l)*Math.PI/180))-90]}}switch(this.type){case 1:var b=[];for(n=0;n<m.length;n++)b[n]=m[n][0];x(m=b);break;case 2:for(n=0;n<m.length;n++)x(m[n]);break;case 3:for(m=function(C){var P=C.length;if(P<=1)return[C];for(var D,O,F=[],$=0;$<P;$++){var X=Qb(C[$]);X!==0&&(O===void 0&&(O=X<0),O===X<0?(D&&F.push(D),D=[C[$]]):D.push(C[$]))}return D&&F.push(D),F}(m),n=0;n<m.length;n++)for(a=0;a<m[n].length;a++)x(m[n][a])}m.length===1?m=m[0]:_="Multi"+_;var T={type:"Feature",geometry:{type:_,coordinates:m},properties:this.properties};return"id"in this&&(T.id=this.id),T};var ew=J0,Q0=ey;function ey(t,e){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=t,this._keys=[],this._values=[],this._features=[],t.readFields(tw,this,e),this.length=this._features.length}function tw(t,e,r){t===15?e.version=r.readVarint():t===1?e.name=r.readString():t===5?e.extent=r.readVarint():t===2?e._features.push(r.pos):t===3?e._keys.push(r.readString()):t===4&&e._values.push(function(n){for(var a=null,l=n.readVarint()+n.pos;n.pos<l;){var h=n.readVarint()>>3;a=h===1?n.readString():h===2?n.readFloat():h===3?n.readDouble():h===4?n.readVarint64():h===5?n.readVarint():h===6?n.readSVarint():h===7?n.readBoolean():null}return a}(r))}ey.prototype.feature=function(t){if(t<0||t>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[t];var e=this._pbf.readVarint()+this._pbf.pos;return new ew(this._pbf,e,this.extent,this._keys,this._values)};var rw=Q0;function iw(t,e,r){if(t===3){var n=new rw(r,r.readVarint()+r.pos);n.length&&(e[n.name]=n)}}var Fm=bf.VectorTile=function(t,e){this.layers=t.readFields(iw,{},e)},wf=bf.VectorTileFeature=J0;function Tf(t,e,r,n){const a=[],l=n===0?(h,f,m,_,x,b)=>{h.push(new Ge(b,m+(b-f)/(_-f)*(x-m)))}:(h,f,m,_,x,b)=>{h.push(new Ge(f+(b-m)/(x-m)*(_-f),b))};for(const h of t){const f=[];for(const m of h){if(m.length<=2)continue;const _=[];for(let T=0;T<m.length-1;T++){const C=m[T].x,P=m[T].y,D=m[T+1].x,O=m[T+1].y,F=n===0?C:P,$=n===0?D:O;F<e?$>e&&l(_,C,P,D,O,e):F>r?$<r&&l(_,C,P,D,O,r):_.push(m[T]),$<e&&F>=e&&l(_,C,P,D,O,e),$>r&&F<=r&&l(_,C,P,D,O,r)}let x=m[m.length-1];const b=n===0?x.x:x.y;b>=e&&b<=r&&_.push(x),_.length&&(x=_[_.length-1],_[0].x===x.x&&_[0].y===x.y||_.push(_[0]),f.push(_))}f.length&&a.push(f)}return a}function Ef(t,e){return t.x-e.x||t.y-e.y}function ty(t,e){return Ef(t.min,e.min)===0&&Ef(t.max,e.max)===0}function ry(t,e){return!(t.min.x>e.max.x||t.max.x<e.min.x||t.min.y>e.max.y||t.max.y<e.min.y)}function iy(t,e,r){const n=1/ct,a=1/(1<<r.canonical.z),l=(e.x*n+r.canonical.x)*a+r.wrap,h=(e.y*n+r.canonical.y)*a;return{min:new Ge((t.x*n+r.canonical.x)*a+r.wrap,(t.y*n+r.canonical.y)*a),max:new Ge(l,h)}}function nw(t,e,r){const n=1<<r.canonical.z,a=((e.x-r.wrap)*n-r.canonical.x)*ct,l=(e.y*n-r.canonical.y)*ct;return{min:new Ge(((t.x-r.wrap)*n-r.canonical.x)*ct,(t.y*n-r.canonical.y)*ct),max:new Ge(a,l)}}function ny(t,e,r,n,a,l,h){const f=t.indices,m=t.vertices,_=[];for(let x=n;x<n+a;x+=3){const b=e[r[x+0]+l],T=e[r[x+1]+l],C=e[r[x+2]+l],P=Math.min(b.x,T.x,C.x),D=Math.max(b.x,T.x,C.x),O=Math.min(b.y,T.y,C.y),F=Math.max(b.y,T.y,C.y);_.length=0,t.grid.query(new Ge(P,O),new Ge(D,F),_);for(let $=0;$<_.length;$++){const X=_[$];if(om(m[f[3*X+0]],m[f[3*X+1]],m[f[3*X+2]],b,T,C,h))return!0}}return!1}function oy(t,e,r,n){if(!t||!r)return!1;let a=t.vertices;if(!e.canonical.equals(n.canonical)||e.wrap!==n.wrap){if(r.vertices.length<t.vertices.length)return oy(r,n,t,e);const l=e.canonical,h=n.canonical,f=Math.pow(2,h.z-l.z);a=t.vertices.map(m=>new Ge(m.x*l.x*ct*f-h.x*ct,m.y*l.y*ct*f-h.y*ct))}return ny(r,a,t.indices,0,t.indices.length,0,0)}bf.VectorTileLayer=Q0;class sy{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,r){const n=this.toIdx(e,r);return{min:this.minimums[n],max:this.maximums[n]}}isLeaf(e,r){return this.leaves[this.toIdx(e,r)]}toIdx(e,r){return r*this.size+e}}function ay(t,e,r,n){let a=0,l=Number.MAX_VALUE;for(let h=0;h<3;h++)if(Math.abs(n[h])<1e-15){if(r[h]<t[h]||r[h]>e[h])return null}else{const f=1/n[h];let m=(t[h]-r[h])*f,_=(e[h]-r[h])*f;if(m>_){const x=m;m=_,_=x}if(m>a&&(a=m),_<l&&(l=_),a>l)return null}return a}function ly(t,e,r,n,a,l,h,f,m,_,x){const b=n-t,T=a-e,C=l-r,P=h-t,D=f-e,O=m-r,F=x[1]*O-x[2]*D,$=x[2]*P-x[0]*O,X=x[0]*D-x[1]*P,H=b*F+T*$+C*X;if(Math.abs(H)<1e-15)return null;const ne=1/H,re=_[0]-t,ce=_[1]-e,pe=_[2]-r,ye=(re*F+ce*$+pe*X)*ne;if(ye<0||ye>1)return null;const Te=ce*C-pe*T,xe=pe*b-re*C,Se=re*T-ce*b,Be=(x[0]*Te+x[1]*xe+x[2]*Se)*ne;return Be<0||ye+Be>1?null:(P*Te+D*xe+O*Se)*ne}function cy(t,e,r){return(t-e)/(r-e)}function uy(t,e,r,n,a,l,h,f,m){const _=1<<r,x=l-n,b=h-a,T=(t+1)/_*x+n,C=(e+0)/_*b+a,P=(e+1)/_*b+a;f[0]=(t+0)/_*x+n,f[1]=C,m[0]=T,m[1]=P}class hy{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const r=function(l){const h=Math.ceil(Math.log2(l.dim/8)),f=[];let m=Math.ceil(Math.pow(2,h));const _=1/m,x=(C,P,D,O,F)=>{const $=O?1:0,X=(C+1)*D-$,H=P*D,ne=(P+1)*D-$;F[0]=C*D,F[1]=H,F[2]=X,F[3]=ne};let b=new sy(m);const T=[];for(let C=0;C<m*m;C++){x(C%m,Math.floor(C/m),_,!1,T);const P=ma(T[0],T[1],l),D=ma(T[2],T[1],l),O=ma(T[2],T[3],l),F=ma(T[0],T[3],l);b.minimums.push(Math.min(P,D,O,F)),b.maximums.push(Math.max(P,D,O,F)),b.leaves.push(1)}for(f.push(b),m/=2;m>=1;m/=2){const C=f[f.length-1];b=new sy(m);for(let P=0;P<m*m;P++){x(P%m,Math.floor(P/m),2,!0,T);const D=C.getElevation(T[0],T[1]),O=C.getElevation(T[2],T[1]),F=C.getElevation(T[2],T[3]),$=C.getElevation(T[0],T[3]),X=C.isLeaf(T[0],T[1]),H=C.isLeaf(T[2],T[1]),ne=C.isLeaf(T[2],T[3]),re=C.isLeaf(T[0],T[3]),ce=Math.min(D.min,O.min,F.min,$.min),pe=Math.max(D.max,O.max,F.max,$.max),ye=X&&H&&ne&&re;b.maximums.push(pe),b.minimums.push(ce),b.leaves.push(pe-ce<=5&&ye?1:0)}f.push(b)}return f}(this.dem),n=r.length-1,a=r[n];this._addNode(a.minimums[0],a.maximums[0],a.leaves[0]),this._construct(r,0,0,n,0)}raycastRoot(e,r,n,a,l,h,f=1){return ay([e,r,-100],[n,a,this.maximums[0]*f],l,h)}raycast(e,r,n,a,l,h,f=1){if(!this.nodeCount)return null;const m=this.raycastRoot(e,r,n,a,l,h,f);if(m==null)return null;const _=[],x=[],b=[],T=[],C=[{idx:0,t:m,nodex:0,nodey:0,depth:0}];for(;C.length>0;){const{idx:P,t:D,nodex:O,nodey:F,depth:$}=C.pop();if(this.leaves[P]){uy(O,F,$,e,r,n,a,b,T);const H=1<<$,ne=(O+0)/H,re=(O+1)/H,ce=(F+0)/H,pe=(F+1)/H,ye=ma(ne,ce,this.dem)*f,Te=ma(re,ce,this.dem)*f,xe=ma(re,pe,this.dem)*f,Se=ma(ne,pe,this.dem)*f,Be=ly(b[0],b[1],ye,T[0],b[1],Te,T[0],T[1],xe,l,h),Ce=ly(T[0],T[1],xe,b[0],T[1],Se,b[0],b[1],ye,l,h),Oe=Math.min(Be!==null?Be:Number.MAX_VALUE,Ce!==null?Ce:Number.MAX_VALUE);if(Oe!==Number.MAX_VALUE)return Oe;{const Me=s.N.scaleAndAdd([],l,h,D);if(dy(ye,Te,Se,xe,cy(Me[0],b[0],T[0]),cy(Me[1],b[1],T[1]))>=Me[2])return D}continue}let X=0;for(let H=0;H<this._siblingOffset.length;H++){uy((O<<1)+this._siblingOffset[H][0],(F<<1)+this._siblingOffset[H][1],$+1,e,r,n,a,b,T),b[2]=-100,T[2]=this.maximums[this.childOffsets[P]+H]*f;const ne=ay(b,T,l,h);if(ne!=null){const re=ne;_[H]=re;let ce=!1;for(let pe=0;pe<X&&!ce;pe++)re>=_[x[pe]]&&(x.splice(pe,0,H),ce=!0);ce||(x[X]=H),X++}}for(let H=0;H<X;H++){const ne=x[H];C.push({idx:this.childOffsets[P]+ne,t:_[ne],nodex:(O<<1)+this._siblingOffset[ne][0],nodey:(F<<1)+this._siblingOffset[ne][1],depth:$+1})}}return null}_addNode(e,r,n){return this.minimums.push(e),this.maximums.push(r),this.leaves.push(n),this.childOffsets.push(0),this.nodeCount++}_construct(e,r,n,a,l){if(e[a].isLeaf(r,n)===1)return;this.childOffsets[l]||(this.childOffsets[l]=this.nodeCount);const h=a-1,f=e[h];let m=0,_=0;for(let x=0;x<this._siblingOffset.length;x++){const b=2*r+this._siblingOffset[x][0],T=2*n+this._siblingOffset[x][1],C=f.getElevation(b,T),P=f.isLeaf(b,T),D=this._addNode(C.min,C.max,P);P&&(m|=1<<x),_||(_=D)}for(let x=0;x<this._siblingOffset.length;x++)m&1<<x||this._construct(e,2*r+this._siblingOffset[x][0],2*n+this._siblingOffset[x][1],h,_+x)}}function dy(t,e,r,n,a,l){return ur(ur(t,r,l),ur(e,n,l),a)}function ma(t,e,r){const n=r.dim,a=Ut(t*n-.5,0,n-1),l=Ut(e*n-.5,0,n-1),h=Math.floor(a),f=Math.floor(l),m=Math.min(h+1,n-1),_=Math.min(f+1,n-1);return dy(r.get(h,f),r.get(m,f),r.get(h,_),r.get(m,_),a-h,l-f)}const ow={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function sw(t,e,r){return(256*t*256+256*e+r)/10-1e4}function aw(t,e,r){return 256*t+e+r/256-32768}class Mf{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,r,n,a=!1){if(this.uid=e,r.height!==r.width)throw new RangeError("DEM tiles must be square");if(n&&n!=="mapbox"&&n!=="terrarium")return li(`"${n}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=r.height;const l=this.dim=r.height-2,h=new Uint32Array(r.data.buffer);if(this.pixels=new Uint8Array(r.data.buffer),this.floatView=new Float32Array(r.data.buffer),this.borderReady=a,this._modifiedForSources={},!a){for(let m=0;m<l;m++)h[this._idx(-1,m)]=h[this._idx(0,m)],h[this._idx(l,m)]=h[this._idx(l-1,m)],h[this._idx(m,-1)]=h[this._idx(m,0)],h[this._idx(m,l)]=h[this._idx(m,l-1)];h[this._idx(-1,-1)]=h[this._idx(0,0)],h[this._idx(l,-1)]=h[this._idx(l-1,0)],h[this._idx(-1,l)]=h[this._idx(0,l-1)],h[this._idx(l,l)]=h[this._idx(l-1,l-1)]}const f=n==="terrarium"?aw:sw;for(let m=0;m<h.length;++m){const _=4*m;this.floatView[m]=f(this.pixels[_],this.pixels[_+1],this.pixels[_+2])}this._timestamp=We.now()}_buildQuadTree(){this._tree=new hy(this)}get(e,r,n=!1){n&&(e=Ut(e,-1,this.dim),r=Ut(r,-1,this.dim));const a=this._idx(e,r);return this.floatView[a]}set(e,r,n){const a=this._idx(e,r),l=this.floatView[a];return this.floatView[a]=n,n-l}static getUnpackVector(e){return ow[e]}_idx(e,r){if(e<-1||e>=this.dim+1||r<-1||r>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(r+1)*this.stride+(e+1)}static pack(e,r){const n=[0,0,0,0],a=Mf.getUnpackVector(r);let l=Math.floor((e+a[3])/a[2]);return n[2]=l%256,l=Math.floor(l/256),n[1]=l%256,l=Math.floor(l/256),n[0]=l,n}getPixels(){return new W0({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,r,n){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let a=r*this.dim,l=r*this.dim+this.dim,h=n*this.dim,f=n*this.dim+this.dim;switch(r){case-1:a=l-1;break;case 1:l=a+1}switch(n){case-1:h=f-1;break;case 1:f=h+1}const m=-r*this.dim,_=-n*this.dim;for(let x=h;x<f;x++)for(let b=a;b<l;b++){const T=4*this._idx(b,x),C=4*this._idx(b+m,x+_);this.pixels[T+0]=e.pixels[C+0],this.pixels[T+1]=e.pixels[C+1],this.pixels[T+2]=e.pixels[C+2],this.pixels[T+3]=e.pixels[C+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}mt(Mf,"DEMData"),mt(hy,"DemMinMaxQuadTree",{omit:["dem"]});class bc{constructor(e,r,n){this._demTile=e,this._dem=this._demTile.dem,this._scale=r,this._offset=n}static create(e,r,n){const a=n||e.findDEMTileFor(r);if(!a||!a.dem)return;const l=a.dem,h=a.tileID,f=1<<r.canonical.z-h.canonical.z;return new bc(a,l.dim/ct/f,[(r.canonical.x/f-h.canonical.x)*l.dim,(r.canonical.y/f-h.canonical.y)*l.dim])}tileCoordToPixel(e,r){const n=r*this._scale+this._offset[1],a=Math.floor(e*this._scale+this._offset[0]),l=Math.floor(n);return new Ge(a,l)}getElevationAt(e,r,n,a){const l=e*this._scale+this._offset[0],h=r*this._scale+this._offset[1],f=Math.floor(l),m=Math.floor(h),_=this._dem;return a=!!a,n?ur(ur(_.get(f,m,a),_.get(f,m+1,a),h-m),ur(_.get(f+1,m,a),_.get(f+1,m+1,a),h-m),l-f):_.get(f,m,a)}getElevationAtPixel(e,r,n){return this._dem.get(e,r,!!n)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*qt(1,e)*this._dem.stride}}const lw=wf.types,cw=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius"],uw=["fill-extrusion-flood-light-ground-radius"],hw=Math.pow(2,13),dw=Math.pow(2,15)-1,fy=new Ge(0,1),_a=2147483648;function Ih(t,e,r,n,a,l,h,f){t.emplaceBack((e<<1)+h,(r<<1)+l,(Math.floor(n*hw)<<1)+a,Math.round(f))}function If(t,e,r,n,a,l){t.emplaceBack(e.x,e.y,(r.x<<1)+n,(r.y<<1)+a,l)}function Ch(t,e,r){t.emplaceBack(e.x,e.y,e.z,r[0]*16384,r[1]*16384,r[2]*16384)}class py{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class my{constructor(){this.centroidXY=new Ge(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new Ge(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new Ge(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new Ge(this.max.x-this.min.x,this.max.y-this.min.y)}}class _y{constructor(){this.acc=new Ge(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(e,r){e.min.x===Number.MAX_VALUE&&(e.min.x=e.max.x=r.x,e.min.y=e.max.y=r.y)}appendEdge(e,r,n){this.accCount++,this.acc._add(r);let a=!!this.borders;r.x<e.min.x?(e.min.x=r.x,a=!0):r.x>e.max.x&&(e.max.x=r.x,a=!0),r.y<e.min.y?(e.min.y=r.y,a=!0):r.y>e.max.y&&(e.max.y=r.y,a=!0),((r.x===0||r.x===ct)&&r.x===n.x)!=((r.y===0||r.y===ct)&&r.y===n.y)&&this.processBorderOverlap(r,n),a&&this.checkBorderIntersection(r,n)}checkBorderIntersection(e,r){r.x<0!=e.x<0&&this.addBorderIntersection(0,ur(r.y,e.y,(0-r.x)/(e.x-r.x))),r.x>ct!=e.x>ct&&this.addBorderIntersection(1,ur(r.y,e.y,(ct-r.x)/(e.x-r.x))),r.y<0!=e.y<0&&this.addBorderIntersection(2,ur(r.x,e.x,(0-r.y)/(e.y-r.y))),r.y>ct!=e.y>ct&&this.addBorderIntersection(3,ur(r.x,e.x,(ct-r.y)/(e.y-r.y)))}addBorderIntersection(e,r){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const n=this.borders[e];r<n[0]&&(n[0]=r),r>n[1]&&(n[1]=r)}processBorderOverlap(e,r){if(e.x===r.x){if(e.y===r.y)return;const n=e.x===0?0:1;this.addBorderIntersection(n,r.y),this.addBorderIntersection(n,e.y)}else{const n=e.y===0?2:3;this.addBorderIntersection(n,r.x),this.addBorderIntersection(n,e.x)}}centroid(){return this.accCount===0?new Ge(0,0):new Ge(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((e,r)=>e+ +(r[0]!==Number.MAX_VALUE),0):0}}function gy(t,e){const r=t.add(e)._unit(),n=Ut(t.x*r.x+t.y*r.y,-1,1);var a,l,h;return a=Math.acos(n),Math.min(4,Math.max(-4,Math.tan(a)))/4*dw*((l=t).x*(h=e).y-l.y*h.x<0?-1:1)}const fw=[t=>t.x<0,t=>t.x>ct,t=>t.y<0,t=>t.y>ct];function pw(t,e,r,n){const a=[4];if(n===0)return a;r._mult(n);const l=t.sub(r),h=e.sub(r),f=[t,e,l,h];for(let m=0;m<4;m++)for(const _ of f)if(fw[m](_)){a.push(m);break}return a}class yy{constructor(e){this.vertexArray=new oh,this.indexArray=new Si,this.programConfigurations=new U(e.layers,e.zoom,r=>uw.includes(r)),this._segments=new ci,this.hiddenByLandmarkVertexArray=new ph,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new ci}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(e,r,n,a=!1){const l=e.length;if(l>2){let h=Math.max(0,this._segments.get().length-1);const f=this._segments._prepareSegment(4*l,this.vertexArray.length,2*this._segmentToGroundQuads[h].length);let m;h!==this._segments.get().length-1&&(h++,this._segmentToGroundQuads[h]=[],this._segmentToRegionTriCounts[h]=[0,0,0,0,0]);{const _=e[0],x=e[1];m=gy(_.sub(e[l-1])._perp()._unit(),x.sub(_)._perp()._unit())}for(let _=0;_<l;_++){const x=_===l-1?0:_+1,b=e[_],T=e[x],C=e[x===l-1?0:x+1],P=T.sub(b)._perp()._unit(),D=gy(P,C.sub(T)._perp()._unit()),O=m,F=D;if(Nm(b,T,r)||a&&by(b,r)&&by(T,r)){m=D;continue}const $=f.vertexLength;If(this.vertexArray,b,T,1,1,O),If(this.vertexArray,b,T,1,0,O),If(this.vertexArray,b,T,0,1,F),If(this.vertexArray,b,T,0,0,F),f.vertexLength+=4;const X=pw(b,T,P,n);for(const H of X)this._segmentToGroundQuads[h].push({id:$,region:H}),this._segmentToRegionTriCounts[h][H]+=2,f.primitiveLength+=2;m=D}}}prepareBorderSegments(){if(!this.hasData())return;const e=this._segments.get(),r=e.length;for(let n=0;n<r;n++)this._segmentToGroundQuads[n].sort((a,l)=>a.region-l.region);for(let n=0;n<r;n++){const a=this._segmentToGroundQuads[n],l=e[n],h=this._segmentToRegionTriCounts[n];h.reduce((m,_)=>m+_,0);let f=0;for(let m=0;m<=4;m++){const _=h[m];if(_!==0){let x=this.regionSegments[m];x||(x=this.regionSegments[m]=new ci);const b={vertexOffset:l.vertexOffset,primitiveOffset:l.primitiveOffset+f,vertexLength:l.vertexLength,primitiveLength:_};x.get().push(b)}f+=_}for(let m=0;m<a.length;m++){const _=a[m].id;this.indexArray.emplaceBack(_,_+1,_+3),this.indexArray.emplaceBack(_,_+3,_+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(e,r,n,a,l,h){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,e,r,n,a,l,h)}upload(e){this.hasData()&&(this.vertexBuffer=e.createVertexBuffer(this.vertexArray,qb.members),this.indexBuffer=e.createIndexBuffer(this.indexArray))}uploadPaintProperties(e){this.hasData()&&this.programConfigurations.upload(e)}update(e,r,n,a,l,h){this.hasData()&&this.programConfigurations.updatePaintArrays(e,r,n,a,l,h)}updateHiddenByLandmark(e){if(!this.hasData())return;const r=e.groundVertexCount+e.groundVertexArrayOffset;if(e.groundVertexCount===0)return;const n=e.flags&_a?1:0;for(let a=e.groundVertexArrayOffset;a<r;++a)this.hiddenByLandmarkVertexArray.emplace(a,n);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(e){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=e.createVertexBuffer(this.hiddenByLandmarkVertexArray,Hb.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let e=0;e<=4;e++){const r=this.regionSegments[e];r&&r.destroy()}}}}class Cf{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.fqid),this.index=e.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=e.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new Si,this.footprintVertices=new qn,this.footprintSegments=[],this.layoutVertexArray=new vo,this.centroidVertexArray=new fl,this.indexArray=new Si,this.programConfigurations=new U(e.layers,e.zoom,r=>cw.includes(r)),this.segments=new ci,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id),this.groundEffect=new yy(e),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[]}populate(e,r,n,a){this.features=[],this.hasPattern=Om("fill-extrusion",this.layers,r),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.tileToMeter=sr(n),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter;for(const{feature:l,id:h,index:f,sourceLayerIndex:m}of e){const _=this.layers[0]._featureFilter.needGeometry,x=wi(l,_);if(!this.layers[0]._featureFilter.filter(new ei(this.zoom),x,n))continue;const b={id:h,sourceLayerIndex:m,index:f,geometry:_?x.geometry:Li(l,n,a),properties:l.properties,type:l.type,patterns:{}},T=this.layoutVertexArray.length;this.hasPattern?this.features.push(km("fill-extrusion",this.layers,b,this.zoom,r)):this.addFeature(b,b.geometry,f,n,{},r.availableImages,a,r.brightness),r.featureIndex.insert(l,b.geometry,f,m,this.index,T)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(e,r,n,a,l,h){for(const f of this.features){const{geometry:m}=f;this.addFeature(f,m,f.index,r,n,a,l,h)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(e,r,n,a,l){const h=Object.keys(e).length!==0;if(h&&!this.stateDependentLayers.length)return;const f=h?this.stateDependentLayers:this.layers;this.programConfigurations.updatePaintArrays(e,r,f,n,a,l),this.groundEffect.update(e,r,f,n,a,l)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Yb),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,Xb.members,!0)),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.groundEffect.uploadHiddenByLandmark(e),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,Wb.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,r,n,a,l,h,f,m){const _=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(e,{})/this.tileToMeter,x=[new Ge(0,0),new Ge(ct,ct)],b=f.projection,T=b.name==="globe",C=lw[e.type]==="Polygon",P=new _y;P.centroidDataIndex=this.centroidData.length;const D=new my,O=this.layers[0].paint.get("fill-extrusion-base").evaluate(e,{},a)<=0,F=this.layers[0].paint.get("fill-extrusion-height").evaluate(e,{},a);D.height=F,D.vertexArrayOffset=this.layoutVertexArray.length,D.groundVertexArrayOffset=this.groundEffect.vertexArray.length,T&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new uc);const $=Rm(r,500);for(let pe=$.length-1;pe>=0;pe--){const ye=$[pe];(ye.length===0||(X=ye[0]).every(Te=>Te.x<=0)||X.every(Te=>Te.x>=ct)||X.every(Te=>Te.y<=0)||X.every(Te=>Te.y>=ct))&&$.splice(pe,1)}var X;let H;if(T)H=My($,x,a);else{H=[];for(const pe of $)H.push({polygon:pe,bounds:x})}const ne=C?this.edgeRadius:0,re=ne>0&&this.zoom<17,ce=(pe,ye)=>{if(pe.length===0)return!1;const Te=pe[pe.length-1];return ye.x===Te.x&&ye.y===Te.y};for(const{polygon:pe,bounds:ye}of H){let Te=0,xe=0;for(const Oe of pe)C&&!Oe[0].equals(Oe[Oe.length-1])&&Oe.push(Oe[0]),xe+=C?Oe.length-1:Oe.length;const Se=this.segments.prepareSegment((C?5:4)*xe,this.layoutVertexArray,this.indexArray);D.footprintSegIdx<0&&(D.footprintSegIdx=this.footprintSegments.length),D.polygonSegIdx<0&&(D.polygonSegIdx=this.polygonSegments.length);const Be={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},Ce=new py;if(Ce.vertexOffset=this.footprintVertices.length,Ce.indexOffset=3*this.footprintIndices.length,Ce.ringIndices=[],C){const Oe=[],Me=[];Te=Se.vertexLength;for(let et=0;et<pe.length;et++){const Ne=pe[et];Ne.length&&et!==0&&Me.push(Oe.length/2);const gt=[];let ht,je;ht=Ne[1].sub(Ne[0])._perp()._unit(),Ce.ringIndices.push(Ne.length-1);for(let kt=1;kt<Ne.length;kt++){const Mt=Ne[kt],_t=Ne[kt===Ne.length-1?1:kt+1],Ze=Mt.clone();if(ne){je=_t.sub(Mt)._perp()._unit();const Dt=ht.add(je)._unit(),Qt=ne*Math.min(4,1/(ht.x*Dt.x+ht.y*Dt.y));Ze.x+=Qt*Dt.x,Ze.y+=Qt*Dt.y,Ze.x=Math.round(Ze.x),Ze.y=Math.round(Ze.y),ht=je}!O||ne!==0&&!re||ce(gt,Ze)||gt.push(Ze),Ih(this.layoutVertexArray,Ze.x,Ze.y,0,0,1,1,0),Se.vertexLength++,this.footprintVertices.emplaceBack(Mt.x,Mt.y),Oe.push(Mt.x,Mt.y),T&&Ch(this.layoutVertexExtArray,b.projectTilePoint(Ze.x,Ze.y,a),b.upVector(a,Ze.x,Ze.y))}O&&(ne===0||re)&&(gt.length!==0&&ce(gt,gt[0])&&gt.pop(),this.groundEffect.addData(gt,ye,_))}const Re=vf(Oe,Me);for(let et=0;et<Re.length;et+=3)this.footprintIndices.emplaceBack(Ce.vertexOffset+Re[et+0],Ce.vertexOffset+Re[et+1],Ce.vertexOffset+Re[et+2]),this.indexArray.emplaceBack(Te+Re[et],Te+Re[et+2],Te+Re[et+1]),Se.primitiveLength++;Ce.indexCount+=Re.length,Ce.vertexCount+=this.footprintVertices.length-Ce.vertexOffset}for(let Oe=0;Oe<pe.length;Oe++){const Me=pe[Oe];P.startRing(D,Me[0]);let Re=Me.length>4&&wy(Me[Me.length-2],Me[0],Me[1]),et=ne?mw(Me[Me.length-2],Me[0],Me[1],ne):0;const Ne=[];let gt,ht,je;ht=Me[1].sub(Me[0])._perp()._unit();let kt=!0;for(let Mt=1,_t=0;Mt<Me.length;Mt++){let Ze=Me[Mt-1],Dt=Me[Mt];const Qt=Me[Mt===Me.length-1?1:Mt+1];if(P.appendEdge(D,Dt,Ze),Nm(Dt,Ze,ye)){ne&&(ht=Qt.sub(Dt)._perp()._unit(),kt=!kt);continue}const Bt=Dt.sub(Ze)._perp(),er=Bt.x/(Math.abs(Bt.x)+Math.abs(Bt.y)),Zt=Bt.y>0?1:0,hr=Ze.dist(Dt);if(_t+hr>32768&&(_t=0),ne){je=Qt.sub(Dt)._perp()._unit();let br=vy(Ze,Dt,Qt,xy(ht,je),ne);isNaN(br)&&(br=0);const Ar=Dt.sub(Ze)._unit();Ze=Ze.add(Ar.mult(et))._round(),Dt=Dt.add(Ar.mult(-br))._round(),et=br,ht=je,O&&this.zoom>=17&&(ce(Ne,Ze)||Ne.push(Ze),ce(Ne,Dt)||Ne.push(Dt))}const Wt=Se.vertexLength,Ur=Me.length>4&&wy(Ze,Dt,Qt);let xr=Ty(_t,Re,kt);if(Ih(this.layoutVertexArray,Ze.x,Ze.y,er,Zt,0,0,xr),Ih(this.layoutVertexArray,Ze.x,Ze.y,er,Zt,0,1,xr),_t+=hr,xr=Ty(_t,Ur,!kt),Re=Ur,Ih(this.layoutVertexArray,Dt.x,Dt.y,er,Zt,0,0,xr),Ih(this.layoutVertexArray,Dt.x,Dt.y,er,Zt,0,1,xr),Se.vertexLength+=4,this.indexArray.emplaceBack(Wt+0,Wt+1,Wt+2),this.indexArray.emplaceBack(Wt+1,Wt+3,Wt+2),Se.primitiveLength+=2,ne){const br=Te+(Mt===1?Me.length-2:Mt-2),Ar=Mt===1?Te:br+1;if(this.indexArray.emplaceBack(Wt+1,br,Wt+3),this.indexArray.emplaceBack(br,Ar,Wt+3),Se.primitiveLength+=2,gt===void 0&&(gt=Wt),!Nm(Qt,Me[Mt],ye)){const vr=Mt===Me.length-1?gt:Se.vertexLength;this.indexArray.emplaceBack(Wt+2,Wt+3,vr),this.indexArray.emplaceBack(Wt+3,vr+1,vr),this.indexArray.emplaceBack(Wt+3,Ar,vr+1),Se.primitiveLength+=3}kt=!kt}if(T){const br=this.layoutVertexExtArray,Ar=b.projectTilePoint(Ze.x,Ze.y,a),vr=b.projectTilePoint(Dt.x,Dt.y,a),Qr=b.upVector(a,Ze.x,Ze.y),Rr=b.upVector(a,Dt.x,Dt.y);Ch(br,Ar,Qr),Ch(br,Ar,Qr),Ch(br,vr,Rr),Ch(br,vr,Rr)}}C&&(Te+=Me.length-1),O&&ne&&this.zoom>=17&&(Ne.length!==0&&ce(Ne,Ne[0])&&Ne.pop(),this.groundEffect.addData(Ne,ye,_,ne>0))}this.footprintSegments.push(Ce),Be.triangleCount=this.indexArray.length-Be.triangleArrayOffset,this.polygonSegments.push(Be),++D.footprintSegLen,++D.polygonSegLen}if(D.vertexCount=this.layoutVertexArray.length-D.vertexArrayOffset,D.groundVertexCount=this.groundEffect.vertexArray.length-D.groundVertexArrayOffset,D.vertexCount!==0){if(D.centroidXY=P.borders?fy:this.encodeCentroid(P,D),this.centroidData.push(D),P.borders){this.featuresOnBorder.push(P);const pe=this.featuresOnBorder.length-1;for(let ye=0;ye<P.borders.length;ye++)P.borders[ye][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[ye].push(pe)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,n,l,h,a,m),this.groundEffect.addPaintPropertiesData(e,n,l,h,a,m),this.maxHeight=Math.max(this.maxHeight,F)}}sortBorders(){for(let e=0;e<this.borderFeatureIndices.length;e++)this.borderFeatureIndices[e].sort((r,n)=>this.featuresOnBorder[r].borders[e][0]-this.featuresOnBorder[n].borders[e][0])}splitToSubtiles(){const e=[];for(let f=0;f<this.centroidData.length;f++){const m=this.centroidData[f],_=+(m.min.y+m.max.y>ct),x=2*_+(+(m.min.x+m.max.x>ct)^_);for(let b=0;b<m.polygonSegLen;b++){const T=m.polygonSegIdx+b;e.push({centroidIdx:f,subtile:x,polygonSegmentIdx:T,triangleSegmentIdx:this.polygonSegments[T].triangleSegIdx})}}const r=new Si;e.sort((f,m)=>f.triangleSegmentIdx===m.triangleSegmentIdx?f.subtile-m.subtile:f.triangleSegmentIdx-m.triangleSegmentIdx);let n=0,a=0,l=0;for(const f of e){if(f.triangleSegmentIdx!==n)break;l++}const h=e.length;for(;a!==e.length;){n=e[a].triangleSegmentIdx;let f=0,m=a,_=a;for(let x=m;x<l&&e[x].subtile===f;x++)_++;for(;m!==l;){const x=e[m];f=x.subtile;const b=this.centroidData[x.centroidIdx].min.clone(),T=this.centroidData[x.centroidIdx].max.clone(),C={vertexOffset:this.segments.segments[n].vertexOffset,primitiveOffset:r.length,vertexLength:this.segments.segments[n].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let P=m;P<_;P++){const D=e[P],O=this.polygonSegments[D.polygonSegmentIdx],F=this.centroidData[D.centroidIdx].min,$=this.centroidData[D.centroidIdx].max,X=this.indexArray.uint16;for(let H=O.triangleArrayOffset;H<O.triangleArrayOffset+O.triangleCount;H++)r.emplaceBack(X[3*H],X[3*H+1],X[3*H+2]);C.primitiveLength+=O.triangleCount,b.x=Math.min(b.x,F.x),b.y=Math.min(b.y,F.y),T.x=Math.max(T.x,$.x),T.y=Math.max(T.y,$.y)}C.primitiveLength>0&&this.triangleSubSegments.push({segment:C,min:b,max:T}),m=_;for(let P=m;P<l&&e[P].subtile===e[m].subtile;P++)_++}a=l;for(let x=a;x<h&&e[x].triangleSegmentIdx===e[a].triangleSegmentIdx;x++)l++}r._trim(),this.indexArray=r}getVisibleSegments(e,r,n){let a=0,l=0;const h=1<<e.canonical.z;if(r){const D=r.getMinMaxForTile(e);D&&(a=D.min,l=D.max)}l+=this.maxHeight;const f=e.toUnwrapped();let m;const _=[f.canonical.x/h+f.wrap,f.canonical.y/h],x=[(f.canonical.x+1)/h+f.wrap,(f.canonical.y+1)/h],b=new ci,T=(D,O,F)=>[D[0]*(1-F[0])+O[0]*F[0],D[1]*(1-F[1])+O[1]*F[1]],C=[],P=[];for(const D of this.triangleSubSegments){C[0]=D.min.x/ct,C[1]=D.min.y/ct,P[0]=D.max.x/ct,P[1]=D.max.y/ct;const O=T(_,x,C),F=T(_,x,P);if(new ai([O[0],O[1],a],[F[0],F[1],l]).intersectsPrecise(n)===0){m&&(b.segments.push(m),m=void 0);continue}const $=D.segment;m&&m.vertexOffset!==$.vertexOffset&&(b.segments.push(m),m=void 0),m?(m.vertexLength+=$.vertexLength,m.primitiveLength+=$.primitiveLength):m={vertexOffset:$.vertexOffset,primitiveLength:$.primitiveLength,vertexLength:$.vertexLength,primitiveOffset:$.primitiveOffset,sortKey:void 0,vaos:{}}}return m&&b.segments.push(m),b}encodeCentroid(e,r){const n=e.centroid(),a=r.span(),l=Math.min(7,Math.round(a.x*this.tileToMeter/10)),h=Math.min(7,Math.round(a.y*this.tileToMeter/10));return new Ge(Ut(n.x,1,ct-1)<<3|l,Ut(n.y,1,ct-1)<<3|h)}encodeBorderCentroid(e){if(!e.borders)return new Ge(0,0);const r=e.borders,n=Number.MAX_VALUE;if(r[0][0]!==n||r[1][0]!==n){const a=r[0][0]!==n?0:1;return new Ge(6|(r[0][0]!==n?0:65528),(r[a][0]+r[a][1])/2<<3|6)}{const a=r[2][0]!==n?2:3;return new Ge((r[a][0]+r[a][1])/2<<3|6,6|(r[2][0]!==n?0:65528))}}showCentroid(e){const r=this.centroidData[e.centroidDataIndex];r.flags&=_a,r.centroidXY.x=0,r.centroidXY.y=0,this.writeCentroidToBuffer(r)}writeCentroidToBuffer(e){this.groundEffect.updateHiddenByLandmark(e);const r=e.vertexArrayOffset,n=e.vertexCount+e.vertexArrayOffset,a=e.flags&_a?fy:e.centroidXY,l=this.centroidVertexArray.geta_centroid_pos0(r);if(this.centroidVertexArray.geta_centroid_pos1(r)!==a.y||l!==a.x){for(let h=r;h<n;++h)this.centroidVertexArray.emplace(h,a.x,a.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const e of this.centroidData)this.writeCentroidToBuffer(e)}updateReplacement(e,r){if(r.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=r.updateTime;const n=r.getReplacementRegionsForTile(e.toUnwrapped());if(function(l,h){if(l.length!==h.length)return!1;for(let f=0;f<l.length;f++)if(l[f].sourceId!==h[f].sourceId||!ty(l[f],h[f]))return!1;return!0}(this.activeReplacements,n))return;if(this.activeReplacements=n,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(const l of this.centroidData)l.flags&=2147483647;const a=[];for(const l of this.activeReplacements){const h=Math.pow(2,l.footprintTileId.canonical.z-e.canonical.z);for(const f of this.centroidData)if(!(f.flags&_a||l.min.x>f.max.x||f.min.x>l.max.x||l.min.y>f.max.y||f.min.y>l.max.y))for(let m=0;m<f.footprintSegLen;m++){const _=this.footprintSegments[f.footprintSegIdx+m];if(a.length=0,_w(this.footprintVertices,_.vertexOffset,_.vertexCount,l.footprintTileId.canonical,e.canonical,a),ny(l.footprint,a,this.footprintIndices.uint16,_.indexOffset,_.indexCount,-_.vertexOffset,-h)){f.flags|=_a;break}}}for(const l of this.centroidData)this.writeCentroidToBuffer(l);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(e,r,n){let a=!1;for(let l=0;l<n.footprintSegLen;l++){const h=this.footprintSegments[n.footprintSegIdx+l];let f=0;for(const m of h.ringIndices){for(let _=f,x=m+f-1;_<m+f;x=_++){const b=this.footprintVertices.int16[2*(_+h.vertexOffset)+0],T=this.footprintVertices.int16[2*(_+h.vertexOffset)+1],C=this.footprintVertices.int16[2*(x+h.vertexOffset)+1];T>r!=C>r&&e<(this.footprintVertices.int16[2*(x+h.vertexOffset)+0]-b)*(r-T)/(C-T)+b&&(a=!a)}f=m}}return a}getHeightAtTileCoord(e,r){let n=Number.NEGATIVE_INFINITY,a=!0;const l=4*(e+ct)*ct+(r+ct);if(this.partLookup.hasOwnProperty(l)){const h=this.partLookup[l];return h?{height:h.height,hidden:!!(h.flags&_a)}:void 0}for(const h of this.centroidData)e>h.max.x||h.min.x>e||r>h.max.y||h.min.y>r||this.footprintContainsPoint(e,r,h)&&h&&h.height>n&&(n=h.height,this.partLookup[l]=h,a=!!(h.flags&_a));if(n!==Number.NEGATIVE_INFINITY)return{height:n,hidden:a};this.partLookup[l]=void 0}}function xy(t,e){const r=t.add(e)._unit();return t.x*r.x+t.y*r.y}function mw(t,e,r,n){const a=e.sub(t)._perp()._unit(),l=r.sub(e)._perp()._unit();return vy(t,e,r,xy(a,l),n)}function vy(t,e,r,n,a){const l=Math.sqrt(1-n*n);return Math.min(t.dist(e)/3,e.dist(r)/3,a*l/n)}function Nm(t,e,r){return t.x<r[0].x&&e.x<r[0].x||t.x>r[1].x&&e.x>r[1].x||t.y<r[0].y&&e.y<r[0].y||t.y>r[1].y&&e.y>r[1].y}function by(t,e){return t.x<e[0].x||t.x>e[1].x||t.y<e[0].y||t.y>e[1].y}function wy(t,e,r){if(t.x<0||t.x>=ct||e.x<0||e.x>=ct||r.x<0||r.x>=ct)return!1;const n=r.sub(e),a=n.perp(),l=t.sub(e);return(n.x*l.x+n.y*l.y)/Math.sqrt((n.x*n.x+n.y*n.y)*(l.x*l.x+l.y*l.y))>-.866&&a.x*l.x+a.y*l.y<0}function Ty(t,e,r){const n=e?2|t:-3&t;return r?1|n:-2&n}function Ey(){const t=Math.PI/32,e=Math.tan(t),r=Ie;return r*Math.sqrt(1+2*e*e)-r}function My(t,e,r){const n=1<<r.z,a=$t(r.x/n),l=$t((r.x+1)/n),h=fr(r.y/n),f=fr((r.y+1)/n);return function(m,_,x,b,T=0,C){const P=[];if(!m.length||!x||!b)return P;const D=(re,ce)=>{for(const pe of re)P.push({polygon:pe,bounds:ce})},O=Math.ceil(Math.log2(x)),F=Math.ceil(Math.log2(b)),$=O-F,X=[];for(let re=0;re<Math.abs($);re++)X.push($>0?0:1);for(let re=0;re<Math.min(O,F);re++)X.push(0),X.push(1);let H=m;if(H=Tf(H,_[0].y-T,_[1].y+T,1),H=Tf(H,_[0].x-T,_[1].x+T,0),!H.length)return P;const ne=[];for(X.length?ne.push({polygons:H,bounds:_,depth:0}):D(H,_);ne.length;){const re=ne.pop(),ce=re.depth,pe=X[ce],ye=re.bounds[0],Te=re.bounds[1],xe=pe===0?ye.x:ye.y,Se=pe===0?Te.x:Te.y,Be=C?C(pe,xe,Se):.5*(xe+Se),Ce=Tf(re.polygons,xe-T,Be+T,pe),Oe=Tf(re.polygons,Be-T,Se+T,pe);if(Ce.length){const Me=[ye,new Ge(pe===0?Be:Te.x,pe===1?Be:Te.y)];X.length>ce+1?ne.push({polygons:Ce,bounds:Me,depth:ce+1}):D(Ce,Me)}if(Oe.length){const Me=[new Ge(pe===0?Be:ye.x,pe===1?Be:ye.y),Te];X.length>ce+1?ne.push({polygons:Oe,bounds:Me,depth:ce+1}):D(Oe,Me)}}return P}(t,e,Math.ceil((l-a)/11.25),Math.ceil((h-f)/11.25),1,(m,_,x)=>{if(m===0)return .5*(_+x);{const b=fr((r.y+_/ct)/n);return(Vt(.5*(fr((r.y+x/ct)/n)+b))*n-r.y)*ct}})}function _w(t,e,r,n,a,l){const h=Math.pow(2,n.z-a.z);for(let f=0;f<r;f++){let m=t.int16[2*(f+e)+0],_=t.int16[2*(f+e)+1];m=(m+a.x*ct)*h-n.x*ct,_=(_+a.y*ct)*h-n.y*ct,l.push(new Ge(m,_))}}mt(Cf,"FillExtrusionBucket",{omit:["layers","features"]}),mt(my,"PartData"),mt(py,"FootprintSegment"),mt(_y,"BorderCentroidData"),mt(yy,"GroundEffect");const gw=new ti({visibility:new Je(be["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new Je(be["layout_fill-extrusion"]["fill-extrusion-edge-radius"])});var yw={paint:new ti({"fill-extrusion-opacity":new Je(be["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Lt(be["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new Je(be["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new Je(be["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Lt(be["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new Lt(be["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Lt(be["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new Je(be["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new Je(be["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new Je(be["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new Je(be["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new Je(be["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new Je(be["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new Je(be["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new Je(be["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new Lt(be["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new Lt(be["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new Je(be["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new Je(be["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new Je(be["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new Je(be["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new Je(be["paint_fill-extrusion"]["fill-extrusion-emissive-strength"])}),layout:gw};class wc extends Ge{constructor(e,r,n){super(e,r),this.z=n}}function Ah(t,e){return t.x*e.x+t.y*e.y}function Iy(t,e){if(t.length===1){let r=0;const n=e[r++];let a;for(;!a||n.equals(a);)if(a=e[r++],!a)return 1/0;for(;r<e.length;r++){const l=e[r],h=t[0],f=a.sub(n),m=l.sub(n),_=h.sub(n),x=Ah(f,f),b=Ah(f,m),T=Ah(m,m),C=Ah(_,f),P=Ah(_,m),D=x*T-b*b,O=(T*C-b*P)/D,F=(x*P-b*C)/D,$=n.z*(1-O-F)+a.z*O+l.z*F;if(isFinite($))return $}return 1/0}{let r=1/0;for(const n of e)r=Math.min(r,n.z);return r}}function Cy(t,e,r,n,a,l,h,f){const m=h*a.getElevationAt(t,e,!0,!0),_=l[0]!==0,x=_?l[1]===0?h*(l[0]/7-450):h*function(b,T,C){const P=Math.floor(T[0]/8),D=Math.floor(T[1]/8),O=10*(T[0]-8*P),F=10*(T[1]-8*D),$=b.getElevationAt(P,D,!0,!0),X=b.getMeterToDEM(C),H=Math.floor(.5*(O*X-1)),ne=Math.floor(.5*(F*X-1)),re=b.tileCoordToPixel(P,D),ce=2*H+1,pe=2*ne+1,ye=function(Oe,Me,Re,et,Ne){return[Oe.getElevationAtPixel(Me,Re,!0),Oe.getElevationAtPixel(Me+Ne,Re,!0),Oe.getElevationAtPixel(Me,Re+Ne,!0),Oe.getElevationAtPixel(Me+et,Re+Ne,!0)]}(b,re.x-H,re.y-ne,ce,pe),Te=Math.abs(ye[0]-ye[1]),xe=Math.abs(ye[2]-ye[3]),Se=Math.abs(ye[0]-ye[2])+Math.abs(ye[1]-ye[3]),Be=Math.min(.25,.5*X*(Te+xe)/ce),Ce=Math.min(.25,.5*X*Se/pe);return $+Math.max(Be*O,Ce*F)}(a,l,f):m;return{base:m+(r===0)?-1:r,top:_?Math.max(x+n,m+r+2):m+n}}const xw=Dr([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),{members:vw}=xw,bw=Dr([{name:"a_packed",components:4,type:"Float32"}]),{members:ww}=bw;class Ay{constructor(e,r){this.width=e,this.height=r,this.nextRow=0,this.image=new pa({width:e,height:r}),this.positions={},this.uploaded=!1}getDash(e,r){const n=this.getKey(e,r);return this.positions[n]}trim(){const e=this.width,r=this.height=co(this.nextRow);this.image.resize({width:e,height:r})}getKey(e,r){return e.join(",")+r}getDashRanges(e,r,n){const a=[];let l=e.length%2==1?-e[e.length-1]*n:0,h=e[0]*n,f=!0;a.push({left:l,right:h,isDash:f,zeroLength:e[0]===0});let m=e[0];for(let _=1;_<e.length;_++){f=!f;const x=e[_];l=m*n,m+=x,h=m*n,a.push({left:l,right:h,isDash:f,zeroLength:x===0})}return a}addRoundDash(e,r,n){const a=r/2;for(let l=-n;l<=n;l++){const h=this.width*(this.nextRow+n+l);let f=0,m=e[f];for(let _=0;_<this.width;_++){_/m.right>1&&(m=e[++f]);const x=Math.abs(_-m.left),b=Math.abs(_-m.right),T=Math.min(x,b);let C;const P=l/n*(a+1);if(m.isDash){const D=a-Math.abs(P);C=Math.sqrt(T*T+D*D)}else C=a-Math.sqrt(T*T+P*P);this.image.data[h+_]=Math.max(0,Math.min(255,C+128))}}}addRegularDash(e,r){for(let m=e.length-1;m>=0;--m){const _=e[m],x=e[m+1];_.zeroLength?e.splice(m,1):x&&x.isDash===_.isDash&&(x.left=_.left,e.splice(m,1))}const n=e[0],a=e[e.length-1];n.isDash===a.isDash&&(n.left=a.left-this.width,a.right=n.right+this.width);const l=this.width*this.nextRow;let h=0,f=e[h];for(let m=0;m<this.width;m++){m/f.right>1&&(f=e[++h]);const _=Math.abs(m-f.left),x=Math.abs(m-f.right),b=Math.min(_,x);this.image.data[l+m]=Math.max(0,Math.min(255,(f.isDash?b:-b)+r+128))}}addDash(e,r){const n=this.getKey(e,r);if(this.positions[n])return this.positions[n];const a=r==="round",l=a?7:0,h=2*l+1;if(this.nextRow+h>this.height)return li("LineAtlas out of space"),null;e.length===0&&e.push(1);let f=0;for(let x=0;x<e.length;x++)e[x]<0&&(li("Negative value is found in line dasharray, replacing values with 0"),e[x]=0),f+=e[x];if(f!==0){const x=this.width/f,b=this.getDashRanges(e,this.width,x);a?this.addRoundDash(b,x,l):this.addRegularDash(b,r==="square"?.5*x:0)}const m=this.nextRow+l;this.nextRow+=h;const _={tl:[m,l],br:[f,0]};return this.positions[n]=_,_}}mt(Ay,"LineAtlas");const Tw=wf.types,Ew=Math.cos(Math.PI/180*37.5);class Um{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.fqid),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(r=>{this.gradients[r.id]={}}),this.layoutVertexArray=new sh,this.layoutVertexArray2=new Yo,this.indexArray=new Si,this.programConfigurations=new U(e.layers,e.zoom),this.segments=new ci,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(e,r,n,a){this.hasPattern=Om("line",this.layers,r);const l=this.layers[0].layout.get("line-sort-key"),h=[];for(const{feature:x,id:b,index:T,sourceLayerIndex:C}of e){const P=this.layers[0]._featureFilter.needGeometry,D=wi(x,P);if(!this.layers[0]._featureFilter.filter(new ei(this.zoom),D,n))continue;const O=l?l.evaluate(D,{},n):void 0,F={id:b,properties:x.properties,type:x.type,sourceLayerIndex:C,index:T,geometry:P?D.geometry:Li(x,n,a),patterns:{},sortKey:O};h.push(F)}l&&h.sort((x,b)=>x.sortKey-b.sortKey);const{lineAtlas:f,featureIndex:m}=r,_=this.addConstantDashes(f);for(const x of h){const{geometry:b,index:T,sourceLayerIndex:C}=x;if(_&&this.addFeatureDashes(x,f),this.hasPattern){const P=km("line",this.layers,x,this.zoom,r);this.patternFeatures.push(P)}else this.addFeature(x,b,T,n,f.positions,r.availableImages,r.brightness);m.insert(e[T].feature,b,T,C,this.index)}}addConstantDashes(e){let r=!1;for(const n of this.layers){const a=n.paint.get("line-dasharray").value,l=n.layout.get("line-cap").value;if(a.kind!=="constant"||l.kind!=="constant")r=!0;else{const h=l.value,f=a.value;if(!f)continue;e.addDash(f,h)}}return r}addFeatureDashes(e,r){const n=this.zoom;for(const a of this.layers){const l=a.paint.get("line-dasharray").value,h=a.layout.get("line-cap").value;if(l.kind==="constant"&&h.kind==="constant")continue;let f,m;if(l.kind==="constant"){if(f=l.value,!f)continue}else f=l.evaluate({zoom:n},e);m=h.kind==="constant"?h.value:h.evaluate({zoom:n},e),r.addDash(f,m),e.patterns[a.id]=r.getKey(f,m)}}update(e,r,n,a,l){const h=Object.keys(e).length!==0;h&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(e,r,h?this.stateDependentLayers:this.layers,n,a,l)}addFeatures(e,r,n,a,l,h){for(const f of this.patternFeatures)this.addFeature(f,f.geometry,f.index,r,n,a,h)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,ww)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,vw),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&e.properties.hasOwnProperty("mapbox_clip_start")&&e.properties.hasOwnProperty("mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,r,n,a,l,h,f){const m=this.layers[0].layout,_=m.get("line-join").evaluate(e,{}),x=m.get("line-cap").evaluate(e,{}),b=m.get("line-miter-limit"),T=m.get("line-round-limit");this.lineClips=this.lineFeatureClips(e);for(const C of r)this.addLine(C,e,_,x,b,T);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,n,l,h,a,f)}addLine(e,r,n,a,l,h){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let F=0;F<e.length-1;F++)this.totalDistance+=e[F].dist(e[F+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const f=Tw[r.type]==="Polygon";let m=e.length;for(;m>=2&&e[m-1].equals(e[m-2]);)m--;let _=0;for(;_<m-1&&e[_].equals(e[_+1]);)_++;if(m<(f?3:2))return;n==="bevel"&&(l=1.05);const x=this.overscaling<=16?15*ct/(512*this.overscaling):0,b=this.segments.prepareSegment(10*m,this.layoutVertexArray,this.indexArray);let T,C,P,D,O;this.e1=this.e2=-1,f&&(T=e[m-2],O=e[_].sub(T)._unit()._perp());for(let F=_;F<m;F++){if(P=F===m-1?f?e[_+1]:void 0:e[F+1],P&&e[F].equals(P))continue;O&&(D=O),T&&(C=T),T=e[F],O=P?P.sub(T)._unit()._perp():D,D=D||O;let $=D.add(O);$.x===0&&$.y===0||$._unit();const X=D.x*O.x+D.y*O.y,H=$.x*O.x+$.y*O.y,ne=H!==0?1/H:1/0,re=2*Math.sqrt(2-2*H),ce=H<Ew&&C&&P,pe=D.x*O.y-D.y*O.x>0;if(ce&&F>_){const xe=T.dist(C);if(xe>2*x){const Se=T.sub(T.sub(C)._mult(x/xe)._round());this.updateDistance(C,Se),this.addCurrentVertex(Se,D,0,0,b),C=Se}}const ye=C&&P;let Te=ye?n:f?"butt":a;if(ye&&Te==="round"&&(ne<h?Te="miter":ne<=2&&(Te="fakeround")),Te==="miter"&&ne>l&&(Te="bevel"),Te==="bevel"&&(ne>2&&(Te="flipbevel"),ne<l&&(Te="miter")),C&&this.updateDistance(C,T),Te==="miter")$._mult(ne),this.addCurrentVertex(T,$,0,0,b);else if(Te==="flipbevel"){if(ne>100)$=O.mult(-1);else{const xe=ne*D.add(O).mag()/D.sub(O).mag();$._perp()._mult(xe*(pe?-1:1))}this.addCurrentVertex(T,$,0,0,b),this.addCurrentVertex(T,$.mult(-1),0,0,b)}else if(Te==="bevel"||Te==="fakeround"){const xe=-Math.sqrt(ne*ne-1),Se=pe?xe:0,Be=pe?0:xe;if(C&&this.addCurrentVertex(T,D,Se,Be,b),Te==="fakeround"){const Ce=Math.round(180*re/Math.PI/20);for(let Oe=1;Oe<Ce;Oe++){let Me=Oe/Ce;if(Me!==.5){const et=Me-.5;Me+=Me*et*(Me-1)*((1.0904+X*(X*(3.55645-1.43519*X)-3.2452))*et*et+(.848013+X*(.215638*X-1.06021)))}const Re=O.sub(D)._mult(Me)._add(D)._unit()._mult(pe?-1:1);this.addHalfVertex(T,Re.x,Re.y,!1,pe,0,b)}}P&&this.addCurrentVertex(T,O,-Se,-Be,b)}else if(Te==="butt")this.addCurrentVertex(T,$,0,0,b);else if(Te==="square"){const xe=C?1:-1;C||this.addCurrentVertex(T,$,xe,xe,b),this.addCurrentVertex(T,$,0,0,b),C&&this.addCurrentVertex(T,$,xe,xe,b)}else Te==="round"&&(C&&(this.addCurrentVertex(T,D,0,0,b),this.addCurrentVertex(T,D,1,1,b,!0)),P&&(this.addCurrentVertex(T,O,-1,-1,b,!0),this.addCurrentVertex(T,O,0,0,b)));if(ce&&F<m-1){const xe=T.dist(P);if(xe>2*x){const Se=T.add(P.sub(T)._mult(x/xe)._round());this.updateDistance(T,Se),this.addCurrentVertex(Se,O,0,0,b),T=Se}}}}addCurrentVertex(e,r,n,a,l,h=!1){const f=r.y*a-r.x,m=-r.y-r.x*a;this.addHalfVertex(e,r.x+r.y*n,r.y-r.x*n,h,!1,n,l),this.addHalfVertex(e,f,m,h,!0,-a,l)}addHalfVertex({x:e,y:r},n,a,l,h,f,m){this.layoutVertexArray.emplaceBack((e<<1)+(l?1:0),(r<<1)+(h?1:0),Math.round(63*n)+128,Math.round(63*a)+128,1+(f===0?0:f<0?-1:1),0,this.lineSoFar),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineClips.start,this.lineClips.end);const _=m.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,_),m.primitiveLength++),h?this.e2=_:this.e1=_}updateScaledDistance(){if(this.lineClips){const e=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=e*this.lineClips.start+this.distance}else this.lineSoFar=this.distance}updateDistance(e,r){this.distance+=e.dist(r),this.updateScaledDistance()}}mt(Um,"LineBucket",{omit:["layers","patternFeatures"]});const Mw=new ti({"line-cap":new Lt(be.layout_line["line-cap"]),"line-join":new Lt(be.layout_line["line-join"]),"line-miter-limit":new Je(be.layout_line["line-miter-limit"]),"line-round-limit":new Je(be.layout_line["line-round-limit"]),"line-sort-key":new Lt(be.layout_line["line-sort-key"]),visibility:new Je(be.layout_line.visibility)});var Sy={paint:new ti({"line-opacity":new Lt(be.paint_line["line-opacity"]),"line-color":new Lt(be.paint_line["line-color"]),"line-translate":new Je(be.paint_line["line-translate"]),"line-translate-anchor":new Je(be.paint_line["line-translate-anchor"]),"line-width":new Lt(be.paint_line["line-width"]),"line-gap-width":new Lt(be.paint_line["line-gap-width"]),"line-offset":new Lt(be.paint_line["line-offset"]),"line-blur":new Lt(be.paint_line["line-blur"]),"line-dasharray":new Lt(be.paint_line["line-dasharray"]),"line-pattern":new Lt(be.paint_line["line-pattern"]),"line-gradient":new Es(be.paint_line["line-gradient"]),"line-trim-offset":new Je(be.paint_line["line-trim-offset"]),"line-emissive-strength":new Je(be.paint_line["line-emissive-strength"]),"line-border-width":new Lt(be.paint_line["line-border-width"]),"line-border-color":new Lt(be.paint_line["line-border-color"])}),layout:Mw};function Py(t,e,r){return e*(ct/(t.tileSize*Math.pow(2,r-t.tileID.overscaledZ)))}function Ly(t,e){return 1/Py(t,1,e.tileZoom)}function Dy(t,e,r,n){return t.translatePosMatrix(n||e.tileID.projMatrix,e,r.paint.get("line-translate"),r.paint.get("line-translate-anchor"))}const zy=t=>{const e=[];Ry(t)&&e.push("RENDER_LINE_DASH"),t.paint.get("line-gradient")&&e.push("RENDER_LINE_GRADIENT");const r=t.paint.get("line-trim-offset");return r[0]===0&&r[1]===0||e.push("RENDER_LINE_TRIM_OFFSET"),t.paint.get("line-border-width").constantOr(1)!==0&&e.push("RENDER_LINE_BORDER"),e};function Ry(t){const e=t.paint.get("line-dasharray").value;return e.value||e.kind!=="constant"}const Oy=new class extends Lt{possiblyEvaluate(t,e){return e=new ei(Math.floor(e.zoom),{now:e.now,fadeDuration:e.fadeDuration,transition:e.transition}),super.possiblyEvaluate(t,e)}evaluate(t,e,r,n){return e=gi({},e,{zoom:Math.floor(e.zoom)}),super.evaluate(t,e,r,n)}}(Sy.paint.properties["line-width"].specification);function ky(t,e){return e>0?e+2*t:t}Oy.useIntegerZoom=!0;const Iw=Dr([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),Cw=Dr([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),Aw=Dr([{name:"a_projected_pos",components:4,type:"Float32"}],4);Dr([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const Sw=Dr([{name:"a_z_offset",components:1,type:"Float32"}],4),Pw=Dr([{name:"a_texb",components:2,type:"Uint16"}]),Lw=Dr([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]),Dw=Dr([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_z_offset",components:1,type:"Float32"}]);Dr([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const By=Dr([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),zw=Dr([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);Dr([{name:"triangle",components:3,type:"Uint16"}]),Dr([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),Dr([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"}]),Dr([{type:"Float32",name:"offsetX"}]),Dr([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var $i=24;const Mo=128;function Vm(t,e){const{expression:r}=e;if(r.kind==="constant")return{kind:"constant",layoutSize:r.evaluate(new ei(t+1))};if(r.kind==="source")return{kind:"source"};{const{zoomStops:n,interpolationType:a}=r;let l=0;for(;l<n.length&&n[l]<=t;)l++;l=Math.max(0,l-1);let h=l;for(;h<n.length&&n[h]<t+1;)h++;h=Math.min(n.length-1,h);const f=n[l],m=n[h];return r.kind==="composite"?{kind:"composite",minZoom:f,maxZoom:m,interpolationType:a}:{kind:"camera",minZoom:f,maxZoom:m,minSize:r.evaluate(new ei(f)),maxSize:r.evaluate(new ei(m)),interpolationType:a}}}function Af(t,{uSize:e,uSizeT:r},{lowerSize:n,upperSize:a}){return t.kind==="source"?n/Mo:t.kind==="composite"?ur(n/Mo,a/Mo,r):e}function Tc(t,e){let r=0,n=0;if(t.kind==="constant")n=t.layoutSize;else if(t.kind!=="source"){const{interpolationType:a,minZoom:l,maxZoom:h}=t,f=a?Ut(xn.interpolationFactor(a,e,l,h),0,1):0;t.kind==="camera"?n=ur(t.minSize,t.maxSize,f):r=f}return{uSizeT:r,uSize:n}}var Rw=Object.freeze({__proto__:null,SIZE_PACK_FACTOR:Mo,evaluateSizeForFeature:Af,evaluateSizeForZoom:Tc,getSizeData:Vm});function Ow(t,e,r){return t.sections.forEach(n=>{n.text=function(a,l,h){const f=l.layout.get("text-transform").evaluate(h,{});return f==="uppercase"?a=a.toLocaleUpperCase():f==="lowercase"&&(a=a.toLocaleLowerCase()),vn.applyArabicShaping&&(a=vn.applyArabicShaping(a)),a}(n.text,e,r)}),t}const Sh={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};function kw(t){return t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""}function Bw(t){return t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""}var Fw={read:function(t,e,r,n,a){var l,h,f=8*a-n-1,m=(1<<f)-1,_=m>>1,x=-7,b=r?a-1:0,T=r?-1:1,C=t[e+b];for(b+=T,l=C&(1<<-x)-1,C>>=-x,x+=f;x>0;l=256*l+t[e+b],b+=T,x-=8);for(h=l&(1<<-x)-1,l>>=-x,x+=n;x>0;h=256*h+t[e+b],b+=T,x-=8);if(l===0)l=1-_;else{if(l===m)return h?NaN:1/0*(C?-1:1);h+=Math.pow(2,n),l-=_}return(C?-1:1)*h*Math.pow(2,l-n)},write:function(t,e,r,n,a,l){var h,f,m,_=8*l-a-1,x=(1<<_)-1,b=x>>1,T=a===23?Math.pow(2,-24)-Math.pow(2,-77):0,C=n?0:l-1,P=n?1:-1,D=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(f=isNaN(e)?1:0,h=x):(h=Math.floor(Math.log(e)/Math.LN2),e*(m=Math.pow(2,-h))<1&&(h--,m*=2),(e+=h+b>=1?T/m:T*Math.pow(2,1-b))*m>=2&&(h++,m/=2),h+b>=x?(f=0,h=x):h+b>=1?(f=(e*m-1)*Math.pow(2,a),h+=b):(f=e*Math.pow(2,b-1)*Math.pow(2,a),h=0));a>=8;t[r+C]=255&f,C+=P,f/=256,a-=8);for(h=h<<a|f,_+=a;_>0;t[r+C]=255&h,C+=P,h/=256,_-=8);t[r+C-P]|=128*D}},Fy=Jr,Sf=Fw;function Jr(t){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(t)?t:new Uint8Array(t||0),this.pos=0,this.type=0,this.length=this.buf.length}Jr.Varint=0,Jr.Fixed64=1,Jr.Bytes=2,Jr.Fixed32=5;var jm=4294967296,Ny=1/jm,Uy=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function Ds(t){return t.type===Jr.Bytes?t.readVarint()+t.pos:t.pos+1}function Ec(t,e,r){return r?4294967296*e+(t>>>0):4294967296*(e>>>0)+(t>>>0)}function Vy(t,e,r){var n=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));r.realloc(n);for(var a=r.pos-1;a>=t;a--)r.buf[a+n]=r.buf[a]}function Nw(t,e){for(var r=0;r<t.length;r++)e.writeVarint(t[r])}function Uw(t,e){for(var r=0;r<t.length;r++)e.writeSVarint(t[r])}function Vw(t,e){for(var r=0;r<t.length;r++)e.writeFloat(t[r])}function jw(t,e){for(var r=0;r<t.length;r++)e.writeDouble(t[r])}function Zw(t,e){for(var r=0;r<t.length;r++)e.writeBoolean(t[r])}function Gw(t,e){for(var r=0;r<t.length;r++)e.writeFixed32(t[r])}function $w(t,e){for(var r=0;r<t.length;r++)e.writeSFixed32(t[r])}function qw(t,e){for(var r=0;r<t.length;r++)e.writeFixed64(t[r])}function Ww(t,e){for(var r=0;r<t.length;r++)e.writeSFixed64(t[r])}function Pf(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+16777216*t[e+3]}function Mc(t,e,r){t[r]=e,t[r+1]=e>>>8,t[r+2]=e>>>16,t[r+3]=e>>>24}function jy(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+(t[e+3]<<24)}Jr.prototype={destroy:function(){this.buf=null},readFields:function(t,e,r){for(r=r||this.length;this.pos<r;){var n=this.readVarint(),a=n>>3,l=this.pos;this.type=7&n,t(a,e,this),this.pos===l&&this.skip(n)}return e},readMessage:function(t,e){return this.readFields(t,e,this.readVarint()+this.pos)},readFixed32:function(){var t=Pf(this.buf,this.pos);return this.pos+=4,t},readSFixed32:function(){var t=jy(this.buf,this.pos);return this.pos+=4,t},readFixed64:function(){var t=Pf(this.buf,this.pos)+Pf(this.buf,this.pos+4)*jm;return this.pos+=8,t},readSFixed64:function(){var t=Pf(this.buf,this.pos)+jy(this.buf,this.pos+4)*jm;return this.pos+=8,t},readFloat:function(){var t=Sf.read(this.buf,this.pos,!0,23,4);return this.pos+=4,t},readDouble:function(){var t=Sf.read(this.buf,this.pos,!0,52,8);return this.pos+=8,t},readVarint:function(t){var e,r,n=this.buf;return e=127&(r=n[this.pos++]),r<128?e:(e|=(127&(r=n[this.pos++]))<<7,r<128?e:(e|=(127&(r=n[this.pos++]))<<14,r<128?e:(e|=(127&(r=n[this.pos++]))<<21,r<128?e:function(a,l,h){var f,m,_=h.buf;if(f=(112&(m=_[h.pos++]))>>4,m<128||(f|=(127&(m=_[h.pos++]))<<3,m<128)||(f|=(127&(m=_[h.pos++]))<<10,m<128)||(f|=(127&(m=_[h.pos++]))<<17,m<128)||(f|=(127&(m=_[h.pos++]))<<24,m<128)||(f|=(1&(m=_[h.pos++]))<<31,m<128))return Ec(a,f,l);throw new Error("Expected varint not more than 10 bytes")}(e|=(15&(r=n[this.pos]))<<28,t,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var t=this.readVarint();return t%2==1?(t+1)/-2:t/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var t=this.readVarint()+this.pos,e=this.pos;return this.pos=t,t-e>=12&&Uy?function(r,n,a){return Uy.decode(r.subarray(n,a))}(this.buf,e,t):function(r,n,a){for(var l="",h=n;h<a;){var f,m,_,x=r[h],b=null,T=x>239?4:x>223?3:x>191?2:1;if(h+T>a)break;T===1?x<128&&(b=x):T===2?(192&(f=r[h+1]))==128&&(b=(31&x)<<6|63&f)<=127&&(b=null):T===3?(m=r[h+2],(192&(f=r[h+1]))==128&&(192&m)==128&&((b=(15&x)<<12|(63&f)<<6|63&m)<=2047||b>=55296&&b<=57343)&&(b=null)):T===4&&(m=r[h+2],_=r[h+3],(192&(f=r[h+1]))==128&&(192&m)==128&&(192&_)==128&&((b=(15&x)<<18|(63&f)<<12|(63&m)<<6|63&_)<=65535||b>=1114112)&&(b=null)),b===null?(b=65533,T=1):b>65535&&(b-=65536,l+=String.fromCharCode(b>>>10&1023|55296),b=56320|1023&b),l+=String.fromCharCode(b),h+=T}return l}(this.buf,e,t)},readBytes:function(){var t=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,t);return this.pos=t,e},readPackedVarint:function(t,e){if(this.type!==Jr.Bytes)return t.push(this.readVarint(e));var r=Ds(this);for(t=t||[];this.pos<r;)t.push(this.readVarint(e));return t},readPackedSVarint:function(t){if(this.type!==Jr.Bytes)return t.push(this.readSVarint());var e=Ds(this);for(t=t||[];this.pos<e;)t.push(this.readSVarint());return t},readPackedBoolean:function(t){if(this.type!==Jr.Bytes)return t.push(this.readBoolean());var e=Ds(this);for(t=t||[];this.pos<e;)t.push(this.readBoolean());return t},readPackedFloat:function(t){if(this.type!==Jr.Bytes)return t.push(this.readFloat());var e=Ds(this);for(t=t||[];this.pos<e;)t.push(this.readFloat());return t},readPackedDouble:function(t){if(this.type!==Jr.Bytes)return t.push(this.readDouble());var e=Ds(this);for(t=t||[];this.pos<e;)t.push(this.readDouble());return t},readPackedFixed32:function(t){if(this.type!==Jr.Bytes)return t.push(this.readFixed32());var e=Ds(this);for(t=t||[];this.pos<e;)t.push(this.readFixed32());return t},readPackedSFixed32:function(t){if(this.type!==Jr.Bytes)return t.push(this.readSFixed32());var e=Ds(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed32());return t},readPackedFixed64:function(t){if(this.type!==Jr.Bytes)return t.push(this.readFixed64());var e=Ds(this);for(t=t||[];this.pos<e;)t.push(this.readFixed64());return t},readPackedSFixed64:function(t){if(this.type!==Jr.Bytes)return t.push(this.readSFixed64());var e=Ds(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed64());return t},skip:function(t){var e=7&t;if(e===Jr.Varint)for(;this.buf[this.pos++]>127;);else if(e===Jr.Bytes)this.pos=this.readVarint()+this.pos;else if(e===Jr.Fixed32)this.pos+=4;else{if(e!==Jr.Fixed64)throw new Error("Unimplemented type: "+e);this.pos+=8}},writeTag:function(t,e){this.writeVarint(t<<3|e)},realloc:function(t){for(var e=this.length||16;e<this.pos+t;)e*=2;if(e!==this.length){var r=new Uint8Array(e);r.set(this.buf),this.buf=r,this.length=e}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(t){this.realloc(4),Mc(this.buf,t,this.pos),this.pos+=4},writeSFixed32:function(t){this.realloc(4),Mc(this.buf,t,this.pos),this.pos+=4},writeFixed64:function(t){this.realloc(8),Mc(this.buf,-1&t,this.pos),Mc(this.buf,Math.floor(t*Ny),this.pos+4),this.pos+=8},writeSFixed64:function(t){this.realloc(8),Mc(this.buf,-1&t,this.pos),Mc(this.buf,Math.floor(t*Ny),this.pos+4),this.pos+=8},writeVarint:function(t){(t=+t||0)>268435455||t<0?function(e,r){var n,a;if(e>=0?(n=e%4294967296|0,a=e/4294967296|0):(a=~(-e/4294967296),4294967295^(n=~(-e%4294967296))?n=n+1|0:(n=0,a=a+1|0)),e>=18446744073709552e3||e<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");r.realloc(10),function(l,h,f){f.buf[f.pos++]=127&l|128,l>>>=7,f.buf[f.pos++]=127&l|128,l>>>=7,f.buf[f.pos++]=127&l|128,l>>>=7,f.buf[f.pos++]=127&l|128,f.buf[f.pos]=127&(l>>>=7)}(n,0,r),function(l,h){var f=(7&l)<<4;h.buf[h.pos++]|=f|((l>>>=3)?128:0),l&&(h.buf[h.pos++]=127&l|((l>>>=7)?128:0),l&&(h.buf[h.pos++]=127&l|((l>>>=7)?128:0),l&&(h.buf[h.pos++]=127&l|((l>>>=7)?128:0),l&&(h.buf[h.pos++]=127&l|((l>>>=7)?128:0),l&&(h.buf[h.pos++]=127&l)))))}(a,r)}(t,this):(this.realloc(4),this.buf[this.pos++]=127&t|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=t>>>7&127))))},writeSVarint:function(t){this.writeVarint(t<0?2*-t-1:2*t)},writeBoolean:function(t){this.writeVarint(!!t)},writeString:function(t){t=String(t),this.realloc(4*t.length),this.pos++;var e=this.pos;this.pos=function(n,a,l){for(var h,f,m=0;m<a.length;m++){if((h=a.charCodeAt(m))>55295&&h<57344){if(!f){h>56319||m+1===a.length?(n[l++]=239,n[l++]=191,n[l++]=189):f=h;continue}if(h<56320){n[l++]=239,n[l++]=191,n[l++]=189,f=h;continue}h=f-55296<<10|h-56320|65536,f=null}else f&&(n[l++]=239,n[l++]=191,n[l++]=189,f=null);h<128?n[l++]=h:(h<2048?n[l++]=h>>6|192:(h<65536?n[l++]=h>>12|224:(n[l++]=h>>18|240,n[l++]=h>>12&63|128),n[l++]=h>>6&63|128),n[l++]=63&h|128)}return l}(this.buf,t,this.pos);var r=this.pos-e;r>=128&&Vy(e,r,this),this.pos=e-1,this.writeVarint(r),this.pos+=r},writeFloat:function(t){this.realloc(4),Sf.write(this.buf,t,this.pos,!0,23,4),this.pos+=4},writeDouble:function(t){this.realloc(8),Sf.write(this.buf,t,this.pos,!0,52,8),this.pos+=8},writeBytes:function(t){var e=t.length;this.writeVarint(e),this.realloc(e);for(var r=0;r<e;r++)this.buf[this.pos++]=t[r]},writeRawMessage:function(t,e){this.pos++;var r=this.pos;t(e,this);var n=this.pos-r;n>=128&&Vy(r,n,this),this.pos=r-1,this.writeVarint(n),this.pos+=n},writeMessage:function(t,e,r){this.writeTag(t,Jr.Bytes),this.writeRawMessage(e,r)},writePackedVarint:function(t,e){e.length&&this.writeMessage(t,Nw,e)},writePackedSVarint:function(t,e){e.length&&this.writeMessage(t,Uw,e)},writePackedBoolean:function(t,e){e.length&&this.writeMessage(t,Zw,e)},writePackedFloat:function(t,e){e.length&&this.writeMessage(t,Vw,e)},writePackedDouble:function(t,e){e.length&&this.writeMessage(t,jw,e)},writePackedFixed32:function(t,e){e.length&&this.writeMessage(t,Gw,e)},writePackedSFixed32:function(t,e){e.length&&this.writeMessage(t,$w,e)},writePackedFixed64:function(t,e){e.length&&this.writeMessage(t,qw,e)},writePackedSFixed64:function(t,e){e.length&&this.writeMessage(t,Ww,e)},writeBytesField:function(t,e){this.writeTag(t,Jr.Bytes),this.writeBytes(e)},writeFixed32Field:function(t,e){this.writeTag(t,Jr.Fixed32),this.writeFixed32(e)},writeSFixed32Field:function(t,e){this.writeTag(t,Jr.Fixed32),this.writeSFixed32(e)},writeFixed64Field:function(t,e){this.writeTag(t,Jr.Fixed64),this.writeFixed64(e)},writeSFixed64Field:function(t,e){this.writeTag(t,Jr.Fixed64),this.writeSFixed64(e)},writeVarintField:function(t,e){this.writeTag(t,Jr.Varint),this.writeVarint(e)},writeSVarintField:function(t,e){this.writeTag(t,Jr.Varint),this.writeSVarint(e)},writeStringField:function(t,e){this.writeTag(t,Jr.Bytes),this.writeString(e)},writeFloatField:function(t,e){this.writeTag(t,Jr.Fixed32),this.writeFloat(e)},writeDoubleField:function(t,e){this.writeTag(t,Jr.Fixed64),this.writeDouble(e)},writeBooleanField:function(t,e){this.writeVarintField(t,!!e)}};var Ic=ft(Fy);const Zm=3;function Hw(t,e,r){e.glyphs=[],t===1&&r.readMessage(Xw,e)}function Xw(t,e,r){if(t===3){const{id:n,bitmap:a,width:l,height:h,left:f,top:m,advance:_}=r.readMessage(Yw,{});e.glyphs.push({id:n,bitmap:new pa({width:l+2*Zm,height:h+2*Zm},a),metrics:{width:l,height:h,left:f,top:m,advance:_}})}else t===4?e.ascender=r.readSVarint():t===5&&(e.descender=r.readSVarint())}function Yw(t,e,r){t===1?e.id=r.readVarint():t===2?e.bitmap=r.readBytes():t===3?e.width=r.readVarint():t===4?e.height=r.readVarint():t===5?e.left=r.readSVarint():t===6?e.top=r.readSVarint():t===7&&(e.advance=r.readVarint())}const Zy=Zm,Yn={horizontal:1,vertical:2,horizontalOnly:3};class Ph{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(e,r){const n=new Ph;return n.scale=e||1,n.fontStack=r,n}static forImage(e){const r=new Ph;return r.imageName=e,r}}class Cc{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,r){const n=new Cc;for(let a=0;a<e.sections.length;a++){const l=e.sections[a];l.image?n.addImageSection(l):n.addTextSection(l,r)}return n}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCodePoint(e){return this.text.codePointAt(e)}verticalizePunctuation(e){this.text=function(r,n){let a="";for(let l=0;l<r.length;l++){const h=r.charCodeAt(l+1)||null,f=r.charCodeAt(l-1)||null;a+=!n&&(h&&kd(h)&&!Sh[r[l+1]]||f&&kd(f)&&!Sh[r[l-1]])||!Sh[r[l]]?r[l]:Sh[r[l]]}return a}(this.text,e)}trim(){let e=0;for(let n=0;n<this.text.length&&Lf[this.text.charCodeAt(n)];n++)e++;let r=this.text.length;for(let n=this.text.length-1;n>=0&&n>=e&&Lf[this.text.charCodeAt(n)];n--)r--;this.text=this.text.substring(e,r),this.sectionIndex=this.sectionIndex.slice(e,r)}substring(e,r){const n=new Cc;return n.text=this.text.substring(e,r),n.sectionIndex=this.sectionIndex.slice(e,r),n.sections=this.sections,n}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,r)=>Math.max(e,this.sections[r].scale),0)}addTextSection(e,r){this.text+=e.text,this.sections.push(Ph.forText(e.scale,e.fontStack||r));const n=this.sections.length-1;for(let a=0;a<e.text.length;++a)this.sectionIndex.push(n)}addImageSection(e){const r=e.image?e.image.namePrimary:"";if(r.length===0)return void li("Can't add FormattedSection with an empty image.");const n=this.getNextImageSectionCharCode();n?(this.text+=String.fromCodePoint(n),this.sections.push(Ph.forImage(r)),this.sectionIndex.push(this.sections.length-1)):li("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Gm(t,e,r,n,a,l,h,f,m,_,x,b,T,C,P){const D=Cc.fromFeature(t,a);b===Yn.vertical&&D.verticalizePunctuation(T);let O=[];const F=function(re,ce,pe,ye,Te,xe){if(!re)return[];const Se=[],Be=function(Re,et,Ne,gt,ht,je){let kt=0;for(let Mt=0;Mt<Re.length();Mt++){const _t=Re.getSection(Mt);kt+=Gy(Re.getCodePoint(Mt),_t,gt,ht,et,je)}return kt/Math.max(1,Math.ceil(kt/Ne))}(re,ce,pe,ye,Te,xe),Ce=re.text.indexOf("")>=0;let Oe=0;for(let Re=0;Re<re.length();Re++){const et=re.getSection(Re),Ne=re.getCodePoint(Re);if(Lf[Ne]||(Oe+=Gy(Ne,et,ye,Te,ce,xe)),Re<re.length()-1){const gt=!((Me=Ne)<11904||!(bt["Bopomofo Extended"](Me)||bt.Bopomofo(Me)||bt["CJK Compatibility Forms"](Me)||bt["CJK Compatibility Ideographs"](Me)||bt["CJK Compatibility"](Me)||bt["CJK Radicals Supplement"](Me)||bt["CJK Strokes"](Me)||bt["CJK Symbols and Punctuation"](Me)||bt["CJK Unified Ideographs Extension A"](Me)||bt["CJK Unified Ideographs"](Me)||bt["Enclosed CJK Letters and Months"](Me)||bt["Halfwidth and Fullwidth Forms"](Me)||bt.Hiragana(Me)||bt["Ideographic Description Characters"](Me)||bt["Kangxi Radicals"](Me)||bt["Katakana Phonetic Extensions"](Me)||bt.Katakana(Me)||bt["Vertical Forms"](Me)||bt["Yi Radicals"](Me)||bt["Yi Syllables"](Me)));(Kw[Ne]||gt||et.imageName)&&Se.push(qy(Re+1,Oe,Be,Se,Jw(Ne,re.getCodePoint(Re+1),gt&&Ce),!1))}}var Me;return Wy(qy(re.length(),Oe,Be,Se,0,!0))}(D,_,l,e,n,C),{processBidirectionalText:$,processStyledBidirectionalText:X}=vn;if($&&D.sections.length===1){const re=$(D.toString(),F);for(const ce of re){const pe=new Cc;pe.text=ce,pe.sections=D.sections;for(let ye=0;ye<ce.length;ye++)pe.sectionIndex.push(0);O.push(pe)}}else if(X){const re=X(D.text,D.sectionIndex,F);for(const ce of re){const pe=new Cc;pe.text=ce[0],pe.sectionIndex=ce[1],pe.sections=D.sections,O.push(pe)}}else O=function(re,ce){const pe=[],ye=re.text;let Te=0;for(const xe of ce)pe.push(re.substring(Te,xe)),Te=xe;return Te<ye.length&&pe.push(re.substring(Te,ye.length)),pe}(D,F);const H=[],ne={positionedLines:H,text:D.toString(),top:x[1],bottom:x[1],left:x[0],right:x[0],writingMode:b,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(re,ce,pe,ye,Te,xe,Se,Be,Ce,Oe,Me,Re){let et=0,Ne=0,gt=0;const ht=Be==="right"?1:Be==="left"?0:.5;let je=!1;for(const Qt of Te){const Bt=Qt.getSections();for(const er of Bt){if(er.imageName)continue;const Zt=ce[er.fontStack];if(Zt&&(je=Zt.ascender!==void 0&&Zt.descender!==void 0,!je))break}if(!je)break}let kt=0;for(const Qt of Te){Qt.trim();const Bt=Qt.getMaxScale(),er=(Bt-1)*$i,Zt={positionedGlyphs:[],lineOffset:0};re.positionedLines[kt]=Zt;const hr=Zt.positionedGlyphs;let Wt=0;if(!Qt.length()){Ne+=xe,++kt;continue}let Ur=0,xr=0;for(let Ar=0;Ar<Qt.length();Ar++){const vr=Qt.getSection(Ar),Qr=Qt.getSectionIndex(Ar),Rr=Qt.getCodePoint(Ar);let ui=vr.scale,Ii=null,Gi=null,Yr=null,ni=$i,Oi=0;const ki=!(Ce===Yn.horizontal||!Me&&!Gu(Rr)||Me&&(Lf[Rr]||(Mt=Rr,bt.Arabic(Mt)||bt["Arabic Supplement"](Mt)||bt["Arabic Extended-A"](Mt)||bt["Arabic Presentation Forms-A"](Mt)||bt["Arabic Presentation Forms-B"](Mt))));if(vr.imageName){const Bi=ye[vr.imageName];if(!Bi)continue;Yr=vr.imageName,re.iconsInText=re.iconsInText||!0,Gi=Bi.paddedRect;const $r=Bi.displaySize;ui=ui*$i/Re,Ii={width:$r[0],height:$r[1],left:0,top:-Zy,advance:ki?$r[1]:$r[0],localGlyph:!1},Oi=je?-Ii.height*ui:Bt*$i-17-$r[1]*ui,ni=Ii.advance;const Dn=(ki?$r[0]:$r[1])*ui-$i*Bt;Dn>0&&Dn>Wt&&(Wt=Dn)}else{const Bi=pe[vr.fontStack];if(!Bi)continue;Bi[Rr]&&(Gi=Bi[Rr]);const $r=ce[vr.fontStack];if(!$r)continue;const Dn=$r.glyphs[Rr];if(!Dn)continue;if(Ii=Dn.metrics,ni=Rr!==8203?$i:0,je){const Ta=$r.ascender!==void 0?Math.abs($r.ascender):0,dn=$r.descender!==void 0?Math.abs($r.descender):0,rn=(Ta+dn)*ui;Ur<rn&&(Ur=rn,xr=(Ta-dn)/2*ui),Oi=-Ta*ui}else Oi=(Bt-ui)*$i-17}ki?(re.verticalizable=!0,hr.push({glyph:Rr,imageName:Yr,x:et,y:Ne+Oi,vertical:ki,scale:ui,localGlyph:Ii.localGlyph,fontStack:vr.fontStack,sectionIndex:Qr,metrics:Ii,rect:Gi}),et+=ni*ui+Oe):(hr.push({glyph:Rr,imageName:Yr,x:et,y:Ne+Oi,vertical:ki,scale:ui,localGlyph:Ii.localGlyph,fontStack:vr.fontStack,sectionIndex:Qr,metrics:Ii,rect:Gi}),et+=Ii.advance*ui+Oe)}hr.length!==0&&(gt=Math.max(et-Oe,gt),je?Hy(hr,ht,Wt,xr,xe*Bt/2):Hy(hr,ht,Wt,0,xe/2)),et=0;const br=xe*Bt+Wt;Zt.lineOffset=Math.max(Wt,er),Ne+=br,++kt}var Mt;const _t=Ne,{horizontalAlign:Ze,verticalAlign:Dt}=$m(Se);(function(Qt,Bt,er,Zt,hr,Wt){const Ur=(Bt-er)*hr,xr=-Wt*Zt;for(const br of Qt)for(const Ar of br.positionedGlyphs)Ar.x+=Ur,Ar.y+=xr})(re.positionedLines,ht,Ze,Dt,gt,_t),re.top+=-Dt*_t,re.bottom=re.top+_t,re.left+=-Ze*gt,re.right=re.left+gt,re.hasBaseline=je}(ne,e,r,n,O,h,f,m,b,_,T,P),!function(re){for(const ce of re)if(ce.positionedGlyphs.length!==0)return!1;return!0}(H)&&ne}const Lf={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},Kw={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function Gy(t,e,r,n,a,l){if(e.imageName){const h=n[e.imageName];return h?h.displaySize[0]*e.scale*$i/l+a:0}{const h=r[e.fontStack],f=h&&h.glyphs[t];return f?f.metrics.advance*e.scale+a:0}}function $y(t,e,r,n){const a=Math.pow(t-e,2);return n?t<e?a/2:2*a:a+Math.abs(r)*r}function Jw(t,e,r){let n=0;return t===10&&(n-=1e4),r&&(n+=150),t!==40&&t!==65288||(n+=50),e!==41&&e!==65289||(n+=50),n}function qy(t,e,r,n,a,l){let h=null,f=$y(e,r,a,l);for(const m of n){const _=$y(e-m.x,r,a,l)+m.badness;_<=f&&(h=m,f=_)}return{index:t,x:e,priorBreak:h,badness:f}}function Wy(t){return t?Wy(t.priorBreak).concat(t.index):[]}function $m(t){let e=.5,r=.5;switch(t){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(t){case"bottom":case"bottom-right":case"bottom-left":r=1;break;case"top":case"top-right":case"top-left":r=0}return{horizontalAlign:e,verticalAlign:r}}function Hy(t,e,r,n,a){if(!(e||r||n||a))return;const l=t.length-1,h=t[l],f=(h.x+h.metrics.advance*h.scale)*e;for(let m=0;m<=l;m++)t[m].x-=f,t[m].y+=r+n+a}function Qw(t,e,r,n){const{horizontalAlign:a,verticalAlign:l}=$m(n),h=r[0]-t.displaySize[0]*a,f=r[1]-t.displaySize[1]*l;return{imagePrimary:t,imageSecondary:e,top:f,bottom:f+t.displaySize[1],left:h,right:h+t.displaySize[0]}}function Xy(t,e,r,n,a,l){const h=t.imagePrimary;let f;if(h.content){const O=h.content,F=h.pixelRatio||1;f=[O[0]/F,O[1]/F,h.displaySize[0]-O[2]/F,h.displaySize[1]-O[3]/F]}const m=e.left*l,_=e.right*l;let x,b,T,C;r==="width"||r==="both"?(C=a[0]+m-n[3],b=a[0]+_+n[1]):(C=a[0]+(m+_-h.displaySize[0])/2,b=C+h.displaySize[0]);const P=e.top*l,D=e.bottom*l;return r==="height"||r==="both"?(x=a[1]+P-n[0],T=a[1]+D+n[2]):(x=a[1]+(P+D-h.displaySize[1])/2,T=x+h.displaySize[1]),{imagePrimary:h,imageSecondary:void 0,top:x,right:b,bottom:T,left:C,collisionPadding:f}}class zs extends Ge{constructor(e,r,n,a,l){super(e,r),this.angle=a,this.z=n,l!==void 0&&(this.segment=l)}clone(){return new zs(this.x,this.y,this.z,this.angle,this.segment)}}function Yy(t,e,r,n,a){if(e.segment===void 0)return!0;let l=e,h=e.segment+1,f=0;for(;f>-r/2;){if(h--,h<0)return!1;f-=t[h].dist(l),l=t[h]}f+=t[h].dist(t[h+1]),h++;const m=[];let _=0;for(;f<r/2;){const x=t[h],b=t[h+1];if(!b)return!1;let T=t[h-1].angleTo(x)-x.angleTo(b);for(T=Math.abs((T+3*Math.PI)%(2*Math.PI)-Math.PI),m.push({distance:f,angleDelta:T}),_+=T;f-m[0].distance>n;)_-=m.shift().angleDelta;if(_>a)return!1;h++,f+=x.dist(b)}return!0}function Ky(t){let e=0;for(let r=0;r<t.length-1;r++)e+=t[r].dist(t[r+1]);return e}function Jy(t,e,r){return t?.6*e*r:0}function Qy(t,e){return Math.max(t?t.right-t.left:0,e?e.right-e.left:0)}function eT(t,e,r,n,a,l){const h=Jy(r,a,l),f=Qy(r,n)*l;let m=0;const _=Ky(t)/2;for(let x=0;x<t.length-1;x++){const b=t[x],T=t[x+1],C=b.dist(T);if(m+C>_){const P=(_-m)/C,D=ur(b.x,T.x,P),O=ur(b.y,T.y,P),F=new zs(D,O,0,T.angleTo(b),x);return!h||Yy(t,F,f,h,e)?F:void 0}m+=C}}function tT(t,e,r,n,a,l,h,f,m){const _=Jy(n,l,h),x=Qy(n,a),b=x*h,T=t[0].x===0||t[0].x===m||t[0].y===0||t[0].y===m;return e-b<e/4&&(e=b+e/4),e1(t,T?e/2*f%e:(x/2+2*l)*h*f%e,e,_,r,b,T,!1,m)}function e1(t,e,r,n,a,l,h,f,m){const _=l/2,x=Ky(t);let b=0,T=e-r,C=[];for(let P=0;P<t.length-1;P++){const D=t[P],O=t[P+1],F=D.dist(O),$=O.angleTo(D);for(;T+r<b+F;){T+=r;const X=(T-b)/F,H=ur(D.x,O.x,X),ne=ur(D.y,O.y,X);if(H>=0&&H<m&&ne>=0&&ne<m&&T-_>=0&&T+_<=x){const re=new zs(H,ne,0,$,P);n&&!Yy(t,re,l,n,a)||C.push(re)}}b+=F}return f||C.length||h||(C=e1(t,b/2,r,n,a,l,h,!0,m)),C}function t1(t,e,r,n,a){const l=[];for(let h=0;h<t.length;h++){const f=t[h];let m;for(let _=0;_<f.length-1;_++){let x=f[_],b=f[_+1];x.x<e&&b.x<e||(x.x<e?x=new Ge(e,x.y+(e-x.x)/(b.x-x.x)*(b.y-x.y))._round():b.x<e&&(b=new Ge(e,x.y+(e-x.x)/(b.x-x.x)*(b.y-x.y))._round()),x.y<r&&b.y<r||(x.y<r?x=new Ge(x.x+(r-x.y)/(b.y-x.y)*(b.x-x.x),r)._round():b.y<r&&(b=new Ge(x.x+(r-x.y)/(b.y-x.y)*(b.x-x.x),r)._round()),x.x>=n&&b.x>=n||(x.x>=n?x=new Ge(n,x.y+(n-x.x)/(b.x-x.x)*(b.y-x.y))._round():b.x>=n&&(b=new Ge(n,x.y+(n-x.x)/(b.x-x.x)*(b.y-x.y))._round()),x.y>=a&&b.y>=a||(x.y>=a?x=new Ge(x.x+(a-x.y)/(b.y-x.y)*(b.x-x.x),a)._round():b.y>=a&&(b=new Ge(x.x+(a-x.y)/(b.y-x.y)*(b.x-x.x),a)._round()),m&&x.equals(m[m.length-1])||(m=[x],l.push(m)),m.push(b)))))}}return l}function r1(t){let e=0,r=0;for(const h of t)e+=h.w*h.h,r=Math.max(r,h.w);t.sort((h,f)=>f.h-h.h);const n=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),r),h:1/0}];let a=0,l=0;for(const h of t)for(let f=n.length-1;f>=0;f--){const m=n[f];if(!(h.w>m.w||h.h>m.h)){if(h.x=m.x,h.y=m.y,l=Math.max(l,h.y+h.h),a=Math.max(a,h.x+h.w),h.w===m.w&&h.h===m.h){const _=n.pop();f<n.length&&(n[f]=_)}else h.h===m.h?(m.x+=h.w,m.w-=h.w):h.w===m.w?(m.y+=h.h,m.h-=h.h):(n.push({x:m.x+h.w,y:m.y,w:m.w-h.w,h:h.h}),m.y+=h.h,m.h-=h.h);break}}return{w:a,h:l,fill:e/(a*l)||0}}mt(zs,"Anchor");const Ln=1;class qm{constructor(e,{pixelRatio:r,version:n,stretchX:a,stretchY:l,content:h}){this.paddedRect=e,this.pixelRatio=r,this.stretchX=a,this.stretchY=l,this.content=h,this.version=n}get tl(){return[this.paddedRect.x+Ln,this.paddedRect.y+Ln]}get br(){return[this.paddedRect.x+this.paddedRect.w-Ln,this.paddedRect.y+this.paddedRect.h-Ln]}get displaySize(){return[(this.paddedRect.w-2*Ln)/this.pixelRatio,(this.paddedRect.h-2*Ln)/this.pixelRatio]}}class i1{constructor(e,r){const n={},a={};this.haveRenderCallbacks=[];const l=[];this.addImages(e,n,l),this.addImages(r,a,l);const{w:h,h:f}=r1(l),m=new Xn({width:h||1,height:f||1});for(const _ in e){const x=e[_],b=n[_].paddedRect;Xn.copy(x.data,m,{x:0,y:0},{x:b.x+Ln,y:b.y+Ln},x.data,x.sdf)}for(const _ in r){const x=r[_],b=a[_].paddedRect,T=b.x+Ln,C=b.y+Ln,P=x.data.width,D=x.data.height;Xn.copy(x.data,m,{x:0,y:0},{x:T,y:C},x.data),Xn.copy(x.data,m,{x:0,y:D-1},{x:T,y:C-1},{width:P,height:1}),Xn.copy(x.data,m,{x:0,y:0},{x:T,y:C+D},{width:P,height:1}),Xn.copy(x.data,m,{x:P-1,y:0},{x:T-1,y:C},{width:1,height:D}),Xn.copy(x.data,m,{x:0,y:0},{x:T+P,y:C},{width:1,height:D})}this.image=m,this.iconPositions=n,this.patternPositions=a}addImages(e,r,n){for(const a in e){const l=e[a],h={x:0,y:0,w:l.data.width+2*Ln,h:l.data.height+2*Ln};n.push(h),r[a]=new qm(h,l),l.hasRenderCallback&&this.haveRenderCallbacks.push(a)}}patchUpdatedImages(e,r,n){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(a=>e.hasImage(a,n)),e.dispatchRenderCallbacks(this.haveRenderCallbacks,n);for(const a in e.getUpdatedImages(n))this.patchUpdatedImage(this.iconPositions[a],e.getImage(a,n),r),this.patchUpdatedImage(this.patternPositions[a],e.getImage(a,n),r)}patchUpdatedImage(e,r,n){if(!e||!r||e.version===r.version)return;e.version=r.version;const[a,l]=e.tl,h=!!Object.keys(this.patternPositions).length;n.update(r.data,{useMipmap:h},{x:a,y:l})}}mt(qm,"ImagePosition"),mt(i1,"ImageAtlas");const Lh=1e20;function n1(t,e,r,n,a,l,h,f,m){for(let _=e;_<e+n;_++)o1(t,r*l+_,l,a,h,f,m);for(let _=r;_<r+a;_++)o1(t,_*l+e,1,n,h,f,m)}function o1(t,e,r,n,a,l,h){l[0]=0,h[0]=-Lh,h[1]=Lh,a[0]=t[e];for(let f=1,m=0,_=0;f<n;f++){a[f]=t[e+f*r];const x=f*f;do{const b=l[m];_=(a[f]-a[b]+x-b*b)/(f-b)/2}while(_<=h[m]&&--m>-1);m++,l[m]=f,h[m]=_,h[m+1]=Lh}for(let f=0,m=0;f<n;f++){for(;h[m+1]<f;)m++;const _=l[m],x=f-_;t[e+f*r]=a[_]+x*x}}const Io=2,Wm={none:0,ideographs:1,all:2};class Ac{constructor(e,r,n){this.requestManager=e,this.localGlyphMode=r,this.localFontFamily=n,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e,r){this.urls[r]=e}getGlyphs(e,r,n){const a=[],l=this.urls[r]||se.GLYPHS_URL;for(const h in e)for(const f of e[h])a.push({stack:h,id:f});qi(a,({stack:h,id:f},m)=>{let _=this.entries[h];_||(_=this.entries[h]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let x=_.glyphs[f];if(x!==void 0)return void m(null,{stack:h,id:f,glyph:x});if(x=this._tinySDF(_,h,f),x)return _.glyphs[f]=x,void m(null,{stack:h,id:f,glyph:x});const b=Math.floor(f/256);if(256*b>65535)return void m(new Error("glyphs > 65535 not supported"));if(_.ranges[b])return void m(null,{stack:h,id:f,glyph:x});let T=_.requests[b];T||(T=_.requests[b]=[],Ac.loadGlyphRange(h,b,l,this.requestManager,(C,P)=>{if(P){_.ascender=P.ascender,_.descender=P.descender;for(const D in P.glyphs)this._doesCharSupportLocalGlyph(+D)||(_.glyphs[+D]=P.glyphs[+D]);_.ranges[b]=!0}for(const D of T)D(C,P);delete _.requests[b]})),T.push((C,P)=>{C?m(C):P&&m(null,{stack:h,id:f,glyph:P.glyphs[f]||null})})},(h,f)=>{if(h)n(h);else if(f){const m={};for(const{stack:_,id:x,glyph:b}of f)m[_]===void 0&&(m[_]={}),m[_].glyphs===void 0&&(m[_].glyphs={}),m[_].glyphs[x]=b&&{id:b.id,bitmap:b.bitmap.clone(),metrics:b.metrics},m[_].ascender=this.entries[_].ascender,m[_].descender=this.entries[_].descender;n(null,m)}})}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==Wm.none&&(this.localGlyphMode===Wm.all?!!this.localFontFamily:!!this.localFontFamily&&(bt["CJK Unified Ideographs"](e)||bt["Hangul Syllables"](e)||bt.Hiragana(e)||bt.Katakana(e)||bt["CJK Symbols and Punctuation"](e)||bt["CJK Unified Ideographs Extension A"](e)||bt["CJK Unified Ideographs Extension B"](e)))}_tinySDF(e,r,n){const a=this.localFontFamily;if(!a||!this._doesCharSupportLocalGlyph(n))return;let l=e.tinySDF;if(!l){let D="400";/bold/i.test(r)?D="900":/medium/i.test(r)?D="500":/light/i.test(r)&&(D="200"),l=e.tinySDF=new Ac.TinySDF({fontFamily:a,fontWeight:D,fontSize:24*Io,buffer:3*Io,radius:8*Io}),l.fontWeight=D}if(this.localGlyphs[l.fontWeight][n])return this.localGlyphs[l.fontWeight][n];const h=String.fromCodePoint(n),{data:f,width:m,height:_,glyphWidth:x,glyphHeight:b,glyphLeft:T,glyphTop:C,glyphAdvance:P}=l.draw(h);return this.localGlyphs[l.fontWeight][n]={id:n,bitmap:new pa({width:m,height:_},f),metrics:{width:x/Io,height:b/Io,left:T/Io,top:C/Io-27,advance:P/Io,localGlyph:!0}}}}Ac.loadGlyphRange=function(t,e,r,n,a){const l=256*e,h=l+255,f=n.transformRequest(n.normalizeGlyphsURL(r).replace("{fontstack}",t).replace("{range}",`${l}-${h}`),nn.Glyphs);ze(f,(m,_)=>{if(m)a(m);else if(_){const x={},b=function(T){return new Ic(T).readFields(Hw,{})}(_);for(const T of b.glyphs)x[T.id]=T;a(null,{glyphs:x,ascender:b.ascender,descender:b.descender})}})},Ac.TinySDF=class{constructor({fontSize:t=24,buffer:e=3,radius:r=8,cutoff:n=.25,fontFamily:a="sans-serif",fontWeight:l="normal",fontStyle:h="normal"}={}){this.buffer=e,this.cutoff=n,this.radius=r;const f=this.size=t+4*e,m=this._createCanvas(f),_=this.ctx=m.getContext("2d",{willReadFrequently:!0});_.font=`${h} ${l} ${t}px ${a}`,_.textBaseline="alphabetic",_.textAlign="left",_.fillStyle="black",this.gridOuter=new Float64Array(f*f),this.gridInner=new Float64Array(f*f),this.f=new Float64Array(f),this.z=new Float64Array(f+1),this.v=new Uint16Array(f)}_createCanvas(t){const e=document.createElement("canvas");return e.width=e.height=t,e}draw(t){const{width:e,actualBoundingBoxAscent:r,actualBoundingBoxDescent:n,actualBoundingBoxLeft:a,actualBoundingBoxRight:l}=this.ctx.measureText(t),h=Math.ceil(r),f=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(l-a))),m=Math.min(this.size-this.buffer,h+Math.ceil(n)),_=f+2*this.buffer,x=m+2*this.buffer,b=Math.max(_*x,0),T=new Uint8ClampedArray(b),C={data:T,width:_,height:x,glyphWidth:f,glyphHeight:m,glyphTop:h,glyphLeft:0,glyphAdvance:e};if(f===0||m===0)return C;const{ctx:P,buffer:D,gridInner:O,gridOuter:F}=this;P.clearRect(D,D,f,m),P.fillText(t,D,D+h);const $=P.getImageData(D,D,f,m);F.fill(Lh,0,b),O.fill(0,0,b);for(let X=0;X<m;X++)for(let H=0;H<f;H++){const ne=$.data[4*(X*f+H)+3]/255;if(ne===0)continue;const re=(X+D)*_+H+D;if(ne===1)F[re]=0,O[re]=Lh;else{const ce=.5-ne;F[re]=ce>0?ce*ce:0,O[re]=ce<0?ce*ce:0}}n1(F,0,0,_,x,_,this.f,this.v,this.z),n1(O,D,D,f,m,_,this.f,this.v,this.z);for(let X=0;X<b;X++){const H=Math.sqrt(F[X])-Math.sqrt(O[X]);T[X]=Math.round(255-255*(H/this.radius+this.cutoff))}return C}};const ga=Ln;function s1(t,e,r,n){const a=[],l=t.imagePrimary,h=l.pixelRatio,f=l.paddedRect.w-2*ga,m=l.paddedRect.h-2*ga,_=t.right-t.left,x=t.bottom-t.top,b=l.stretchX||[[0,f]],T=l.stretchY||[[0,m]],C=(xe,Se)=>xe+Se[1]-Se[0],P=b.reduce(C,0),D=T.reduce(C,0),O=f-P,F=m-D;let $=0,X=P,H=0,ne=D,re=0,ce=O,pe=0,ye=F;if(l.content&&n){const xe=l.content;$=Df(b,0,xe[0]),H=Df(T,0,xe[1]),X=Df(b,xe[0],xe[2]),ne=Df(T,xe[1],xe[3]),re=xe[0]-$,pe=xe[1]-H,ce=xe[2]-xe[0]-X,ye=xe[3]-xe[1]-ne}const Te=(xe,Se,Be,Ce)=>{const Oe=zf(xe.stretch-$,X,_,t.left),Me=Rf(xe.fixed-re,ce,xe.stretch,P),Re=zf(Se.stretch-H,ne,x,t.top),et=Rf(Se.fixed-pe,ye,Se.stretch,D),Ne=zf(Be.stretch-$,X,_,t.left),gt=Rf(Be.fixed-re,ce,Be.stretch,P),ht=zf(Ce.stretch-H,ne,x,t.top),je=Rf(Ce.fixed-pe,ye,Ce.stretch,D),kt=new Ge(Oe,Re),Mt=new Ge(Ne,Re),_t=new Ge(Ne,ht),Ze=new Ge(Oe,ht),Dt=new Ge(Me/h,et/h),Qt=new Ge(gt/h,je/h),Bt=e*Math.PI/180;if(Bt){const xr=Math.sin(Bt),br=Math.cos(Bt),Ar=[br,-xr,xr,br];kt._matMult(Ar),Mt._matMult(Ar),Ze._matMult(Ar),_t._matMult(Ar)}const er=xe.stretch+xe.fixed,Zt=Be.stretch+Be.fixed,hr=Se.stretch+Se.fixed,Wt=Ce.stretch+Ce.fixed,Ur=t.imageSecondary;return{tl:kt,tr:Mt,bl:Ze,br:_t,texPrimary:{x:l.paddedRect.x+ga+er,y:l.paddedRect.y+ga+hr,w:Zt-er,h:Wt-hr},texSecondary:Ur?{x:Ur.paddedRect.x+ga+er,y:Ur.paddedRect.y+ga+hr,w:Zt-er,h:Wt-hr}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Dt,pixelOffsetBR:Qt,minFontScaleX:ce/h/_,minFontScaleY:ye/h/x,isSDF:r}};if(n&&(l.stretchX||l.stretchY)){const xe=a1(b,O,P),Se=a1(T,F,D);for(let Be=0;Be<xe.length-1;Be++){const Ce=xe[Be],Oe=xe[Be+1];for(let Me=0;Me<Se.length-1;Me++)a.push(Te(Ce,Se[Me],Oe,Se[Me+1]))}}else a.push(Te({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:f+1},{fixed:0,stretch:m+1}));return a}function Df(t,e,r){let n=0;for(const a of t)n+=Math.max(e,Math.min(r,a[1]))-Math.max(e,Math.min(r,a[0]));return n}function a1(t,e,r){const n=[{fixed:-ga,stretch:0}];for(const[a,l]of t){const h=n[n.length-1];n.push({fixed:a-h.stretch,stretch:h.stretch}),n.push({fixed:a-h.stretch,stretch:h.stretch+(l-a)})}return n.push({fixed:e+ga,stretch:r}),n}function zf(t,e,r,n){return t/e*r+n}function Rf(t,e,r,n){return t-e*r/n}function rT(t,e,r,n){const a=e+t.positionedLines[n].lineOffset;return n===0?r+a/2:r+(a+(e+t.positionedLines[n-1].lineOffset))/2}function iT(t,e=1,r=!1){let n=1/0,a=1/0,l=-1/0,h=-1/0;const f=t[0];for(let C=0;C<f.length;C++){const P=f[C];(!C||P.x<n)&&(n=P.x),(!C||P.y<a)&&(a=P.y),(!C||P.x>l)&&(l=P.x),(!C||P.y>h)&&(h=P.y)}const m=Math.min(l-n,h-a);let _=m/2;const x=new Pn([],nT);if(m===0)return new Ge(n,a);for(let C=n;C<l;C+=m)for(let P=a;P<h;P+=m)x.push(new Sc(C+_,P+_,_,t));let b=function(C){let P=0,D=0,O=0;const F=C[0];for(let $=0,X=F.length,H=X-1;$<X;H=$++){const ne=F[$],re=F[H],ce=ne.x*re.y-re.x*ne.y;D+=(ne.x+re.x)*ce,O+=(ne.y+re.y)*ce,P+=3*ce}return new Sc(D/P,O/P,0,C)}(t),T=x.length;for(;x.length;){const C=x.pop();(C.d>b.d||!b.d)&&(b=C,r&&console.log("found best %d after %d probes",Math.round(1e4*C.d)/1e4,T)),C.max-b.d<=e||(_=C.h/2,x.push(new Sc(C.p.x-_,C.p.y-_,_,t)),x.push(new Sc(C.p.x+_,C.p.y-_,_,t)),x.push(new Sc(C.p.x-_,C.p.y+_,_,t)),x.push(new Sc(C.p.x+_,C.p.y+_,_,t)),T+=4)}return r&&(console.log(`num probes: ${T}`),console.log(`best distance: ${b.d}`)),b.p}function nT(t,e){return e.max-t.max}class Sc{constructor(e,r,n,a){this.p=new Ge(e,r),this.h=n,this.d=function(l,h){let f=!1,m=1/0;for(let _=0;_<h.length;_++){const x=h[_];for(let b=0,T=x.length,C=T-1;b<T;C=b++){const P=x[b],D=x[C];P.y>l.y!=D.y>l.y&&l.x<(D.x-P.x)*(l.y-P.y)/(D.y-P.y)+P.x&&(f=!f),m=Math.min(m,ha(l,P,D))}}return(f?1:-1)*Math.sqrt(m)}(this.p,a),this.max=this.d+this.h*Math.SQRT2}}const Hm=Number.POSITIVE_INFINITY,oT=Math.sqrt(2);function l1(t,[e,r]){let n=0,a=0;if(r===Hm){e<0&&(e=0);const l=e/oT;switch(t){case"top-right":case"top-left":a=l-7;break;case"bottom-right":case"bottom-left":a=7-l;break;case"bottom":a=7-e;break;case"top":a=e-7}switch(t){case"top-right":case"bottom-right":n=-l;break;case"top-left":case"bottom-left":n=l;break;case"left":n=e;break;case"right":n=-e}}else{switch(e=Math.abs(e),r=Math.abs(r),t){case"top-right":case"top-left":case"top":a=r-7;break;case"bottom-right":case"bottom-left":case"bottom":a=7-r}switch(t){case"top-right":case"bottom-right":case"right":n=-e;break;case"top-left":case"bottom-left":case"left":n=e}}return[n,a]}function Xm(t){switch(t){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function sT(t,e,r,n,a,l,h,f,m,_,x,b,T,C,P){let D=l.textMaxSize.evaluate(e,{},b);D===void 0&&(D=h);const O=t.layers[0].layout,F=O.get("icon-offset").evaluate(e,{},b),$=u1(r.horizontal)||r.vertical,X=T.name==="globe",H=$i,ne=h/H,re=t.tilePixelRatio*D/H,ce=(Oe=t.overscaling,t.zoom>18&&Oe>2&&(Oe>>=1),Math.max(ct/(512*Oe),1)*O.get("symbol-spacing")),pe=O.get("text-padding")*t.tilePixelRatio,ye=O.get("icon-padding")*t.tilePixelRatio,Te=St(O.get("text-max-angle")),xe=O.get("text-rotation-alignment")==="map"&&O.get("symbol-placement")!=="point",Se=O.get("icon-rotation-alignment")==="map"&&O.get("symbol-placement")!=="point",Be=O.get("symbol-placement"),Ce=ce/2;var Oe;const Me=O.get("icon-text-fit").evaluate(e,{},b),Re=O.get("icon-text-fit-padding").evaluate(e,{},b),et=Me!=="none";let Ne;t.hasAnyIconTextFit===!1&&et&&(t.hasAnyIconTextFit=!0),n&&et&&(t.allowVerticalPlacement&&r.vertical&&(Ne=Xy(n,r.vertical,Me,Re,F,ne)),$&&(n=Xy(n,$,Me,Re,F,ne)));const gt=(ht,je,kt)=>{if(je.x<0||je.x>=ct||je.y<0||je.y>=ct)return;let Mt=null;if(X){const{x:_t,y:Ze,z:Dt}=T.projectTilePoint(je.x,je.y,kt);Mt={anchor:new zs(_t,Ze,Dt,0,void 0),up:T.upVector(kt,je.x,je.y)}}(function(_t,Ze,Dt,Qt,Bt,er,Zt,hr,Wt,Ur,xr,br,Ar,vr,Qr,Rr,ui,Ii,Gi,Yr,ni,Oi,ki,Bi,$r,Dn,Ta){const dn=_t.addToLineVertexArray(Ze,Qt);let rn,Jn,Wh,tp,ux,hx,dx,fx=0,px=0,mx=0,_x=0,x_=-1,v_=-1;const ns={};let gx=gh("");const Ml=Dt?Dt.anchor:Ze,b_=Wt.layout.get("icon-text-fit").evaluate(ni,{},$r)!=="none";let w_=0,T_=0;if(Wt._unevaluatedLayout.getValue("text-radial-offset")===void 0?[w_,T_]=Wt.layout.get("text-offset").evaluate(ni,{},$r).map(zn=>zn*$i):(w_=Wt.layout.get("text-radial-offset").evaluate(ni,{},$r)*$i,T_=Hm),_t.allowVerticalPlacement&&Bt.vertical){const zn=Bt.vertical;if(Qr)hx=Ym(zn),hr&&(dx=Ym(hr));else{const Rn=Wt.layout.get("text-rotate").evaluate(ni,{},$r)+90;Wh=Of(Ur,Ml,Ze,xr,br,Ar,zn,vr,Rn,Rr),hr&&(tp=Of(Ur,Ml,Ze,xr,br,Ar,hr,Ii,Rn))}}if(er){const zn=Wt.layout.get("icon-rotate").evaluate(ni,{},$r),Rn=s1(er,zn,ki,b_),Bc=hr?s1(hr,zn,ki,b_):void 0;Jn=Of(Ur,Ml,Ze,xr,br,Ar,er,Ii,zn),fx=4*Rn.length;const yx=_t.iconSizeData;let Il=null;yx.kind==="source"?(Il=[Mo*Wt.layout.get("icon-size").evaluate(ni,{},$r)],Il[0]>ya&&li(`${_t.layerIds[0]}: Value for "icon-size" is >= ${Dh}. Reduce your "icon-size".`)):yx.kind==="composite"&&(Il=[Mo*Oi.compositeIconSizes[0].evaluate(ni,{},$r),Mo*Oi.compositeIconSizes[1].evaluate(ni,{},$r)],(Il[0]>ya||Il[1]>ya)&&li(`${_t.layerIds[0]}: Value for "icon-size" is >= ${Dh}. Reduce your "icon-size".`)),_t.addSymbols(_t.icon,Rn,Il,Yr,Gi,ni,!1,Dt,Ze,dn.lineStartIndex,dn.lineLength,-1,Bi,$r,Dn,Ta),x_=_t.icon.placedSymbolArray.length-1,Bc&&(px=4*Bc.length,_t.addSymbols(_t.icon,Bc,Il,Yr,Gi,ni,Yn.vertical,Dt,Ze,dn.lineStartIndex,dn.lineLength,-1,Bi,$r,Dn,Ta),v_=_t.icon.placedSymbolArray.length-1)}for(const zn in Bt.horizontal){const Rn=Bt.horizontal[zn];rn||(gx=gh(Rn.text),Qr?ux=Ym(Rn):rn=Of(Ur,Ml,Ze,xr,br,Ar,Rn,vr,Wt.layout.get("text-rotate").evaluate(ni,{},$r),Rr));const Bc=Rn.positionedLines.length===1;if(mx+=c1(_t,Dt,Ze,Rn,Zt,Wt,Qr,ni,Rr,dn,Bt.vertical?Yn.horizontal:Yn.horizontalOnly,Bc?Object.keys(Bt.horizontal):[zn],ns,x_,Oi,Bi,$r,Dn),Bc)break}Bt.vertical&&(_x+=c1(_t,Dt,Ze,Bt.vertical,Zt,Wt,Qr,ni,Rr,dn,Yn.vertical,["vertical"],ns,v_,Oi,Bi,$r,Dn));let Ea=-1;const E_=(zn,Rn)=>zn?Math.max(zn,Rn):Rn;Ea=E_(ux,Ea),Ea=E_(hx,Ea),Ea=E_(dx,Ea);const EE=Ea>-1?1:0;_t.glyphOffsetArray.length>=65535&&li("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),ni.sortKey!==void 0&&_t.addToSortKeyRanges(_t.symbolInstances.length,ni.sortKey),_t.symbolInstances.emplaceBack(Ze.x,Ze.y,Ml.x,Ml.y,Ml.z,ns.right>=0?ns.right:-1,ns.center>=0?ns.center:-1,ns.left>=0?ns.left:-1,ns.vertical>=0?ns.vertical:-1,x_,v_,gx,rn!==void 0?rn:_t.collisionBoxArray.length,rn!==void 0?rn+1:_t.collisionBoxArray.length,Wh!==void 0?Wh:_t.collisionBoxArray.length,Wh!==void 0?Wh+1:_t.collisionBoxArray.length,Jn!==void 0?Jn:_t.collisionBoxArray.length,Jn!==void 0?Jn+1:_t.collisionBoxArray.length,tp||_t.collisionBoxArray.length,tp?tp+1:_t.collisionBoxArray.length,xr,mx,_x,fx,px,EE,0,w_,T_,Ea,0,b_?1:0)})(t,je,Mt,ht,r,n,a,Ne,t.layers[0],t.collisionBoxArray,e.index,e.sourceLayerIndex,t.index,pe,xe,m,0,ye,Se,F,e,l,_,x,b,C,P)};if(Be==="line")for(const ht of t1(e.geometry,0,0,ct,ct)){const je=tT(ht,ce,Te,r.vertical||$,n,H,re,t.overscaling,ct);for(const kt of je)$&&aT(t,$.text,Ce,kt)||gt(ht,kt,b)}else if(Be==="line-center"){for(const ht of e.geometry)if(ht.length>1){const je=eT(ht,Te,r.vertical||$,n,H,re);je&&gt(ht,je,b)}}else if(e.type==="Polygon")for(const ht of Rm(e.geometry,0)){const je=iT(ht,16);gt(ht[0],new zs(je.x,je.y,0,0,void 0),b)}else if(e.type==="LineString")for(const ht of e.geometry)gt(ht,new zs(ht[0].x,ht[0].y,0,0,void 0),b);else if(e.type==="Point")for(const ht of e.geometry)for(const je of ht)gt([je],new zs(je.x,je.y,0,0,void 0),b)}const Dh=255,ya=Dh*Mo;function c1(t,e,r,n,a,l,h,f,m,_,x,b,T,C,P,D,O,F){const $=function(ne,re,ce,pe,ye,Te,xe,Se){const Be=[];if(re.positionedLines.length===0)return Be;const Ce=pe.layout.get("text-rotate").evaluate(Te,{})*Math.PI/180,Oe=function(gt){const ht=gt[0],je=gt[1],kt=ht*je;return kt>0?[ht,-je]:kt<0?[-ht,je]:ht===0?[je,ht]:[je,-ht]}(ce);let Me=Math.abs(re.top-re.bottom);for(const gt of re.positionedLines)Me-=gt.lineOffset;const Re=re.positionedLines.length,et=Me/Re;let Ne=re.top-ce[1];for(let gt=0;gt<Re;++gt){const ht=re.positionedLines[gt];Ne=rT(re,et,Ne,gt);for(const je of ht.positionedGlyphs){if(!je.rect)continue;const kt=je.rect||{};let Mt=Zy+1,_t=!0,Ze=1,Dt=0;if(je.imageName){const Yr=xe[je.imageName];if(!Yr)continue;if(Yr.sdf){li("SDF images are not supported in formatted text and will be ignored.");continue}_t=!1,Ze=Yr.pixelRatio,Mt=Ln/Ze}const Qt=(ye||Se)&&je.vertical,Bt=je.metrics.advance*je.scale/2,er=je.metrics,Zt=je.rect;if(Zt===null)continue;Se&&re.verticalizable&&(Dt=je.imageName?Bt-je.metrics.width*je.scale/2:0);const hr=ye?[je.x+Bt,je.y]:[0,0];let Wt=[0,0],Ur=[0,0],xr=!1;ye||(Qt?(Ur=[je.x+Bt+Oe[0],je.y+Oe[1]-Dt],xr=!0):Wt=[je.x+Bt+ce[0],je.y+ce[1]-Dt]);const br=Zt.w*je.scale/(Ze*(je.localGlyph?Io:1)),Ar=Zt.h*je.scale/(Ze*(je.localGlyph?Io:1));let vr,Qr,Rr,ui;if(Qt){const Yr=je.y-Ne,ni=new Ge(-Bt,Bt-Yr),Oi=-Math.PI/2,ki=new Ge(...Ur);vr=new Ge(-Bt+Wt[0],Wt[1]),vr._rotateAround(Oi,ni)._add(ki),vr.x+=-Yr+Bt,vr.y-=(er.left-Mt)*je.scale;const Bi=je.imageName?er.advance*je.scale:$i*je.scale,$r=String.fromCodePoint(je.glyph);kw($r)?vr.x+=(1-Mt)*je.scale:Bw($r)?vr.x+=Bi-er.height*je.scale+(-Mt-1)*je.scale:vr.x+=je.imageName||er.width+2*Mt===Zt.w&&er.height+2*Mt===Zt.h?(Bi-Ar)/2:(Bi-(er.height+2*Mt)*je.scale)/2,Qr=new Ge(vr.x,vr.y-br),Rr=new Ge(vr.x+Ar,vr.y),ui=new Ge(vr.x+Ar,vr.y-br)}else{const Yr=(er.left-Mt)*je.scale-Bt+Wt[0],ni=(-er.top-Mt)*je.scale+Wt[1],Oi=Yr+br,ki=ni+Ar;vr=new Ge(Yr,ni),Qr=new Ge(Oi,ni),Rr=new Ge(Yr,ki),ui=new Ge(Oi,ki)}if(Ce){let Yr;Yr=ye?new Ge(0,0):xr?new Ge(Oe[0],Oe[1]):new Ge(ce[0],ce[1]),vr._rotateAround(Ce,Yr),Qr._rotateAround(Ce,Yr),Rr._rotateAround(Ce,Yr),ui._rotateAround(Ce,Yr)}const Ii=new Ge(0,0),Gi=new Ge(0,0);Be.push({tl:vr,tr:Qr,bl:Rr,br:ui,texPrimary:kt,texSecondary:void 0,writingMode:re.writingMode,glyphOffset:hr,sectionIndex:je.sectionIndex,isSDF:_t,pixelOffsetTL:Ii,pixelOffsetBR:Gi,minFontScaleX:0,minFontScaleY:0})}}return Be}(0,n,m,l,h,f,a,t.allowVerticalPlacement),X=t.textSizeData;let H=null;X.kind==="source"?(H=[Mo*l.layout.get("text-size").evaluate(f,{},O)],H[0]>ya&&li(`${t.layerIds[0]}: Value for "text-size" is >= ${Dh}. Reduce your "text-size".`)):X.kind==="composite"&&(H=[Mo*P.compositeTextSizes[0].evaluate(f,{},O),Mo*P.compositeTextSizes[1].evaluate(f,{},O)],(H[0]>ya||H[1]>ya)&&li(`${t.layerIds[0]}: Value for "text-size" is >= ${Dh}. Reduce your "text-size".`)),t.addSymbols(t.text,$,H,m,h,f,x,e,r,_.lineStartIndex,_.lineLength,C,D,O,F,!1);for(const ne of b)T[ne]=t.text.placedSymbolArray.length-1;return 4*$.length}function u1(t){for(const e in t)return t[e];return null}function Of(t,e,r,n,a,l,h,f,m,_){let x=h.top,b=h.bottom,T=h.left,C=h.right;const P=h.collisionPadding;if(P&&(T-=P[0],x-=P[1],C+=P[2],b+=P[3]),m){const D=new Ge(T,x),O=new Ge(C,x),F=new Ge(T,b),$=new Ge(C,b),X=St(m);let H=new Ge(0,0);_&&(H=new Ge(_[0],_[1])),D._rotateAround(X,H),O._rotateAround(X,H),F._rotateAround(X,H),$._rotateAround(X,H),T=Math.min(D.x,O.x,F.x,$.x),C=Math.max(D.x,O.x,F.x,$.x),x=Math.min(D.y,O.y,F.y,$.y),b=Math.max(D.y,O.y,F.y,$.y)}return t.emplaceBack(e.x,e.y,e.z,r.x,r.y,T,x,C,b,f,n,a,l),t.length-1}function Ym(t){t.collisionPadding&&(t.top-=t.collisionPadding[1],t.bottom+=t.collisionPadding[3]);const e=t.bottom-t.top;return e>0?Math.max(10,e):null}function aT(t,e,r,n){const a=t.compareText;if(e in a){const l=a[e];for(let h=l.length-1;h>=0;h--)if(n.dist(l[h])<r)return!0}else a[e]=[];return a[e].push(n),!1}function h1(t,e){const r=t.fovAboveCenter,n=t.elevation?t.elevation.getMinElevationBelowMSL()*e:0,a=(t._camera.position[2]*t.worldSize-n)/Math.cos(t._pitch),l=Math.sin(r)*a/Math.sin(Math.max(Math.PI/2-t._pitch-r,.01)),h=Math.sin(t._pitch)*l+a;return Math.min(1.01*h,a*(1/t._horizonShift))}function zh(t,e){if(!e.isReprojectedInTileSpace)return{scale:1<<t.z,x:t.x,y:t.y,x2:t.x+1,y2:t.y+1,projection:e};const r=Math.pow(2,-t.z),n=t.x*r,a=(t.x+1)*r,l=t.y*r,h=(t.y+1)*r,f=$t(n),m=$t(a),_=fr(l),x=fr(h),b=e.project(f,_),T=e.project(m,_),C=e.project(m,x),P=e.project(f,x);let D=Math.min(b.x,T.x,C.x,P.x),O=Math.min(b.y,T.y,C.y,P.y),F=Math.max(b.x,T.x,C.x,P.x),$=Math.max(b.y,T.y,C.y,P.y);const X=r/16;function H(re,ce,pe,ye,Te,xe){const Se=(pe+Te)/2,Be=(ye+xe)/2,Ce=e.project($t(Se),fr(Be)),Oe=Math.max(0,D-Ce.x,O-Ce.y,Ce.x-F,Ce.y-$);D=Math.min(D,Ce.x),F=Math.max(F,Ce.x),O=Math.min(O,Ce.y),$=Math.max($,Ce.y),Oe>X&&(H(re,Ce,pe,ye,Se,Be),H(Ce,ce,Se,Be,Te,xe))}H(b,T,n,l,a,l),H(T,C,a,l,a,h),H(C,P,a,h,n,h),H(P,b,n,h,n,l),D-=X,O-=X,F+=X,$+=X;const ne=1/Math.max(F-D,$-O);return{scale:ne,x:D*ne,y:O*ne,x2:F*ne,y2:$*ne,projection:e}}function d1(t,{x:e,y:r},n=0){return new Ge(((e-n)*t.scale-t.x)*ct,(r*t.scale-t.y)*ct)}const lT=s.a6.identity(new Float32Array(16));class xa{constructor(e){this.spec=e,this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,r){return{x:0,y:0,z:0}}unproject(e,r){return new ge(0,0)}projectTilePoint(e,r,n){return{x:e,y:r,z:0}}locationPoint(e,r,n=!0){return e._coordinatePoint(e.locationCoordinate(r),n)}pixelsPerMeter(e,r){return qt(1,e)*r}pixelSpaceConversion(e,r,n){return 1}farthestPixelDistance(e){return h1(e,e.pixelsPerMeter)}pointCoordinate(e,r,n,a){const l=e.horizonLineFromTop(!1),h=new Ge(r,Math.max(l,n));return e.rayIntersectionCoordinate(e.pointRayIntersection(h,a))}pointCoordinate3D(e,r,n){const a=new Ge(r,n);if(e.elevation)return e.elevation.pointCoordinate(a);{const l=this.pointCoordinate(e,a.x,a.y,0);return[l.x,l.y,l.z]}}isPointAboveHorizon(e,r){if(e.elevation)return!this.pointCoordinate3D(e,r.x,r.y);const n=e.horizonLineFromTop();return r.y<n}createInversionMatrix(e,r){return lT}createTileMatrix(e,r,n){let a,l,h;const f=n.canonical,m=s.a6.identity(new Float64Array(16));if(this.isReprojectedInTileSpace){const _=zh(f,this);a=1,l=_.x+n.wrap*_.scale,h=_.y,s.a6.scale(m,m,[a/_.scale,a/_.scale,e.pixelsPerMeter/r])}else a=r/e.zoomScale(f.z),l=(f.x+Math.pow(2,f.z)*n.wrap)*a,h=f.y*a;return s.a6.translate(m,m,[l,h,0]),s.a6.scale(m,m,[a/ct,a/ct,1]),m}upVector(e,r,n){return[0,0,1]}upVectorScale(e,r,n){return{metersToTile:1}}}class cT extends xa{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];const[r,n]=this.parallels=e.parallels||[29.5,45.5],a=Math.sin(St(r));this.n=(a+Math.sin(St(n)))/2,this.c=1+a*(2*this.n-a),this.r0=Math.sqrt(this.c)/this.n}project(e,r){const{n,c:a,r0:l}=this,h=St(e-this.center[0]),f=St(r),m=Math.sqrt(a-2*n*Math.sin(f))/n;return{x:m*Math.sin(h*n),y:m*Math.cos(h*n)-l,z:0}}unproject(e,r){const{n,c:a,r0:l}=this,h=l+r;let f=Math.atan2(e,Math.abs(h))*Math.sign(h);h*n<0&&(f-=Math.PI*Math.sign(e)*Math.sign(h));const m=St(this.center[0])*n;f=mn(f,-Math.PI-m,Math.PI-m);const _=Ut(At(f/n)+this.center[0],-180,180),x=Math.asin(Ut((a-(e*e+h*h)*n*n)/(2*n),-1,1)),b=Ut(At(x),-nr,nr);return new ge(_,b)}}const Rh=1.340264,Oh=-.081106,kh=893e-6,Bh=.003796,kf=Math.sqrt(3)/2;class uT extends xa{project(e,r){r=r/180*Math.PI,e=e/180*Math.PI;const n=Math.asin(kf*Math.sin(r)),a=n*n,l=a*a*a;return{x:.5*(e*Math.cos(n)/(kf*(Rh+3*Oh*a+l*(7*kh+9*Bh*a)))/Math.PI+.5),y:1-.5*(n*(Rh+Oh*a+l*(kh+Bh*a))/Math.PI+1),z:0}}unproject(e,r){e=(2*e-.5)*Math.PI;let n=r=(2*(1-r)-1)*Math.PI,a=n*n,l=a*a*a;for(let x,b,T,C=0;C<12&&(b=n*(Rh+Oh*a+l*(kh+Bh*a))-r,T=Rh+3*Oh*a+l*(7*kh+9*Bh*a),x=b/T,n=Ut(n-x,-Math.PI/3,Math.PI/3),a=n*n,l=a*a*a,!(Math.abs(x)<1e-12));++C);const h=kf*e*(Rh+3*Oh*a+l*(7*kh+9*Bh*a))/Math.cos(n),f=Math.asin(Math.sin(n)/kf),m=Ut(180*h/Math.PI,-180,180),_=Ut(180*f/Math.PI,-nr,nr);return new ge(m,_)}}class hT extends xa{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,r){return{x:.5+e/360,y:.5-r/360,z:0}}unproject(e,r){const n=360*(e-.5),a=Ut(360*(.5-r),-nr,nr);return new ge(n,a)}}const Pc=Math.PI/2;function Bf(t){return Math.tan((Pc+t)/2)}class dT extends xa{constructor(e){super(e),this.center=e.center||[0,30];const[r,n]=this.parallels=e.parallels||[30,30];let a=St(r),l=St(n);this.southernCenter=a+l<0,this.southernCenter&&(a=-a,l=-l);const h=Math.cos(a),f=Bf(a);this.n=a===l?Math.sin(a):Math.log(h/Math.cos(l))/Math.log(Bf(l)/f),this.f=h*Math.pow(Bf(a),this.n)/this.n}project(e,r){r=St(r),this.southernCenter&&(r=-r),e=St(e-this.center[0]);const n=1e-6,{n:a,f:l}=this;l>0?r<-Pc+n&&(r=-Pc+n):r>Pc-n&&(r=Pc-n);const h=l/Math.pow(Bf(r),a);let f=h*Math.sin(a*e),m=l-h*Math.cos(a*e);return f=.5*(f/Math.PI+.5),m=.5*(m/Math.PI+.5),{x:f,y:this.southernCenter?m:1-m,z:0}}unproject(e,r){e=(2*e-.5)*Math.PI,this.southernCenter&&(r=1-r),r=(2*(1-r)-.5)*Math.PI;const{n,f:a}=this,l=a-r,h=Math.sign(l),f=Math.sign(n)*Math.sqrt(e*e+l*l);let m=Math.atan2(e,Math.abs(l))*h;l*n<0&&(m-=Math.PI*Math.sign(e)*h);const _=Ut(At(m/n)+this.center[0],-180,180),x=Ut(At(2*Math.atan(Math.pow(a/f,1/n))-Pc),-nr,nr);return new ge(_,this.southernCenter?-x:x)}}class f1 extends xa{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,r){return{x:Yt(e),y:Vt(r),z:0}}unproject(e,r){const n=$t(e),a=fr(r);return new ge(n,a)}}const p1=St(nr);class fT extends xa{project(e,r){const n=(r=St(r))*r,a=n*n;return{x:.5*((e=St(e))*(.8707-.131979*n+a*(a*(.003971*n-.001529*a)-.013791))/Math.PI+.5),y:1-.5*(r*(1.007226+n*(.015085+a*(.028874*n-.044475-.005916*a)))/Math.PI+1),z:0}}unproject(e,r){e=(2*e-.5)*Math.PI;let n=r=(2*(1-r)-1)*Math.PI,a=25,l=0,h=n*n;do{h=n*n;const _=h*h;l=(n*(1.007226+h*(.015085+_*(.028874*h-.044475-.005916*_)))-r)/(1.007226+h*(.045255+_*(.259866*h-.311325-.005916*11*_))),n=Ut(n-l,-p1,p1)}while(Math.abs(l)>1e-6&&--a>0);h=n*n;const f=Ut(At(e/(.8707+h*(h*(h*h*h*(.003971-.001529*h)-.013791)-.131979))),-180,180),m=At(n);return new ge(f,m)}}const m1=St(nr);class pT extends xa{project(e,r){r=St(r),e=St(e);const n=Math.cos(r),a=2/Math.PI,l=Math.acos(n*Math.cos(e/2)),h=Math.sin(l)/l,f=.5*(e*a+2*n*Math.sin(e/2)/h)||0,m=.5*(r+Math.sin(r)/h)||0;return{x:.5*(f/Math.PI+.5),y:1-.5*(m/Math.PI+1),z:0}}unproject(e,r){let n=e=(2*e-.5)*Math.PI,a=r=(2*(1-r)-1)*Math.PI,l=25;const h=1e-6;let f=0,m=0;do{const _=Math.cos(a),x=Math.sin(a),b=2*x*_,T=x*x,C=_*_,P=Math.cos(n/2),D=Math.sin(n/2),O=2*P*D,F=D*D,$=1-C*P*P,X=$?1/$:0,H=$?Math.acos(_*P)*Math.sqrt(1/$):0,ne=.5*(2*H*_*D+2*n/Math.PI)-e,re=.5*(H*x+a)-r,ce=.5*X*(C*F+H*_*P*T)+1/Math.PI,pe=X*(O*b/4-H*x*D),ye=.125*X*(b*D-H*x*C*O),Te=.5*X*(T*P+H*F*_)+.5,xe=pe*ye-Te*ce;f=(re*pe-ne*Te)/xe,m=(ne*ye-re*ce)/xe,n=Ut(n-f,-Math.PI,Math.PI),a=Ut(a-m,-m1,m1)}while((Math.abs(f)>h||Math.abs(m)>h)&&--l>0);return new ge(At(n),At(a))}}class _1 extends xa{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(St(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,r){const{scale:n,cosPhi:a}=this;return{x:St(e)*a*n+.5,y:-Math.sin(St(r))/a*n+.5,z:0}}unproject(e,r){const{scale:n,cosPhi:a}=this,l=-(r-.5)/n,h=Ut(At((e-.5)/n)/a,-180,180),f=Math.asin(Ut(l*a,-1,1)),m=Ut(At(f),-nr,nr);return new ge(h,m)}}class mT extends f1{constructor(e){super(e),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(e,r,n){const a=bh(e,r,n),l=mf(is(n));return s.N.transformMat4(a,a,l),{x:a[0],y:a[1],z:a[2]}}locationPoint(e,r){const n=Ae(r.lat,r.lng),a=s.N.normalize([],n),l=e.elevation?e.elevation.getAtPointOrZero(e.locationCoordinate(r),e._centerAltitude):e._centerAltitude,h=qt(1,0)*ct*l;s.N.scaleAndAdd(n,n,a,h);const f=s.a6.identity(new Float64Array(16));return s.a6.multiply(f,e.pixelMatrix,e.globeMatrix),s.N.transformMat4(n,n,f),new Ge(n[0],n[1])}pixelsPerMeter(e,r){return qt(1,0)*r}pixelSpaceConversion(e,r,n){const a=qt(1,e)*r,l=ur(qt(1,45)*r,a,n);return this.pixelsPerMeter(e,r)/l}createTileMatrix(e,r,n){const a=Im(is(n.canonical));return s.a6.multiply(new Float64Array(16),e.globeMatrix,a)}createInversionMatrix(e,r){const{center:n}=e,a=mf(is(r));return s.a6.rotateY(a,a,St(n.lng)),s.a6.rotateX(a,a,St(n.lat)),s.a6.scale(a,a,[e._pixelsPerMercatorPixel,e._pixelsPerMercatorPixel,1]),Float32Array.from(a)}pointCoordinate(e,r,n,a){return z0(e,r,n,!0)||new gr(0,0)}pointCoordinate3D(e,r,n){const a=this.pointCoordinate(e,r,n,0);return[a.x,a.y,a.z]}isPointAboveHorizon(e,r){return!z0(e,r.x,r.y,!1)}farthestPixelDistance(e){const r=function(a,l){const h=a.cameraToCenterDistance,f=a._centerAltitude*l,m=a._camera,_=a._camera.forward(),x=s.N.add([],s.N.scale([],_,-h),[0,0,f]),b=a.worldSize/(2*Math.PI),T=[0,0,-b],C=a.width/a.height,P=Math.tan(a.fovAboveCenter),D=s.N.scale([],m.up(),P),O=s.N.scale([],m.right(),P*C),F=s.N.normalize([],s.N.add([],s.N.add([],_,D),O)),$=[];let X;if(new bm(x,F).closestPointOnSphere(T,b,$)){const H=s.N.add([],$,T),ne=s.N.sub([],H,x);X=Math.cos(a.fovAboveCenter)*s.N.length(ne)}else{const H=s.N.sub([],x,T),ne=s.N.sub([],T,x);s.N.normalize(ne,ne);const re=s.N.length(H)-b;X=Math.sqrt(re*(re+2*b));const ce=Math.acos(X/(b+re))-Math.acos(s.N.dot(_,ne));X*=Math.cos(ce)}return 1.01*X}(e,this.pixelsPerMeter(e.center.lat,e.worldSize)),n=fa(e.zoom);if(n>0){const a=h1(e,qt(1,e.center.lat)*e.worldSize),l=e.worldSize/(2*Math.PI),h=Math.max(e.width,e.height)/e.worldSize*Math.PI;return ur(r,a+l*(1-Math.cos(h)),Math.pow(n,10))}return r}upVector(e,r,n){return bh(r,n,e,1)}upVectorScale(e){return{metersToTile:df(pf(is(e)))}}}function g1(t){const e=t.parallels,r=!!e&&Math.abs(e[0]+e[1])<.01;switch(t.name){case"mercator":return new f1(t);case"equirectangular":return new hT(t);case"naturalEarth":return new fT(t);case"equalEarth":return new uT(t);case"winkelTripel":return new pT(t);case"albers":return r?new _1(t):new cT(t);case"lambertConformalConic":return r?new _1(t):new dT(t);case"globe":return new mT(t)}throw new Error(`Invalid projection name: ${t.name}`)}const _T=wf.types,gT=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Ff(t,e,r,n,a,l,h,f,m,_,x,b,T){const C=f?Math.min(ya,Math.round(f[0])):0,P=f?Math.min(ya,Math.round(f[1])):0;t.emplaceBack(e,r,Math.round(32*n),Math.round(32*a),l,h,(C<<1)+(m?1:0),P,16*_,16*x,256*b,256*T)}function Nf(t,e,r){t.emplaceBack(e,r)}function Uf(t,e,r,n,a,l,h){t.emplaceBack(e,r,n,a,l,h)}function Vf(t,e,r,n,a){t.emplaceBack(e,r,n,a),t.emplaceBack(e,r,n,a),t.emplaceBack(e,r,n,a),t.emplaceBack(e,r,n,a)}function yT(t){for(const e of t.sections)if($u(e.text))return!0;return!1}class Km{constructor(e){this.layoutVertexArray=new sl,this.indexArray=new Si,this.programConfigurations=e,this.segments=new ci,this.dynamicLayoutVertexArray=new Yo,this.opacityVertexArray=new lh,this.placedSymbolArray=new qd,this.iconTransitioningVertexArray=new io,this.globeExtVertexArray=new ah,this.zOffsetVertexArray=new ll}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}upload(e,r,n,a,l){this.isEmpty()||(n&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Iw.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,r),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,Aw.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,gT,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=e.createVertexBuffer(this.iconTransitioningVertexArray,Pw.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,Cw.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||l)&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,Sw.members,!0)),this.opacityVertexBuffer.itemSize=1),(n||a)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy())}}mt(Km,"SymbolBuffers");class Jm{constructor(e,r,n){this.layoutVertexArray=new e,this.layoutAttributes=r,this.indexArray=new n,this.segments=new ci,this.collisionVertexArray=new uh,this.collisionVertexArrayExt=new Yo}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,Lw.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,Dw.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}mt(Jm,"CollisionBuffers");class jf{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(h=>h.fqid),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=s.a6.identity([]),this.placementViewportMatrix=s.a6.identity([]);const r=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Vm(this.zoom,r["text-size"]),this.iconSizeData=Vm(this.zoom,r["icon-size"]);const n=this.layers[0].layout,a=n.get("symbol-sort-key"),l=n.get("symbol-z-order");this.canOverlap=n.get("text-allow-overlap")||n.get("icon-allow-overlap")||n.get("text-ignore-placement")||n.get("icon-ignore-placement"),this.sortFeaturesByKey=l!=="viewport-y"&&a.constantOr(1)!==void 0,this.sortFeaturesByY=(l==="viewport-y"||l==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=n.get("text-writing-mode").map(h=>Yn[h]),this.stateDependentLayerIds=this.layers.filter(h=>h.isStateDependent()).map(h=>h.id),this.sourceID=e.sourceID,this.projection=e.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=n.get("symbol-z-elevate")}createArrays(){this.text=new Km(new U(this.layers,this.zoom,e=>/^text/.test(e))),this.icon=new Km(new U(this.layers,this.zoom,e=>/^icon/.test(e))),this.glyphOffsetArray=new Xd,this.lineVertexArray=new dl,this.symbolInstances=new Hd}calculateGlyphDependencies(e,r,n,a,l){for(let h=0;h<e.length;h++){const f=e.codePointAt(h);if(f===void 0)break;if(r[f]=!0,a&&l&&f<=65535){const m=Sh[e.charAt(h)];m&&(r[m.charCodeAt(0)]=!0)}}}populate(e,r,n,a){const l=this.layers[0],h=l.layout,f=this.projection.name==="globe",m=h.get("text-font"),_=h.get("text-field"),x=h.get("icon-image"),b=(_.value.kind!=="constant"||_.value.value instanceof Vi&&!_.value.value.isEmpty()||_.value.value.toString().length>0)&&(m.value.kind!=="constant"||m.value.value.length>0),T=x.value.kind!=="constant"||!!x.value.value||Object.keys(x.parameters).length>0,C=h.get("symbol-sort-key");if(this.features=[],!b&&!T)return;const P=r.iconDependencies,D=r.glyphDependencies,O=r.availableImages,F=new ei(this.zoom);for(const{feature:$,id:X,index:H,sourceLayerIndex:ne}of e){const re=l._featureFilter.needGeometry,ce=wi($,re);if(!l._featureFilter.filter(F,ce,n))continue;if(re||(ce.geometry=Li($,n,a)),f&&$.type!==1&&n.z<=5){const xe=ce.geometry,Se=.98078528056,Be=(Ce,Oe)=>{const Me=bh(Ce.x,Ce.y,n,1),Re=bh(Oe.x,Oe.y,n,1);return s.N.dot(Me,Re)<Se};for(let Ce=0;Ce<xe.length;Ce++)xe[Ce]=Zi(xe[Ce],Be)}let pe,ye;if(b){const xe=l.getValueAndResolveTokens("text-field",ce,n,O),Se=Vi.factory(xe);yT(Se)&&(this.hasRTLText=!0),(!this.hasRTLText||Xo()==="unavailable"||this.hasRTLText&&vn.isParsed())&&(pe=Ow(Se,l,ce))}if(T){const xe=l.getValueAndResolveTokens("icon-image",ce,n,O);ye=xe instanceof Rt?xe:Rt.fromString(xe)}if(!pe&&!ye)continue;const Te=this.sortFeaturesByKey?C.evaluate(ce,{},n):void 0;if(this.features.push({id:X,text:pe,icon:ye,index:H,sourceLayerIndex:ne,geometry:ce.geometry,properties:$.properties,type:_T[$.type],sortKey:Te}),ye&&(P[ye.namePrimary]=!0,ye.nameSecondary&&(P[ye.nameSecondary]=!0)),pe){const xe=m.evaluate(ce,{},n).join(","),Se=h.get("text-rotation-alignment")==="map"&&h.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Yn.vertical)>=0;for(const Be of pe.sections)if(Be.image)P[Be.image.namePrimary]=!0;else{const Ce=Wo(pe.toString()),Oe=Be.fontStack||xe,Me=D[Oe]=D[Oe]||{};this.calculateGlyphDependencies(Be.text,Me,Se,this.allowVerticalPlacement,Ce)}}}h.get("symbol-placement")==="line"&&(this.features=function($){const X={},H={},ne=[];let re=0;function ce(xe){ne.push($[xe]),re++}function pe(xe,Se,Be){const Ce=H[xe];return delete H[xe],H[Se]=Ce,ne[Ce].geometry[0].pop(),ne[Ce].geometry[0]=ne[Ce].geometry[0].concat(Be[0]),Ce}function ye(xe,Se,Be){const Ce=X[Se];return delete X[Se],X[xe]=Ce,ne[Ce].geometry[0].shift(),ne[Ce].geometry[0]=Be[0].concat(ne[Ce].geometry[0]),Ce}function Te(xe,Se,Be){const Ce=Be?Se[0][Se[0].length-1]:Se[0][0];return`${xe}:${Ce.x}:${Ce.y}`}for(let xe=0;xe<$.length;xe++){const Se=$[xe],Be=Se.geometry,Ce=Se.text?Se.text.toString():null;if(!Ce){ce(xe);continue}const Oe=Te(Ce,Be),Me=Te(Ce,Be,!0);if(Oe in H&&Me in X&&H[Oe]!==X[Me]){const Re=ye(Oe,Me,Be),et=pe(Oe,Me,ne[Re].geometry);delete X[Oe],delete H[Me],H[Te(Ce,ne[et].geometry,!0)]=et,ne[Re].geometry=null}else Oe in H?pe(Oe,Me,Be):Me in X?ye(Oe,Me,Be):(ce(xe),X[Oe]=re-1,H[Me]=re-1)}return ne.filter(xe=>xe.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort(($,X)=>$.sortKey-X.sortKey)}update(e,r,n,a,l){const h=Object.keys(e).length!==0;if(h&&!this.stateDependentLayers.length)return;const f=h?this.stateDependentLayers:this.layers;this.text.programConfigurations.updatePaintArrays(e,r,f,n,a,l),this.icon.programConfigurations.updatePaintArrays(e,r,f,n,a,l)}updateZOffset(){const e=(l,h,f)=>{n+=h,n>l.length&&l.resize(n);for(let m=-h;m<0;m++)l.emplace(m+n,f)},r=(l,h,f)=>{a+=h,a>l.length&&l.resize(a);for(let m=-h;m<0;m++)l.emplace(m+a,f)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let n=0,a=0;for(let l=0;l<this.symbolInstances.length;l++){const h=this.symbolInstances.get(l),{numHorizontalGlyphVertices:f,numVerticalGlyphVertices:m,numIconVertices:_}=h,x=h.zOffset,b=_>0;if((f>0||m>0)&&(e(this.text.zOffsetVertexArray,f,x),e(this.text.zOffsetVertexArray,m,x)),b){const{placedIconSymbolIndex:T,verticalPlacedIconSymbolIndex:C}=h;T>=0&&r(this.icon.zOffsetVertexArray,_,x),C>=0&&r(this.icon.zOffsetVertexArray,h.numVerticalIconVertices,x)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=g1(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,r){const n=this.lineVertexArray.length;if(e.segment!==void 0)for(const{x:a,y:l}of r)this.lineVertexArray.emplaceBack(a,l);return{lineStartIndex:n,lineLength:this.lineVertexArray.length-n}}addSymbols(e,r,n,a,l,h,f,m,_,x,b,T,C,P,D,O){const F=e.indexArray,$=e.layoutVertexArray,X=e.globeExtVertexArray,H=e.segments.prepareSegment(4*r.length,$,F,this.canOverlap?h.sortKey:void 0),ne=this.glyphOffsetArray.length,re=H.vertexLength,ce=this.allowVerticalPlacement&&f===Yn.vertical?Math.PI/2:0,pe=h.text&&h.text.sections;for(let Te=0;Te<r.length;Te++){const{tl:xe,tr:Se,bl:Be,br:Ce,texPrimary:Oe,texSecondary:Me,pixelOffsetTL:Re,pixelOffsetBR:et,minFontScaleX:Ne,minFontScaleY:gt,glyphOffset:ht,isSDF:je,sectionIndex:kt}=r[Te],Mt=H.vertexLength,_t=ht[1];if(Ff($,_.x,_.y,xe.x,_t+xe.y,Oe.x,Oe.y,n,je,Re.x,Re.y,Ne,gt),Ff($,_.x,_.y,Se.x,_t+Se.y,Oe.x+Oe.w,Oe.y,n,je,et.x,Re.y,Ne,gt),Ff($,_.x,_.y,Be.x,_t+Be.y,Oe.x,Oe.y+Oe.h,n,je,Re.x,et.y,Ne,gt),Ff($,_.x,_.y,Ce.x,_t+Ce.y,Oe.x+Oe.w,Oe.y+Oe.h,n,je,et.x,et.y,Ne,gt),m){const{x:Ze,y:Dt,z:Qt}=m.anchor,[Bt,er,Zt]=m.up;Uf(X,Ze,Dt,Qt,Bt,er,Zt),Uf(X,Ze,Dt,Qt,Bt,er,Zt),Uf(X,Ze,Dt,Qt,Bt,er,Zt),Uf(X,Ze,Dt,Qt,Bt,er,Zt),Vf(e.dynamicLayoutVertexArray,Ze,Dt,Qt,ce)}else Vf(e.dynamicLayoutVertexArray,_.x,_.y,_.z,ce);if(O){const Ze=Me||Oe;Nf(e.iconTransitioningVertexArray,Ze.x,Ze.y),Nf(e.iconTransitioningVertexArray,Ze.x+Ze.w,Ze.y),Nf(e.iconTransitioningVertexArray,Ze.x,Ze.y+Ze.h),Nf(e.iconTransitioningVertexArray,Ze.x+Ze.w,Ze.y+Ze.h)}F.emplaceBack(Mt,Mt+1,Mt+2),F.emplaceBack(Mt+1,Mt+2,Mt+3),H.vertexLength+=4,H.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(ht[0]),Te!==r.length-1&&kt===r[Te+1].sectionIndex||e.programConfigurations.populatePaintArrays($.length,h,h.index,{},C,P,D,pe&&pe[kt])}const ye=m?m.anchor:_;e.placedSymbolArray.emplaceBack(ye.x,ye.y,ye.z,_.x,_.y,ne,this.glyphOffsetArray.length-ne,re,x,b,_.segment,n?n[0]:0,n?n[1]:0,a[0],a[1],f,0,!1,0,T,0)}_commitLayoutVertex(e,r,n,a,l,h,f){e.emplaceBack(r,n,a,l,h,Math.round(f.x),Math.round(f.y))}_addCollisionDebugVertices(e,r,n,a,l,h,f){const m=n.segments.prepareSegment(4,n.layoutVertexArray,n.indexArray),_=m.vertexLength,x=f.tileAnchorX,b=f.tileAnchorY;for(let C=0;C<4;C++)n.collisionVertexArray.emplaceBack(0,0,0,0);this._commitDebugCollisionVertexUpdate(n.collisionVertexArrayExt,r,e.padding,f.zOffset),this._commitLayoutVertex(n.layoutVertexArray,a,l,h,x,b,new Ge(e.x1,e.y1)),this._commitLayoutVertex(n.layoutVertexArray,a,l,h,x,b,new Ge(e.x2,e.y1)),this._commitLayoutVertex(n.layoutVertexArray,a,l,h,x,b,new Ge(e.x2,e.y2)),this._commitLayoutVertex(n.layoutVertexArray,a,l,h,x,b,new Ge(e.x1,e.y2)),m.vertexLength+=4;const T=n.indexArray;T.emplaceBack(_,_+1),T.emplaceBack(_+1,_+2),T.emplaceBack(_+2,_+3),T.emplaceBack(_+3,_),m.primitiveLength+=4}_addTextDebugCollisionBoxes(e,r,n,a,l,h){for(let f=a;f<l;f++){const m=n.get(f),_=this.getSymbolInstanceTextSize(e,h,r,f);this._addCollisionDebugVertices(m,_,this.textCollisionBox,m.projectedAnchorX,m.projectedAnchorY,m.projectedAnchorZ,h)}}_addIconDebugCollisionBoxes(e,r,n,a,l,h){for(let f=a;f<l;f++){const m=n.get(f),_=this.getSymbolInstanceIconSize(e,r,h.placedIconSymbolIndex);this._addCollisionDebugVertices(m,_,this.iconCollisionBox,m.projectedAnchorX,m.projectedAnchorY,m.projectedAnchorZ,h)}}generateCollisionDebugBuffers(e,r){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Jm(al,By.members,io),this.iconCollisionBox=new Jm(al,By.members,io);const n=Tc(this.iconSizeData,e),a=Tc(this.textSizeData,e);for(let l=0;l<this.symbolInstances.length;l++){const h=this.symbolInstances.get(l);this._addTextDebugCollisionBoxes(a,e,r,h.textBoxStartIndex,h.textBoxEndIndex,h),this._addTextDebugCollisionBoxes(a,e,r,h.verticalTextBoxStartIndex,h.verticalTextBoxEndIndex,h),this._addIconDebugCollisionBoxes(n,e,r,h.iconBoxStartIndex,h.iconBoxEndIndex,h),this._addIconDebugCollisionBoxes(n,e,r,h.verticalIconBoxStartIndex,h.verticalIconBoxEndIndex,h)}}getSymbolInstanceTextSize(e,r,n,a){const l=this.text.placedSymbolArray.get(r.rightJustifiedTextSymbolIndex>=0?r.rightJustifiedTextSymbolIndex:r.centerJustifiedTextSymbolIndex>=0?r.centerJustifiedTextSymbolIndex:r.leftJustifiedTextSymbolIndex>=0?r.leftJustifiedTextSymbolIndex:r.verticalPlacedTextSymbolIndex>=0?r.verticalPlacedTextSymbolIndex:a),h=Af(this.textSizeData,e,l)/$i;return this.tilePixelRatio*h}getSymbolInstanceIconSize(e,r,n){const a=this.icon.placedSymbolArray.get(n),l=Af(this.iconSizeData,e,a);return this.tilePixelRatio*l}_commitDebugCollisionVertexUpdate(e,r,n,a){e.emplaceBack(r,-n,-n,a),e.emplaceBack(r,n,-n,a),e.emplaceBack(r,n,n,a),e.emplaceBack(r,-n,n,a)}_updateTextDebugCollisionBoxes(e,r,n,a,l,h){for(let f=a;f<l;f++){const m=n.get(f),_=this.getSymbolInstanceTextSize(e,h,r,f);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,_,m.padding,h.zOffset)}}_updateIconDebugCollisionBoxes(e,r,n,a,l,h){for(let f=a;f<l;f++){const m=n.get(f),_=this.getSymbolInstanceIconSize(e,r,h.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,_,m.padding,h.zOffset)}}updateCollisionDebugBuffers(e,r){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const n=Tc(this.iconSizeData,e),a=Tc(this.textSizeData,e);for(let l=0;l<this.symbolInstances.length;l++){const h=this.symbolInstances.get(l);this._updateTextDebugCollisionBoxes(a,e,r,h.textBoxStartIndex,h.textBoxEndIndex,h),this._updateTextDebugCollisionBoxes(a,e,r,h.verticalTextBoxStartIndex,h.verticalTextBoxEndIndex,h),this._updateIconDebugCollisionBoxes(n,e,r,h.iconBoxStartIndex,h.iconBoxEndIndex,h),this._updateIconDebugCollisionBoxes(n,e,r,h.verticalIconBoxStartIndex,h.verticalIconBoxEndIndex,h)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,r,n,a,l,h,f,m,_){const x={};if(r<n){const{x1:b,y1:T,x2:C,y2:P,padding:D,projectedAnchorX:O,projectedAnchorY:F,projectedAnchorZ:$,tileAnchorX:X,tileAnchorY:H,featureIndex:ne}=e.get(r);x.textBox={x1:b,y1:T,x2:C,y2:P,padding:D,projectedAnchorX:O,projectedAnchorY:F,projectedAnchorZ:$,tileAnchorX:X,tileAnchorY:H},x.textFeatureIndex=ne}if(a<l){const{x1:b,y1:T,x2:C,y2:P,padding:D,projectedAnchorX:O,projectedAnchorY:F,projectedAnchorZ:$,tileAnchorX:X,tileAnchorY:H,featureIndex:ne}=e.get(a);x.verticalTextBox={x1:b,y1:T,x2:C,y2:P,padding:D,projectedAnchorX:O,projectedAnchorY:F,projectedAnchorZ:$,tileAnchorX:X,tileAnchorY:H},x.verticalTextFeatureIndex=ne}if(h<f){const{x1:b,y1:T,x2:C,y2:P,padding:D,projectedAnchorX:O,projectedAnchorY:F,projectedAnchorZ:$,tileAnchorX:X,tileAnchorY:H,featureIndex:ne}=e.get(h);x.iconBox={x1:b,y1:T,x2:C,y2:P,padding:D,projectedAnchorX:O,projectedAnchorY:F,projectedAnchorZ:$,tileAnchorX:X,tileAnchorY:H},x.iconFeatureIndex=ne}if(m<_){const{x1:b,y1:T,x2:C,y2:P,padding:D,projectedAnchorX:O,projectedAnchorY:F,projectedAnchorZ:$,tileAnchorX:X,tileAnchorY:H,featureIndex:ne}=e.get(m);x.verticalIconBox={x1:b,y1:T,x2:C,y2:P,padding:D,projectedAnchorX:O,projectedAnchorY:F,projectedAnchorZ:$,tileAnchorX:X,tileAnchorY:H},x.verticalIconFeatureIndex=ne}return x}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let r=0;r<this.symbolInstances.length;r++){const n=this.symbolInstances.get(r);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,n.textBoxStartIndex,n.textBoxEndIndex,n.verticalTextBoxStartIndex,n.verticalTextBoxEndIndex,n.iconBoxStartIndex,n.iconBoxEndIndex,n.verticalIconBoxStartIndex,n.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(e,r){const n=e.placedSymbolArray.get(r),a=n.vertexStartIndex+4*n.numGlyphs;for(let l=n.vertexStartIndex;l<a;l+=4)e.indexArray.emplaceBack(l,l+1,l+2),e.indexArray.emplaceBack(l+1,l+2,l+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const r=Math.sin(e),n=Math.cos(e),a=[],l=[],h=[];for(let f=0;f<this.symbolInstances.length;++f){h.push(f);const m=this.symbolInstances.get(f);a.push(0|Math.round(r*m.tileAnchorX+n*m.tileAnchorY)),l.push(m.featureIndex)}return h.sort((f,m)=>a[f]-a[m]||l[m]-l[f]),h}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let e=0;e<this.symbolInstances.length;++e)this.symbolInstanceIndexesSortedZOffset.push(e)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((e,r)=>this.symbolInstances.get(r).zOffset-this.symbolInstances.get(e).zOffset)}addToSortKeyRanges(e,r){const n=this.sortKeyRanges[this.sortKeyRanges.length-1];n&&n.sortKey===r?n.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:r,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const r of this.symbolInstanceIndexes){const n=this.symbolInstances.get(r);this.featureSortOrder.push(n.featureIndex);const{rightJustifiedTextSymbolIndex:a,centerJustifiedTextSymbolIndex:l,leftJustifiedTextSymbolIndex:h,verticalPlacedTextSymbolIndex:f,placedIconSymbolIndex:m,verticalPlacedIconSymbolIndex:_}=n;a>=0&&this.addIndicesForPlacedSymbol(this.text,a),l>=0&&l!==a&&this.addIndicesForPlacedSymbol(this.text,l),h>=0&&h!==l&&h!==a&&this.addIndicesForPlacedSymbol(this.text,h),f>=0&&this.addIndicesForPlacedSymbol(this.text,f),m>=0&&this.addIndicesForPlacedSymbol(this.icon,m),_>=0&&this.addIndicesForPlacedSymbol(this.icon,_)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}mt(jf,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),jf.addDynamicAttributes=Vf;const xT=new ti({"symbol-placement":new Je(be.layout_symbol["symbol-placement"]),"symbol-spacing":new Je(be.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Je(be.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Lt(be.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Je(be.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new Je(be.layout_symbol["symbol-z-elevate"]),"icon-allow-overlap":new Je(be.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new Je(be.layout_symbol["icon-ignore-placement"]),"icon-optional":new Je(be.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Je(be.layout_symbol["icon-rotation-alignment"]),"icon-size":new Lt(be.layout_symbol["icon-size"]),"icon-text-fit":new Lt(be.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Lt(be.layout_symbol["icon-text-fit-padding"]),"icon-image":new Lt(be.layout_symbol["icon-image"]),"icon-rotate":new Lt(be.layout_symbol["icon-rotate"]),"icon-padding":new Je(be.layout_symbol["icon-padding"]),"icon-keep-upright":new Je(be.layout_symbol["icon-keep-upright"]),"icon-offset":new Lt(be.layout_symbol["icon-offset"]),"icon-anchor":new Lt(be.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Je(be.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Je(be.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Je(be.layout_symbol["text-rotation-alignment"]),"text-field":new Lt(be.layout_symbol["text-field"]),"text-font":new Lt(be.layout_symbol["text-font"]),"text-size":new Lt(be.layout_symbol["text-size"]),"text-max-width":new Lt(be.layout_symbol["text-max-width"]),"text-line-height":new Lt(be.layout_symbol["text-line-height"]),"text-letter-spacing":new Lt(be.layout_symbol["text-letter-spacing"]),"text-justify":new Lt(be.layout_symbol["text-justify"]),"text-radial-offset":new Lt(be.layout_symbol["text-radial-offset"]),"text-variable-anchor":new Je(be.layout_symbol["text-variable-anchor"]),"text-anchor":new Lt(be.layout_symbol["text-anchor"]),"text-max-angle":new Je(be.layout_symbol["text-max-angle"]),"text-writing-mode":new Je(be.layout_symbol["text-writing-mode"]),"text-rotate":new Lt(be.layout_symbol["text-rotate"]),"text-padding":new Je(be.layout_symbol["text-padding"]),"text-keep-upright":new Je(be.layout_symbol["text-keep-upright"]),"text-transform":new Lt(be.layout_symbol["text-transform"]),"text-offset":new Lt(be.layout_symbol["text-offset"]),"text-allow-overlap":new Je(be.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new Je(be.layout_symbol["text-ignore-placement"]),"text-optional":new Je(be.layout_symbol["text-optional"]),visibility:new Je(be.layout_symbol.visibility)});var Qm={paint:new ti({"icon-opacity":new Lt(be.paint_symbol["icon-opacity"]),"icon-emissive-strength":new Lt(be.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new Lt(be.paint_symbol["text-emissive-strength"]),"icon-color":new Lt(be.paint_symbol["icon-color"]),"icon-halo-color":new Lt(be.paint_symbol["icon-halo-color"]),"icon-halo-width":new Lt(be.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Lt(be.paint_symbol["icon-halo-blur"]),"icon-translate":new Je(be.paint_symbol["icon-translate"]),"icon-translate-anchor":new Je(be.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new Lt(be.paint_symbol["icon-image-cross-fade"]),"text-opacity":new Lt(be.paint_symbol["text-opacity"]),"text-color":new Lt(be.paint_symbol["text-color"],{runtimeType:Cn,getOverride:t=>t.textColor,hasOverride:t=>!!t.textColor}),"text-halo-color":new Lt(be.paint_symbol["text-halo-color"]),"text-halo-width":new Lt(be.paint_symbol["text-halo-width"]),"text-halo-blur":new Lt(be.paint_symbol["text-halo-blur"]),"text-translate":new Je(be.paint_symbol["text-translate"]),"text-translate-anchor":new Je(be.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new Je(be.paint_symbol["icon-color-saturation"])}),layout:xT};class y1{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:js,this.defaultValue=e}evaluate(e){if(e.formattedSection){const r=this.defaultValue.property.overrides;if(r&&r.hasOverride(e.formattedSection))return r.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}mt(y1,"FormatSectionOverride",{omit:["defaultValue"]});class Zf extends ln{constructor(e,r,n){super(e,Qm,r,n)}recalculate(e,r){super.recalculate(e,r),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const n=this.layout.get("text-writing-mode");if(n){const a=[];for(const l of n)a.indexOf(l)<0&&a.push(l);this.layout._values["text-writing-mode"]=a}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getValueAndResolveTokens(e,r,n,a){const l=this.layout.get(e).evaluate(r,{},n,a),h=this._unevaluatedLayout._values[e];return h.isDataDriven()||Wa(h.value)||!l?l:function(f,m){return m.replace(/{([^{}]+)}/g,(_,x)=>x in f?String(f[x]):"")}(r.properties,l)}createBucket(e){return new jf(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const e of Qm.paint.overridableProperties){if(!Zf.hasPaintOverride(this.layout,e))continue;const r=this.paint.get(e),n=new y1(r),a=new ic(n,r.property.specification,this.scope,this.options);let l=null;l=r.value.kind==="constant"||r.value.kind==="source"?new Zu("source",a):new Ha("composite",a,r.value.zoomStops,r.value._interpolationType),this.paint._values[e]=new aa(r.property,l,r.parameters)}}_handleOverridablePaintPropertyUpdate(e,r,n){return!(!this.layout||r.isDataDriven()||n.isDataDriven())&&Zf.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,r){const n=e.get("text-field"),a=Qm.paint.properties[r];let l=!1;const h=f=>{for(const m of f)if(a.overrides&&a.overrides.hasOverride(m))return void(l=!0)};if(n.value.kind==="constant"&&n.value.value instanceof Vi)h(n.value.value.sections);else if(n.value.kind==="source"){const f=_=>{l||(_ instanceof po&&vi(_.value)===Gs?h(_.value.sections):_ instanceof qs?h(_.sections):_.eachChild(f))},m=n.value;m._styleExpression&&f(m._styleExpression.expression)}return l}getProgramIds(){const e=this.paint.get("icon-opacity").constantOr(1)!==0,r=this.paint.get("text-opacity").constantOr(1)!==0,n=[];return e&&n.push("symbolIcon"),r&&n.push("symbolSDF"),n}getDefaultProgramParams(e,r){return{config:new R(this,r),overrideFog:!1}}}const vT=new ti({visibility:new Je(be.layout_background.visibility)});var bT={paint:new ti({"background-color":new Je(be.paint_background["background-color"]),"background-pattern":new Je(be.paint_background["background-pattern"]),"background-opacity":new Je(be.paint_background["background-opacity"]),"background-emissive-strength":new Je(be.paint_background["background-emissive-strength"])}),layout:vT};const wT=new ti({visibility:new Je(be.layout_raster.visibility)});var TT={paint:new ti({"raster-opacity":new Je(be.paint_raster["raster-opacity"]),"raster-color":new Es(be.paint_raster["raster-color"]),"raster-color-mix":new Je(be.paint_raster["raster-color-mix"]),"raster-color-range":new Je(be.paint_raster["raster-color-range"]),"raster-hue-rotate":new Je(be.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Je(be.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Je(be.paint_raster["raster-brightness-max"]),"raster-saturation":new Je(be.paint_raster["raster-saturation"]),"raster-contrast":new Je(be.paint_raster["raster-contrast"]),"raster-resampling":new Je(be.paint_raster["raster-resampling"]),"raster-fade-duration":new Je(be.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new Je(be.paint_raster["raster-emissive-strength"]),"raster-array-band":new Je(be.paint_raster["raster-array-band"]),"raster-elevation":new Je(be.paint_raster["raster-elevation"])}),layout:wT},e_=Dr([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);class t_{constructor(e,r,n,a){this.context=e,this.format=n,this.texture=e.gl.createTexture(),this.update(r,a)}update(e,r,n){const{width:a,height:l}=e,{context:h}=this,{gl:f}=h;if(f.bindTexture(f.TEXTURE_2D,this.texture),h.pixelStoreUnpackFlipY.set(!1),h.pixelStoreUnpack.set(1),h.pixelStoreUnpackPremultiplyAlpha.set(this.format===f.RGBA&&(!r||r.premultiply!==!1)),n||this.size&&this.size[0]===a&&this.size[1]===l){const{x:m,y:_}=n||{x:0,y:0};if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap)f.texSubImage2D(f.TEXTURE_2D,0,m,_,f.RGBA,f.UNSIGNED_BYTE,e);else{let x=this.format,b=f.UNSIGNED_BYTE;this.format===f.R32F&&(x=f.RED,b=f.FLOAT),f.texSubImage2D(f.TEXTURE_2D,0,m,_,a,l,x,b,e.data)}}else if(this.size=[a,l],e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap){let m=this.format;this.format===f.R8&&(m=f.RED),f.texImage2D(f.TEXTURE_2D,0,this.format,m,f.UNSIGNED_BYTE,e)}else{let m=this.format,_=this.format,x=f.UNSIGNED_BYTE;this.format===f.DEPTH_COMPONENT&&(m=f.DEPTH_COMPONENT16,x=f.UNSIGNED_SHORT),this.format===f.R8&&(_=f.RED),this.format===f.R32F&&(x=f.FLOAT,_=f.RED),f.texImage2D(f.TEXTURE_2D,0,m,a,l,0,_,x,e.data)}this.useMipmap=!!(r&&r.useMipmap),this.useMipmap&&f.generateMipmap(f.TEXTURE_2D)}bind(e,r,n=!1){const{context:a}=this,{gl:l}=a;l.bindTexture(l.TEXTURE_2D,this.texture),e!==this.minFilter&&(l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,e),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,this.useMipmap&&!n?e===l.NEAREST?l.NEAREST_MIPMAP_NEAREST:l.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),r!==this.wrapS&&(l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,r),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,r),this.wrapS=r)}bindExtraParam(e,r,n,a){const{context:l}=this,{gl:h}=l;h.bindTexture(h.TEXTURE_2D,this.texture),r!==this.magFilter&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,r),this.magFilter=r),e!==this.minFilter&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,this.useMipmap?e===h.NEAREST?h.NEAREST_MIPMAP_NEAREST:h.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),n!==this.wrapS&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,n),this.wrapS=n),a!==this.wrapT&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,a),this.wrapT=a)}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class Gf{constructor(e,r){this.context=e,this.texture=r}bind(e,r){const{context:n}=this,{gl:a}=n;a.bindTexture(a.TEXTURE_2D,this.texture),e!==this.minFilter&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,e),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,e),this.minFilter=e),r!==this.wrapS&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,r),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,r),this.wrapS=r)}}function $f(t,e,r,n,a,l,h,f){const m=[t,e,1,r,n,1,a,l,1],_=[h,f,1],x=s.co.adjoint([],m),[b,T,C]=s.N.transformMat3(_,_,x);return s.co.multiply(m,m,[b,0,0,0,T,0,0,0,C])}function x1(t,e,r,n,a,l,h,f){const m=function(_,x,b,T,C,P,D,O){const F=$f(0,0,1,0,1,1,0,1),$=$f(_,x,b,T,C,P,D,O),X=s.co.adjoint([],F);return s.co.multiply($,$,X)}(t,e,r,n,a,l,h,f);return[m[2]/m[8]/ct,m[5]/m[8]/ct]}function qf(t){return[t[0],Math.min(Math.max(t[1],-nr),nr)]}class v1 extends Vs{constructor(e,r,n,a){super(),this.id=e,this.dispatcher=n,this.coordinates=r.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(a),this.options=r,this._dirty=!1}load(e,r){if(this._loaded=r||!1,this.fire(new hs("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return e&&(this.coordinates=e),this._loaded=!0,void this._finishLoading();this._imageRequest=at(this.map._requestManager.transformRequest(this.url,nn.Image),(n,a)=>{this._imageRequest=null,this._loaded=!0,n?this.fire(new Wc(n)):a&&(this.image=a instanceof HTMLImageElement?We.getImageData(a):a,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading())})}loaded(){return this._loaded}updateImage(e){return e.url?(this._imageRequest&&e.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=e.url,this.load(e.coordinates,this._loaded),this):this}setTexture(e){if(!(e.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new Gf(this.map.painter.context,e.handle),this.width=e.dimensions[0],this.height=e.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new hs("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof Gf||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(e){if(this.coordinates=e,this._boundsArray=void 0,this._unsupportedCoords=!1,!e.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let r=e[0][1],n=e[0][1];for(const l of e)l[1]>n&&(n=l[1]),l[1]<r&&(r=l[1]);const a=(n+r)/2;if(a>nr?this.onNorthPole=!0:a<-nr&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const l=e.map(gr.fromLngLat);this.tileID=function(h){let f=1/0,m=1/0,_=-1/0,x=-1/0;for(const D of h)f=Math.min(f,D.x),m=Math.min(m,D.y),_=Math.max(_,D.x),x=Math.max(x,D.y);const b=Math.max(_-f,x-m),T=Math.max(0,Math.floor(-Math.log(b)/Math.LN2)),C=Math.pow(2,T);let P=Math.floor((f+_)/2*C);return P>1&&(P-=1),new Ve(T,P,Math.floor((m+x)/2*C))}(l),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new hs("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(e){for(const F in this.tiles){const $=this.tiles[F];$.state!=="loaded"&&($.state="loaded",$.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const r=zh(new Ve(0,0,0),this.map.transform.projection),n=[r.projection.project(this.coordinates[0][0],this.coordinates[0][1]),r.projection.project(this.coordinates[1][0],this.coordinates[1][1]),r.projection.project(this.coordinates[2][0],this.coordinates[2][1]),r.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(F){const $=F[1].x-F[0].x,X=F[1].y-F[0].y,H=F[2].x-F[1].x,ne=F[2].y-F[1].y,re=F[3].x-F[2].x,ce=F[3].y-F[2].y,pe=F[0].x-F[3].x,ye=F[0].y-F[3].y,Te=$*ne-H*X,xe=H*ce-re*ne,Se=re*ye-pe*ce,Be=pe*X-$*ye;return Te>0&&xe>0&&Se>0&&Be>0||Te<0&&xe<0&&Se<0&&Be<0}(n))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const a=zh(this.tileID,this.map.transform.projection),[l,h,f,m]=this.coordinates.map(F=>{const $=a.projection.project(F[0],F[1]);return d1(a,$)._round()});this.perspectiveTransform=x1(l.x,l.y,h.x,h.y,f.x,f.y,m.x,m.y);const _=this._boundsArray=new vo;_.emplaceBack(l.x,l.y,0,0),_.emplaceBack(h.x,h.y,ct,0),_.emplaceBack(m.x,m.y,0,ct),_.emplaceBack(f.x,f.y,ct,ct),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=e.createVertexBuffer(_,e_.members),this.boundsSegments=ci.simpleSegment(0,0,4,2);const x=[],b=[qf((T=this.coordinates)[0]),qf(T[1]),qf(T[2]),qf(T[3])];var T;const[C,P,D,O]=function(F){let $=F[0][0],X=$,H=F[0][1],ne=H;for(let re=1;re<F.length;re++)F[re][0]<$?$=F[re][0]:F[re][0]>X&&(X=F[re][0]),F[re][1]<H?H=F[re][1]:F[re][1]>ne&&(ne=F[re][1]);return[$,H,X-$,ne-H]}(b);{const F=new vo,[$,X,H,ne]=function(Re){let et=Re[0].x,Ne=et,gt=Re[0].y,ht=gt;for(let je=1;je<Re.length;je++)Re[je].x<et?et=Re[je].x:Re[je].x>Ne&&(Ne=Re[je].x),Re[je].y<gt?gt=Re[je].y:Re[je].y>ht&&(ht=Re[je].y);return[et,gt,Ne-et,ht-gt]}(n),re=Re=>[(Re.x-$)/H,(Re.y-X)/ne],[ce,pe,ye,Te]=n.map(re),xe=function(Re,et,Ne,gt,ht,je,kt,Mt){const _t=$f(0,0,1,0,1,1,0,1),Ze=$f(Re,et,Ne,gt,ht,je,kt,Mt),Dt=s.co.adjoint([],Ze);return s.co.multiply(_t,_t,Dt)}(ce[0],ce[1],pe[0],pe[1],ye[0],ye[1],Te[0],Te[1]);this.elevatedGlobePerspectiveTransform=x1(ce[0],ce[1],pe[0],pe[1],ye[0],ye[1],Te[0],Te[1]);const Se=(Re,et)=>{x.push(Re.lng);const Ne=Math.round((Re.lng-C)/D*ct),gt=Math.round((Re.lat-P)/O*ct),ht=re(et),je=s.N.transformMat3([],[ht[0],ht[1],1],xe),kt=Math.round(je[0]/je[2]*ct),Mt=Math.round(je[1]/je[2]*ct);F.emplaceBack(Ne,gt,kt,Mt)},Be=n[3].x-n[0].x,Ce=n[3].y-n[0].y,Oe=n[2].x-n[1].x,Me=n[2].y-n[1].y;for(let Re=0;Re<65;Re++){const et=Re/64,Ne=[n[0].x+et*Be,n[0].y+et*Ce],gt=[n[1].x+et*Oe,n[1].y+et*Me],ht=gt[0]-Ne[0],je=gt[1]-Ne[1];for(let kt=0;kt<65;kt++){const Mt=kt/64,_t={x:Ne[0]+ht*Mt,y:Ne[1]+je*Mt,z:0};Se(r.projection.unproject(_t.x,_t.y),_t)}}this.elevatedGlobeVertexBuffer=e.createVertexBuffer(F,e_.members)}{this.maxLongitudeTriangleSize=0;let F=[],$=new Si;const X=(H,ne,re)=>{$.emplaceBack(H,ne,re);const ce=x[H],pe=x[ne],ye=x[re],Te=Math.min(Math.min(ce,pe),ye),xe=Math.max(Math.max(ce,pe),ye)-Te;xe>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=xe),F.push(Te+xe/2)};for(let H=0;H<64;H++)for(let ne=0;ne<64;ne++){const re=65*H+ne,ce=re+1,pe=re+65,ye=pe+1;X(re,pe,ce),X(ce,pe,ye)}[F,$]=function(H,ne){const re=Array.from({length:H.length},(ye,Te)=>Te);re.sort((ye,Te)=>H[ye]-H[Te]);const ce=[],pe=new Si;for(let ye=0;ye<re.length;ye++){const Te=re[ye];ce.push(H[Te]);const xe=3*Te,Se=xe+1;pe.emplaceBack(ne.uint16[xe],ne.uint16[Se],ne.uint16[Se+1])}return[ce,pe]}(F,$),this.elevatedGlobeTrianglesCenterLongitudes=F,this.elevatedGlobeIndexBuffer=e.createIndexBuffer($)}this.elevatedGlobeSegments=ci.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,D/ct,0,O/ct,0,0,P,C,0])}prepare(){const e=Object.keys(this.tiles).length!==0;if(this.tileID&&!e)return;const r=this.map.painter.context,n=r.gl;!this._dirty||this.texture instanceof Gf||(this.texture?this.texture.update(this.image):(this.texture=new t_(r,this.image,n.RGBA),this.texture.bind(n.LINEAR,n.CLAMP_TO_EDGE)),this._dirty=!1),e&&this._prepareData(r)}loadTile(e,r){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},r(null)):(e.state="errored",r(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(e){const r=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!r)return null;const n=this.elevatedGlobeTrianglesCenterLongitudes;let a=((x,b)=>x+360*Math.round((b-x)/360))(e+180,n[0]);const l=new ci,h=(x,b)=>{l.segments.push({vertexOffset:0,primitiveOffset:x,vertexLength:r.segments[0].vertexLength,primitiveLength:b,sortKey:void 0,vaos:{}})},f=.51*this.maxLongitudeTriangleSize;if(Math.abs(n[0]-a)<=f){const x=Le(n,0,n.length,a+f);return x===n.length||h(x,de(n,x+1,n.length,a+360-f)-x),l}a<n[0]&&(a+=360);const m=de(n,0,n.length,a-f);if(m===n.length)return h(0,n.length),l;h(0,m-0);const _=Le(n,m+1,n.length,a+f);return _!==n.length&&h(_,n.length-_),l}}const ET=(Math.pow(256,2)-1)/16907520;class b1 extends ln{constructor(e,r,n){super(e,TT,r,n),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isLayerDraped(e){return!(e&&e._source instanceof v1&&(e._source.onNorthPole||e._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(e){e!=="raster-color"&&e!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}updateColorRamp(e){if(!this.hasColorMap()||!this._curRampRange)return;const r=this._transitionablePaint._values["raster-color"].value.expression,[n,a]=e||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(n)&&isNaN(a)||n===this._curRampRange[0]&&a===this._curRampRange[1]||(this.colorRamp=wh({expression:r,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:n,end:a}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[n,a])}}const MT=new ti({visibility:new Je(be["layout_raster-particle"].visibility)});var IT={paint:new ti({"raster-particle-array-band":new Je(be["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new Je(be["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new Es(be["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new Je(be["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new Je(be["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new Je(be["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new Je(be["paint_raster-particle"]["raster-particle-reset-rate-factor"])}),layout:MT};class w1 extends ln{constructor(e,r,n){super(e,IT,r,n),this._updateColorRamp(),this.onRemove=a=>{this.colorRampTexture&&this.colorRampTexture.destroy(),this.transformFeedbackObject&&a.painter.context.gl.deleteTransformFeedback(this.transformFeedbackObject),this.tileFramebuffer&&this.tileFramebuffer.destroy()},this.lastInvalidatedAt=We.now()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isLayerDraped(e){return!1}_handleSpecialPaintPropertyUpdate(e){e!=="raster-particle-color"&&e!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),e==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const e=this._transitionablePaint._values["raster-particle-color"].value.expression,r=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=wh({expression:e,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:r}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=We.now()}}class CT extends ln{constructor(e,r){super(e,{},r),this.implementation=e,e.slot&&(this.slot=e.slot)}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isLayerDraped(e){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}const AT=new ti({visibility:new Je(be.layout_sky.visibility)});var ST={paint:new ti({"sky-type":new Je(be.paint_sky["sky-type"]),"sky-atmosphere-sun":new Je(be.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new Je(be.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new Je(be.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new Je(be.paint_sky["sky-gradient-radius"]),"sky-gradient":new Es(be.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new Je(be.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new Je(be.paint_sky["sky-atmosphere-color"]),"sky-opacity":new Je(be.paint_sky["sky-opacity"])}),layout:AT};function r_(t,e,r){const n=[0,0,1],a=s.bi.identity([]);return s.bi.rotateY(a,a,r?-St(t)+Math.PI:St(t)),s.bi.rotateX(a,a,-St(e)),s.N.transformQuat(n,n,a),s.N.normalize(n,n)}var PT={paint:new ti({})};function T1(t,e){const r=Wf(t.projection,t.zoom,t.width,t.height),n=function(l,h,f,m,_){const x=new ge(f.lng-180*va,f.lat),b=new ge(f.lng+180*va,f.lat),T=l.project(x.lng,x.lat),C=l.project(b.lng,b.lat),P=-Math.atan2(C.y-T.y,C.x-T.x),D=gr.fromLngLat(f);D.y=Ut(D.y,-1+va,1-va);const O=D.toLngLat(),F=l.project(O.lng,O.lat),$=gr.fromLngLat(O);$.x+=va;const X=$.toLngLat(),H=l.project(X.lng,X.lat),ne=I1(H.x-F.x,H.y-F.y,P),re=gr.fromLngLat(O);re.y+=va;const ce=re.toLngLat(),pe=l.project(ce.lng,ce.lat),ye=I1(pe.x-F.x,pe.y-F.y,P),Te=Math.abs(ne.x)/Math.abs(ye.y),xe=s.a6.identity([]);s.a6.rotateZ(xe,xe,-P*(1-(_?0:m)));const Se=s.a6.identity([]);return s.a6.scale(Se,Se,[1,1-(1-Te)*m,1]),Se[4]=-ye.x/ye.y*m,s.a6.rotateZ(Se,Se,P),s.a6.multiply(Se,xe,Se),Se}(t.projection,0,t.center,r,e),a=E1(t);return s.a6.scale(n,n,[a,a,1]),n}function E1(t){const e=t.projection,r=Wf(t.projection,t.zoom,t.width,t.height),n=M1(e,t.center),a=M1(e,ge.convert(e.center));return Math.pow(2,n*r+(1-r)*a)}function Wf(t,e,r,n,a=1/0){const l=t.range;if(!l)return 0;const h=Math.min(a,Math.max(r,n)),f=Math.log(h/1024)/Math.LN2;return Ei(l[0]+f,l[1]+f,e)}const va=1/4e4;function M1(t,e){const r=Ut(e.lat,-nr,nr),n=new ge(e.lng-180*va,r),a=new ge(e.lng+180*va,r),l=t.project(n.lng,r),h=t.project(a.lng,r),f=gr.fromLngLat(n),m=gr.fromLngLat(a),_=h.x-l.x,x=h.y-l.y,b=m.x-f.x,T=m.y-f.y,C=Math.sqrt((b*b+T*T)/(_*_+x*x));return Math.log(C)/Math.LN2}function I1(t,e,r){const n=Math.cos(r),a=Math.sin(r);return{x:t*n-e*a,y:t*a+e*n}}function C1(t,e,r){s.a6.identity(t),s.a6.rotateZ(t,t,St(e[2])),s.a6.rotateX(t,t,St(e[0])),s.a6.rotateY(t,t,St(e[1])),s.a6.scale(t,t,r),s.a6.multiply(t,t,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function Hf(t,e,r,n,a,l,h,f){const m=[r[0]-e[0],r[1]-e[1],0],_=[n[0]-e[0],n[1]-e[1],0];if(s.N.length(m)<1e-12||s.N.length(_)<1e-12)return s.bi.identity(t);const x=s.N.cross([],m,_);s.N.normalize(x,x),s.N.subtract(_,n,e),m[2]=(l-a)*f,_[2]=(h-a)*f;const b=m;return s.N.cross(b,m,_),s.N.normalize(b,b),s.bi.rotationTo(t,x,b)}function i_(t,e,r=!1){const n=fa(e.zoom),a=function(l,h,f){const m=h.worldSize,_=[l[12],l[13],l[14]],x=fr(_[1]/m),b=$t(_[0]/m),T=s.a6.identity([]),C=qt(1,x)*m,P=qt(1,0)*m*or(x,h.zoom),D=1/Cm(m);let O=P*D;if(f){const H=Wf(h.projection,h.zoom,h.width,h.height,1024);O=D*h.projection.pixelSpaceConversion(h.center.lat,m,H)}const F=Ae(x,b);s.N.add(F,F,s.N.scale([],s.N.normalize([],F),C*O*_[2]));const $=function(H){const ne=[H[0],H[1],H[2]];let re=[0,1,0];const ce=s.N.cross([],re,ne);return s.N.cross(re,ne,ce),s.N.squaredLength(re)===0&&(re=[0,1,0],s.N.cross(ce,ne,re)),s.N.normalize(ce,ce),s.N.normalize(re,re),s.N.normalize(ne,ne),[ce[0],ce[1],ce[2],0,re[0],re[1],re[2],0,ne[0],ne[1],ne[2],0,H[0],H[1],H[2],1]}(F);s.a6.scale(T,T,[O,O,O*C]),s.a6.translate(T,T,[-_[0],-_[1],-_[2]]);const X=s.a6.multiply([],h.globeMatrix,$);return s.a6.multiply(X,X,T),s.a6.multiply(X,X,l),X}(t,e,r);if(n>0){const l=function(h,f){const m=f.worldSize,_=qt(1,0)*m*or(f.center.lat,f.zoom)/Cm(m),x=qt(1,f.center.lat)*m,b=s.a6.identity([]);return s.a6.rotateY(b,b,St(f.center.lng)),s.a6.rotateX(b,b,St(f.center.lat)),s.a6.translate(b,b,[0,0,q]),s.a6.scale(b,b,[_,_,_*x]),s.a6.translate(b,b,[f.point.x-.5*m,f.point.y-.5*m,0]),s.a6.multiply(b,b,h),s.a6.multiply(b,f.globeMatrix,b)}(t,e);return function(h,f,m){const _=(P,D,O)=>{const F=s.N.length(P),$=s.N.length(D),X=Ls(P,D,O);return s.N.scale(X,X,1/s.N.length(X)*ur(F,$,O))},x=_([h[0],h[1],h[2]],[f[0],f[1],f[2]],m),b=_([h[4],h[5],h[6]],[f[4],f[5],f[6]],m),T=_([h[8],h[9],h[10]],[f[8],f[9],f[10]],m),C=Ls([h[12],h[13],h[14]],[f[12],f[13],f[14]],m);return[x[0],x[1],x[2],0,b[0],b[1],b[2],0,T[0],T[1],T[2],0,C[0],C[1],C[2],1]}(a,l,n)}return a}function A1(t,e,r,n){const a=ai.projectAabbCorners(n,r);let l=Number.MAX_VALUE,h=-1;for(let _=0;_<a.length;++_){const x=a[_];x[0]=(.5*x[0]+.5)*e.width,x[1]=(.5-.5*x[1])*e.height,x[2]<l&&(h=_,l=x[2])}const f=_=>new Ge(a[_][0],a[_][1]);let m;switch(h){case 0:case 6:m=[f(1),f(5),f(4),f(7),f(3),f(2),f(1)];break;case 1:case 7:m=[f(0),f(4),f(5),f(6),f(2),f(3),f(0)];break;case 3:case 5:m=[f(1),f(0),f(4),f(7),f(6),f(2),f(1)];break;default:m=[f(1),f(5),f(6),f(7),f(3),f(0),f(1)]}if(oo(t,m))return l}const LT=Dr([{name:"a_pos_3f",components:3,type:"Float32"}]),DT=Dr([{name:"a_color_3f",components:3,type:"Float32"}]),zT=Dr([{name:"a_color_4f",components:4,type:"Float32"}]),RT=Dr([{name:"a_uv_2f",components:2,type:"Float32"}]),OT=Dr([{name:"a_normal_3f",components:3,type:"Float32"}]),kT=Dr([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),BT=Dr([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);class S1{constructor(e,r){this.feature=e,this.instancedDataOffset=r,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class P1{constructor(){this.instancedDataArray=new fh,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class n_{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.fqid),this.projection=e.projection,this.index=e.index,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0}}populate(e,r,n,a){this.tileToMeter=sr(n);const l=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:h,id:f,index:m,sourceLayerIndex:_}of e){const x=wi(h,l);if(!this.layers[0]._featureFilter.filter(new ei(this.zoom),x,n))continue;const b={id:f,sourceLayerIndex:_,index:m,geometry:l?x.geometry:Li(h,n,a),properties:h.properties,type:h.type,patterns:{}},T=this.addFeature(b,b.geometry,x);T&&r.featureIndex.insert(h,b.geometry,m,_,this.index,this.instancesPerModel[T].instancedDataArray.length,ct/32)}this.lookup=null}update(e,r,n,a){for(const l in this.instancesPerModel){const h=this.instancesPerModel[l];for(const f in e)h.idToFeaturesIndex.hasOwnProperty(f)&&this.evaluate(h.features[h.idToFeaturesIndex[f]],e[f],h,!0)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let e=!1;for(const r in this.instancesPerModel){const n=this.instancesPerModel[r];for(const a of n.features){const l=this.layers[0],h=a.feature,f=this.canonical,m=l.paint.get("model-rotation").evaluate(h,{},f),_=l.paint.get("model-scale").evaluate(h,{},f),x=l.paint.get("model-translation").evaluate(h,{},f);s.N.exactEquals(a.rotation,m)&&s.N.exactEquals(a.scale,_)&&s.N.exactEquals(a.translation,x)||(this.evaluate(a,a.featureStates,n,!0),e=!0)}}return e}isEmpty(){for(const e in this.instancesPerModel)if(this.instancesPerModel[e].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(e){if(!this.uploaded)for(const r in this.instancesPerModel){const n=this.instancesPerModel[r];n.instancedDataArray.length<0||n.instancedDataArray.length===0||(n.instancedDataBuffer?n.instancedDataBuffer.updateData(n.instancedDataArray):n.instancedDataBuffer=e.createVertexBuffer(n.instancedDataArray,kT.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const e in this.instancesPerModel){const r=this.instancesPerModel[e];r.instancedDataArray.length!==0&&r.instancedDataBuffer&&r.instancedDataBuffer.destroy()}}addFeature(e,r,n){const a=this.layers[0],l=a.layout.get("model-id").evaluate(n,{},this.canonical);if(!l)return li(`modelId is not evaluated for layer ${a.id} and it is not going to get rendered.`),l;this.instancesPerModel[l]||(this.instancesPerModel[l]=new P1);const h=this.instancesPerModel[l],f=h.instancedDataArray,m=new S1(n,f.length);for(const _ of r)for(const x of _){if(x.x<0||x.x>=ct||x.y<0||x.y>=ct)continue;const b=(this.lookupDim-1)/ct,T=this.lookupDim*(x.y*b|0)+x.x*b|0;if(this.lookup){if(this.lookup[T]!==0)continue;this.lookup[T]=1}this.instanceCount++;const C=f.length;f.resize(C+1),h.instancesEvaluatedElevation.push(0),f.float32[16*C]=x.x,f.float32[16*C+1]=x.y}return m.instancedDataCount=h.instancedDataArray.length-m.instancedDataOffset,m.instancedDataCount>0&&(e.id&&(h.idToFeaturesIndex[e.id]=h.features.length),h.features.push(m),this.evaluate(m,{},h,!1)),l}evaluate(e,r,n,a){const l=this.layers[0],h=e.feature,f=this.canonical,m=e.rotation=l.paint.get("model-rotation").evaluate(h,r,f),_=e.scale=l.paint.get("model-scale").evaluate(h,r,f),x=e.translation=l.paint.get("model-translation").evaluate(h,r,f),b=l.paint.get("model-color").evaluate(h,r,f);b.a=l.paint.get("model-color-mix-intensity").evaluate(h,r,f);const T=[];this.maxVerticalOffset<x[2]&&(this.maxVerticalOffset=x[2]),this.maxScale=Math.max(Math.max(this.maxScale,_[0]),Math.max(_[1],_[2])),C1(T,m,_);const C=Math.round(100*b.a)+b.b/1.05;for(let P=0;P<e.instancedDataCount;++P){const D=e.instancedDataOffset+P,O=16*D,F=n.instancedDataArray.float32;let $=0;a&&($=F[O+6]-n.instancesEvaluatedElevation[D]);const X=0|F[O+1];F[O]=(0|F[O])+b.r/1.05,F[O+1]=X+b.g/1.05,F[O+2]=C,F[O+3]=1/(f.z>10?this.tileToMeter:sr(f,X)),F[O+4]=x[0],F[O+5]=x[1],F[O+6]=x[2]+$,F[O+7]=T[0],F[O+8]=T[1],F[O+9]=T[2],F[O+10]=T[4],F[O+11]=T[5],F[O+12]=T[6],F[O+13]=T[8],F[O+14]=T[9],F[O+15]=T[10],n.instancesEvaluatedElevation[D]=x[2]}}}mt(n_,"ModelBucket",{omit:["layers"]}),mt(P1,"PerModelAttributes"),mt(S1,"ModelFeature");const FT=new ti({visibility:new Je(be.layout_model.visibility),"model-id":new Lt(be.layout_model["model-id"])});var NT={paint:new ti({"model-opacity":new Je(be.paint_model["model-opacity"]),"model-rotation":new Lt(be.paint_model["model-rotation"]),"model-scale":new Lt(be.paint_model["model-scale"]),"model-translation":new Lt(be.paint_model["model-translation"]),"model-color":new Lt(be.paint_model["model-color"]),"model-color-mix-intensity":new Lt(be.paint_model["model-color-mix-intensity"]),"model-type":new Je(be.paint_model["model-type"]),"model-cast-shadows":new Je(be.paint_model["model-cast-shadows"]),"model-receive-shadows":new Je(be.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new Je(be.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new Lt(be.paint_model["model-emissive-strength"]),"model-roughness":new Lt(be.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new Lt(be.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new Je(be.paint_model["model-cutoff-fade-range"])}),layout:FT};const wl=64,Lc={CoordinateSpaceTile:1,CoordinateSpaceYUp:2,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function L1(t,e,r,n,a,l,h,f,m,_=!1){const x=r.zoom,b=r.project(n),T=or(n.lat,x),C=1/T;s.a6.identity(t),s.a6.translate(t,t,[b.x+h[0]*C,b.y+h[1]*C,h[2]]);let P=1,D=1;const O=r.worldSize;if(_){if(r.projection.name==="mercator"){let H=0;r.elevation&&(H=r.elevation.getAtPointOrZero(new gr(b.x/O,b.y/O),0));const ne=s.a7.transformMat4([],[b.x,b.y,H,1],r.projMatrix)[3]/r.cameraToCenterDistance;P=ne,D=ne*or(r.center.lat,x)}else if(r.projection.name==="globe"){const H=i_(t,r),ne=s.a6.multiply([],r.projMatrix,H),re=[0,0,0,1];s.a7.transformMat4(re,re,ne);const ce=re[3]/r.cameraToCenterDistance,pe=fa(x),ye=r.projection.pixelsPerMeter(n.lat,O)*or(n.lat,x),Te=r.projection.pixelsPerMeter(r.center.lat,O)*or(r.center.lat,x);P=ce/ur(ye,ri(r.center.lat),pe),D=ce*T/ye,P*=Te,D*=Te}}else P=C;s.a6.scale(t,t,[P,P,D]);const F=[...t],$=e.orientation,X=[];if(C1(X,[$[0]+a[0],$[1]+a[1],$[2]+a[2]],l),s.a6.multiply(t,F,X),f&&r.elevation){let H=0;const ne=[];if(m&&r.elevation){H=function(pe,ye,Te,xe,Se){const Be=ye.elevation;if(!Be)return 0;const Ce=ai.projectAabbCorners(Te,xe),Oe=qt(1,Se.lat)*ye.worldSize,Me=function(Dt,Qt){const Bt=[0,0,1],er=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const Zt of er){const hr=Dt[Zt.corners[0]],Wt=Dt[Zt.corners[1]],Ur=Dt[Zt.corners[2]],xr=[Wt[0]-hr[0],Wt[1]-hr[1],Qt*(Wt[2]-hr[2])],br=s.N.cross(xr,xr,[Ur[0]-hr[0],Ur[1]-hr[1],Qt*(Ur[2]-hr[2])]);s.N.normalize(br,br),Zt.dotProductWithUp=s.N.dot(br,Bt)}return er.sort((Zt,hr)=>Zt.dotProductWithUp-hr.dotProductWithUp),er[0].corners}(Ce,Oe),Re=Ce[Me[0]],et=Ce[Me[1]],Ne=Ce[Me[2]],gt=Ce[Me[3]],ht=Be.getAtPointOrZero(new gr(Re[0]/ye.worldSize,Re[1]/ye.worldSize),0),je=Be.getAtPointOrZero(new gr(et[0]/ye.worldSize,et[1]/ye.worldSize),0),kt=Be.getAtPointOrZero(new gr(Ne[0]/ye.worldSize,Ne[1]/ye.worldSize),0),Mt=Be.getAtPointOrZero(new gr(gt[0]/ye.worldSize,gt[1]/ye.worldSize),0),_t=(ht+Mt)/2,Ze=(je+kt)/2;return _t>Ze?je<kt?Hf(pe,et,gt,Re,je,Mt,ht,Oe):Hf(pe,Ne,Re,gt,kt,ht,Mt,Oe):ht<Mt?Hf(pe,Re,et,Ne,ht,je,kt,Oe):Hf(pe,gt,Ne,et,Mt,kt,je,Oe),Math.max(_t,Ze)}(ne,r,e.aabb,t,n);const re=s.a6.fromQuat([],ne),ce=s.a6.multiply([],re,X);s.a6.multiply(t,F,ce)}else H=r.elevation.getAtPointOrZero(new gr(b.x/O,b.y/O),0);H!==0&&(t[14]+=H)}}function Fh(t,e,r=!1){t.uploaded||(t.gfxTexture=new t_(e,t.image,r?e.gl.R8:e.gl.RGBA,{useMipmap:t.sampler.minFilter>=e.gl.NEAREST_MIPMAP_NEAREST}),t.uploaded=!0,t.image=null)}function UT(t,e,r){t.indexBuffer=e.createIndexBuffer(t.indexArray,!1,!0),t.vertexBuffer=e.createVertexBuffer(t.vertexArray,LT.members,!1,!0),t.normalArray&&(t.normalBuffer=e.createVertexBuffer(t.normalArray,OT.members,!1,!0)),t.texcoordArray&&(t.texcoordBuffer=e.createVertexBuffer(t.texcoordArray,RT.members,!1,!0)),t.colorArray&&(t.colorBuffer=e.createVertexBuffer(t.colorArray,(t.colorArray.bytesPerElement===12?DT:zT).members,!1,!0)),t.featureArray&&(t.pbrBuffer=e.createVertexBuffer(t.featureArray,BT.members,!0)),t.segments=ci.simpleSegment(0,0,t.vertexArray.length,t.indexArray.length);const n=t.material;n.pbrMetallicRoughness.baseColorTexture&&Fh(n.pbrMetallicRoughness.baseColorTexture,e),n.pbrMetallicRoughness.metallicRoughnessTexture&&Fh(n.pbrMetallicRoughness.metallicRoughnessTexture,e),n.normalTexture&&Fh(n.normalTexture,e),n.occlusionTexture&&Fh(n.occlusionTexture,e,r),n.emissionTexture&&Fh(n.emissionTexture,e)}function o_(t,e,r){if(t.meshes)for(const n of t.meshes)UT(n,e,r);if(t.children)for(const n of t.children)o_(n,e,r)}function Xf(t){if(t.meshes)for(const e of t.meshes)e.indexArray.destroy(),e.vertexArray.destroy(),e.colorArray&&e.colorArray.destroy(),e.normalArray&&e.normalArray.destroy(),e.texcoordArray&&e.texcoordArray.destroy(),e.featureArray&&e.featureArray.destroy();if(t.children)for(const e of t.children)Xf(e)}function s_(t){if(t.meshes)for(const r of t.meshes)r.vertexBuffer&&(r.vertexBuffer.destroy(),r.indexBuffer.destroy(),r.normalBuffer&&r.normalBuffer.destroy(),r.texcoordBuffer&&r.texcoordBuffer.destroy(),r.colorBuffer&&r.colorBuffer.destroy(),r.pbrBuffer&&r.pbrBuffer.destroy(),r.segments.destroy(),r.material&&((e=r.material).pbrMetallicRoughness.baseColorTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),e.pbrMetallicRoughness.metallicRoughnessTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),e.normalTexture&&e.normalTexture.gfxTexture&&e.normalTexture.gfxTexture.destroy(),e.emissionTexture&&e.emissionTexture.gfxTexture&&e.emissionTexture.gfxTexture.destroy(),e.occlusionTexture&&e.occlusionTexture.gfxTexture&&e.occlusionTexture.gfxTexture.destroy()));var e;if(t.children)for(const r of t.children)s_(r)}class VT{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class jT{constructor(){this.tasks={},this.taskQueue=[],Nn(["process"],this),this.invoker=new VT(this.process),this.nextId=0}add(e,r){const n=this.nextId++,a=function({type:l,isSymbolTile:h,zoom:f}){return f=f||0,l==="message"?0:l!=="maybePrepare"||h?l!=="parseTile"||h?l==="parseTile"&&h?300-f:l==="maybePrepare"&&h?400-f:500:200-f:100-f}(r);if(a===0){to();try{e()}finally{}return null}return this.tasks[n]={fn:e,metadata:r,priority:a,id:n},this.taskQueue.push(n),this.invoker.trigger(),{cancel:()=>{delete this.tasks[n]}}}process(){to();try{if(this.taskQueue=this.taskQueue.filter(n=>!!this.tasks[n]),!this.taskQueue.length)return;const e=this.pick();if(e===null)return;const r=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!r)return;r.fn()}finally{}}pick(){let e=null,r=1/0;for(let a=0;a<this.taskQueue.length;a++){const l=this.tasks[this.taskQueue[a]];l.priority<r&&(r=l.priority,e=a)}if(e===null)return null;const n=this.taskQueue[e];return this.taskQueue.splice(e,1),n}remove(){this.invoker.remove()}}class D1{constructor(e,r,n){this.target=e,this.parent=r,this.mapId=n,this.callbacks={},this.cancelCallbacks={},Nn(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new jT}send(e,r,n,a,l=!1,h){const f=Math.round(1e18*Math.random()).toString(36).substring(0,10);n&&(n.metadata=h,this.callbacks[f]=n);const m=new Set;return this.target.postMessage({id:f,type:e,hasCallback:!!n,targetMapId:a,mustQueue:l,sourceMapId:this.mapId,data:qo(r,m)},m),{cancel:()=>{n&&delete this.callbacks[f],this.target.postMessage({id:f,type:"<cancel>",targetMapId:a,sourceMapId:this.mapId})}}}receive(e){const r=e.data,n=r.id;if(n&&(!r.targetMapId||this.mapId===r.targetMapId))if(r.type==="<cancel>"){const a=this.cancelCallbacks[n];delete this.cancelCallbacks[n],a&&a.cancel()}else if(r.mustQueue||to()){const a=this.callbacks[n],l=this.scheduler.add(()=>this.processTask(n,r),a&&a.metadata||{type:"message"});l&&(this.cancelCallbacks[n]=l)}else this.processTask(n,r)}processTask(e,r){if(delete this.cancelCallbacks[e],r.type==="<response>"){const n=this.callbacks[e];delete this.callbacks[e],n&&(r.error?n(ws(r.error)):n(null,ws(r.data)))}else{const n=new Set,a=r.hasCallback?(h,f)=>{this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:h?qo(h):null,data:qo(f,n)},n)}:h=>{},l=ws(r.data);if(this.parent[r.type])this.parent[r.type](r.sourceMapId,l,a);else if(this.parent.getWorkerSource){const h=r.type.split(".");this.parent.getWorkerSource(r.sourceMapId,h[0],l.source,l.scope)[h[1]](l,a)}else a(new Error(`Could not find function ${r.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}class Dc{constructor(e,r){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=eo();const n=this.workerPool.acquire(this.id);for(let a=0;a<n.length;a++){const l=new Dc.Actor(n[a],r,this.id);l.name=`Worker ${a}`,this.actors.push(l)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(e,r,n){qi(this.actors,(a,l)=>{a.send(e,r,l)},n=n||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(e=>{e.remove()}),this.actors=[],this.workerPool.release(this.id)}}Dc.Actor=D1;var Nh={workerUrl:"",workerClass:null,workerParams:void 0};function ZT(){return Nh.workerClass!=null?new Nh.workerClass:new self.Worker(Nh.workerUrl,Nh.workerParams)}const a_="mapboxgl_preloaded_worker_pool";class Uh{constructor(){this.active={}}acquire(e){if(!this.workers)for(this.workers=[];this.workers.length<Uh.workerCount;)this.workers.push(new ZT);return this.active[e]=!0,this.workers.slice()}release(e){delete this.active[e],this.workers&&this.numActive()===0&&(this.workers.forEach(r=>{r.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[a_]}numActive(){return Object.keys(this.active).length}}let Vh;function Yf(){return Vh||(Vh=new Uh),Vh}Uh.workerCount=2;let Kf,l_,Co,zc,c_,Rc=null;function z1(){return to()&&self.worker&&self.worker.dracoUrl?self.worker.dracoUrl:l_||se.DRACO_URL}function R1(){if(to()&&self.worker&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(zc)return zc;const t=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return zc=WebAssembly.validate(t)?se.MESHOPT_SIMD_URL:se.MESHOPT_URL,zc}const Jf={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},GT={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},jh={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function O1(t,e,r){const n=r.json.bufferViews.length,a=r.buffers.length;e.bufferView=n,r.json.bufferViews[n]={buffer:a,byteLength:t.byteLength},r.buffers[a]=t}const u_="KHR_draco_mesh_compression";function $T(t,e){const r=t.extensions&&t.extensions[u_];if(!r)return;const n=new Co.Decoder,a=N1(e,r.bufferView),l=new Co.Mesh;if(!n.DecodeArrayToMesh(a,a.byteLength,l))throw new Error("Failed to decode Draco mesh");const h=e.json.accessors[t.indices],f=Jf[h.componentType],m=h.count*f.BYTES_PER_ELEMENT,_=Co._malloc(m);f===Uint16Array?n.GetTrianglesUInt16Array(l,m,_):n.GetTrianglesUInt32Array(l,m,_),O1(Co.memory.buffer.slice(_,_+m),h,e),Co._free(_);for(const x of Object.keys(r.attributes)){const b=n.GetAttributeByUniqueId(l,r.attributes[x]),T=e.json.accessors[t.attributes[x]],C=GT[T.componentType],P=T.count*jh[T.type]*Jf[T.componentType].BYTES_PER_ELEMENT,D=Co._malloc(P);n.GetAttributeDataArrayForAllPoints(l,b,Co[C],P,D),O1(Co.memory.buffer.slice(D,D+P),T,e),Co._free(D)}n.destroy(),l.destroy(),delete t.extensions[u_]}const Qf="EXT_meshopt_compression";function qT(t,e){if(!t.extensions||!t.extensions[Qf])return;const r=t.extensions[Qf],n=new Uint8Array(e.buffers[r.buffer],r.byteOffset||0,r.byteLength||0),a=new Uint8Array(r.count*r.byteStride);c_.decodeGltfBuffer(a,r.count,r.byteStride,n,r.mode,r.filter),t.buffer=e.buffers.length,t.byteOffset=0,e.buffers[t.buffer]=a.buffer,delete t.extensions[Qf]}const k1=1179937895,B1=new TextDecoder("utf8");function F1(t,e){return new URL(t,e).href}function WT(t,e,r,n){return fetch(F1(t.uri,n)).then(a=>a.arrayBuffer()).then(a=>{e.buffers[r]=a})}function N1(t,e){const r=t.json.bufferViews[e];return new Uint8Array(t.buffers[r.buffer],r.byteOffset||0,r.byteLength)}function HT(t,e,r,n){if(t.uri){const a=F1(t.uri,n);return fetch(a).then(l=>l.blob()).then(l=>createImageBitmap(l)).then(l=>{e.images[r]=l})}if(t.bufferView!==void 0){const a=N1(e,t.bufferView),l=new Blob([a],{type:t.mimeType});return createImageBitmap(l).then(h=>{e.images[r]=h})}}function U1(t,e=0,r){const n={json:null,images:[],buffers:[]};if(new Uint32Array(t,e,1)[0]===k1){const x=new Uint32Array(t,e);let b=2;const T=(x[b++]>>2)-3,C=x[b++]>>2;if(b++,n.json=JSON.parse(B1.decode(x.subarray(b,b+C))),b+=C,b<T){const P=x[b++];b++;const D=e+(b<<2);n.buffers[0]=t.slice(D,D+P)}}else n.json=JSON.parse(B1.decode(new Uint8Array(t,e)));const{buffers:a,images:l,meshes:h,extensionsUsed:f,bufferViews:m}=n.json;let _=Promise.resolve();if(a){const x=[];for(let b=0;b<a.length;b++){const T=a[b];T.uri?x.push(WT(T,n,b,r)):n.buffers[b]||(n.buffers[b]=null)}_=Promise.all(x)}return _.then(()=>{const x=[],b=f&&f.includes(u_),T=f&&f.includes(Qf);if(b&&x.push(function(){if(!Co)return Kf||(Kf=function(C){let P,D=null;function O(){P=new Uint8Array(D.buffer)}function F(){throw new Error("Unexpected Draco error.")}const $={a:{a:F,d:function(X,H,ne){return P.copyWithin(X,H,H+ne)},c:function(X){const H=P.length,ne=Math.max(X>>>0,Math.ceil(1.2*H)),re=Math.ceil((ne-H)/65536);try{return D.grow(re),O(),!0}catch{return!1}},b:F}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(C,$):C.then(X=>X.arrayBuffer()).then(X=>WebAssembly.instantiate(X,$))).then(X=>{const{Rb:H,Qb:ne,P:re,T:ce,X:pe,Ja:ye,La:Te,Qa:xe,Va:Se,Wa:Be,eb:Ce,jb:Oe,f:Me,e:Re,yb:et,zb:Ne,Ab:gt,Bb:ht,Db:je,Gb:kt}=X.instance.exports;D=Re;const Mt=(()=>{let _t=0,Ze=0,Dt=0,Qt=0;return Bt=>{Dt&&(H(Qt),H(_t),Ze+=Dt,Dt=_t=0),_t||(Ze+=128,_t=ne(Ze));const er=Bt.length+7&-8;let Zt=_t;er>=Ze&&(Dt=er,Zt=Qt=ne(er));for(let hr=0;hr<Bt.length;hr++)P[Zt+hr]=Bt[hr];return Zt}})();return O(),Me(),{memory:Re,_free:H,_malloc:ne,Mesh:class{constructor(){this.ptr=re()}destroy(){ce(this.ptr)}},Decoder:class{constructor(){this.ptr=ye()}destroy(){Oe(this.ptr)}DecodeArrayToMesh(_t,Ze,Dt){const Qt=Mt(_t),Bt=Te(this.ptr,Qt,Ze,Dt.ptr);return!!pe(Bt)}GetAttributeByUniqueId(_t,Ze){return{ptr:xe(this.ptr,_t.ptr,Ze)}}GetTrianglesUInt16Array(_t,Ze,Dt){Se(this.ptr,_t.ptr,Ze,Dt)}GetTrianglesUInt32Array(_t,Ze,Dt){Be(this.ptr,_t.ptr,Ze,Dt)}GetAttributeDataArrayForAllPoints(_t,Ze,Dt,Qt,Bt){Ce(this.ptr,_t.ptr,Ze.ptr,Dt,Qt,Bt)}},DT_INT8:et(),DT_UINT8:Ne(),DT_INT16:gt(),DT_UINT16:ht(),DT_UINT32:je(),DT_FLOAT32:kt()}})}(fetch(z1())),Kf.then(C=>{Co=C,Kf=void 0}))}()),T&&x.push(function(){if(c_)return;const C=function(P){let D;const O=WebAssembly.instantiateStreaming(P,{}).then(X=>{D=X.instance,D.exports.__wasm_call_ctors()}),F={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},$={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:O,supported:!0,decodeGltfBuffer(X,H,ne,re,ce,pe){(function(ye,Te,xe,Se,Be,Ce,Oe){const Me=ye.exports.sbrk,Re=Se+3&-4,et=Me(Re*Be),Ne=Me(Ce.length),gt=new Uint8Array(ye.exports.memory.buffer);gt.set(Ce,Ne);const ht=Te(et,Se,Be,Ne,Ce.length);if(ht===0&&Oe&&Oe(et,Re,Be),xe.set(gt.subarray(et,et+Se*Be)),Me(et-Me(0)),ht!==0)throw new Error(`Malformed buffer data: ${ht}`)})(D,D.exports[$[ce]],X,H,ne,re,D.exports[F[pe]])}}}(fetch(R1()));return C.ready.then(()=>{c_=C})}()),l)for(let C=0;C<l.length;C++)x.push(HT(l[C],n,C,r));return(x.length?Promise.all(x):Promise.resolve()).then(()=>{if(b&&h)for(const{primitives:C}of h)for(const P of C)$T(P,n);if(T&&h&&m)for(const C of m)qT(C,n);return n})})}class V1{constructor(e,r,n){if(this.triangleCount=r.length/3,this.min=new Ge(0,0),this.max=new Ge(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||e.length===0||n===0)return;const a=e.map(x=>x.x),l=e.map(x=>x.y);this.min=new Ge(Math.min(...a),Math.min(...l)),this.max=new Ge(Math.max(...a),Math.max(...l));const h=this.max.sub(this.min);h.x=Math.max(h.x,1),h.y=Math.max(h.y,1);const f=Math.max(h.x,h.y)/n;this.cellsX=Math.max(1,Math.ceil(h.x/f)),this.cellsY=Math.max(1,Math.ceil(h.y/f)),this.xScale=1/f,this.yScale=1/f;const m=[];for(let x=0;x<this.triangleCount;x++){const b=e[r[3*x+0]].sub(this.min),T=e[r[3*x+1]].sub(this.min),C=e[r[3*x+2]].sub(this.min),P=ba(Math.floor(Math.min(b.x,T.x,C.x)),this.xScale,this.cellsX),D=ba(Math.floor(Math.max(b.x,T.x,C.x)),this.xScale,this.cellsX),O=ba(Math.floor(Math.min(b.y,T.y,C.y)),this.yScale,this.cellsY),F=ba(Math.floor(Math.max(b.y,T.y,C.y)),this.yScale,this.cellsY),$=new Ge(0,0),X=new Ge(0,0),H=new Ge(0,0),ne=new Ge(0,0);for(let re=O;re<=F;++re){$.y=X.y=re*f,H.y=ne.y=(re+1)*f;for(let ce=P;ce<=D;++ce)$.x=H.x=ce*f,X.x=ne.x=(ce+1)*f,(om(b,T,C,$,X,ne)||om(b,T,C,$,ne,H))&&m.push({cellIdx:re*this.cellsX+ce,triIdx:x})}}if(m.length===0)return;m.sort((x,b)=>x.cellIdx-b.cellIdx||x.triIdx-b.triIdx);let _=0;for(;_<m.length;){const x=m[_].cellIdx,b={start:this.payload.length,len:0};for(;_<m.length&&m[_].cellIdx===x;)++b.len,this.payload.push(m[_++].triIdx);this.cells[x]=b}}query(e,r,n){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>r.x||e.y>this.max.y||this.min.y>r.y)return;this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8)));for(let m=0;m<this.lookup.length;m++)this.lookup[m]=0;const a=ba(e.x-this.min.x,this.xScale,this.cellsX),l=ba(r.x-this.min.x,this.xScale,this.cellsX),h=ba(e.y-this.min.y,this.yScale,this.cellsY),f=ba(r.y-this.min.y,this.yScale,this.cellsY);for(let m=h;m<=f;m++)for(let _=a;_<=l;_++){const x=this.cells[m*this.cellsX+_];if(x)for(let b=0;b<x.len;b++){const T=this.payload[x.start+b],C=Math.floor(T/8),P=1<<T%8;if(!(this.lookup[C]&P)&&(this.lookup[C]|=P,n.push(T),n.length===this.triangleCount))return}}}}function ba(t,e,r){return Math.max(0,Math.min(r-1,Math.floor(t*e)))}function Tl(t,e){const r=t.json.bufferViews[e.bufferView],n=Jf[e.componentType];return new n(t.buffers[r.buffer],(e.byteOffset||0)+(r.byteOffset||0),e.count*(r.byteStride&&r.byteStride!==jh[e.type]*n.BYTES_PER_ELEMENT?r.byteStride/n.BYTES_PER_ELEMENT:jh[e.type]))}function h_(t,e,r,n){const a=Jf[e.componentType],l=function(x){switch(x){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(a),h=t.json.bufferViews[e.bufferView],f=h.byteStride?h.byteStride/a.BYTES_PER_ELEMENT:jh[e.type],m=r.float32,_=m.length/r.capacity;for(let x=0,b=0;x<e.count*f;x+=f,b+=_)for(let T=0;T<_;T++)m[b+T]=n[x+T]*l;r._trim()}function XT(t,e,r){const n=t.indices,a=t.attributes,l={};l.indexArray=new Si;const h=e.json.accessors[n],f=h.count/3;l.indexArray.reserve(f);const m=Tl(e,h);for(let T=0;T<f;T++)l.indexArray.emplaceBack(m[3*T],m[3*T+1],m[3*T+2]);l.indexArray._trim(),l.vertexArray=new Ms;const _=e.json.accessors[a.POSITION];l.vertexArray.reserve(_.count);const x=Tl(e,_);for(let T=0;T<_.count;T++)l.vertexArray.emplaceBack(x[3*T],x[3*T+1],x[3*T+2]);if(l.vertexArray._trim(),l.aabb=new ai(_.min,_.max),l.centroid=function(T,C){const P=[0,0,0],D=T.length;if(D>0){for(let O=0;O<D;O++){const F=3*T[O];P[0]+=C[F],P[1]+=C[F+1],P[2]+=C[F+2]}P[0]/=D,P[1]/=D,P[2]/=D}return P}(m,x),a.COLOR_0!==void 0){const T=e.json.accessors[a.COLOR_0],C=jh[T.type],P=Tl(e,T);l.colorArray=C===3?new Ms:new Yo,l.colorArray.resize(T.count),h_(e,T,l.colorArray,P)}if(a.NORMAL!==void 0){l.normalArray=new Ms;const T=e.json.accessors[a.NORMAL];l.normalArray.resize(T.count);const C=Tl(e,T);h_(e,T,l.normalArray,C)}if(a.TEXCOORD_0!==void 0&&r.length>0){l.texcoordArray=new ul;const T=e.json.accessors[a.TEXCOORD_0];l.texcoordArray.resize(T.count);const C=Tl(e,T);h_(e,T,l.texcoordArray,C)}if(a._FEATURE_ID_RGBA4444!==void 0){const T=e.json.accessors[a._FEATURE_ID_RGBA4444];e.json.extensionsUsed&&e.json.extensionsUsed.includes("EXT_meshopt_compression")&&(l.featureData=Tl(e,T))}a._FEATURE_RGBA4444!==void 0&&(l.featureData=new Uint32Array(Tl(e,e.json.accessors[a._FEATURE_RGBA4444]).buffer));const b=t.material;return l.material=function(T,C){const{emissiveFactor:P=[0,0,0],alphaMode:D="OPAQUE",alphaCutoff:O=.5,normalTexture:F,occlusionTexture:$,emissiveTexture:X,doubleSided:H}=T,{baseColorFactor:ne=[1,1,1,1],metallicFactor:re=1,roughnessFactor:ce=1,baseColorTexture:pe,metallicRoughnessTexture:ye}=T.pbrMetallicRoughness||{},Te=$?C[$.index]:void 0;if($&&$.extensions&&$.extensions.KHR_texture_transform&&Te){const xe=$.extensions.KHR_texture_transform;Te.offsetScale=[xe.offset[0],xe.offset[1],xe.scale[0],xe.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new mi(...ne),metallicFactor:re,roughnessFactor:ce,baseColorTexture:pe?C[pe.index]:void 0,metallicRoughnessTexture:ye?C[ye.index]:void 0},doubleSided:H,emissiveFactor:P,alphaMode:D,alphaCutoff:O,normalTexture:F?C[F.index]:void 0,occlusionTexture:Te,emissionTexture:X?C[X.index]:void 0,defined:T.defined===void 0}}(b!==void 0?e.json.materials[b]:{defined:!1},r),l}function j1(t,e,r){const{matrix:n,rotation:a,translation:l,scale:h,mesh:f,extras:m,children:_}=t,x={};if(x.matrix=n||s.a6.fromRotationTranslationScale([],a||[0,0,0,1],l||[0,0,0],h||[1,1,1]),f!==void 0){x.meshes=r[f];const b=x.anchor=[0,0];for(const T of x.meshes){const{min:C,max:P}=T.aabb;b[0]+=C[0]+P[0],b[1]+=C[1]+P[1]}b[0]=Math.floor(b[0]/x.meshes.length/2),b[1]=Math.floor(b[1]/x.meshes.length/2)}if(m&&(m.id&&(x.id=m.id),m.lights&&(x.lights=function(b){if(!b.length)return[];const T=function(F){const $=atob(F),X=new Uint8Array($.length);for(let H=0;H<$.length;H++)X[H]=$.codePointAt(H);return X}(b),C=[],P=T.length/24,D=new Uint16Array(T.buffer),O=new Float32Array(T.buffer);for(let F=0;F<P;F++){const $=D[2*F*6]/30,X=D[2*F*6+1]/30,H=D[2*F*6+10]/100,ne=O[6*F+1],re=O[6*F+2],ce=O[6*F+3],pe=O[6*F+4],ye=ce-ne,Te=pe-re,xe=Math.hypot(ye,Te);C.push({pos:[ne+.5*ye,re+.5*Te,X],normal:[Te/xe,-ye/xe,0],width:xe,height:$,depth:H,points:[ne,re,ce,pe]})}return C}(m.lights))),_){const b=[];for(const T of _)b.push(j1(e.json.nodes[T],e,r));x.children=b}return x}function YT(t){if(t.vertices.length===0||t.indices.length===0)return null;const[e,r]=[t.vertices[0].clone(),t.vertices[0].clone()];for(let h=1;h<t.vertices.length;++h){const f=t.vertices[h];e.x=Math.min(e.x,f.x),e.y=Math.min(e.y,f.y),r.x=Math.max(r.x,f.x),r.y=Math.max(r.y,f.y)}const n=Math.ceil(Math.max(r.x-e.x,r.y-e.y)/256),a=Math.max(8,n),l=new V1(t.vertices,t.indices,a);return{vertices:t.vertices,indices:t.indices,grid:l,min:e,max:r}}function KT(t){if(!t.extras||!t.extras.ground)return null;const e=t.extras.ground;if(!e||!Array.isArray(e)||e.length===0)return null;const r=e[0];if(!r||!Array.isArray(r)||r.length===0)return null;const n=[];for(const h of r){if(!Array.isArray(h)||h.length!==2)continue;const f=h[0],m=h[1];typeof f=="number"&&typeof m=="number"&&n.push(new Ge(f,m))}if(n.length<3)return null;n.length>1&&n[n.length-1].equals(n[0])&&n.pop();let a=0;for(let h=0;h<n.length;h++){const f=n[h],m=n[(h+1)%n.length],_=n[(h+2)%n.length];a+=(f.x-m.x)*(_.y-m.y)-(_.x-m.x)*(f.y-m.y)}a>0&&n.reverse();const l=vf(n.flatMap(h=>[h.x,h.y]),[]);return l.length===0?null:{vertices:n,indices:l}}function JT(t){const e=[],r=[];let n=0;for(const a of t){n=e.length;const l=a.vertexArray.float32,h=a.indexArray.uint16;for(let f=0;f<a.vertexArray.length;f++)e.push(new Ge(l[3*f+0],l[3*f+1]));for(let f=0;f<3*a.indexArray.length;f++)r.push(h[f]+n)}if(r.length%3!=0)return null;for(let a=0;a<r.length;a+=3){const l=e[r[a+0]],h=e[r[a+1]],f=e[r[a+2]];(l.x-h.x)*(f.y-h.y)-(f.x-h.x)*(l.y-h.y)>0&&([r[a+1],r[a+2]]=[r[a+2],r[a+1]])}return{vertices:e,indices:r}}function Z1(t){const e=function(m,_){const x=[],b=WebGL2RenderingContext;if(m.json.textures)for(const T of m.json.textures){const C={magFilter:b.LINEAR,minFilter:b.NEAREST,wrapS:b.REPEAT,wrapT:b.REPEAT};T.sampler!==void 0&&Object.assign(C,m.json.samplers[T.sampler]),x.push({image:_[T.source],sampler:C,uploaded:!1})}return x}(t,t.images),r=function(m,_){const x=[];for(const b of m.json.meshes){const T=[];for(const C of b.primitives)T.push(XT(C,m,_));x.push(T)}return x}(t,e),{scenes:n,scene:a,nodes:l}=t.json,h=n?n[a||0].nodes:l,f=[];for(const m of h)f.push(j1(l[m],t,r));return function(m,_,x){const b={},T=new Set;for(let C=0;C<m.length;C++){const P=x[_[C]];if(!P.extras)continue;const D=P.extras["mapbox:footprint:version"],O=P.extras["mapbox:footprint:id"];(D||O)&&T.add(C),D==="1.0.0"&&O&&(b[O]=C)}for(let C=0;C<m.length;C++){if(T.has(C))continue;const P=m[C],D=x[_[C]];if(!D.extras)continue;let O=null;P.id in b&&(O=JT(m[b[P.id]].meshes)),O||(O=KT(D)),O&&(P.footprint=YT(O))}if(T.size>0){const C=Array.from(T.values()).sort((P,D)=>P-D);for(let P=C.length-1;P>=0;P--)m.splice(C[P],1)}}(f,h,t.json.nodes),f}function QT(t){t.heightmap=new Float32Array(4096),t.heightmap.fill(-1);const e=t.vertexArray.float32,r=t.aabb.min[0]-1,n=t.aabb.min[1]-1,a=wl/(t.aabb.max[0]-r+2),l=wl/(t.aabb.max[1]-n+2);for(let h=0;h<e.length;h+=3){const f=e[h+2],m=(e[h+0]-r)*a|0,_=(e[h+1]-n)*l|0;f>t.heightmap[_*wl+m]&&(t.heightmap[_*wl+m]=f)}}function eE(t,e){const r={};r.indexArray=new Si,r.indexArray.reserve(4*t.length),r.vertexArray=new Ms,r.vertexArray.reserve(10*t.length),r.colorArray=new Yo,r.vertexArray.reserve(10*t.length);let n=0;for(const h of t){const f=Math.min(10,Math.max(4,1.3*h.height))*e,m=[-h.normal[1],h.normal[0],0],_=Math.min(.29,.1*h.width/h.depth),x=h.width-2*h.depth*e*(_+.01),b=s.N.scaleAndAdd([],h.pos,m,x/2),T=s.N.scaleAndAdd([],h.pos,m,-x/2),C=[b[0],b[1],b[2]+h.height],P=[T[0],T[1],T[2]+h.height],D=s.N.scaleAndAdd([],h.normal,m,_);s.N.scale(D,D,f);const O=s.N.scaleAndAdd([],h.normal,m,-_);s.N.scale(O,O,f),s.N.add(D,b,D),s.N.add(O,T,O),b[2]+=.1,T[2]+=.1,r.vertexArray.emplaceBack(D[0],D[1],D[2]),r.vertexArray.emplaceBack(O[0],O[1],O[2]),r.vertexArray.emplaceBack(b[0],b[1],b[2]),r.vertexArray.emplaceBack(T[0],T[1],T[2]),r.vertexArray.emplaceBack(C[0],C[1],C[2]),r.vertexArray.emplaceBack(P[0],P[1],P[2]),r.vertexArray.emplaceBack(b[0],b[1],b[2]),r.vertexArray.emplaceBack(T[0],T[1],T[2]),r.vertexArray.emplaceBack(D[0],D[1],D[2]),r.vertexArray.emplaceBack(O[0],O[1],O[2]);const F=x/f/2;r.colorArray.emplaceBack(-F-_,-1,F,.8),r.colorArray.emplaceBack(F+_,-1,F,.8),r.colorArray.emplaceBack(-F,0,F,1.3),r.colorArray.emplaceBack(F,0,F,1.3),r.colorArray.emplaceBack(F+_,-.8,F,.7),r.colorArray.emplaceBack(F+_,-.8,F,.7),r.colorArray.emplaceBack(0,0,F,1.3),r.colorArray.emplaceBack(0,0,F,1.3),r.colorArray.emplaceBack(F+_,-1.2,F,.8),r.colorArray.emplaceBack(F+_,-1.2,F,.8),r.indexArray.emplaceBack(6+n,4+n,8+n),r.indexArray.emplaceBack(7+n,9+n,5+n),r.indexArray.emplaceBack(0+n,1+n,2+n),r.indexArray.emplaceBack(1+n,3+n,2+n),n+=10}const a={defined:!0,emissiveFactor:[0,0,0]},l={};return l.baseColorFactor=mi.white,a.pbrMetallicRoughness=l,r.material=a,r.aabb=new ai([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),r}mt(V1,"TriangleGridIndex");class G1{constructor(e){this._stringToNumber={},this._numberToString=[];for(let r=0;r<e.length;r++){const n=e[r];this._stringToNumber[n]=r,this._numberToString[r]=n}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}const tE=["tile","layer","source","sourceLayer","state"];class $1{constructor(e,r,n,a,l){this.type="Feature",this._vectorTileFeature=e,this._z=r,this._x=n,this._y=a,this.properties=e.properties,this.id=l}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};this.id!==void 0&&(e.id=this.id);for(const r of tE)this[r]!==void 0&&(e[r]=this[r]);return e}}class q1{constructor(e,r){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new yo(ct,16,0),this.featureIndexArray=new Kd,this.promoteId=r,this.is3DTile=!1}insert(e,r,n,a,l,h=0,f=0){const m=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(n,a,l,h);const _=this.grid;for(let x=0;x<r.length;x++){const b=r[x],T=[1/0,1/0,-1/0,-1/0];for(let C=0;C<b.length;C++){const P=b[C];T[0]=Math.min(T[0],P.x),T[1]=Math.min(T[1],P.y),T[2]=Math.max(T[2],P.x),T[3]=Math.max(T[3],P.y)}f!==0&&(T[0]-=f,T[1]-=f,T[2]+=f,T[3]+=f),T[0]<ct&&T[1]<ct&&T[2]>=0&&T[3]>=0&&_.insert(m,T[0],T[1],T[2],T[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new Fm(new Ic(this.rawTileData)).layers,this.sourceLayerCoder=new G1(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,r,n,a){this.loadVTLayers();const l=e.params||{},h=bn(l.filter),f=e.tileResult,m=e.transform,_=f.bufferedTilespaceBounds,x=this.grid.query(_.min.x,_.min.y,_.max.x,_.max.y,(P,D,O,F)=>fg(f.bufferedTilespaceGeometry,P,D,O,F));x.sort(rE);let b=null;m.elevation&&x.length>0&&(b=bc.create(m.elevation,this.tileID));const T={};let C;for(let P=0;P<x.length;P++){const D=x[P];if(D===C)continue;C=D;const O=this.featureIndexArray.get(D);let F=null;if(this.is3DTile){const $=this.bucketLayerIDs[0][0],X=r[$];if(X.type!=="model")continue;const{queryFeature:H,intersectionZ:ne}=X.queryIntersectsMatchingFeature(f,O.featureIndex,h,m);H&&this.appendToResult(T,$,O.featureIndex,H,ne)}else this.loadMatchingFeature(T,O,h,l.layers,l.availableImages,r,n,a,($,X,H,ne=0)=>(F||(F=Li($,this.tileID.canonical,e.tileTransform)),X.queryIntersectsFeature(f,$,H,F,this.z,e.transform,e.pixelPosMatrix,b,ne)))}return T}loadMatchingFeature(e,r,n,a,l,h,f,m,_){const{featureIndex:x,bucketIndex:b,sourceLayerIndex:T,layoutVertexArrayOffset:C}=r,P=this.bucketLayerIDs[b];if(a&&!function($,X){for(let H=0;H<$.length;H++)if(X.indexOf($[H])>=0)return!0;return!1}(a,P))return;const D=this.sourceLayerCoder.decode(T),O=this.vtLayers[D].feature(x);if(n.needGeometry){const $=wi(O,!0);if(!n.filter(new ei(this.tileID.overscaledZ),$,this.tileID.canonical))return}else if(!n.filter(new ei(this.tileID.overscaledZ),O))return;const F=this.getId(O,D);for(let $=0;$<P.length;$++){const X=P[$];if(a&&a.indexOf(X)<0)continue;const H=h[X];if(!H)continue;let ne={};F!==void 0&&m&&(ne=m.getState(H.sourceLayer||"_geojsonTileLayer",F));const re=!_||_(O,H,ne,C);if(!re)continue;const ce=new $1(O,this.z,this.x,this.y,F),pe=gi({},f[X]);pe.paint=W1(pe.paint,H.paint,O,ne,l),pe.layout=W1(pe.layout,H.layout,O,ne,l),ce.layer=pe,this.appendToResult(e,X,x,ce,re)}}appendToResult(e,r,n,a,l){let h=e[r];h===void 0&&(h=e[r]=[]),h.push({featureIndex:n,feature:a,intersectionZ:l})}lookupSymbolFeatures(e,r,n,a,l,h,f,m){const _={};this.loadVTLayers();const x=bn(l);for(const b of e)this.loadMatchingFeature(_,{bucketIndex:n,sourceLayerIndex:a,featureIndex:b,layoutVertexArrayOffset:0},x,h,f,m,r);return _}loadFeature(e){const{featureIndex:r,sourceLayerIndex:n}=e;this.loadVTLayers();const a=this.sourceLayerCoder.decode(n),l=this.vtFeatures[a];if(l[r])return l[r];const h=this.vtLayers[a].feature(r);return l[r]=h,h}hasLayer(e){for(const r of this.bucketLayerIDs)for(const n of r)if(e===n)return!0;return!1}getId(e,r){let n=e.id;if(this.promoteId){const a=typeof this.promoteId=="string"?this.promoteId:this.promoteId[r];a!=null&&(n=e.properties[a]),typeof n=="boolean"&&(n=Number(n))}return n}}function W1(t,e,r,n,a){return Ci(t,(l,h)=>{const f=e instanceof Ja?e.get(h):null;return f&&f.evaluate?f.evaluate(r,n,a):f})}function rE(t,e){return e-t}mt(q1,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const d_=new Float32Array(262144),El=new Uint8Array(262144);function H1(t){let e=0;if(t.meshes)for(const r of t.meshes)e=Math.max(e,r.aabb.max[2]);if(t.children)for(const r of t.children)e=Math.max(e,H1(r));return e}function X1(t,e,r){if(t.meshes)for(const n of t.meshes)n.aabb.min[0]!==1/0&&r.insert(e,n.aabb.min[0],n.aabb.min[1],n.aabb.max[0],n.aabb.max[1]);if(t.children)for(const n of t.children)X1(n,e,r)}const Y1=["","wall","door","roof","window","lamp","logo"];class K1{constructor(e){this.node=e,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.feature={type:"Point",id:e.id,geometry:[],properties:{height:H1(e)}}}getLocalBounds(){if(!this.node.meshes)return new ai([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let e=0;const r=new ai([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const n of this.node.meshes)this.node.lightMeshIndex!==e&&r.encapsulate(n.aabb),e++;this.aabb=r}return this.aabb}}class ep{constructor(e,r,n,a,l,h){this.id=r,this.modelTraits|=Lc.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,n&&(this.modelTraits|=Lc.HasMapboxMeshFeatures),a&&(this.modelTraits|=Lc.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=l,this.dirty=!0,this.needsUpload=!1,this.nodesInfo=[];for(const f of e)this.nodesInfo.push(new K1(f)),X1(f,h.featureIndexArray.length,h.grid),h.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,h.bucketLayerIDs.length-1,0)}update(){console.log("Update 3D model bucket")}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(e){if(!this.needsUpload)return;const r=this.getNodesInfo();for(const n of r){const a=n.node;this.uploaded?this.updatePbrBuffer(a):o_(a,e,!0)}for(const n of r)Xf(n.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(e){let r=!1;if(!e.meshes)return r;for(const n of e.meshes)n.pbrBuffer&&(n.pbrBuffer.updateData(n.featureArray),r=!0);return r}needsReEvaluation(e,r,n){const a=e.transform.projectionOptions,l=e.style.getBrightness(),h=this.brightness!==l;return!!(!this.uploaded||this.dirty||a.name!==this.projection.name||Zh(n.paint.get("model-color").value,h)||Zh(n.paint.get("model-color-mix-intensity").value,h)||Zh(n.paint.get("model-roughness").value,h)||Zh(n.paint.get("model-emissive-strength").value,h)||Zh(n.paint.get("model-height-based-emissive-strength-multiplier").value,h))&&(this.projection=a,this.brightness=l,!0)}evaluateScale(e,r){if(e.transform.zoom===this.zoom)return;this.zoom=e.transform.zoom;const n=this.getNodesInfo(),a=this.id.canonical;for(const l of n){const h=l.feature;l.evaluatedScale=r.paint.get("model-scale").evaluate(h,{},a)}}evaluate(e){const r=this.getNodesInfo();for(const n of r){if(!n.node.meshes)continue;const a=n.feature,l=n.node.meshes&&n.node.meshes[0].featureData,h=n.evaluatedColor[2],f=n.evaluatedRMEA[2],m=this.id.canonical;if(n.hasTranslucentParts=!1,l){for(let _=0;_<Y1.length;_++){const x=Y1[_];x.length&&(a.properties.part=x);const b=e.paint.get("model-color").evaluate(a,{},m),T=e.paint.get("model-color-mix-intensity").evaluate(a,{},m);n.evaluatedColor[_]=[b.r,b.g,b.b,T],n.evaluatedRMEA[_][0]=e.paint.get("model-roughness").evaluate(a,{},m),n.evaluatedRMEA[_][2]=e.paint.get("model-emissive-strength").evaluate(a,{},m),n.evaluatedRMEA[_][3]=b.a,n.emissionHeightBasedParams[_]=e.paint.get("model-height-based-emissive-strength-multiplier").evaluate(a,{},m),!n.hasTranslucentParts&&b.a<1&&(n.hasTranslucentParts=!0)}delete a.properties.part,nE(n,h!==n.evaluatedColor[2]||f!==n.evaluatedRMEA[2],this.modelTraits)}else n.evaluatedRMEA[0][2]=e.paint.get("model-emissive-strength").evaluate(a,{},m);n.evaluatedScale=e.paint.get("model-scale").evaluate(a,{},m),this.updatePbrBuffer(n.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(e,r,n,a){const l=e.findDEMTileFor(n);if(l&&(l.tileID.canonical!==this.terrainTile||r!==this.terrainExaggeration)){if(l.dem&&l.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=l.tileID.overscaledZ;const h=bc.create(e,n,l);if(!h)return;this.modelTraits&Lc.HasMapboxMeshFeatures&&this.updateDEM(e,h,n,a);for(const f of this.getNodesInfo()){const m=f.node;if(!m.footprint||!m.footprint.vertices||!m.footprint.vertices.length)continue;const _=m.footprint.vertices;let x=h.getElevationAt(_[0].x,_[0].y,!0,!0);for(let b=1;b<_.length;b++)x=Math.min(x,h.getElevationAt(_[b].x,_[b].y,!0,!0));m.elevation=x}}this.terrainTile=l.tileID.canonical,this.terrainExaggeration=r}}updateDEM(e,r,n,a){let l=r._dem._modifiedForSources[a];if(l===void 0&&(r._dem._modifiedForSources[a]=[],l=r._dem._modifiedForSources[a]),l.includes(n.canonical))return;const h=r._dem.dim;l.push(n.canonical);let f=!1;for(const m of this.getNodesInfo()){const _=m.node;if(!_.footprint||!_.footprint.grid)continue;const x=_.footprint.grid,b=r.tileCoordToPixel(x.min.x,x.min.y),T=r.tileCoordToPixel(x.max.x,x.max.y),C=Math.min(Math.min(h-T.y,b.x),Math.min(b.y,h-T.x));if(C<0)continue;const P=Ut(C,2,5);let D=Math.max(0,b.x-P),O=Math.max(0,b.y-P),F=Math.min(T.x+P,h-1),$=Math.min(T.y+P,h-1);for(let re=O;re<=$;++re)for(let ce=D;ce<=F;++ce)El[re*h+ce]=255;let X=0,H=0;for(let re=0;re<x.cellsY;++re)for(let ce=0;ce<x.cellsX;++ce){if(!x.cells[re*x.cellsX+ce])continue;const pe=r.tileCoordToPixel(x.min.x+ce/x.xScale,x.min.y+re/x.yScale),ye=r.tileCoordToPixel(x.min.x+(ce+1)/x.xScale,x.min.y+(re+1)/x.yScale);for(let Te=pe.y;Te<=Math.min(ye.y+1,h-1);++Te)for(let xe=pe.x;xe<=Math.min(ye.x+1,h-1);++xe)El[Te*h+xe]===255&&(El[Te*h+xe]=0,X+=r.getElevationAtPixel(xe,Te),H++)}const ne=X/H;D=Math.max(1,b.x-P),O=Math.max(1,b.y-P),F=Math.min(T.x+P,h-2),$=Math.min(T.y+P,h-2),f=!0;for(let re=O;re<=$;++re)for(let ce=D;ce<=F;++ce)El[re*h+ce]===0&&(d_[re*h+ce]=r._dem.set(ce,re,ne));for(let re=1;re<P;++re){D=Math.max(1,b.x-re),O=Math.max(1,b.y-re),F=Math.min(T.x+re,h-2),$=Math.min(T.y+re,h-2);for(let ce=O;ce<=$;++ce)for(let pe=D;pe<=F;++pe){const ye=ce*h+pe;if(El[ye]===255){let Te=0,xe=0,Se=-1,Be=-1;for(let Ce=-1;Ce<=1;++Ce)for(let Oe=-1;Oe<=1;++Oe){const Me=(ce+Ce)*h+pe+Oe;if(El[Me]>=re)continue;const Re=d_[Me],et=Math.abs(Re);et>xe&&(Te=Re,xe=et,Se=Oe,Be=Ce)}if(xe>.1){const Ce=1-(re+.5*Math.abs(Se*Be))/P;let Oe=r._dem.get(pe,ce)+Te*Ce;const Me=r._dem.get(pe+Se,ce+Be),Re=r._dem.get(pe-Se,ce-Be,!0);(Oe-Me)*(Oe-Re)>0&&(Oe=(Me+Re)/2),d_[ye]=r._dem.set(pe,ce,Oe),El[ye]=re}}}}}f&&(r._demTile.needsDEMTextureUpload=!0,r._dem._timestamp=We.now())}getNodesInfo(){return this.nodesInfo}destroy(){const e=this.getNodesInfo();for(const r of e)Xf(r.node),s_(r.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(e,r){if(r.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=r.updateTime;const n=r.getReplacementRegionsForTile(e.toUnwrapped()),a=this.getNodesInfo();for(let l=0;l<this.nodesInfo.length;l++){const h=a[l].node;a[l].hiddenByReplacement=!!h.footprint&&!n.find(f=>f.footprint===h.footprint)}}getHeightAtTileCoord(e,r){const n=this.getNodesInfo(),a=[];for(let l=0;l<this.nodesInfo.length;l++){const h=n[l],f=h.node.meshes[0];if(e<f.aabb.min[0]||r<f.aabb.min[1]||e>f.aabb.max[0]||r>f.aabb.max[1])continue;const m=(e-f.aabb.min[0])/(f.aabb.max[0]-f.aabb.min[0])*wl|0,_=Math.min(63,(r-f.aabb.min[1])/(f.aabb.max[1]-f.aabb.min[1])*wl|0)*wl+Math.min(63,m);if(!(f.heightmap[_]<0&&h.node.footprint))return h.hiddenByReplacement?void 0:{height:f.heightmap[_],maxHeight:h.feature.properties.height,hidden:!1,verticalScale:h.evaluatedScale[2]};if(h.node.footprint.grid.query(new Ge(e,r),new Ge(e,r),a),a.length>0)return{height:void 0,maxHeight:h.feature.properties.height,hidden:h.hiddenByReplacement,verticalScale:h.evaluatedScale[2]}}}}function Zh(t,e){return!t.isLightConstant&&e}function iE(t,e,r,n,a,l,h,f){let m=(61440&e|(61440&e)>>4)>>8,_=(3840&e|(3840&e)>>4)>>4,x=240&e|(240&e)>>4;r[3]>0&&(m=ur(m,255*r[0],r[3]),_=ur(_,255*r[1],r[3]),x=ur(x,255*r[2],r[3]));const b=m<<8|_,T=x<<8|Math.floor(255*n[3]),C=function(re){const ce=Ut(re,0,2);return Math.min(Math.round(.5*ce*255),255)}(n[2])<<8|15*n[0]<<4|15*n[1],P=Ut(a[0],0,1),D=Ut(a[1],0,1),O=Ut(a[2],0,1),F=Ut(a[3],0,1);let $,X,H,ne;if(P!==D&&h!==l&&D!==P){const re=h-l;X=1/(re*(D-P)),H=-(l+re*P)/(re*(D-P));const ce=Ut(a[4],-1,1);ne=Math.pow(10,ce),$=255*O<<8|255*F}else $=65535,X=0,H=1,ne=1;if(t.emplaceBack(b,T,C,$,X,H,ne),f){const re=f.length;f.clear();for(let ce=0;ce<re;ce++)f.emplaceBack(b,T,C,$,X,H,ne)}}function nE(t,e,r){const n=t.node;let a=0;const l=r&Lc.HasMeshoptCompression;for(const h of n.meshes){if(n.lights&&n.lightMeshIndex===a||!h.featureData)continue;h.featureArray=new hl,h.featureArray.reserve(h.featureData.length);let f=e;for(const m of h.featureData){const _=l?65535&m:m>>16&65535,x=l?m>>16&65535:65535&m,b=(15&x)<8?15&x:0,T=t.evaluatedRMEA[b],C=t.evaluatedColor[b],P=t.emissionHeightBasedParams[b];let D;if(f&&b===2&&n.lights&&(D=new hl,D.resize(10*n.lights.length)),iE(h.featureArray,_,C,T,P,h.aabb.min[2],h.aabb.max[2],D),D&&f){f=!1;const O=n.meshes[n.lightMeshIndex];O.featureArray=D,O.featureArray._trim()}}h.featureArray._trim(),a++}}function J1(t,e,r,n){const a=1<<t.z;e.lat=fr((n/ct+t.y)/a),e.lng=$t((r/ct+t.x)/a)}mt(ep,"Tiled3dModelBucket",{omit:["layers"]}),mt(K1,"Tiled3dModelFeature");const oE={circle:class extends ln{constructor(t,e,r){super(t,Kv,e,r)}createBucket(t){return new hn(t)}queryRadius(t){const e=t;return yc("circle-radius",this,e)+yc("circle-stroke-width",this,e)+af(this.paint.get("circle-translate"))}queryIntersectsFeature(t,e,r,n,a,l,h,f){const m=mg(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),l.angle,t.pixelToTileUnitsFactor),_=this.paint.get("circle-radius").evaluate(e,r)+this.paint.get("circle-stroke-width").evaluate(e,r);return j0(t,n,l,h,f,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",m,_)}getProgramIds(){return["circle"]}getDefaultProgramParams(t,e){const r=V0(this);return{config:new R(this,e),defines:r,overrideFog:!1}}},heatmap:class extends ln{createBucket(t){return new G0(t)}constructor(t,e,r){super(t,Ab,e,r),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(t){t==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=wh({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(t){return yc("heatmap-radius",this,t)}queryIntersectsFeature(t,e,r,n,a,l,h,f){const m=this.paint.get("heatmap-radius").evaluate(e,r);return j0(t,n,l,h,f,!0,!0,new Ge(0,0),m)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(t,e){return t==="heatmap"?{config:new R(this,e),overrideFog:!1}:{}}},hillshade:class extends ln{constructor(t,e,r){super(t,Pb,e,r)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(t,e){return{overrideFog:!1}}},fill:class extends ln{constructor(t,e,r){super(t,Gb,e,r)}getProgramIds(){const t=this.paint.get("fill-pattern"),e=t&&t.constantOr(1),r=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&r.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),r}getDefaultProgramParams(t,e){return{config:new R(this,e),overrideFog:!1}}recalculate(t,e){super.recalculate(t,e);const r=this.paint._values["fill-outline-color"];r.value.kind==="constant"&&r.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(t){return new Bm(t)}queryRadius(){return af(this.paint.get("fill-translate"))}queryIntersectsFeature(t,e,r,n,a,l){return!t.queryGeometry.isAboveHorizon&&Is(pg(t.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),l.angle,t.pixelToTileUnitsFactor),n)}isTileClipped(){return!0}},"fill-extrusion":class extends ln{constructor(t,e,r){super(t,yw,e,r),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(t){return new Cf(t)}queryRadius(){return af(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}hasShadowPass(){return!0}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(t,e,r,n,a,l,h,f,m){const _=mg(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),l.angle,t.pixelToTileUnitsFactor),x=this.paint.get("fill-extrusion-height").evaluate(e,r),b=this.paint.get("fill-extrusion-base").evaluate(e,r),T=[0,0],C=f&&l.elevation,P=l.elevation?l.elevation.exaggeration():1,D=t.tile.getBucket(this);if(C&&D instanceof Cf){const H=D.centroidVertexArray,ne=m+1;ne<H.length&&(T[0]=H.geta_centroid_pos0(ne),T[1]=H.geta_centroid_pos1(ne))}if(T[0]===0&&T[1]===1)return!1;l.projection.name==="globe"&&(n=My([n],[new Ge(0,0),new Ge(ct,ct)],t.tileID.canonical).map(H=>H.polygon).flat());const O=C?f:null,[F,$]=function(H,ne,re,ce,pe,ye,Te,xe,Se,Be,Ce){return H.projection.name==="globe"?function(Oe,Me,Re,et,Ne,gt,ht,je,kt,Mt,_t){const Ze=[],Dt=[],Qt=Oe.projection.upVectorScale(_t,Oe.center.lat,Oe.worldSize).metersToTile,Bt=[0,0,0,1],er=[0,0,0,1],Zt=(Wt,Ur,xr,br)=>{Wt[0]=Ur,Wt[1]=xr,Wt[2]=br,Wt[3]=1},hr=Ey();Re>0&&(Re+=hr),et+=hr;for(const Wt of Me){const Ur=[],xr=[];for(const br of Wt){const Ar=br.x+Ne.x,vr=br.y+Ne.y,Qr=Oe.projection.projectTilePoint(Ar,vr,_t),Rr=Oe.projection.upVector(_t,br.x,br.y);let ui=Re,Ii=et;if(ht){const Gi=Cy(Ar,vr,Re,et,ht,je,kt,Mt);ui+=Gi.base,Ii+=Gi.top}Re!==0?Zt(Bt,Qr.x+Rr[0]*Qt*ui,Qr.y+Rr[1]*Qt*ui,Qr.z+Rr[2]*Qt*ui):Zt(Bt,Qr.x,Qr.y,Qr.z),Zt(er,Qr.x+Rr[0]*Qt*Ii,Qr.y+Rr[1]*Qt*Ii,Qr.z+Rr[2]*Qt*Ii),s.N.transformMat4(Bt,Bt,gt),s.N.transformMat4(er,er,gt),Ur.push(new wc(Bt[0],Bt[1],Bt[2])),xr.push(new wc(er[0],er[1],er[2]))}Ze.push(Ur),Dt.push(xr)}return[Ze,Dt]}(H,ne,re,ce,pe,ye,Te,xe,Se,Be,Ce):Te?function(Oe,Me,Re,et,Ne,gt,ht,je,kt){const Mt=[],_t=[],Ze=[0,0,0,1];for(const Dt of Oe){const Qt=[],Bt=[];for(const er of Dt){const Zt=er.x+et.x,hr=er.y+et.y,Wt=Cy(Zt,hr,Me,Re,gt,ht,je,kt);Ze[0]=Zt,Ze[1]=hr,Ze[2]=Wt.base,Ze[3]=1,s.a7.transformMat4(Ze,Ze,Ne),Ze[3]=Math.max(Ze[3],1e-5);const Ur=new wc(Ze[0]/Ze[3],Ze[1]/Ze[3],Ze[2]/Ze[3]);Ze[0]=Zt,Ze[1]=hr,Ze[2]=Wt.top,Ze[3]=1,s.a7.transformMat4(Ze,Ze,Ne),Ze[3]=Math.max(Ze[3],1e-5);const xr=new wc(Ze[0]/Ze[3],Ze[1]/Ze[3],Ze[2]/Ze[3]);Qt.push(Ur),Bt.push(xr)}Mt.push(Qt),_t.push(Bt)}return[Mt,_t]}(ne,re,ce,pe,ye,Te,xe,Se,Be):function(Oe,Me,Re,et,Ne){const gt=[],ht=[],je=Ne[8]*Me,kt=Ne[9]*Me,Mt=Ne[10]*Me,_t=Ne[11]*Me,Ze=Ne[8]*Re,Dt=Ne[9]*Re,Qt=Ne[10]*Re,Bt=Ne[11]*Re;for(const er of Oe){const Zt=[],hr=[];for(const Wt of er){const Ur=Wt.x+et.x,xr=Wt.y+et.y,br=Ne[0]*Ur+Ne[4]*xr+Ne[12],Ar=Ne[1]*Ur+Ne[5]*xr+Ne[13],vr=Ne[2]*Ur+Ne[6]*xr+Ne[14],Qr=Ne[3]*Ur+Ne[7]*xr+Ne[15],Rr=br+je,ui=Ar+kt,Ii=vr+Mt,Gi=Math.max(Qr+_t,1e-5),Yr=br+Ze,ni=Ar+Dt,Oi=vr+Qt,ki=Math.max(Qr+Bt,1e-5);Zt.push(new wc(Rr/Gi,ui/Gi,Ii/Gi)),hr.push(new wc(Yr/ki,ni/ki,Oi/ki))}gt.push(Zt),ht.push(hr)}return[gt,ht]}(ne,re,ce,pe,ye)}(l,n,b,x,_,h,O,T,P,l.center.lat,t.tileID.canonical),X=t.queryGeometry;return function(H,ne,re){let ce=1/0;Is(re,ne)&&(ce=Iy(re,ne[0]));for(let pe=0;pe<ne.length;pe++){const ye=ne[pe],Te=H[pe];for(let xe=0;xe<ye.length-1;xe++){const Se=ye[xe],Be=[Se,ye[xe+1],Te[xe+1],Te[xe],Se];oo(re,Be)&&(ce=Math.min(ce,Iy(re,Be)))}}return ce!==1/0&&ce}(F,$,X.isPointQuery()?X.screenBounds:X.screenGeometry)}},line:class extends ln{constructor(t,e,r){super(t,Sy,e,r),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(t){if(t==="line-gradient"){const e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof Za,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(t,e){super.recalculate(t,e),this.paint._values["line-floorwidth"]=Oy.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,t)}createBucket(t){return new Um(t)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(t,e){const r=zy(this);return{config:new R(this,e),defines:r,overrideFog:!1}}queryRadius(t){const e=t,r=ky(yc("line-width",this,e),yc("line-gap-width",this,e)),n=yc("line-offset",this,e);return r/2+Math.abs(n)+af(this.paint.get("line-translate"))}queryIntersectsFeature(t,e,r,n,a,l){if(t.queryGeometry.isAboveHorizon)return!1;const h=pg(t.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),l.angle,t.pixelToTileUnitsFactor),f=t.pixelToTileUnitsFactor/2*ky(this.paint.get("line-width").evaluate(e,r),this.paint.get("line-gap-width").evaluate(e,r)),m=this.paint.get("line-offset").evaluate(e,r);return m&&(n=function(_,x){const b=[],T=new Ge(0,0);for(let C=0;C<_.length;C++){const P=_[C],D=[];for(let O=0;O<P.length;O++){const F=P[O],$=P[O+1],X=O===0?T:F.sub(P[O-1])._unit()._perp(),H=O===P.length-1?T:$.sub(F)._unit()._perp(),ne=X._add(H)._unit();ne._mult(1/(ne.x*H.x+ne.y*H.y)),D.push(ne._mult(x)._add(F))}b.push(D)}return b}(n,m*t.pixelToTileUnitsFactor)),function(_,x,b){for(let T=0;T<x.length;T++){const C=x[T];if(_.length>=3){for(let P=0;P<C.length;P++)if(wo(_,C[P]))return!0}if(_l(_,C,b))return!0}return!1}(h,n,f)}isTileClipped(){return!0}},symbol:Zf,background:class extends ln{constructor(t,e,r){super(t,bT,e,r)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(t,e){return{overrideFog:!1}}},raster:b1,"raster-particle":w1,sky:class extends ln{constructor(t,e,r){super(t,ST,e,r),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(t){t==="sky-gradient"?this._updateColorRamp():t!=="sky-atmosphere-sun"&&t!=="sky-atmosphere-halo-color"&&t!=="sky-atmosphere-color"&&t!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=wh({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(t){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const e=t.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(t,e){if(this.paint.get("sky-type")==="atmosphere"){const n=this.paint.get("sky-atmosphere-sun"),a=!n,l=t.style.light,h=l.properties.get("position");return a&&l.properties.get("anchor")==="viewport"&&li("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),a?r_(h.azimuthal,90-h.polar,e):r_(n[0],90-n[1],e)}const r=this.paint.get("sky-gradient-center");return r_(r[0],90-r[1],e)}isSky(){return!0}markSkyboxValid(t){this._skyboxInvalidated=!1,this._lightPosition=t.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const t=this.paint.get("sky-type");return t==="atmosphere"?["skyboxCapture","skybox"]:t==="gradient"?["skyboxGradient"]:null}},slot:class extends ln{constructor(t,e,r){super(t,PT,e)}},model:class extends ln{constructor(t,e,r){super(t,NT,e,r),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(t){return new n_(t)}getProgramIds(){return["model"]}is3D(){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(t){return t instanceof ep?ct-1:0}queryIntersectsFeature(t,e,r,n,a,l){if(!this.modelManager)return!1;const h=this.modelManager,f=t.tile.getBucket(this);if(!(f&&f instanceof n_))return!1;const m=f;for(const _ in m.instancesPerModel){const x=m.instancesPerModel[_];if(x.idToFeaturesIndex.hasOwnProperty(e.id)){const b=x.features[x.idToFeaturesIndex[e.id]],T=h.getModel(_,this.scope);if(!T)return!1;let C=s.a6.create();const P=new ge(0,0),D=m.canonical;let O=Number.MAX_VALUE;for(let F=0;F<b.instancedDataCount;++F){const $=16*(b.instancedDataOffset+F),X=x.instancedDataArray.float32,H=[X[$+4],X[$+5],X[$+6]];J1(D,P,X[$],0|X[$+1]),L1(C,T,l,P,b.rotation,b.scale,H,!1,!1,!1),l.projection.name==="globe"&&(C=i_(C,l));const ne=s.a6.multiply([],l.projMatrix,C),re=t.queryGeometry,ce=A1(re.isPointQuery()?re.screenBounds:re.screenGeometry,l,ne,T.aabb);ce!=null&&(O=Math.min(ce,O))}return O!==Number.MAX_VALUE&&O}}return!1}_handleOverridablePaintPropertyUpdate(t,e,r){return!(!this.layout||e.isDataDriven()||r.isDataDriven()||t!=="model-color"&&t!=="model-color-mix-intensity"&&t!=="model-rotation"&&t!=="model-scale"&&t!=="model-translation"&&t!=="model-emissive-strength")}_isPropertyZoomDependent(t){const e=this._transitionablePaint._values[t];return e!=null&&e.value!=null&&e.value.expression!=null&&e.value.expression instanceof Ha}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}queryIntersectsMatchingFeature(t,e,r,n){const a=t.tile,l=a.getBucket(this);let h=null,f=Number.MAX_VALUE;if(!(l&&l instanceof ep))return{queryFeature:h,intersectionZ:f};const m=l.getNodesInfo()[e];if(m.hiddenByReplacement||!m.node.meshes||!r.filter(new ei(a.tileID.overscaledZ),m.feature,a.tileID.canonical))return{queryFeature:h,intersectionZ:f};const _=m.node,x=n.calculatePosMatrix(a.tileID.toUnwrapped(),n.worldSize),b=m.evaluatedScale;let T=0;n.elevation&&_.elevation&&(T=_.elevation*n.elevation.exaggeration()),s.a6.translate(x,x,[(_.anchor?_.anchor[0]:0)*(b[0]-1),(_.anchor?_.anchor[1]:0)*(b[1]-1),T]),s.a6.scale(x,x,b),s.a6.multiply(x,x,_.matrix);const C=t.queryGeometry,P=C.isPointQuery()?C.screenBounds:C.screenGeometry,D=function(F){const $=s.a6.multiply([],x,F.matrix),X=s.a6.multiply($,n.expandedFarZProjMatrix,$);for(let H=0;H<F.meshes.length;++H){const ne=F.meshes[H];if(H===F.lightMeshIndex)continue;const re=A1(P,n,X,ne.aabb);re!=null&&(f=Math.min(re,f))}if(F.children)for(const H of F.children)D(H)};if(D(_),f===Number.MAX_VALUE)return{queryFeature:h,intersectionZ:f};const O=new ge(0,0);return J1(a.tileID.canonical,O,m.node.anchor[0],m.node.anchor[1]),h={type:"Feature",geometry:{type:"Point",coordinates:[O.lng,O.lat]},properties:m.feature.properties,id:m.feature.id,state:{},layer:this.serialize()},{queryFeature:h,intersectionZ:f}}}},Xt={read:function(t,e){return t.readFields(Xt._readField,{header_length:0,x:0,y:0,z:0,layers:[]},e)},_readField:function(t,e,r){t===1?e.header_length=r.readFixed32():t===2?e.x=r.readVarint():t===3?e.y=r.readVarint():t===4?e.z=r.readVarint():t===5&&e.layers.push(Xt.Layer.read(r,r.readVarint()+r.pos))},PixelFormat:{PIXEL_FORMAT_UNKNOWN:{value:0,options:{}},PIXEL_FORMAT_UINT32:{value:1,options:{}},PIXEL_FORMAT_UINT16:{value:2,options:{}},PIXEL_FORMAT_UINT8:{value:3,options:{}}},Filter:{}};Xt.Filter.read=function(t,e){return t.readFields(Xt.Filter._readField,{delta_filter:null,filter:null,zigzag_filter:null,bitshuffle_filter:null,byteshuffle_filter:null},e)},Xt.Filter._readField=function(t,e,r){t===1?(e.delta_filter=Xt.Filter.Delta.read(r,r.readVarint()+r.pos),e.filter="delta_filter"):t===2?(e.zigzag_filter=Xt.Filter.Zigzag.read(r,r.readVarint()+r.pos),e.filter="zigzag_filter"):t===3?(e.bitshuffle_filter=Xt.Filter.BitShuffle.read(r,r.readVarint()+r.pos),e.filter="bitshuffle_filter"):t===4&&(e.byteshuffle_filter=Xt.Filter.ByteShuffle.read(r,r.readVarint()+r.pos),e.filter="byteshuffle_filter")},Xt.Filter.Delta={},Xt.Filter.Delta.read=function(t,e){return t.readFields(Xt.Filter.Delta._readField,{block_size:0},e)},Xt.Filter.Delta._readField=function(t,e,r){t===1&&(e.block_size=r.readVarint())},Xt.Filter.Zigzag={},Xt.Filter.Zigzag.read=function(t,e){return t.readFields(Xt.Filter.Zigzag._readField,{},e)},Xt.Filter.Zigzag._readField=function(t,e,r){},Xt.Filter.BitShuffle={},Xt.Filter.BitShuffle.read=function(t,e){return t.readFields(Xt.Filter.BitShuffle._readField,{},e)},Xt.Filter.BitShuffle._readField=function(t,e,r){},Xt.Filter.ByteShuffle={},Xt.Filter.ByteShuffle.read=function(t,e){return t.readFields(Xt.Filter.ByteShuffle._readField,{},e)},Xt.Filter.ByteShuffle._readField=function(t,e,r){},Xt.Codec={},Xt.Codec.read=function(t,e){return t.readFields(Xt.Codec._readField,{gzip_data:null,codec:null,jpeg_image:null,webp_image:null,png_image:null},e)},Xt.Codec._readField=function(t,e,r){t===1?(e.gzip_data=Xt.Codec.GzipData.read(r,r.readVarint()+r.pos),e.codec="gzip_data"):t===2?(e.jpeg_image=Xt.Codec.JpegImage.read(r,r.readVarint()+r.pos),e.codec="jpeg_image"):t===3?(e.webp_image=Xt.Codec.WebpImage.read(r,r.readVarint()+r.pos),e.codec="webp_image"):t===4&&(e.png_image=Xt.Codec.PngImage.read(r,r.readVarint()+r.pos),e.codec="png_image")},Xt.Codec.GzipData={},Xt.Codec.GzipData.read=function(t,e){return t.readFields(Xt.Codec.GzipData._readField,{},e)},Xt.Codec.GzipData._readField=function(t,e,r){},Xt.Codec.JpegImage={},Xt.Codec.JpegImage.read=function(t,e){return t.readFields(Xt.Codec.JpegImage._readField,{},e)},Xt.Codec.JpegImage._readField=function(t,e,r){},Xt.Codec.WebpImage={},Xt.Codec.WebpImage.read=function(t,e){return t.readFields(Xt.Codec.WebpImage._readField,{},e)},Xt.Codec.WebpImage._readField=function(t,e,r){},Xt.Codec.PngImage={},Xt.Codec.PngImage.read=function(t,e){return t.readFields(Xt.Codec.PngImage._readField,{},e)},Xt.Codec.PngImage._readField=function(t,e,r){},Xt.DataIndexEntry={},Xt.DataIndexEntry.read=function(t,e){return t.readFields(Xt.DataIndexEntry._readField,{first_byte:0,last_byte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},e)},Xt.DataIndexEntry._readField=function(t,e,r){t===1?e.first_byte=r.readFixed64():t===2?e.last_byte=r.readFixed64():t===3?e.filters.push(Xt.Filter.read(r,r.readVarint()+r.pos)):t===4?e.codec=Xt.Codec.read(r,r.readVarint()+r.pos):t===5?e.offset=r.readFloat():t===6?e.scale=r.readFloat():t===7&&e.bands.push(r.readString())},Xt.Layer={},Xt.Layer.read=function(t,e){return t.readFields(Xt.Layer._readField,{version:0,name:"",units:"",tilesize:0,buffer:0,pixel_format:0,data_index:[]},e)},Xt.Layer._readField=function(t,e,r){t===1?e.version=r.readVarint():t===2?e.name=r.readString():t===3?e.units=r.readString():t===4?e.tilesize=r.readVarint():t===5?e.buffer=r.readVarint():t===6?e.pixel_format=r.readVarint():t===7&&e.data_index.push(Xt.DataIndexEntry.read(r,r.readVarint()+r.pos))};const Ao={read:function(t,e){return t.readFields(Ao._readField,{uint32_values:null,values:null,fixed32_values:null},e)},_readField:function(t,e,r){t===2?(e.uint32_values=Ao.Uint32Values.read(r,r.readVarint()+r.pos),e.values="uint32_values"):t===3&&(e.fixed32_values=Ao.Fixed32Values.read(r,r.readVarint()+r.pos),e.values="fixed32_values")},Uint32Values:{}};Ao.Uint32Values.read=function(t,e){return t.readFields(Ao.Uint32Values._readField,{values:[]},e)},Ao.Uint32Values._readField=function(t,e,r){t===1&&(e.readValuesInto=function(n){if(n.type!==2)throw new Error(`Unsupported pbf type "${n.type}"`);const a=function(h){return h.type===2?h.readVarint()+h.pos:h.pos+1}(n),l=n.pos;return n.pos=a,function(h){n.pos=l;let f=0;for(;n.pos<a;){const m=n.readVarint();h[f++]=m}return h}}(r))},Ao.Fixed32Values={},Ao.Fixed32Values.read=function(t,e){return t.readFields(Ao.Fixed32Values._readField,{values:[]},e)},Ao.Fixed32Values._readField=function(t,e,r){throw new Error("Not implemented")};/**
 * tiny-lru
 *
 * @copyright 2023 Jason Mulligan <jason.mulligan@avoidwork.com>
 * @license BSD-3-Clause
 * @version 11.2.5
 */class sE{constructor(e=0,r=0,n=!1){this.first=null,this.items=Object.create(null),this.last=null,this.max=e,this.resetTtl=n,this.size=0,this.ttl=r}clear(){return this.first=null,this.items=Object.create(null),this.last=null,this.size=0,this}delete(e){if(this.has(e)){const r=this.items[e];delete this.items[e],this.size--,r.prev!==null&&(r.prev.next=r.next),r.next!==null&&(r.next.prev=r.prev),this.first===r&&(this.first=r.next),this.last===r&&(this.last=r.prev)}return this}entries(e=this.keys()){return e.map(r=>[r,this.get(r)])}evict(e=!1){if(e||this.size>0){const r=this.first;delete this.items[r.key],--this.size==0?(this.first=null,this.last=null):(this.first=r.next,this.first.prev=null)}return this}expiresAt(e){let r;return this.has(e)&&(r=this.items[e].expiry),r}get(e){let r;if(this.has(e)){const n=this.items[e];this.ttl>0&&n.expiry<=Date.now()?this.delete(e):(r=n.value,this.set(e,r,!0))}return r}has(e){return e in this.items}keys(){const e=[];let r=this.first;for(;r!==null;)e.push(r.key),r=r.next;return e}set(e,r,n=!1,a=this.resetTtl){let l;if(n||this.has(e)){if(l=this.items[e],l.value=r,n===!1&&a&&(l.expiry=this.ttl>0?Date.now()+this.ttl:this.ttl),this.last!==l){const h=this.last,f=l.next,m=l.prev;this.first===l&&(this.first=l.next),l.next=null,l.prev=this.last,h.next=l,m!==null&&(m.next=f),f!==null&&(f.prev=m)}}else this.max>0&&this.size===this.max&&this.evict(!0),l=this.items[e]={expiry:this.ttl>0?Date.now()+this.ttl:this.ttl,key:e,prev:this.last,next:null,value:r},++this.size==1?this.first=l:this.last.next=l;return this.last=l,this}values(e=this.keys()){return e.map(r=>this.get(r))}}function aE(t,e){if(e.length!==4)throw new Error(`Expected data of dimension 4 but got ${e.length}.`);let r=e[3];for(let n=2;n>=1;n--){const a=n===1?1:0,l=n===2?1:0;for(let h=0;h<e[0];h++){const f=e[1]*h;for(let m=a;m<e[1];m++){const _=e[2]*(m+f);for(let x=l;x<e[2];x++){const b=e[3]*(x+_);for(let T=0;T<e[3];T++){const C=b+T;t[C]+=t[C-r]}}}}r*=e[n]}return t}function lE(t){for(let e=0,r=t.length;e<r;e++)t[e]=t[e]>>>1^-(1&t[e]);return t}function cE(t,e){switch(e){case"uint32":return t;case"uint16":for(let r=0;r<t.length;r+=2){const n=t[r],a=t[r+1];t[r]=(240&n)>>4|(61440&n)>>8|(240&a)<<4|61440&a,t[r+1]=15&n|(3840&n)>>4|(15&a)<<8|(3840&a)<<4}return t;case"uint8":for(let r=0;r<t.length;r+=4){const n=t[r],a=t[r+1],l=t[r+2],h=t[r+3];t[r+0]=(192&n)>>6|(192&a)>>4|(192&l)>>2|192&h,t[r+1]=(48&n)>>4|(48&a)>>2|48&l|(48&h)<<2,t[r+2]=(12&n)>>2|12&a|(12&l)<<2|(12&h)<<4,t[r+3]=3&n|(3&a)<<2|(3&l)<<4|(3&h)<<6}return t;default:throw new Error(`Invalid pixel format, "${e}"`)}}class wa extends Error{constructor(e){super(e),this.name="MRTError"}}var Kn=Uint8Array,Oc=Uint16Array,uE=Int32Array,Q1=new Kn([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),ex=new Kn([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),hE=new Kn([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),tx=function(t,e){for(var r=new Oc(31),n=0;n<31;++n)r[n]=e+=1<<t[n-1];var a=new uE(r[30]);for(n=1;n<30;++n)for(var l=r[n];l<r[n+1];++l)a[l]=l-r[n]<<5|n;return{b:r,r:a}},rx=tx(Q1,2),ix=rx.b,dE=rx.r;ix[28]=258,dE[258]=28;for(var fE=tx(ex,0).b,f_=new Oc(32768),_i=0;_i<32768;++_i){var kc=(43690&_i)>>1|(21845&_i)<<1;f_[_i]=((65280&(kc=(61680&(kc=(52428&kc)>>2|(13107&kc)<<2))>>4|(3855&kc)<<4))>>8|(255&kc)<<8)>>1}var Gh=function(t,e,r){for(var n=t.length,a=0,l=new Oc(e);a<n;++a)t[a]&&++l[t[a]-1];var h,f=new Oc(e);for(a=1;a<e;++a)f[a]=f[a-1]+l[a-1]<<1;if(r){h=new Oc(1<<e);var m=15-e;for(a=0;a<n;++a)if(t[a])for(var _=a<<4|t[a],x=e-t[a],b=f[t[a]-1]++<<x,T=b|(1<<x)-1;b<=T;++b)h[f_[b]>>m]=_}else for(h=new Oc(n),a=0;a<n;++a)t[a]&&(h[a]=f_[f[t[a]-1]++]>>15-t[a]);return h},$h=new Kn(288);for(_i=0;_i<144;++_i)$h[_i]=8;for(_i=144;_i<256;++_i)$h[_i]=9;for(_i=256;_i<280;++_i)$h[_i]=7;for(_i=280;_i<288;++_i)$h[_i]=8;var nx=new Kn(32);for(_i=0;_i<32;++_i)nx[_i]=5;var pE=Gh($h,9,1),mE=Gh(nx,5,1),p_=function(t){for(var e=t[0],r=1;r<t.length;++r)t[r]>e&&(e=t[r]);return e},So=function(t,e,r){var n=e/8|0;return(t[n]|t[n+1]<<8)>>(7&e)&r},m_=function(t,e){var r=e/8|0;return(t[r]|t[r+1]<<8|t[r+2]<<16)>>(7&e)},_E=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Po=function(t,e,r){var n=new Error(e||_E[t]);if(n.code=t,Error.captureStackTrace&&Error.captureStackTrace(n,Po),!r)throw n;return n},gE=new Kn(0),yE=typeof TextDecoder<"u"&&new TextDecoder;try{yE.decode(gE,{stream:!0})}catch{}const xE={gzip_data:"gzip"},vE={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},bE={uint32:1,uint16:2,uint8:4},wE={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};class ox{constructor(e=1){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=e}getLayer(e){return this.layers[e]}getHeaderLength(e){const r=new Uint8Array(e),n=new DataView(e);if(r[0]!==13)throw new wa("File is not a valid MRT.");return n.getUint32(1,!0)}parseHeader(e){const r=new Uint8Array(e),n=this.getHeaderLength(e);if(r.length<n)throw new wa(`Expected header with length >= ${n} but got buffer of length ${r.length}`);const a=new Ic(r.subarray(0,n)),l=Xt.read(a);if(!isNaN(this.x)&&(this.x!==l.x||this.y!==l.y||this.z!==l.z))throw new wa(`Invalid attempt to parse header ${l.z}/${l.x}/${l.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=l.x,this.y=l.y,this.z=l.z;for(const h of l.layers)this.layers[h.name]=new TE(h,{cacheSize:this._cacheSize});return this}createDecodingTask(e){const r=[],n=this.getLayer(e.layerName);for(let a=0;a<n.dataIndex.length;a++){const l=n.dataIndex[a],h=l.first_byte-e.firstByte,f=l.last_byte+1-e.firstByte;if(a<e.firstBlock||a>e.lastBlock||n._blocksInProgress.has(a))continue;const m={layerName:n.name,firstByte:h,lastByte:f,pixelFormat:n.pixelFormat,blockIndex:a,blockShape:[l.bands.length].concat(n.bandShape),buffer:n.buffer,codec:l.codec.codec,filters:l.filters.map(_=>_.filter)};n._blocksInProgress.add(a),r.push(m)}return new sx(r,()=>{r.forEach(a=>n._blocksInProgress.delete(a.blockIndex))},(a,l)=>{if(r.forEach(h=>n._blocksInProgress.delete(h.blockIndex)),a)throw a;l.forEach(h=>{this.getLayer(h.layerName).processDecodedData(h)})})}}class TE{constructor({version:e,name:r,units:n,tilesize:a,pixel_format:l,buffer:h,data_index:f},m){if(this.version=e,this.version!==1)throw new wa(`Cannot parse raster layer encoded with MRT version ${e}`);this.name=r,this.units=n,this.tileSize=a,this.buffer=h,this.pixelFormat=vE[l],this.dataIndex=f,this.bandShape=[a+2*h,a+2*h,bE[this.pixelFormat]],this._decodedBlocks=function(_=1e3,x=0,b=!1){if(isNaN(_)||_<0)throw new TypeError("Invalid max value");if(isNaN(x)||x<0)throw new TypeError("Invalid ttl value");if(typeof b!="boolean")throw new TypeError("Invalid resetTtl value");return new sE(_,x,b)}(m?m.cacheSize:5),this._blocksInProgress=new Set}processDecodedData(e){const r=e.blockIndex.toString();this._decodedBlocks.get(r)||this._decodedBlocks.set(r,e.data)}getBlockForBand(e){let r=0;switch(typeof e){case"string":for(const[n,a]of this.dataIndex.entries()){for(const[l,h]of a.bands.entries())if(h===e)return{bandIndex:r+l,blockIndex:n,blockBandIndex:l};r+=a.bands.length}break;case"number":for(const[n,a]of this.dataIndex.entries()){if(e>=r&&e<r+a.bands.length)return{bandIndex:e,blockIndex:n,blockBandIndex:e-r};r+=a.bands.length}break;default:throw new wa(`Invalid band \`${JSON.stringify(e)}\`. Expected string or integer.`)}throw new wa(`Band not found: ${JSON.stringify(e)}`)}getDataRange(e){let r=1/0,n=-1/0,a=1/0,l=-1/0;for(const h of e){const{blockIndex:f}=this.getBlockForBand(h);if(f<0)throw new wa(`Invalid band: ${JSON.stringify(h)}`);const m=this.dataIndex[f];a=Math.min(a,f),l=Math.max(l,f),r=Math.min(r,m.first_byte),n=Math.max(n,m.last_byte)}return{layerName:this.name,firstByte:r,lastByte:n,firstBlock:a,lastBlock:l}}hasBand(e){const{blockIndex:r}=this.getBlockForBand(e);return r>=0}hasDataForBand(e){const{blockIndex:r}=this.getBlockForBand(e);return r>=0&&!!this._decodedBlocks.get(r.toString())}getBandView(e){const{blockIndex:r,blockBandIndex:n}=this.getBlockForBand(e),a=this._decodedBlocks.get(r.toString());if(!a)throw new wa(`Data for band ${JSON.stringify(e)} of layer "${this.name}" not decoded.`);const l=this.dataIndex[r],h=this.bandShape.reduce((_,x)=>_*x,1),f=n*h,m=a.subarray(f,f+h);return{data:m,bytes:new Uint8Array(m.buffer).subarray(m.byteOffset,m.byteOffset+m.byteLength),tileSize:this.tileSize,buffer:this.buffer,offset:l.offset,scale:l.scale}}}class sx{constructor(e,r,n){this.tasks=e,this._onCancel=r,this._onComplete=n,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(e,r){this._finalized||(this._onComplete(e,r),this._finalized=!0)}}ox.performDecoding=function(t,e){return Promise.all(e.tasks.map(r=>{const{layerName:n,firstByte:a,lastByte:l,pixelFormat:h,blockShape:f,blockIndex:m,filters:_,codec:x}=r,b=new Uint8Array(t).subarray(a,l+1),T=new Uint32Array(f[0]*f[1]*f[2]);let C;if(x!=="gzip_data")throw new Error(`Unhandled codec: ${x}`);return C=function(P,D){if(!globalThis.DecompressionStream&&D==="gzip_data")return Promise.resolve(((X=function(re){re[0]==31&&re[1]==139&&re[2]==8||Po(6,"invalid gzip data");var ce=re[3],pe=10;4&ce&&(pe+=2+(re[10]|re[11]<<8));for(var ye=(ce>>3&1)+(ce>>4&1);ye>0;ye-=!re[pe++]);return pe+(2&ce)}($=P))+8>$.length&&Po(6,"invalid gzip data"),function(re,ce,pe,ye){var Te=re.length;if(!Te||ce.f&&!ce.l)return pe||new Kn(0);var xe=!pe,Se=xe||ce.i!=2,Be=ce.i;xe&&(pe=new Kn(3*Te));var Ce=function(dn){var rn=pe.length;if(dn>rn){var Jn=new Kn(Math.max(2*rn,dn));Jn.set(pe),pe=Jn}},Oe=ce.f||0,Me=ce.p||0,Re=ce.b||0,et=ce.l,Ne=ce.d,gt=ce.m,ht=ce.n,je=8*Te;do{if(!et){Oe=So(re,Me,1);var kt=So(re,Me+1,3);if(Me+=3,!kt){var Mt=re[(xr=4+((Me+7)/8|0))-4]|re[xr-3]<<8,_t=xr+Mt;if(_t>Te){Be&&Po(0);break}Se&&Ce(Re+Mt),pe.set(re.subarray(xr,_t),Re),ce.b=Re+=Mt,ce.p=Me=8*_t,ce.f=Oe;continue}if(kt==1)et=pE,Ne=mE,gt=9,ht=5;else if(kt==2){var Ze=So(re,Me,31)+257,Dt=So(re,Me+10,15)+4,Qt=Ze+So(re,Me+5,31)+1;Me+=14;for(var Bt=new Kn(Qt),er=new Kn(19),Zt=0;Zt<Dt;++Zt)er[hE[Zt]]=So(re,Me+3*Zt,7);Me+=3*Dt;var hr=p_(er),Wt=(1<<hr)-1,Ur=Gh(er,hr,1);for(Zt=0;Zt<Qt;){var xr,br=Ur[So(re,Me,Wt)];if(Me+=15&br,(xr=br>>4)<16)Bt[Zt++]=xr;else{var Ar=0,vr=0;for(xr==16?(vr=3+So(re,Me,3),Me+=2,Ar=Bt[Zt-1]):xr==17?(vr=3+So(re,Me,7),Me+=3):xr==18&&(vr=11+So(re,Me,127),Me+=7);vr--;)Bt[Zt++]=Ar}}var Qr=Bt.subarray(0,Ze),Rr=Bt.subarray(Ze);gt=p_(Qr),ht=p_(Rr),et=Gh(Qr,gt,1),Ne=Gh(Rr,ht,1)}else Po(1);if(Me>je){Be&&Po(0);break}}Se&&Ce(Re+131072);for(var ui=(1<<gt)-1,Ii=(1<<ht)-1,Gi=Me;;Gi=Me){var Yr=(Ar=et[m_(re,Me)&ui])>>4;if((Me+=15&Ar)>je){Be&&Po(0);break}if(Ar||Po(2),Yr<256)pe[Re++]=Yr;else{if(Yr==256){Gi=Me,et=null;break}var ni=Yr-254;Yr>264&&(ni=So(re,Me,(1<<(Bi=Q1[Zt=Yr-257]))-1)+ix[Zt],Me+=Bi);var Oi=Ne[m_(re,Me)&Ii],ki=Oi>>4;if(Oi||Po(3),Me+=15&Oi,Rr=fE[ki],ki>3){var Bi=ex[ki];Rr+=m_(re,Me)&(1<<Bi)-1,Me+=Bi}if(Me>je){Be&&Po(0);break}Se&&Ce(Re+131072);var $r=Re+ni;if(Re<Rr){var Dn=0-Rr,Ta=Math.min(Rr,$r);for(Dn+Re<0&&Po(3);Re<Ta;++Re)pe[Re]=ye[Dn+Re]}for(;Re<$r;++Re)pe[Re]=pe[Re-Rr]}}ce.l=et,ce.p=Gi,ce.b=Re,ce.f=Oe,et&&(Oe=1,ce.m=gt,ce.d=Ne,ce.n=ht)}while(!Oe);return Re!=pe.length&&xe?function(dn,rn,Jn){return(rn==null||rn<0)&&(rn=0),(Jn==null||Jn>dn.length)&&(Jn=dn.length),new Kn(dn.subarray(rn,Jn))}(pe,0,Re):pe.subarray(0,Re)}($.subarray(X,-8),{i:2},new Kn(((O=$)[(F=O.length)-4]|O[F-3]<<8|O[F-2]<<16|O[F-1]<<24)>>>0),void 0)));var O,F,$,X;const H=xE[D];if(!H)throw new Error(`Unhandled codec: ${D}`);const ne=new globalThis.DecompressionStream(H);return new Response(new Blob([P]).stream().pipeThrough(ne)).arrayBuffer().then(re=>new Uint8Array(re))}(b,x).then(P=>{const D=Ao.read(new Ic(P));if(D.values==="uint32_values")return D.uint32_values.readValuesInto(T),new wE[h](T.buffer);throw new Error(`Unhandled numeric data "${D.values}"`)}),C.then(P=>{for(let D=_.length-1;D>=0;D--)switch(_[D]){case"delta_filter":aE(P,f);break;case"zigzag_filter":lE(P);break;case"bitshuffle_filter":cE(P,h);break;default:throw new Error(`Unhandled filter "${_[D]}"`)}return{layerName:n,blockIndex:m,data:P}}).catch(P=>{throw P})}))},mt(sx,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]});const ax=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class __{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[r,n]=new Uint8Array(e,0,2);if(r!==219)throw new Error("Data does not appear to be in a KDBush format.");const a=n>>4;if(a!==1)throw new Error(`Got v${a} data when expected v1.`);const l=ax[15&n];if(!l)throw new Error("Unrecognized array type.");const[h]=new Uint16Array(e,2,1),[f]=new Uint32Array(e,4,1);return new __(f,h,l,e)}constructor(e,r=64,n=Float64Array,a){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+r,2),65535),this.ArrayType=n,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const l=ax.indexOf(this.ArrayType),h=2*e*this.ArrayType.BYTES_PER_ELEMENT,f=e*this.IndexArrayType.BYTES_PER_ELEMENT,m=(8-f%8)%8;if(l<0)throw new Error(`Unexpected typed array class: ${n}.`);a&&a instanceof ArrayBuffer?(this.data=a,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+f+m,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+h+f+m),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+f+m,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+l]),new Uint16Array(this.data,2,1)[0]=r,new Uint32Array(this.data,4,1)[0]=e)}add(e,r){const n=this._pos>>1;return this.ids[n]=n,this.coords[this._pos++]=e,this.coords[this._pos++]=r,n}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return g_(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,r,n,a){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:l,coords:h,nodeSize:f}=this,m=[0,l.length-1,0],_=[];for(;m.length;){const x=m.pop()||0,b=m.pop()||0,T=m.pop()||0;if(b-T<=f){for(let O=T;O<=b;O++){const F=h[2*O],$=h[2*O+1];F>=e&&F<=n&&$>=r&&$<=a&&_.push(l[O])}continue}const C=T+b>>1,P=h[2*C],D=h[2*C+1];P>=e&&P<=n&&D>=r&&D<=a&&_.push(l[C]),(x===0?e<=P:r<=D)&&(m.push(T),m.push(C-1),m.push(1-x)),(x===0?n>=P:a>=D)&&(m.push(C+1),m.push(b),m.push(1-x))}return _}within(e,r,n){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:a,coords:l,nodeSize:h}=this,f=[0,a.length-1,0],m=[],_=n*n;for(;f.length;){const x=f.pop()||0,b=f.pop()||0,T=f.pop()||0;if(b-T<=h){for(let O=T;O<=b;O++)cx(l[2*O],l[2*O+1],e,r)<=_&&m.push(a[O]);continue}const C=T+b>>1,P=l[2*C],D=l[2*C+1];cx(P,D,e,r)<=_&&m.push(a[C]),(x===0?e-n<=P:r-n<=D)&&(f.push(T),f.push(C-1),f.push(1-x)),(x===0?e+n>=P:r+n>=D)&&(f.push(C+1),f.push(b),f.push(1-x))}return m}}function g_(t,e,r,n,a,l){if(a-n<=r)return;const h=n+a>>1;lx(t,e,h,n,a,l),g_(t,e,r,n,h-1,1-l),g_(t,e,r,h+1,a,1-l)}function lx(t,e,r,n,a,l){for(;a>n;){if(a-n>600){const _=a-n+1,x=r-n+1,b=Math.log(_),T=.5*Math.exp(2*b/3),C=.5*Math.sqrt(b*T*(_-T)/_)*(x-_/2<0?-1:1);lx(t,e,r,Math.max(n,Math.floor(r-x*T/_+C)),Math.min(a,Math.floor(r+(_-x)*T/_+C)),l)}const h=e[2*r+l];let f=n,m=a;for(qh(t,e,n,r),e[2*a+l]>h&&qh(t,e,n,a);f<m;){for(qh(t,e,f,m),f++,m--;e[2*f+l]<h;)f++;for(;e[2*m+l]>h;)m--}e[2*n+l]===h?qh(t,e,n,m):(m++,qh(t,e,m,a)),m<=r&&(n=m+1),r<=m&&(a=m-1)}}function qh(t,e,r,n){y_(t,r,n),y_(e,2*r,2*n),y_(e,2*r+1,2*n+1)}function y_(t,e,r){const n=t[e];t[e]=t[r],t[r]=n}function cx(t,e,r,n){const a=t-r,l=e-n;return a*a+l*l}s.$=d1,s.A=rc,s.B=Uu,s.C=dr,s.D=be,s.E=Vs,s.F=ti,s.G=Je,s.H=class{constructor(t){this.specification=t}possiblyEvaluate(t,e){return ho(t.expression.evaluate(e))}interpolate(t,e,r){return{x:ur(t.x,e.x,r),y:ur(t.y,e.y,r),z:ur(t.z,e.z,r),azimuthal:ur(t.azimuthal,e.azimuthal,r),polar:ur(t.polar,e.polar,r)}}},s.I=qm,s.J=xo,s.K=ei,s.L=gr,s.M=class{constructor(t,e,r,n){this.id=t,this.position=e!=null?new ge(e[0],e[1]):new ge(0,0),this.orientation=r??[0,0,0],this.nodes=n,this.uploaded=!1,this.aabb=new ai([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(t,e){if(s.a6.multiply(t.matrix,e,t.matrix),t.meshes)for(const r of t.meshes){const n=ai.applyTransform(r.aabb,t.matrix);this.aabb.encapsulate(n)}if(t.children)for(const r of t.children)this._applyTransformations(r,t.matrix)}computeBoundsAndApplyParent(){const t=s.a6.identity([]);for(const e of this.nodes)this._applyTransformations(e,t)}computeModelMatrix(t,e,r,n,a,l,h=!1){L1(this.matrix,this,t.transform,this.position,e,r,n,a,l,h)}upload(t){if(!this.uploaded){for(const e of this.nodes)o_(e,t);for(const e of this.nodes)Xf(e);this.uploaded=!0}}destroy(){for(const t of this.nodes)s_(t)}},s.O=Ei,s.P=Ge,s.Q=Ja,s.R=nn,s.S=fa,s.T=t_,s.U=ur,s.V=ct,s.W=ud,s.X=class{constructor(t){this.specification=t}possiblyEvaluate(t,e){return function([r,n]){const a=ho([1,r,n]);return{x:a.x,y:a.y,z:a.z}}(t.expression.evaluate(e))}interpolate(t,e,r){return{x:ur(t.x,e.x,r),y:ur(t.y,e.y,r),z:ur(t.z,e.z,r)}}},s.Y=function(t,e,r=0,n=!0){const a=new Ge(r,r),l=t.sub(a),h=e.add(a),f=[l,new Ge(h.x,l.y),h,new Ge(l.x,h.y)];return n&&f.push(l.clone()),f},s.Z=Ha,s._=function(t,e){const r=[];for(let n=0;n<t.length;n++){const a=mn(n-1,-1,t.length-1),l=mn(n+1,-1,t.length-1),h=t[n],f=t[l],m=t[a].sub(h).unit(),_=f.sub(h).unit(),x=_.angleWithSep(m.x,m.y),b=m.add(_).unit().mult(-1*e/Math.sin(x/2));r.push(h.add(b))}return r},s.a=Wc,s.a$=function(t){const e=[];for(const r in t)e.push(t[r]);return e},s.a0=fg,s.a1=function(t,e,r=0){return s.N.fromValues(((e.x-r)*t.scale-t.x)*ct,(e.y*t.scale-t.y)*ct,Vr(e.z,e.y))},s.a2=bm,s.a3=Py,s.a4=function(t){let e=1/0,r=1/0,n=-1/0,a=-1/0;for(const l of t)e=Math.min(e,l.x),r=Math.min(r,l.y),n=Math.max(n,l.x),a=Math.max(a,l.y);return{min:new Ge(e,r),max:new Ge(n,a)}},s.a5=Yt,s.a8=wo,s.a9=Tr,s.aA=Ad,s.aB=ci,s.aC=eo,s.aD=Gd,s.aE=jf,s.aF=function(){vn.isLoading()||vn.isLoaded()||Xo()!=="deferred"||Ju()},s.aG=bn,s.aH=wi,s.aI=$1,s.aJ=us,s.aK=Um,s.aL=Bm,s.aM=Li,s.aN=qn,s.aO=dh,s.aP=D0,s.aQ=vf,s.aR=e_,s.aS=function(t,e){const r=fa(e.zoom);if(r===0)return is(t);const n=ff(t),a=Mm(n),l=Yt(n.getWest())*e.worldSize,h=Yt(n.getEast())*e.worldSize,f=Vt(n.getNorth())*e.worldSize,m=Vt(n.getSouth())*e.worldSize,_=[l,f,0],x=[h,f,0],b=[l,m,0],T=[h,m,0],C=s.a6.invert([],e.globeMatrix);return s.N.transformMat4(_,_,C),s.N.transformMat4(x,x,C),s.N.transformMat4(b,b,C),s.N.transformMat4(T,T,C),a[0]=Ls(a[0],b,r),a[1]=Ls(a[1],T,r),a[2]=Ls(a[2],x,r),a[3]=Ls(a[3],_,r),ai.fromPoints(a)},s.aT=mf,s.aU=bh,s.aV=Ls,s.aW=en,s.aX=yb,s.aY=Nn,s.aZ=ox,s.a_=ze,s.aa=Ut,s.ab=q,s.ac=function(t,e){const r={};for(let n=0;n<e.length;n++){const a=e[n];a in t&&(r[a]=t[a])}return r},s.ad=Ee,s.ae=Vt,s.af=class{constructor(t){this.entries={},this.scheduler=t}request(t,e,r,n){const a=this.entries[t]=this.entries[t]||{callbacks:[]};if(a.result){const[l,h]=a.result;return this.scheduler?this.scheduler.add(()=>{n(l,h)},e):n(l,h),()=>{}}return a.callbacks.push(n),a.cancel||(a.cancel=r((l,h)=>{a.result=[l,h];for(const f of a.callbacks)this.scheduler?this.scheduler.add(()=>{f(l,h)},e):f(l,h);setTimeout(()=>delete this.entries[t],3e3)})),()=>{a.result||(a.callbacks=a.callbacks.filter(l=>l!==n),a.callbacks.length||(a.cancel(),delete this.entries[t]))}}},s.ag=nh,s.ah=function(t,e,r){const n=JSON.stringify(t.request);return t.data&&(this.deduped.entries[n]={result:[null,t.data]}),this.deduped.request(n,{type:"parseTile",isSymbolTile:t.isSymbolTile,zoom:t.tileZoom},a=>{const l=ze(t.request,(h,f,m,_)=>{h?a(h):f&&a(null,{vectorTile:r?void 0:new Fm(new Ic(f)),rawData:f,cacheControl:m,expires:_})});return()=>{l.cancel(),a()}},e)},s.ai=function(t){Pr++,Pr>wt&&(t.getActor().send("enforceCacheSizeLimit",De),Pr=0)},s.aj=xi,s.ak=Fe,s.al=function(t){return t<=1?1:Math.pow(2,Math.floor(Math.log(t)/Math.LN2))},s.am=Xe,s.an=b1,s.ao=w1,s.ap=v1,s.aq=function(t,e){const r=document.createElement("video");r.muted=!0,r.onloadstart=function(){e(null,r)};for(let n=0;n<t.length;n++){const a=document.createElement("source");He(t[n])||(r.crossOrigin="Anonymous"),a.src=t[n],r.appendChild(a)}return{cancel:()=>{}}},s.ar=Gf,s.as=zh,s.at=$t,s.au=fr,s.av=vo,s.aw=Si,s.ax=mi,s.ay=Dr,s.az=Ms,s.b=hs,s.b$=Nd,s.b0=function(t,e){const r=[];for(const n in t)n in e||r.push(n);return r},s.b1=qi,s.b2=["type","source","source-layer","minzoom","maxzoom","filter","layout"],s.b3=function(t,e){const{x:r,y:n}=t.point,a=F0(r,n,t.worldSize/t._pixelsPerMercatorPixel,0,0);return s.a6.multiply(a,a,Im(is(e)))},s.b5=Tc,s.b6=Yn,s.b7=Af,s.b8=function(t,e,r,n,a){const l=5*e+2;t.float32[l+0]=r,t.float32[l+1]=n,t.float32[l+2]=a},s.b9=Vf,s.bA=Wf,s.bB=T1,s.bC=function(t){const e=T1(t,!0);return s.b4.invert([],[e[0],e[1],e[4],e[5]])},s.bD=wm,s.bE=function(t){const{x:e,y:r}=t.point,{lng:n,lat:a}=t._center;return F0(e,r,t.worldSize,n,a)},s.bF=At,s.bG=J,s.bH=function(t){const e=Math.round((t+45+360)%360/90)%4;return Sr[e]},s.bI=45,s.bJ=It,s.bK=u,s.bL=Qo,s.bM=sf,s.bN=Hi,s.bO=mc,s.bP=c,s.bQ=function(t,e,r){const n=Math.sqrt(t*t+e*e+r*r),a=n>0?Math.acos(r/n)*Gt:0;let l=t!==0||e!==0?Math.atan2(-e,-t)*Gt+90:0;return l<0&&(l+=360),[n,l,a]},s.bR=sr,s.bS=ai,s.bT=ho,s.bU=function(t){return[Math.pow(t[0],1/2.2),Math.pow(t[1],1/2.2),Math.pow(t[2],1/2.2)]},s.bV=function(t){return t({pluginStatus:an,pluginURL:Ho}),Ku.on("pluginStateChange",t),t},s.bW=Dc,s.bX=Yf,s.bY=Ac,s.bZ=Wm,s.b_=pi,s.ba=t1,s.bb=oo,s.bc=$i,s.bd=l1,s.be=Xm,s.bf=$m,s.bg=__,s.bh=mn,s.bj=St,s.bk=ie,s.bl=qt,s.bm=function(t,e,r){t[4*e+0]=r[0],t[4*e+1]=r[1],t[4*e+2]=r[2],t[4*e+3]=r[3]},s.bn=ge,s.bo=g1,s.bp=Ye,s.bq=Tm,s.br=E1,s.bs=Ve,s.bt=O0,s.bu=function(t,e,r,n,a,l,h,f,m){if(m.name==="globe")return O0(t,e,new Ve(r,n,a),!1);const _=zh({z:r,x:n,y:a},m);return new ai([(l+_.x/_.scale)*e,e*(_.y/_.scale),h],[(l+_.x2/_.scale)*e,e*(_.y2/_.scale),f])},s.bv=function(t,e,r){let n=0;for(let a=0;a<2;++a){const l=r?r[a]:0;t[a]>l&&(n+=(t[a]-l)*(t[a]-l)),e[a]<l&&(n+=(l-e[a])*(l-e[a]))}return n},s.bw=nr,s.bx=j,s.by=function(t){const e=s.a6.identity(new Float64Array(16));s.a6.multiply(e,t.pixelMatrix,t.globeMatrix);const r=[0,he,0],n=[0,we,0];return s.N.transformMat4(r,r,e),s.N.transformMat4(n,n,e),[r[0]>0&&r[0]<=t.width&&r[1]>0&&r[1]<=t.height&&!Am(t,new ge(t.center.lat,90)),n[0]>0&&n[0]<=t.width&&n[1]>0&&n[1]<=t.height&&!Am(t,new ge(t.center.lat,-90))]},s.bz=function(t,e){const{scale:r}=t.tileTransform,n=r*ct/(t.tileSize*Math.pow(2,e.zoom-t.tileID.overscaledZ+t.tileID.canonical.z));return s.b4.scale(new Float32Array(4),e.inverseAdjustmentMatrix,[n,n])},s.c=Z1,s.c$=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},s.c0=_e,s.c1=gn,s.c2=function(t,e,r){return t.type==="custom"?new CT(t,e):new oE[t.type](t,e,r)},s.c3=function(t){const e=t.indexOf(lc);return e>=0?t.slice(0,e):t},s.c4=function(t){return t.indexOf(lc)>=0},s.c5=function(t){const e=t.indexOf(lc);return e>=0?t.slice(e+1):""},s.c6=function(t){const e=[],r=t.id;return r===void 0&&e.push({message:`layers.${r}: missing required property "id"`}),t.render===void 0&&e.push({message:`layers.${r}: missing required method "render"`}),t.renderingMode&&t.renderingMode!=="2d"&&t.renderingMode!=="3d"&&e.push({message:`layers.${r}: property "renderingMode" must be either "2d" or "3d"`}),e},s.c7=Ki,s.c8=Ku,s.c9=Pe,s.cA=zy,s.cB=(t,e,r,n,a,l)=>{const h=t.transform;return{u_matrix:Dy(t,e,r,n),u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:h.calculatePixelsToTileUnitsMatrix(e),u_device_pixel_ratio:a,u_image:0,u_tile_units_to_pixels:Ly(e,h),u_units_to_pixels:[1/h.pixelsToGLUnits[0],1/h.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:l}},s.cC=(t,e,r,n,a,l,h)=>{const f=t.transform,m=f.calculatePixelsToTileUnitsMatrix(e);return{u_matrix:Dy(t,e,r,n),u_pixels_to_tile_units:m,u_device_pixel_ratio:l,u_units_to_pixels:[1/f.pixelsToGLUnits[0],1/f.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:a,u_texsize:Ry(r)&&e.lineAtlasTexture?e.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:Ly(e,t.transform),u_alpha_discard_threshold:0,u_trim_offset:h,u_emissive_strength:r.paint.get("line-emissive-strength")}},s.cD=co,s.cE=wh,s.cF=Ey,s.cG=yt,s.cH=Cf,s.cI=_a,s.cJ=450,s.cK=7,s.cL=ET,s.cM=256,s.cN=Im,s.cO=Jo,s.cP=hh,s.cQ=function(t,e,r,n,a){return Ut((t-e)/(r-e)*(a-n)+n,n,a)},s.cR=or,s.cS=i_,s.cT=[1,1,1],s.cU=bc,s.cV=Lc,s.cW=io,s.cX=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[]}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(t){const e=iy(new Ge(0,0),new Ge(ct,ct),t),r=[];for(const n of this._activeRegions){if(n.hiddenByOverlap||!ry(e,n))continue;const a=nw(n.min,n.max,t);r.push({min:a.min,max:a.max,sourceId:this._sourceIds[n.priority],footprint:n.footprint,footprintTileId:n.tileId})}return r}setSources(t){this._setSources(t.map(e=>({getSourceId:()=>e.cache.id,getFootprints:()=>{const r=[];for(const n of e.cache.getVisibleCoordinates()){const a=e.cache.getTile(n).buckets[e.layer];if(a)for(const l of a.getNodesInfo()){const h=l.node;h.footprint&&r.push({footprint:h.footprint,id:n.toUnwrapped()})}}return r}})))}_addSource(t){const e=t.getFootprints();if(e.length!==0){for(const r of e){if(!r.footprint)continue;const n=iy(r.footprint.min,r.footprint.max,r.id);this._activeRegions.push({min:n.min,max:n.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:r.id,footprint:r.footprint})}this._sourceIds.push(t.getSourceId())}}_computeReplacement(){this._activeRegions.sort((e,r)=>e.priority-r.priority||Ef(e.min,r.min)||Ef(e.max,r.max));let t=this._activeRegions.length!==this._prevRegions.length;if(!t){let e=0,r=0;for(;!t&&e!==this._activeRegions.length;){const n=this._activeRegions[e],a=this._prevRegions[r];t=n.priority!==a.priority||!ty(n,a),++e,++r}}if(t){++this._updateTime;const e=r=>{const n=this._activeRegions;if(r>=n.length)return r;const a=n[r].priority;for(;r<n.length&&n[r].priority===a;)++r;return r};if(this._sourceIds.length>1){let r=0,n=e(r);for(;r!==n;){let a=r;const l=r;for(;a!==n;){const h=this._activeRegions[a];h.hiddenByOverlap=!1;for(let f=0;f<l;f++){const m=this._activeRegions[f];if(!m.hiddenByOverlap&&ry(h,m)&&(h.hiddenByOverlap=oy(h.footprint,h.tileId,m.footprint,m.tileId),h.hiddenByOverlap))break}++a}r=n,n=e(r)}}}}_setSources(t){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let e=t.length-1;e>=0;e--)this._addSource(t[e]);this._computeReplacement()}},s.cY=class{constructor(t){this._createGrid(t),this._createPoles(t)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const t of this._poleSegments)t.destroy();for(const t of this._gridSegments)t.withSkirts.destroy(),t.withoutSkirts.destroy()}_fillGridMeshWithLods(t,e){const r=new qn,n=new Si,a=[],l=t+1+2,h=e[0]+1,f=e[0]+1+(1+e.length),m=(_,x,b)=>{let T=_===l-1?_-2:_===0?_:_-1;return T+=b?24575:0,[T,x]};for(let _=0;_<l;++_)r.emplaceBack(...m(_,0,!0));for(let _=0;_<h;++_)for(let x=0;x<l;++x)r.emplaceBack(...m(x,_,(x===0||x===l-1)&&!0));for(let _=0;_<e.length;++_){const x=e[_];for(let b=0;b<l;++b)r.emplaceBack(...m(b,x,!0))}for(let _=0;_<e.length;++_){const x=n.length,b=e[_]+1+2,T=new Si;for(let D=0;D<b-1;D++){const O=D===b-2,F=O?l*(f-e.length+_-D):l;for(let $=0;$<l-1;$++){const X=D*l+$;D===0||O||$===0||$===l-2?(T.emplaceBack(X+1,X,X+F),T.emplaceBack(X+F,X+F+1,X+1)):(n.emplaceBack(X+1,X,X+F),n.emplaceBack(X+F,X+F+1,X+1))}}const C=ci.simpleSegment(0,x,r.length,n.length-x);for(let D=0;D<T.uint16.length;D+=3)n.emplaceBack(T.uint16[D],T.uint16[D+1],T.uint16[D+2]);const P=ci.simpleSegment(0,x,r.length,n.length-x);a.push({withoutSkirts:C,withSkirts:P})}return{vertices:r,indices:n,segments:a}}_createGrid(t){const e=this._fillGridMeshWithLods(oe,le);this._gridSegments=e.segments,this._gridBuffer=t.createVertexBuffer(e.vertices,D0.members),this._gridIndexBuffer=t.createIndexBuffer(e.indices,!0)}_createPoles(t){const e=new Si;for(let h=0;h<=oe;h++)e.emplaceBack(0,h+1,h+2);this._poleIndexBuffer=t.createIndexBuffer(e,!0);const r=new Jo,n=new Jo,a=new Jo,l=new Jo;this._poleSegments=[];for(let h=0,f=0;h<J;h++){const m=360/(1<<h);r.emplaceBack(0,-q,0,.5,0),n.emplaceBack(0,-q,0,.5,1),a.emplaceBack(0,-q,0,.5,.5),l.emplaceBack(0,-q,0,.5,.5);for(let _=0;_<=oe;_++){let x=_/oe,b=0;const T=ur(0,m,x),[C,P,D]=me(bb,wb,T,q);r.emplaceBack(C,P,D,x,b),n.emplaceBack(C,P,D,x,1-b);const O=St(T);x=.5+.5*Math.sin(O),b=.5+.5*Math.cos(O),a.emplaceBack(C,P,D,x,b),l.emplaceBack(C,P,D,x,1-b)}this._poleSegments.push(ci.simpleSegment(f,0,66,64)),f+=66}this._poleNorthVertexBuffer=t.createVertexBuffer(r,hf,!1),this._poleSouthVertexBuffer=t.createVertexBuffer(n,hf,!1),this._texturedPoleNorthVertexBuffer=t.createVertexBuffer(a,hf,!1),this._texturedPoleSouthVertexBuffer=t.createVertexBuffer(l,hf,!1)}getGridBuffers(t,e){return[this._gridBuffer,this._gridIndexBuffer,e?this._gridSegments[t].withSkirts:this._gridSegments[t].withoutSkirts]}getPoleBuffers(t,e){return[e?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,e?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[t]]}},s.cZ=function(t){return Oo.has(t)},s.c_=Ti,s.ca=i,s.cb=class extends bo{constructor(t){super(t),this.current=d}set(t,e,r){if(this.fetchUniformLocation(t,e)){for(let n=0;n<9;n++)if(r[n]!==this.current[n]){this.current=r,this.gl.uniformMatrix3fv(this.location,!1,r);break}}}},s.cc=it,s.cd=function(t,e,r){const n=fa(r.zoom),a=t.style.map._antialias,l=e.options.extStandardDerivativesForceOff||t.terrain&&t.terrain.exaggeration()>0;return n===0&&!a&&!l},s.ce=function(t){const e=t.pixelsPerMeter,r=e/qt(1,t.center.lat),n=s.a6.identity(new Float64Array(16));return s.a6.translate(n,n,[t.point.x,t.point.y,0]),s.a6.scale(n,n,[r,r,e]),Float32Array.from(n)},s.cf=ff,s.cg=function(t){const e=nr-5;t=Ut(t,-e,e)/e*90;const r=Math.pow(Math.abs(Math.sin(St(t))),3);return Math.round(r*(le.length-1))},s.ch=function(t,e,r,n){const a=e.getNorth(),l=e.getSouth(),h=e.getWest(),f=e.getEast(),m=1<<t.z,_=f-h,x=a-l,b=_/oe,T=-x/le[r],C=[0,b,0,T,0,0,a,h,0];if(t.z>0){const P=180/n;s.co.multiply(C,C,[P/_+1,0,0,0,P/x+1,0,-.5*P/b,.5*P/T,1])}return C[2]=m,C[5]=t.x,C[8]=t.y,C},s.ci=is,s.cj=function(t,e,r){const n=s.a6.identity(new Float64Array(16)),a=(e/(1<<t)-.5)*Math.PI*2;return s.a6.rotateY(n,r.globeMatrix,a),Float32Array.from(n)},s.ck=class{isDataAvailableAtPoint(t){const e=this._source();if(this.isUsingMockSource()||!e||t.y<0||t.y>1)return!1;const r=e.getSource().maxzoom,n=1<<r,a=Math.floor(t.x),l=Math.floor((t.x-a)*n),h=Math.floor(t.y*n),f=this.findDEMTileFor(new Xe(r,a,r,l,h));return!(!f||!f.dem)}getAtPointOrZero(t,e=0){return this.getAtPoint(t,e)||0}getAtPoint(t,e,r=!0){if(this.isUsingMockSource())return null;e==null&&(e=null);const n=this._source();if(!n||t.y<0||t.y>1)return e;const a=n.getSource().maxzoom,l=1<<a,h=Math.floor(t.x),f=t.x-h,m=new Xe(a,h,a,Math.floor(f*l),Math.floor(t.y*l)),_=this.findDEMTileFor(m);if(!_||!_.dem)return e;const x=_.dem,b=1<<_.tileID.canonical.z,T=(f*b-_.tileID.canonical.x)*x.dim,C=(t.y*b-_.tileID.canonical.y)*x.dim,P=Math.floor(T),D=Math.floor(C);return(r?this.exaggeration():1)*ur(ur(x.get(P,D),x.get(P,D+1),C-D),ur(x.get(P+1,D),x.get(P+1,D+1),C-D),T-P)}getAtTileOffset(t,e,r){const n=1<<t.canonical.z;return this.getAtPointOrZero(new gr(t.wrap+(t.canonical.x+e/ct)/n,(t.canonical.y+r/ct)/n))}getAtTileOffsetFunc(t,e,r,n){return a=>{const l=this.getAtTileOffset(t,a.x,a.y),h=n.upVector(t.canonical,a.x,a.y),f=n.upVectorScale(t.canonical,e,r).metersToTile;return s.N.scale(h,h,l*f),h}}getForTilePoints(t,e,r,n){if(this.isUsingMockSource())return!1;const a=bc.create(this,t,n);return!!a&&(e.forEach(l=>{l[2]=this.exaggeration()*a.getElevationAt(l[0],l[1],r)}),!0)}getMinMaxForTile(t){if(this.isUsingMockSource())return null;const e=this.findDEMTileFor(t);if(!e||!e.dem)return null;const r=e.dem.tree,n=e.tileID,a=1<<t.canonical.z-n.canonical.z;let l=t.canonical.x/a-n.canonical.x,h=t.canonical.y/a-n.canonical.y,f=0;for(let m=0;m<t.canonical.z-n.canonical.z&&!r.leaves[f];m++){l*=2,h*=2;const _=2*Math.floor(h)+Math.floor(l);f=r.childOffsets[f]+_,l%=1,h%=1}return{min:this.exaggeration()*r.minimums[f],max:this.exaggeration()*r.maximums[f]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(t,e,r){throw new Error("Pure virtual method called.")}pointCoordinate(t){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(t){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const t=this.visibleDemTiles;if(t.length===0)return null;let e=!1,r=Number.MAX_VALUE,n=Number.MIN_VALUE;for(const a of t){const l=this.getMinMaxForTile(a.tileID);l&&(r=Math.min(r,l.min),n=Math.max(n,l.max),e=!0)}return e?{min:r,max:n}:null}},s.cl=df,s.cm=W0,s.cn=function(t,e){return[Math.pow(t[0],2.2)*e,Math.pow(t[1],2.2)*e,Math.pow(t[2],2.2)*e]},s.cp=B0,s.cq=256,s.cr=function(t,e){const r=[0,0,0],n=mf(is(e.canonical));return s.N.transformMat4(r,r,n),s.N.transformMat4(r,r,t),r},s.cs=t=>({u_camera_to_center_distance:new Hi(t),u_extrude_scale:new g(t),u_device_pixel_ratio:new Hi(t),u_matrix:new u(t),u_inv_rot_matrix:new u(t),u_merc_center:new Qo(t),u_tile_id:new sf(t),u_zoom_transition:new Hi(t),u_up_dir:new sf(t),u_emissive_strength:new Hi(t)}),s.ct=t=>({u_matrix:new u(t),u_pixels_to_tile_units:new g(t),u_device_pixel_ratio:new Hi(t),u_units_to_pixels:new Qo(t),u_dash_image:new mc(t),u_gradient_image:new mc(t),u_image_height:new Hi(t),u_texsize:new Qo(t),u_tile_units_to_pixels:new Hi(t),u_alpha_discard_threshold:new Hi(t),u_trim_offset:new Qo(t),u_emissive_strength:new Hi(t)}),s.cu=t=>({u_matrix:new u(t),u_texsize:new Qo(t),u_pixels_to_tile_units:new g(t),u_device_pixel_ratio:new Hi(t),u_image:new mc(t),u_units_to_pixels:new Qo(t),u_tile_units_to_pixels:new Hi(t),u_alpha_discard_threshold:new Hi(t),u_trim_offset:new Qo(t)}),s.cv=hc,s.cw=zw,s.cx=Rw,s.cy=V0,s.cz=(t,e,r,n,a,l)=>{const h=t.transform,f=h.projection.name==="globe";let m;if(l.paint.get("circle-pitch-alignment")==="map")if(f){const x=B0(h.zoom,e.canonical)*h._pixelsPerMercatorPixel;m=Float32Array.from([x,0,0,x])}else m=h.calculatePixelsToTileUnitsMatrix(r);else m=new Float32Array([h.pixelsToGLUnits[0],0,0,h.pixelsToGLUnits[1]]);const _={u_camera_to_center_distance:t.transform.getCameraToCenterDistance(h.projection),u_matrix:t.translatePosMatrix(e.projMatrix,r,l.paint.get("circle-translate"),l.paint.get("circle-translate-anchor")),u_device_pixel_ratio:We.devicePixelRatio,u_extrude_scale:m,u_inv_rot_matrix:Tb,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:l.paint.get("circle-emissive-strength")};if(f){_.u_inv_rot_matrix=n,_.u_merc_center=a,_.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],_.u_zoom_transition=fa(h.zoom);const x=a[0]*ct,b=a[1]*ct;_.u_up_dir=h.projection.upVector(new Ve(0,0,0),x,b)}return _},s.d=at,s.d0=oi,s.d1=yr,s.d2=Ae,s.d3=function([t,e,r]){const n=Math.hypot(t,e,r),a=Math.atan2(t,r),l=.5*Math.PI-Math.acos(-e/n);return new ge(At(a),At(l))},s.d4=Ie,s.d5=se,s.d6=Am,s.d7=N0,s.d8=function(t){const e=[0,0,0],r=s.a6.identity(new Float64Array(16));return s.a6.multiply(r,t.pixelMatrix,t.globeMatrix),s.N.transformMat4(e,e,r),new Ge(e[0],e[1])},s.d9=function(t){const e=t.navigator?t.navigator.userAgent:null;return!!function(r){if(ke==null){const n=r.navigator?r.navigator.userAgent:null;ke=!!r.safari||!(!n||!(/\b(iPad|iPhone|iPod)\b/.test(n)||n.match("Safari")&&!n.match("Chrome")))}return ke}(t)&&e&&(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))},s.dA=Io,s.dB=G1,s.dC=q1,s.dD=Ay,s.dE=Ci,s.dF=i1,s.dG=function(t,e,r,n,a,l,h,f,m,_,x){t.createArrays(),t.tilePixelRatio=ct/(512*t.overscaling),t.compareText={},t.iconsNeedLinear=!1;const b=t.layers[0].layout,T=t.layers[0]._unevaluatedLayout._values,C={};if(t.textSizeData.kind==="composite"){const{minZoom:F,maxZoom:$}=t.textSizeData;C.compositeTextSizes=[T["text-size"].possiblyEvaluate(new ei(F),f),T["text-size"].possiblyEvaluate(new ei($),f)]}if(t.iconSizeData.kind==="composite"){const{minZoom:F,maxZoom:$}=t.iconSizeData;C.compositeIconSizes=[T["icon-size"].possiblyEvaluate(new ei(F),f),T["icon-size"].possiblyEvaluate(new ei($),f)]}C.layoutTextSize=T["text-size"].possiblyEvaluate(new ei(m+1),f),C.layoutIconSize=T["icon-size"].possiblyEvaluate(new ei(m+1),f),C.textMaxSize=T["text-size"].possiblyEvaluate(new ei(18),f);const P=b.get("text-rotation-alignment")==="map"&&b.get("symbol-placement")!=="point",D=b.get("text-size");let O=!1;for(const F of t.features)if(F.icon&&F.icon.nameSecondary){O=!0;break}for(const F of t.features){const $=b.get("text-font").evaluate(F,{},f).join(","),X=D.evaluate(F,{},f),H=C.layoutTextSize.evaluate(F,{},f),ne=(C.layoutIconSize.evaluate(F,{},f),{horizontal:{},vertical:void 0}),re=F.text;let ce,pe=[0,0];if(re){const xe=re.toString(),Se=b.get("text-letter-spacing").evaluate(F,{},f)*$i,Be=b.get("text-line-height").evaluate(F,{},f)*$i,Ce=Jp(xe)?Se:0,Oe=b.get("text-anchor").evaluate(F,{},f),Me=b.get("text-variable-anchor");if(!Me){const ht=b.get("text-radial-offset").evaluate(F,{},f);pe=ht?l1(Oe,[ht*$i,Hm]):b.get("text-offset").evaluate(F,{},f).map(je=>je*$i)}let Re=P?"center":b.get("text-justify").evaluate(F,{},f);const et=b.get("symbol-placement")==="point",Ne=et?b.get("text-max-width").evaluate(F,{},f)*$i:1/0,gt=ht=>{t.allowVerticalPlacement&&Wo(xe)&&(ne.vertical=Gm(re,e,r,a,$,Ne,Be,Oe,ht,Ce,pe,Yn.vertical,!0,H,X))};if(!P&&Me){const ht=Re==="auto"?Me.map(kt=>Xm(kt)):[Re];let je=!1;for(let kt=0;kt<ht.length;kt++){const Mt=ht[kt];if(!ne.horizontal[Mt])if(je)ne.horizontal[Mt]=ne.horizontal[0];else{const _t=Gm(re,e,r,a,$,Ne,Be,"center",Mt,Ce,pe,Yn.horizontal,!1,H,X);_t&&(ne.horizontal[Mt]=_t,je=_t.positionedLines.length===1)}}gt("left")}else{if(Re==="auto"&&(Re=Xm(Oe)),et||b.get("text-writing-mode").indexOf("horizontal")>=0||!Wo(xe)){const ht=Gm(re,e,r,a,$,Ne,Be,Oe,Re,Ce,pe,Yn.horizontal,!1,H,X);ht&&(ne.horizontal[Re]=ht)}gt(et?"left":Re)}}let ye=!1;if(F.icon&&F.icon.namePrimary){const xe=n[F.icon.namePrimary];xe&&(ce=Qw(a[F.icon.namePrimary],F.icon.nameSecondary?a[F.icon.nameSecondary]:void 0,b.get("icon-offset").evaluate(F,{},f),b.get("icon-anchor").evaluate(F,{},f)),ye=xe.sdf,t.sdfIcons===void 0?t.sdfIcons=xe.sdf:t.sdfIcons!==xe.sdf&&li("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(xe.pixelRatio!==t.pixelRatio||b.get("icon-rotate").constantOr(1)!==0)&&(t.iconsNeedLinear=!0))}const Te=u1(ne.horizontal)||ne.vertical;t.iconsInText||(t.iconsInText=!!Te&&Te.iconsInText),(Te||ce)&&sT(t,F,ne,ce,n,C,H,0,pe,ye,h,f,_,x,O)}l&&t.generateCollisionDebugBuffers(m,t.collisionBoxArray)},s.dH=Fm,s.dI=Ic,s.dJ=Mf,s.dK=ft,s.dL=wf,s.dM=bf,s.dN=Lr,s.dO=Fy,s.dP=function(t){let e=0;if(new Uint32Array(t,0,1)[0]!==k1){const r=new Uint32Array(t,0,7),[,,n,a,l,h]=r;e=r.byteLength+a+l+h+l,(n!==t.byteLength||e>=t.byteLength)&&li("Invalid b3dm header information.")}return U1(t,e)},s.dQ=function(t,e){const r=Z1(t);for(const n of r){for(const a of n.meshes)QT(a);n.lights&&(n.lightMeshIndex=n.meshes.length,n.meshes.push(eE(n.lights,e)))}return r},s.dR=ep,s.dS=D1,s.dT=vn,s.dU=function(t){Or(),pt&&pt.then(e=>{e.keys().then(r=>{for(let n=0;n<r.length-t;n++)e.delete(r[n])})})},s.da=class{constructor(t,e,r){this._transformRequestFn=t,this._customAccessToken=e,this._silenceAuthErrors=!!r,this._createSkuToken()}_createSkuToken(){const t=function(){let e="";for(let r=0;r<10;r++)e+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",Qe,e].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,e){return this._transformRequestFn&&this._transformRequestFn(t,e)||{url:t}}normalizeStyleURL(t,e){if(!_e(t))return t;const r=Ft(t);return r.params.push(`sdk=js-${te}`),r.path=`/styles/v1${r.path}`,this._makeAPIURL(r,this._customAccessToken||e)}normalizeGlyphsURL(t,e){if(!_e(t))return t;const r=Ft(t);return r.path=`/fonts/v1${r.path}`,this._makeAPIURL(r,this._customAccessToken||e)}normalizeModelURL(t,e){if(!_e(t))return t;const r=Ft(t);return r.path=`/models/v1${r.path}`,this._makeAPIURL(r,this._customAccessToken||e)}normalizeSourceURL(t,e,r,n){if(!_e(t))return t;const a=Ft(t);return a.path=`/v4/${a.authority}.json`,a.params.push("secure"),r&&a.params.push(`language=${r}`),n&&a.params.push(`worldview=${n}`),this._makeAPIURL(a,this._customAccessToken||e)}normalizeSpriteURL(t,e,r,n){const a=Ft(t);return _e(t)?(a.path=`/styles/v1${a.path}/sprite${e}${r}`,this._makeAPIURL(a,this._customAccessToken||n)):(a.path+=`${e}${r}`,cr(a))}normalizeTileURL(t,e,r){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!_e(t))return t;const n=Ft(t);n.path=n.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${e||r&&n.authority!=="raster"&&r===512?"@2x":""}${Mr.supported?".webp":"$1"}`),n.authority==="raster"?n.path=`/${se.RASTER_URL_PREFIX}${n.path}`:n.authority==="rasterarrays"?n.path=`/${se.RASTERARRAYS_URL_PREFIX}${n.path}`:(n.path=n.path.replace(/^.+\/v4\//,"/"),n.path=`/${se.TILE_URL_VERSION}${n.path}`);const a=this._customAccessToken||function(l){for(const h of l){const f=h.match(/^access_token=(.*)$/);if(f)return f[1]}return null}(n.params)||se.ACCESS_TOKEN;return se.REQUIRE_ACCESS_TOKEN&&a&&this._skuToken&&n.params.push(`sku=${this._skuToken}`),this._makeAPIURL(n,a)}canonicalizeTileURL(t,e){const r=Ft(t);if(!r.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!r.path.match(/\.[\w]+$/))return t;let n="mapbox://";r.path.match(/^\/raster\/v1\//)?n+=`raster/${r.path.replace(`/${se.RASTER_URL_PREFIX}/`,"")}`:r.path.match(/^\/rasterarrays\/v1\//)?n+=`rasterarrays/${r.path.replace(`/${se.RASTERARRAYS_URL_PREFIX}/`,"")}`:n+=`tiles/${r.path.replace(`/${se.TILE_URL_VERSION}/`,"")}`;let a=r.params;return e&&(a=a.filter(l=>!l.match(/^access_token=/))),a.length&&(n+=`?${a.join("&")}`),n}canonicalizeTileset(t,e){const r=!!e&&_e(e),n=[];for(const a of t.tiles||[])fe(a)?n.push(this.canonicalizeTileURL(a,r)):n.push(a);return n}_makeAPIURL(t,e){const r="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",n=Ft(se.API_URL);if(t.protocol=n.protocol,t.authority=n.authority,t.protocol==="http"){const a=t.params.indexOf("secure");a>=0&&t.params.splice(a,1)}if(n.path!=="/"&&(t.path=`${n.path}${t.path}`),!se.REQUIRE_ACCESS_TOKEN)return cr(t);if(e=e||se.ACCESS_TOKEN,!this._silenceAuthErrors){if(!e)throw new Error(`An API access token is required to use Mapbox GL. ${r}`);if(e[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${r}`)}return t.params=t.params.filter(a=>a.indexOf("access_token")===-1),t.params.push(`access_token=${e||""}`),cr(t)}},s.db=function(t,e){e?Oo.add(t):Oo.delete(t)},s.dc=Mr,s.dd=Un,s.de=La,s.df=ut,s.dg=wr,s.dh=function(t){Oo.delete(t)},s.di=Ui,s.dj=Ni,s.dk=te,s.dl=function(t,e){De=t,wt=e},s.dm=function(t,e,r=!1){if(an===qu||an===Wu||an===Hu)throw new Error("setRTLTextPlugin cannot be called multiple times.");Ho=We.resolveURL(t),an=qu,Xu=e,Yu(),r||Ju()},s.dn=Xo,s.dp=function(){Yf().acquire(a_)},s.dq=function(){const t=Vh;t&&(t.isPreloaded()&&t.numActive()===1?(t.release(a_),Vh=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},s.dr=Uh,s.ds=function(t){const e=tr();if(!e)return;const r=e.delete(vt);t&&r.catch(t).then(()=>t())},s.dt=Nh,s.du=z1,s.dv=function(t){l_=We.resolveURL(t),Rc||(Rc=new Dc(Yf(),new Vs)),Rc.broadcast("setDracoUrl",l_)},s.dw=R1,s.dx=function(t){zc=We.resolveURL(t),Rc||(Rc=new Dc(Yf(),new Vs)),Rc.broadcast("setMeshoptUrl",zc)},s.dy=mt,s.dz=pa,s.e=gi,s.f=We,s.g=function(t,e){return Pe(gi(t,{type:"json"}),e)},s.h=Xn,s.i=Ws,s.j=Yc,s.k=tc,s.l=function(t){return fetch(t).then(e=>e.arrayBuffer()).then(e=>U1(e,0,t))},s.m=Ld,s.n=Wa,s.o=el,s.p=r1,s.q=oc,s.r=nc,s.s=Vu,s.t=Va,s.u=Qa,s.v=ji,s.w=li,s.x=Js,s.z=th}),Y(["./shared"],function(s){function te(ke){const W=ke?ke.url.toString():void 0;return W?performance.getEntriesByName(W):[]}function ae(ke){if(typeof ke=="number"||typeof ke=="boolean"||typeof ke=="string"||ke==null)return JSON.stringify(ke);if(Array.isArray(ke)){let ie="[";for(const de of ke)ie+=`${ae(de)},`;return`${ie}]`}let W="{";for(const ie of Object.keys(ke).sort())W+=`${ie}:${ae(ke[ie])},`;return`${W}}`}function se(ke){let W="";for(const ie of s.b2)W+=`/${ae(ke[ie])}`;return W}class fe{constructor(W){this.keyCache={},this._layers={},this._layerConfigs={},W&&this.replace(W)}replace(W,ie){this._layerConfigs={},this._layers={},this.update(W,[],ie)}update(W,ie,de){this._options=de;for(const Fe of W)this._layerConfigs[Fe.id]=Fe,(this._layers[Fe.id]=s.c2(Fe,this.scope,this._options)).compileFilter(),this.keyCache[Fe.id]&&delete this.keyCache[Fe.id];for(const Fe of ie)delete this.keyCache[Fe],delete this._layerConfigs[Fe],delete this._layers[Fe];this.familiesBySource={};const Le=function(Fe,We){const vt={};for(let wt=0;wt<Fe.length;wt++){const pt=We&&We[Fe[wt].id]||se(Fe[wt]);We&&(We[Fe[wt].id]=pt);let Et=vt[pt];Et||(Et=vt[pt]=[]),Et.push(Fe[wt])}const De=[];for(const wt in vt)De.push(vt[wt]);return De}(s.a$(this._layerConfigs),this.keyCache);for(const Fe of Le){const We=Fe.map(tr=>this._layers[tr.id]),vt=We[0];if(vt.visibility==="none")continue;const De=vt.source||"";let wt=this.familiesBySource[De];wt||(wt=this.familiesBySource[De]={});const pt=vt.sourceLayer||"_geojsonTileLayer";let Et=wt[pt];Et||(Et=wt[pt]=[]),Et.push(We)}}}const _e=1*s.dA;class qe{constructor(W){const ie={},de=[];for(const vt in W){const De=W[vt],wt=ie[vt]={};for(const pt in De.glyphs){const Et=De.glyphs[+pt];if(!Et||Et.bitmap.width===0||Et.bitmap.height===0)continue;const tr=Et.metrics.localGlyph?_e:1,Or={x:0,y:0,w:Et.bitmap.width+2*tr,h:Et.bitmap.height+2*tr};de.push(Or),wt[pt]=Or}}const{w:Le,h:Fe}=s.p(de),We=new s.dz({width:Le||1,height:Fe||1});for(const vt in W){const De=W[vt];for(const wt in De.glyphs){const pt=De.glyphs[+wt];if(!pt||pt.bitmap.width===0||pt.bitmap.height===0)continue;const Et=ie[vt][wt],tr=pt.metrics.localGlyph?_e:1;s.dz.copy(pt.bitmap,We,{x:0,y:0},{x:Et.x+tr,y:Et.y+tr},pt.bitmap)}}this.image=We,this.positions=ie}}s.dy(qe,"GlyphAtlas");class nt{constructor(W){this.tileID=new s.am(W.tileID.overscaledZ,W.tileID.wrap,W.tileID.canonical.z,W.tileID.canonical.x,W.tileID.canonical.y),this.tileZoom=W.tileZoom,this.uid=W.uid,this.zoom=W.zoom,this.canonical=W.tileID.canonical,this.pixelRatio=W.pixelRatio,this.tileSize=W.tileSize,this.source=W.source,this.scope=W.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=W.showCollisionBoxes,this.collectResourceTiming=!!W.collectResourceTiming,this.promoteId=W.promoteId,this.isSymbolTile=W.isSymbolTile,this.tileTransform=s.as(W.tileID.canonical,W.projection),this.projection=W.projection,this.brightness=W.brightness,this.extraShadowCaster=!!W.extraShadowCaster}parse(W,ie,de,Le,Fe){this.status="parsing",this.data=W,this.collisionBoxArray=new s.aD;const We=new s.dB(Object.keys(W.layers).sort()),vt=new s.dC(this.tileID,this.promoteId);vt.bucketLayerIDs=[];const De={},wt=new s.dD(256,256),pt={featureIndex:vt,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:wt,availableImages:de,brightness:this.brightness},Et=ie.familiesBySource[this.source];for(const zr in Et){const Zr=W.layers[zr];if(!Zr)continue;let Ai=!1,Wr=!1,Ji=!1;for(const yi of Et[zr])yi[0].type==="symbol"?Ai=!0:Wr=!0,yi[0].is3D()&&yi[0].type!=="model"&&(Ji=!0);if(this.extraShadowCaster&&!Ji||this.isSymbolTile===!0&&!Ai||this.isSymbolTile===!1&&!Wr)continue;Zr.version===1&&s.w(`Vector tile source "${this.source}" layer "${zr}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Wi=We.encode(zr),nn=[];for(let yi=0;yi<Zr.length;yi++){const pi=Zr.feature(yi),Pe=vt.getId(pi,zr);nn.push({feature:pi,id:Pe,index:yi,sourceLayerIndex:Wi})}for(const yi of Et[zr]){const pi=yi[0];(!this.extraShadowCaster||pi.is3D()&&pi.type!=="model")&&(this.isSymbolTile!==void 0&&pi.type==="symbol"!==this.isSymbolTile||pi.minzoom&&this.zoom<Math.floor(pi.minzoom)||pi.maxzoom&&this.zoom>=pi.maxzoom||pi.visibility!=="none"&&(xt(yi,this.zoom,pt.brightness,de),(De[pi.id]=pi.createBucket({index:vt.bucketLayerIDs.length,layers:yi,zoom:this.zoom,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Wi,sourceID:this.source,projection:this.projection.spec})).populate(nn,pt,this.tileID.canonical,this.tileTransform),vt.bucketLayerIDs.push(yi.map(Pe=>Pe.id))))}}let tr,Or,Hr,kr;wt.trim();const Pr={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},Mr=()=>{if(tr)return this.status="done",Fe(tr);if(this.extraShadowCaster)this.status="done",Fe(null,{buckets:s.a$(De).filter(zr=>!zr.isEmpty()),featureIndex:vt,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:pt.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(Or&&Hr&&kr){const zr=new qe(Or),Zr=new s.dF(Hr,kr);for(const Ai in De){const Wr=De[Ai];Wr instanceof s.aE?(xt(Wr.layers,this.zoom,pt.brightness,de),s.dG(Wr,Or,zr.positions,Hr,Zr.iconPositions,this.showCollisionBoxes,de,this.tileID.canonical,this.tileZoom,this.projection,this.brightness)):Wr.hasPattern&&(Wr instanceof s.aK||Wr instanceof s.aL||Wr instanceof s.cH)&&(xt(Wr.layers,this.zoom,pt.brightness,de),Wr.addFeatures(pt,this.tileID.canonical,Zr.patternPositions,de,this.tileTransform,this.brightness))}this.status="done",Fe(null,{buckets:s.a$(De).filter(Ai=>!Ai.isEmpty()),featureIndex:vt,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:zr.image,lineAtlas:wt,imageAtlas:Zr,brightness:pt.brightness})}};if(!this.extraShadowCaster){const zr=s.dE(pt.glyphDependencies,Wr=>Object.keys(Wr).map(Number));Object.keys(zr).length?Le.send("getGlyphs",{uid:this.uid,stacks:zr,scope:this.scope},(Wr,Ji)=>{tr||(tr=Wr,Or=Ji,Mr())},void 0,!1,Pr):Or={};const Zr=Object.keys(pt.iconDependencies);Zr.length?Le.send("getImages",{icons:Zr,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(Wr,Ji)=>{tr||(tr=Wr,Hr=Ji,Mr())},void 0,!1,Pr):Hr={};const Ai=Object.keys(pt.patternDependencies);Ai.length?Le.send("getImages",{icons:Ai,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(Wr,Ji)=>{tr||(tr=Wr,kr=Ji,Mr())},void 0,!1,Pr):kr={}}Mr()}}function xt(ke,W,ie,de){const Le=new s.K(W,{brightness:ie});for(const Fe of ke)Fe.recalculate(Le,de)}class lt extends s.E{constructor(W,ie,de,Le,Fe,We){super(),this.actor=W,this.layerIndex=ie,this.availableImages=de,this.loadVectorData=Fe||s.ah,this.loading={},this.loaded={},this.deduped=new s.af(W.scheduler),this.isSpriteLoaded=Le,this.scheduler=W.scheduler,this.brightness=We}loadTile(W,ie){const de=W.uid,Le=W&&W.request,Fe=Le&&Le.collectResourceTiming,We=this.loading[de]=new nt(W);We.abort=this.loadVectorData(W,(vt,De)=>{const wt=!this.loading[de];if(delete this.loading[de],wt||vt||!De)return We.status="done",wt||(this.loaded[de]=We),ie(vt);const pt=De.rawData,Et={};De.expires&&(Et.expires=De.expires),De.cacheControl&&(Et.cacheControl=De.cacheControl),We.vectorTile=De.vectorTile||new s.dH(new s.dI(pt));const tr=()=>{We.parse(We.vectorTile,this.layerIndex,this.availableImages,this.actor,(Or,Hr)=>{if(Or||!Hr)return ie(Or);const kr={};if(Fe){const Pr=te(Le);Pr.length>0&&(kr.resourceTiming=JSON.parse(JSON.stringify(Pr)))}ie(null,s.e({rawTileData:pt.slice(0)},Hr,Et,kr))})};this.isSpriteLoaded?tr():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(tr,{type:"parseTile",isSymbolTile:W.isSymbolTile,zoom:W.tileZoom}):tr()}),this.loaded=this.loaded||{},this.loaded[de]=We})}reloadTile(W,ie){const de=this.loaded,Le=W.uid,Fe=this;if(de&&de[Le]){const We=de[Le];We.showCollisionBoxes=W.showCollisionBoxes,We.projection=W.projection,We.brightness=W.brightness,We.tileTransform=s.as(W.tileID.canonical,W.projection),We.extraShadowCaster=W.extraShadowCaster;const vt=(De,wt)=>{const pt=We.reloadCallback;pt&&(delete We.reloadCallback,We.parse(We.vectorTile,Fe.layerIndex,this.availableImages,Fe.actor,pt)),ie(De,wt)};We.status==="parsing"?We.reloadCallback=vt:We.status==="done"&&(We.vectorTile?We.parse(We.vectorTile,this.layerIndex,this.availableImages,this.actor,vt):vt())}else ie(null,void 0)}abortTile(W,ie){const de=W.uid,Le=this.loading[de];Le&&(Le.abort&&Le.abort(),delete this.loading[de]),ie()}removeTile(W,ie){const de=this.loaded,Le=W.uid;de&&de[Le]&&delete de[Le],ie()}}class $e{loadTile(W,ie){const{uid:de,encoding:Le,rawImageData:Fe,padding:We}=W,vt=ImageBitmap&&Fe instanceof ImageBitmap?this.getImageData(Fe,We):Fe;ie(null,new s.dJ(de,vt,Le,We<1))}getImageData(W,ie){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(W.width,W.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=W.width,this.offscreenCanvas.height=W.height,this.offscreenCanvasContext.drawImage(W,0,0,W.width,W.height);const de=this.offscreenCanvasContext.getImageData(-ie,-ie,W.width+2*ie,W.height+2*ie);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),de}}class ft{decodeRasterArray({task:W,buffer:ie},de){s.aZ.performDecoding(ie,W).then(Le=>{de(null,Le)},Le=>{de(Le)})}}function Nt(ke,W){if(ke.length!==0){Ot(ke[0],W);for(var ie=1;ie<ke.length;ie++)Ot(ke[ie],!W)}}function Ot(ke,W){for(var ie=0,de=0,Le=0,Fe=ke.length,We=Fe-1;Le<Fe;We=Le++){var vt=(ke[Le][0]-ke[We][0])*(ke[We][1]+ke[Le][1]),De=ie+vt;de+=Math.abs(ie)>=Math.abs(vt)?ie-De+vt:vt-De+ie,ie=De}ie+de>=0!=!!W&&ke.reverse()}var lr=s.dK(function ke(W,ie){var de,Le=W&&W.type;if(Le==="FeatureCollection")for(de=0;de<W.features.length;de++)ke(W.features[de],ie);else if(Le==="GeometryCollection")for(de=0;de<W.geometries.length;de++)ke(W.geometries[de],ie);else if(Le==="Feature")ke(W.geometry,ie);else if(Le==="Polygon")Nt(W.coordinates,ie);else if(Le==="MultiPolygon")for(de=0;de<W.coordinates.length;de++)Nt(W.coordinates[de],ie);return W});const Lr=s.dL.prototype.toGeoJSON;let Er=class{constructor(ke){this._feature=ke,this.extent=s.V,this.type=ke.type,this.properties=ke.tags,"id"in ke&&!isNaN(ke.id)&&(this.id=parseInt(ke.id,10))}loadGeometry(){if(this._feature.type===1){const ke=[];for(const W of this._feature.geometry)ke.push([new s.P(W[0],W[1])]);return ke}{const ke=[];for(const W of this._feature.geometry){const ie=[];for(const de of W)ie.push(new s.P(de[0],de[1]));ke.push(ie)}return ke}}toGeoJSON(ke,W,ie){return Lr.call(this,ke,W,ie)}},Ge=class{constructor(ke){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=s.V,this.length=ke.length,this._features=ke}feature(ke){return new Er(this._features[ke])}};var qr={exports:{}},Gt=s.dN,St=s.dM.VectorTileFeature,At=Sr;function Sr(ke,W){this.options=W||{},this.features=ke,this.length=ke.length}function it(ke,W){this.id=typeof ke.id=="number"?ke.id:void 0,this.type=ke.type,this.rawGeometry=ke.type===1?[ke.geometry]:ke.geometry,this.properties=ke.tags,this.extent=W||4096}Sr.prototype.feature=function(ke){return new it(this.features[ke],this.options.extent)},it.prototype.loadGeometry=function(){var ke=this.rawGeometry;this.geometry=[];for(var W=0;W<ke.length;W++){for(var ie=ke[W],de=[],Le=0;Le<ie.length;Le++)de.push(new Gt(ie[Le][0],ie[Le][1]));this.geometry.push(de)}return this.geometry},it.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var ke=this.geometry,W=1/0,ie=-1/0,de=1/0,Le=-1/0,Fe=0;Fe<ke.length;Fe++)for(var We=ke[Fe],vt=0;vt<We.length;vt++){var De=We[vt];W=Math.min(W,De.x),ie=Math.max(ie,De.x),de=Math.min(de,De.y),Le=Math.max(Le,De.y)}return[W,de,ie,Le]},it.prototype.toGeoJSON=St.prototype.toGeoJSON;var Ti=s.dO,oi=At;function Ut(ke){var W=new Ti;return function(ie,de){for(var Le in ie.layers)de.writeMessage(3,Ei,ie.layers[Le])}(ke,W),W.finish()}function Ei(ke,W){var ie;W.writeVarintField(15,ke.version||1),W.writeStringField(1,ke.name||""),W.writeVarintField(5,ke.extent||4096);var de={keys:[],values:[],keycache:{},valuecache:{}};for(ie=0;ie<ke.length;ie++)de.feature=ke.feature(ie),W.writeMessage(2,mn,de);var Le=de.keys;for(ie=0;ie<Le.length;ie++)W.writeStringField(3,Le[ie]);var Fe=de.values;for(ie=0;ie<Fe.length;ie++)W.writeMessage(4,Yi,Fe[ie])}function mn(ke,W){var ie=ke.feature;ie.id!==void 0&&W.writeVarintField(1,ie.id),W.writeMessage(2,qi,ke),W.writeVarintField(3,ie.type),W.writeMessage(4,eo,ie)}function qi(ke,W){var ie=ke.feature,de=ke.keys,Le=ke.values,Fe=ke.keycache,We=ke.valuecache;for(var vt in ie.properties){var De=ie.properties[vt],wt=Fe[vt];if(De!==null){wt===void 0&&(de.push(vt),Fe[vt]=wt=de.length-1),W.writeVarint(wt);var pt=typeof De;pt!=="string"&&pt!=="boolean"&&pt!=="number"&&(De=JSON.stringify(De));var Et=pt+":"+De,tr=We[Et];tr===void 0&&(Le.push(De),We[Et]=tr=Le.length-1),W.writeVarint(tr)}}}function gi(ke,W){return(W<<3)+(7&ke)}function Fn(ke){return ke<<1^ke>>31}function eo(ke,W){for(var ie=ke.loadGeometry(),de=ke.type,Le=0,Fe=0,We=ie.length,vt=0;vt<We;vt++){var De=ie[vt],wt=1;de===1&&(wt=De.length),W.writeVarint(gi(1,wt));for(var pt=de===3?De.length-1:De.length,Et=0;Et<pt;Et++){Et===1&&de!==1&&W.writeVarint(gi(2,pt-1));var tr=De[Et].x-Le,Or=De[Et].y-Fe;W.writeVarint(Fn(tr)),W.writeVarint(Fn(Or)),Le+=tr,Fe+=Or}de===3&&W.writeVarint(gi(7,1))}}function Yi(ke,W){var ie=typeof ke;ie==="string"?W.writeStringField(1,ke):ie==="boolean"?W.writeBooleanField(7,ke):ie==="number"&&(ke%1!=0?W.writeDoubleField(3,ke):ke<0?W.writeSVarintField(6,ke):W.writeVarintField(5,ke))}qr.exports=Ut,qr.exports.fromVectorTileJs=Ut,qr.exports.fromGeojsonVt=function(ke,W){W=W||{};var ie={};for(var de in ke)ie[de]=new oi(ke[de].features,W),ie[de].name=de,ie[de].version=W.version,ie[de].extent=W.extent;return Ut({layers:ie})},qr.exports.GeoJSONWrapper=oi;var co=s.dK(qr.exports);const uo={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:ke=>ke},Nn=Math.fround||(_n=new Float32Array(1),ke=>(_n[0]=+ke,_n[0]));var _n;const Ci=3,Ki=5,gn=6;class Rl{constructor(W){this.options=Object.assign(Object.create(uo),W),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(W){const{log:ie,minZoom:de,maxZoom:Le}=this.options;ie&&console.time("total time");const Fe=`prepare ${W.length} points`;ie&&console.time(Fe),this.points=W;const We=[];for(let De=0;De<W.length;De++){const wt=W[De];if(!wt.geometry)continue;const[pt,Et]=wt.geometry.coordinates,tr=Nn(cs(pt)),Or=Nn(ho(Et));We.push(tr,Or,1/0,De,-1,1),this.options.reduce&&We.push(0)}let vt=this.trees[Le+1]=this._createTree(We);ie&&console.timeEnd(Fe);for(let De=Le;De>=de;De--){const wt=+Date.now();vt=this.trees[De]=this._createTree(this._cluster(vt,De)),ie&&console.log("z%d: %d clusters in %dms",De,vt.numItems,+Date.now()-wt)}return ie&&console.timeEnd("total time"),this}getClusters(W,ie){let de=((W[0]+180)%360+360)%360-180;const Le=Math.max(-90,Math.min(90,W[1]));let Fe=W[2]===180?180:((W[2]+180)%360+360)%360-180;const We=Math.max(-90,Math.min(90,W[3]));if(W[2]-W[0]>=360)de=-180,Fe=180;else if(de>Fe){const Et=this.getClusters([de,Le,180,We],ie),tr=this.getClusters([-180,Le,Fe,We],ie);return Et.concat(tr)}const vt=this.trees[this._limitZoom(ie)],De=vt.range(cs(de),ho(We),cs(Fe),ho(Le)),wt=vt.data,pt=[];for(const Et of De){const tr=this.stride*Et;pt.push(wt[tr+Ki]>1?li(wt,tr,this.clusterProps):this.points[wt[tr+Ci]])}return pt}getChildren(W){const ie=this._getOriginId(W),de=this._getOriginZoom(W),Le="No cluster with the specified id.",Fe=this.trees[de];if(!Fe)throw new Error(Le);const We=Fe.data;if(ie*this.stride>=We.length)throw new Error(Le);const vt=this.options.radius/(this.options.extent*Math.pow(2,de-1)),De=Fe.within(We[ie*this.stride],We[ie*this.stride+1],vt),wt=[];for(const pt of De){const Et=pt*this.stride;We[Et+4]===W&&wt.push(We[Et+Ki]>1?li(We,Et,this.clusterProps):this.points[We[Et+Ci]])}if(wt.length===0)throw new Error(Le);return wt}getLeaves(W,ie,de){const Le=[];return this._appendLeaves(Le,W,ie=ie||10,de=de||0,0),Le}getTile(W,ie,de){const Le=this.trees[this._limitZoom(W)],Fe=Math.pow(2,W),{extent:We,radius:vt}=this.options,De=vt/We,wt=(de-De)/Fe,pt=(de+1+De)/Fe,Et={features:[]};return this._addTileFeatures(Le.range((ie-De)/Fe,wt,(ie+1+De)/Fe,pt),Le.data,ie,de,Fe,Et),ie===0&&this._addTileFeatures(Le.range(1-De/Fe,wt,1,pt),Le.data,Fe,de,Fe,Et),ie===Fe-1&&this._addTileFeatures(Le.range(0,wt,De/Fe,pt),Le.data,-1,de,Fe,Et),Et.features.length?Et:null}getClusterExpansionZoom(W){let ie=this._getOriginZoom(W)-1;for(;ie<=this.options.maxZoom;){const de=this.getChildren(W);if(ie++,de.length!==1)break;W=de[0].properties.cluster_id}return ie}_appendLeaves(W,ie,de,Le,Fe){const We=this.getChildren(ie);for(const vt of We){const De=vt.properties;if(De&&De.cluster?Fe+De.point_count<=Le?Fe+=De.point_count:Fe=this._appendLeaves(W,De.cluster_id,de,Le,Fe):Fe<Le?Fe++:W.push(vt),W.length===de)break}return Fe}_createTree(W){const ie=new s.bg(W.length/this.stride|0,this.options.nodeSize,Float32Array);for(let de=0;de<W.length;de+=this.stride)ie.add(W[de],W[de+1]);return ie.finish(),ie.data=W,ie}_addTileFeatures(W,ie,de,Le,Fe,We){for(const vt of W){const De=vt*this.stride,wt=ie[De+Ki]>1;let pt,Et,tr;if(wt)pt=Mn(ie,De,this.clusterProps),Et=ie[De],tr=ie[De+1];else{const kr=this.points[ie[De+Ci]];pt=kr.properties;const[Pr,Mr]=kr.geometry.coordinates;Et=cs(Pr),tr=ho(Mr)}const Or={type:1,geometry:[[Math.round(this.options.extent*(Et*Fe-de)),Math.round(this.options.extent*(tr*Fe-Le))]],tags:pt};let Hr;Hr=wt||this.options.generateId?ie[De+Ci]:this.points[ie[De+Ci]].id,Hr!==void 0&&(Or.id=Hr),We.features.push(Or)}}_limitZoom(W){return Math.max(this.options.minZoom,Math.min(Math.floor(+W),this.options.maxZoom+1))}_cluster(W,ie){const{radius:de,extent:Le,reduce:Fe,minPoints:We}=this.options,vt=de/(Le*Math.pow(2,ie)),De=W.data,wt=[],pt=this.stride;for(let Et=0;Et<De.length;Et+=pt){if(De[Et+2]<=ie)continue;De[Et+2]=ie;const tr=De[Et],Or=De[Et+1],Hr=W.within(De[Et],De[Et+1],vt),kr=De[Et+Ki];let Pr=kr;for(const Mr of Hr){const zr=Mr*pt;De[zr+2]>ie&&(Pr+=De[zr+Ki])}if(Pr>kr&&Pr>=We){let Mr,zr=tr*kr,Zr=Or*kr,Ai=-1;const Wr=(Et/pt<<5)+(ie+1)+this.points.length;for(const Ji of Hr){const Wi=Ji*pt;if(De[Wi+2]<=ie)continue;De[Wi+2]=ie;const nn=De[Wi+Ki];zr+=De[Wi]*nn,Zr+=De[Wi+1]*nn,De[Wi+4]=Wr,Fe&&(Mr||(Mr=this._map(De,Et,!0),Ai=this.clusterProps.length,this.clusterProps.push(Mr)),Fe(Mr,this._map(De,Wi)))}De[Et+4]=Wr,wt.push(zr/Pr,Zr/Pr,1/0,Wr,-1,Pr),Fe&&wt.push(Ai)}else{for(let Mr=0;Mr<pt;Mr++)wt.push(De[Et+Mr]);if(Pr>1)for(const Mr of Hr){const zr=Mr*pt;if(!(De[zr+2]<=ie)){De[zr+2]=ie;for(let Zr=0;Zr<pt;Zr++)wt.push(De[zr+Zr])}}}}return wt}_getOriginId(W){return W-this.points.length>>5}_getOriginZoom(W){return(W-this.points.length)%32}_map(W,ie,de){if(W[ie+Ki]>1){const We=this.clusterProps[W[ie+gn]];return de?Object.assign({},We):We}const Le=this.points[W[ie+Ci]].properties,Fe=this.options.map(Le);return de&&Fe===Le?Object.assign({},Fe):Fe}}function li(ke,W,ie){return{type:"Feature",id:ke[W+Ci],properties:Mn(ke,W,ie),geometry:{type:"Point",coordinates:[(de=ke[W],360*(de-.5)),to(ke[W+1])]}};var de}function Mn(ke,W,ie){const de=ke[W+Ki],Le=de>=1e4?`${Math.round(de/1e3)}k`:de>=1e3?Math.round(de/100)/10+"k":de,Fe=ke[W+gn],We=Fe===-1?{}:Object.assign({},ie[Fe]);return Object.assign(We,{cluster:!0,cluster_id:ke[W+Ci],point_count:de,point_count_abbreviated:Le})}function cs(ke){return ke/360+.5}function ho(ke){const W=Math.sin(ke*Math.PI/180),ie=.5-.25*Math.log((1+W)/(1-W))/Math.PI;return ie<0?0:ie>1?1:ie}function to(ke){const W=(180-360*ke)*Math.PI/180;return 360*Math.atan(Math.exp(W))/Math.PI-90}var us={exports:{}};us.exports=function(){function ke(Pe,ze,He,tt){for(var Ke,st=tt,at=He-ze>>1,Qe=He-ze,ut=Pe[ze],rt=Pe[ze+1],Ft=Pe[He],cr=Pe[He+1],Ct=ze+3;Ct<He;Ct+=3){var Fr=W(Pe[Ct],Pe[Ct+1],ut,rt,Ft,cr);if(Fr>st)Ke=Ct,st=Fr;else if(Fr===st){var Kr=Math.abs(Ct-at);Kr<Qe&&(Ke=Ct,Qe=Kr)}}st>tt&&(Ke-ze>3&&ke(Pe,ze,Ke,tt),Pe[Ke+2]=st,He-Ke>3&&ke(Pe,Ke,He,tt))}function W(Pe,ze,He,tt,Ke,st){var at=Ke-He,Qe=st-tt;if(at!==0||Qe!==0){var ut=((Pe-He)*at+(ze-tt)*Qe)/(at*at+Qe*Qe);ut>1?(He=Ke,tt=st):ut>0&&(He+=at*ut,tt+=Qe*ut)}return(at=Pe-He)*at+(Qe=ze-tt)*Qe}function ie(Pe,ze,He,tt){var Ke={id:Pe===void 0?null:Pe,type:ze,geometry:He,tags:tt,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(st){var at=st.geometry,Qe=st.type;if(Qe==="Point"||Qe==="MultiPoint"||Qe==="LineString")de(st,at);else if(Qe==="Polygon"||Qe==="MultiLineString")for(var ut=0;ut<at.length;ut++)de(st,at[ut]);else if(Qe==="MultiPolygon")for(ut=0;ut<at.length;ut++)for(var rt=0;rt<at[ut].length;rt++)de(st,at[ut][rt])}(Ke),Ke}function de(Pe,ze){for(var He=0;He<ze.length;He+=3)Pe.minX=Math.min(Pe.minX,ze[He]),Pe.minY=Math.min(Pe.minY,ze[He+1]),Pe.maxX=Math.max(Pe.maxX,ze[He]),Pe.maxY=Math.max(Pe.maxY,ze[He+1])}function Le(Pe,ze,He,tt){if(ze.geometry){var Ke=ze.geometry.coordinates,st=ze.geometry.type,at=Math.pow(He.tolerance/((1<<He.maxZoom)*He.extent),2),Qe=[],ut=ze.id;if(He.promoteId?ut=ze.properties[He.promoteId]:He.generateId&&(ut=tt||0),st==="Point")Fe(Ke,Qe);else if(st==="MultiPoint")for(var rt=0;rt<Ke.length;rt++)Fe(Ke[rt],Qe);else if(st==="LineString")We(Ke,Qe,at,!1);else if(st==="MultiLineString"){if(He.lineMetrics){for(rt=0;rt<Ke.length;rt++)We(Ke[rt],Qe=[],at,!1),Pe.push(ie(ut,"LineString",Qe,ze.properties));return}vt(Ke,Qe,at,!1)}else if(st==="Polygon")vt(Ke,Qe,at,!0);else{if(st!=="MultiPolygon"){if(st==="GeometryCollection"){for(rt=0;rt<ze.geometry.geometries.length;rt++)Le(Pe,{id:ut,geometry:ze.geometry.geometries[rt],properties:ze.properties},He,tt);return}throw new Error("Input data is not a valid GeoJSON object.")}for(rt=0;rt<Ke.length;rt++){var Ft=[];vt(Ke[rt],Ft,at,!0),Qe.push(Ft)}}Pe.push(ie(ut,st,Qe,ze.properties))}}function Fe(Pe,ze){ze.push(De(Pe[0])),ze.push(wt(Pe[1])),ze.push(0)}function We(Pe,ze,He,tt){for(var Ke,st,at=0,Qe=0;Qe<Pe.length;Qe++){var ut=De(Pe[Qe][0]),rt=wt(Pe[Qe][1]);ze.push(ut),ze.push(rt),ze.push(0),Qe>0&&(at+=tt?(Ke*rt-ut*st)/2:Math.sqrt(Math.pow(ut-Ke,2)+Math.pow(rt-st,2))),Ke=ut,st=rt}var Ft=ze.length-3;ze[2]=1,ke(ze,0,Ft,He),ze[Ft+2]=1,ze.size=Math.abs(at),ze.start=0,ze.end=ze.size}function vt(Pe,ze,He,tt){for(var Ke=0;Ke<Pe.length;Ke++){var st=[];We(Pe[Ke],st,He,tt),ze.push(st)}}function De(Pe){return Pe/360+.5}function wt(Pe){var ze=Math.sin(Pe*Math.PI/180),He=.5-.25*Math.log((1+ze)/(1-ze))/Math.PI;return He<0?0:He>1?1:He}function pt(Pe,ze,He,tt,Ke,st,at,Qe){if(tt/=ze,st>=(He/=ze)&&at<tt)return Pe;if(at<He||st>=tt)return null;for(var ut=[],rt=0;rt<Pe.length;rt++){var Ft=Pe[rt],cr=Ft.geometry,Ct=Ft.type,Fr=Ke===0?Ft.minX:Ft.minY,Kr=Ke===0?Ft.maxX:Ft.maxY;if(Fr>=He&&Kr<tt)ut.push(Ft);else if(!(Kr<He||Fr>=tt)){var jr=[];if(Ct==="Point"||Ct==="MultiPoint")Et(cr,jr,He,tt,Ke);else if(Ct==="LineString")tr(cr,jr,He,tt,Ke,!1,Qe.lineMetrics);else if(Ct==="MultiLineString")Hr(cr,jr,He,tt,Ke,!1);else if(Ct==="Polygon")Hr(cr,jr,He,tt,Ke,!0);else if(Ct==="MultiPolygon")for(var xi=0;xi<cr.length;xi++){var Ni=[];Hr(cr[xi],Ni,He,tt,Ke,!0),Ni.length&&jr.push(Ni)}if(jr.length){if(Qe.lineMetrics&&Ct==="LineString"){for(xi=0;xi<jr.length;xi++)ut.push(ie(Ft.id,Ct,jr[xi],Ft.tags));continue}Ct!=="LineString"&&Ct!=="MultiLineString"||(jr.length===1?(Ct="LineString",jr=jr[0]):Ct="MultiLineString"),Ct!=="Point"&&Ct!=="MultiPoint"||(Ct=jr.length===3?"Point":"MultiPoint"),ut.push(ie(Ft.id,Ct,jr,Ft.tags))}}}return ut.length?ut:null}function Et(Pe,ze,He,tt,Ke){for(var st=0;st<Pe.length;st+=3){var at=Pe[st+Ke];at>=He&&at<=tt&&(ze.push(Pe[st]),ze.push(Pe[st+1]),ze.push(Pe[st+2]))}}function tr(Pe,ze,He,tt,Ke,st,at){for(var Qe,ut,rt=Or(Pe),Ft=Ke===0?Pr:Mr,cr=Pe.start,Ct=0;Ct<Pe.length-3;Ct+=3){var Fr=Pe[Ct],Kr=Pe[Ct+1],jr=Pe[Ct+2],xi=Pe[Ct+3],Ni=Pe[Ct+4],wr=Ke===0?Fr:Kr,yn=Ke===0?xi:Ni,Un=!1;at&&(Qe=Math.sqrt(Math.pow(Fr-xi,2)+Math.pow(Kr-Ni,2))),wr<He?yn>He&&(ut=Ft(rt,Fr,Kr,xi,Ni,He),at&&(rt.start=cr+Qe*ut)):wr>tt?yn<tt&&(ut=Ft(rt,Fr,Kr,xi,Ni,tt),at&&(rt.start=cr+Qe*ut)):kr(rt,Fr,Kr,jr),yn<He&&wr>=He&&(ut=Ft(rt,Fr,Kr,xi,Ni,He),Un=!0),yn>tt&&wr<=tt&&(ut=Ft(rt,Fr,Kr,xi,Ni,tt),Un=!0),!st&&Un&&(at&&(rt.end=cr+Qe*ut),ze.push(rt),rt=Or(Pe)),at&&(cr+=Qe)}var Ui=Pe.length-3;Fr=Pe[Ui],Kr=Pe[Ui+1],jr=Pe[Ui+2],(wr=Ke===0?Fr:Kr)>=He&&wr<=tt&&kr(rt,Fr,Kr,jr),Ui=rt.length-3,st&&Ui>=3&&(rt[Ui]!==rt[0]||rt[Ui+1]!==rt[1])&&kr(rt,rt[0],rt[1],rt[2]),rt.length&&ze.push(rt)}function Or(Pe){var ze=[];return ze.size=Pe.size,ze.start=Pe.start,ze.end=Pe.end,ze}function Hr(Pe,ze,He,tt,Ke,st){for(var at=0;at<Pe.length;at++)tr(Pe[at],ze,He,tt,Ke,st,!1)}function kr(Pe,ze,He,tt){Pe.push(ze),Pe.push(He),Pe.push(tt)}function Pr(Pe,ze,He,tt,Ke,st){var at=(st-ze)/(tt-ze);return Pe.push(st),Pe.push(He+(Ke-He)*at),Pe.push(1),at}function Mr(Pe,ze,He,tt,Ke,st){var at=(st-He)/(Ke-He);return Pe.push(ze+(tt-ze)*at),Pe.push(st),Pe.push(1),at}function zr(Pe,ze){for(var He=[],tt=0;tt<Pe.length;tt++){var Ke,st=Pe[tt],at=st.type;if(at==="Point"||at==="MultiPoint"||at==="LineString")Ke=Zr(st.geometry,ze);else if(at==="MultiLineString"||at==="Polygon"){Ke=[];for(var Qe=0;Qe<st.geometry.length;Qe++)Ke.push(Zr(st.geometry[Qe],ze))}else if(at==="MultiPolygon")for(Ke=[],Qe=0;Qe<st.geometry.length;Qe++){for(var ut=[],rt=0;rt<st.geometry[Qe].length;rt++)ut.push(Zr(st.geometry[Qe][rt],ze));Ke.push(ut)}He.push(ie(st.id,at,Ke,st.tags))}return He}function Zr(Pe,ze){var He=[];He.size=Pe.size,Pe.start!==void 0&&(He.start=Pe.start,He.end=Pe.end);for(var tt=0;tt<Pe.length;tt+=3)He.push(Pe[tt]+ze,Pe[tt+1],Pe[tt+2]);return He}function Ai(Pe,ze){if(Pe.transformed)return Pe;var He,tt,Ke,st=1<<Pe.z,at=Pe.x,Qe=Pe.y;for(He=0;He<Pe.features.length;He++){var ut=Pe.features[He],rt=ut.geometry,Ft=ut.type;if(ut.geometry=[],Ft===1)for(tt=0;tt<rt.length;tt+=2)ut.geometry.push(Wr(rt[tt],rt[tt+1],ze,st,at,Qe));else for(tt=0;tt<rt.length;tt++){var cr=[];for(Ke=0;Ke<rt[tt].length;Ke+=2)cr.push(Wr(rt[tt][Ke],rt[tt][Ke+1],ze,st,at,Qe));ut.geometry.push(cr)}}return Pe.transformed=!0,Pe}function Wr(Pe,ze,He,tt,Ke,st){return[Math.round(He*(Pe*tt-Ke)),Math.round(He*(ze*tt-st))]}function Ji(Pe,ze,He,tt,Ke){for(var st=ze===Ke.maxZoom?0:Ke.tolerance/((1<<ze)*Ke.extent),at={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:He,y:tt,z:ze,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},Qe=0;Qe<Pe.length;Qe++){at.numFeatures++,Wi(at,Pe[Qe],st,Ke);var ut=Pe[Qe].minX,rt=Pe[Qe].minY,Ft=Pe[Qe].maxX,cr=Pe[Qe].maxY;ut<at.minX&&(at.minX=ut),rt<at.minY&&(at.minY=rt),Ft>at.maxX&&(at.maxX=Ft),cr>at.maxY&&(at.maxY=cr)}return at}function Wi(Pe,ze,He,tt){var Ke=ze.geometry,st=ze.type,at=[];if(st==="Point"||st==="MultiPoint")for(var Qe=0;Qe<Ke.length;Qe+=3)at.push(Ke[Qe]),at.push(Ke[Qe+1]),Pe.numPoints++,Pe.numSimplified++;else if(st==="LineString")nn(at,Ke,Pe,He,!1,!1);else if(st==="MultiLineString"||st==="Polygon")for(Qe=0;Qe<Ke.length;Qe++)nn(at,Ke[Qe],Pe,He,st==="Polygon",Qe===0);else if(st==="MultiPolygon")for(var ut=0;ut<Ke.length;ut++){var rt=Ke[ut];for(Qe=0;Qe<rt.length;Qe++)nn(at,rt[Qe],Pe,He,!0,Qe===0)}if(at.length){var Ft=ze.tags||null;if(st==="LineString"&&tt.lineMetrics){for(var cr in Ft={},ze.tags)Ft[cr]=ze.tags[cr];Ft.mapbox_clip_start=Ke.start/Ke.size,Ft.mapbox_clip_end=Ke.end/Ke.size}var Ct={geometry:at,type:st==="Polygon"||st==="MultiPolygon"?3:st==="LineString"||st==="MultiLineString"?2:1,tags:Ft};ze.id!==null&&(Ct.id=ze.id),Pe.features.push(Ct)}}function nn(Pe,ze,He,tt,Ke,st){var at=tt*tt;if(tt>0&&ze.size<(Ke?at:tt))He.numPoints+=ze.length/3;else{for(var Qe=[],ut=0;ut<ze.length;ut+=3)(tt===0||ze[ut+2]>at)&&(He.numSimplified++,Qe.push(ze[ut]),Qe.push(ze[ut+1])),He.numPoints++;Ke&&function(rt,Ft){for(var cr=0,Ct=0,Fr=rt.length,Kr=Fr-2;Ct<Fr;Kr=Ct,Ct+=2)cr+=(rt[Ct]-rt[Kr])*(rt[Ct+1]+rt[Kr+1]);if(cr>0===Ft)for(Ct=0,Fr=rt.length;Ct<Fr/2;Ct+=2){var jr=rt[Ct],xi=rt[Ct+1];rt[Ct]=rt[Fr-2-Ct],rt[Ct+1]=rt[Fr-1-Ct],rt[Fr-2-Ct]=jr,rt[Fr-1-Ct]=xi}}(Qe,st),Pe.push(Qe)}}function yi(Pe,ze){var He=(ze=this.options=function(Ke,st){for(var at in st)Ke[at]=st[at];return Ke}(Object.create(this.options),ze)).debug;if(He&&console.time("preprocess data"),ze.maxZoom<0||ze.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(ze.promoteId&&ze.generateId)throw new Error("promoteId and generateId cannot be used together.");var tt=function(Ke,st){var at=[];if(Ke.type==="FeatureCollection")for(var Qe=0;Qe<Ke.features.length;Qe++)Le(at,Ke.features[Qe],st,Qe);else Le(at,Ke.type==="Feature"?Ke:{geometry:Ke},st);return at}(Pe,ze);this.tiles={},this.tileCoords=[],He&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",ze.indexMaxZoom,ze.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),(tt=function(Ke,st){var at=st.buffer/st.extent,Qe=Ke,ut=pt(Ke,1,-1-at,at,0,-1,2,st),rt=pt(Ke,1,1-at,2+at,0,-1,2,st);return(ut||rt)&&(Qe=pt(Ke,1,-at,1+at,0,-1,2,st)||[],ut&&(Qe=zr(ut,1).concat(Qe)),rt&&(Qe=Qe.concat(zr(rt,-1)))),Qe}(tt,ze)).length&&this.splitTile(tt,0,0,0),He&&(tt.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function pi(Pe,ze,He){return 32*((1<<Pe)*He+ze)+Pe}return yi.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},yi.prototype.splitTile=function(Pe,ze,He,tt,Ke,st,at){for(var Qe=[Pe,ze,He,tt],ut=this.options,rt=ut.debug;Qe.length;){tt=Qe.pop(),He=Qe.pop(),ze=Qe.pop(),Pe=Qe.pop();var Ft=1<<ze,cr=pi(ze,He,tt),Ct=this.tiles[cr];if(!Ct&&(rt>1&&console.time("creation"),Ct=this.tiles[cr]=Ji(Pe,ze,He,tt,ut),this.tileCoords.push({z:ze,x:He,y:tt}),rt)){rt>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",ze,He,tt,Ct.numFeatures,Ct.numPoints,Ct.numSimplified),console.timeEnd("creation"));var Fr="z"+ze;this.stats[Fr]=(this.stats[Fr]||0)+1,this.total++}if(Ct.source=Pe,Ke){if(ze===ut.maxZoom||ze===Ke)continue;var Kr=1<<Ke-ze;if(He!==Math.floor(st/Kr)||tt!==Math.floor(at/Kr))continue}else if(ze===ut.indexMaxZoom||Ct.numPoints<=ut.indexMaxPoints)continue;if(Ct.source=null,Pe.length!==0){rt>1&&console.time("clipping");var jr,xi,Ni,wr,yn,Un,Ui=.5*ut.buffer/ut.extent,La=.5-Ui,Oo=.5+Ui,Us=1+Ui;jr=xi=Ni=wr=null,yn=pt(Pe,Ft,He-Ui,He+Oo,0,Ct.minX,Ct.maxX,ut),Un=pt(Pe,Ft,He+La,He+Us,0,Ct.minX,Ct.maxX,ut),Pe=null,yn&&(jr=pt(yn,Ft,tt-Ui,tt+Oo,1,Ct.minY,Ct.maxY,ut),xi=pt(yn,Ft,tt+La,tt+Us,1,Ct.minY,Ct.maxY,ut),yn=null),Un&&(Ni=pt(Un,Ft,tt-Ui,tt+Oo,1,Ct.minY,Ct.maxY,ut),wr=pt(Un,Ft,tt+La,tt+Us,1,Ct.minY,Ct.maxY,ut),Un=null),rt>1&&console.timeEnd("clipping"),Qe.push(jr||[],ze+1,2*He,2*tt),Qe.push(xi||[],ze+1,2*He,2*tt+1),Qe.push(Ni||[],ze+1,2*He+1,2*tt),Qe.push(wr||[],ze+1,2*He+1,2*tt+1)}}},yi.prototype.getTile=function(Pe,ze,He){var tt=this.options,Ke=tt.extent,st=tt.debug;if(Pe<0||Pe>24)return null;var at=1<<Pe,Qe=pi(Pe,ze=(ze%at+at)%at,He);if(this.tiles[Qe])return Ai(this.tiles[Qe],Ke);st>1&&console.log("drilling down to z%d-%d-%d",Pe,ze,He);for(var ut,rt=Pe,Ft=ze,cr=He;!ut&&rt>0;)rt--,Ft=Math.floor(Ft/2),cr=Math.floor(cr/2),ut=this.tiles[pi(rt,Ft,cr)];return ut&&ut.source?(st>1&&console.log("found parent tile z%d-%d-%d",rt,Ft,cr),st>1&&console.time("drilling down"),this.splitTile(ut.source,rt,Ft,cr,Pe,ze,He),st>1&&console.timeEnd("drilling down"),this.tiles[Qe]?Ai(this.tiles[Qe],Ke):null):null},function(Pe,ze){return new yi(Pe,ze)}}();var fi=s.dK(us.exports);function Fs(ke,W){const ie=ke.tileID.canonical;if(!this._geoJSONIndex)return W(null,null);const de=this._geoJSONIndex.getTile(ie.z,ie.x,ie.y);if(!de)return W(null,null);const Le=new Ge(de.features);let Fe=co(Le);Fe.byteOffset===0&&Fe.byteLength===Fe.buffer.byteLength||(Fe=new Uint8Array(Fe)),W(null,{vectorTile:Le,rawData:Fe.buffer})}class Ns extends lt{constructor(W,ie,de,Le,Fe,We){super(W,ie,de,Le,Fs,We),Fe&&(this.loadGeoJSON=Fe)}loadData(W,ie){const de=W&&W.request,Le=de&&de.collectResourceTiming;this.loadGeoJSON(W,(Fe,We)=>{if(Fe||!We)return ie(Fe);if(typeof We!="object")return ie(new Error(`Input data given to '${W.source}' is not a valid GeoJSON object.`));{lr(We,!0);try{if(W.filter){const De=s.r(W.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(De.result==="error")throw new Error(De.value.map(pt=>`${pt.key}: ${pt.message}`).join(", "));We={type:"FeatureCollection",features:We.features.filter(pt=>De.value.evaluate({zoom:0},pt))}}this._geoJSONIndex=W.cluster?new Rl(function({superclusterOptions:De,clusterProperties:wt}){if(!wt||!De)return De;const pt={},Et={},tr={accumulated:null,zoom:0},Or={properties:null},Hr=Object.keys(wt);for(const kr of Hr){const[Pr,Mr]=wt[kr],zr=s.r(Mr),Zr=s.r(typeof Pr=="string"?[Pr,["accumulated"],["get",kr]]:Pr);pt[kr]=zr.value,Et[kr]=Zr.value}return De.map=kr=>{Or.properties=kr;const Pr={};for(const Mr of Hr)Pr[Mr]=pt[Mr].evaluate(tr,Or);return Pr},De.reduce=(kr,Pr)=>{Or.properties=Pr;for(const Mr of Hr)tr.accumulated=kr[Mr],kr[Mr]=Et[Mr].evaluate(tr,Or)},De}(W)).load(We.features):fi(We,W.geojsonVtOptions)}catch(De){return ie(De)}this.loaded={};const vt={};if(Le){const De=te(de);De&&(vt.resourceTiming={},vt.resourceTiming[W.source]=JSON.parse(JSON.stringify(De)))}ie(null,vt)}})}reloadTile(W,ie){const de=this.loaded;return de&&de[W.uid]?super.reloadTile(W,ie):this.loadTile(W,ie)}loadGeoJSON(W,ie){if(W.request)s.g(W.request,ie);else{if(typeof W.data!="string")return ie(new Error(`Input data given to '${W.source}' is not a valid GeoJSON object.`));try{return ie(null,JSON.parse(W.data))}catch{return ie(new Error(`Input data given to '${W.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(W,ie){try{ie(null,this._geoJSONIndex.getClusterExpansionZoom(W.clusterId))}catch(de){ie(de)}}getClusterChildren(W,ie){try{ie(null,this._geoJSONIndex.getChildren(W.clusterId))}catch(de){ie(de)}}getClusterLeaves(W,ie){try{ie(null,this._geoJSONIndex.getLeaves(W.clusterId,W.limit,W.offset))}catch(de){ie(de)}}}class In{constructor(W,ie){this.tileID=new s.am(W.tileID.overscaledZ,W.tileID.wrap,W.tileID.canonical.z,W.tileID.canonical.x,W.tileID.canonical.y),this.tileZoom=W.tileZoom,this.uid=W.uid,this.zoom=W.zoom,this.canonical=W.tileID.canonical,this.pixelRatio=W.pixelRatio,this.tileSize=W.tileSize,this.source=W.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=W.projection,this.brightness=ie}parse(W,ie,de,Le){this.status="parsing";const Fe=new s.am(de.tileID.overscaledZ,de.tileID.wrap,de.tileID.canonical.z,de.tileID.canonical.x,de.tileID.canonical.y),We={},vt=ie.familiesBySource[de.source],De=new s.dC(Fe,de.promoteId);return De.bucketLayerIDs=[],De.is3DTile=!0,s.dP(W).then(wt=>{if(!wt)return Le(new Error("Could not parse tile"));const pt=s.dQ(wt,1/s.bR(de.tileID.canonical)),Et=wt.json.extensionsUsed&&wt.json.extensionsUsed.includes("MAPBOX_mesh_features")||wt.json.asset.extras&&wt.json.asset.extras.MAPBOX_mesh_features,tr=wt.json.extensionsUsed&&wt.json.extensionsUsed.includes("EXT_meshopt_compression"),Or=new s.K(this.zoom,{brightness:this.brightness});for(const Hr in vt)for(const kr of vt[Hr]){const Pr=kr[0];De.bucketLayerIDs.push(kr.map(zr=>zr.id)),Pr.recalculate(Or,[]);const Mr=new s.dR(pt,Fe,Et,tr,this.brightness,De);Et||(Mr.needsUpload=!0),We[Pr.fqid]=Mr,Mr.evaluate(Pr)}this.status="done",Le(null,{buckets:We,featureIndex:De})}).catch(wt=>Le(new Error(wt.message)))}}class fo{constructor(W,ie,de,Le,Fe,We){this.actor=W,this.layerIndex=ie,this.brightness=We,this.loading={},this.loaded={}}loadTile(W,ie){const de=W.uid,Le=this.loading[de]=new In(W,this.brightness);s.a_(W.request,(Fe,We)=>{const vt=!this.loading[de];return delete this.loading[de],vt||Fe?(Le.status="done",vt||(this.loaded[de]=Le),ie(Fe)):We&&We.byteLength!==0?void Le.parse(We,this.layerIndex,W,(De,wt)=>{Le.status="done",this.loaded=this.loaded||{},this.loaded[de]=Le,De||!wt?ie(De):ie(null,wt)}):(Le.status="done",this.loaded[de]=Le,ie())})}reloadTile(W,ie){const de=this.loaded,Le=W.uid;if(de&&de[Le]){const Fe=de[Le];Fe.projection=W.projection,Fe.brightness=W.brightness;const We=(vt,De)=>{Fe.reloadCallback&&(delete Fe.reloadCallback,this.loadTile(W,ie)),ie(vt,De)};Fe.status==="parsing"?Fe.reloadCallback=We:Fe.status==="done"&&this.loadTile(W,ie)}}abortTile(W,ie){const de=W.uid;this.loading[de]&&delete this.loading[de],ie()}removeTile(W,ie){const de=this.loaded,Le=W.uid;de&&de[Le]&&delete de[Le],ie()}}class Ro{constructor(W){this.self=W,this.actor=new s.dS(W,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=s.bo({name:"mercator"}),this.workerSourceTypes={vector:lt,geojson:Ns,"batched-model":fo},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(ie,de)=>{if(this.workerSourceTypes[ie])throw new Error(`Worker source with name "${ie}" already registered.`);this.workerSourceTypes[ie]=de},this.self.registerRTLTextPlugin=ie=>{if(s.dT.isParsed())throw new Error("RTL text plugin already registered.");s.dT.applyArabicShaping=ie.applyArabicShaping,s.dT.processBidirectionalText=ie.processBidirectionalText,s.dT.processStyledBidirectionalText=ie.processStyledBidirectionalText}}clearCaches(W,ie,de){delete this.layerIndexes[W],delete this.availableImages[W],delete this.workerSources[W],delete this.demWorkerSources[W],delete this.rasterArrayWorkerSource,de()}checkIfReady(W,ie,de){de()}setReferrer(W,ie){this.referrer=ie}spriteLoaded(W,{scope:ie,isLoaded:de}){if(this.isSpriteLoaded[W]||(this.isSpriteLoaded[W]={}),this.isSpriteLoaded[W][ie]=de,this.workerSources[W]&&this.workerSources[W][ie])for(const Le in this.workerSources[W][ie]){const Fe=this.workerSources[W][ie][Le];for(const We in Fe)Fe[We]instanceof lt&&(Fe[We].isSpriteLoaded=de,Fe[We].fire(new s.b("isSpriteLoaded")))}}setImages(W,{scope:ie,images:de},Le){if(this.availableImages[W]||(this.availableImages[W]={}),this.availableImages[W][ie]=de,this.workerSources[W]&&this.workerSources[W][ie]){for(const Fe in this.workerSources[W][ie]){const We=this.workerSources[W][ie][Fe];for(const vt in We)We[vt].availableImages=de}Le()}else Le()}setProjection(W,ie){this.projections[W]=s.bo(ie)}setBrightness(W,ie,de){this.brightness=ie,de()}setLayers(W,ie,de){this.getLayerIndex(W,ie.scope).replace(ie.layers,ie.options),de()}updateLayers(W,ie,de){this.getLayerIndex(W,ie.scope).update(ie.layers,ie.removedIds,ie.options),de()}loadTile(W,ie,de){ie.projection=this.projections[W]||this.defaultProjection,this.getWorkerSource(W,ie.type,ie.source,ie.scope).loadTile(ie,de)}loadDEMTile(W,ie,de){this.getDEMWorkerSource(W,ie.source,ie.scope).loadTile(ie,de)}decodeRasterArray(W,ie,de){this.getRasterArrayWorkerSource().decodeRasterArray(ie,de)}reloadTile(W,ie,de){ie.projection=this.projections[W]||this.defaultProjection,this.getWorkerSource(W,ie.type,ie.source,ie.scope).reloadTile(ie,de)}abortTile(W,ie,de){this.getWorkerSource(W,ie.type,ie.source,ie.scope).abortTile(ie,de)}removeTile(W,ie,de){this.getWorkerSource(W,ie.type,ie.source,ie.scope).removeTile(ie,de)}removeSource(W,ie,de){if(!(this.workerSources[W]&&this.workerSources[W][ie.scope]&&this.workerSources[W][ie.scope][ie.type]&&this.workerSources[W][ie.scope][ie.type][ie.source]))return;const Le=this.workerSources[W][ie.scope][ie.type][ie.source];delete this.workerSources[W][ie.scope][ie.type][ie.source],Le.removeSource!==void 0?Le.removeSource(ie,de):de()}loadWorkerSource(W,ie,de){try{this.self.importScripts(ie.url),de()}catch(Le){de(Le.toString())}}syncRTLPluginState(W,ie,de){try{s.dT.setState(ie);const Le=s.dT.getPluginURL();if(s.dT.isLoaded()&&!s.dT.isParsed()&&Le!=null){this.self.importScripts(Le);const Fe=s.dT.isParsed();de(Fe?void 0:new Error(`RTL Text Plugin failed to import scripts from ${Le}`),Fe)}}catch(Le){de(Le.toString())}}setDracoUrl(W,ie){this.dracoUrl=ie}getAvailableImages(W,ie){this.availableImages[W]||(this.availableImages[W]={});let de=this.availableImages[W][ie];return de||(de=[]),de}getLayerIndex(W,ie){this.layerIndexes[W]||(this.layerIndexes[W]={});let de=this.layerIndexes[W][ie];return de||(de=this.layerIndexes[W][ie]=new fe,de.scope=ie),de}getWorkerSource(W,ie,de,Le){if(this.workerSources[W]||(this.workerSources[W]={}),this.workerSources[W][Le]||(this.workerSources[W][Le]={}),this.workerSources[W][Le][ie]||(this.workerSources[W][Le][ie]={}),this.isSpriteLoaded[W]||(this.isSpriteLoaded[W]={}),!this.workerSources[W][Le][ie][de]){const Fe={send:(We,vt,De,wt,pt,Et)=>{this.actor.send(We,vt,De,W,pt,Et)},scheduler:this.actor.scheduler};this.workerSources[W][Le][ie][de]=new this.workerSourceTypes[ie](Fe,this.getLayerIndex(W,Le),this.getAvailableImages(W,Le),this.isSpriteLoaded[W][Le],void 0,this.brightness)}return this.workerSources[W][Le][ie][de]}getDEMWorkerSource(W,ie,de){return this.demWorkerSources[W]||(this.demWorkerSources[W]={}),this.demWorkerSources[W][de]||(this.demWorkerSources[W][de]={}),this.demWorkerSources[W][de][ie]||(this.demWorkerSources[W][de][ie]=new $e),this.demWorkerSources[W][de][ie]}getRasterArrayWorkerSource(){return this.rasterArrayWorkerSource||(this.rasterArrayWorkerSource=new ft),this.rasterArrayWorkerSource}enforceCacheSizeLimit(W,ie){s.dU(ie)}getWorkerPerformanceMetrics(W,ie,de){de(void 0,void 0)}}return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope&&(self.worker=new Ro(self)),Ro}),Y(["./shared"],function(s){function te(c,i){if(Array.isArray(c)){if(!Array.isArray(i)||c.length!==i.length)return!1;for(let o=0;o<c.length;o++)if(!te(c[o],i[o]))return!1;return!0}if(typeof c=="object"&&c!==null&&i!==null){if(typeof i!="object"||Object.keys(c).length!==Object.keys(i).length)return!1;for(const o in c)if(!te(c[o],i[o]))return!1;return!0}return c===i}var ae=se;function se(c){return!function(i){return typeof window>"u"||typeof document>"u"?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var u,d,p=new Blob([""],{type:"text/javascript"}),g=URL.createObjectURL(p);try{d=new Worker(g),u=!0}catch{u=!1}return d&&d.terminate(),URL.revokeObjectURL(g),u}()?function(){var u=document.createElement("canvas");u.width=u.height=1;var d=u.getContext("2d");if(!d)return!1;var p=d.getImageData(0,0,1,1);return p&&p.width===u.width}()?(fe[o=i&&i.failIfMajorPerformanceCaveat]===void 0&&(fe[o]=function(u){var d,p=function(g){var v=document.createElement("canvas"),w=Object.create(se.webGLContextAttributes);return w.failIfMajorPerformanceCaveat=g,v.getContext("webgl2",w)}(u);if(!p)return!1;try{d=p.createShader(p.VERTEX_SHADER)}catch{return!1}return!(!d||p.isContextLost())&&(p.shaderSource(d,"void main() {}"),p.compileShader(d),p.getShaderParameter(d,p.COMPILE_STATUS)===!0)}(o)),fe[o]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var o}(c)}var fe={};function _e(c,i,o){const u=document.createElement(c);return i!=null&&(u.className=i),o&&o.appendChild(u),u}function qe(c,i,o){const u=document.createElementNS("http://www.w3.org/2000/svg",c);for(const d of Object.keys(i))u.setAttributeNS(null,d,String(i[d]));return o&&o.appendChild(u),u}se.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};const nt=typeof document<"u"?document.documentElement&&document.documentElement.style:null,xt=nt&&nt.userSelect!==void 0?"userSelect":"WebkitUserSelect";let lt;function $e(){nt&&xt&&(lt=nt[xt],nt[xt]="none")}function ft(){nt&&xt&&(nt[xt]=lt)}function Nt(c){c.preventDefault(),c.stopPropagation(),window.removeEventListener("click",Nt,!0)}function Ot(){window.addEventListener("click",Nt,!0),window.setTimeout(()=>{window.removeEventListener("click",Nt,!0)},0)}function lr(c,i){const o=c.getBoundingClientRect();return Ge(c,o,i)}function Lr(c,i){const o=c.getBoundingClientRect(),u=[];for(let d=0;d<i.length;d++)u.push(Ge(c,o,i[d]));return u}function Er(c){return window.InstallTrigger!==void 0&&c.button===2&&c.ctrlKey&&window.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:c.button}function Ge(c,i,o){const u=c.offsetWidth===i.width?1:c.offsetWidth/i.width;return new s.P((o.clientX-i.left)*u,(o.clientY-i.top)*u)}class qr{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages=new Set}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(i,o){this._updatedSourceCaches[i]=o,this.setDirty()}discardSourceCacheUpdate(i){delete this._updatedSourceCaches[i]}updateLayer(i){const o=i.scope;this._updatedLayers[o]=this._updatedLayers[o]||new Set,this._updatedLayers[o].add(i.id),this.setDirty()}removeLayer(i){const o=i.scope;this._removedLayers[o]=this._removedLayers[o]||{},this._updatedLayers[o]=this._updatedLayers[o]||new Set,this._removedLayers[o][i.id]=i,this._updatedLayers[o].delete(i.id),this._updatedPaintProps.delete(i.fqid),this.setDirty()}getRemovedLayer(i){return this._removedLayers[i.scope]?this._removedLayers[i.scope][i.id]:null}discardLayerRemoval(i){this._removedLayers[i.scope]&&delete this._removedLayers[i.scope][i.id]}getLayerUpdatesByScope(){const i={};for(const o in this._updatedLayers)i[o]=i[o]||{},i[o].updatedIds=Array.from(this._updatedLayers[o].values());for(const o in this._removedLayers)i[o]=i[o]||{},i[o].removedIds=Object.keys(this._removedLayers[o]);return i}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(i){this._updatedPaintProps.add(i.fqid),this.setDirty()}getUpdatedImages(){return Array.from(this._updatedImages.values())}updateImage(i){this._updatedImages.add(i),this.setDirty()}resetUpdatedImages(){this._updatedImages.clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages.clear()}}class Gt extends s.E{constructor(i){super(),this.requestManager=i,this.models={"":{}},this.numModelsLoading={}}loadModel(i,o){return s.l(this.requestManager.transformRequest(o,s.R.Model).url).then(u=>{if(!u)return;const d=s.c(u),p=new s.M(i,void 0,void 0,d);return p.computeBoundsAndApplyParent(),p}).catch(u=>{this.fire(new s.a(new Error(`Could not load model ${i} from ${o}: ${u.message}`)))})}load(i,o){this.models[o]||(this.models[o]={});const u=Object.keys(i);this.numModelsLoading[o]=(this.numModelsLoading[o]||0)+u.length;const d=[];for(const p of u)d.push(this.loadModel(p,i[p]));Promise.allSettled(d).then(p=>{for(let g=0;g<p.length;g++){const{status:v,value:w}=p[g];v==="fulfilled"&&w&&(this.models[o][u[g]]=w)}this.numModelsLoading[o]-=u.length,this.fire(new s.b("data",{dataType:"style"}))}).catch(p=>{this.fire(new s.a(new Error(`Could not load models: ${p.message}`)))})}isLoaded(){for(const i in this.numModelsLoading)if(this.numModelsLoading[i]>0)return!1;return!0}hasModel(i,o){return!!this.getModel(i,o)}getModel(i,o){return this.models[o]||(this.models[o]={}),this.models[o][i]}addModel(i,o,u){this.models[u]||(this.models[u]={}),this.hasModel(i,u)&&this.removeModel(i,u),this.load({[i]:this.requestManager.normalizeModelURL(o)},u)}addModels(i,o){const u={};for(const d in i)u[d]=this.requestManager.normalizeModelURL(i[d]);this.load(u,o)}removeModel(i,o){this.models[o]||(this.models[o]={});const u=this.models[o][i];delete this.models[o][i],u.destroy()}listModels(i){return this.models[i]||(this.models[i]={}),Object.keys(this.models[i])}upload(i,o){this.models[o]||(this.models[o]={});for(const u in this.models[o])this.models[o][u].upload(i.context)}}class St{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(i,o,u){const d=String(o);if(this.stateChanges[i]=this.stateChanges[i]||{},this.stateChanges[i][d]=this.stateChanges[i][d]||{},s.e(this.stateChanges[i][d],u),this.deletedStates[i]===null){this.deletedStates[i]={};for(const p in this.state[i])p!==d&&(this.deletedStates[i][p]=null)}else if(this.deletedStates[i]&&this.deletedStates[i][d]===null){this.deletedStates[i][d]={};for(const p in this.state[i][d])u[p]||(this.deletedStates[i][d][p]=null)}else for(const p in u)this.deletedStates[i]&&this.deletedStates[i][d]&&this.deletedStates[i][d][p]===null&&delete this.deletedStates[i][d][p]}removeFeatureState(i,o,u){if(this.deletedStates[i]===null)return;const d=String(o);if(this.deletedStates[i]=this.deletedStates[i]||{},u&&o!==void 0)this.deletedStates[i][d]!==null&&(this.deletedStates[i][d]=this.deletedStates[i][d]||{},this.deletedStates[i][d][u]=null);else if(o!==void 0)if(this.stateChanges[i]&&this.stateChanges[i][d])for(u in this.deletedStates[i][d]={},this.stateChanges[i][d])this.deletedStates[i][d][u]=null;else this.deletedStates[i][d]=null;else this.deletedStates[i]=null}getState(i,o){const u=String(o),d=s.e({},(this.state[i]||{})[u],(this.stateChanges[i]||{})[u]);if(this.deletedStates[i]===null)return{};if(this.deletedStates[i]){const p=this.deletedStates[i][o];if(p===null)return{};for(const g in p)delete d[g]}return d}initializeTileState(i,o){i.setFeatureState(this.state,o)}coalesceChanges(i,o){const u={};for(const d in this.stateChanges){this.state[d]=this.state[d]||{};const p={};for(const g in this.stateChanges[d])this.state[d][g]||(this.state[d][g]={}),s.e(this.state[d][g],this.stateChanges[d][g]),p[g]=this.state[d][g];u[d]=p}for(const d in this.deletedStates){this.state[d]=this.state[d]||{};const p={};if(this.deletedStates[d]===null)for(const g in this.state[d])p[g]={},this.state[d][g]={};else for(const g in this.deletedStates[d]){if(this.deletedStates[d][g]===null)this.state[d][g]={};else if(this.state[d][g])for(const v of Object.keys(this.deletedStates[d][g]))delete this.state[d][g][v];p[g]=this.state[d][g]}u[d]=u[d]||{},s.e(u[d],p)}if(this.stateChanges={},this.deletedStates={},Object.keys(u).length!==0)for(const d in i)i[d].setFeatureState(u,o)}}function At(c){const{userImage:i}=c;return!!(i&&i.render&&i.render())&&(c.data.replace(new Uint8Array(i.data.buffer)),!0)}class Sr extends s.E{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded={},this.requestors=[],this.patterns={},this.atlasImage={},this.atlasTexture={},this.dirty=!0}createScope(i){this.images[i]={},this.loaded[i]=!1,this.updatedImages[i]={},this.patterns[i]={},this.callbackDispatchedThisFrame[i]={},this.atlasImage[i]=new s.h({width:1,height:1})}isLoaded(){for(const i in this.loaded)if(!this.loaded[i])return!1;return!0}setLoaded(i,o){if(this.loaded[o]!==i&&(this.loaded[o]=i,i)){for(const{ids:u,callback:d}of this.requestors)this._notify(u,o,d);this.requestors=[]}}hasImage(i,o){return!!this.getImage(i,o)}getImage(i,o){return this.images[o][i]}addImage(i,o,u){this._validate(i,u)&&(this.images[o][i]=u)}_validate(i,o){let u=!0;return this._validateStretch(o.stretchX,o.data&&o.data.width)||(this.fire(new s.a(new Error(`Image "${i}" has invalid "stretchX" value`))),u=!1),this._validateStretch(o.stretchY,o.data&&o.data.height)||(this.fire(new s.a(new Error(`Image "${i}" has invalid "stretchY" value`))),u=!1),this._validateContent(o.content,o)||(this.fire(new s.a(new Error(`Image "${i}" has invalid "content" value`))),u=!1),u}_validateStretch(i,o){if(!i)return!0;let u=0;for(const d of i){if(d[0]<u||d[1]<d[0]||o<d[1])return!1;u=d[1]}return!0}_validateContent(i,o){return!(i&&(i.length!==4||i[0]<0||o.data.width<i[0]||i[1]<0||o.data.height<i[1]||i[2]<0||o.data.width<i[2]||i[3]<0||o.data.height<i[3]||i[2]<i[0]||i[3]<i[1]))}updateImage(i,o,u){u.version=this.images[o][i].version+1,this.images[o][i]=u,this.updatedImages[o][i]=!0}removeImage(i,o){const u=this.images[o][i];delete this.images[o][i],delete this.patterns[o][i],u.userImage&&u.userImage.onRemove&&u.userImage.onRemove()}listImages(i){return Object.keys(this.images[i])}getImages(i,o,u){let d=!0;const p=!!this.loaded[o];if(!p)for(const g of i)this.images[o][g]||(d=!1);p||d?this._notify(i,o,u):this.requestors.push({ids:i,scope:o,callback:u})}getUpdatedImages(i){return this.updatedImages[i]}_notify(i,o,u){const d={};for(const p of i){this.images[o][p]||this.fire(new s.b("styleimagemissing",{id:p}));const g=this.images[o][p];g?d[p]={data:g.data.clone(),pixelRatio:g.pixelRatio,sdf:g.sdf,version:g.version,stretchX:g.stretchX,stretchY:g.stretchY,content:g.content,hasRenderCallback:!!(g.userImage&&g.userImage.render)}:s.w(`Image "${p}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}u(null,d)}getPixelSize(i){const{width:o,height:u}=this.atlasImage[i];return{width:o,height:u}}getPattern(i,o){const u=this.patterns[o][i],d=this.getImage(i,o);if(!d)return null;if(u&&u.position.version===d.version)return u.position;if(u)u.position.version=d.version;else{const p={w:d.data.width+2,h:d.data.height+2,x:0,y:0},g=new s.I(p,d);this.patterns[o][i]={bin:p,position:g}}return this._updatePatternAtlas(o),this.patterns[o][i].position}bind(i,o){const u=i.gl;let d=this.atlasTexture[o];d?this.dirty&&(d.update(this.atlasImage[o]),this.dirty=!1):(d=new s.T(i,this.atlasImage[o],u.RGBA),this.atlasTexture[o]=d),d.bind(u.LINEAR,u.CLAMP_TO_EDGE)}_updatePatternAtlas(i){const o=[];for(const g in this.patterns[i])o.push(this.patterns[i][g].bin);const{w:u,h:d}=s.p(o),p=this.atlasImage[i];p.resize({width:u||1,height:d||1});for(const g in this.patterns[i]){const{bin:v}=this.patterns[i][g],w=v.x+1,M=v.y+1,I=this.images[i][g].data,S=I.width,z=I.height;s.h.copy(I,p,{x:0,y:0},{x:w,y:M},{width:S,height:z}),s.h.copy(I,p,{x:0,y:z-1},{x:w,y:M-1},{width:S,height:1}),s.h.copy(I,p,{x:0,y:0},{x:w,y:M+z},{width:S,height:1}),s.h.copy(I,p,{x:S-1,y:0},{x:w-1,y:M},{width:1,height:z}),s.h.copy(I,p,{x:0,y:0},{x:w+S,y:M},{width:1,height:z})}this.dirty=!0}beginFrame(){for(const i in this.images)this.callbackDispatchedThisFrame[i]={}}dispatchRenderCallbacks(i,o){for(const u of i){if(this.callbackDispatchedThisFrame[o][u])continue;this.callbackDispatchedThisFrame[o][u]=!0;const d=this.images[o][u];At(d)&&this.updateImage(u,o,d)}}}class it{constructor(i,o,u,d){this.message=(i?`${i}: `:"")+u,d&&(this.identifier=d),o!=null&&o.__line__&&(this.line=o.__line__)}}class Ti extends it{}function oi(c){const i=c.key,o=c.value,u=c.valueSpec||{},d=c.objectElementValidators||{},p=c.style,g=c.styleSpec;let v=[];const w=s.i(o);if(w!=="object")return[new it(i,o,`object expected, ${w} found`)];for(const M in o){const I=M.split(".")[0];let S;d[I]?S=d[I]:u[I]?S=fi:d["*"]?S=d["*"]:u["*"]&&(S=fi),S?v=v.concat(S({key:(i&&`${i}.`)+M,value:o[M],valueSpec:u[I]||u["*"],style:p,styleSpec:g,object:o,objectKey:M},o)):v.push(new Ti(i,o[M],`unknown property "${M}"`))}for(const M in u)d[M]||u[M].required&&u[M].default===void 0&&o[M]===void 0&&v.push(new it(i,o,`missing required property "${M}"`));return v}function Ut(c){const i=c.value,o=c.valueSpec,u=c.style,d=c.styleSpec,p=c.key,g=c.arrayElementValidator||fi;if(s.i(i)!=="array")return[new it(p,i,`array expected, ${s.i(i)} found`)];if(o.length&&i.length!==o.length)return[new it(p,i,`array length ${o.length} expected, length ${i.length} found`)];if(o["min-length"]&&i.length<o["min-length"])return[new it(p,i,`array length at least ${o["min-length"]} expected, length ${i.length} found`)];let v={type:o.value,values:o.values,minimum:o.minimum,maximum:o.maximum,function:void 0};d.$version<7&&(v.function=o.function),s.i(o.value)==="object"&&(v=o.value);let w=[];for(let M=0;M<i.length;M++)w=w.concat(g({array:i,arrayIndex:M,value:i[M],valueSpec:v,style:u,styleSpec:d,key:`${p}[${M}]`},!0));return w}function Ei(c){const i=c.key,o=c.value,u=c.valueSpec;let d=s.i(o);if(d==="number"&&o!=o&&(d="NaN"),d!=="number")return[new it(i,o,`number expected, ${d} found`)];if("minimum"in u){let p=u.minimum;if(s.i(u.minimum)==="array"&&(p=u.minimum[c.arrayIndex]),o<p)return[new it(i,o,`${o} is less than the minimum value ${p}`)]}if("maximum"in u){let p=u.maximum;if(s.i(u.maximum)==="array"&&(p=u.maximum[c.arrayIndex]),o>p)return[new it(i,o,`${o} is greater than the maximum value ${p}`)]}return[]}function mn(c){const i=c.valueSpec,o=s.u(c.value.type);let u,d,p,g={};const v=o!=="categorical"&&c.value.property===void 0,w=!v,M=s.i(c.value.stops)==="array"&&s.i(c.value.stops[0])==="array"&&s.i(c.value.stops[0][0])==="object",I=oi({key:c.key,value:c.value,valueSpec:c.styleSpec.function,style:c.style,styleSpec:c.styleSpec,objectElementValidators:{stops:function(R){if(o==="identity")return[new it(R.key,R.value,'identity function may not have a "stops" property')];let U=[];const N=R.value;return U=U.concat(Ut({key:R.key,value:N,valueSpec:R.valueSpec,style:R.style,styleSpec:R.styleSpec,arrayElementValidator:S})),s.i(N)==="array"&&N.length===0&&U.push(new it(R.key,N,"array must have at least one stop")),U},default:function(R){return fi({key:R.key,value:R.value,valueSpec:i,style:R.style,styleSpec:R.styleSpec})}}});return o==="identity"&&v&&I.push(new it(c.key,c.value,'missing required property "property"')),o==="identity"||c.value.stops||I.push(new it(c.key,c.value,'missing required property "stops"')),o==="exponential"&&c.valueSpec.expression&&!s.s(c.valueSpec)&&I.push(new it(c.key,c.value,"exponential functions not supported")),c.styleSpec.$version>=8&&(w&&!s.k(c.valueSpec)?I.push(new it(c.key,c.value,"property functions not supported")):v&&!s.m(c.valueSpec)&&I.push(new it(c.key,c.value,"zoom functions not supported"))),o!=="categorical"&&!M||c.value.property!==void 0||I.push(new it(c.key,c.value,'"property" property is required')),I;function S(R){let U=[];const N=R.value,V=R.key;if(s.i(N)!=="array")return[new it(V,N,`array expected, ${s.i(N)} found`)];if(N.length!==2)return[new it(V,N,`array length 2 expected, length ${N.length} found`)];if(M){if(s.i(N[0])!=="object")return[new it(V,N,`object expected, ${s.i(N[0])} found`)];if(N[0].zoom===void 0)return[new it(V,N,"object stop key must have zoom")];if(N[0].value===void 0)return[new it(V,N,"object stop key must have value")];const B=s.u(N[0].zoom);if(typeof B!="number")return[new it(V,N[0].zoom,"stop zoom values must be numbers")];if(p&&p>B)return[new it(V,N[0].zoom,"stop zoom values must appear in ascending order")];B!==p&&(p=B,d=void 0,g={}),U=U.concat(oi({key:`${V}[0]`,value:N[0],valueSpec:{zoom:{}},style:R.style,styleSpec:R.styleSpec,objectElementValidators:{zoom:Ei,value:z}}))}else U=U.concat(z({key:`${V}[0]`,value:N[0],valueSpec:{},style:R.style,styleSpec:R.styleSpec},N));return s.n(s.o(N[1]))?U.concat([new it(`${V}[1]`,N[1],"expressions are not allowed in function stops.")]):U.concat(fi({key:`${V}[1]`,value:N[1],valueSpec:i,style:R.style,styleSpec:R.styleSpec}))}function z(R,U){const N=s.i(R.value),V=s.u(R.value),B=R.value!==null?R.value:U;if(u){if(N!==u)return[new it(R.key,B,`${N} stop domain type must match previous stop domain type ${u}`)]}else u=N;if(N!=="number"&&N!=="string"&&N!=="boolean"&&typeof V!="number"&&typeof V!="string"&&typeof V!="boolean")return[new it(R.key,B,"stop domain value must be a number, string, or boolean")];if(N!=="number"&&o!=="categorical"){let G=`number expected, ${N} found`;return s.k(i)&&o===void 0&&(G+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new it(R.key,B,G)]}return o!=="categorical"||N!=="number"||typeof V=="number"&&isFinite(V)&&Math.floor(V)===V?o!=="categorical"&&N==="number"&&typeof V=="number"&&typeof d=="number"&&d!==void 0&&V<d?[new it(R.key,B,"stop domain values must appear in ascending order")]:(d=V,o==="categorical"&&V in g?[new it(R.key,B,"stop domain values must be unique")]:(g[V]=!0,[])):[new it(R.key,B,`integer expected, found ${String(V)}`)]}}function qi(c){const i=(c.expressionContext==="property"?s.q:s.r)(s.o(c.value),c.valueSpec);if(i.result==="error")return i.value.map(u=>new it(`${c.key}${u.key}`,c.value,u.message));const o=i.value.expression||i.value._styleExpression.expression;if(c.expressionContext==="property"&&c.propertyKey==="text-font"&&!o.outputDefined())return[new it(c.key,c.value,`Invalid data expression for "${c.propertyKey}". Output values must be contained as literals within the expression.`)];if(c.expressionContext==="property"&&c.propertyType==="layout"&&!s.t(o))return[new it(c.key,c.value,'"feature-state" data expressions are not supported with layout properties.')];if(c.expressionContext==="filter")return gi(o,c);if(c.expressionContext&&c.expressionContext.indexOf("cluster")===0){if(!s.v(o,["zoom","feature-state"]))return[new it(c.key,c.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(c.expressionContext==="cluster-initial"&&!s.x(o))return[new it(c.key,c.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function gi(c,i){const o=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(i.valueSpec&&i.valueSpec.expression)for(const d of i.valueSpec.expression.parameters)o.delete(d);if(o.size===0)return[];const u=[];return c instanceof s.C&&o.has(c.name)?[new it(i.key,i.value,`["${c.name}"] expression is not supported in a filter for a ${i.object.type} layer with id: ${i.object.id}`)]:(c.eachChild(d=>{u.push(...gi(d,i))}),u)}function Fn(c){const i=c.key,o=c.value,u=c.valueSpec,d=[];return Array.isArray(u.values)?u.values.indexOf(s.u(o))===-1&&d.push(new it(i,o,`expected one of [${u.values.join(", ")}], ${JSON.stringify(o)} found`)):Object.keys(u.values).indexOf(s.u(o))===-1&&d.push(new it(i,o,`expected one of [${Object.keys(u.values).join(", ")}], ${JSON.stringify(o)} found`)),d}function eo(c){return s.z(s.o(c.value))?qi(s.j({},c,{expressionContext:"filter",valueSpec:c.styleSpec[`filter_${c.layerType||"fill"}`]})):Yi(c)}function Yi(c){const i=c.value,o=c.key;if(s.i(i)!=="array")return[new it(o,i,`array expected, ${s.i(i)} found`)];const u=c.styleSpec;let d,p=[];if(i.length<1)return[new it(o,i,"filter array must have at least 1 element")];switch(p=p.concat(Fn({key:`${o}[0]`,value:i[0],valueSpec:u.filter_operator,style:c.style,styleSpec:c.styleSpec})),s.u(i[0])){case"<":case"<=":case">":case">=":i.length>=2&&s.u(i[1])==="$type"&&p.push(new it(o,i,`"$type" cannot be use with operator "${i[0]}"`));case"==":case"!=":i.length!==3&&p.push(new it(o,i,`filter array for operator "${i[0]}" must have 3 elements`));case"in":case"!in":i.length>=2&&(d=s.i(i[1]),d!=="string"&&p.push(new it(`${o}[1]`,i[1],`string expected, ${d} found`)));for(let g=2;g<i.length;g++)d=s.i(i[g]),s.u(i[1])==="$type"?p=p.concat(Fn({key:`${o}[${g}]`,value:i[g],valueSpec:u.geometry_type,style:c.style,styleSpec:c.styleSpec})):d!=="string"&&d!=="number"&&d!=="boolean"&&p.push(new it(`${o}[${g}]`,i[g],`string, number, or boolean expected, ${d} found`));break;case"any":case"all":case"none":for(let g=1;g<i.length;g++)p=p.concat(Yi({key:`${o}[${g}]`,value:i[g],style:c.style,styleSpec:c.styleSpec}));break;case"has":case"!has":d=s.i(i[1]),i.length!==2?p.push(new it(o,i,`filter array for "${i[0]}" operator must have 2 elements`)):d!=="string"&&p.push(new it(`${o}[1]`,i[1],`string expected, ${d} found`))}return p}function co(c,i){const o=c.key,u=c.style,d=c.layer,p=c.styleSpec,g=c.value,v=c.objectKey,w=p[`${i}_${c.layerType}`];if(!w)return[];const M=v.match(/^(.*)-transition$/);if(i==="paint"&&M&&w[M[1]]&&w[M[1]].transition)return fi({key:o,value:g,valueSpec:p.transition,style:u,styleSpec:p});const I=c.valueSpec||w[v];if(!I)return[new Ti(o,g,`unknown property "${v}"`)];let S;if(s.i(g)==="string"&&s.k(I)&&!I.tokens&&(S=/^{([^}]+)}$/.exec(g))){const R=`\`{ "type": "identity", "property": ${S?JSON.stringify(S[1]):'"_"'} }\``;return[new it(o,g,`"${v}" does not support interpolation syntax
Use an identity property function instead: ${R}.`)]}const z=[];if(c.layerType==="symbol")v!=="text-field"||!u||u.glyphs||u.imports||z.push(new it(o,g,'use of "text-field" requires a style "glyphs" property')),v==="text-font"&&s.A(s.o(g))&&s.u(g.type)==="identity"&&z.push(new it(o,g,'"text-font" does not support identity functions'));else if(c.layerType==="model"&&i==="paint"&&d&&d.layout&&d.layout.hasOwnProperty("model-id")&&s.k(I)&&(s.B(I)||s.m(I))){const R=s.q(s.o(g),I),U=R.value.expression||R.value._styleExpression.expression;U&&!s.v(U,["measure-light"])&&(v==="model-emissive-strength"&&s.x(U)&&s.t(U)||z.push(new it(o,g,`${v} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return z.concat(fi({key:c.key,value:g,valueSpec:I,style:u,styleSpec:p,expressionContext:"property",propertyType:i,propertyKey:v}))}function uo(c){return co(c,"paint")}function Nn(c){return co(c,"layout")}function _n(c){let i=[];const o=c.value,u=c.key,d=c.style,p=c.styleSpec;o.type||o.ref||i.push(new it(u,o,'either "type" or "ref" is required'));let g=s.u(o.type);const v=s.u(o.ref);if(o.id){const w=s.u(o.id);for(let M=0;M<c.arrayIndex;M++){const I=d.layers[M];s.u(I.id)===w&&i.push(new it(u,o.id,`duplicate layer id "${o.id}", previously used at line ${I.id.__line__}`))}}if("ref"in o){let w;["type","source","source-layer","filter","layout"].forEach(M=>{M in o&&i.push(new it(u,o[M],`"${M}" is prohibited for ref layers`))}),d.layers.forEach(M=>{s.u(M.id)===v&&(w=M)}),w?w.ref?i.push(new it(u,o.ref,"ref cannot reference another ref layer")):g=s.u(w.type):typeof v=="string"&&i.push(new it(u,o.ref,`ref layer "${v}" not found`))}else if(g!=="background"&&g!=="sky"&&g!=="slot")if(o.source){const w=d.sources&&d.sources[o.source],M=w&&s.u(w.type);w?M==="vector"&&g==="raster"?i.push(new it(u,o.source,`layer "${o.id}" requires a raster source`)):M==="raster"&&g!=="raster"?i.push(new it(u,o.source,`layer "${o.id}" requires a vector source`)):M!=="vector"||o["source-layer"]?M==="raster-dem"&&g!=="hillshade"?i.push(new it(u,o.source,"raster-dem source can only be used with layer type 'hillshade'.")):M!=="raster-array"||["raster","raster-particle"].includes(g)?g!=="line"||!o.paint||!o.paint["line-gradient"]&&!o.paint["line-trim-offset"]||M==="geojson"&&w.lineMetrics?g==="raster-particle"&&M!=="raster-array"&&i.push(new it(u,o.source,`layer "${o.id}" requires a 'raster-array' source.`)):i.push(new it(u,o,`layer "${o.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):i.push(new it(u,o.source,"raster-array source can only be used with layer type 'raster'.")):i.push(new it(u,o,`layer "${o.id}" must specify a "source-layer"`)):i.push(new it(u,o.source,`source "${o.source}" not found`))}else i.push(new it(u,o,'missing required property "source"'));return i=i.concat(oi({key:u,value:o,valueSpec:p.layer,style:c.style,styleSpec:c.styleSpec,objectElementValidators:{"*":()=>[],type:()=>fi({key:`${u}.type`,value:o.type,valueSpec:p.layer.type,style:c.style,styleSpec:c.styleSpec,object:o,objectKey:"type"}),filter:w=>eo(s.j({layerType:g},w)),layout:w=>oi({layer:o,key:w.key,value:w.value,valueSpec:{},style:w.style,styleSpec:w.styleSpec,objectElementValidators:{"*":M=>Nn(s.j({layerType:g},M))}}),paint:w=>oi({layer:o,key:w.key,value:w.value,valueSpec:{},style:w.style,styleSpec:w.styleSpec,objectElementValidators:{"*":M=>uo(s.j({layerType:g,layer:o},M))}})}})),i}function Ci(c){const i=c.value,o=c.key,u=s.i(i);return u!=="string"?[new it(o,i,`string expected, ${u} found`)]:[]}const Ki={promoteId:function({key:c,value:i}){if(s.i(i)==="string")return Ci({key:c,value:i});{const o=[];for(const u in i)o.push(...Ci({key:`${c}.${u}`,value:i[u]}));return o}}};function gn(c){const i=c.value,o=c.key,u=c.styleSpec,d=c.style;if(!i.type)return[new it(o,i,'"type" is required')];const p=s.u(i.type);let g=[];switch(["vector","raster","raster-dem","raster-array"].includes(p)&&(i.url||i.tiles||g.push(new Ti(o,i,'Either "url" or "tiles" is required.'))),p){case"vector":case"raster":case"raster-dem":case"raster-array":return g=g.concat(oi({key:o,value:i,valueSpec:u[`source_${p.replace("-","_")}`],style:c.style,styleSpec:u,objectElementValidators:Ki})),g;case"geojson":if(g=oi({key:o,value:i,valueSpec:u.source_geojson,style:d,styleSpec:u,objectElementValidators:Ki}),i.cluster)for(const v in i.clusterProperties){const[w,M]=i.clusterProperties[v],I=typeof w=="string"?[w,["accumulated"],["get",v]]:w;g.push(...qi({key:`${o}.${v}.map`,value:M,expressionContext:"cluster-map"})),g.push(...qi({key:`${o}.${v}.reduce`,value:I,expressionContext:"cluster-reduce"}))}return g;case"video":return oi({key:o,value:i,valueSpec:u.source_video,style:d,styleSpec:u});case"image":return oi({key:o,value:i,valueSpec:u.source_image,style:d,styleSpec:u});case"canvas":return[new it(o,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Fn({key:`${o}.type`,value:i.type,valueSpec:{values:Rl(u)},style:d,styleSpec:u})}}function Rl(c){return c.source.reduce((i,o)=>{const u=c[o];return u.type.type==="enum"&&(i=i.concat(Object.keys(u.type.values))),i},[])}function li(c){const i=c.value;let o=[];if(!i)return o;const u=s.i(i);return u!=="string"?(o=o.concat([new it(c.key,i,`string expected, "${u}" found`)]),o):(function(d){const p=d.indexOf("://")===-1;try{return new URL(d,p?"http://example.com":void 0),!0}catch{return!1}}(i)||(o=o.concat([new it(c.key,i,`invalid url "${i}"`)])),o)}function Mn(c){const i=c.value,o=c.styleSpec,u=o.light,d=c.style;let p=[];const g=s.i(i);if(i===void 0)return p;if(g!=="object")return p=p.concat([new it("light",i,`object expected, ${g} found`)]),p;for(const v in i){const w=v.match(/^(.*)-transition$/);p=p.concat(w&&u[w[1]]&&u[w[1]].transition?fi({key:v,value:i[v],valueSpec:o.transition,style:d,styleSpec:o}):u[v]?fi({key:v,value:i[v],valueSpec:u[v],style:d,styleSpec:o}):[new it(v,i[v],`unknown property "${v}"`)])}return p}function cs(c){const i=c.value;let o=[];if(!i)return o;const u=s.i(i);if(u!=="object")return o=o.concat([new it("light-3d",i,`object expected, ${u} found`)]),o;const d=c.styleSpec,p=d["light-3d"],g=c.key,v=c.style,w=c.style.lights;for(const S of["type","id"])if(!(S in i))return o=o.concat([new it("light-3d",i,`missing property ${S} on light`)]),o;if(i.type&&w)for(let S=0;S<c.arrayIndex;S++){const z=s.u(i.type),R=w[S];s.u(R.type)===z&&o.push(new it(g,i.id,`duplicate light type "${i.type}", previously defined at line ${R.id.__line__}`))}const M=`properties_light_${i.type}`;if(!(M in d))return o=o.concat([new it("light-3d",i,`Invalid light type ${i.type}`)]),o;const I=d[M];for(const S in i)if(S==="properties"){const z=i[S],R=s.i(z);if(R!=="object")return o=o.concat([new it("properties",z,`object expected, ${R} found`)]),o;for(const U in z)o=o.concat(I[U]?fi({key:U,value:z[U],valueSpec:I[U],style:v,styleSpec:d}):[new Ti(c.key,z[U],`unknown property "${U}"`)])}else{const z=S.match(/^(.*)-transition$/);o=o.concat(z&&p[z[1]]&&p[z[1]].transition?fi({key:S,value:i[S],valueSpec:d.transition,style:v,styleSpec:d}):p[S]?fi({key:S,value:i[S],valueSpec:p[S],style:v,styleSpec:d}):[new Ti(S,i[S],`unknown property "${S}"`)])}return o}function ho(c){const i=c.value,o=c.key,u=c.style,d=c.styleSpec,p=d.terrain;let g=[];const v=s.i(i);if(i===void 0||v==="null")return g;if(v!=="object")return g=g.concat([new it("terrain",i,`object expected, ${v} found`)]),g;for(const w in i){const M=w.match(/^(.*)-transition$/);g=g.concat(M&&p[M[1]]&&p[M[1]].transition?fi({key:w,value:i[w],valueSpec:d.transition,style:u,styleSpec:d}):p[w]?fi({key:w,value:i[w],valueSpec:p[w],style:u,styleSpec:d}):[new Ti(w,i[w],`unknown property "${w}"`)])}if(i.source){const w=u.sources&&u.sources[i.source],M=w&&s.u(w.type);w?M!=="raster-dem"&&g.push(new it(o,i.source,`terrain cannot be used with a source of type ${String(M)}, it only be used with a "raster-dem" source type`)):g.push(new it(o,i.source,`source "${i.source}" not found`))}else g.push(new it(o,i,'terrain is missing required property "source"'));return g}function to(c){const i=c.value,o=c.style,u=c.styleSpec,d=u.fog;let p=[];const g=s.i(i);if(i===void 0)return p;if(g!=="object")return p=p.concat([new it("fog",i,`object expected, ${g} found`)]),p;for(const v in i){const w=v.match(/^(.*)-transition$/);p=p.concat(w&&d[w[1]]&&d[w[1]].transition?fi({key:v,value:i[v],valueSpec:u.transition,style:o,styleSpec:u}):d[v]?fi({key:v,value:i[v],valueSpec:d[v],style:o,styleSpec:u}):[new Ti(v,i[v],`unknown property "${v}"`)])}return p}const us={"*":()=>[],array:Ut,boolean:function(c){const i=c.value,o=c.key,u=s.i(i);return u!=="boolean"?[new it(o,i,`boolean expected, ${u} found`)]:[]},number:Ei,color:function(c){const i=c.key,o=c.value,u=s.i(o);return u!=="string"?[new it(i,o,`color expected, ${u} found`)]:s.y(o)===null?[new it(i,o,`color expected, "${o}" found`)]:[]},enum:Fn,filter:eo,function:mn,layer:_n,object:oi,source:gn,model:li,light:Mn,"light-3d":cs,terrain:ho,fog:to,string:Ci,formatted:function(c){return Ci(c).length===0?[]:qi(c)},resolvedImage:function(c){return Ci(c).length===0?[]:qi(c)},projection:function(c){const i=c.value,o=c.styleSpec,u=o.projection,d=c.style;let p=[];const g=s.i(i);if(g==="object")for(const v in i)p=p.concat(fi({key:v,value:i[v],valueSpec:u[v],style:d,styleSpec:o}));else g!=="string"&&(p=p.concat([new it("projection",i,`object or string expected, ${g} found`)]));return p},import:function(c){const{value:i,styleSpec:o}=c,{data:u,...d}=i;Object.defineProperty(d,"__line__",{value:i.__line__,enumerable:!1});let p=oi(s.j({},c,{value:d,valueSpec:o.import}));return s.u(d.id)===""&&p.push(new it(`${c.key}.id`,d,"import id can't be an empty string")),u&&(p=p.concat(Ns(u,o,{key:`${c.key}.data`}))),p}};function fi(c,i=!1){const o=c.value,u=c.valueSpec,d=c.styleSpec;if(u.expression&&s.A(s.u(o)))return mn(c);if(u.expression&&s.n(s.o(o)))return qi(c);if(u.type&&us[u.type]){const p=us[u.type](c);return i===!0&&p.length>0&&s.i(c.value)==="array"?qi(c):p}return oi(s.j({},c,{valueSpec:u.type?d[u.type]:u}))}function Fs(c){const i=c.value,o=c.key,u=Ci(c);return u.length||(i.indexOf("{fontstack}")===-1&&u.push(new it(o,i,'"glyphs" url must include a "{fontstack}" token')),i.indexOf("{range}")===-1&&u.push(new it(o,i,'"glyphs" url must include a "{range}" token'))),u}function Ns(c,i=s.D,o={}){return fi({key:o.key||"",value:c,valueSpec:i.$root,styleSpec:i,style:c,objectElementValidators:{glyphs:Fs,"*":()=>[]}})}function In(c,i=s.D){return De(Ns(c,i))}const fo=c=>De(gn(c)),Ro=c=>De(Mn(c)),ke=c=>De(cs(c)),W=c=>De(ho(c)),ie=c=>De(to(c)),de=c=>De(_n(c)),Le=c=>De(eo(c)),Fe=c=>De(uo(c)),We=c=>De(Nn(c)),vt=c=>De(li(c));function De(c){return c.slice().sort((i,o)=>i.line&&o.line?i.line-o.line:0)}function wt(c,i){let o=!1;if(i&&i.length)for(const u of i)u instanceof Ti?s.w(u.message):(c.fire(new s.a(new Error(u.message))),o=!0);return o}const pt=new s.F({anchor:new s.G(s.D.light.anchor),position:new s.H(s.D.light.position),color:new s.G(s.D.light.color),intensity:new s.G(s.D.light.intensity)});class Et extends s.E{constructor(i,o="flat"){super(),this._transitionable=new s.J(pt),this.setLight(i,o),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(i,o,u={}){this._validate(Ro,i,u)||(this._transitionable.setTransitionOrValue(i),this.id=o)}updateTransitions(i){this._transitioning=this._transitionable.transitioned(i,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(i){this.properties=this._transitioning.possiblyEvaluate(i)}_validate(i,o,u){return(!u||u.validate!==!1)&&wt(this,i.call(In,s.e({value:o,style:{glyphs:!0,sprite:!0},styleSpec:s.D})))}}const tr=new s.F({source:new s.G(s.D.terrain.source),exaggeration:new s.G(s.D.terrain.exaggeration)});let Or=class extends s.E{constructor(c,i,o,u){super(),this.scope=o,this._transitionable=new s.J(tr,o,u),this._transitionable.setTransitionOrValue(c,u),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=i}get(){return this._transitionable.serialize()}set(c,i){this._transitionable.setTransitionOrValue(c,i)}updateTransitions(c){this._transitioning=this._transitionable.transitioned(c,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(c){this.properties=this._transitioning.possiblyEvaluate(c)}getExaggeration(c){return this._transitioning.possiblyEvaluate(new s.K(c)).get("exaggeration")}isZoomDependent(){const c=this._transitionable._values.exaggeration;return c!=null&&c.value!=null&&c.value.expression!=null&&c.value.expression instanceof s.Z}};const Hr=45,kr=65,Pr=.05;function Mr(c,i,o,u){const d=s.O(Hr,kr,o),[p,g]=zr(c,u);let v=1-Math.min(1,Math.exp((i-p)/(g-p)*-6));return v*=v*v,v=Math.min(1,1.00747*v),v*d*c.alpha}function zr(c,i){const o=.5/Math.tan(.5*i);return[c.range[0]+o,c.range[1]+o]}function Zr(c,i,o,u,d){const p=s.N.transformMat4([],[i,o,u],d.mercatorFogMatrix);return Mr(c,s.N.length(p),d.pitch,d._fov)}function Ai(c,i,o,u,d,p,g){const v=[[o,u,0],[d,u,0],[d,p,0],[o,p,0]];let w=Number.MAX_VALUE,M=-Number.MAX_VALUE;for(const I of v){const S=s.N.transformMat4([],I,i),z=s.N.length(S);w=Math.min(w,z),M=Math.max(M,z)}return[Mr(c,w,g.pitch,g._fov),Mr(c,M,g.pitch,g._fov)]}const Wr=new s.F({range:new s.G(s.D.fog.range),color:new s.G(s.D.fog.color),"high-color":new s.G(s.D.fog["high-color"]),"space-color":new s.G(s.D.fog["space-color"]),"horizon-blend":new s.G(s.D.fog["horizon-blend"]),"star-intensity":new s.G(s.D.fog["star-intensity"]),"vertical-range":new s.G(s.D.fog["vertical-range"])});class Ji extends s.E{constructor(i,o,u,d){super(),this._transitionable=new s.J(Wr,u,new Map(d)),this.set(i,d),this._transitioning=this._transitionable.untransitioned(),this._transform=o,this.properties=new s.Q(Wr)}get state(){const i=this._transform,o=i.projection.name==="globe",u=s.S(i.zoom),d=this.properties.get("range"),p=[.5,3];return{range:o?[s.U(p[0],d[0],u),s.U(p[1],d[1],u)]:d,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(i,o,u={}){if(this._validate(ie,i,u))return;const d=s.e({},i);for(const p of Object.keys(s.D.fog))d[p]===void 0&&(d[p]=s.D.fog[p].default);this._options=d,this._transitionable.setTransitionOrValue(this._options,o)}getOpacity(i){if(!this._transform.projection.supportsFog)return 0;const o=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:s.O(Hr,kr,i))*o.a}getOpacityAtLatLng(i,o){return this._transform.projection.supportsFog?function(u,d,p){const g=s.L.fromLngLat(d),v=p.elevation?p.elevation.getAtPointOrZero(g):0;return Zr(u,g.x,g.y,v,p)}(this.state,i,o):0}getOpacityForTile(i){if(!this._transform.projection.supportsFog)return[1,1];const o=this._transform.calculateFogTileMatrix(i.toUnwrapped());return Ai(this.state,o,0,0,s.V,s.V,this._transform)}getOpacityForBounds(i,o,u,d,p){return this._transform.projection.supportsFog?Ai(this.state,i,o,u,d,p,this._transform):[1,1]}getFovAdjustedRange(i){return this._transform.projection.supportsFog?zr(this.state,i):[0,1]}isVisibleOnFrustum(i){if(!this._transform.projection.supportsFog)return!1;const o=[4,5,6,7];for(const u of o){const d=i.points[u];let p;if(d[2]>=0)p=d;else{const g=i.points[u-4];p=s.W(g,d,g[2]/(g[2]-d[2]))}if(Zr(this.state,p[0],p[1],0,this._transform)>=Pr)return!0}return!1}updateConfig(i){this._transitionable.setTransitionOrValue(this._options,new Map(i))}updateTransitions(i){this._transitioning=this._transitionable.transitioned(i,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(i){this.properties=this._transitioning.possiblyEvaluate(i)}_validate(i,o,u){return(!u||u.validate!==!1)&&wt(this,i.call(In,s.e({value:o,style:{glyphs:!0,sprite:!0},styleSpec:s.D})))}}class Wi extends s.E{constructor(i,o,u,d){super(),this.scope=u,this._options=i,this.properties=new s.Q(o),this._transitionable=new s.J(o,u,new Map(d)),this._transitionable.setTransitionOrValue(i.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(i){this._transitionable.setTransitionOrValue(this._options.properties,new Map(i))}updateTransitions(i){this._transitioning=this._transitionable.transitioned(i,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(i){this.properties=this._transitioning.possiblyEvaluate(i)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(i,o){this._options=i,this._transitionable.setTransitionOrValue(i.properties,o)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}const nn=new s.F({color:new s.G(s.D.properties_light_ambient.color),intensity:new s.G(s.D.properties_light_ambient.intensity)}),yi=new s.F({direction:new s.X(s.D.properties_light_directional.direction),color:new s.G(s.D.properties_light_directional.color),intensity:new s.G(s.D.properties_light_directional.intensity),"cast-shadows":new s.G(s.D.properties_light_directional["cast-shadows"]),"shadow-intensity":new s.G(s.D.properties_light_directional["shadow-intensity"])});class pi{constructor(i,o,u,d){this.screenBounds=i,this.cameraPoint=o,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=u,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,d)}static createFromScreenPoints(i,o){let u,d;if(i instanceof s.P||typeof i[0]=="number"){const p=s.P.convert(i);u=[p],d=o.isPointAboveHorizon(p)}else{const p=s.P.convert(i[0]),g=s.P.convert(i[1]);u=[p,g],d=s.Y(p,g).every(v=>o.isPointAboveHorizon(v))}return new pi(u,o.getCameraPoint(),d,o)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(i){return s.Y(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],i)}bufferedCameraGeometry(i){const o=this.screenBounds[0],u=this.screenBounds.length===1?this.screenBounds[0].add(new s.P(1,1)):this.screenBounds[1],d=s.Y(o,u,0,!1);return this.cameraPoint.y>u.y&&(this.cameraPoint.x>o.x&&this.cameraPoint.x<u.x?d.splice(3,0,this.cameraPoint):this.cameraPoint.x>=u.x?d[2]=this.cameraPoint:this.cameraPoint.x<=o.x&&(d[3]=this.cameraPoint)),s._(d,i)}bufferedCameraGeometryGlobe(i){const o=this.screenBounds[0],u=this.screenBounds.length===1?this.screenBounds[0].add(new s.P(1,1)):this.screenBounds[1],d=s.Y(o,u,i),p=this.cameraPoint.clone();switch(3*((p.y>o.y)+(p.y>u.y))+((p.x>o.x)+(p.x>u.x))){case 0:d[0]=p,d[4]=p.clone();break;case 1:d.splice(1,0,p);break;case 2:d[1]=p;break;case 3:d.splice(4,0,p);break;case 5:d.splice(2,0,p);break;case 6:d[3]=p;break;case 7:d.splice(3,0,p);break;case 8:d[2]=p}return d}containsTile(i,o,u,d=0){const p=i.queryPadding/o._pixelsPerMercatorPixel+1,g=u?this._bufferedCameraMercator(p,o):this._bufferedScreenMercator(p,o);let v=i.tileID.wrap+(g.unwrapped?d:0);const w=g.polygon.map(V=>s.$(i.tileTransform,V,v));if(!s.a0(w,0,0,s.V,s.V))return;v=i.tileID.wrap+(this.screenGeometryMercator.unwrapped?d:0);const M=this.screenGeometryMercator.polygon.map(V=>s.a1(i.tileTransform,V,v)),I=M.map(V=>new s.P(V[0],V[1])),S=o.getFreeCameraOptions().position||new s.L(0,0,0),z=s.a1(i.tileTransform,S,v),R=M.map(V=>{const B=s.N.sub(V,V,z);return s.N.normalize(B,B),new s.a2(z,B)}),U=s.a3(i,1,o.zoom)*o._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:I,tilespaceRays:R,bufferedTilespaceGeometry:w,bufferedTilespaceBounds:(N=s.a4(w),N.min.x=s.aa(N.min.x,0,s.V),N.min.y=s.aa(N.min.y,0,s.V),N.max.x=s.aa(N.max.x,0,s.V),N.max.y=s.aa(N.max.y,0,s.V),N),tile:i,tileID:i.tileID,pixelToTileUnitsFactor:U};var N}_bufferedScreenMercator(i,o){const u=He(i);if(this._screenRaycastCache[u])return this._screenRaycastCache[u];{let d;return d=o.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(i),o):{polygon:this.bufferedScreenGeometry(i).map(p=>o.pointCoordinate3D(p)),unwrapped:!0},this._screenRaycastCache[u]=d,d}}_bufferedCameraMercator(i,o){const u=He(i);if(this._cameraRaycastCache[u])return this._cameraRaycastCache[u];{let d;return d=o.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(i),o):{polygon:this.bufferedCameraGeometry(i).map(p=>o.pointCoordinate3D(p)),unwrapped:!0},this._cameraRaycastCache[u]=d,d}}_projectAndResample(i,o){const u=function(p,g){const v=s.a6.multiply([],g.pixelMatrix,g.globeMatrix),w=[0,-s.ab,0,1],M=[0,s.ab,0,1],I=[0,0,0,1];s.a7.transformMat4(w,w,v),s.a7.transformMat4(M,M,v),s.a7.transformMat4(I,I,v);const S=new s.P(w[0]/w[3],w[1]/w[3]),z=new s.P(M[0]/M[3],M[1]/M[3]),R=s.a8(p,S)&&w[3]<I[3],U=s.a8(p,z)&&M[3]<I[3];if(!R&&!U)return null;const N=function(Q,oe,le){for(let he=1;he<Q.length;he++){const we=ze(oe.pointCoordinate3D(Q[he-1]).x),me=ze(oe.pointCoordinate3D(Q[he]).x);if(le<0){if(we<me)return{idx:he,t:-we/(me-1-we)}}else if(me<we)return{idx:he,t:(1-we)/(me+1-we)}}return null}(p,g,R?-1:1);if(!N)return null;const{idx:V,t:B}=N;let G=V>1?Pe(p.slice(0,V),g):[],K=V<p.length?Pe(p.slice(V),g):[];G=G.map(Q=>new s.P(ze(Q.x),Q.y)),K=K.map(Q=>new s.P(ze(Q.x),Q.y));const q=[...G];q.length===0&&q.push(K[K.length-1]);const J=s.U(q[q.length-1].y,(K.length===0?G[0]:K[0]).y,B);let j;return j=R?[new s.P(0,J),new s.P(0,0),new s.P(1,0),new s.P(1,J)]:[new s.P(1,J),new s.P(1,1),new s.P(0,1),new s.P(0,J)],q.push(...j),K.length===0?q.push(G[0]):q.push(...K),{polygon:q.map(Q=>new s.L(Q.x,Q.y)),unwrapped:!1}}(i,o);if(u)return u;const d=function(p,g){let v=!1,w=-1/0,M=0;for(let S=0;S<p.length-1;S++)p[S].x>w&&(w=p[S].x,M=S);for(let S=0;S<p.length-1;S++){const z=(M+S)%(p.length-1),R=p[z],U=p[z+1];Math.abs(R.x-U.x)>.5&&(R.x<U.x?(R.x+=1,z===0&&(p[p.length-1].x+=1)):(U.x+=1,z+1===p.length-1&&(p[0].x+=1)),v=!0)}const I=s.a5(g.center.lng);return v&&I<Math.abs(I-1)&&p.forEach(S=>{S.x-=1}),{polygon:p,unwrapped:v}}(Pe(i,o).map(p=>new s.P(ze(p.x),p.y)),o);return{polygon:d.polygon.map(p=>new s.L(p.x,p.y)),unwrapped:d.unwrapped}}}function Pe(c,i){return s.a9(c,o=>{const u=i.pointCoordinate3D(o);o.x=u.x,o.y=u.y},1/256)}function ze(c){return c<0?1+c%1:c%1}function He(c){return 100*c|0}function tt(c,i,o,u,d){const p=function(g,v){if(g)return d(g);if(v){c.url&&v.tiles&&c.tiles&&delete c.tiles;const w=s.ac(s.e(v,c),["tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);v.vector_layers&&(w.vectorLayers=v.vector_layers,w.vectorLayerIds=w.vectorLayers.map(M=>M.id)),v.raster_layers&&(w.rasterLayers=v.raster_layers,w.rasterLayerIds=w.rasterLayers.map(M=>M.id)),w.tiles=i.canonicalizeTileset(w,c.url),d(null,w)}};return c.url?s.g(i.transformRequest(i.normalizeSourceURL(c.url,null,o,u),s.R.Source),p):s.f.frame(()=>p(null,c))}class Ke{constructor(i,o,u){this.bounds=s.ad.convert(this.validateBounds(i)),this.minzoom=o||0,this.maxzoom=u||24}validateBounds(i){return Array.isArray(i)&&i.length===4?[Math.max(-180,i[0]),Math.max(-90,i[1]),Math.min(180,i[2]),Math.min(90,i[3])]:[-180,-90,180,90]}contains(i){const o=Math.pow(2,i.z),u=Math.floor(s.a5(this.bounds.getWest())*o),d=Math.floor(s.ae(this.bounds.getNorth())*o),p=Math.ceil(s.a5(this.bounds.getEast())*o),g=Math.ceil(s.ae(this.bounds.getSouth())*o);return i.x>=u&&i.x<p&&i.y>=d&&i.y<g}}class st extends s.E{constructor(i,o,u,d){if(super(),this.id=i,this.dispatcher=u,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,s.e(this,s.ac(o,["url","scheme","tileSize","promoteId"])),this._options=s.e({type:"vector"},o),this._collectResourceTiming=!!o.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(d),this._tileWorkers={},this._deduped=new s.af}load(i){this._loaded=!1,this.fire(new s.b("dataloading",{dataType:"source"}));const o=Array.isArray(this.map._language)?this.map._language.join():this.map._language,u=this.map._worldview;this._tileJSONRequest=tt(this._options,this.map._requestManager,o,u,(d,p)=>{this._tileJSONRequest=null,this._loaded=!0,d?(o&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${o}`),u&&u.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${u}`),this.fire(new s.a(d))):p&&(s.e(this,p),p.bounds&&(this.tileBounds=new Ke(p.bounds,this.minzoom,this.maxzoom)),s.aj(p.tiles,this.map._requestManager._customAccessToken),this.fire(new s.b("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.b("data",{dataType:"source",sourceDataType:"content"}))),i&&i(d)})}loaded(){return this._loaded}hasTile(i){return!this.tileBounds||this.tileBounds.contains(i.canonical)}onAdd(i){this.map=i,this.load()}reload(){this.cancelTileJSONRequest();const i=s.ag(this.id,this.scope);this.load(()=>this.map.style.clearSource(i))}setTiles(i){return this._options.tiles=i,this.reload(),this}setUrl(i){return this.url=i,this._options.url=i,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return s.e({},this._options)}loadTile(i,o){const u=this.map._requestManager.normalizeTileURL(i.tileID.canonical.url(this.tiles,this.scheme)),d={request:this.map._requestManager.transformRequest(u,s.R.Tile),data:void 0,uid:i.uid,tileID:i.tileID,tileZoom:i.tileZoom,zoom:i.tileID.overscaledZ,tileSize:this.tileSize*i.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:s.f.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:i.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:i.isExtraShadowCaster};if(d.request.collectResourceTiming=this._collectResourceTiming,i.actor&&i.state!=="expired")i.state==="loading"?i.reloadCallback=o:i.request=i.actor.send("reloadTile",d,p.bind(this));else if(i.actor=this._tileWorkers[u]=this._tileWorkers[u]||this.dispatcher.getActor(),this.dispatcher.ready)i.request=i.actor.send("loadTile",d,p.bind(this),void 0,!0);else{const g=s.ah.call({deduped:this._deduped},d,(v,w)=>{v||!w?p.call(this,v):(d.data={cacheControl:w.cacheControl,expires:w.expires,rawData:w.rawData.slice(0)},i.actor&&i.actor.send("loadTile",d,p.bind(this),void 0,!0))},!0);i.request={cancel:g}}function p(g,v){return delete i.request,i.aborted?o(null):g&&g.status!==404?o(g):(v&&v.resourceTiming&&(i.resourceTiming=v.resourceTiming),this.map._refreshExpiredTiles&&v&&i.setExpiryData(v),i.loadVectorData(v,this.map.painter),s.ai(this.dispatcher),o(null),void(i.reloadCallback&&(this.loadTile(i,i.reloadCallback),i.reloadCallback=null)))}}abortTile(i){i.request&&(i.request.cancel(),delete i.request),i.actor&&i.actor.send("abortTile",{uid:i.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(i){i.actor&&i.actor.send("removeTile",{uid:i.uid,type:this.type,source:this.id,scope:this.scope}),i.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class at extends s.E{constructor(i,o,u,d){super(),this.id=i,this.dispatcher=u,this.setEventedParent(d),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=s.e({type:"raster"},o),s.e(this,s.ac(o,["url","scheme","tileSize"]))}load(i){this._loaded=!1,this.fire(new s.b("dataloading",{dataType:"source"})),this._tileJSONRequest=tt(this._options,this.map._requestManager,null,null,(o,u)=>{this._tileJSONRequest=null,this._loaded=!0,o?this.fire(new s.a(o)):u&&(s.e(this,u),u.bounds&&(this.tileBounds=new Ke(u.bounds,this.minzoom,this.maxzoom)),s.aj(u.tiles),this.fire(new s.b("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.b("data",{dataType:"source",sourceDataType:"content"}))),i&&i(o)})}loaded(){return this._loaded}onAdd(i){this.map=i,this.load()}reload(){this.cancelTileJSONRequest();const i=s.ag(this.id,this.scope);this.load(()=>this.map.style.clearSource(i))}setTiles(i){return this._options.tiles=i,this.reload(),this}setUrl(i){return this.url=i,this._options.url=i,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return s.e({},this._options)}hasTile(i){return!this.tileBounds||this.tileBounds.contains(i.canonical)}loadTile(i,o){const u=s.f.devicePixelRatio>=2,d=this.map._requestManager.normalizeTileURL(i.tileID.canonical.url(this.tiles,this.scheme),u,this.tileSize);i.request=s.d(this.map._requestManager.transformRequest(d,s.R.Tile),(p,g,v,w)=>(delete i.request,i.aborted?(i.state="unloaded",o(null)):p?(i.state="errored",o(p)):g?(this.map._refreshExpiredTiles&&i.setExpiryData({cacheControl:v,expires:w}),i.setTexture(g,this.map.painter),i.state="loaded",s.ai(this.dispatcher),void o(null)):o(null)))}abortTile(i,o){i.request&&(i.request.cancel(),delete i.request),o()}unloadTile(i,o){i.texture&&i.texture instanceof s.T?(i.destroy(!0),i.texture&&i.texture instanceof s.T&&this.map.painter.saveTileTexture(i.texture)):i.destroy(),o()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class Qe extends at{constructor(i,o,u,d){super(i,o,u,d),this.type="raster-array",this.maxzoom=22,this._options=s.e({type:"raster-array"},o)}triggerRepaint(i){const o=this.map.painter._terrain,u=this.map.style.getSourceCache(this.id);o&&o.enabled&&u&&o._clearRenderCacheForTile(u.id,i.tileID),this.map.triggerRepaint()}loadTile(i,o){const u=this.map._requestManager.normalizeTileURL(i.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),d=this.map._requestManager.transformRequest(u,s.R.Tile);i.requestParams=d,i.actor||(i.actor=this.dispatcher.getActor()),i.request=i.fetchHeader(void 0,(p,g,v,w)=>{if(delete i.request,i.aborted)return i.state="unloaded",o(null);if(p)return p.code===20?void 0:(i.state="errored",o(p));this.map._refreshExpiredTiles&&i.setExpiryData({cacheControl:v,expires:w}),i.state="empty",o(null)})}unloadTile(i){const o=i.texture;o&&o instanceof s.T?(i.destroy(!0),this.map.painter.saveTileTexture(o)):(i.destroy(),i.flushQueues(),i._isHeaderLoaded=!1,delete i._mrt,delete i.textureDescriptor),i.fbo&&(i.fbo.destroy(),delete i.fbo),delete i.request,delete i.requestParams,delete i.neighboringTiles,i.state="unloaded"}prepareTile(i,o,u){i._isHeaderLoaded&&(i.state!=="empty"&&(i.state="reloading"),i.fetchBand(o,u,(d,p)=>{if(d)return i.state="errored",this.fire(new s.a(d)),void this.triggerRepaint(i);p&&(i.setTexture(p,this.map.painter),i.state="loaded",this.triggerRepaint(i))}))}getInitialBand(i){if(!this.rasterLayers)return 0;const o=this.rasterLayers.find(({id:p})=>p===i),u=o&&o.fields,d=u&&u.bands&&u.bands;return d?d[0]:0}getTextureDescriptor(i,o,u){if(!i)return;const d=o.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!d)return;let p=null;o instanceof s.an?p=o.paint.get("raster-array-band"):o instanceof s.ao&&(p=o.paint.get("raster-particle-array-band"));const g=p||this.getInitialBand(d);if(g!=null)if(i.textureDescriptor){if(!i.updateNeeded(d,g)||u)return Object.assign({},i.textureDescriptor,{texture:i.texture})}else this.prepareTile(i,d,g)}}const ut=32,rt=33,Ft=new Uint16Array(8184);for(let c=0;c<2046;c++){let i=c+2,o=0,u=0,d=0,p=0,g=0,v=0;for(1&i?d=p=g=ut:o=u=v=ut;(i>>=1)>1;){const M=o+d>>1,I=u+p>>1;1&i?(d=o,p=u,o=g,u=v):(o=d,u=p,d=g,p=v),g=M,v=I}const w=4*c;Ft[w+0]=o,Ft[w+1]=u,Ft[w+2]=d,Ft[w+3]=p}const cr=new Uint16Array(2178),Ct=new Uint8Array(1089),Fr=new Uint16Array(1089);function Kr(c){return c===0?-.03125:c===32?.03125:0}class jr{constructor(i,o,u,d){this.id=jr.uniqueIdxCounter,jr.uniqueIdxCounter++,this.context=i;const p=i.gl;this.buffer=p.createBuffer(),this.dynamicDraw=!!u,this.context.unbindVAO(),i.bindElementBuffer.set(this.buffer),p.bufferData(p.ELEMENT_ARRAY_BUFFER,o.arrayBuffer,this.dynamicDraw?p.DYNAMIC_DRAW:p.STATIC_DRAW),this.dynamicDraw||d||o.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(i){this.id=jr.uniqueIdxCounter,jr.uniqueIdxCounter++;const o=this.context.gl;this.context.unbindVAO(),this.bind(),o.bufferSubData(o.ELEMENT_ARRAY_BUFFER,0,i.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}jr.uniqueIdxCounter=0;const xi={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Ni{constructor(i,o,u,d,p,g){this.length=o.length,this.attributes=u,this.itemSize=o.bytesPerElement,this.dynamicDraw=d,this.instanceCount=g,this.context=i;const v=i.gl;this.buffer=v.createBuffer(),i.bindVertexBuffer.set(this.buffer),v.bufferData(v.ARRAY_BUFFER,o.arrayBuffer,this.dynamicDraw?v.DYNAMIC_DRAW:v.STATIC_DRAW),this.dynamicDraw||p||o.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(i){const o=this.context.gl;this.bind(),o.bufferSubData(o.ARRAY_BUFFER,0,i.arrayBuffer)}enableAttributes(i,o){for(let u=0;u<this.attributes.length;u++){const d=o.attributes[this.attributes[u].name];d!==void 0&&i.enableVertexAttribArray(d)}}setVertexAttribPointers(i,o,u){for(let d=0;d<this.attributes.length;d++){const p=this.attributes[d],g=o.attributes[p.name];g!==void 0&&i.vertexAttribPointer(g,p.components,i[xi[p.type]],!1,this.itemSize,p.offset+this.itemSize*(u||0))}}setVertexAttribDivisor(i,o,u){for(let d=0;d<this.attributes.length;d++){const p=o.attributes[this.attributes[d].name];p!==void 0&&this.instanceCount&&this.instanceCount>0&&i.vertexAttribDivisor(p,u)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class wr{constructor(i){this.gl=i.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(i){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class yn extends wr{getDefault(){return s.ax.transparent}set(i){const o=this.current;(i.r!==o.r||i.g!==o.g||i.b!==o.b||i.a!==o.a||this.dirty)&&(this.gl.clearColor(i.r,i.g,i.b,i.a),this.current=i,this.dirty=!1)}}class Un extends wr{getDefault(){return 1}set(i){(i!==this.current||this.dirty)&&(this.gl.clearDepth(i),this.current=i,this.dirty=!1)}}class Ui extends wr{getDefault(){return 0}set(i){(i!==this.current||this.dirty)&&(this.gl.clearStencil(i),this.current=i,this.dirty=!1)}}class La extends wr{getDefault(){return[!0,!0,!0,!0]}set(i){const o=this.current;(i[0]!==o[0]||i[1]!==o[1]||i[2]!==o[2]||i[3]!==o[3]||this.dirty)&&(this.gl.colorMask(i[0],i[1],i[2],i[3]),this.current=i,this.dirty=!1)}}class Oo extends wr{getDefault(){return!0}set(i){(i!==this.current||this.dirty)&&(this.gl.depthMask(i),this.current=i,this.dirty=!1)}}class Us extends wr{getDefault(){return 255}set(i){(i!==this.current||this.dirty)&&(this.gl.stencilMask(i),this.current=i,this.dirty=!1)}}class qc extends wr{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(i){const o=this.current;(i.func!==o.func||i.ref!==o.ref||i.mask!==o.mask||this.dirty)&&(this.gl.stencilFunc(i.func,i.ref,i.mask),this.current=i,this.dirty=!1)}}class hs extends wr{getDefault(){const i=this.gl;return[i.KEEP,i.KEEP,i.KEEP]}set(i){const o=this.current;(i[0]!==o[0]||i[1]!==o[1]||i[2]!==o[2]||this.dirty)&&(this.gl.stencilOp(i[0],i[1],i[2]),this.current=i,this.dirty=!1)}}class Wc extends wr{getDefault(){return!1}set(i){if(i===this.current&&!this.dirty)return;const o=this.gl;i?o.enable(o.STENCIL_TEST):o.disable(o.STENCIL_TEST),this.current=i,this.dirty=!1}}class Vs extends wr{getDefault(){return[0,1]}set(i){const o=this.current;(i[0]!==o[0]||i[1]!==o[1]||this.dirty)&&(this.gl.depthRange(i[0],i[1]),this.current=i,this.dirty=!1)}}class cd extends wr{getDefault(){return!1}set(i){if(i===this.current&&!this.dirty)return;const o=this.gl;i?o.enable(o.DEPTH_TEST):o.disable(o.DEPTH_TEST),this.current=i,this.dirty=!1}}class Ol extends wr{getDefault(){return this.gl.LESS}set(i){(i!==this.current||this.dirty)&&(this.gl.depthFunc(i),this.current=i,this.dirty=!1)}}class Hc extends wr{getDefault(){return!1}set(i){if(i===this.current&&!this.dirty)return;const o=this.gl;i?o.enable(o.BLEND):o.disable(o.BLEND),this.current=i,this.dirty=!1}}class kl extends wr{getDefault(){const i=this.gl;return[i.ONE,i.ZERO,i.ONE,i.ZERO]}set(i){const o=this.current;(i[0]!==o[0]||i[1]!==o[1]||i[2]!==o[2]||i[3]!==o[3]||this.dirty)&&(this.gl.blendFuncSeparate(i[0],i[1],i[2],i[3]),this.current=i,this.dirty=!1)}}class Xc extends wr{getDefault(){return s.ax.transparent}set(i){const o=this.current;(i.r!==o.r||i.g!==o.g||i.b!==o.b||i.a!==o.a||this.dirty)&&(this.gl.blendColor(i.r,i.g,i.b,i.a),this.current=i,this.dirty=!1)}}class on extends wr{getDefault(){return this.gl.FUNC_ADD}set(i){(i!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(i,i),this.current=i,this.dirty=!1)}}class mi extends wr{getDefault(){return!1}set(i){if(i===this.current&&!this.dirty)return;const o=this.gl;i?o.enable(o.CULL_FACE):o.disable(o.CULL_FACE),this.current=i,this.dirty=!1}}class ur extends wr{getDefault(){return this.gl.BACK}set(i){(i!==this.current||this.dirty)&&(this.gl.cullFace(i),this.current=i,this.dirty=!1)}}class ud extends wr{getDefault(){return this.gl.CCW}set(i){(i!==this.current||this.dirty)&&(this.gl.frontFace(i),this.current=i,this.dirty=!1)}}let Bl=class extends wr{getDefault(){return null}set(c){(c!==this.current||this.dirty)&&(this.gl.useProgram(c),this.current=c,this.dirty=!1)}};class Yc extends wr{getDefault(){return this.gl.TEXTURE0}set(i){(i!==this.current||this.dirty)&&(this.gl.activeTexture(i),this.current=i,this.dirty=!1)}}class Rp extends wr{getDefault(){const i=this.gl;return[0,0,i.drawingBufferWidth,i.drawingBufferHeight]}set(i){const o=this.current;(i[0]!==o[0]||i[1]!==o[1]||i[2]!==o[2]||i[3]!==o[3]||this.dirty)&&(this.gl.viewport(i[0],i[1],i[2],i[3]),this.current=i,this.dirty=!1)}}class ro extends wr{getDefault(){return null}set(i){if(i===this.current&&!this.dirty)return;const o=this.gl;o.bindFramebuffer(o.FRAMEBUFFER,i),this.current=i,this.dirty=!1}}class Kc extends wr{getDefault(){return null}set(i){if(i===this.current&&!this.dirty)return;const o=this.gl;o.bindRenderbuffer(o.RENDERBUFFER,i),this.current=i,this.dirty=!1}}class Op extends wr{getDefault(){return null}set(i){if(i===this.current&&!this.dirty)return;const o=this.gl;o.bindTexture(o.TEXTURE_2D,i),this.current=i,this.dirty=!1}}class js extends wr{getDefault(){return null}set(i){if(i===this.current&&!this.dirty)return;const o=this.gl;o.bindBuffer(o.ARRAY_BUFFER,i),this.current=i,this.dirty=!1}}class dt extends wr{getDefault(){return null}set(i){const o=this.gl;o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,i),this.current=i,this.dirty=!1}}class Ir extends wr{getDefault(){return null}set(i){this.gl&&(i!==this.current||this.dirty)&&(this.gl.bindVertexArray(i),this.current=i,this.dirty=!1)}}class Cr extends wr{getDefault(){return 4}set(i){if(i===this.current&&!this.dirty)return;const o=this.gl;o.pixelStorei(o.UNPACK_ALIGNMENT,i),this.current=i,this.dirty=!1}}class Cn extends wr{getDefault(){return!1}set(i){if(i===this.current&&!this.dirty)return;const o=this.gl;o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i),this.current=i,this.dirty=!1}}class Zs extends wr{getDefault(){return!1}set(i){if(i===this.current&&!this.dirty)return;const o=this.gl;o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,i),this.current=i,this.dirty=!1}}class mr extends wr{constructor(i,o){super(i),this.context=i,this.parent=o}getDefault(){return null}}class Fl extends mr{setDirty(){this.dirty=!0}set(i){if(i===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const o=this.gl;o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,i,0),this.current=i,this.dirty=!1}}class Gs extends mr{attachment(){return this.gl.DEPTH_ATTACHMENT}set(i){if(i===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const o=this.gl;o.framebufferRenderbuffer(o.FRAMEBUFFER,this.attachment(),o.RENDERBUFFER,i),this.current=i,this.dirty=!1}}class Da extends mr{attachment(){return this.gl.DEPTH_ATTACHMENT}set(i){if(i===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const o=this.gl;o.framebufferTexture2D(o.FRAMEBUFFER,this.attachment(),o.TEXTURE_2D,i,0),this.current=i,this.dirty=!1}}class sn extends Gs{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}class di{constructor(i,o,u,d,p){this.context=i,this.width=o,this.height=u;const g=this.framebuffer=i.gl.createFramebuffer();d&&(this.colorAttachment=new Fl(i,g)),p&&(this.depthAttachmentType=p,this.depthAttachment=p==="renderbuffer"?new Gs(i,g):new Da(i,g))}destroy(){const i=this.context.gl;if(this.colorAttachment){const o=this.colorAttachment.get();o&&i.deleteTexture(o)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){const o=this.depthAttachment.get();o&&i.deleteRenderbuffer(o)}else{const o=this.depthAttachment.get();o&&i.deleteTexture(o)}i.deleteFramebuffer(this.framebuffer)}}class zt{constructor(i,o,u){this.func=i,this.mask=o,this.range=u}}zt.ReadOnly=!1,zt.ReadWrite=!0,zt.disabled=new zt(519,zt.ReadOnly,[0,1]);const ds=7680;class jt{constructor(i,o,u,d,p,g){this.test=i,this.ref=o,this.mask=u,this.fail=d,this.depthFail=p,this.pass=g}}jt.disabled=new jt({func:519,mask:0},0,0,ds,ds,ds);const ko=771;class rr{constructor(i,o,u,d){this.blendFunction=i,this.blendColor=o,this.mask=u,this.blendEquation=d}}rr.Replace=[1,0,1,0],rr.disabled=new rr(rr.Replace,s.ax.transparent,[!1,!1,!1,!1]),rr.unblended=new rr(rr.Replace,s.ax.transparent,[!0,!0,!0,!0]),rr.alphaBlended=new rr([1,ko,1,ko],s.ax.transparent,[!0,!0,!0,!0]),rr.multiply=new rr([774,0,774,0],s.ax.transparent,[!0,!0,!0,!0]);const $s=1029,Vi=2305;class Rt{constructor(i,o,u){this.enable=i,this.mode=o,this.frontFace=u}}Rt.disabled=new Rt(!1,$s,Vi),Rt.backCCW=new Rt(!0,$s,Vi),Rt.backCW=new Rt(!0,$s,2304),Rt.frontCW=new Rt(!0,1028,2304),Rt.frontCCW=new Rt(!0,1028,Vi);class hd{constructor(i,o){this.gl=i,this.clearColor=new yn(this),this.clearDepth=new Un(this),this.clearStencil=new Ui(this),this.colorMask=new La(this),this.depthMask=new Oo(this),this.stencilMask=new Us(this),this.stencilFunc=new qc(this),this.stencilOp=new hs(this),this.stencilTest=new Wc(this),this.depthRange=new Vs(this),this.depthTest=new cd(this),this.depthFunc=new Ol(this),this.blend=new Hc(this),this.blendFunc=new kl(this),this.blendColor=new Xc(this),this.blendEquation=new on(this),this.cullFace=new mi(this),this.cullFaceSide=new ur(this),this.frontFace=new ud(this),this.program=new Bl(this),this.activeTexture=new Yc(this),this.viewport=new Rp(this),this.bindFramebuffer=new ro(this),this.bindRenderbuffer=new Kc(this),this.bindTexture=new Op(this),this.bindVertexBuffer=new js(this),this.bindElementBuffer=new dt(this),this.bindVertexArrayOES=new Ir(this),this.pixelStoreUnpack=new Cr(this),this.pixelStoreUnpackPremultiplyAlpha=new Cn(this),this.pixelStoreUnpackFlipY=new Zs(this),this.options=o?{...o}:{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=i.getExtension("EXT_texture_filter_anisotropic")||i.getExtension("MOZ_EXT_texture_filter_anisotropic")||i.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=i.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=i.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=i.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=i.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=i.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=i.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=i.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=i.getParameter(i.MAX_TEXTURE_SIZE),this.maxPointSize=i.getParameter(i.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(i,o,u){return new jr(this,i,o,u)}createVertexBuffer(i,o,u,d,p){return new Ni(this,i,o,u,d,p)}createRenderbuffer(i,o,u){const d=this.gl,p=d.createRenderbuffer();return this.bindRenderbuffer.set(p),d.renderbufferStorage(d.RENDERBUFFER,i,o,u),this.bindRenderbuffer.set(null),p}createFramebuffer(i,o,u,d){return new di(this,i,o,u,d)}clear({color:i,depth:o,stencil:u,colorMask:d}){const p=this.gl;let g=0;i&&(g|=p.COLOR_BUFFER_BIT,this.clearColor.set(i),this.colorMask.set(d||[!0,!0,!0,!0])),o!==void 0&&(g|=p.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(o),this.depthMask.set(!0)),u!==void 0&&(g|=p.STENCIL_BUFFER_BIT,this.clearStencil.set(u),this.stencilMask.set(255)),p.clear(g)}setCullFace(i){i.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(i.mode),this.frontFace.set(i.frontFace))}setDepthMode(i){i.func!==this.gl.ALWAYS||i.mask?(this.depthTest.set(!0),this.depthFunc.set(i.func),this.depthMask.set(i.mask),this.depthRange.set(i.range)):this.depthTest.set(!1)}setStencilMode(i){i.test.func!==this.gl.ALWAYS||i.mask?(this.stencilTest.set(!0),this.stencilMask.set(i.mask),this.stencilOp.set([i.fail,i.depthFail,i.pass]),this.stencilFunc.set({func:i.test.func,ref:i.ref,mask:i.test.mask})):this.stencilTest.set(!1)}setColorMode(i){te(i.blendFunction,rr.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(i.blendFunction),this.blendColor.set(i.blendColor),i.blendEquation?this.blendEquation.set(i.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(i.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}var fs=s.ay([{name:"a_pos",type:"Float32",components:3}]);class vi{constructor(i,o,u,d){const p={width:u[0],height:u[1],data:null},g=i.gl;this.targetColorTexture=new s.T(i,p,g.RGBA,{useMipmap:!1}),this.backgroundColorTexture=new s.T(i,p,g.RGBA,{useMipmap:!1}),this.context=i,this.setNumParticles(o,d),this.lastInvalidatedAt=0}setNumParticles(i,o){if(this.numParticles===o)return;(this.particleVertices0||this.particleVertices1||this.particleSegment)&&(this.particleVertices0.destroy(),this.particleVertices1.destroy(),this.particleSegment.destroy());const u=new s.az;u.reserve(Math.round(o));const d=s.aA(i.key);for(let p=0;p<o;p++)u.emplaceBack(d(),d(),d());this.particleVertices0=this.context.createVertexBuffer(u,fs.members,!0),this.particleVertices1=this.context.createVertexBuffer(u,fs.members,!0),this.particleSegment=s.aB.simpleSegment(0,0,this.particleVertices0.length,0),this.numParticles=o}update(i){return!(this.lastInvalidatedAt<i&&(this.lastInvalidatedAt=s.f.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleVertices0.destroy(),this.particleVertices1.destroy(),this.particleSegment.destroy()}}const An={type:2,extent:s.V,loadGeometry:()=>[[new s.P(0,0),new s.P(s.V+1,0),new s.P(s.V+1,s.V+1),new s.P(0,s.V+1),new s.P(0,0)]]};class Bo{constructor(i,o,u,d,p){this.tileID=i,this.uid=s.aC(),this.uses=0,this.tileSize=o,this.tileZoom=u,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=p,d&&d.style&&(this._lastUpdatedBrightness=d.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",d&&d.transform&&(this.projection=d.transform.projection)}registerFadeDuration(i){const o=i+this.timeAdded;o<s.f.now()||this.fadeEndTime&&o<this.fadeEndTime||(this.fadeEndTime=o)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=s.as(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(i,o,u){if(this.unloadVectorData(),this.state="loaded",i){i.featureIndex&&(this.latestFeatureIndex=i.featureIndex,i.rawTileData?(this.latestRawTileData=i.rawTileData,this.latestFeatureIndex.rawTileData=i.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=i.collisionBoxArray,this.buckets=function(d,p){const g={};if(!p)return g;for(const v of d){const w=v.layerIds.map(M=>p.getLayer(M)).filter(Boolean);if(w.length!==0){v.layers=w,v.stateDependentLayerIds&&(v.stateDependentLayers=v.stateDependentLayerIds.map(M=>w.filter(I=>I.id===M)[0]));for(const M of w)g[M.fqid]=v}}return g}(i.buckets,o.style),this.hasSymbolBuckets=!1;for(const d in this.buckets){const p=this.buckets[d];if(p instanceof s.aE){if(this.hasSymbolBuckets=!0,!u)break;p.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const d in this.buckets){const p=this.buckets[d];if(p instanceof s.aE&&p.hasRTLText){this.hasRTLText=!0,s.aF();break}}this.queryPadding=0;for(const d in this.buckets){const p=this.buckets[d],g=o.style.getOwnLayer(d);if(!g)continue;const v=g.queryRadius(p);this.queryPadding=Math.max(this.queryPadding,v)}i.imageAtlas&&(this.imageAtlas=i.imageAtlas),i.glyphAtlasImage&&(this.glyphAtlasImage=i.glyphAtlasImage),i.lineAtlas&&(this.lineAtlas=i.lineAtlas),this._lastUpdatedBrightness=i.brightness}else this.collisionBoxArray=new s.aD}unloadVectorData(){if(this.hasData()){for(const i in this.buckets)this.buckets[i].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}getBucket(i){return this.buckets[i.fqid]}upload(i){for(const d in this.buckets){const p=this.buckets[d];p.uploadPending()&&p.upload(i)}const o=i.gl,u=this.imageAtlas;if(u&&!u.uploaded){const d=!!Object.keys(u.patternPositions).length;this.imageAtlasTexture=new s.T(i,u.image,o.RGBA,{useMipmap:d}),this.imageAtlas.uploaded=!0}this.glyphAtlasImage&&(this.glyphAtlasTexture=new s.T(i,this.glyphAtlasImage,o.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new s.T(i,this.lineAtlas.image,o.R8),this.lineAtlas.uploaded=!0)}prepare(i,o,u){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(i,this.imageAtlasTexture,u),!o||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const d=o.style.getBrightness();(this._lastUpdatedBrightness||d)&&(this._lastUpdatedBrightness&&d&&Math.abs(this._lastUpdatedBrightness-d)<.001||(this._lastUpdatedBrightness=d,this.updateBuckets(void 0,o)))}queryRenderedFeatures(i,o,u,d,p,g,v,w){return this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)?this.latestFeatureIndex.query({tileResult:d,pixelPosMatrix:v,transform:g,params:p,tileTransform:this.tileTransform},i,o,u):{}}querySourceFeatures(i,o){const u=this.latestFeatureIndex;if(!u||!u.rawTileData)return;const d=u.loadVTLayers(),p=o?o.sourceLayer:"",g=d._geojsonTileLayer||d[p];if(!g)return;const v=s.aG(o&&o.filter),{z:w,x:M,y:I}=this.tileID.canonical,S={z:w,x:M,y:I};for(let z=0;z<g.length;z++){const R=g.feature(z);if(v.needGeometry){const V=s.aH(R,!0);if(!v.filter(new s.K(this.tileID.overscaledZ),V,this.tileID.canonical))continue}else if(!v.filter(new s.K(this.tileID.overscaledZ),R))continue;const U=u.getId(R,p),N=new s.aI(R,w,M,I,U);N.tile=S,i.push(N)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}bucketsLoaded(){for(const i in this.buckets)if(this.buckets[i].uploadPending())return!1;return!0}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(i){const o=this.expirationTime;if(i.cacheControl){const u=s.aJ(i.cacheControl);u["max-age"]&&(this.expirationTime=Date.now()+1e3*u["max-age"])}else i.expires&&(this.expirationTime=new Date(i.expires).getTime());if(this.expirationTime){const u=Date.now();let d=!1;if(this.expirationTime>u)d=!1;else if(o)if(this.expirationTime<o)d=!0;else{const p=this.expirationTime-o;p?this.expirationTime=u+Math.max(p,3e4):d=!0}else d=!0;d?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(i,o){this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData&&Object.keys(i).length!==0&&o&&this.updateBuckets(i,o)}updateBuckets(i,o){if(!this.latestFeatureIndex)return;const u=this.latestFeatureIndex.loadVTLayers(),d=o.style.listImages(),p=o.style.getBrightness();for(const g in this.buckets){if(!o.style.hasLayer(g))continue;const v=this.buckets[g],w=v.layers[0].sourceLayer||"_geojsonTileLayer",M=u[w];let I={};if(i&&(I=i[w],!M||!I||Object.keys(I).length===0))continue;if(v.update(I,M,d,this.imageAtlas&&this.imageAtlas.patternPositions||{},p),v instanceof s.aK||v instanceof s.aL){const z=o.style.getOwnSourceCache(v.layers[0].source);o._terrain&&o._terrain.enabled&&z&&v.programConfigurations.needsUpload&&o._terrain._clearRenderCacheForTile(z.id,this.tileID)}const S=o&&o.style&&o.style.getOwnLayer(g);S&&(this.queryPadding=Math.max(this.queryPadding,S.queryRadius(v)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<s.f.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(i){this.symbolFadeHoldUntil=s.f.now()+i}setTexture(i,o){const u=o.context,d=u.gl;this.texture=this.texture||o.getTileTexture(i.width),this.texture&&this.texture instanceof s.T?this.texture.update(i,{useMipmap:!0}):(this.texture=new s.T(u,i,d.RGBA,{useMipmap:!0}),this.texture.bind(d.LINEAR,d.CLAMP_TO_EDGE))}setDependencies(i,o){const u={};for(const d of o)u[d]=!0;this.dependencies[i]=u}hasDependency(i,o){for(const u of i){const d=this.dependencies[u];if(d){for(const p of o)if(d[p])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(i,o){if(!o||o.name==="mercator"||this._tileDebugBuffer)return;const u=s.aM(An,this.tileID.canonical,this.tileTransform)[0],d=new s.aN,p=new s.aO;for(let g=0;g<u.length;g++){const{x:v,y:w}=u[g];d.emplaceBack(v,w),p.emplaceBack(g)}p.emplaceBack(0),this._tileDebugIndexBuffer=i.createIndexBuffer(p),this._tileDebugBuffer=i.createVertexBuffer(d,s.aP.members),this._tileDebugSegments=s.aB.simpleSegment(0,0,d.length,p.length)}_makeTileBoundsBuffers(i,o){if(this._tileBoundsBuffer||!o||o.name==="mercator")return;const u=s.aM(An,this.tileID.canonical,this.tileTransform)[0];let d,p;if(this.isRaster){const g=function(v,w){const M=s.as(v,w),I=Math.pow(2,v.z);for(let V=0;V<rt;V++)for(let B=0;B<rt;B++){const G=s.at((v.x+(B+Kr(B))/ut)/I),K=s.au((v.y+(V+Kr(V))/ut)/I),q=w.project(G,K),J=V*rt+B;cr[2*J+0]=Math.round((q.x*M.scale-M.x)*s.V),cr[2*J+1]=Math.round((q.y*M.scale-M.y)*s.V)}Ct.fill(0),Fr.fill(0);for(let V=2045;V>=0;V--){const B=4*V,G=Ft[B+0],K=Ft[B+1],q=Ft[B+2],J=Ft[B+3],j=G+q>>1,Q=K+J>>1,oe=j+Q-K,le=Q+G-j,he=K*rt+G,we=J*rt+q,me=Q*rt+j,Ae=Math.hypot((cr[2*he+0]+cr[2*we+0])/2-cr[2*me+0],(cr[2*he+1]+cr[2*we+1])/2-cr[2*me+1])>=16;Ct[me]=Ct[me]||(Ae?1:0),V<1022&&(Ct[me]=Ct[me]||Ct[(K+le>>1)*rt+(G+oe>>1)]||Ct[(J+le>>1)*rt+(q+oe>>1)])}const S=new s.av,z=new s.aw;let R=0;function U(V,B){const G=B*rt+V;return Fr[G]===0&&(S.emplaceBack(cr[2*G+0],cr[2*G+1],V*s.V/ut,B*s.V/ut),Fr[G]=++R),Fr[G]-1}function N(V,B,G,K,q,J){const j=V+G>>1,Q=B+K>>1;if(Math.abs(V-q)+Math.abs(B-J)>1&&Ct[Q*rt+j])N(q,J,V,B,j,Q),N(G,K,q,J,j,Q);else{const oe=U(V,B),le=U(G,K),he=U(q,J);z.emplaceBack(oe,le,he)}}return N(0,0,ut,ut,ut,0),N(ut,ut,0,0,0,ut),{vertices:S,indices:z}}(this.tileID.canonical,o);d=g.vertices,p=g.indices}else{d=new s.av,p=new s.aw;for(const{x:v,y:w}of u)d.emplaceBack(v,w,0,0);const g=s.aQ(d.int16,void 0,4);for(let v=0;v<g.length;v+=3)p.emplaceBack(g[v],g[v+1],g[v+2])}this._tileBoundsBuffer=i.createVertexBuffer(d,s.aR.members),this._tileBoundsIndexBuffer=i.createIndexBuffer(p),this._tileBoundsSegments=s.aB.simpleSegment(0,0,d.length,p.length)}_makeGlobeTileDebugBuffers(i,o){const u=o.projection;if(!u||u.name!=="globe"||o.freezeTileCoverage)return;const d=this.tileID.canonical,p=s.aS(d,o),g=s.aT(p),v=s.S(o.zoom);let w;v>0&&(w=s.a6.invert(new Float64Array(16),o.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(i,d,o,g,w,v),this._makeGlobeTileDebugTextBuffer(i,d,o,g,w,v)}_globePoint(i,o,u,d,p,g,v){let w=s.aU(i,o,u);if(g){const M=1<<u.z,I=s.a5(d.center.lng),S=s.ae(d.center.lat),z=(u.x+.5)/M-I;let R=0;z>.5?R=-1:z<-.5&&(R=1);let U=(i/s.V+u.x)/M+R,N=(o/s.V+u.y)/M;U=(U-I)*d._pixelsPerMercatorPixel+I,N=(N-S)*d._pixelsPerMercatorPixel+S;const V=[U*d.worldSize,N*d.worldSize,0];s.N.transformMat4(V,V,g),w=s.aV(w,V,v)}return s.N.transformMat4(w,w,p)}_makeGlobeTileDebugBorderBuffer(i,o,u,d,p,g){const v=new s.aN,w=new s.aO,M=new s.aW,I=(z,R,U,N,V)=>{const B=(U-z)/(V-1),G=(N-R)/(V-1),K=v.length;for(let q=0;q<V;q++){const J=z+q*B,j=R+q*G;v.emplaceBack(J,j);const Q=this._globePoint(J,j,o,u,d,p,g);M.emplaceBack(Q[0],Q[1],Q[2]),w.emplaceBack(K+q)}},S=s.V;I(0,0,S,0,16),I(S,0,S,S,16),I(S,S,0,S,16),I(0,S,0,0,16),this._tileDebugIndexBuffer=i.createIndexBuffer(w),this._tileDebugBuffer=i.createVertexBuffer(v,s.aP.members),this._globeTileDebugBorderBuffer=i.createVertexBuffer(M,s.aX.members),this._tileDebugSegments=s.aB.simpleSegment(0,0,v.length,w.length)}_makeGlobeTileDebugTextBuffer(i,o,u,d,p,g){const v=s.V/4,w=new s.aN,M=new s.aw,I=new s.aW,S=25;M.reserve(32),w.reserve(S),I.reserve(S);const z=(R,U)=>S*R+U;for(let R=0;R<S;R++){const U=R*v;for(let N=0;N<S;N++){const V=N*v;w.emplaceBack(V,U);const B=this._globePoint(V,U,o,u,d,p,g);I.emplaceBack(B[0],B[1],B[2])}}for(let R=0;R<4;R++)for(let U=0;U<4;U++){const N=z(R,U),V=z(R,U+1),B=z(R+1,U),G=z(R+1,U+1);M.emplaceBack(N,V,B),M.emplaceBack(B,V,G)}this._tileDebugTextIndexBuffer=i.createIndexBuffer(M),this._tileDebugTextBuffer=i.createVertexBuffer(w,s.aP.members),this._globeTileDebugTextBuffer=i.createVertexBuffer(I,s.aX.members),this._tileDebugTextSegments=s.aB.simpleSegment(0,0,S,32)}destroy(i=!1){for(const o in this.buckets)this.buckets[o].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!i&&this.texture&&this.texture instanceof s.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}const po={vector:st,raster:at,"raster-dem":class extends at{constructor(c,i,o,u){super(c,i,o,u),this.type="raster-dem",this.maxzoom=22,this._options=s.e({type:"raster-dem"},i),this.encoding=i.encoding||"mapbox"}loadTile(c,i){const o=this.map._requestManager.normalizeTileURL(c.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function u(d,p){d&&(c.state="errored",i(d)),p&&(c.dem=p,c.dem.onDeserialize(),c.needsHillshadePrepare=!0,c.needsDEMTextureUpload=!0,c.state="loaded",i(null))}c.request=s.d(this.map._requestManager.transformRequest(o,s.R.Tile),(function(d,p,g,v){if(delete c.request,c.aborted)c.state="unloaded",i(null);else if(d)c.state="errored",i(d);else if(p){this.map._refreshExpiredTiles&&c.setExpiryData({cacheControl:g,expires:v});const w=ImageBitmap&&p instanceof ImageBitmap&&s.ak(),M=1-(p.width-s.al(p.width))/2;M<1||c.neighboringTiles||(c.neighboringTiles=this._getNeighboringTiles(c.tileID));const I=w?p:s.f.getImageData(p,M),S={uid:c.uid,coord:c.tileID,source:this.id,scope:this.scope,rawImageData:I,encoding:this.encoding,padding:M};c.actor&&c.state!=="expired"||(c.actor=this.dispatcher.getActor(),c.actor.send("loadDEMTile",S,u.bind(this),void 0,!0))}}).bind(this))}_getNeighboringTiles(c){const i=c.canonical,o=Math.pow(2,i.z),u=(i.x-1+o)%o,d=i.x===0?c.wrap-1:c.wrap,p=(i.x+1+o)%o,g=i.x+1===o?c.wrap+1:c.wrap,v={};return v[new s.am(c.overscaledZ,d,i.z,u,i.y).key]={backfilled:!1},v[new s.am(c.overscaledZ,g,i.z,p,i.y).key]={backfilled:!1},i.y>0&&(v[new s.am(c.overscaledZ,d,i.z,u,i.y-1).key]={backfilled:!1},v[new s.am(c.overscaledZ,c.wrap,i.z,i.x,i.y-1).key]={backfilled:!1},v[new s.am(c.overscaledZ,g,i.z,p,i.y-1).key]={backfilled:!1}),i.y+1<o&&(v[new s.am(c.overscaledZ,d,i.z,u,i.y+1).key]={backfilled:!1},v[new s.am(c.overscaledZ,c.wrap,i.z,i.x,i.y+1).key]={backfilled:!1},v[new s.am(c.overscaledZ,g,i.z,p,i.y+1).key]={backfilled:!1}),v}},"raster-array":Qe,geojson:class extends s.E{constructor(c,i,o,u){super(),this.id=c,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=o.getActor(),this.setEventedParent(u),this._data=i.data,this._options=s.e({},i),this._collectResourceTiming=i.collectResourceTiming,i.maxzoom!==void 0&&(this.maxzoom=i.maxzoom),i.type&&(this.type=i.type),i.attribution&&(this.attribution=i.attribution),this.promoteId=i.promoteId;const d=s.V/this.tileSize;this.workerOptions=s.e({source:this.id,scope:this.scope,cluster:i.cluster||!1,geojsonVtOptions:{buffer:(i.buffer!==void 0?i.buffer:128)*d,tolerance:(i.tolerance!==void 0?i.tolerance:.375)*d,extent:s.V,maxZoom:this.maxzoom,lineMetrics:i.lineMetrics||!1,generateId:i.generateId||!1},superclusterOptions:{maxZoom:i.clusterMaxZoom!==void 0?i.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,i.clusterMinPoints||2),extent:s.V,radius:(i.clusterRadius!==void 0?i.clusterRadius:50)*d,log:!1,generateId:i.generateId||!1},clusterProperties:i.clusterProperties,filter:i.filter},i.workerOptions)}onAdd(c){this.map=c,this.setData(this._data)}setData(c){return this._data=c,this._updateWorkerData(),this}getClusterExpansionZoom(c,i){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:c,source:this.id,scope:this.scope},i),this}getClusterChildren(c,i){return this.actor.send("geojson.getClusterChildren",{clusterId:c,source:this.id,scope:this.scope},i),this}getClusterLeaves(c,i,o,u){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:c,limit:i,offset:o},u),this}_updateWorkerData(){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new s.b("dataloading",{dataType:"source"})),this._loaded=!1;const c=s.e({},this.workerOptions);c.scope=this.scope;const i=this._data;typeof i=="string"?(c.request=this.map._requestManager.transformRequest(s.f.resolveURL(i),s.R.Source),c.request.collectResourceTiming=this._collectResourceTiming):c.data=JSON.stringify(i),this._pendingLoad=this.actor.send(`${this.type}.loadData`,c,(o,u)=>{if(this._loaded=!0,this._pendingLoad=null,o)this.fire(new s.a(o));else{const d={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&u&&u.resourceTiming&&u.resourceTiming[this.id]&&(d.resourceTiming=u.resourceTiming[this.id]),this.fire(new s.b("data",d)),this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(),this._coalesce=!1)})}loaded(){return this._loaded}loadTile(c,i){const o=c.actor?"reloadTile":"loadTile";c.actor=this.actor;const u={type:this.type,uid:c.uid,tileID:c.tileID,tileZoom:c.tileZoom,zoom:c.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,scope:this.scope,pixelRatio:s.f.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0};c.request=this.actor.send(o,u,(d,p)=>(delete c.request,c.destroy(),c.aborted?i(null):d?i(d):(c.loadVectorData(p,this.map.painter,o==="reloadTile"),i(null))),void 0,o==="loadTile")}abortTile(c){c.request&&(c.request.cancel(),delete c.request),c.aborted=!0}unloadTile(c){this.actor.send("removeTile",{uid:c.uid,type:this.type,source:this.id,scope:this.scope}),c.destroy()}onRemove(){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return s.e({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends s.ap{constructor(c,i,o,u){super(c,i,o,u),this.roundZoom=!0,this.type="video",this.options=i}load(){this._loaded=!1;const c=this.options;this.urls=[];for(const i of c.urls)this.urls.push(this.map._requestManager.transformRequest(i,s.R.Source).url);s.aq(this.urls,(i,o)=>{this._loaded=!0,i?this.fire(new s.a(i)):o&&(this.video=o,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(c){if(this.video){const i=this.video.seekable;c<i.start(0)||c>i.end(0)?this.fire(new s.a(new it(`sources.${this.id}`,null,`Playback for this video can be set only between the ${i.start(0)} and ${i.end(0)}-second mark.`))):this.video.currentTime=c}}getVideo(){return this.video}onAdd(c){this.map||(this.map=c,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const c=this.map.painter.context,i=c.gl;this.texture?this.video.paused||(this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE),i.texSubImage2D(i.TEXTURE_2D,0,0,0,i.RGBA,i.UNSIGNED_BYTE,this.video)):(this.texture=new s.T(c,this.video,i.RGBA),this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(c)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:s.ap,model:class extends s.E{constructor(c,i,o,u){super(),this.id=c,this.type="model",this.models=[],this._loaded=!1,this._options=i}load(){const c=[];for(const i in this._options.models){const o=this._options.models[i],u=s.l(this.map._requestManager.transformRequest(o.uri,s.R.Model).url).then(d=>{if(!d)return;const p=s.c(d),g=new s.M(i,o.position,o.orientation,p);g.computeBoundsAndApplyParent(),this.models.push(g)}).catch(d=>{this.fire(new s.a(new Error(`Could not load model ${i} from ${o.uri}: ${d.message}`)))});c.push(u)}return Promise.allSettled(c).then(()=>{this._loaded=!0,this.fire(new s.b("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(i=>{this.fire(new s.a(new Error(`Could not load models: ${i.message}`)))})}onAdd(c){this.map=c,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(c,i){}serialize(){return{type:"model"}}},"batched-model":class extends s.E{constructor(c,i,o,u){super(),this.type="batched-model",this.id=c,this.tileSize=512,this._options=i,this.tiles=this._options.tiles,this.maxzoom=i.maxzoom||19,this.minzoom=i.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=o,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(u)}onAdd(c){this.map=c,this.load()}load(c){this._loaded=!1,this.fire(new s.b("dataloading",{dataType:"source"}));const i=Array.isArray(this.map._language)?this.map._language.join():this.map._language,o=this.map._worldview;this._tileJSONRequest=tt(this._options,this.map._requestManager,i,o,(u,d)=>{this._tileJSONRequest=null,this._loaded=!0,u?(i&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${i}`),o&&o.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${o}`),this.fire(new s.a(u))):d&&(s.e(this,d),d.bounds&&(this.tileBounds=new Ke(d.bounds,this.minzoom,this.maxzoom)),s.aj(d.tiles,this.map._requestManager._customAccessToken),this.fire(new s.b("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.b("data",{dataType:"source",sourceDataType:"content"}))),c&&c(u)})}hasTransition(){return!1}hasTile(c){return!this.tileBounds||this.tileBounds.contains(c.canonical)}loaded(){return this._loaded}loadTile(c,i){const o=this.map._requestManager.normalizeTileURL(c.tileID.canonical.url(this.tiles,this.scheme)),u={request:this.map._requestManager.transformRequest(o,s.R.Tile),data:void 0,uid:c.uid,tileID:c.tileID,tileZoom:c.tileZoom,zoom:c.tileID.overscaledZ,tileSize:this.tileSize*c.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:c.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0};if(c.actor&&c.state!=="expired")if(c.state==="loading")c.reloadCallback=i;else{if(c.buckets){const p=Object.values(c.buckets);for(const g of p)g.dirty=!0;return void(c.state="loaded")}c.request=c.actor.send("reloadTile",u,d.bind(this))}else c.actor=this.dispatcher.getActor(),c.request=c.actor.send("loadTile",u,d.bind(this),void 0,!0);function d(p,g){return c.aborted?i(null):p&&p.status!==404?i(p):(g&&(g.resourceTiming&&(c.resourceTiming=g.resourceTiming),this.map._refreshExpiredTiles&&c.setExpiryData(g),c.buckets={...c.buckets,...g.buckets},g.featureIndex&&(c.latestFeatureIndex=g.featureIndex)),c.state="loaded",void i(null))}}serialize(){return s.e({},this._options)}},canvas:class extends s.ap{constructor(c,i,o,u){super(c,i,o,u),i.coordinates?Array.isArray(i.coordinates)&&i.coordinates.length===4&&!i.coordinates.some(d=>!Array.isArray(d)||d.length!==2||d.some(p=>typeof p!="number"))||this.fire(new s.a(new it(`sources.${c}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new s.a(new it(`sources.${c}`,null,'missing required property "coordinates"'))),i.animate&&typeof i.animate!="boolean"&&this.fire(new s.a(new it(`sources.${c}`,null,'optional "animate" property must be a boolean value'))),i.canvas?typeof i.canvas=="string"||i.canvas instanceof HTMLCanvasElement||this.fire(new s.a(new it(`sources.${c}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new s.a(new it(`sources.${c}`,null,'missing required property "canvas"'))),this.options=i,this.animate=i.animate===void 0||i.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new s.a(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(c){this.map=c,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let c=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,c=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,c=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const i=this.map.painter.context;this.texture?!c&&!this._playing||this.texture instanceof s.ar||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new s.T(i,this.canvas,i.gl.RGBA,{premultiply:!0}),this._prepareData(i)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const c of[this.canvas.width,this.canvas.height])if(isNaN(c)||c<=0)return!0;return!1}},custom:class extends s.E{constructor(c,i,o,u){super(),this.id=c,this.type="custom",this._dataType="raster",this._dispatcher=o,this._implementation=i,this.setEventedParent(u),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new s.a(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new s.a(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new Ke(this._implementation.bounds,this.minzoom,this.maxzoom)),i.update=this._update.bind(this),i.clearTiles=this._clearTiles.bind(this),i.coveringTiles=this._coveringTiles.bind(this),s.e(this,s.ac(i,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return s.ac(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new s.b("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.b("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(c){this._map=c,this._loaded=!1,this.fire(new s.b("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(c),this.load()}onRemove(c){this._implementation.onRemove&&this._implementation.onRemove(c)}hasTile(c){if(this._implementation.hasTile){const{x:i,y:o,z:u}=c.canonical;return this._implementation.hasTile({x:i,y:o,z:u})}return!this.tileBounds||this.tileBounds.contains(c.canonical)}loadTile(c,i){const{x:o,y:u,z:d}=c.tileID.canonical,p=new AbortController;c.request=Promise.resolve(this._implementation.loadTile({x:o,y:u,z:d},{signal:p.signal})).then((function(g){return delete c.request,c.aborted?(c.state="unloaded",i(null)):g===void 0?(c.state="errored",i(null)):g===null?(this.loadTileData(c,{width:this.tileSize,height:this.tileSize,data:null}),c.state="loaded",i(null)):function(v){return v instanceof ImageData||v instanceof HTMLCanvasElement||v instanceof ImageBitmap||v instanceof HTMLImageElement}(g)?(this.loadTileData(c,g),c.state="loaded",void i(null)):(c.state="errored",i(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch(g=>{g.code!==20&&(c.state="errored",i(g))}),c.request.cancel=()=>p.abort()}loadTileData(c,i){c.setTexture(i,this._map.painter)}unloadTile(c,i){if(c.texture&&c.texture instanceof s.T?(c.destroy(!0),c.texture&&c.texture instanceof s.T&&this._map.painter.saveTileTexture(c.texture)):c.destroy(),this._implementation.unloadTile){const{x:o,y:u,z:d}=c.tileID.canonical;this._implementation.unloadTile({x:o,y:u,z:d})}i()}abortTile(c,i){c.request&&c.request.cancel&&(c.request.cancel(),delete c.request),i()}hasTransition(){return!1}_coveringTiles(){return this._map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(c=>({x:c.canonical.x,y:c.canonical.y,z:c.canonical.z}))}_clearTiles(){const c=s.ag(this.id,this.scope);this._map.style.clearSource(c)}_update(){this.fire(new s.b("data",{dataType:"source",sourceDataType:"content"}))}}},bi=function(c,i,o,u){const d=new po[i.type](c,i,o,u);if(d.id!==c)throw new Error(`Expected Source id to be ${c} instead of ${d.id}`);return s.aY(["load","abort","unload","serialize","prepare"],d),d};function Jc(c,i){const o=s.a6.identity([]);return s.a6.scale(o,o,[.5*c.width,.5*-c.height,1]),s.a6.translate(o,o,[1,-1,0]),s.a6.multiply(o,o,c.calculateProjMatrix(i.toUnwrapped())),Float32Array.from(o)}function Qc(c,i,o,u,d,p,g,v=!1){const w=c.tilesIn(u,g,v);w.sort(qs);const M=[];for(const S of w)M.push({wrappedTileID:S.tile.tileID.wrapped().key,queryResults:S.tile.queryRenderedFeatures(i,o,c._state,S,d,p,Jc(c.transform,S.tile.tileID),v)});const I=function(S){const z={},R={};for(const U of S){const N=U.queryResults,V=U.wrappedTileID,B=R[V]=R[V]||{};for(const G in N){const K=N[G],q=B[G]=B[G]||{},J=z[G]=z[G]||[];for(const j of K)q[j.featureIndex]||(q[j.featureIndex]=!0,J.push(j))}}return z}(M);for(const S in I)I[S].forEach(z=>{const R=z.feature,U=R.layer;U&&U.type!=="background"&&U.type!=="sky"&&U.type!=="slot"&&(R.source=U.source,U["source-layer"]&&(R.sourceLayer=U["source-layer"]),R.state=R.id!==void 0?c.getFeatureState(U["source-layer"],R.id):{})});return I}function mo(c,i){const o=c.getRenderableIds().map(p=>c.getTileByID(p)),u=[],d={};for(let p=0;p<o.length;p++){const g=o[p],v=g.tileID.canonical.key;d[v]||(d[v]=!0,g.querySourceFeatures(u,i))}return u}function qs(c,i){const o=c.tileID,u=i.tileID;return o.overscaledZ-u.overscaledZ||o.canonical.y-u.canonical.y||o.wrap-u.wrap||o.canonical.x-u.canonical.x}class ps extends Bo{constructor(i,o,u,d,p){super(i,o,u,d,p),this._workQueue=[],this._fetchQueue=[],this._isHeaderLoaded=!1}setTexture(i,o){const u=o.context,d=u.gl;this.texture=this.texture||o.getTileTexture(i.width),this.texture&&this.texture instanceof s.T?this.texture.update(i,{useMipmap:!1,premultiply:!1}):this.texture=new s.T(u,i,d.RGBA,{useMipmap:!1,premultiply:!1})}flushQueues(){for(;this._workQueue.length;)this._workQueue.pop()();for(;this._fetchQueue.length;)this._fetchQueue.pop()()}fetchHeader(i=16384,o){const u=this._mrt=new s.aZ(30),d=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(i-1)}});return this.entireBuffer=null,this.request=s.a_(d,(p,g,v,w)=>{if(p)o(p);else try{const M=u.getHeaderLength(g);if(M>i)return void(this.request=this.fetchHeader(M,o));u.parseHeader(g),this._isHeaderLoaded=!0;let I=0;for(const S of Object.values(u.layers))I=Math.max(I,S.dataIndex[S.dataIndex.length-1].last_byte);g.byteLength>=I&&(this.entireBuffer=g),o(null,this.entireBuffer||g,v,w)}catch(M){o(M)}}),this.request}fetchBand(i,o,u){const d=this._mrt;if(!this._isHeaderLoaded||!d)return void u(new Error("Tile header is not ready"));const p=this.actor;if(!p)return void u(new Error("Can't fetch tile band without an actor"));let g;const v=(S,z)=>{g.complete(S,z),S?u(S):(this.updateTextureDescriptor(i,o),u(null,this.textureDescriptor&&this.textureDescriptor.img))},w=(S,z)=>{if(S)return u(S);const R=p.send("decodeRasterArray",{buffer:z,task:g},v,void 0,!0);this._workQueue.push(()=>{R&&R.cancel(),g.cancel()})},M=d.getLayer(i);if(!M)return void u(new Error(`Unknown sourceLayer "${i}"`));if(M.hasDataForBand(o))return this.updateTextureDescriptor(i,o),void u(null,this.textureDescriptor?this.textureDescriptor.img:null);const I=M.getDataRange([o]);if(g=d.createDecodingTask(I),!g||g.tasks.length)if(this.flushQueues(),this.entireBuffer)w(null,this.entireBuffer.slice(I.firstByte,I.lastByte+1));else{const S=Object.assign({},this.requestParams,{headers:{Range:`bytes=${I.firstByte}-${I.lastByte}`}}),z=s.a_(S,w);this._fetchQueue.push(()=>{z.cancel(),g.cancel()})}else u(null)}updateNeeded(i,o){return(!this.textureDescriptor||this.textureDescriptor.band!==o||this.textureDescriptor.layer!==i)&&this.state!=="errored"}updateTextureDescriptor(i,o){if(!this._mrt)return;const u=this._mrt.getLayer(i);if(!u||!u.hasBand(o)||!u.hasDataForBand(o))return;const{bytes:d,tileSize:p,buffer:g,offset:v,scale:w}=u.getBandView(o),M=p+2*g,I={data:d,width:M,height:M},S=this.texture;S&&S instanceof s.T&&S.update(I,{useMipmap:!1,premultiply:!1}),this.textureDescriptor={layer:i,band:o,img:I,buffer:g,offset:v,tileSize:p,format:u.pixelFormat,mix:[w,256*w,65536*w,16777216*w]}}}class Ws{constructor(i,o){this.max=i,this.onRemove=o,this.reset()}reset(){for(const i in this.data)for(const o of this.data[i])o.timeout&&clearTimeout(o.timeout),this.onRemove(o.value);return this.data={},this.order=[],this}add(i,o,u){const d=i.wrapped().key;this.data[d]===void 0&&(this.data[d]=[]);const p={value:o,timeout:void 0};if(u!==void 0&&(p.timeout=setTimeout(()=>{this.remove(i,p)},u)),this.data[d].push(p),this.order.push(d),this.order.length>this.max){const g=this._getAndRemoveByKey(this.order[0]);g&&this.onRemove(g)}return this}has(i){return i.wrapped().key in this.data}getAndRemove(i){return this.has(i)?this._getAndRemoveByKey(i.wrapped().key):null}_getAndRemoveByKey(i){const o=this.data[i].shift();return o.timeout&&clearTimeout(o.timeout),this.data[i].length===0&&delete this.data[i],this.order.splice(this.order.indexOf(i),1),o.value}getByKey(i){const o=this.data[i];return o?o[0].value:null}get(i){return this.has(i)?this.data[i.wrapped().key][0].value:null}remove(i,o){if(!this.has(i))return this;const u=i.wrapped().key,d=o===void 0?0:this.data[u].indexOf(o),p=this.data[u][d];return this.data[u].splice(d,1),p.timeout&&clearTimeout(p.timeout),this.data[u].length===0&&delete this.data[u],this.onRemove(p.value),this.order.splice(this.order.indexOf(u),1),this}setMaxSize(i){for(this.max=i;this.order.length>this.max;){const o=this._getAndRemoveByKey(this.order[0]);o&&this.onRemove(o)}return this}filter(i){const o=[];for(const u in this.data)for(const d of this.data[u])i(d.value)||o.push(d);for(const u of o)this.remove(u.value.tileID,u)}}class Vn extends s.E{constructor(i,o,u){super(),this.id=i,this._onlySymbols=u,o.on("data",d=>{d.dataType==="source"&&d.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&d.dataType==="source"&&d.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),o.on("error",()=>{this._sourceErrored=!0}),this._source=o,this._tiles={},this._cache=new Ws(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=o.minTileCacheSize,this._maxTileCacheSize=o.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new St,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(i){this.map=i,this._minTileCacheSize=this._minTileCacheSize===void 0&&i?i._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&i?i._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const i in this._tiles){const o=this._tiles[i];if(o.state!=="errored"&&(o.state!=="loaded"||!o.bucketsLoaded()))return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const i=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,i&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(i,o){return i.isSymbolTile=this._onlySymbols,i.isExtraShadowCaster=this._shadowCasterTiles[i.tileID.key],this._source.loadTile(i,o)}_unloadTile(i){if(this._source.unloadTile)return this._source.unloadTile(i,()=>{})}_abortTile(i){if(this._source.abortTile)return this._source.abortTile(i,()=>{})}serialize(){return this._source.serialize()}prepare(i){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const o in this._tiles){const u=this._tiles[o];u.upload(i),u.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return s.a$(this._tiles).map(i=>i.tileID).sort(Nl).map(i=>i.key)}getRenderableIds(i,o){const u=[];for(const d in this._tiles)this._isIdRenderable(+d,i,o)&&u.push(this._tiles[d]);return i?u.sort((d,p)=>{const g=d.tileID,v=p.tileID,w=new s.P(g.canonical.x,g.canonical.y)._rotate(this.transform.angle),M=new s.P(v.canonical.x,v.canonical.y)._rotate(this.transform.angle);return g.overscaledZ-v.overscaledZ||M.y-w.y||M.x-w.x}).map(d=>d.tileID.key):u.map(d=>d.tileID).sort(Nl).map(d=>d.key)}hasRenderableParent(i){const o=this.findLoadedParent(i,0);return!!o&&this._isIdRenderable(o.tileID.key)}_isIdRenderable(i,o,u){return this._tiles[i]&&this._tiles[i].hasData()&&!this._coveredTiles[i]&&(o||!this._tiles[i].holdingForFade())&&(u||!this._shadowCasterTiles[i])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const i in this._tiles)this._tiles[i].state!=="errored"&&this._reloadTile(+i,"reloading")}}_reloadTile(i,o){const u=this._tiles[i];u&&(u.state!=="loading"&&(u.state=o),this._loadTile(u,this._tileLoaded.bind(this,u,i,o)))}_tileLoaded(i,o,u,d){if(d)if(i.state="errored",d.status!==404)this._source.fire(new s.a(d,{tile:i}));else{if(!(i.tileID.key in this._loadedParentTiles))return void this._source.fire(new s.b("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id}));if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const p=this.map.painter.terrain;this.update(this.transform,p.getScaledDemTileSize(),!0),p.resetTileLookupCache(this.id)}else this.update(this.transform)}else i.timeAdded=s.f.now(),u==="expired"&&(i.refreshedUponExpiration=!0),this._setTileReloadTimer(o,i),this._source.type==="raster-dem"&&i.dem&&this._backfillDEM(i),this._state.initializeTileState(i,this.map?this.map.painter:null),this._source.fire(new s.b("data",{dataType:"source",tile:i,coord:i.tileID,sourceCacheId:this.id}))}_backfillDEM(i){const o=this.getRenderableIds();for(let d=0;d<o.length;d++){const p=o[d];if(i.neighboringTiles&&i.neighboringTiles[p]){const g=this.getTileByID(p);u(i,g),u(g,i)}}function u(d,p){if(!d.dem||d.dem.borderReady)return;d.needsHillshadePrepare=!0,d.needsDEMTextureUpload=!0;let g=p.tileID.canonical.x-d.tileID.canonical.x;const v=p.tileID.canonical.y-d.tileID.canonical.y,w=Math.pow(2,d.tileID.canonical.z),M=p.tileID.key;g===0&&v===0||Math.abs(v)>1||(Math.abs(g)>1&&(Math.abs(g+w)===1?g+=w:Math.abs(g-w)===1&&(g-=w)),p.dem&&d.dem&&(d.dem.backfillBorder(p.dem,g,v),d.neighboringTiles&&d.neighboringTiles[M]&&(d.neighboringTiles[M].backfilled=!0)))}}getTile(i){return this.getTileByID(i.key)}getTileByID(i){return this._tiles[i]}_retainLoadedChildren(i,o,u,d){for(const p in this._tiles){let g=this._tiles[p];if(d[p]||!g.hasData()||g.tileID.overscaledZ<=o||g.tileID.overscaledZ>u)continue;let v=g.tileID;for(;g&&g.tileID.overscaledZ>o+1;){const M=g.tileID.scaledTo(g.tileID.overscaledZ-1);g=this._tiles[M.key],g&&g.hasData()&&(v=M)}let w=v;for(;w.overscaledZ>o;)if(w=w.scaledTo(w.overscaledZ-1),i[w.key]){d[v.key]=v;break}}}findLoadedParent(i,o){if(i.key in this._loadedParentTiles){const u=this._loadedParentTiles[i.key];return u&&u.tileID.overscaledZ>=o?u:null}for(let u=i.overscaledZ-1;u>=o;u--){const d=i.scaledTo(u),p=this._getLoadedTile(d);if(p)return p}}_getLoadedTile(i){const o=this._tiles[i.key];return o&&o.hasData()?o:this._cache.getByKey(this._source.reparseOverscaled?i.wrapped().key:i.canonical.key)}updateCacheSize(i,o){o=o||this._source.tileSize;const u=Math.ceil(i.width/o)+1,d=Math.ceil(i.height/o)+1,p=Math.floor(u*d*5),g=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,p):p,v=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,g):g;this._cache.setMaxSize(v)}handleWrapJump(i){const o=Math.round((i-(this._prevLng===void 0?i:this._prevLng))/360);if(this._prevLng=i,o){const u={};for(const d in this._tiles){const p=this._tiles[d];p.tileID=p.tileID.unwrapTo(p.tileID.wrap+o),u[p.tileID.key]=p}this._tiles=u;for(const d in this._timers)clearTimeout(this._timers[d]),delete this._timers[d];for(const d in this._tiles)this._setTileReloadTimer(+d,this._tiles[d])}}update(i,o,u,d){if(this.transform=i,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!u)return;let p;if(this.updateCacheSize(i,o),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={},this.used||this.usedForTerrain)if(this._source.tileID)p=i.getVisibleUnwrappedCoordinates(this._source.tileID).map(w=>new s.am(w.canonical.z,w.wrap,w.canonical.z,w.canonical.x,w.canonical.y));else if(this.tileCoverLift!==0){const w=i.clone();w.tileCoverLift=this.tileCoverLift,p=w.coveringTiles({tileSize:o||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!u,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.minzoom<=1&&i.projection.name==="globe"&&(p.push(new s.am(1,0,1,0,0)),p.push(new s.am(1,0,1,1,0)),p.push(new s.am(1,0,1,0,1)),p.push(new s.am(1,0,1,1,1)))}else p=i.coveringTiles({tileSize:o||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!u,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.hasTile&&(p=p.filter(w=>this._source.hasTile(w)));else p=[];if(p.length>0&&this.castsShadows&&d&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!_o(this._source.type)){const w=i.coveringZoomLevel({tileSize:o||this._source.tileSize,roundZoom:this._source.roundZoom&&!u}),M=Math.min(w,this._source.maxzoom),I=i.extendTileCoverForShadows(p,d,M);for(const S of I)this._shadowCasterTiles[S.key]=!0,p.push(S)}const g=this._updateRetainedTiles(p);if(_o(this._source.type)&&p.length!==0){const w={},M={},I=Object.keys(g);for(const z of I){const R=g[z],U=this._tiles[z];if(!U||U.fadeEndTime&&U.fadeEndTime<=s.f.now())continue;const N=this.findLoadedParent(R,Math.max(R.overscaledZ-Vn.maxOverzooming,this._source.minzoom));N&&(this._addTile(N.tileID),w[N.tileID.key]=N.tileID),M[z]=R}const S=p[p.length-1].overscaledZ;for(const z in this._tiles){const R=this._tiles[z];if(g[z]||!R.hasData())continue;let U=R.tileID;for(;U.overscaledZ>S;){U=U.scaledTo(U.overscaledZ-1);const N=this._tiles[U.key];if(N&&N.hasData()&&M[U.key]){g[z]=R.tileID;break}}}for(const z in w)g[z]||(this._coveredTiles[z]=!0,g[z]=w[z])}for(const w in g)this._tiles[w].clearFadeHold();const v=s.b0(this._tiles,g);for(const w of v){const M=this._tiles[w];M.hasSymbolBuckets&&!M.holdingForFade()?M.setHoldDuration(this.map._fadeDuration):M.hasSymbolBuckets&&!M.symbolFadeFinished()||this._removeTile(+w)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const i in this._tiles)this._tiles[i].holdingForFade()&&this._removeTile(+i)}_updateRetainedTiles(i){const o={};if(i.length===0)return o;const u={},d=i.reduce((M,I)=>Math.min(M,I.overscaledZ),1/0),p=i[0].overscaledZ,g=Math.max(p-Vn.maxOverzooming,this._source.minzoom),v=Math.max(p+Vn.maxUnderzooming,this._source.minzoom),w={};for(const M of i){const I=this._addTile(M);o[M.key]=M,I.hasData()||d<this._source.maxzoom&&(w[M.key]=M)}this._retainLoadedChildren(w,d,v,o);for(const M of i){let I=this._tiles[M.key];if(I.hasData())continue;if(M.canonical.z>=this._source.maxzoom){const z=M.children(this._source.maxzoom)[0],R=this.getTile(z);if(R&&R.hasData()){o[z.key]=z;continue}}else{const z=M.children(this._source.maxzoom);if(o[z[0].key]&&o[z[1].key]&&o[z[2].key]&&o[z[3].key])continue}let S=I.wasRequested();for(let z=M.overscaledZ-1;z>=g;--z){const R=M.scaledTo(z);if(u[R.key]||(u[R.key]=!0,I=this.getTile(R),!I&&S&&(I=this._addTile(R)),I&&(o[R.key]=R,S=I.wasRequested(),I.hasData())))break}}return o}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const i in this._tiles){const o=[];let u,d=this._tiles[i].tileID;for(;d.overscaledZ>0;){if(d.key in this._loadedParentTiles){u=this._loadedParentTiles[d.key];break}o.push(d.key);const p=d.scaledTo(d.overscaledZ-1);if(u=this._getLoadedTile(p),u)break;d=p}for(const p of o)this._loadedParentTiles[p]=u}}_addTile(i){let o=this._tiles[i.key];if(o)return o.isExtraShadowCaster!==!0||this._shadowCasterTiles[i.key]||this._reloadTile(i.key,"reloading"),o;o=this._cache.getAndRemove(i),o&&(this._setTileReloadTimer(i.key,o),o.tileID=i,this._state.initializeTileState(o,this.map?this.map.painter:null),this._cacheTimers[i.key]&&(clearTimeout(this._cacheTimers[i.key]),delete this._cacheTimers[i.key],this._setTileReloadTimer(i.key,o)));const u=!!o;if(!u){const d=this.map?this.map.painter:null,p=this._source.tileSize*i.overscaleFactor();o=this._source.type==="raster-array"?new ps(i,p,this.transform.tileZoom,d,this._isRaster):new Bo(i,p,this.transform.tileZoom,d,this._isRaster),this._loadTile(o,this._tileLoaded.bind(this,o,i.key,o.state))}return o?(o.uses++,this._tiles[i.key]=o,u||this._source.fire(new s.b("dataloading",{tile:o,coord:o.tileID,dataType:"source"})),o):null}_setTileReloadTimer(i,o){i in this._timers&&(clearTimeout(this._timers[i]),delete this._timers[i]);const u=o.getExpiryTimeout();u&&(this._timers[i]=setTimeout(()=>{this._reloadTile(i,"expired"),delete this._timers[i]},u))}_removeTile(i){const o=this._tiles[i];o&&(o.uses--,delete this._tiles[i],this._timers[i]&&(clearTimeout(this._timers[i]),delete this._timers[i]),o.uses>0||(o.hasData()&&o.state!=="reloading"||o.state==="empty"?this._cache.add(o.tileID,o,o.getExpiryTimeout()):(o.aborted=!0,this._abortTile(o),this._unloadTile(o))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const i in this._tiles)this._removeTile(+i);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(i,o,u){const d=[],p=this.transform;if(!p)return d;const g=p.projection.name==="globe",v=s.a5(p.center.lng);for(const w in this._tiles){const M=this._tiles[w];if(u&&M.clearQueryDebugViz(),M.holdingForFade())continue;let I;if(g){const S=M.tileID.canonical;if(S.z===0){const z=[Math.abs(s.aa(v,...za(S,-1))-v),Math.abs(s.aa(v,...za(S,1))-v)];I=[0,2*z.indexOf(Math.min(...z))-1]}else{const z=[Math.abs(s.aa(v,...za(S,-1))-v),Math.abs(s.aa(v,...za(S,0))-v),Math.abs(s.aa(v,...za(S,1))-v)];I=[z.indexOf(Math.min(...z))-1]}}else I=[0];for(const S of I){const z=i.containsTile(M,p,o,S);z&&d.push(z)}}return d}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(i){return this._getRenderableCoordinates(i)}_getRenderableCoordinates(i,o){const u=this.getRenderableIds(i,o).map(p=>this._tiles[p].tileID),d=this.transform.projection.name==="globe";for(const p of u)p.projMatrix=this.transform.calculateProjMatrix(p.toUnwrapped()),p.expandedProjMatrix=d?this.transform.calculateProjMatrix(p.toUnwrapped(),!1,!0):p.projMatrix;return u}sortCoordinatesByDistance(i){const o=i.slice(),u=this.transform._camera.position,d=this.transform._camera.forward(),p={};for(const g of o){const v=1/(1<<g.canonical.z);p[g.key]=((g.canonical.x+.5)*v+g.wrap-u[0])*d[0]+((g.canonical.y+.5)*v-u[1])*d[1]-u[2]*d[2]}return o.sort((g,v)=>p[g.key]-p[v.key]),o}hasTransition(){if(this._source.hasTransition())return!0;if(_o(this._source.type))for(const i in this._tiles){const o=this._tiles[i];if(o.fadeEndTime!==void 0&&o.fadeEndTime>=s.f.now())return!0}return!1}setFeatureState(i,o,u){this._state.updateState(i=i||"_geojsonTileLayer",o,u)}removeFeatureState(i,o,u){this._state.removeFeatureState(i=i||"_geojsonTileLayer",o,u)}getFeatureState(i,o){return this._state.getState(i=i||"_geojsonTileLayer",o)}setDependencies(i,o,u){const d=this._tiles[i];d&&d.setDependencies(o,u)}reloadTilesForDependencies(i,o){for(const u in this._tiles)this._tiles[u].hasDependency(i,o)&&this._reloadTile(+u,"reloading");this._cache.filter(u=>!u.hasDependency(i,o))}_preloadTiles(i,o){if(!this._sourceLoaded){const w=()=>{this._sourceLoaded&&(this._source.off("data",w),this._preloadTiles(i,o))};return void this._source.on("data",w)}const u=new Map,d=Array.isArray(i)?i:[i],p=this.map.painter.terrain,g=this.usedForTerrain&&p?p.getScaledDemTileSize():this._source.tileSize;for(const w of d){const M=w.coveringTiles({tileSize:g,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const I of M)u.set(I.key,I);this.usedForTerrain&&w.updateElevation(!1)}const v=Array.from(u.values());s.b1(v,(w,M)=>{const I=new Bo(w,this._source.tileSize*w.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(I,S=>{this._source.type==="raster-dem"&&I.dem&&this._backfillDEM(I),M(S,I)})},o)}}function Nl(c,i){const o=Math.abs(2*c.wrap)-+(c.wrap<0),u=Math.abs(2*i.wrap)-+(i.wrap<0);return c.overscaledZ-i.overscaledZ||u-o||i.canonical.y-c.canonical.y||i.canonical.x-c.canonical.x}function _o(c){return c==="raster"||c==="image"||c==="video"||c==="custom"}function za(c,i){const o=1<<c.z;return[c.x/o+i,(c.x+1)/o+i]}Vn.maxOverzooming=10,Vn.maxUnderzooming=3;class dd{constructor(i){this.style=i,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const i=!1,o=!1;for(const u in this.style._mergedLayers){const d=this.style._mergedLayers[u];if(d.type==="fill-extrusion")this.layers.push({layer:d,visible:i,visibilityChanged:o});else if(d.type==="model"){const p=this.style.getLayerSource(d);p&&p.type==="batched-model"&&this.layers.push({layer:d,visible:i,visibilityChanged:o})}}}onNewFrame(i){this.layersGotHidden=!1;for(const o of this.layers){const u=o.layer;let d=!1;u.type==="fill-extrusion"?d=!u.isHidden(i)&&u.paint.get("fill-extrusion-opacity")>0:u.type==="model"&&(d=!u.isHidden(i)&&u.paint.get("model-opacity")>0),this.layersGotHidden=this.layersGotHidden||!d&&o.visible,o.visible=d}}updateZOffset(i,o){this.currentBuildingBuckets=[];for(const d of this.layers){const p=d.layer,g=this.style.getLayerSourceCache(p);let v=1;p.type==="fill-extrusion"&&(v=d.visible?p.paint.get("fill-extrusion-vertical-scale"):0);let w=g?g.getTile(o):null;if(!w&&g&&o.canonical.z>g.getSource().minzoom){let M=o.scaledTo(Math.min(g.getSource().maxzoom,o.overscaledZ-1));for(;M.overscaledZ>=g.getSource().minzoom&&(w=g.getTile(M),!w&&M.overscaledZ!==0);)M=M.scaledTo(M.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:w?w.getBucket(p):null,tileID:w?w.tileID:o,verticalScale:v})}i.hasAnyZOffset=!1;let u=!1;for(let d=0;d<i.symbolInstances.length;d++){const p=i.symbolInstances.get(d),g=p.zOffset,v=this._getHeightAtTileOffset(o,p.tileAnchorX,p.tileAnchorY);p.zOffset=v!==Number.NEGATIVE_INFINITY?v:g,u||g===p.zOffset||(u=!0),i.hasAnyZOffset||p.zOffset===0||(i.hasAnyZOffset=!0)}u&&(i.zOffsetBuffersNeedUpload=!0,i.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(i,o,u,d){let p=o,g=u;if(i.canonical.z!==d.canonical.z){const v=d.canonical,w=1/(1<<i.canonical.z-v.z);p=(o+i.canonical.x*s.V)*w-v.x*s.V|0,g=(u+i.canonical.y*s.V)*w-v.y*s.V|0}return{tileX:p,tileY:g}}_getHeightAtTileOffset(i,o,u){let d,p;for(let g=0;g<this.layers.length;++g){if(this.layers[g].layer.type!=="fill-extrusion")continue;const{bucket:v,tileID:w,verticalScale:M}=this.currentBuildingBuckets[g];if(!v)continue;const{tileX:I,tileY:S}=this._mapCoordToOverlappingTile(i,o,u,w),z=v.getHeightAtTileCoord(I,S);z&&z.height!==void 0&&(z.hidden?d=z.height:p=Math.max(z.height*M,p||0))}if(p!==void 0)return p;for(let g=0;g<this.layers.length;++g){const v=this.layers[g];if(v.layer.type!=="model"||!v.visible)continue;const{bucket:w,tileID:M}=this.currentBuildingBuckets[g];if(!w)continue;const{tileX:I,tileY:S}=this._mapCoordToOverlappingTile(i,o,u,M),z=w.getHeightAtTileCoord(I,S);if(z&&!z.hidden)return z.height===void 0&&d!==void 0?Math.min(z.maxHeight,d)*z.verticalScale:(z.height||0)*z.verticalScale}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function ms(c,i){const o={};for(const u in c)u!=="ref"&&(o[u]=c[u]);return s.b2.forEach(u=>{u in i&&(o[u]=i[u])}),o}function fd(c){c=c.slice();const i=Object.create(null);for(let o=0;o<c.length;o++)i[c[o].id]=c[o];for(let o=0;o<c.length;o++)"ref"in c[o]&&(c[o]=ms(c[o],i[c[o].ref]));return c}const dr={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport"};function Ra(c,i,o){o.push({command:dr.addSource,args:[c,i[c]]})}function eu(c,i,o){i.push({command:dr.removeSource,args:[c]}),o[c]=!0}function kp(c,i,o,u){eu(c,o,u),Ra(c,i,o)}function Bp(c,i,o){let u;for(u in c[o])if(c[o].hasOwnProperty(u)&&u!=="data"&&!te(c[o][u],i[o][u]))return!1;for(u in i[o])if(i[o].hasOwnProperty(u)&&u!=="data"&&!te(c[o][u],i[o][u]))return!1;return!0}function Fo(c,i,o,u,d,p){let g;for(g in i=i||{},c=c||{})c.hasOwnProperty(g)&&(te(c[g],i[g])||o.push({command:p,args:[u,g,i[g],d]}));for(g in i)i.hasOwnProperty(g)&&!c.hasOwnProperty(g)&&(te(c[g],i[g])||o.push({command:p,args:[u,g,i[g],d]}))}function No(c){return c.id}function Ul(c,i){return c[i.id]=i,c}class Hs{constructor(i,o){this.reset(i,o)}reset(i,o){this.points=i||[],this._distances=[0];for(let u=1;u<this.points.length;u++)this._distances[u]=this._distances[u-1]+this.points[u].dist(this.points[u-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(o||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(i){if(this.points.length===1)return this.points[0];i=s.aa(i,0,1);let o=1,u=this._distances[o];const d=i*this.paddedLength+this.padding;for(;u<d&&o<this._distances.length;)u=this._distances[++o];const p=o-1,g=this._distances[p],v=u-g,w=v>0?(d-g)/v:0;return this.points[p].mult(1-w).add(this.points[o].mult(w))}}class tu{constructor(i,o,u){const d=this.boxCells=[],p=this.circleCells=[];this.xCellCount=Math.ceil(i/u),this.yCellCount=Math.ceil(o/u);for(let g=0;g<this.xCellCount*this.yCellCount;g++)d.push([]),p.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=i,this.height=o,this.xScale=this.xCellCount/i,this.yScale=this.yCellCount/o,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(i,o,u,d,p){this._forEachCell(o,u,d,p,this._insertBoxCell,this.boxUid++),this.boxKeys.push(i),this.bboxes.push(o),this.bboxes.push(u),this.bboxes.push(d),this.bboxes.push(p)}insertCircle(i,o,u,d){this._forEachCell(o-d,u-d,o+d,u+d,this._insertCircleCell,this.circleUid++),this.circleKeys.push(i),this.circles.push(o),this.circles.push(u),this.circles.push(d)}_insertBoxCell(i,o,u,d,p,g){this.boxCells[p].push(g)}_insertCircleCell(i,o,u,d,p,g){this.circleCells[p].push(g)}_query(i,o,u,d,p,g){if(u<0||i>this.width||d<0||o>this.height)return!p&&[];const v=[];if(i<=0&&o<=0&&this.width<=u&&this.height<=d){if(p)return!0;for(let w=0;w<this.boxKeys.length;w++)v.push({key:this.boxKeys[w],x1:this.bboxes[4*w],y1:this.bboxes[4*w+1],x2:this.bboxes[4*w+2],y2:this.bboxes[4*w+3]});for(let w=0;w<this.circleKeys.length;w++){const M=this.circles[3*w],I=this.circles[3*w+1],S=this.circles[3*w+2];v.push({key:this.circleKeys[w],x1:M-S,y1:I-S,x2:M+S,y2:I+S})}return g?v.filter(g):v}return this._forEachCell(i,o,u,d,this._queryCell,v,{hitTest:p,seenUids:{box:{},circle:{}}},g),p?v.length>0:v}_queryCircle(i,o,u,d,p){const g=i-u,v=i+u,w=o-u,M=o+u;if(v<0||g>this.width||M<0||w>this.height)return!d&&[];const I=[];return this._forEachCell(g,w,v,M,this._queryCellCircle,I,{hitTest:d,circle:{x:i,y:o,radius:u},seenUids:{box:{},circle:{}}},p),d?I.length>0:I}query(i,o,u,d,p){return this._query(i,o,u,d,!1,p)}hitTest(i,o,u,d,p){return this._query(i,o,u,d,!0,p)}hitTestCircle(i,o,u,d){return this._queryCircle(i,o,u,!0,d)}_queryCell(i,o,u,d,p,g,v,w){const M=v.seenUids,I=this.boxCells[p];if(I!==null){const z=this.bboxes;for(const R of I)if(!M.box[R]){M.box[R]=!0;const U=4*R;if(i<=z[U+2]&&o<=z[U+3]&&u>=z[U+0]&&d>=z[U+1]&&(!w||w(this.boxKeys[R]))){if(v.hitTest)return g.push(!0),!0;g.push({key:this.boxKeys[R],x1:z[U],y1:z[U+1],x2:z[U+2],y2:z[U+3]})}}}const S=this.circleCells[p];if(S!==null){const z=this.circles;for(const R of S)if(!M.circle[R]){M.circle[R]=!0;const U=3*R;if(this._circleAndRectCollide(z[U],z[U+1],z[U+2],i,o,u,d)&&(!w||w(this.circleKeys[R]))){if(v.hitTest)return g.push(!0),!0;{const N=z[U],V=z[U+1],B=z[U+2];g.push({key:this.circleKeys[R],x1:N-B,y1:V-B,x2:N+B,y2:V+B})}}}}}_queryCellCircle(i,o,u,d,p,g,v,w){const M=v.circle,I=v.seenUids,S=this.boxCells[p];if(S!==null){const R=this.bboxes;for(const U of S)if(!I.box[U]){I.box[U]=!0;const N=4*U;if(this._circleAndRectCollide(M.x,M.y,M.radius,R[N+0],R[N+1],R[N+2],R[N+3])&&(!w||w(this.boxKeys[U])))return g.push(!0),!0}}const z=this.circleCells[p];if(z!==null){const R=this.circles;for(const U of z)if(!I.circle[U]){I.circle[U]=!0;const N=3*U;if(this._circlesCollide(R[N],R[N+1],R[N+2],M.x,M.y,M.radius)&&(!w||w(this.circleKeys[U])))return g.push(!0),!0}}}_forEachCell(i,o,u,d,p,g,v,w){const M=this._convertToXCellCoord(i),I=this._convertToYCellCoord(o),S=this._convertToXCellCoord(u),z=this._convertToYCellCoord(d);for(let R=M;R<=S;R++)for(let U=I;U<=z;U++)if(p.call(this,i,o,u,d,this.xCellCount*U+R,g,v,w))return}_convertToXCellCoord(i){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(i*this.xScale)))}_convertToYCellCoord(i){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(i*this.yScale)))}_circlesCollide(i,o,u,d,p,g){const v=d-i,w=p-o,M=u+g;return M*M>v*v+w*w}_circleAndRectCollide(i,o,u,d,p,g,v){const w=(g-d)/2,M=Math.abs(i-(d+w));if(M>w+u)return!1;const I=(v-p)/2,S=Math.abs(o-(p+I));if(S>I+u)return!1;if(M<=w||S<=I)return!0;const z=M-w,R=S-I;return z*z+R*R<=u*u}}const go={unknown:0,flipRequired:1,flipNotRequired:2},Uo=Math.tan(85*Math.PI/180);function Oa(c,i,o,u,d,p,g){const v=s.a6.create();if(o)if(p.name==="globe"){const w=s.b3(d,i);s.a6.multiply(v,v,w)}else{const w=s.b4.invert([],g);v[0]=w[0],v[1]=w[1],v[4]=w[2],v[5]=w[3],u||s.a6.rotateZ(v,v,d.angle)}else s.a6.multiply(v,d.labelPlaneMatrix,c);return v}function ru(c,i,o,u,d,p,g){const v=Oa(c,i,o,u,d,p,g);return p.name==="globe"&&o||(v[2]=v[6]=v[10]=v[14]=0),v}function iu(c,i,o,u,d,p,g){if(o){if(p.name==="globe"){const v=Oa(c,i,o,u,d,p,g);return s.a6.invert(v,v),s.a6.multiply(v,c,v),v}{const v=s.a6.clone(c),w=s.a6.identity([]);return w[0]=g[0],w[1]=g[1],w[4]=g[2],w[5]=g[3],s.a6.multiply(v,v,w),u||s.a6.rotateZ(v,v,-d.angle),v}}return d.glCoordMatrix}function Sn(c,i,o,u){const d=[c,i,o,1];o?s.a7.transformMat4(d,d,u):cu(d,d,u);const p=d[3];return d[0]/=p,d[1]/=p,d[2]/=p,d}function pd(c,i){return Math.min(.5+c/i*.5,1.5)}function nu(c,i){const o=c[0]/c[3],u=c[1]/c[3];return o>=-i[0]&&o<=i[0]&&u>=-i[1]&&u<=i[1]}function ou(c,i,o,u,d,p,g,v,w,M){const I=o.transform,S=u?c.textSizeData:c.iconSizeData,z=s.b5(S,o.transform.zoom),R=I.projection.name==="globe",U=[256/o.width*2+1,256/o.height*2+1],N=u?c.text.dynamicLayoutVertexArray:c.icon.dynamicLayoutVertexArray;N.clear();let V=null;R&&(V=u?c.text.globeExtVertexArray:c.icon.globeExtVertexArray);const B=c.lineVertexArray,G=u?c.text.placedSymbolArray:c.icon.placedSymbolArray,K=o.transform.width/o.transform.height;let q,J=!1;for(let j=0;j<G.length;j++){const Q=G.get(j),{numGlyphs:oe,writingMode:le}=Q;if(le!==s.b6.vertical||J||q===s.b6.horizontal||(J=!0),q=le,(Q.hidden||le===s.b6.vertical)&&!J){Vo(oe,N);continue}J=!1;const he=new s.P(Q.tileAnchorX,Q.tileAnchorY);let{x:we,y:me,z:Ae}=I.projection.projectTilePoint(he.x,he.y,M.canonical);if(w){const[ot,yt,Pt]=w(he);we+=ot,me+=yt,Ae+=Pt}const Ie=[we,me,Ae,1];if(s.a7.transformMat4(Ie,Ie,i),!nu(Ie,U)){Vo(oe,N);continue}const Ue=Ie[3],ge=pd(o.transform.getCameraToCenterDistance(I.projection),Ue),Ee=s.b7(S,z,Q),ue=g?Ee/ge:Ee*ge,ve=Sn(we,me,Ae,d);if(ve[3]<=0){Vo(oe,N);continue}let Ve={};const Ye=g?null:w,Xe=lu(Q,ue,!1,v,i,d,p,c.glyphOffsetArray,B,N,V,ve,he,Ve,K,Ye,I.projection,M,g);J=Xe.useVertical,Ye&&Xe.needsFlipping&&(Ve={}),(Xe.notEnoughRoom||J||Xe.needsFlipping&&lu(Q,ue,!0,v,i,d,p,c.glyphOffsetArray,B,N,V,ve,he,Ve,K,Ye,I.projection,M,g).notEnoughRoom)&&Vo(oe,N)}u?(c.text.dynamicLayoutVertexBuffer.updateData(N),V&&c.text.globeExtVertexBuffer&&c.text.globeExtVertexBuffer.updateData(V)):(c.icon.dynamicLayoutVertexBuffer.updateData(N),V&&c.icon.globeExtVertexBuffer&&c.icon.globeExtVertexBuffer.updateData(V))}function su(c,i,o,u,d,p,g,v,w,M,I,S,z,R,U,N){const{lineStartIndex:V,glyphStartIndex:B,segment:G}=v,K=B+v.numGlyphs,q=V+v.lineLength,J=i.getoffsetX(B),j=i.getoffsetX(K-1),Q=ka(c*J,o,u,d,p,g,G,V,q,w,M,I,S,z,!0,R,U,N);if(!Q)return null;const oe=ka(c*j,o,u,d,p,g,G,V,q,w,M,I,S,z,!0,R,U,N);return oe?{first:Q,last:oe}:null}function au(c,i,o,u){return c===s.b6.horizontal&&Math.abs(u)>Math.abs(o)?{useVertical:!0}:c===s.b6.vertical?u>0?{needsFlipping:!0}:null:i!==go.unknown&&function(d,p){return d===0||Math.abs(p/d)>Uo}(o,u)?i===go.flipRequired?{needsFlipping:!0}:null:o<0?{needsFlipping:!0}:null}function lu(c,i,o,u,d,p,g,v,w,M,I,S,z,R,U,N,V,B,G){const K=i/24,q=c.lineOffsetX*K,J=c.lineOffsetY*K,{lineStartIndex:j,glyphStartIndex:Q,numGlyphs:oe,segment:le,writingMode:he,flipState:we}=c,me=j+c.lineLength,Ae=Ie=>{if(I){const[ue,ve,Ve]=Ie.up,Ye=M.length;s.b8(I,Ye+0,ue,ve,Ve),s.b8(I,Ye+1,ue,ve,Ve),s.b8(I,Ye+2,ue,ve,Ve),s.b8(I,Ye+3,ue,ve,Ve)}const[Ue,ge,Ee]=Ie.point;s.b9(M,Ue,ge,Ee,Ie.angle)};if(oe>1){const Ie=su(K,v,q,J,o,S,z,c,w,p,R,N,!1,V,B,G);if(!Ie)return{notEnoughRoom:!0};if(u&&!o){let[Ue,ge,Ee]=Ie.first.point,[ue,ve,Ve]=Ie.last.point;[Ue,ge]=Sn(Ue,ge,Ee,g),[ue,ve]=Sn(ue,ve,Ve,g);const Ye=au(he,we,(ue-Ue)*U,ve-ge);if(c.flipState=Ye&&Ye.needsFlipping?go.flipRequired:go.flipNotRequired,Ye)return Ye}Ae(Ie.first);for(let Ue=Q+1;Ue<Q+oe-1;Ue++){const ge=ka(K*v.getoffsetX(Ue),q,J,o,S,z,le,j,me,w,p,R,N,!1,!1,V,B,G);if(!ge)return M.length-=4*(Ue-Q),{notEnoughRoom:!0};Ae(ge)}Ae(Ie.last)}else{if(u&&!o){const Ue=Sn(z.x,z.y,0,d),ge=j+le+1,Ee=new s.P(w.getx(ge),w.gety(ge)),ue=Sn(Ee.x,Ee.y,0,d),ve=ue[3]>0?ue:Vl(z,Ee,Ue,1,d,void 0,V,B.canonical),Ve=au(he,we,(ve[0]-Ue[0])*U,ve[1]-Ue[1]);if(c.flipState=Ve&&Ve.needsFlipping?go.flipRequired:go.flipNotRequired,Ve)return Ve}const Ie=ka(K*v.getoffsetX(Q),q,J,o,S,z,le,j,me,w,p,R,N,!1,!1,V,B,G);if(!Ie)return{notEnoughRoom:!0};Ae(Ie)}return{}}function Xs(c,i,o,u,d){const{x:p,y:g,z:v}=u.projectTilePoint(c.x,c.y,i);if(!d)return Sn(p,g,v,o);const[w,M,I]=d(c);return Sn(p+w,g+M,v+I,o)}function Vl(c,i,o,u,d,p,g,v){const w=Xs(c.sub(i)._unit()._add(c),v,d,g,p);return s.N.sub(w,o,w),s.N.normalize(w,w),s.N.scaleAndAdd(w,o,w,u)}function ka(c,i,o,u,d,p,g,v,w,M,I,S,z,R,U,N,V,B){const G=u?c-i:c+i;let K=G>0?1:-1,q=0;u&&(K*=-1,q=Math.PI),K<0&&(q+=Math.PI);let J=v+g+(K>0?0:1)|0,j=d,Q=d,oe=0,le=0;const he=Math.abs(G),we=[],me=[];let Ae=p,Ie=Ae;const Ue=()=>Vl(Ie,Ae,Q,he-oe+1,I,z,N,V.canonical);for(;oe+le<=he;){if(J+=K,J<v||J>=w)return null;if(Q=j,Ie=Ae,we.push(Q),R&&me.push(Ie),Ae=new s.P(M.getx(J),M.gety(J)),j=S[J],!j){const yt=Xs(Ae,V.canonical,I,N,z);j=yt[3]>0?S[J]=yt:Ue()}oe+=le,le=s.N.distance(Q,j)}U&&z&&(S[J]&&(j=Ue(),le=s.N.distance(Q,j)),S[J]=j);const ge=(he-oe)/le,Ee=Ae.sub(Ie)._mult(ge)._add(Ie),ue=s.N.sub([],j,Q),ve=s.N.scaleAndAdd([],Q,ue,ge);let Ve=[0,0,1],Ye=ue[0],Xe=ue[1];if(B&&(Ve=N.upVector(V.canonical,Ee.x,Ee.y),Ve[0]!==0||Ve[1]!==0||Ve[2]!==1)){const yt=[Ve[2],0,-Ve[0]],Pt=s.N.cross([],Ve,yt);s.N.normalize(yt,yt),s.N.normalize(Pt,Pt),Ye=s.N.dot(ue,yt),Xe=s.N.dot(ue,Pt)}if(o){const yt=s.N.cross([],Ve,ue);s.N.normalize(yt,yt),s.N.scaleAndAdd(ve,ve,yt,o*K)}const ot=q+Math.atan2(Xe,Ye);return we.push(ve),R&&me.push(Ee),{point:ve,angle:ot,path:we,tilePath:me,up:Ve}}function Vo(c,i){const o=i.length,u=o+4*c;i.resize(u),i.float32.fill(-1/0,4*o,4*u)}function cu(c,i,o){const u=i[0],d=i[1];return c[0]=o[0]*u+o[4]*d+o[12],c[1]=o[1]*u+o[5]*d+o[13],c[3]=o[3]*u+o[7]*d+o[15],c}const Pn=100;class ct{constructor(i,o,u=new tu(i.width+200,i.height+200,25),d=new tu(i.width+200,i.height+200,25)){this.transform=i,this.grid=u,this.ignoredGrid=d,this.pitchfactor=Math.cos(i._pitch)*i.cameraToCenterDistance,this.screenRightBoundary=i.width+Pn,this.screenBottomBoundary=i.height+Pn,this.gridRightBoundary=i.width+200,this.gridBottomBoundary=i.height+200,this.fogState=o}placeCollisionBox(i,o,u,d,p,g,v,w){let M=u.projectedAnchorX,I=u.projectedAnchorY,S=u.projectedAnchorZ;const z=u.elevation,R=u.tileID,U=i.getProjection();if(z&&R){const[j,Q,oe]=U.upVector(R.canonical,u.tileAnchorX,u.tileAnchorY),le=U.upVectorScale(R.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;M+=j*z*le,I+=Q*z*le,S+=oe*z*le}const N=this.projectAndGetPerspectiveRatio(v,M,I,S,u.tileID,U.name==="globe"||!!z||this.transform.pitch>0,U),V=g*N.perspectiveRatio,B=(u.x1*o+d.x-u.padding)*V+N.point.x,G=(u.y1*o+d.y-u.padding)*V+N.point.y,K=(u.x2*o+d.x+u.padding)*V+N.point.x,q=(u.y2*o+d.y+u.padding)*V+N.point.y,J=N.perspectiveRatio<=.55||N.occluded;return!this.isInsideGrid(B,G,K,q)||!p&&this.grid.hitTest(B,G,K,q,w)||J?{box:[],offscreen:!1,occluded:N.occluded}:{box:[B,G,K,q],offscreen:this.isOffscreen(B,G,K,q),occluded:!1}}placeCollisionCircles(i,o,u,d,p,g,v,w,M,I,S,z,R,U,N){const V=[],B=this.transform.elevation,G=i.getProjection(),K=B?B.getAtTileOffsetFunc(N,this.transform.center.lat,this.transform.worldSize,G):null,q=new s.P(u.tileAnchorX,u.tileAnchorY);let{x:J,y:j,z:Q}=G.projectTilePoint(q.x,q.y,N.canonical);if(K){const[Ee,ue,ve]=K(q);J+=Ee,j+=ue,Q+=ve}const oe=G.name==="globe",le=this.projectAndGetPerspectiveRatio(v,J,j,Q,N,oe||!!B||this.transform.pitch>0,G),{perspectiveRatio:he}=le,we=(S?g/he:g*he)/s.bc,me=Sn(J,j,Q,w),Ae=le.signedDistanceFromCamera>0?su(we,p,u.lineOffsetX*we,u.lineOffsetY*we,!1,me,q,u,d,w,{},B&&!S?K:null,S&&!!B,G,N,S):null;let Ie=!1,Ue=!1,ge=!0;if(Ae&&!le.occluded){const Ee=.5*R*he+U,ue=new s.P(-100,-100),ve=new s.P(this.screenRightBoundary,this.screenBottomBoundary),Ve=new Hs,{first:Ye,last:Xe}=Ae,ot=Ye.path.length;let yt=[];for(let It=ot-1;It>=1;It--)yt.push(Ye.path[It]);for(let It=1;It<Xe.path.length;It++)yt.push(Xe.path[It]);const Pt=2.5*Ee;M&&(yt=yt.map(([It,Yt,Vt],qt)=>(K&&!oe&&(Vt=K(qt<ot-1?Ye.tilePath[ot-1-qt]:Xe.tilePath[qt-ot+2])[2]),Sn(It,Yt,Vt,M))),yt.some(It=>It[3]<=0)&&(yt=[]));let Tt=[];if(yt.length>0){let It=1/0,Yt=-1/0,Vt=1/0,qt=-1/0;for(const $t of yt)It=Math.min(It,$t[0]),Vt=Math.min(Vt,$t[1]),Yt=Math.max(Yt,$t[0]),qt=Math.max(qt,$t[1]);Yt>=ue.x&&It<=ve.x&&qt>=ue.y&&Vt<=ve.y&&(Tt=[yt.map($t=>new s.P($t[0],$t[1]))],(It<ue.x||Yt>ve.x||Vt<ue.y||qt>ve.y)&&(Tt=s.ba(Tt,ue.x,ue.y,ve.x,ve.y)))}for(const It of Tt){Ve.reset(It,.25*Ee);let Yt=0;Yt=Ve.length<=.5*Ee?1:Math.ceil(Ve.paddedLength/Pt)+1;for(let Vt=0;Vt<Yt;Vt++){const qt=Vt/Math.max(Yt-1,1),$t=Ve.lerp(qt),fr=$t.x+Pn,Vr=$t.y+Pn;V.push(fr,Vr,Ee,0);const nr=fr-Ee,ri=Vr-Ee,or=fr+Ee,yr=Vr+Ee;if(ge=ge&&this.isOffscreen(nr,ri,or,yr),Ue=Ue||this.isInsideGrid(nr,ri,or,yr),!o&&this.grid.hitTestCircle(fr,Vr,Ee,z)&&(Ie=!0,!I))return{circles:[],offscreen:!1,collisionDetected:Ie,occluded:!1}}}}return{circles:!I&&Ie||!Ue?[]:V,offscreen:ge,collisionDetected:Ie,occluded:le.occluded}}queryRenderedSymbols(i){if(i.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const o=[];let u=1/0,d=1/0,p=-1/0,g=-1/0;for(const I of i){const S=new s.P(I.x+Pn,I.y+Pn);u=Math.min(u,S.x),d=Math.min(d,S.y),p=Math.max(p,S.x),g=Math.max(g,S.y),o.push(S)}const v=this.grid.query(u,d,p,g).concat(this.ignoredGrid.query(u,d,p,g)),w={},M={};for(const I of v){const S=I.key;if(w[S.bucketInstanceId]===void 0&&(w[S.bucketInstanceId]={}),w[S.bucketInstanceId][S.featureIndex])continue;const z=[new s.P(I.x1,I.y1),new s.P(I.x2,I.y1),new s.P(I.x2,I.y2),new s.P(I.x1,I.y2)];s.bb(o,z)&&(w[S.bucketInstanceId][S.featureIndex]=!0,M[S.bucketInstanceId]===void 0&&(M[S.bucketInstanceId]=[]),M[S.bucketInstanceId].push(S.featureIndex))}return M}insertCollisionBox(i,o,u,d,p){(o?this.ignoredGrid:this.grid).insert({bucketInstanceId:u,featureIndex:d,collisionGroupID:p},i[0],i[1],i[2],i[3])}insertCollisionCircles(i,o,u,d,p){const g=o?this.ignoredGrid:this.grid,v={bucketInstanceId:u,featureIndex:d,collisionGroupID:p};for(let w=0;w<i.length;w+=4)g.insertCircle(v,i[w],i[w+1],i[w+2])}projectAndGetPerspectiveRatio(i,o,u,d,p,g,v){const w=[o,u,d,1];let M=!1;d||this.transform.pitch>0?(s.a7.transformMat4(w,w,i),this.fogState&&p&&v.name!=="globe"&&(M=function(z,R,U,N,V,B){const G=B.calculateFogTileMatrix(V),K=[R,U,N];return s.N.transformMat4(K,K,G),Mr(z,s.N.length(K),B.pitch,B._fov)}(this.fogState,o,u,d,p.toUnwrapped(),this.transform)>.9)):cu(w,w,i);const I=w[3];return{point:new s.P((w[0]/I+1)/2*this.transform.width+Pn,(-w[1]/I+1)/2*this.transform.height+Pn),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(v)/I*.5,1.5),signedDistanceFromCamera:I,occluded:g&&w[2]>I||M}}isOffscreen(i,o,u,d){return u<Pn||i>=this.screenRightBoundary||d<Pn||o>this.screenBottomBoundary}isInsideGrid(i,o,u,d){return u>=0&&i<this.gridRightBoundary&&d>=0&&o<this.gridBottomBoundary}getViewportMatrix(){const i=s.a6.identity([]);return s.a6.translate(i,i,[-100,-100,0]),i}}function jl(c,i,o){const u=i.createTileMatrix(c,c.worldSize,o.toUnwrapped());return s.a6.multiply(new Float32Array(16),c.projMatrix,u)}function uu(c,i,o){if(i.projection.name===o.projection.name)return c.projMatrix;const u=o.clone();return u.setProjection(i.projection),jl(u,i.getProjection(),c)}function Ba(c,i,o){return i.name===o.projection.name?c.projMatrix:jl(o,i,c)}class hu{constructor(i,o,u,d){this.opacity=i?Math.max(0,Math.min(1,i.opacity+(i.placed?o:-o))):d&&u?1:0,this.placed=u}isHidden(){return this.opacity===0&&!this.placed}}class jo{constructor(i,o,u,d,p,g=!1){this.text=new hu(i?i.text:null,o,u,p),this.icon=new hu(i?i.icon:null,o,d,p),this.clipped=g}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class jn{constructor(i,o,u,d=!1){this.text=i,this.icon=o,this.skipFade=u,this.clipped=d}}class du{constructor(){this.invProjMatrix=s.a6.create(),this.viewportMatrix=s.a6.create(),this.circles=[]}}class _s{constructor(i,o,u,d,p){this.bucketInstanceId=i,this.featureIndex=o,this.sourceLayerIndex=u,this.bucketIndex=d,this.tileID=p}}class Zl{constructor(i){this.crossSourceCollisions=i,this.maxGroupID=0,this.collisionGroups={}}get(i){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[i]){const o=++this.maxGroupID;this.collisionGroups[i]={ID:o,predicate:u=>u.collisionGroupID===o}}return this.collisionGroups[i]}}function gs(c,i,o,u,d){const{horizontalAlign:p,verticalAlign:g}=s.bf(c),v=-(p-.5)*i,w=-(g-.5)*o,M=s.bd(c,u);return new s.P(v+M[0]*d,w+M[1]*d)}function fu(c,i,o,u,d){const p=new s.P(c,i);return o&&p._rotate(u?d:-d),p}class Fp{constructor(i,o,u,d,p,g){this.transform=i.clone(),this.projection=i.projection.name,this.collisionIndex=new ct(this.transform,p),this.buildingIndex=g,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=o,this.retainedQueryData={},this.collisionGroups=new Zl(u),this.collisionCircleArrays={},this.prevPlacement=d,d&&(d.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(i,o,u,d){const p=u.getBucket(o),g=u.latestFeatureIndex;if(!p||!g||o.fqid!==p.layerIds[0])return;const v=p.layers[0].layout,w=u.collisionBoxArray,M=Math.pow(2,this.transform.zoom-u.tileID.overscaledZ),I=u.tileSize/s.V,S=u.tileID.toUnwrapped();this.transform.setProjection(p.projection);const z=(R=u.tileID,U=p.getProjection(),N=this.transform,U.name===this.projection?N.calculateProjMatrix(R.toUnwrapped()):jl(N,U,R));var R,U,N;const V=v.get("text-pitch-alignment")==="map",B=v.get("text-rotation-alignment")==="map";o.compileFilter();const G=o.dynamicFilter(),K=o.dynamicFilterNeedsFeature(),q=this.transform.calculatePixelsToTileUnitsMatrix(u),J=ru(z,u.tileID.canonical,V,B,this.transform,p.getProjection(),q);let j=null;if(V){const le=iu(z,u.tileID.canonical,V,B,this.transform,p.getProjection(),q);j=s.a6.multiply([],this.transform.labelPlaneMatrix,le)}let Q=null;G&&u.latestFeatureIndex&&(Q={unwrappedTileID:S,dynamicFilter:G,dynamicFilterNeedsFeature:K,featureIndex:u.latestFeatureIndex}),this.retainedQueryData[p.bucketInstanceId]=new _s(p.bucketInstanceId,g,p.sourceLayerIndex,p.index,u.tileID);const oe={bucket:p,layout:v,posMatrix:z,textLabelPlaneMatrix:J,labelToScreenMatrix:j,clippingData:Q,scale:M,textPixelRatio:I,holdingForFade:u.holdingForFade(),collisionBoxArray:w,partiallyEvaluatedTextSize:s.b5(p.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:s.b5(p.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(p.sourceID)};if(d)for(const le of p.sortKeyRanges){const{sortKey:he,symbolInstanceStart:we,symbolInstanceEnd:me}=le;i.push({sortKey:he,symbolInstanceStart:we,symbolInstanceEnd:me,parameters:oe})}else i.push({symbolInstanceStart:0,symbolInstanceEnd:p.symbolInstances.length,parameters:oe})}attemptAnchorPlacement(i,o,u,d,p,g,v,w,M,I,S,z,R,U,N,V,B,G){const{textOffset0:K,textOffset1:q,crossTileID:J}=z,j=[K,q],Q=gs(i,u,d,j,p),oe=this.collisionIndex.placeCollisionBox(U,p,o,fu(Q.x,Q.y,g,v,this.transform.angle),S,w,M,I.predicate);if(V){const le=U.getSymbolInstanceIconSize(G,this.transform.zoom,z.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(U,le,V,fu(Q.x,Q.y,g,v,this.transform.angle),S,w,M,I.predicate).box.length===0)return}if(oe.box.length>0){let le;return this.prevPlacement&&this.prevPlacement.variableOffsets[J]&&this.prevPlacement.placements[J]&&this.prevPlacement.placements[J].text&&(le=this.prevPlacement.variableOffsets[J].anchor),this.variableOffsets[J]={textOffset:j,width:u,height:d,anchor:i,textScale:p,prevAnchor:le},this.markUsedJustification(U,i,z,N),U.allowVerticalPlacement&&(this.markUsedOrientation(U,N,z),this.placedOrientations[J]=N),{shift:Q,placedGlyphBoxes:oe}}}placeLayerBucketPart(i,o,u,d){const{bucket:p,layout:g,posMatrix:v,textLabelPlaneMatrix:w,labelToScreenMatrix:M,clippingData:I,textPixelRatio:S,holdingForFade:z,collisionBoxArray:R,partiallyEvaluatedTextSize:U,partiallyEvaluatedIconSize:N,collisionGroup:V}=i.parameters,B=g.get("text-optional"),G=g.get("icon-optional"),K=g.get("text-allow-overlap"),q=g.get("icon-allow-overlap"),J=g.get("text-rotation-alignment")==="map",j=g.get("text-pitch-alignment")==="map",Q=g.get("symbol-z-order")==="viewport-y",oe=g.get("symbol-z-elevate");this.transform.setProjection(p.projection);let le=K&&(q||!p.hasIconData()||G),he=q&&(K||!p.hasTextData()||B);!p.collisionArrays&&R&&p.deserializeCollisionBoxes(R),u&&d&&p.updateCollisionDebugBuffers(this.transform.zoom,R);const we=(me,Ae,Ie)=>{const{crossTileID:Ue,numVerticalGlyphVertices:ge}=me;if(I){const or={zoom:this.transform.zoom,pitch:this.transform.pitch};let yr=null;if(I.dynamicFilterNeedsFeature){const sr=this.retainedQueryData[p.bucketInstanceId];yr=I.featureIndex.loadFeature({featureIndex:me.featureIndex,bucketIndex:sr.bucketIndex,sourceLayerIndex:sr.sourceLayerIndex,layoutVertexArrayOffset:0})}if(!(0,I.dynamicFilter)(or,yr,this.retainedQueryData[p.bucketInstanceId].tileID.canonical,new s.P(me.tileAnchorX,me.tileAnchorY),this.transform.calculateDistanceTileData(I.unwrappedTileID)))return this.placements[Ue]=new jn(!1,!1,!1,!0),void o.add(Ue)}if(o.has(Ue))return;if(z)return void(this.placements[Ue]=new jn(!1,!1,!1));let Ee=!1,ue=!1,ve=!0,Ve=!1,Ye=!1,Xe=null,ot={box:null,offscreen:null,occluded:null},yt={box:null,offscreen:null,occluded:null},Pt=null,Tt=null,It=null,Yt=0,Vt=0,qt=0;Ie.textFeatureIndex?Yt=Ie.textFeatureIndex:me.useRuntimeCollisionCircles&&(Yt=me.featureIndex),Ie.verticalTextFeatureIndex&&(Vt=Ie.verticalTextFeatureIndex);const $t=or=>{or.tileID=this.retainedQueryData[p.bucketInstanceId].tileID;const yr=this.transform.elevation;or.elevation=me.zOffset+(yr?yr.getAtTileOffset(or.tileID,or.tileAnchorX,or.tileAnchorY):0)},fr=Ie.textBox;if(fr){$t(fr);const or=sr=>{let gr=s.b6.horizontal;if(p.allowVerticalPlacement&&!sr&&this.prevPlacement){const Gr=this.prevPlacement.placedOrientations[Ue];Gr&&(this.placedOrientations[Ue]=Gr,gr=Gr,this.markUsedOrientation(p,gr,me))}return gr},yr=(sr,gr)=>{if(p.allowVerticalPlacement&&ge>0&&Ie.verticalTextBox){for(const Gr of p.writingModes)if(Gr===s.b6.vertical?(ot=gr(),yt=ot):ot=sr(),ot&&ot.box&&ot.box.length)break}else ot=sr()};if(g.get("text-variable-anchor")){let sr=g.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[Ue]){const Tr=this.prevPlacement.variableOffsets[Ue];sr.indexOf(Tr.anchor)>0&&(sr=sr.filter(Pi=>Pi!==Tr.anchor),sr.unshift(Tr.anchor))}const gr=(Tr,Pi,Zi)=>{const cn=p.getSymbolInstanceTextSize(U,me,this.transform.zoom,Ae),no=(Tr.x2-Tr.x1)*cn+2*Tr.padding,un=(Tr.y2-Tr.y1)*cn+2*Tr.padding,Li=me.hasIconTextFit&&!q?Pi:null;Li&&$t(Li);let wi={box:[],offscreen:!1,occluded:!1};const Xi=K?2*sr.length:sr.length;for(let tn=0;tn<Xi;++tn){const hn=this.attemptAnchorPlacement(sr[tn%sr.length],Tr,no,un,cn,J,j,S,v,V,tn>=sr.length,me,Ae,p,Zi,Li,U,N);if(hn&&(wi=hn.placedGlyphBoxes,wi&&wi.box&&wi.box.length)){Ee=!0,Xe=hn.shift;break}}return wi};yr(()=>gr(fr,Ie.iconBox,s.b6.horizontal),()=>{const Tr=Ie.verticalTextBox;return Tr&&$t(Tr),p.allowVerticalPlacement&&!(ot&&ot.box&&ot.box.length)&&ge>0&&Tr?gr(Tr,Ie.verticalIconBox,s.b6.vertical):{box:null,offscreen:null,occluded:null}}),ot&&(Ee=ot.box,ve=ot.offscreen,Ve=ot.occluded);const Gr=or(!(!ot||!ot.box));if(!Ee&&this.prevPlacement){const Tr=this.prevPlacement.variableOffsets[Ue];Tr&&(this.variableOffsets[Ue]=Tr,this.markUsedJustification(p,Tr.anchor,me,Gr))}}else{const sr=(gr,Gr)=>{const Tr=p.getSymbolInstanceTextSize(U,me,this.transform.zoom,Ae),Pi=this.collisionIndex.placeCollisionBox(p,Tr,gr,new s.P(0,0),K,S,v,V.predicate);return Pi&&Pi.box&&Pi.box.length&&(this.markUsedOrientation(p,Gr,me),this.placedOrientations[Ue]=Gr),Pi};yr(()=>sr(fr,s.b6.horizontal),()=>{const gr=Ie.verticalTextBox;return p.allowVerticalPlacement&&ge>0&&gr?($t(gr),sr(gr,s.b6.vertical)):{box:null,offscreen:null,occluded:null}}),or(!!(ot&&ot.box&&ot.box.length))}}if(Pt=ot,Ee=Pt&&Pt.box&&Pt.box.length>0,ve=Pt&&Pt.offscreen,Ve=Pt&&Pt.occluded,me.useRuntimeCollisionCircles){const or=p.text.placedSymbolArray.get(me.centerJustifiedTextSymbolIndex>=0?me.centerJustifiedTextSymbolIndex:me.verticalPlacedTextSymbolIndex),yr=s.b7(p.textSizeData,U,or),sr=g.get("text-padding");Tt=this.collisionIndex.placeCollisionCircles(p,K,or,p.lineVertexArray,p.glyphOffsetArray,yr,v,w,M,u,j,V.predicate,me.collisionCircleDiameter*yr/s.bc,sr,this.retainedQueryData[p.bucketInstanceId].tileID),Ee=K||Tt.circles.length>0&&!Tt.collisionDetected,ve=ve&&Tt.offscreen,Ve=Tt.occluded}if(Ie.iconFeatureIndex&&(qt=Ie.iconFeatureIndex),Ie.iconBox){const or=yr=>{$t(yr);const sr=me.hasIconTextFit&&Xe?fu(Xe.x,Xe.y,J,j,this.transform.angle):new s.P(0,0),gr=p.getSymbolInstanceIconSize(N,this.transform.zoom,me.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(p,gr,yr,sr,q,S,v,V.predicate)};yt&&yt.box&&yt.box.length&&Ie.verticalIconBox?(It=or(Ie.verticalIconBox),ue=It.box.length>0):(It=or(Ie.iconBox),ue=It.box.length>0),ve=ve&&It.offscreen,Ye=It.occluded}const Vr=B||me.numHorizontalGlyphVertices===0&&ge===0,nr=G||me.numIconVertices===0;if(Vr||nr?nr?Vr||(ue=ue&&Ee):Ee=ue&&Ee:ue=Ee=ue&&Ee,Ee&&Pt&&Pt.box&&this.collisionIndex.insertCollisionBox(Pt.box,g.get("text-ignore-placement"),p.bucketInstanceId,yt&&yt.box&&Vt?Vt:Yt,V.ID),ue&&It&&this.collisionIndex.insertCollisionBox(It.box,g.get("icon-ignore-placement"),p.bucketInstanceId,qt,V.ID),Tt&&(Ee&&this.collisionIndex.insertCollisionCircles(Tt.circles,g.get("text-ignore-placement"),p.bucketInstanceId,Yt,V.ID),u)){const or=p.bucketInstanceId;let yr=this.collisionCircleArrays[or];yr===void 0&&(yr=this.collisionCircleArrays[or]=new du);for(let sr=0;sr<Tt.circles.length;sr+=4)yr.circles.push(Tt.circles[sr+0]),yr.circles.push(Tt.circles[sr+1]),yr.circles.push(Tt.circles[sr+2]),yr.circles.push(Tt.collisionDetected?1:0)}const ri=p.projection.name!=="globe";le=le&&(ri||!Ve),he=he&&(ri||!Ye),this.placements[Ue]=new jn(Ee||le,ue||he,ve||p.justReloaded),o.add(Ue)};if(oe&&this.buildingIndex&&(this.buildingIndex.updateZOffset(p,this.retainedQueryData[p.bucketInstanceId].tileID),p.updateZOffset()),Q){const me=p.getSortedSymbolIndexes(this.transform.angle);for(let Ae=me.length-1;Ae>=0;--Ae){const Ie=me[Ae];we(p.symbolInstances.get(Ie),Ie,p.collisionArrays[Ie])}p.hasAnyZOffset&&s.w(`${p.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(p.hasAnyZOffset){const me=p.getSortedIndexesByZOffset();for(let Ae=0;Ae<me.length;++Ae){const Ie=me[Ae];we(p.symbolInstances.get(Ie),Ie,p.collisionArrays[Ie])}}else for(let me=i.symbolInstanceStart;me<i.symbolInstanceEnd;me++)we(p.symbolInstances.get(me),me,p.collisionArrays[me]);if(u&&p.bucketInstanceId in this.collisionCircleArrays){const me=this.collisionCircleArrays[p.bucketInstanceId];s.a6.invert(me.invProjMatrix,v),me.viewportMatrix=this.collisionIndex.getViewportMatrix()}p.justReloaded=!1}markUsedJustification(i,o,u,d){const{leftJustifiedTextSymbolIndex:p,centerJustifiedTextSymbolIndex:g,rightJustifiedTextSymbolIndex:v,verticalPlacedTextSymbolIndex:w,crossTileID:M}=u,I=s.be(o),S=d===s.b6.vertical?w:I==="left"?p:I==="center"?g:I==="right"?v:-1;p>=0&&(i.text.placedSymbolArray.get(p).crossTileID=S>=0&&p!==S?0:M),g>=0&&(i.text.placedSymbolArray.get(g).crossTileID=S>=0&&g!==S?0:M),v>=0&&(i.text.placedSymbolArray.get(v).crossTileID=S>=0&&v!==S?0:M),w>=0&&(i.text.placedSymbolArray.get(w).crossTileID=S>=0&&w!==S?0:M)}markUsedOrientation(i,o,u){const d=o===s.b6.horizontal||o===s.b6.horizontalOnly?o:0,p=o===s.b6.vertical?o:0,{leftJustifiedTextSymbolIndex:g,centerJustifiedTextSymbolIndex:v,rightJustifiedTextSymbolIndex:w,verticalPlacedTextSymbolIndex:M}=u,I=i.text.placedSymbolArray;g>=0&&(I.get(g).placedOrientation=d),v>=0&&(I.get(v).placedOrientation=d),w>=0&&(I.get(w).placedOrientation=d),M>=0&&(I.get(M).placedOrientation=p)}commit(i){this.commitTime=i,this.zoomAtLastRecencyCheck=this.transform.zoom;const o=this.prevPlacement;let u=!1;this.prevZoomAdjustment=o?o.zoomAdjustment(this.transform.zoom):0;const d=o?o.symbolFadeChange(i):1,p=o?o.opacities:{},g=o?o.variableOffsets:{},v=o?o.placedOrientations:{};for(const w in this.placements){const M=this.placements[w],I=p[w];I?(this.opacities[w]=new jo(I,d,M.text,M.icon,null,M.clipped),u=u||M.text!==I.text.placed||M.icon!==I.icon.placed):(this.opacities[w]=new jo(null,d,M.text,M.icon,M.skipFade,M.clipped),u=u||M.text||M.icon)}for(const w in p){const M=p[w];if(!this.opacities[w]){const I=new jo(M,d,!1,!1);I.isHidden()||(this.opacities[w]=I,u=u||M.text.placed||M.icon.placed)}}for(const w in g)this.variableOffsets[w]||!this.opacities[w]||this.opacities[w].isHidden()||(this.variableOffsets[w]=g[w]);for(const w in v)this.placedOrientations[w]||!this.opacities[w]||this.opacities[w].isHidden()||(this.placedOrientations[w]=v[w]);u?this.lastPlacementChangeTime=i:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=o?o.lastPlacementChangeTime:i)}updateLayerOpacities(i,o){const u=new Set;for(const d of o){const p=d.getBucket(i);p&&d.latestFeatureIndex&&i.fqid===p.layerIds[0]&&(this.updateBucketOpacities(p,u,d.collisionBoxArray),p.layers[0].layout.get("symbol-z-elevate")&&this.buildingIndex&&(this.buildingIndex.updateZOffset(p,d.tileID),p.updateZOffset()))}}updateBucketOpacities(i,o,u){i.hasTextData()&&i.text.opacityVertexArray.clear(),i.hasIconData()&&i.icon.opacityVertexArray.clear(),i.hasIconCollisionBoxData()&&i.iconCollisionBox.collisionVertexArray.clear(),i.hasTextCollisionBoxData()&&i.textCollisionBox.collisionVertexArray.clear();const d=i.layers[0].layout,p=!!i.layers[0].dynamicFilter(),g=new jo(null,0,!1,!1,!0),v=d.get("text-allow-overlap"),w=d.get("icon-allow-overlap"),M=d.get("text-variable-anchor"),I=d.get("text-rotation-alignment")==="map",S=d.get("text-pitch-alignment")==="map",z=new jo(null,0,v&&(w||!i.hasIconData()||d.get("icon-optional")),w&&(v||!i.hasTextData()||d.get("text-optional")),!0);!i.collisionArrays&&u&&(i.hasIconCollisionBoxData()||i.hasTextCollisionBoxData())&&i.deserializeCollisionBoxes(u);const R=(N,V,B)=>{for(let G=0;G<V/4;G++)N.opacityVertexArray.emplaceBack(B)};let U=0;for(let N=0;N<i.symbolInstances.length;N++){const V=i.symbolInstances.get(N),{numHorizontalGlyphVertices:B,numVerticalGlyphVertices:G,crossTileID:K,numIconVertices:q}=V,J=o.has(K);let j=this.opacities[K];J?j=g:j||(j=z,this.opacities[K]=j),o.add(K);const Q=B>0||G>0,oe=q>0,le=this.placedOrientations[K],he=le===s.b6.vertical,we=le===s.b6.horizontal||le===s.b6.horizontalOnly;if(!Q&&!oe||j.isHidden()||U++,Q){const me=gd(j.text);R(i.text,B,he?Fa:me),R(i.text,G,we?Fa:me);const Ae=j.text.isHidden(),{leftJustifiedTextSymbolIndex:Ie,centerJustifiedTextSymbolIndex:Ue,rightJustifiedTextSymbolIndex:ge,verticalPlacedTextSymbolIndex:Ee}=V,ue=i.text.placedSymbolArray,ve=Ae||he?1:0;Ie>=0&&(ue.get(Ie).hidden=ve),Ue>=0&&(ue.get(Ue).hidden=ve),ge>=0&&(ue.get(ge).hidden=ve),Ee>=0&&(ue.get(Ee).hidden=Ae||we?1:0);const Ve=this.variableOffsets[K];Ve&&this.markUsedJustification(i,Ve.anchor,V,le);const Ye=this.placedOrientations[K];Ye&&(this.markUsedJustification(i,"left",V,Ye),this.markUsedOrientation(i,Ye,V))}if(oe){const me=gd(j.icon),{placedIconSymbolIndex:Ae,verticalPlacedIconSymbolIndex:Ie}=V,Ue=i.icon.placedSymbolArray,ge=j.icon.isHidden()?1:0;Ae>=0&&(R(i.icon,q,he?Fa:me),Ue.get(Ae).hidden=ge),Ie>=0&&(R(i.icon,V.numVerticalIconVertices,we?Fa:me),Ue.get(Ie).hidden=ge)}if(i.hasIconCollisionBoxData()||i.hasTextCollisionBoxData()){const me=i.collisionArrays[N];if(me){let Ae=new s.P(0,0),Ie=!0;if(me.textBox||me.verticalTextBox){if(M){const ge=this.variableOffsets[K];ge?(Ae=gs(ge.anchor,ge.width,ge.height,ge.textOffset,ge.textScale),I&&Ae._rotate(S?this.transform.angle:-this.transform.angle)):Ie=!1}p&&(Ie=!j.clipped),me.textBox&&Ys(i.textCollisionBox.collisionVertexArray,j.text.placed,!Ie||he,Ae.x,Ae.y),me.verticalTextBox&&Ys(i.textCollisionBox.collisionVertexArray,j.text.placed,!Ie||we,Ae.x,Ae.y)}const Ue=Ie&&!!(!we&&me.verticalIconBox);me.iconBox&&Ys(i.iconCollisionBox.collisionVertexArray,j.icon.placed,Ue,V.hasIconTextFit?Ae.x:0,V.hasIconTextFit?Ae.y:0),me.verticalIconBox&&Ys(i.iconCollisionBox.collisionVertexArray,j.icon.placed,!Ue,V.hasIconTextFit?Ae.x:0,V.hasIconTextFit?Ae.y:0)}}}if(i.fullyClipped=U===0,i.sortFeatures(this.transform.angle),this.retainedQueryData[i.bucketInstanceId]&&(this.retainedQueryData[i.bucketInstanceId].featureSortOrder=i.featureSortOrder),i.hasTextData()&&i.text.opacityVertexBuffer&&i.text.opacityVertexBuffer.updateData(i.text.opacityVertexArray),i.hasIconData()&&i.icon.opacityVertexBuffer&&i.icon.opacityVertexBuffer.updateData(i.icon.opacityVertexArray),i.hasIconCollisionBoxData()&&i.iconCollisionBox.collisionVertexBuffer&&i.iconCollisionBox.collisionVertexBuffer.updateData(i.iconCollisionBox.collisionVertexArray),i.hasTextCollisionBoxData()&&i.textCollisionBox.collisionVertexBuffer&&i.textCollisionBox.collisionVertexBuffer.updateData(i.textCollisionBox.collisionVertexArray),i.bucketInstanceId in this.collisionCircleArrays){const N=this.collisionCircleArrays[i.bucketInstanceId];i.placementInvProjMatrix=N.invProjMatrix,i.placementViewportMatrix=N.viewportMatrix,i.collisionCircleArray=N.circles,delete this.collisionCircleArrays[i.bucketInstanceId]}}symbolFadeChange(i){return this.fadeDuration===0?1:(i-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(i){return Math.max(0,(this.transform.zoom-i)/1.5)}hasTransitions(i){return this.stale||i-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(i,o){const u=this.zoomAtLastRecencyCheck===o?1-this.zoomAdjustment(o):1;return this.zoomAtLastRecencyCheck=o,this.commitTime+this.fadeDuration*u>i}setStale(){this.stale=!0}}function Ys(c,i,o,u,d){c.emplaceBack(i?1:0,o?1:0,u||0,d||0),c.emplaceBack(i?1:0,o?1:0,u||0,d||0),c.emplaceBack(i?1:0,o?1:0,u||0,d||0),c.emplaceBack(i?1:0,o?1:0,u||0,d||0)}const Np=Math.pow(2,25),md=Math.pow(2,24),_d=Math.pow(2,17),pu=Math.pow(2,16),Up=Math.pow(2,9),Vp=Math.pow(2,8),jp=Math.pow(2,1);function gd(c){if(c.opacity===0&&!c.placed)return 0;if(c.opacity===1&&c.placed)return 4294967295;const i=c.placed?1:0,o=Math.floor(127*c.opacity);return o*Np+i*md+o*_d+i*pu+o*Up+i*Vp+o*jp+i}const Fa=0;class Zp{constructor(i){this._sortAcrossTiles=i.layout.get("symbol-z-order")!=="viewport-y"&&i.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(i,o,u,d,p){const g=this._bucketParts;for(;this._currentTileIndex<i.length;)if(o.getBucketParts(g,d,i[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,p())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,g.sort((v,w)=>v.sortKey-w.sortKey));this._currentPartIndex<g.length;){const v=g[this._currentPartIndex];if(o.placeLayerBucketPart(v,this._seenCrossTileIDs,u,v.symbolInstanceStart===0),this._currentPartIndex++,p())return!0}return!1}}class Gl{constructor(i,o,u,d,p,g,v,w,M){this.placement=new Fp(i,p,g,v,w,M),this._currentPlacementIndex=o.length-1,this._forceFullPlacement=u,this._showCollisionBoxes=d,this._done=!1}isDone(){return this._done}continuePlacement(i,o,u,d){const p=s.f.now(),g=()=>{const v=s.f.now()-p;return!this._forceFullPlacement&&v>2};for(;this._currentPlacementIndex>=0;){const v=o[i[this._currentPlacementIndex]],w=this.placement.collisionIndex.transform.zoom;if(v.type==="symbol"&&(!v.minzoom||v.minzoom<=w)&&(!v.maxzoom||v.maxzoom>w)){const M=v,I=M.layout.get("symbol-z-elevate"),S=this._inProgressLayer=this._inProgressLayer||new Zp(M),z=s.ag(v.source,v.scope);if(S.continuePlacement(I?d[z]:u[z],this.placement,this._showCollisionBoxes,v,g))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(i){return this.placement.commit(i),this.placement}}const mu=512/s.V/2;class yd{constructor(i,o,u){this.tileID=i,this.bucketInstanceId=u,this.index=new s.bg(o.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const d=i.canonical.x*s.V,p=i.canonical.y*s.V;for(let g=0;g<o.length;g++){const{key:v,crossTileID:w,tileAnchorX:M,tileAnchorY:I}=o.get(g),S=Math.floor((d+M)*mu),z=Math.floor((p+I)*mu);this.index.add(S,z),this.keys.push(v),this.crossTileIDs.push(w)}this.index.finish()}findMatches(i,o,u){const d=this.tileID.canonical.z<o.canonical.z?1:Math.pow(2,this.tileID.canonical.z-o.canonical.z),p=mu/Math.pow(2,o.canonical.z-this.tileID.canonical.z),g=o.canonical.x*s.V,v=o.canonical.y*s.V;for(let w=0;w<i.length;w++){const M=i.get(w);if(M.crossTileID)continue;const{key:I,tileAnchorX:S,tileAnchorY:z}=M,R=Math.floor((g+S)*p),U=Math.floor((v+z)*p),N=this.index.range(R-d,U-d,R+d,U+d);for(const V of N){const B=this.crossTileIDs[V];if(this.keys[V]===I&&!u.has(B)){u.add(B),M.crossTileID=B;break}}}}}class _u{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class $l{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(i){const o=Math.round((i-this.lng)/360);if(o!==0)for(const u in this.indexes){const d=this.indexes[u],p={};for(const g in d){const v=d[g];v.tileID=v.tileID.unwrapTo(v.tileID.wrap+o),p[v.tileID.key]=v}this.indexes[u]=p}this.lng=i}addBucket(i,o,u){if(this.indexes[i.overscaledZ]&&this.indexes[i.overscaledZ][i.key]){if(this.indexes[i.overscaledZ][i.key].bucketInstanceId===o.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(i.overscaledZ,this.indexes[i.overscaledZ][i.key])}for(let p=0;p<o.symbolInstances.length;p++)o.symbolInstances.get(p).crossTileID=0;this.usedCrossTileIDs[i.overscaledZ]||(this.usedCrossTileIDs[i.overscaledZ]=new Set);const d=this.usedCrossTileIDs[i.overscaledZ];for(const p in this.indexes){const g=this.indexes[p];if(Number(p)>i.overscaledZ)for(const v in g){const w=g[v];w.tileID.isChildOf(i)&&w.findMatches(o.symbolInstances,i,d)}else{const v=g[i.scaledTo(Number(p)).key];v&&v.findMatches(o.symbolInstances,i,d)}}for(let p=0;p<o.symbolInstances.length;p++){const g=o.symbolInstances.get(p);g.crossTileID||(g.crossTileID=u.generate(),d.add(g.crossTileID))}return this.indexes[i.overscaledZ]===void 0&&(this.indexes[i.overscaledZ]={}),this.indexes[i.overscaledZ][i.key]=new yd(i,o.symbolInstances,o.bucketInstanceId),!0}removeBucketCrossTileIDs(i,o){for(const u of o.crossTileIDs)this.usedCrossTileIDs[i].delete(u)}removeStaleBuckets(i){let o=!1;for(const u in this.indexes){const d=this.indexes[u];for(const p in d)i[d[p].bucketInstanceId]||(this.removeBucketCrossTileIDs(u,d[p]),delete d[p],o=!0)}return o}}class gu{constructor(){this.layerIndexes={},this.crossTileIDs=new _u,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(i,o,u,d){let p=this.layerIndexes[i.fqid];p===void 0&&(p=this.layerIndexes[i.fqid]=new $l);let g=!1;const v={};d.name!=="globe"&&p.handleWrapJump(u);for(const w of o){const M=w.getBucket(i);M&&i.fqid===M.layerIds[0]&&(M.bucketInstanceId||(M.bucketInstanceId=++this.maxBucketInstanceId),p.addBucket(w.tileID,M,this.crossTileIDs)&&(g=!0),v[M.bucketInstanceId]=!0)}return p.removeStaleBuckets(v)&&(g=!0),g}pruneUnusedLayers(i){const o={};i.forEach(u=>{o[u]=!0});for(const u in this.layerIndexes)o[u]||delete this.layerIndexes[u]}}class ys{constructor(i=0,o=0,u=0,d=0){if(isNaN(i)||i<0||isNaN(o)||o<0||isNaN(u)||u<0||isNaN(d)||d<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=i,this.bottom=o,this.left=u,this.right=d}interpolate(i,o,u){return o.top!=null&&i.top!=null&&(this.top=s.U(i.top,o.top,u)),o.bottom!=null&&i.bottom!=null&&(this.bottom=s.U(i.bottom,o.bottom,u)),o.left!=null&&i.left!=null&&(this.left=s.U(i.left,o.left,u)),o.right!=null&&i.right!=null&&(this.right=s.U(i.right,o.right,u)),this}getCenter(i,o){const u=s.aa((this.left+i-this.right)/2,0,i),d=s.aa((this.top+o-this.bottom)/2,0,o);return new s.P(u,d)}equals(i){return this.top===i.top&&this.bottom===i.bottom&&this.left===i.left&&this.right===i.right}clone(){return new ys(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function ql(c,i){const o=s.bk(c,3);s.a6.fromQuat(c,i),s.bm(c,3,o)}function Na(c,i){const o=s.bi.identity([]);return s.bi.rotateZ(o,o,-i),s.bi.rotateX(o,o,-c),o}function yu(c,i){const o=[c[0],c[1],0],u=[i[0],i[1],0];if(s.N.length(o)>=1e-15){const g=s.N.normalize([],o);s.N.scale(u,g,s.N.dot(u,g)),i[0]=u[0],i[1]=u[1]}const d=s.N.cross([],i,c);if(s.N.len(d)<1e-15)return null;const p=Math.atan2(-d[1],d[0]);return Na(Math.atan2(Math.sqrt(c[0]*c[0]+c[1]*c[1]),-c[2]),p)}class Ua{constructor(i,o){this.position=i,this.orientation=o}get position(){return this._position}set position(i){if(i){const o=i instanceof s.L?i:new s.L(i[0],i[1],i[2]);this._renderWorldCopies&&(o.x=s.bh(o.x,0,1)),this._position=o}else this._position=null}lookAtPoint(i,o){if(this.orientation=null,!this.position)return;const u=this.position,d=this._elevation?this._elevation.getAtPointOrZero(s.L.fromLngLat(i)):0,p=s.L.fromLngLat(i,d),g=[p.x-u.x,p.y-u.y,p.z-u.z];o||(o=[0,0,1]),o[2]=Math.abs(o[2]),this.orientation=yu(g,o)}setPitchBearing(i,o){this.orientation=Na(s.bj(i),s.bj(-o))}}class Ks{constructor(i,o){this._transform=s.a6.identity([]),this.orientation=o,this.position=i}get mercatorPosition(){const i=this.position;return new s.L(i[0],i[1],i[2])}get position(){const i=s.bk(this._transform,3);return[i[0],i[1],i[2]]}set position(i){var o;i&&s.bm(this._transform,3,[(o=i)[0],o[1],o[2],1])}get orientation(){return this._orientation}set orientation(i){this._orientation=i||s.bi.identity([]),i&&ql(this._transform,this._orientation)}getPitchBearing(){const i=this.forward(),o=this.right();return{bearing:Math.atan2(-o[1],o[0]),pitch:Math.atan2(Math.sqrt(i[0]*i[0]+i[1]*i[1]),-i[2])}}setPitchBearing(i,o){this._orientation=Na(i,o),ql(this._transform,this._orientation)}forward(){const i=s.bk(this._transform,2);return[-i[0],-i[1],-i[2]]}up(){const i=s.bk(this._transform,1);return[-i[0],-i[1],-i[2]]}right(){const i=s.bk(this._transform,0);return[i[0],i[1],i[2]]}getCameraToWorld(i,o){const u=new Float64Array(16);return s.a6.invert(u,this.getWorldToCamera(i,o)),u}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(i,o,u){const d=this.position;s.N.scale(d,d,-i);const p=new Float64Array(16);return s.a6.fromScaling(p,[u,u,u]),s.a6.translate(p,p,d),p[10]*=o,p}getWorldToCamera(i,o){const u=new Float64Array(16),d=new Float64Array(4),p=this.position;return s.bi.conjugate(d,this._orientation),s.N.scale(p,p,-i),s.a6.fromQuat(u,d),s.a6.translate(u,u,p),u[1]*=-1,u[5]*=-1,u[9]*=-1,u[13]*=-1,u[8]*=o,u[9]*=o,u[10]*=o,u[11]*=o,u}getCameraToClipPerspective(i,o,u,d){const p=new Float64Array(16);return s.a6.perspective(p,i,o,u,d),p}getCameraToClipOrthographic(i,o,u,d,p,g){const v=new Float64Array(16);return s.a6.ortho(v,i,o,u,d,p,g),v}getDistanceToElevation(i,o=!1){const u=i===0?0:s.bl(i,o?s.au(this.position[1]):this.position[1]),d=this.forward();return(u-this.position[2])/d[2]}clone(){return new Ks([...this.position],[...this.orientation])}}const Js=(c,i,o)=>(1-o)*c+o*i,Va=c=>c*c*c*c*c;class ja{constructor(i,o,u,d,p,g,v){this.tileSize=512,this._renderWorldCopies=p===void 0||p,this._minZoom=i||0,this._maxZoom=o||22,this._minPitch=u??0,this._maxPitch=d??60,this.setProjection(g),this.setMaxBounds(v),this.width=0,this.height=0,this._center=new s.bn(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new ys,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new Ks,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1}clone(){const i=new ja(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return i._elevation=this._elevation,i._centerAltitude=this._centerAltitude,i._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,i.tileSize=this.tileSize,i.mercatorFromTransition=this.mercatorFromTransition,i.width=this.width,i.height=this.height,i.cameraElevationReference=this.cameraElevationReference,i._center=this._center,i._setZoom(this.zoom),i._seaLevelZoom=this._seaLevelZoom,i.angle=this.angle,i._fov=this._fov,i._pitch=this._pitch,i._nearZ=this._nearZ,i._farZ=this._farZ,i._averageElevation=this._averageElevation,i._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,i._unmodified=this._unmodified,i._edgeInsets=this._edgeInsets.clone(),i._camera=this._camera.clone(),i._calcMatrices(),i.freezeTileCoverage=this.freezeTileCoverage,i.frustumCorners=this.frustumCorners,i}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<15}get elevation(){return this._elevation}set elevation(i){this._elevation!==i&&(this._elevation=i,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(i,o=!1){const u=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||u)&&this._updateCameraOnTerrain(),(i||u)&&this._constrainCamera(o),this._calcMatrices()}getProjection(){return s.ac(this.projection,["name","center","parallels"])}setProjection(i){this.projectionOptions=i||{name:"mercator"};const o=this.projection?this.getProjection():void 0;this.projection=s.bo(this.projectionOptions);const u=!te(o,this.getProjection());return u&&this._calcMatrices(),this.mercatorFromTransition=!1,u}setOrthographicProjectionAtLowPitch(i){return this._orthographicProjectionAtLowPitch!==i&&(this._orthographicProjectionAtLowPitch=i,this._calcMatrices(),!0)}setMercatorFromTransition(){const i=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=s.bo({name:"mercator"});const o=i!==this.projection.name;return o&&this._calcMatrices(),o}get minZoom(){return this._minZoom}set minZoom(i){this._minZoom!==i&&(this._minZoom=i,this.zoom=Math.max(this.zoom,i))}get maxZoom(){return this._maxZoom}set maxZoom(i){this._maxZoom!==i&&(this._maxZoom=i,this.zoom=Math.min(this.zoom,i))}get minPitch(){return this._minPitch}set minPitch(i){this._minPitch!==i&&(this._minPitch=i,this.pitch=Math.max(this.pitch,i))}get maxPitch(){return this._maxPitch}set maxPitch(i){this._maxPitch!==i&&(this._maxPitch=i,this.pitch=Math.min(this.pitch,i))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(i){i===void 0?i=!0:i===null&&(i=!1),this._renderWorldCopies=i}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const i=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(i))}get cameraWorldSize(){const i=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(i))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return s.bl(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new s.P(this.width,this.height)}get bearing(){return s.bh(this.rotation,-180,180)}set bearing(i){this.rotation=i}get rotation(){return-this.angle/Math.PI*180}set rotation(i){const o=-i*Math.PI/180;this.angle!==o&&(this._unmodified=!1,this.angle=o,this._calcMatrices(),this.rotationMatrix=s.b4.create(),s.b4.rotate(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(i){const o=s.aa(i,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==o&&(this._unmodified=!1,this._pitch=o,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}get fovX(){return this._fov}get fovY(){const i=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/i)}set fov(i){i=Math.max(.01,Math.min(60,i)),this._fov!==i&&(this._unmodified=!1,this._fov=s.bj(i),this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(i){this._averageElevation=i,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(i){const o=Math.min(Math.max(i,this.minZoom),this.maxZoom);this._zoom!==o&&(this._unmodified=!1,this._setZoom(o),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(i){this._zoom=i,this.scale=this.zoomScale(i),this.tileZoom=Math.floor(i),this.zoomFraction=i-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(i){this._tileCoverLift!==i&&(this._tileCoverLift=i)}_updateCameraOnTerrain(){const i=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,o=this.elevation&&i===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||i===Number.NEGATIVE_INFINITY&&(!o||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const u=this._elevation;o||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&u.exaggeration()&&this._centerAltitudeValidForExaggeration!==u.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*u.exaggeration(),this._centerAltitudeValidForExaggeration=u.exaggeration()):(this._centerAltitude=i||0,this._centerAltitudeValidForExaggeration=u.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){this._centerAltitudeValidForExaggeration!==void 0&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const i=this._elevation,o=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],u=this.horizonLineFromTop();let d=0,p=0;for(let g=0;g<o.length;g++){const v=new s.P(o[g][0]*this.width,u+o[g][1]*(this.height-u)),w=i.pointCoordinate(v);if(!w)continue;const M=1/Math.hypot(w[0]-this._camera.position[0],w[1]-this._camera.position[1]);d+=w[3]*M,p+=M}return p===0?NaN:d/p}get center(){return this._center}set center(i){i.lat===this._center.lat&&i.lng===this._center.lng||(this._unmodified=!1,this._center=i,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const i=this._seaLevelZoom,o=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),u=this.pixelsPerMeter/this.worldSize*o,d=this._mercatorZfromZoom(i),p=this._mercatorZfromZoom(this._maxZoom),g=Math.max(d-u,p);this._setZoom(this._zoomFromMercatorZ(g))}get padding(){return this._edgeInsets.toJSON()}set padding(i){this._edgeInsets.equals(i)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,i,1),this._calcMatrices())}computeZoomRelativeTo(i){const o=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,i.toAltitude()));let u;u=i.z<this._camera.position[2]?[o.x,o.y,o.z]:[i.x,i.y,i.z];const d=s.N.length(s.N.sub([],this._camera.position,u));return s.aa(this._zoomFromMercatorZ(d),this._minZoom,this._maxZoom)}setFreeCameraOptions(i){if(!this.height||!i.position&&!i.orientation)return;this._updateCameraState();let o=!1;if(i.orientation&&!s.bi.exactEquals(i.orientation,this._camera.orientation)&&(o=this._setCameraOrientation(i.orientation)),i.position){const u=[i.position.x,i.position.y,i.position.z];s.N.exactEquals(u,this._camera.position)||(this._setCameraPosition(u),o=!0)}o&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const i=this._camera.position,o=new Ua;return o.position=new s.L(i[0],i[1],i[2]),o.orientation=this._camera.orientation,o._elevation=this.elevation,o._renderWorldCopies=this.renderWorldCopies,o}_setCameraOrientation(i){if(!s.bi.length(i))return!1;s.bi.normalize(i,i);const o=s.N.transformQuat([],[0,0,-1],i),u=s.N.transformQuat([],[0,-1,0],i);if(u[2]<0)return!1;const d=yu(o,u);return!!d&&(this._camera.orientation=d,!0)}_setCameraPosition(i){const o=this.zoomScale(this.minZoom)*this.tileSize,u=this.zoomScale(this.maxZoom)*this.tileSize,d=this.cameraToCenterDistance;i[2]=s.aa(i[2],d/u,d/o),this._camera.position=i}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(i){return this._edgeInsets.equals(i)}interpolatePadding(i,o,u){this._unmodified=!1,this._edgeInsets.interpolate(i,o,u),this._constrain(),this._calcMatrices()}coveringZoomLevel(i){const o=(i.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/i.tileSize));return Math.max(0,o)}getVisibleUnwrappedCoordinates(i){const o=[new s.bp(0,i)];if(this.renderWorldCopies){const u=this.pointCoordinate(new s.P(0,0)),d=this.pointCoordinate(new s.P(this.width,0)),p=this.pointCoordinate(new s.P(this.width,this.height)),g=this.pointCoordinate(new s.P(0,this.height)),v=Math.floor(Math.min(u.x,d.x,p.x,g.x)),w=Math.floor(Math.max(u.x,d.x,p.x,g.x)),M=1;for(let I=v-M;I<=w+M;I++)I!==0&&o.push(new s.bp(I,i))}return o}isLODDisabled(i){return(!i||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCoverForShadows(i,o,u){let d=[];if(o[0]===0&&o[1]===0)return d;for(const g of i){const v=g.canonical,w=g.overscaledZ,M=g.wrap,I=1<<v.z,S=v.x+1<I,z=v.x>0,R=v.y+1<I,U=v.y>0,N=g.wrap-(z?0:1),V=g.wrap+(S?0:1),B=z?v.x-1:I-1,G=S?v.x+1:0;o[0]<0?(d.push(new s.am(w,V,v.z,G,v.y)),o[1]<0&&R&&(d.push(new s.am(w,M,v.z,v.x,v.y+1)),d.push(new s.am(w,V,v.z,G,v.y+1))),o[1]>0&&U&&(d.push(new s.am(w,M,v.z,v.x,v.y-1)),d.push(new s.am(w,V,v.z,G,v.y-1)))):o[0]>0?(d.push(new s.am(w,N,v.z,B,v.y)),o[1]<0&&R&&(d.push(new s.am(w,M,v.z,v.x,v.y+1)),d.push(new s.am(w,N,v.z,B,v.y+1))),o[1]>0&&U&&(d.push(new s.am(w,M,v.z,v.x,v.y-1)),d.push(new s.am(w,N,v.z,B,v.y-1)))):o[1]<0&&R?d.push(new s.am(w,M,v.z,v.x,v.y+1)):U&&d.push(new s.am(w,M,v.z,v.x,v.y-1))}if(d.length>1){d.sort((w,M)=>w.overscaledZ-M.overscaledZ||w.wrap-M.wrap||w.canonical.z-M.canonical.z||w.canonical.x-M.canonical.x||w.canonical.y-M.canonical.y);let g=0,v=0;for(;v<d.length;)d[v].equals(d[g])?++v:d[++g]=d[v++];d.length=g+1}const p=[];for(const g of d)d.some(v=>g.isChildOf(v))||p.push(g);return d=p.filter(g=>!i.some(v=>!!(g.overscaledZ<u&&v.isChildOf(g))||g.equals(v)||g.isChildOf(v))),d}coveringTiles(i){let o=this.coveringZoomLevel(i);const u=o,d=this.elevation&&this.elevation.exaggeration(),p=d&&!i.isTerrainDEM,g=this.projection.name==="mercator";if(i.minzoom!==void 0&&o<i.minzoom)return[];i.maxzoom!==void 0&&o>i.maxzoom&&(o=i.maxzoom);const v=this.locationCoordinate(this.center),w=this.center.lat,M=1<<o,I=[M*v.x,M*v.y,0],S=this.projection.name==="globe",z=!S,R=s.bq.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,o,z),U=S?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),N=M*s.bl(1,this.center.lat),V=this._camera.position[2]/s.bl(1,this.center.lat),B=[M*U.x,M*U.y,V*(z?1:N)],G=S||d,K=this.cameraToCenterDistance/i.tileSize*(i.roundZoom?1:.502),q=this.isLODDisabled(!0)?o:0;let J;if(this._elevation&&i.isTerrainDEM)J=1e4*this._elevation.exaggeration();else if(this._elevation){const ue=this._elevation.getMinMaxForVisibleTiles();J=ue?ue.max:this._centerAltitude}else J=this._centerAltitude;const j=i.isTerrainDEM?-J:this._elevation?this._elevation.getMinElevationBelowMSL():0,Q=this.projection.isReprojectedInTileSpace?s.br(this):1,oe=ue=>{const Ve=new s.L(ue.x+25e-6,ue.y,ue.z),Ye=new s.L(ue.x,ue.y+25e-6,ue.z),Xe=ue.toLngLat(),ot=Ve.toLngLat(),yt=Ye.toLngLat(),Pt=this.locationCoordinate(Xe),Tt=this.locationCoordinate(ot),It=this.locationCoordinate(yt),Yt=Math.hypot(Tt.x-Pt.x,Tt.y-Pt.y),Vt=Math.hypot(It.x-Pt.x,It.y-Pt.y);return Math.sqrt(Yt*Vt)*Q/25e-6},le=ue=>{const ve=J,Ve=j;return{aabb:s.bu(this,M,0,0,0,ue,Ve,ve,this.projection),zoom:0,x:0,y:0,minZ:Ve,maxZ:ve,wrap:ue,fullyVisible:!1}},he=[];let we=[];const me=o,Ae=i.reparseOverscaled?u:o,Ie=ue=>ue*ue,Ue=Ie((V-this._centerAltitude)*N),ge=ue=>{if(!this._elevation||!ue.tileID||!g)return;const ve=this._elevation.getMinMaxForTile(ue.tileID),Ve=ue.aabb;ve?(Ve.min[2]=ve.min,Ve.max[2]=ve.max,Ve.center[2]=(Ve.min[2]+Ve.max[2])/2):(ue.shouldSplit=Ee(ue),ue.shouldSplit||(Ve.min[2]=Ve.max[2]=Ve.center[2]=this._centerAltitude))},Ee=ue=>{if(ue.zoom<q)return!0;if(ue.zoom===me)return!1;if(ue.shouldSplit!=null)return ue.shouldSplit;const ve=ue.aabb.distanceX(B),Ve=ue.aabb.distanceY(B);let Ye=Ue,Xe=1;if(S){Ye=Ie(ue.aabb.distanceZ(B));const Pt=Math.pow(2,ue.zoom),Tt=s.au((ue.y+1)/Pt),It=s.au(ue.y/Pt),Yt=Math.min(Math.max(w,Tt),It),Vt=s.bJ(Yt)/s.bJ(w);if(Xe=Yt===w?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,Vt/this._mercatorScaleRatio),this.zoom<=s.bG&&ue.zoom===me-1&&Vt>=.9)return!0}else if(p&&(Ye=Ie(ue.aabb.distanceZ(B)*N)),this.projection.isReprojectedInTileSpace&&u<=5){const Pt=Math.pow(2,ue.zoom),Tt=oe(new s.L((ue.x+.5)/Pt,(ue.y+.5)/Pt));Xe=Tt>.85?1:Tt}const ot=ve*ve+Ve*Ve+Ye,yt=Ie((1<<me-ue.zoom)*K*Xe*((Pt,Tt)=>{if(Tt*Ie(.707)<Pt)return 1;const It=Math.sqrt(Tt/Pt);return It/(1.4144271570014144+(Math.pow(1.1,It-1.4144271570014144+1)-1)/(1.1-1)-1)})(Math.max(Ye,Ue),ot));return ot<yt};if(this.renderWorldCopies)for(let ue=1;ue<=3;ue++)he.push(le(-ue)),he.push(le(ue));for(he.push(le(0));he.length>0;){const ue=he.pop(),ve=ue.x,Ve=ue.y;let Ye=ue.fullyVisible;const Xe=()=>this.projection.name==="globe"&&(ue.y===0||ue.y===(1<<ue.zoom)-1);if(!Ye){let ot=G?ue.aabb.intersects(R):ue.aabb.intersectsFlat(R);if(ot===0&&Xe()){const yt=new s.bs(ue.zoom,ve,Ve);ot=s.bt(this,M,yt,!0).intersects(R)}if(ot===0)continue;Ye=ot===2}if(ue.zoom!==me&&Ee(ue))for(let ot=0;ot<4;ot++){const yt=(ve<<1)+ot%2,Pt=(Ve<<1)+(ot>>1),Tt={aabb:g?ue.aabb.quadrant(ot):s.bu(this,M,ue.zoom+1,yt,Pt,ue.wrap,ue.minZ,ue.maxZ,this.projection),zoom:ue.zoom+1,x:yt,y:Pt,wrap:ue.wrap,fullyVisible:Ye,tileID:void 0,shouldSplit:void 0,minZ:ue.minZ,maxZ:ue.maxZ};p&&!S&&(Tt.tileID=new s.am(ue.zoom+1===me?Ae:ue.zoom+1,ue.wrap,ue.zoom+1,yt,Pt),ge(Tt)),he.push(Tt)}else{const ot=ue.zoom===me?Ae:ue.zoom;if(i.minzoom&&i.minzoom>ot)continue;if(!Ye){let It=G?ue.aabb.intersectsPrecise(R):ue.aabb.intersectsPreciseFlat(R);if(It===0&&Xe()){const Yt=new s.bs(ue.zoom,ve,Ve);It=s.bt(this,M,Yt,!0).intersectsPrecise(R)}if(It===0)continue}const yt=I[0]-(.5+ve+(ue.wrap<<ue.zoom))*(1<<o-ue.zoom),Pt=I[1]-.5-Ve,Tt=ue.tileID?ue.tileID:new s.am(ot,ue.wrap,ue.zoom,ve,Ve);we.push({tileID:Tt,distanceSq:yt*yt+Pt*Pt})}}if(this.fogCullDistSq){const ue=this.fogCullDistSq,ve=this.horizonLineFromTop();we=we.filter(Ve=>{const Ye=[0,0,0,1],Xe=[s.V,s.V,0,1],ot=this.calculateFogTileMatrix(Ve.tileID.toUnwrapped());s.a7.transformMat4(Ye,Ye,ot),s.a7.transformMat4(Xe,Xe,ot);const yt=s.a7.min([],Ye,Xe),Pt=s.a7.max([],Ye,Xe),Tt=s.bv(yt,Pt);if(Tt===0)return!0;let It=!1;const Yt=this._elevation;if(Yt&&Tt>ue&&ve!==0){const Vt=this.calculateProjMatrix(Ve.tileID.toUnwrapped());let qt;i.isTerrainDEM||(qt=Yt.getMinMaxForTile(Ve.tileID)),qt||(qt={min:j,max:J});const $t=s.bH(this.rotation),fr=[$t[0]*s.V,$t[1]*s.V,qt.max];s.N.transformMat4(fr,fr,Vt),It=(1-fr[1])*this.height*.5<ve}return Tt<ue||It})}return we.sort((ue,ve)=>ue.distanceSq-ve.distanceSq).map(ue=>ue.tileID)}resize(i,o){this.width=i,this.height=o,this.pixelsToGLUnits=[2/i,-2/o],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(i){return Math.pow(2,i)}scaleZoom(i){return Math.log(i)/Math.LN2}project(i){const o=s.aa(i.lat,-s.bw,s.bw),u=this.projection.project(i.lng,o);return new s.P(u.x*this.worldSize,u.y*this.worldSize)}unproject(i){return this.projection.unproject(i.x/this.worldSize,i.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/s.bl(1,this.center.lat)/this.worldSize}setLocationAtPoint(i,o){let u,d;const p=this.centerPoint;if(this.projection.name==="globe"){const v=this.worldSize;u=(o.x-p.x)/v,d=(o.y-p.y)/v}else{const v=this.pointCoordinate(o),w=this.pointCoordinate(p);u=v.x-w.x,d=v.y-w.y}const g=this.locationCoordinate(i);this.setLocation(new s.L(g.x-u,g.y-d))}setLocation(i){this.center=this.coordinateLocation(i),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(i){return this.projection.locationPoint(this,i)}locationPoint3D(i){return this.projection.locationPoint(this,i,!0)}pointLocation(i){return this.coordinateLocation(this.pointCoordinate(i))}pointLocation3D(i){return this.coordinateLocation(this.pointCoordinate3D(i))}locationCoordinate(i,o){const u=o?s.bl(o,i.lat):void 0,d=this.projection.project(i.lng,i.lat);return new s.L(d.x,d.y,u)}coordinateLocation(i){return this.projection.unproject(i.x,i.y)}pointRayIntersection(i,o){const u=o??this._centerAltitude,d=[i.x,i.y,0,1],p=[i.x,i.y,1,1];s.a7.transformMat4(d,d,this.pixelMatrixInverse),s.a7.transformMat4(p,p,this.pixelMatrixInverse);const g=p[3];s.a7.scale(d,d,1/d[3]),s.a7.scale(p,p,1/g);const v=d[2],w=p[2];return{p0:d,p1:p,t:v===w?0:(u-v)/(w-v)}}screenPointToMercatorRay(i){const o=[i.x,i.y,0,1],u=[i.x,i.y,1,1];return s.a7.transformMat4(o,o,this.pixelMatrixInverse),s.a7.transformMat4(u,u,this.pixelMatrixInverse),s.a7.scale(o,o,1/o[3]),s.a7.scale(u,u,1/u[3]),o[2]=s.bl(o[2],this._center.lat)*this.worldSize,u[2]=s.bl(u[2],this._center.lat)*this.worldSize,s.a7.scale(o,o,1/this.worldSize),s.a7.scale(u,u,1/this.worldSize),new s.a2([o[0],o[1],o[2]],s.N.normalize([],s.N.sub([],u,o)))}rayIntersectionCoordinate(i){const{p0:o,p1:u,t:d}=i,p=s.bl(o[2],this._center.lat),g=s.bl(u[2],this._center.lat);return new s.L(s.U(o[0],u[0],d)/this.worldSize,s.U(o[1],u[1],d)/this.worldSize,s.U(p,g,d))}pointCoordinate(i,o=this._centerAltitude){return this.projection.pointCoordinate(this,i.x,i.y,o)}pointCoordinate3D(i){if(!this.elevation)return this.pointCoordinate(i);let o=this.projection.pointCoordinate3D(this,i.x,i.y);if(o)return new s.L(o[0],o[1],o[2]);let u=0,d=this.horizonLineFromTop();if(i.y>d)return this.pointCoordinate(i);const p=.02*d,g=i.clone();for(let v=0;v<10&&d-u>p;v++){g.y=s.U(u,d,.66);const w=this.projection.pointCoordinate3D(this,g.x,g.y);w?(d=g.y,o=w):u=g.y}return o?new s.L(o[0],o[1],o[2]):this.pointCoordinate(i)}isPointAboveHorizon(i){return this.projection.isPointAboveHorizon(this,i)}isPointOnSurface(i){if(i.y<0||i.y>this.height||i.x<0||i.x>this.width)return!1;if(this.elevation||this.zoom>=s.bx)return!this.isPointAboveHorizon(i);const o=this.pointCoordinate(i);return o.y>=0&&o.y<=1}_coordinatePoint(i,o){const u=o&&this.elevation?this.elevation.getAtPointOrZero(i,this._centerAltitude):this._centerAltitude,d=[i.x*this.worldSize,i.y*this.worldSize,u+i.toAltitude(),1];return s.a7.transformMat4(d,d,this.pixelMatrix),d[3]>0?new s.P(d[0]/d[3],d[1]/d[3]):new s.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:i,left:o}=this._edgeInsets,u=this.height-this._edgeInsets.bottom,d=this.width-this._edgeInsets.right,p=this.pointLocation3D(new s.P(o,i)),g=this.pointLocation3D(new s.P(d,i)),v=this.pointLocation3D(new s.P(d,u)),w=this.pointLocation3D(new s.P(o,u));let M=Math.min(p.lng,g.lng,v.lng,w.lng),I=Math.max(p.lng,g.lng,v.lng,w.lng),S=Math.min(p.lat,g.lat,v.lat,w.lat),z=Math.max(p.lat,g.lat,v.lat,w.lat);const R=Math.pow(2,-this.zoom)/16*270,U=this.projection.name==="globe"?1:4,N=(V,B,G,K,q)=>{const J=(V+G)/2,j=(B+K)/2,Q=new s.P(J,j),{lng:oe,lat:le}=this.pointLocation3D(Q),he=Math.max(0,M-oe,S-le,oe-I,le-z);M=Math.min(M,oe),I=Math.max(I,oe),S=Math.min(S,le),z=Math.max(z,le),(q<U||he>R)&&(N(V,B,J,j,q+1),N(J,j,G,K,q+1))};if(N(o,i,d,i,1),N(d,i,d,u,1),N(d,u,o,u,1),N(o,u,o,i,1),this.projection.name==="globe"){const[V,B]=s.by(this);V?(z=90,I=180,M=-180):B&&(S=-90,I=180,M=-180)}return new s.ad(new s.bn(M,S),new s.bn(I,z))}_getBoundsRectangular(i,o){const{top:u,left:d}=this._edgeInsets,p=this.height-this._edgeInsets.bottom,g=this.width-this._edgeInsets.right,v=new s.P(d,u),w=new s.P(g,u),M=new s.P(g,p),I=new s.P(d,p);let S=this.pointCoordinate(v,i),z=this.pointCoordinate(w,i);const R=this.pointCoordinate(M,o),U=this.pointCoordinate(I,o),N=(V,B)=>(B.y-V.y)/(B.x-V.x);return S.y>1&&z.y>=0?S=new s.L((1-U.y)/N(U,S)+U.x,1):S.y<0&&z.y<=1&&(S=new s.L(-U.y/N(U,S)+U.x,0)),z.y>1&&S.y>=0?z=new s.L((1-R.y)/N(R,z)+R.x,1):z.y<0&&S.y<=1&&(z=new s.L(-R.y/N(R,z)+R.x,0)),new s.ad().extend(this.coordinateLocation(S)).extend(this.coordinateLocation(z)).extend(this.coordinateLocation(U)).extend(this.coordinateLocation(R))}_getBoundsRectangularTerrain(){const i=this.elevation;if(!i.visibleDemTiles.length||i.isUsingMockSource())return this._getBoundsRectangular(0,0);const o=i.visibleDemTiles.reduce((u,d)=>{if(d.dem){const p=d.dem.tree;u.min=Math.min(u.min,p.minimums[0]),u.max=Math.max(u.max,p.maximums[0])}return u},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(o.min*i.exaggeration(),o.max*i.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(i=!0){const o=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,u=this.height/2-o*(1-this._horizonShift);return i?Math.max(0,u):u}getMaxBounds(){return this.maxBounds}setMaxBounds(i){this.maxBounds=i,this.minLat=-s.bw,this.maxLat=s.bw,this.minLng=-180,this.maxLng=180,i&&(this.minLat=i.getSouth(),this.maxLat=i.getNorth(),this.minLng=i.getWest(),this.maxLng=i.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=s.a5(this.minLng)*this.tileSize,this.worldMaxX=s.a5(this.maxLng)*this.tileSize,this.worldMinY=s.ae(this.maxLat)*this.tileSize,this.worldMaxY=s.ae(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(i,o){return this.projection.createTileMatrix(this,o,i)}calculateDistanceTileData(i){const o=i.key,u=this._distanceTileDataCache;if(u[o])return u[o];const d=i.canonical,p=1/this.height,g=this.cameraWorldSize,v=g/this.zoomScale(d.z),w=(d.x+Math.pow(2,d.z)*i.wrap)*v,M=d.y*v,I=this.point;I.x*=g/this.worldSize,I.y*=g/this.worldSize;const S=this.angle,z=Math.sin(-S),R=-Math.cos(-S);return u[o]={bearing:[z,R],center:[(I.x-w)*p,(I.y-M)*p],scale:v/s.V*p},u[o]}calculateFogTileMatrix(i){const o=i.key,u=this._fogTileMatrixCache;if(u[o])return u[o];const d=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,i);return s.a6.multiply(d,this.worldToFogMatrix,d),u[o]=new Float32Array(d),u[o]}calculateProjMatrix(i,o=!1,u=!1){const d=i.key;let p;if(p=u?this._expandedProjMatrixCache:o?this._alignedProjMatrixCache:this._projMatrixCache,p[d])return p[d];const g=this.calculatePosMatrix(i,this.worldSize);let v;return v=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:u?this.expandedFarZProjMatrix:o?this.alignedProjMatrix:this.projMatrix,s.a6.multiply(g,v,g),p[d]=new Float32Array(g),p[d]}calculatePixelsToTileUnitsMatrix(i){const o=i.tileID.key,u=this._pixelsToTileUnitsCache;if(u[o])return u[o];const d=s.bz(i,this);return u[o]=d,u[o]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){const i=1/this.worldSize,o=s.a6.fromScaling([],[i,i,i]);return s.a6.multiply(o,o,this.globeMatrix),o}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;const i=this._elevation;this._updateCameraState();const o=s.bl(1,this._center.lat)*this.worldSize,u=this._computeCameraPosition(o),d=this._camera.forward(),p=s.bl(1,this._center.lat);u[2]/=p,d[2]/=p,s.N.normalize(d,d);const g=i.raycast(u,d,i.exaggeration());if(g){const v=s.N.scaleAndAdd([],u,d,g),w=new s.L(v[0],v[1],s.bl(v[2],s.au(v[1]))),M=(w.z+s.N.length([w.x-u[0],w.y-u[1],w.z-u[2]*p]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(M),this._centerAltitude=w.toAltitude(),this._center=this.coordinateLocation(w),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(i=!1){if(!this._elevation)return;const o=this._elevation,u=s.bl(1,this._center.lat)*this.worldSize,d=this._computeCameraPosition(u),p=o.getAtPointOrZero(new s.L(...d)),g=this.pixelsPerMeter/this.worldSize*p,v=this._minimumHeightOverTerrain(),w=d[2]-g;if(w<=v)if(w<0||i){const M=this.locationCoordinate(this._center,this._centerAltitude),I=[d[0],d[1],M.z-d[2]],S=s.N.length(I);I[2]-=(v-w)/this._pixelsPerMercatorPixel;const z=s.N.length(I);if(z===0)return;s.N.scale(I,I,S/z*this._pixelsPerMercatorPixel),this._camera.position=[d[0],d[1],M.z*this._pixelsPerMercatorPixel-I[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const i=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||i){const z=this.center;return z.lat=s.aa(z.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!i)&&(z.lng=s.aa(z.lng,this.minLng,this.maxLng)),this.center=z,void(this._constraining=!1)}const o=this._unmodified,{x:u,y:d}=this.point;let p=0,g=u,v=d;const w=this.width/2,M=this.height/2,I=this.worldMinY*this.scale,S=this.worldMaxY*this.scale;if(d-M<I&&(v=I+M),d+M>S&&(v=S-M),S-I<this.height&&(p=Math.max(p,this.height/(S-I)),v=(S+I)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const z=this.worldMinX*this.scale,R=this.worldMaxX*this.scale,U=this.worldSize/2-(z+R)/2;g=(u+U+this.worldSize)%this.worldSize-U,g-w<z&&(g=z+w),g+w>R&&(g=R-w),R-z<this.width&&(p=Math.max(p,this.width/(R-z)),g=(R+z)/2)}g===u&&v===d||(this.center=this.unproject(new s.P(g,v))),p&&(this.zoom+=this.scaleZoom(p)),this._constrainCamera(),this._unmodified=o,this._constraining=!1}_minZoomForBounds(){let i=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(i=Math.max(i,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),i}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const i=this.centerOffset,o=this.projection.name==="globe",u=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=s.bl(1,this.center.lat)/s.bl(1,s.bI));const d=s.bA(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,d),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const p=this.projection.zAxisUnit==="meters"?u:1,g=this._camera.getWorldToCamera(this.worldSize,p);let v;const w=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(w[8]=2*-i.x/this.width,w[9]=2*i.y/this.height,this.isOrthographic){let le=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),he=le*this.aspect,we=-he,me=-le;he-=i.x,we-=i.x,le+=i.y,me+=i.y,v=this._camera.getCameraToClipOrthographic(we,he,me,le,this._nearZ,this._farZ),((Ae,Ie,Ue,ge)=>{for(let Ee=0;Ee<16;Ee++)Ae[Ee]=Js(Ie[Ee],Ue[Ee],ge)})(v,v,w,Va(this.pitch>=15?1:this.pitch/15))}else v=w;const M=s.a6.mul([],w,g);let I=s.a6.mul([],v,g);if(this.projection.isReprojectedInTileSpace){const le=this.locationCoordinate(this.center),he=s.a6.identity([]);s.a6.translate(he,he,[le.x*this.worldSize,le.y*this.worldSize,0]),s.a6.multiply(he,he,s.bB(this)),s.a6.translate(he,he,[-le.x*this.worldSize,-le.y*this.worldSize,0]),s.a6.multiply(I,I,he),s.a6.multiply(M,M,he),this.inverseAdjustmentMatrix=s.bC(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=s.a6.scale([],I,[this.worldSize,this.worldSize,this.worldSize/p,1]),this.projMatrix=I,this.invProjMatrix=s.a6.invert(new Float64Array(16),this.projMatrix),o){const le=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);le[8]=2*-i.x/this.width,le[9]=2*i.y/this.height,this.expandedFarZProjMatrix=s.a6.mul([],le,g)}else this.expandedFarZProjMatrix=this.projMatrix;const S=s.a6.invert([],v);this.frustumCorners=s.bD.fromInvProjectionMatrix(S,this.horizonLineFromTop(),this.height),this.cameraFrustum=s.bq.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!o);const z=new Float32Array(16);s.a6.identity(z),s.a6.scale(z,z,[1,-1,1]),s.a6.rotateX(z,z,this._pitch),s.a6.rotateZ(z,z,this.angle);const R=s.a6.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=s.a6.clone(R);const U=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;R[8]=2*-i.x/this.width,R[9]=2*(i.y+U)/this.height,this.skyboxMatrix=s.a6.multiply(z,R,z);const N=this.point,V=N.x,B=N.y,G=this.width%2/2,K=this.height%2/2,q=Math.cos(this.angle),J=Math.sin(this.angle),j=V-Math.round(V)+q*G+J*K,Q=B-Math.round(B)+q*K+J*G,oe=new Float64Array(I);if(s.a6.translate(oe,oe,[j>.5?j-1:j,Q>.5?Q-1:Q,0]),this.alignedProjMatrix=oe,I=s.a6.create(),s.a6.scale(I,I,[this.width/2,-this.height/2,1]),s.a6.translate(I,I,[1,-1,0]),this.labelPlaneMatrix=I,I=s.a6.create(),s.a6.scale(I,I,[1,-1,1]),s.a6.translate(I,I,[-1,-1,0]),s.a6.scale(I,I,[2/this.width,2/this.height,1]),this.glCoordMatrix=I,this.pixelMatrix=s.a6.multiply(new Float64Array(16),this.labelPlaneMatrix,M),this._calcFogMatrices(),this._distanceTileDataCache={},I=s.a6.invert(new Float64Array(16),this.pixelMatrix),!I)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=I,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=s.bE(this);const le=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=s.N.transformMat4(le,le,g),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=I;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const i=this.cameraWorldSizeForFog,o=this.cameraPixelsPerMeter,u=this._camera.position,d=1/this.height/this._pixelsPerMercatorPixel,p=[i,i,o];s.N.scale(p,p,d),s.N.scale(u,u,-1),s.N.multiply(u,u,p);const g=s.a6.create();s.a6.translate(g,g,u),s.a6.scale(g,g,p),this.mercatorFogMatrix=g,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(i,o,d)}_computeCameraPosition(i){const o=(i=i||this.pixelsPerMeter)/this.pixelsPerMeter,u=this._camera.forward(),d=this.point,p=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*o-i/this.worldSize*this._centerAltitude;return[d.x/this.worldSize-u[0]*p,d.y/this.worldSize-u[1]*p,i/this.worldSize*this._centerAltitude-u[2]*p]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(i){const o=this._maxCameraBoundsDistance()*Math.cos(this._pitch),u=this._camera.position[2],d=i[2];let p=1;this.projection.wrap&&(this.center=this.center.wrap()),d>0&&(p=Math.min((o-u)/d,1)),this._camera.position=s.N.scaleAndAdd([],this._camera.position,i,p),this._updateStateFromCamera()}_updateStateFromCamera(){const i=this._camera.position,o=this._camera.forward(),{pitch:u,bearing:d}=this._camera.getPitchBearing(),p=s.bl(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,g=this._mercatorZfromZoom(this._maxZoom)*Math.cos(s.bj(this._maxPitch)),v=Math.max((i[2]-p)/Math.cos(u),g),w=this._zoomFromMercatorZ(v);s.N.scaleAndAdd(i,i,o,v),this._pitch=s.aa(u,s.bj(this.minPitch),s.bj(this.maxPitch)),this.angle=s.bh(d,-Math.PI,Math.PI),this._setZoom(s.aa(w,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new s.L(i[0],i[1],i[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(i){return Math.pow(2,i)*this.tileSize}_mercatorZfromZoom(i){return this.cameraToCenterDistance/this._worldSizeFromZoom(i)}_minimumHeightOverTerrain(){const i=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(i)}_zoomFromMercatorZ(i){return this.scaleZoom(this.cameraToCenterDistance/(i*this.tileSize))}zoomFromMercatorZAdjusted(i){let o=0,u=s.bx,d=0,p=1/0;for(;u-o>1e-6&&u>o;){const g=o+.5*(u-o),v=this.tileSize*Math.pow(2,g),w=this.getCameraToCenterDistance(this.projection,g,v),M=this.scaleZoom(w/(i*this.tileSize)),I=Math.abs(g-M);I<p&&(p=I,d=g),g<M?o=g:u=g}return d}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(s.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(i,o){const u=Math.min(i.x,o.x),d=Math.max(i.x,o.x),p=Math.min(i.y,o.y),g=Math.max(i.y,o.y);if(p<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const v=[new s.P(u,p),new s.P(d,g),new s.P(u,g),new s.P(d,p)],w=this.renderWorldCopies?-3:0,M=this.renderWorldCopies?4:1;for(const I of v){const S=this.pointRayIntersection(I);if(S.t<0)return!0;const z=this.rayIntersectionCoordinate(S);if(z.x<w||z.y<0||z.x>M||z.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+s.bF(this.fovAboveCenter)>88||this.anyCornerOffEdge(new s.P(0,0),new s.P(this.width,this.height))}zoomDeltaToMovement(i,o){const u=s.N.length(s.N.sub([],this._camera.position,i)),d=this._zoomFromMercatorZ(u)+o;return u-this._mercatorZfromZoom(d)}getCameraPoint(){if(this.projection.name==="globe"){const i=function([o,u,d],p){const g=[o,u,d,1];s.a7.transformMat4(g,g,p);const v=g[3]=Math.max(g[3],1e-6);return g[0]/=v,g[1]/=v,g[2]/=v,g}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new s.P(i[0],i[1])}{const i=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new s.P(0,i))}}getCameraToCenterDistance(i,o=this.zoom,u=this.worldSize){const d=s.bA(i,o,this.width,this.height,1024),p=i.pixelSpaceConversion(this.center.lat,u,d);let g=.5/Math.tan(.5*this._fov)*this.height*p;return this.isOrthographic&&(g=Js(1,g,Va(this.pitch>=15?1:this.pitch/15))),g}getWorldToCameraMatrix(){const i=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&s.a6.multiply(i,i,this.globeMatrix),i}getFrustum(i){return s.bq.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,i,this.projection.zAxisUnit==="meters")}}const ji={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,ShadowMap0:10},Zo=(c,i)=>{if(i>0&&c.terrain&&s.w("Cutoff is currently disabled on terrain"),i<=0||c.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const o=c.transform,u=Math.max(Math.abs(o._zoom-(c.minCutoffZoom-1)),1),d=o.isLODDisabled(!1)?s.O(60,45,o.pitch):s.O(30,15,o.pitch),p=o._farZ-o._nearZ,g=i*o.height,v=((1-(w=d))*o.cameraToCenterDistance+w*(o._farZ+g))*u;var w;return{shouldRenderCutoff:d<1,uniformValues:{u_cutoff_params:[o._nearZ,o._farZ,(v-o._nearZ)/p,(v-g-o._nearZ)/p]}}},Qi={cascadeCount:2,shadowMapResolution:2048};class xu{constructor(i,o){this.aabb=i,this.lastCascade=o}}class xd{add(i,o){const u=this.receivers[i.key];u!==void 0?(u.aabb.min[0]=Math.min(u.aabb.min[0],o.min[0]),u.aabb.min[1]=Math.min(u.aabb.min[1],o.min[1]),u.aabb.min[2]=Math.min(u.aabb.min[2],o.min[2]),u.aabb.max[0]=Math.max(u.aabb.max[0],o.max[0]),u.aabb.max[1]=Math.max(u.aabb.max[1],o.max[1]),u.aabb.max[2]=Math.max(u.aabb.max[2],o.max[2])):this.receivers[i.key]=new xu(o,null)}clear(){this.receivers={}}get(i){return this.receivers[i.key]}computeRequiredCascades(i,o,u){const d=s.bS.fromPoints(i.points);let p=0;for(const g in this.receivers){const v=this.receivers[g];if(!v||!d.intersectsAabb(v.aabb))continue;v.aabb.min=d.closestPoint(v.aabb.min),v.aabb.max=d.closestPoint(v.aabb.max);const w=v.aabb.getCorners();for(let M=0;M<u.length;M++){let I=!0;for(const S of w){const z=[S[0]*o,S[1]*o,S[2]];if(s.N.transformMat4(z,z,u[M].matrix),z[0]<-1||z[0]>1||z[1]<-1||z[1]>1){I=!1;break}}if(v.lastCascade=M,p=Math.max(p,M),I)break}}return p+1}}class vu{constructor(i){this.painter=i,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new xd,this._depthMode=new zt(i.context.gl.LEQUAL,zt.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this.useNormalOffset=!1,i.tp.registerParameter(Qi,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),i.tp.registerParameter(Qi,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32})}destroy(){for(const i of this._cascades)i.texture.destroy(),i.framebuffer.destroy();this._cascades=[]}updateShadowParameters(i,o){const u=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!o||!o.properties)return;const d=o.properties.get("shadow-intensity");if(!o.shadowsEnabled()||d<=0||(this._shadowLayerCount=u.style.order.reduce((U,N)=>{const V=u.style._mergedLayers[N];return U+(V.hasShadowPass()&&!V.isHidden(i.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this._enabled))return;const p=u.context,g=Qi.shadowMapResolution,v=Qi.shadowMapResolution;if(this._cascades.length===0||Qi.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let U=0;U<Qi.cascadeCount;++U){const N=u._shadowMapDebug,V=p.gl,B=p.createFramebuffer(g,v,N,"texture"),G=new s.T(p,{width:g,height:v,data:null},V.DEPTH_COMPONENT);if(B.depthAttachment.set(G.texture),N){const K=new s.T(p,{width:g,height:v,data:null},V.RGBA);B.colorAttachment.set(K.texture)}this._cascades.push({framebuffer:B,texture:G,matrix:[],far:0,boundingSphereRadius:0,frustum:new s.bq,scale:0})}}this.shadowDirection=Wl(o);let w=0;if(i.elevation){const U=i.elevation,N=[1e4,-1e4];U.visibleDemTiles.filter(V=>V.dem).forEach(V=>{const B=V.dem.tree;N[0]=Math.min(N[0],B.minimums[0]),N[1]=Math.max(N[1],B.maximums[0])}),N[0]!==1e4&&(w=(N[1]-N[0])*U.exaggeration())}const M=1.5*i.cameraToCenterDistance,I=3*M,S=new Float64Array(16);for(let U=0;U<this._cascades.length;++U){const N=this._cascades[U];let V=i.height/50,B=1;Qi.cascadeCount===1?B=I:U===0?B=M:(V=M,B=I);const[G,K]=vd(i,this.shadowDirection,V,B,Qi.shadowMapResolution,w);N.scale=i.scale,N.matrix=G,N.boundingSphereRadius=K,s.a6.invert(S,N.matrix),N.frustum=s.bq.fromInvProjectionMatrix(S,1,0,!0),N.far=B}const z=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[z].far,this._cascades[z].far],this._uniformValues.u_shadow_intensity=d,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/Qi.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=Qi.shadowMapResolution,this._uniformValues.u_shadowmap_0=ji.ShadowMap0,this._uniformValues.u_shadowmap_1=ji.ShadowMap0+1,this._groundShadowTiles=u.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const R=u.transform.elevation;for(const U of this._groundShadowTiles){let N={min:0,max:0};if(R){const V=R.getMinMaxForTile(U);V&&(N=V)}this.addShadowReceiver(U.toUnwrapped(),N.min,N.max)}}get enabled(){return this._enabled}set enabled(i){this._enabled=i}drawShadowPass(i,o){if(!this._enabled)return;const u=this.painter,d=u.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(u.transform.getFrustum(0),u.transform.worldSize,this._cascades),d.viewport.set([0,0,Qi.shadowMapResolution,Qi.shadowMapResolution]);for(let p=0;p<this._numCascadesToRender;++p){u.currentShadowCascade=p,d.bindFramebuffer.set(this._cascades[p].framebuffer.framebuffer),d.clear({color:s.ax.white,depth:1});for(const g of i.order){const v=i._mergedLayers[g];if(!v.hasShadowPass()||v.isHidden(u.transform.zoom))continue;const w=i.getLayerSourceCache(v),M=w?o[w.id]:void 0;(v.type==="model"||M&&M.length)&&u.renderLayer(u,w,v,M)}}u.currentShadowCascade=0}drawGroundShadows(){if(!this._enabled)return;const i=this.painter,o=i.style,u=i.context,d=o.directionalLight,p=o.ambientLight;if(!d||!p)return;const g=[],v=Zo(i,i.longestCutoffRange);v.shouldRenderCutoff&&g.push("RENDER_CUTOFF");const w=Za(d,p),M=new zt(u.gl.LEQUAL,zt.ReadOnly,i.depthRangeFor3D);for(const I of this._groundShadowTiles){const S=I.toUnwrapped(),z=i.isTileAffectedByFog(I),R=i.getOrCreateProgram("groundShadow",{defines:g,overrideFog:z});this.setupShadows(S,R),i.uploadCommonUniforms(u,R,S,null,v);const U={u_matrix:i.transform.calculateProjMatrix(S),u_ground_shadow_factor:w};R.draw(i,u.gl.TRIANGLES,M,jt.disabled,rr.multiply,Rt.disabled,U,"ground_shadow",i.tileExtentBuffer,i.quadTriangleIndexBuffer,i.tileExtentSegments,{},i.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?rr.unblended:rr.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(i){const o=this.painter.transform,u=o.calculatePosMatrix(i,o.worldSize);return s.a6.multiply(u,this._cascades[this.painter.currentShadowCascade].matrix,u),Float32Array.from(u)}calculateShadowPassMatrixFromMatrix(i){return s.a6.multiply(i,this._cascades[this.painter.currentShadowCascade].matrix,i),Float32Array.from(i)}setupShadows(i,o,u,d=0){if(!this._enabled)return;const p=this.painter.transform,g=this.painter.context,v=g.gl,w=this._uniformValues,M=new Float64Array(16),I=p.calculatePosMatrix(i,p.worldSize);for(let S=0;S<this._cascades.length;S++)s.a6.multiply(M,this._cascades[S].matrix,I),w[S===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(M),g.activeTexture.set(v.TEXTURE0+ji.ShadowMap0+S),this._cascades[S].texture.bind(v.NEAREST,v.CLAMP_TO_EDGE);if(this.useNormalOffset=!!u,this.useNormalOffset){const S=s.bR(i.canonical),z=2/p.tileSize*s.V/Qi.shadowMapResolution,R=z*this._cascades[0].boundingSphereRadius,U=z*this._cascades[this._cascades.length-1].boundingSphereRadius,N=(u==="vector-tile"?1:3)/Math.pow(2,d-i.canonical.z-(1-p.zoom+Math.floor(p.zoom)));w.u_shadow_normal_offset=[S,R*N,U*N],w.u_shadow_bias=[6e-5,.0012,.012]}else w.u_shadow_bias=[36e-5,.0012,.012];o.setShadowUniformValues(g,w)}setupShadowsFromMatrix(i,o,u=!1){if(!this._enabled)return;const d=this.painter.context,p=d.gl,g=this._uniformValues,v=new Float64Array(16);for(let w=0;w<Qi.cascadeCount;w++)s.a6.multiply(v,this._cascades[w].matrix,i),g[w===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(v),d.activeTexture.set(p.TEXTURE0+ji.ShadowMap0+w),this._cascades[w].texture.bind(p.NEAREST,p.CLAMP_TO_EDGE);this.useNormalOffset=u,u?(g.u_shadow_normal_offset=[1,5,5],g.u_shadow_bias=[6e-5,.0012,.012]):g.u_shadow_bias=[36e-5,.0012,.012],o.setShadowUniformValues(d,g)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(i,o,u,d){if(d[2]>=0)return{};const p=function(w,M,I){const S=I/(1<<w.canonical.z);return new s.bS([w.canonical.x*S+w.wrap*I,w.canonical.y*S+w.wrap*I,0],[(w.canonical.x+1)*S+w.wrap*I,(w.canonical.y+1)*S+w.wrap*I,M])}(i,o,u).getCorners(),g=o/-d[2];d[0]<0?(s.N.add(p[0],p[0],[d[0]*g,0,0]),s.N.add(p[3],p[3],[d[0]*g,0,0])):d[0]>0&&(s.N.add(p[1],p[1],[d[0]*g,0,0]),s.N.add(p[2],p[2],[d[0]*g,0,0])),d[1]<0?(s.N.add(p[0],p[0],[0,d[1]*g,0]),s.N.add(p[1],p[1],[0,d[1]*g,0])):d[1]>0&&(s.N.add(p[2],p[2],[0,d[1]*g,0]),s.N.add(p[3],p[3],[0,d[1]*g,0]));const v={};return v.vertices=p,v.planes=[xs(p[1],p[0],p[4]),xs(p[2],p[1],p[5]),xs(p[3],p[2],p[6]),xs(p[0],p[3],p[7])],v}addShadowReceiver(i,o,u){this._receivers.add(i,s.bS.fromTileIdAndHeight(i,o,u))}getMaxCascadeForTile(i){const o=this._receivers.get(i);return o&&o.lastCascade?o.lastCascade:0}}function xs(c,i,o){const u=s.N.sub([],o,i),d=s.N.sub([],c,i),p=s.N.cross([],u,d),g=s.N.length(p);return g===0?[0,0,1,0]:(s.N.scale(p,p,1/g),[p[0],p[1],p[2],-s.N.dot(p,i)])}function Wl(c){const i=c.properties.get("direction"),o=s.bQ(i.x,i.y,i.z);o[2]=s.aa(o[2],0,75);const u=s.bT([o[0],o[1],o[2]]);return s.N.fromValues(u.x,u.y,u.z)}function Za(c,i){const o=c.properties.get("color"),u=c.properties.get("intensity"),d=c.properties.get("direction"),p=[d.x,d.y,d.z],g=i.properties.get("color"),v=i.properties.get("intensity"),w=Math.max(s.N.dot([0,0,1],p),0),M=[0,0,0];s.N.scale(M,g.toArray01Linear().slice(0,3),v);const I=[0,0,0];return s.N.scale(I,o.toArray01Linear().slice(0,3),w*u),s.bU([M[0]>0?M[0]/(M[0]+I[0]):0,M[1]>0?M[1]/(M[1]+I[1]):0,M[2]>0?M[2]/(M[2]+I[2]):0])}function vd(c,i,o,u,d,p){const g=c.zoom,v=c.scale,w=c.worldSize,M=1/w,I=c.aspect,S=Math.sqrt(1+I*I)*Math.tan(.5*c.fovX),z=S*S,R=u-o,U=u+o;let N,V;z>R/U?(N=u,V=u*S):(N=.5*U*(1+z),V=.5*Math.sqrt(R*R+2*(u*u+o*o)*z+U*U*z*z));const B=c.projection.pixelsPerMeter(c.center.lat,w),G=c._camera.getCameraToWorldMercator(),K=[0,0,-N*M];s.N.transformMat4(K,K,G);let q=V*M;const J=c._edgeInsets;if(!(J.left===0&&J.top===0&&J.right===0&&J.bottom===0||J.left===J.right&&J.top===J.bottom)){const Ye=c._camera.getWorldToCamera(c.worldSize,c.projection.zAxisUnit==="meters"?B:1),Xe=c._camera.getCameraToClipPerspective(c._fov,c.width/c.height,o,u);Xe[8]=2*-c.centerOffset.x/c.width,Xe[9]=2*c.centerOffset.y/c.height;const ot=new Float64Array(16);s.a6.mul(ot,Xe,Ye);const yt=new Float64Array(16);s.a6.invert(yt,ot);const Pt=s.bq.fromInvProjectionMatrix(yt,w,g,!0);for(const Tt of Pt.points){const It=((j=Tt)[0]/=v,j[1]/=v,j[2]=s.bl(j[2],c._center.lat),j);q=Math.max(q,s.N.len(s.N.subtract([],K,It)))}}var j;q*=d/(d-1);const Q=Math.acos(i[2]),oe=Math.atan2(-i[0],-i[1]),le=new Ks;le.position=K,le.setPitchBearing(Q,oe);const he=le.getWorldToCamera(w,B),we=q*w,me=Math.min(c._mercatorZfromZoom(17)*w*-2,-2*we),Ae=le.getCameraToClipOrthographic(-we,we,-we,we,me,(we+p*B)/i[2]),Ie=new Float64Array(16);s.a6.multiply(Ie,Ae,he);const Ue=s.N.fromValues(Math.floor(1e6*K[0])/1e6*w,Math.floor(1e6*K[1])/1e6*w,0),ge=.5*d,Ee=[0,0,0];s.N.transformMat4(Ee,Ue,Ie),s.N.scale(Ee,Ee,ge);const ue=[Math.floor(Ee[0]),Math.floor(Ee[1]),Math.floor(Ee[2])],ve=[0,0,0];s.N.sub(ve,Ee,ue),s.N.scale(ve,ve,-1/ge);const Ve=new Float64Array(16);return s.a6.identity(Ve),s.a6.translate(Ve,Ve,ve),s.a6.multiply(Ie,Ve,Ie),[Ie,we]}const Go=(c,i)=>wt(c,i&&i.filter(o=>o.identifier!=="source.canvas")),bd=s.ac(dr,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection","setCamera","addImport","removeImport","updateImport"]),Qs=s.ac(dr,["setCenter","setZoom","setBearing","setPitch"]),bu={version:8,layers:[],sources:{}},wd={duration:300,delay:0},Gp=new Set(["fill","line","background","hillshade","raster"]);class Zn extends s.E{constructor(i,o={}){super(),this.map=i,this.scope=o.scope||"",this.fragments=[],this.importDepth=o.importDepth||0,this.importsCache=o.importsCache||new Map,this.resolvedImports=o.resolvedImports||new Set,this.transition=s.e({},wd),this._buildingIndex=new dd(this),this.crossTileSymbolIndex=new gu,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=o.styleChanges||new qr,this.dispatcher=o.dispatcher?o.dispatcher:new s.bW(s.bX(),this),o.imageManager?this.imageManager=o.imageManager:(this.imageManager=new Sr,this.imageManager.setEventedParent(this)),this.imageManager.createScope(this.scope),this.glyphManager=o.glyphManager?o.glyphManager:new s.bY(i._requestManager,o.localFontFamily?s.bZ.all:o.localIdeographFontFamily?s.bZ.ideographs:s.bZ.none,o.localFontFamily||o.localIdeographFontFamily),o.modelManager?this.modelManager=o.modelManager:(this.modelManager=new Gt(i._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._order=[],this._markersNeedUpdate=!1,this.options=o.configOptions?o.configOptions:new Map,this._configDependentLayers=o.configDependentLayers?o.configDependentLayers:new Set,this._config=o.config,this.dispatcher.broadcast("setReferrer",s.b_());const u=this;this._rtlTextPluginCallback=Zn.registerForPluginStateChange(d=>{u.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:d.pluginStatus,pluginURL:d.pluginURL},(p,g)=>{if(s.b$(p),g&&g.every(v=>v))for(const v in u._sourceCaches){const w=u._sourceCaches[v],M=w.getSource().type;M!=="vector"&&M!=="geojson"||w.reload()}})}),this.on("data",d=>{if(d.dataType!=="source"||d.sourceDataType!=="metadata")return;const p=this.getOwnSource(d.sourceId);if(p&&p.vectorLayerIds)for(const g in this._layers){const v=this._layers[g];v.source===p.id&&this._validateLayer(v)}})}loadURL(i,o={}){this.fire(new s.b("dataloading",{dataType:"style"}));const u=typeof o.validate=="boolean"?o.validate:!s.c0(i);i=this.map._requestManager.normalizeStyleURL(i,o.accessToken),this.resolvedImports.add(i);const d=this.importsCache.get(i);if(d)return this._load(d,u);const p=this.map._requestManager.transformRequest(i,s.R.Style);this._request=s.g(p,(g,v)=>{if(this._request=null,g)this.fire(new s.a(g));else if(v)return this.importsCache.set(i,v),this._load(v,u)})}loadJSON(i,o={}){this.fire(new s.b("dataloading",{dataType:"style"})),this._request=s.f.frame(()=>{this._request=null,this._load(i,o.validate!==!1)})}loadEmpty(){this.fire(new s.b("dataloading",{dataType:"style"})),this._load(bu,!1)}_loadImports(i,o,u){if(this.importDepth>=4)return s.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const d=[];for(const p of i){const g=this._createFragmentStyle(p),v=new Promise(I=>{g.once("style.import.load",I),g.once("error",I)}).then(()=>this.mergeAll());if(d.push(v),this.resolvedImports.has(p.url)){g.loadEmpty();continue}const w=p.data||this.importsCache.get(p.url);w?g.loadJSON(w,{validate:o}):p.url?g.loadURL(p.url,{validate:o}):g.loadEmpty();const M={style:g,id:p.id,config:p.config};if(u){const I=this.fragments.findIndex(({id:S})=>S===u);this.fragments=this.fragments.slice(0,I).concat(M).concat(this.fragments.slice(I))}else this.fragments.push(M)}return Promise.allSettled(d)}_createFragmentStyle(i){const o=this.scope?s.ag(i.id,this.scope):i.id,u=new Zn(this.map,{scope:o,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:i.config,configOptions:this.options,configDependentLayers:this._configDependentLayers});return u.setEventedParent(this.map,{style:u}),u}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options});const i=this.isRootStyle();this._shouldPrecompile=i,this.fire(new s.b(i?"style.load":"style.import.load"))}_load(i,o){const u=i.schema;if(this.isRootStyle()&&(i.fragment||u&&i.fragment!==!1)){const g=s.e({},bu,{imports:[{id:"basemap",data:i,url:""}]});return void this._load(g,o)}if(this.setConfig(this._config,u),o&&Go(this,In(i)))return;this._loaded=!0,this.stylesheet=s.c1(i);for(const g in i.sources)this.addSource(g,i.sources[g],{validate:!1,isInitialLoad:!0});i.sprite?this._loadSprite(i.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.glyphManager.setURL(i.glyphs,this.scope);const d=fd(this.stylesheet.layers);if(this._order=d.map(g=>g.id),this.stylesheet.light&&s.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){const g=this.stylesheet.lights[0];this.light=new Et(g.properties,g.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new Et(this.stylesheet.light)),this._layers={},this._serializedLayers={};for(const g of d){const v=s.c2(g,this.scope,this.options);v.isConfigDependent&&this._configDependentLayers.add(v.fqid),v.setEventedParent(this,{layer:{id:v.id}}),this._layers[v.id]=v,this._serializedLayers[v.id]=v.serialize();const w=this.getOwnLayerSourceCache(v),M=!!this.directionalLight&&this.directionalLight.shadowsEnabled();w&&v.canCastShadows()&&M&&(w.castsShadows=!0)}this.stylesheet.models&&this.modelManager.addModels(this.stylesheet.models,this.scope);const p=this.stylesheet.terrain;p&&(this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=s.f.hasCanvasFingerprintNoise()),this.disableElevatedTerrain?s.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."):this.terrainSetForDrapingOnly()||this._createTerrain(p,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new s.b("data",{dataType:"style"})),i.imports?this._loadImports(i.imports,o).then(()=>this._reloadImports()):this._reloadImports()}isRootStyle(){return this.importDepth===0}mergeAll(){let i,o,u,d,p,g,v,w;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(M=>{if(M.stylesheet){if(M.light!=null&&(i=M.light),M.stylesheet.lights)for(const I of M.stylesheet.lights)I.type==="ambient"&&M.ambientLight!=null&&(o=M.ambientLight),I.type==="directional"&&M.directionalLight!=null&&(u=M.directionalLight);d=this._prioritizeTerrain(d,M.terrain,M.stylesheet.terrain),M.stylesheet.fog&&M.fog!=null&&(p=M.fog),M.stylesheet.camera!=null&&(w=M.stylesheet.camera),M.stylesheet.projection!=null&&(g=M.stylesheet.projection),M.stylesheet.transition!=null&&(v=M.stylesheet.transition)}}),this.light=i,this.ambientLight=o,this.directionalLight=u,this.fog=p,d===null?delete this.terrain:this.terrain=d,this.camera=w||{"camera-projection":"perspective"},this.projection=g||{name:"mercator"},this.transition=s.e({},wd,v),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(i){const o=u=>{for(const d of u.fragments)o(d.style);i(u)};o(this)}_prioritizeTerrain(i,o,u){const d=i&&i.drapeRenderMode===0;return u===null?o&&o.drapeRenderMode===0?o:d?i:null:o!=null&&(!i||d||o&&o.drapeRenderMode===1)?o:i}mergeTerrain(){let i;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(o=>{i=this._prioritizeTerrain(i,o.terrain,o.stylesheet.terrain)}),i===null?delete this.terrain:this.terrain=i}mergeProjection(){let i;this.forEachFragmentStyle(o=>{o.stylesheet.projection!=null&&(i=o.stylesheet.projection)}),this.projection=i||{name:"mercator"}}mergeSources(){const i={},o={},u={};this.forEachFragmentStyle(d=>{for(const p in d._sourceCaches){const g=s.ag(p,d.scope);i[g]=d._sourceCaches[p]}for(const p in d._otherSourceCaches){const g=s.ag(p,d.scope);o[g]=d._otherSourceCaches[p]}for(const p in d._symbolSourceCaches){const g=s.ag(p,d.scope);u[g]=d._symbolSourceCaches[p]}}),this._mergedSourceCaches=i,this._mergedOtherSourceCaches=o,this._mergedSymbolSourceCaches=u}mergeLayers(){const i={},o=[],u={};this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(p=>{for(const g of p._order){const v=p._layers[g];if(v.type==="slot"){const w=s.c3(g);if(i[w])continue;i[w]=[]}v.slot&&i[v.slot]?i[v.slot].push(v):o.push(v)}}),this._mergedOrder=[];const d=(p=[])=>{for(const g of p)if(g.type==="slot"){const v=s.c3(g.id);i[v]&&d(i[v])}else{const v=s.ag(g.id,g.scope);this._mergedOrder.push(v),u[v]=g,g.is3D()&&(this._has3DLayers=!0),g.type==="circle"&&(this._hasCircleLayers=!0),g.type==="symbol"&&(this._hasSymbolLayers=!0)}};d(o),this._mergedLayers=u,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(i){return this.stylesheet.camera=s.e({},this.stylesheet.camera,i),this.camera=this.stylesheet.camera,this}setProjection(i){i?this.stylesheet.projection=i:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(i){this._spriteRequest=function(o,u,d){let p,g,v;const w=s.f.devicePixelRatio>1?"@2x":"";let M=s.g(u.transformRequest(u.normalizeSpriteURL(o,w,".json"),s.R.SpriteJSON),(z,R)=>{M=null,v||(v=z,p=R,S())}),I=s.d(u.transformRequest(u.normalizeSpriteURL(o,w,".png"),s.R.SpriteImage),(z,R)=>{I=null,v||(v=z,g=R,S())});function S(){if(v)d(v);else if(p&&g){const z=s.f.getImageData(g),R={};for(const U in p){const{width:N,height:V,x:B,y:G,sdf:K,pixelRatio:q,stretchX:J,stretchY:j,content:Q}=p[U],oe=new s.h({width:N,height:V});s.h.copy(z,oe,{x:B,y:G},{x:0,y:0},{width:N,height:V}),R[U]={data:oe,pixelRatio:q,sdf:K,stretchX:J,stretchY:j,content:Q}}d(null,R)}}return{cancel(){M&&(M.cancel(),M=null),I&&(I.cancel(),I=null)}}}(i,this.map._requestManager,(o,u)=>{if(this._spriteRequest=null,o)this.fire(new s.a(o));else if(u)for(const d in u)this.imageManager.addImage(d,this.scope,u[d]);this.imageManager.setLoaded(!0,this.scope),this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new s.b("data",{dataType:"style"}))})}_validateLayer(i){const o=this.getOwnSource(i.source);if(!o)return;const u=i.sourceLayer;u&&(o.type==="geojson"||o.vectorLayerIds&&o.vectorLayerIds.indexOf(u)===-1)&&this.fire(new s.a(new Error(`Source layer "${u}" does not exist on source "${o.id}" as specified by style layer "${i.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const i in this._sourceCaches)if(!this._sourceCaches[i].loaded())return!1;if(!this.imageManager.isLoaded()||!this.modelManager.isLoaded())return!1;for(const{style:i}of this.fragments)if(!i.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((i,o)=>{const u=this.fragments[o];return u&&u.style&&(i.data=u.style.serialize()),i})}_serializeSources(){const i={};for(const o in this._sourceCaches){const u=this._sourceCaches[o].getSource();i[u.id]||(i[u.id]=u.serialize())}return i}_serializeLayers(i){const o=[];for(const u of i){const d=this._layers[u];d&&d.type!=="custom"&&o.push(d.serialize())}return o}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition())return!0;for(const i in this._sourceCaches)if(this._sourceCaches[i].hasTransition())return!0;for(const i in this._layers)if(this._layers[i].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}isLayerDraped(i){return!!this.terrain&&(typeof i.isLayerDraped=="function"?i.isLayerDraped(this.getLayerSourceCache(i)):Gp.has(i.type))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(i){const o=this.getOwnLayer(i);if(o)return o;this.fire(new s.a(new Error(`The layer '${i}' does not exist in the map's style.`)))}_checkSource(i){const o=this.getOwnSource(i);if(o)return o;this.fire(new s.a(new Error(`The source '${i}' does not exist in the map's style.`)))}update(i){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(i),this.directionalLight&&this.directionalLight.recalculate(i);const o=this.calculateLightsBrightness();i.brightness=o||0,o!==this._brightness&&(this._brightness=o,this.dispatcher.broadcast("setBrightness",o));const u=this._changes.isDirty();if(this._changes.isDirty()){const p=this._changes.getLayerUpdatesByScope();for(const g in p){const{updatedIds:v,removedIds:w}=p[g];(v||w)&&this._updateWorkerLayers(g,v,w)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(i),this.light&&this.light.updateTransitions(i),this.ambientLight&&this.ambientLight.updateTransitions(i),this.directionalLight&&this.directionalLight.updateTransitions(i),this.fog&&this.fog.updateTransitions(i),this._changes.reset()}const d={};for(const p in this._mergedSourceCaches){const g=this._mergedSourceCaches[p];d[p]=g.used,g.used=!1,g.tileCoverLift=0}for(const p of this._mergedOrder){const g=this._mergedLayers[p];if(g.recalculate(i,this._availableImages),!g.isHidden(i.zoom)){const v=this.getLayerSourceCache(g);v&&(v.used=!0,v.tileCoverLift=Math.max(v.tileCoverLift,g.tileCoverLift()))}if(!this._precompileDone&&this._shouldPrecompile)for(let v=g.minzoom||0;v<(g.maxzoom||25.5);v++){const w=this.map.painter;if(w){const M=g.getProgramIds();if(!M)continue;for(const I of M){const S=g.getDefaultProgramParams(I,i.zoom);S&&(w.style=this,this.fog&&(w._fogVisible=!0,S.overrideFog=!0,w.getOrCreateProgram(I,S)),w._fogVisible=!1,S.overrideFog=!1,w.getOrCreateProgram(I,S),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(S.overrideRtt=!0,w.getOrCreateProgram(I,S)))}}}}this._shouldPrecompile&&(this._precompileDone=!0);for(const p in d){const g=this._mergedSourceCaches[p];d[p]!==g.used&&g.getSource().fire(new s.b("data",{sourceDataType:"visibility",dataType:"source",sourceId:g.getSource().id}))}this.light&&this.light.recalculate(i),this.terrain&&this.terrain.recalculate(i),this.fog&&this.fog.recalculate(i),this.z=i.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),u&&this.fire(new s.b("data",{dataType:"style"}))}_updateTilesForChangedImages(){const i=this._changes.getUpdatedImages();if(i.length){for(const o in this._sourceCaches)this._sourceCaches[o].reloadTilesForDependencies(["icons","patterns"],i);this._changes.resetUpdatedImages()}}_updateWorkerLayers(i,o,u){const d=this.getFragmentStyle(i);d&&this.dispatcher.broadcast("updateLayers",{layers:o?d._serializeLayers(o):[],scope:i,removedIds:u||[],options:d.options})}setState(i){if(this._checkLoaded(),Go(this,In(i)))return!1;(i=s.c1(i)).layers=fd(i.layers);const o=function(d,p){if(!d)return[{command:dr.setStyle,args:[p]}];let g=[];try{if(!te(d.version,p.version))return[{command:dr.setStyle,args:[p]}];te(d.center,p.center)||g.push({command:dr.setCenter,args:[p.center]}),te(d.zoom,p.zoom)||g.push({command:dr.setZoom,args:[p.zoom]}),te(d.bearing,p.bearing)||g.push({command:dr.setBearing,args:[p.bearing]}),te(d.pitch,p.pitch)||g.push({command:dr.setPitch,args:[p.pitch]}),te(d.sprite,p.sprite)||g.push({command:dr.setSprite,args:[p.sprite]}),te(d.glyphs,p.glyphs)||g.push({command:dr.setGlyphs,args:[p.glyphs]}),te(d.imports,p.imports)||function(S=[],z=[],R){z=z||[];const U=(S=S||[]).map(No),N=z.map(No),V=S.reduce(Ul,{}),B=z.reduce(Ul,{}),G=U.slice();let K,q,J,j;for(K=0,q=0;K<U.length;K++)J=U[K],B.hasOwnProperty(J)?q++:(R.push({command:dr.removeImport,args:[J]}),G.splice(G.indexOf(J,q),1));for(K=0,q=0;K<N.length;K++)J=N[N.length-1-K],G[G.length-1-K]!==J&&(V.hasOwnProperty(J)?(R.push({command:dr.removeImport,args:[J]}),G.splice(G.lastIndexOf(J,G.length-q),1)):q++,j=G[G.length-K],R.push({command:dr.addImport,args:[B[J],j]}),G.splice(G.length-K,0,J));for(const Q of z){const oe=V[Q.id];oe&&!te(oe,Q)&&R.push({command:dr.updateImport,args:[Q.id,Q]})}}(d.imports,p.imports,g),te(d.transition,p.transition)||g.push({command:dr.setTransition,args:[p.transition]}),te(d.light,p.light)||g.push({command:dr.setLight,args:[p.light]}),te(d.fog,p.fog)||g.push({command:dr.setFog,args:[p.fog]}),te(d.projection,p.projection)||g.push({command:dr.setProjection,args:[p.projection]}),te(d.lights,p.lights)||g.push({command:dr.setLights,args:[p.lights]}),te(d.camera,p.camera)||g.push({command:dr.setCamera,args:[p.camera]});const v={},w=[];(function(S,z,R,U){let N;for(N in z=z||{},S=S||{})S.hasOwnProperty(N)&&(z.hasOwnProperty(N)||eu(N,R,U));for(N in z){if(!z.hasOwnProperty(N))continue;const V=z[N];S.hasOwnProperty(N)?te(S[N],V)||(S[N].type==="geojson"&&V.type==="geojson"&&Bp(S,z,N)?R.push({command:dr.setGeoJSONSourceData,args:[N,V.data]}):kp(N,z,R,U)):Ra(N,z,R)}})(d.sources,p.sources,w,v);const M=[];d.layers&&d.layers.forEach(S=>{S.source&&v[S.source]?g.push({command:dr.removeLayer,args:[S.id]}):M.push(S)});let I=d.terrain;I&&v[I.source]&&(g.push({command:dr.setTerrain,args:[void 0]}),I=void 0),g=g.concat(w),te(I,p.terrain)||g.push({command:dr.setTerrain,args:[p.terrain]}),function(S,z,R){z=z||[];const U=(S=S||[]).map(No),N=z.map(No),V=S.reduce(Ul,{}),B=z.reduce(Ul,{}),G=U.slice(),K=Object.create(null);let q,J,j,Q,oe,le,he;for(q=0,J=0;q<U.length;q++)j=U[q],B.hasOwnProperty(j)?J++:(R.push({command:dr.removeLayer,args:[j]}),G.splice(G.indexOf(j,J),1));for(q=0,J=0;q<N.length;q++)j=N[N.length-1-q],G[G.length-1-q]!==j&&(V.hasOwnProperty(j)?(R.push({command:dr.removeLayer,args:[j]}),G.splice(G.lastIndexOf(j,G.length-J),1)):J++,le=G[G.length-q],R.push({command:dr.addLayer,args:[B[j],le]}),G.splice(G.length-q,0,j),K[j]=!0);for(q=0;q<N.length;q++)if(j=N[q],Q=V[j],oe=B[j],!K[j]&&!te(Q,oe))if(te(Q.source,oe.source)&&te(Q["source-layer"],oe["source-layer"])&&te(Q.type,oe.type)){for(he in Fo(Q.layout,oe.layout,R,j,null,dr.setLayoutProperty),Fo(Q.paint,oe.paint,R,j,null,dr.setPaintProperty),te(Q.slot,oe.slot)||R.push({command:dr.setSlot,args:[j,oe.slot]}),te(Q.filter,oe.filter)||R.push({command:dr.setFilter,args:[j,oe.filter]}),te(Q.minzoom,oe.minzoom)&&te(Q.maxzoom,oe.maxzoom)||R.push({command:dr.setLayerZoomRange,args:[j,oe.minzoom,oe.maxzoom]}),Q)Q.hasOwnProperty(he)&&he!=="layout"&&he!=="paint"&&he!=="filter"&&he!=="metadata"&&he!=="minzoom"&&he!=="maxzoom"&&he!=="slot"&&(he.indexOf("paint.")===0?Fo(Q[he],oe[he],R,j,he.slice(6),dr.setPaintProperty):te(Q[he],oe[he])||R.push({command:dr.setLayerProperty,args:[j,he,oe[he]]}));for(he in oe)oe.hasOwnProperty(he)&&!Q.hasOwnProperty(he)&&he!=="layout"&&he!=="paint"&&he!=="filter"&&he!=="metadata"&&he!=="minzoom"&&he!=="maxzoom"&&he!=="slot"&&(he.indexOf("paint.")===0?Fo(Q[he],oe[he],R,j,he.slice(6),dr.setPaintProperty):te(Q[he],oe[he])||R.push({command:dr.setLayerProperty,args:[j,he,oe[he]]}))}else R.push({command:dr.removeLayer,args:[j]}),le=G[G.lastIndexOf(j)+1],R.push({command:dr.addLayer,args:[oe,le]})}(M,p.layers,g)}catch(v){console.warn("Unable to compute style diff:",v),g=[{command:dr.setStyle,args:[p]}]}return g}(this.serialize(),i).filter(d=>!(d.command in Qs));if(o.length===0)return!1;const u=o.filter(d=>!(d.command in bd));if(u.length>0)throw new Error(`Unimplemented: ${u.map(d=>d.command).join(", ")}.`);return o.forEach(d=>{this[d.command].apply(this,d.args)}),this.stylesheet=i,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}addImage(i,o){return this.getImage(i)?this.fire(new s.a(new Error("An image with this name already exists."))):(this.imageManager.addImage(i,this.scope,o),this._afterImageUpdated(i),this)}updateImage(i,o){this.imageManager.updateImage(i,this.scope,o)}getImage(i){return this.imageManager.getImage(i,this.scope)}removeImage(i){return this.getImage(i)?(this.imageManager.removeImage(i,this.scope),this._afterImageUpdated(i),this):this.fire(new s.a(new Error("No image with this name exists.")))}_afterImageUpdated(i){this._availableImages=this.imageManager.listImages(this.scope),this._changes.updateImage(i),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.fire(new s.b("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModel(i,o,u={}){return this._checkLoaded(),this._validate(vt,`models.${i}`,o,null,u)||(this.modelManager.addModel(i,o,this.scope),this._changes.setDirty()),this}hasModel(i){return this.modelManager.hasModel(i,this.scope)}removeModel(i){return this.hasModel(i)?(this.modelManager.removeModel(i,this.scope),this):this.fire(new s.a(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(i,o,u={}){if(this._checkLoaded(),this.getOwnSource(i)!==void 0)throw new Error(`There is already a source with ID "${i}".`);if(!o.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(o).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(o.type)>=0&&this._validate(fo,`sources.${i}`,o,null,u))return;this.map&&this.map._collectResourceTiming&&(o.collectResourceTiming=!0);const d=bi(i,o,this.dispatcher,this);d.scope=this.scope,d.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(d.id),source:d.serialize(),sourceId:d.id}));const p=g=>{const v=(g?"symbol:":"other:")+d.id,w=s.ag(v,this.scope),M=this._sourceCaches[v]=new Vn(w,d,g);(g?this._symbolSourceCaches:this._otherSourceCaches)[d.id]=M,M.onAdd(this.map)};p(!1),o.type!=="vector"&&o.type!=="geojson"||p(!0),d.onAdd&&d.onAdd(this.map),u.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(i){this._checkLoaded();const o=this.getOwnSource(i);if(!o)throw new Error("There is no source with this ID");for(const d in this._layers)if(this._layers[d].source===i)return this.fire(new s.a(new Error(`Source "${i}" cannot be removed while layer "${d}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===i)return this.fire(new s.a(new Error(`Source "${i}" cannot be removed while terrain is using it.`)));const u=this.getOwnSourceCaches(i);for(const d of u){const p=s.c3(d.id);delete this._sourceCaches[p],this._changes.discardSourceCacheUpdate(d.id),d.fire(new s.b("data",{sourceDataType:"metadata",dataType:"source",sourceId:d.getSource().id})),d.setEventedParent(null),d.clearTiles()}return delete this._otherSourceCaches[i],delete this._symbolSourceCaches[i],this.mergeSources(),o.setEventedParent(null),o.onRemove&&o.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(i,o){this._checkLoaded(),this.getOwnSource(i).setData(o),this._changes.setDirty()}getOwnSource(i){const o=this.getOwnSourceCache(i);return o&&o.getSource()}getOwnSources(){const i=[];for(const o in this._otherSourceCaches){const u=this.getOwnSourceCache(o);u&&i.push(u.getSource())}return i}areTilesLoaded(){const i=this._mergedSourceCaches;for(const o in i){const u=i[o]._tiles;for(const d in u){const p=u[d];if(p.state!=="loaded"&&p.state!=="errored")return!1}}return!0}setLights(i){if(this._checkLoaded(),!i)return delete this.ambientLight,void delete this.directionalLight;const o=this._getTransitionParameters();for(const d of i){if(this._validate(ke,"lights",d))return;switch(d.type){case"ambient":if(this.ambientLight){const p=this.ambientLight;p.set(d),p.updateTransitions(o)}else this.ambientLight=new Wi(d,nn,this.scope,this.options);break;case"directional":if(this.directionalLight){const p=this.directionalLight;p.set(d),p.updateTransitions(o)}else this.directionalLight=new Wi(d,yi,this.scope,this.options)}}const u=new s.K(this.z||0,o);this.ambientLight&&this.ambientLight.recalculate(u),this.directionalLight&&this.directionalLight.recalculate(u),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const i=this.directionalLight,o=this.ambientLight;if(!i||!o)return;const u=S=>.2126*(S[0]<=.03928?S[0]/12.92:Math.pow((S[0]+.055)/1.055,2.4))+.7152*(S[1]<=.03928?S[1]/12.92:Math.pow((S[1]+.055)/1.055,2.4))+.0722*(S[2]<=.03928?S[2]/12.92:Math.pow((S[2]+.055)/1.055,2.4)),d=i.properties.get("color").toArray01(),p=i.properties.get("intensity"),g=i.properties.get("direction"),v=1-s.bQ(g.x,g.y,g.z)[2]/90,w=u(d)*p*v,M=o.properties.get("color").toArray01(),I=o.properties.get("intensity");return(w+u(M)*I)/2}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const i=[];return this.directionalLight&&i.push(this.directionalLight.get()),this.ambientLight&&i.push(this.ambientLight.get()),i}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(i){if(!i)return this;if(s.c4(i)){const o=s.c5(i),u=this.fragments.find(({id:p})=>p===o);if(!u)throw new Error(`Style import not found: ${i}`);const d=s.c3(i);return u.style.getFragmentStyle(d)}{const o=this.fragments.find(({id:u})=>u===i);if(!o)throw new Error(`Style import not found: ${i}`);return o.style}}getConfigProperty(i,o){const u=this.getFragmentStyle(i);if(!u)return null;const d=s.ag(o,u.scope),p=u.options.get(d),g=p?p.value||p.default:null;return g?g.serialize():null}setConfigProperty(i,o,u){const d=s.r(u);if(d.result!=="success")return void Go(this,d.value);const p=d.value.expression,g=this.getFragmentStyle(i);if(!g)return;const v=s.ag(o,g.scope),w=g.options.get(v);w&&(this.options.set(v,{...w,value:p}),this.updateConfigDependencies())}setConfig(i,o){if(this._config=i,i||o)if(o)for(const u in o){let d,p;const g=s.r(o[u].default);if(g.result==="success"&&(d=g.value.expression),i&&i[u]!==void 0){const z=s.r(i[u]);z.result==="success"&&(p=z.value.expression)}const{minValue:v,maxValue:w,stepValue:M,type:I,values:S}=o[u];if(d){const z=s.ag(u,this.scope);this.options.set(z,{default:d,value:p,minValue:v,maxValue:w,stepValue:M,type:I,values:S})}else this.fire(new s.a(new Error(`No schema defined for config option "${u}".`)))}else this.fire(new s.a(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(){for(const i of this._configDependentLayers){const o=this.getLayer(i);o&&(o.possiblyEvaluateVisibility(),this._updateLayer(o))}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this._changes.setDirty()}addLayer(i,o,u={}){this._checkLoaded();const d=i.id;if(this._layers[d])return void this.fire(new s.a(new Error(`Layer with id "${d}" already exists on this map`)));let p;if(i.type==="custom"){if(Go(this,s.c6(i)))return;p=s.c2(i,this.scope,this.options)}else{if(typeof i.source=="object"&&(this.addSource(d,i.source),i=s.c1(i),i=s.e(i,{source:d})),this._validate(de,`layers.${d}`,i,{arrayIndex:-1},u))return;p=s.c2(i,this.scope,this.options),this._validateLayer(p),p.setEventedParent(this,{layer:{id:d}}),this._serializedLayers[p.id]=p.serialize()}p.isConfigDependent&&this._configDependentLayers.add(p.fqid);let g=this._order.length;if(o){const I=this._order.indexOf(o);if(I===-1)return void this.fire(new s.a(new Error(`Layer with id "${o}" does not exist on this map.`)));p.slot===this._layers[o].slot?g=I:s.w(`Layer with id "${o}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(g,0,d),this._layerOrderChanged=!0,this._layers[d]=p;const v=this.getOwnLayerSourceCache(p),w=!!this.directionalLight&&this.directionalLight.shadowsEnabled();v&&p.canCastShadows()&&w&&(v.castsShadows=!0);const M=this._changes.getRemovedLayer(p);if(M&&p.source&&v&&p.type!=="custom"){this._changes.discardLayerRemoval(p);const I=s.ag(p.source,p.scope);M.type!==p.type?this._changes.updateSourceCache(I,"clear"):(this._changes.updateSourceCache(I,"reload"),v.pause())}this._updateLayer(p),p.onAdd&&p.onAdd(this.map),p.scope=this.scope,this.mergeLayers()}moveLayer(i,o){this._checkLoaded();const u=this._checkLayer(i);if(!u||i===o)return;const d=this._order.indexOf(i);this._order.splice(d,1);let p=this._order.length;if(o){const g=this._order.indexOf(o);if(g===-1)return void this.fire(new s.a(new Error(`Layer with id "${o}" does not exist on this map.`)));u.slot===this._layers[o].slot?p=g:s.w(`Layer with id "${o}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(p,0,i),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(i){this._checkLoaded();const o=this._checkLayer(i);if(!o)return;o.setEventedParent(null);const u=this._order.indexOf(i);this._order.splice(u,1),delete this._layers[i],delete this._serializedLayers[i],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(o.fqid),this._changes.removeLayer(o);const d=this.getOwnLayerSourceCache(o);if(d&&d.castsShadows){let p=!1;for(const g in this._layers)if(this._layers[g].source===o.source&&this._layers[g].canCastShadows()){p=!0;break}d.castsShadows=p}o.onRemove&&o.onRemove(this.map),this.mergeLayers()}getOwnLayer(i){return this._layers[i]}hasLayer(i){return i in this._mergedLayers}hasLayerType(i){for(const o in this._layers)if(this._layers[o].type===i)return!0;return!1}setLayerZoomRange(i,o,u){this._checkLoaded();const d=this._checkLayer(i);d&&(d.minzoom===o&&d.maxzoom===u||(o!=null&&(d.minzoom=o),u!=null&&(d.maxzoom=u),this._updateLayer(d)))}setSlot(i,o){this._checkLoaded();const u=this._checkLayer(i);u&&u.slot!==o&&(u.slot=o,this._updateLayer(u))}setFilter(i,o,u={}){this._checkLoaded();const d=this._checkLayer(i);if(d&&!te(d.filter,o))return o==null?(d.filter=void 0,void this._updateLayer(d)):void(this._validate(Le,`layers.${d.id}.filter`,o,{layerType:d.type},u)||(d.filter=s.c1(o),this._updateLayer(d)))}getFilter(i){const o=this._checkLayer(i);if(o)return s.c1(o.filter)}setLayoutProperty(i,o,u,d={}){this._checkLoaded();const p=this._checkLayer(i);if(p&&!te(p.getLayoutProperty(o),u)){if(u!=null&&(!d||d.validate!==!1)&&Go(p,We.call(In,{key:`layers.${i}.layout.${o}`,layerType:p.type,objectKey:o,value:u,styleSpec:s.D,style:{glyphs:!0,sprite:!0}})))return;p.setLayoutProperty(o,u),p.isConfigDependent&&this._configDependentLayers.add(p.fqid),this._updateLayer(p)}}getLayoutProperty(i,o){const u=this._checkLayer(i);if(u)return u.getLayoutProperty(o)}setPaintProperty(i,o,u,d={}){this._checkLoaded();const p=this._checkLayer(i);if(!p||te(p.getPaintProperty(o),u)||u!=null&&(!d||d.validate!==!1)&&Go(p,Fe.call(In,{key:`layers.${i}.paint.${o}`,layerType:p.type,objectKey:o,value:u,styleSpec:s.D})))return;const g=p.setPaintProperty(o,u);p.isConfigDependent&&this._configDependentLayers.add(p.fqid),g&&this._updateLayer(p),this._changes.updatePaintProperties(p)}getPaintProperty(i,o){const u=this._checkLayer(i);if(u)return u.getPaintProperty(o)}setFeatureState(i,o){this._checkLoaded();const u=i.source,d=i.sourceLayer,p=this._checkSource(u);if(!p)return;const g=p.type;if(g==="geojson"&&d)return void this.fire(new s.a(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(g==="vector"&&!d)return void this.fire(new s.a(new Error("The sourceLayer parameter must be provided for vector source types.")));i.id===void 0&&this.fire(new s.a(new Error("The feature id parameter must be provided.")));const v=this.getOwnSourceCaches(u);for(const w of v)w.setFeatureState(d,i.id,o)}removeFeatureState(i,o){this._checkLoaded();const u=i.source,d=this._checkSource(u);if(!d)return;const p=d.type,g=p==="vector"?i.sourceLayer:void 0;if(p==="vector"&&!g)return void this.fire(new s.a(new Error("The sourceLayer parameter must be provided for vector source types.")));if(o&&typeof i.id!="string"&&typeof i.id!="number")return void this.fire(new s.a(new Error("A feature id is required to remove its specific state property.")));const v=this.getOwnSourceCaches(u);for(const w of v)w.removeFeatureState(g,i.id,o)}getFeatureState(i){this._checkLoaded();const o=i.source,u=i.sourceLayer,d=this._checkSource(o);if(d){if(d.type!=="vector"||u)return i.id===void 0&&this.fire(new s.a(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(o)[0].getFeatureState(u,i.id);this.fire(new s.a(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(i){return this.stylesheet.transition=s.e({},this.stylesheet.transition,i),this.transition=this.stylesheet.transition,this}getTransition(){return s.e({},this.stylesheet.transition)}serialize(){this._checkLoaded();const i=this.getTerrain(),o=i&&this.terrain&&this.terrain.scope===this.scope?i:this.stylesheet.terrain;return s.c7({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:o,fog:this.stylesheet.fog,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},u=>u!==void 0)}_updateLayer(i){this._changes.updateLayer(i);const o=this.getLayerSourceCache(i),u=s.ag(i.source,i.scope),d=this._changes.getUpdatedSourceCaches();i.source&&!d[u]&&o&&o.getSource().type!=="raster"&&(this._changes.updateSourceCache(u,"reload"),o.pause()),i.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(i){const o=v=>this._mergedLayers[v].type==="fill-extrusion"||this._mergedLayers[v].type==="model",u=this.order,d={},p=[];for(let v=u.length-1;v>=0;v--){const w=u[v];if(o(w)){d[w]=v;for(const M of i){const I=M[w];if(I)for(const S of I)p.push(S)}}}p.sort((v,w)=>w.intersectionZ-v.intersectionZ);const g=[];for(let v=u.length-1;v>=0;v--){const w=u[v];if(o(w))for(let M=p.length-1;M>=0;M--){const I=p[M].feature;if(d[I.layer.id]<v)break;g.push(I),p.pop()}else for(const M of i){const I=M[w];if(I)for(const S of I)g.push(S.feature)}}return g}queryRenderedFeatures(i,o,u){o&&o.filter&&this._validate(Le,"queryRenderedFeatures.filter",o.filter,null,o),o.scope=this.scope,o.availableImages=this._availableImages,o.serializedLayers=this._serializedLayers;const d={};if(o&&o.layers){if(!Array.isArray(o.layers))return this.fire(new s.a(new Error("parameters.layers must be an Array."))),[];for(const M of o.layers){const I=this._mergedLayers[M];if(!I)return this.fire(new s.a(new Error(`The layer '${M}' does not exist in the map's style and cannot be queried for features.`))),[];d[I.source]=!0}}const p=[],g=o.serializedLayers||{},v=o&&o.layers?o.layers.some(M=>{const I=this.getLayer(M);return I&&I.is3D()}):this.has3DLayers(),w=pi.createFromScreenPoints(i,u);for(const M in this._mergedSourceCaches){const I=this._mergedSourceCaches[M].getSource();if(!I||I.scope!==o.scope)continue;const S=this._mergedSourceCaches[M].getSource().id;o.layers&&!d[S]||p.push(Qc(this._mergedSourceCaches[M],this._mergedLayers,g,w,o,u,v,!!this.map._showQueryGeometry))}return this.placement&&p.push(function(M,I,S,z,R,U,N){const V={},B=U.queryRenderedSymbols(z),G=[];for(const K of Object.keys(B).map(Number))G.push(N[K]);G.sort(qs);for(const K of G){const q=K.featureIndex.lookupSymbolFeatures(B[K.bucketInstanceId],I,K.bucketIndex,K.sourceLayerIndex,R.filter,R.layers,R.availableImages,M);for(const J in q){const j=V[J]=V[J]||[],Q=q[J];Q.sort((oe,le)=>{const he=K.featureSortOrder;if(he){const we=he.indexOf(oe.featureIndex);return he.indexOf(le.featureIndex)-we}return le.featureIndex-oe.featureIndex});for(const oe of Q)j.push(oe)}}for(const K in V)V[K].forEach(q=>{const J=q.feature,j=S(M[K]);if(!j)return;const Q=j.getFeatureState(J.layer["source-layer"],J.id);J.source=J.layer.source,J.layer["source-layer"]&&(J.sourceLayer=J.layer["source-layer"]),J.state=Q});return V}(this._mergedLayers,g,this.getLayerSourceCache.bind(this),w.screenGeometry,o,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(p)}querySourceFeatures(i,o){o&&o.filter&&this._validate(Le,"querySourceFeatures.filter",o.filter,null,o);const u=this.getOwnSourceCaches(i);let d=[];for(const p of u)d=d.concat(mo(p,o));return d}addSourceType(i,o,u){return Zn.getSourceType(i)?u(new Error(`A source type called "${i}" already exists.`)):(Zn.setSourceType(i,o),o.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:i,url:o.workerSourceURL},u):u(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(i,o,u={}){this._checkLoaded();const d=this.light.getLight();let p=!1;for(const v in i)if(!te(i[v],d[v])){p=!0;break}if(!p)return;const g=this._getTransitionParameters();this.light.setLight(i,o,u),this.light.updateTransitions(g)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}setTerrain(i,o=1){if(this._checkLoaded(),!i)return this.terrainSetForDrapingOnly()&&o!==0||delete this.terrain,i===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);let u=i;const d=i.source==null;if(o===1){if(typeof u.source=="object"){const v="terrain-dem-src";this.addSource(v,u.source),u=s.c1(u),u=s.e(u,{source:v})}const p=s.e({},u),g={};if(this.terrain&&d){p.source=this.terrain.get().source;const v=this.terrain?this.getFragmentStyle(this.terrain.scope):null;v&&(g.style=v.serialize())}if(this._validate(W,"terrain",p,g))return}if(!this.terrain||this.terrain.scope!==this.scope&&!d||this.terrain&&o!==this.terrain.drapeRenderMode){if(!u)return;this._createTerrain(u,o),this.fire(new s.b("data",{dataType:"style"}))}else{const p=this.terrain,g=p.get();for(const v of Object.keys(s.D.terrain))!u.hasOwnProperty(v)&&s.D.terrain[v].default&&(u[v]=s.D.terrain[v].default);for(const v in i)if(!te(i[v],g[v])){p.set(i,this.options),this.stylesheet.terrain=i;const w=this._getTransitionParameters({duration:0});p.updateTransitions(w),this.fire(new s.b("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(i){const o=this.fog=new Ji(i,this.map.transform,this.scope,this.options);this.stylesheet.fog=o.get();const u=this._getTransitionParameters({duration:0});o.updateTransitions(u)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(const i of this.map._markers)i._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(i){if(this._checkLoaded(),!i)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const o=this.fog;if(!te(o.get(),i)){o.set(i,this.options),this.stylesheet.fog=o.get();const u=this._getTransitionParameters({duration:0});o.updateTransitions(u)}}else this._createFog(i);this._markersNeedUpdate=!0}_getTransitionParameters(i){return{now:s.f.now(),transition:s.e(this.transition,i)}}updateDrapeFirstLayers(){if(!this.terrain)return;const i=[],o=[];for(const u in this._mergedLayers)this.isLayerDraped(this._mergedLayers[u])?i.push(u):o.push(u);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...i),this._drapedFirstOrder.push(...o)}_createTerrain(i,o){const u=this.terrain=new Or(i,o,this.scope,this.options);o===1&&(this.stylesheet.terrain=i),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const d=this._getTransitionParameters({duration:0});u.updateTransitions(d)}_force3DLayerUpdate(){for(const i in this._layers){const o=this._layers[i];o.type==="fill-extrusion"&&this._updateLayer(o)}}_forceSymbolLayerUpdate(){for(const i in this._layers){const o=this._layers[i];o.type==="symbol"&&this._updateLayer(o)}}_validate(i,o,u,d,p={}){if(p&&p.validate===!1)return!1;const g=s.e({},this.serialize());return Go(this,i.call(In,s.e({key:o,style:g,value:u,styleSpec:s.D},d)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),s.c8.off("pluginStateChange",this._rtlTextPluginCallback);for(const i in this._mergedLayers)this._mergedLayers[i].setEventedParent(null);for(const i in this._mergedSourceCaches)this._mergedSourceCaches[i].clearTiles(),this._mergedSourceCaches[i].setEventedParent(null);this.setEventedParent(null),delete this.fog,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.dispatcher.remove())}clearSource(i){const o=this.getSourceCaches(i);for(const u of o)u.clearTiles()}clearSources(){for(const i in this._mergedSourceCaches)this._mergedSourceCaches[i].clearTiles()}reloadSource(i){const o=this.getSourceCaches(i);for(const u of o)u.resume(),u.reload()}reloadSources(){for(const i of this.getSources())i.reload&&i.reload()}updateSources(i){let o;this.directionalLight&&(o=Wl(this.directionalLight));for(const u in this._mergedSourceCaches)this._mergedSourceCaches[u].update(i,void 0,void 0,o)}_generateCollisionBoxes(){for(const i in this._sourceCaches){const o=this._sourceCaches[i];o.resume(),o.reload()}}_updatePlacement(i,o,u,d,p=!1){let g=!1,v=!1;const w={},M={};for(const I of this._mergedOrder){const S=this._mergedLayers[I];if(S.type!=="symbol")continue;const z=s.ag(S.source,S.scope);let R=w[z];if(!R){const N=this.getLayerSourceCache(S);if(!N)continue;const V=N.getRenderableIds(!0).map(B=>N.getTileByID(B));M[z]=V.slice(),R=w[z]=V.sort((B,G)=>G.tileID.overscaledZ-B.tileID.overscaledZ||(B.tileID.isLessThan(G.tileID)?-1:1))}const U=this.crossTileSymbolIndex.addLayer(S,R,i.center.lng,i.projection);g=g||U}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),p=p||this._layerOrderChanged||u===0,this._layerOrderChanged&&this.fire(new s.b("neworder")),(p||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(s.f.now(),i.zoom))&&(this.pauseablePlacement=new Gl(i,this._mergedOrder,p,o,u,d,this.placement,this.fog&&i.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,w,M),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(s.f.now()),v=!0),g&&this.pauseablePlacement.placement.setStale()),v||g){this._buildingIndex.onNewFrame(i.zoom);for(const I of this._mergedOrder){const S=this._mergedLayers[I];S.type==="symbol"&&this.placement.updateLayerOpacities(S,w[s.ag(S.source,S.scope)])}}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(s.f.now())}_releaseSymbolFadeTiles(){for(const i in this._sourceCaches)this._sourceCaches[i].releaseSymbolFadeTiles()}addImport(i,o){this._checkLoaded();const u=this.stylesheet.imports=this.stylesheet.imports||[];if(u.findIndex(({id:p})=>p===i.id)!==-1)return this.fire(new s.a(new Error(`Import with id '${i.id}' already exists in the map's style.`)));if(!o)return u.push(i),this._loadImports([i],!0),this;const d=u.findIndex(({id:p})=>p===o);return d===-1?this.fire(new s.a(new Error(`Import with id "${o}" does not exist on this map.`))):(this.stylesheet.imports=u.slice(0,d).concat(i).concat(u.slice(d)),this._loadImports([i],!0,o),this)}updateImport(i,o){this._checkLoaded();const u=this.stylesheet.imports||[],d=this.getImportIndex(i);return d===-1?this:typeof o=="string"?(this.setImportUrl(i,o),this):(o.url&&o.url!==u[d].url&&this.setImportUrl(i,o.url),te(o.config,u[d].config)||this.setImportConfig(i,o.config),te(o.data,u[d].data)||this.setImportData(i,o.data),this)}moveImport(i,o){this._checkLoaded();let u=this.stylesheet.imports||[];const d=this.getImportIndex(i);if(d===-1)return this;const p=this.getImportIndex(o);if(p===-1)return this;const g=u[d],v=this.fragments[d];return u=u.filter(({id:w})=>w!==i),this.fragments=this.fragments.filter(({id:w})=>w!==i),this.stylesheet.imports=u.slice(0,p).concat(g).concat(u.slice(p)),this.fragments=this.fragments.slice(0,p).concat(v).concat(this.fragments.slice(p)),this.mergeLayers(),this}setImportUrl(i,o){this._checkLoaded();const u=this.stylesheet.imports||[],d=this.getImportIndex(i);if(d===-1)return this;u[d].url=o;const p=this.fragments[d];return p.style=this._createFragmentStyle(u[d]),p.style.on("style.import.load",()=>this.mergeAll()),p.style.loadURL(o),this}setImportData(i,o){this._checkLoaded();const u=this.getImportIndex(i),d=this.stylesheet.imports||[];return u===-1?this:o?(this.fragments[u].style.setState(o),this._reloadImports(),this):(delete d[u].data,this.setImportUrl(i,d[u].url))}setImportConfig(i,o){this._checkLoaded();const u=this.getImportIndex(i),d=this.stylesheet.imports||[];if(u===-1)return this;o?d[u].config=o:delete d[u].config;const p=this.fragments[u],g=p.style.stylesheet&&p.style.stylesheet.schema;return p.config=o,p.style.setConfig(o,g),this.updateConfigDependencies(),this}removeImport(i){this._checkLoaded();const o=this.stylesheet.imports||[],u=this.getImportIndex(i);return u===-1||(o.splice(u,1),this.fragments[u].style._remove(),this.fragments.splice(u,1),this._reloadImports()),this}getImportIndex(i){const o=(this.stylesheet.imports||[]).findIndex(u=>u.id===i);return o===-1&&this.fire(new s.a(new Error(`Import '${i}' does not exist in the map's style and cannot be updated.`))),o}getLayer(i){return this._mergedLayers[i]}getSources(){const i=[];for(const o in this._mergedOtherSourceCaches){const u=this._mergedOtherSourceCaches[o];u&&i.push(u.getSource())}return i}getSource(i,o){const u=this.getSourceCache(i,o);return u&&u.getSource()}getLayerSource(i){const o=this.getLayerSourceCache(i);return o&&o.getSource()}getSourceCache(i,o){const u=s.ag(i,o);return this._mergedOtherSourceCaches[u]}getLayerSourceCache(i){const o=s.ag(i.source,i.scope);return i.type==="symbol"?this._mergedSymbolSourceCaches[o]:this._mergedOtherSourceCaches[o]}getSourceCaches(i){const o=[];return this._mergedOtherSourceCaches[i]&&o.push(this._mergedOtherSourceCaches[i]),this._mergedSymbolSourceCaches[i]&&o.push(this._mergedSymbolSourceCaches[i]),o}updateSourceCaches(){const i=this._changes.getUpdatedSourceCaches();for(const o in i){const u=i[o];u==="reload"?this.reloadSource(o):u==="clear"&&this.clearSource(o)}}updateLayers(i){const o=this._changes.getUpdatedPaintProperties();for(const u of o){const d=this.getLayer(u);d&&d.updateTransitions(i)}}getImages(i,o,u){this.imageManager.getImages(o.icons,o.scope,u),this._updateTilesForChangedImages();const d=p=>{p&&p.setDependencies(o.tileID.key,o.type,o.icons)};d(this._otherSourceCaches[o.source]),d(this._symbolSourceCaches[o.source])}getGlyphs(i,o,u){this.glyphManager.getGlyphs(o.stacks,o.scope,u)}getResource(i,o,u){return s.c9(o,u)}getOwnSourceCache(i){return this._otherSourceCaches[i]}getOwnLayerSourceCache(i){return i.type==="symbol"?this._symbolSourceCaches[i.source]:this._otherSourceCaches[i.source]}getOwnSourceCaches(i){const o=[];return this._otherSourceCaches[i]&&o.push(this._otherSourceCaches[i]),this._symbolSourceCaches[i]&&o.push(this._symbolSourceCaches[i]),o}_isSourceCacheLoaded(i){const o=this.getOwnSourceCaches(i);return o.length===0?(this.fire(new s.a(new Error(`There is no source with ID '${i}'`))),!1):o.every(u=>u.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(i=>{i.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}Zn.getSourceType=function(c){return po[c]},Zn.setSourceType=function(c,i){po[c]=i},Zn.registerForPluginStateChange=s.bV;var Hl=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#ifdef RENDER_CUTOFF
float cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}
#endif`,Xl=`
out vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec2 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color) {
#ifdef INDICATOR_CUTOUT
float holeMinOpacity=u_indicator_cutout_params.x;float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
glFragColor=vec4(0.7,0.0,0.0,0.7); \\
gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif
#ifdef RENDER_CUTOFF
uniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;
#endif
vec4 textureLodCustom(sampler2D image,vec2 pos,vec2 lod_coord) {vec2 size=vec2(textureSize(image,0));vec2 dx=dFdx(lod_coord.xy*size);vec2 dy=dFdy(lod_coord.xy*size);float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}`,Yl=`
#define EXTENT 8192.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}
#ifdef RENDER_CUTOFF
uniform vec4 u_cutoff_params;out float v_cutoff_opacity;
#endif
const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}`,Kl="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",wu=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;uniform sampler2D u_depth;uniform vec2 u_depth_size_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5));return coord.z > depth+0.0005;}float occlusionFade(vec4 frag) {vec3 coord=frag.xyz/frag.w;vec3 df=vec3(5.0*u_depth_size_inv,0.0);vec2 uv=0.5*coord.xy+0.5;vec4 depth=vec4(
unpack_depth(texture(u_depth,uv-df.xz)),unpack_depth(texture(u_depth,uv+df.xz)),unpack_depth(texture(u_depth,uv-df.zy)),unpack_depth(texture(u_depth,uv+df.zy))
);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z-0.001)-depth),0.0,1.0));}vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }bool isOccluded(vec4 frag) { return false; }float occlusionFade(vec4 frag) { return 1.0; }
#endif`,Tu=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,Td=`highp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}
#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {
#ifdef FOG_DITHERING
vec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);
#else
return color;
#endif
}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,ea=`#ifdef RASTER_ARRAY
uniform sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)
);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)
);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}
#endif`,ta=`#ifdef RASTER_ARRAY
uniform sampler2D u_velocity;uniform vec2 u_velocity_res;uniform float u_max_speed;const vec2 INVALID_VELOCITY=vec2(-1);uniform vec2 u_texture_offset;uniform float u_data_offset;uniform vec4 u_data_scale;vec2 lookup_velocity(vec2 uv) {uv=u_texture_offset.x+u_texture_offset.y*uv;vec2 fxy;ivec4 c=_raTexLinearCoord(uv,u_velocity_res,fxy);vec4 tl=texelFetch(u_velocity,c.yz,0);vec4 tr=texelFetch(u_velocity,c.xz,0);vec4 bl=texelFetch(u_velocity,c.yw,0);vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NODATA) {return INVALID_VELOCITY;}if (tr==NODATA) {return INVALID_VELOCITY;}if (bl==NODATA) {return INVALID_VELOCITY;}if (br==NODATA) {return INVALID_VELOCITY;}vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);
#ifdef DATA_FORMAT_UINT32
vec2 velocity=vec2(u_data_offset+dot(t,u_data_scale),0);return velocity;
#else
vec2 velocity=vec2(u_data_offset+dot(t.rg,u_data_scale.yx),-(u_data_offset+dot(t.ba,u_data_scale.yx)));
#endif
return velocity/max(u_max_speed,length(velocity));}
#endif`,Eu=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif//RENDER_SHADOWS`,Ga=`#ifdef RENDER_SHADOWS
#ifdef DEPTH_TEXTURE
uniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;
#else
uniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;
#endif
uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;
#ifdef DEPTH_TEXTURE
shadow_depth=texture(u_shadowmap_1,uv).r;
#else
shadow_depth=unpack_depth(texture(u_shadowmap_1,uv))*0.5+0.5;
#endif
return step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;
#ifdef DEPTH_TEXTURE
shadow_depth=texture(u_shadowmap_0,uv).r;
#else
shadow_depth=unpack_depth(texture(u_shadowmap_0,uv))*0.5+0.5;
#endif
return step(shadow_depth,compare);}float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp vec2 uv=pos.xy;return shadow_sample_1(uv,pos.z-bias);}float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;
#ifdef NATIVE
highp vec2 uv=pos.xy;highp vec4 samples=textureGather(u_shadowmap_0,uv,0);lowp vec4 stepSamples=step(samples,vec4(compare0));
#else
highp vec2 uv00=pos.xy-vec2(0.5*u_shadow_texel_size);highp vec2 uv10=uv00+vec2(u_shadow_texel_size,0.0);highp vec2 uv01=uv00+vec2(0.0,u_shadow_texel_size);highp vec2 uv11=uv01+vec2(u_shadow_texel_size,0.0);lowp vec4 stepSamples=vec4(
shadow_sample_0(uv01,compare0),shadow_sample_0(uv11,compare0),shadow_sample_0(uv10,compare0),shadow_sample_0(uv00,compare0)
);
#endif
vec2 f=fract(pos.xy*u_shadow_map_resolution-vec2(0.5));lowp vec2 lerpx=mix(stepSamples.wx,stepSamples.zy,f.xx);return mix(lerpx.x,lerpx.y,f.y);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {
#ifdef SHADOWS_SINGLE_CASCADE
light_view_pos0.xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);
#else
light_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth));
#endif
}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;const ra=[];$o(Hl,ra),$o(Yl,ra),$o(Xl,ra);const xn={"_prelude_fog.vertex.glsl":Tu,"_prelude_terrain.vertex.glsl":wu,"_prelude_shadow.vertex.glsl":Eu,"_prelude_fog.fragment.glsl":Td,"_prelude_shadow.fragment.glsl":Ga,"_prelude_lighting.glsl":`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif//LIGHTING_3D_MODE`,"_prelude_raster_array.glsl":ea,"_prelude_raster_particle.glsl":ta},ia={};_r("",wu),_r(Td,Tu),_r(Ga,Eu),_r(ea,""),_r(ta,"");const Mu=_r(Xl,Yl),Jl=Hl;var Iu={background:_r(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec4 u_color;uniform float u_opacity;
#ifdef LIGHTING_3D_MODE
in vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_lighting.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:_r(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in vec2 v_pos;void main() {vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_tile_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),circle:_r(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
glFragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:_r("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:_r(`#include "_prelude_fog.fragment.glsl"
uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:_r(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:_r("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`#include "_prelude_terrain.vertex.glsl"
in vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in float a_size_scale;in vec2 a_padding;in float a_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;out float v_placed;out float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*(a_z_offset+elevation(a_anchor_pos)),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:_r("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}",`in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:_r("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",`#include "_prelude_terrain.vertex.glsl"
in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;
#endif
out vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),fill:_r(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutline:_r(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in highp vec2 v_pos;uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
in vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:_r(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_emissive_strength;in highp vec2 v_pos;in highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;out highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:_r(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;in vec2 v_pos;uniform float u_emissive_strength;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:_r(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in vec4 v_flat;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
in vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
in highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
in float v_flood_radius;in float v_has_floodlight;
#endif
uniform float u_emissive_strength;in float v_height;void main() {
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color.rgb=mix(color.rgb,v_flat.rgb,u_emissive_strength);color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
uniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
out vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
out highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
out float v_flood_radius;out float v_has_floodlight;
#endif
out float v_height;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float cutoff=1.0;vec3 scaled_pos=pos;
#ifdef RENDER_CUTOFF
vec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);cutoff=max(0.01,cutoff_opacity(u_cutoff_params,ground.z));if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff < 0.01 && centroid_pos.x !=0.0));gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=vec4(color.rgb,1.0);v_flat=vec4(linearProduct(color.rgb,vec3(calculate_NdotL(normal))),1.0);
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionDepth:_r(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_vertical_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
out highp float v_depth;void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base);pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:_r(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
in vec3 v_normal;
#endif
in vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
out vec2 v_pos;out vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
out vec3 v_normal;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif 
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:_r(`#include "_prelude_shadow.fragment.glsl"
precision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#ifdef FOG
in float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef RENDER_CUTOFF
shadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));
#endif
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0)).r);
#endif
glFragColor=vec4(shadow,1.0);}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#ifdef FOG
out float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);
#ifdef FOG
v_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);
#endif
}`),fillExtrusionGroundEffect:_r(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;
#ifdef SDF_SUBPASS
in highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
in highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));
#endif
glFragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
#ifdef RENDER_CUTOFF
fog*=v_cutoff_opacity;
#endif
glFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
glFragColor=color;
#endif
HANDLE_WIREFRAME_DEBUG;
#endif
}`,`#include "_prelude_fog.vertex.glsl"
in highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
out highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;
#ifdef FOG
out highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
const float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(1.0,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),hillshadePrepare:_r(`precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:_r(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
glFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);
#endif
#ifdef FOG
glFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:_r(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform lowp float u_device_pixel_ratio;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec4 v_uv;
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;in vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;alpha*=linearstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture(u_gradient_image,v_uv.xy);
#else
out_color=color;
#endif
float trimmed=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {if (line_progress <=trim_end && line_progress >=trim_start) {out_color=vec4(0,0,0,0);trimmed=0.0;}}
#endif
if (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}
#ifdef RENDER_LINE_BORDER
float edgeBlur=(border_width+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {    
float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color.rgb=mix(border_color.rgb*border_color.a*trimmed,out_color.rgb,smoothAlpha);}}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#define EXTRUDE_SCALE 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
in highp vec4 a_packed;
#endif
#ifdef RENDER_LINE_DASH
in float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec4 v_uv;
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec4(a_uv_x,a_split_index*texel_height-half_texel_height,a_clip_start,a_clip_end);
#else
v_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/floorwidth,(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),linePattern:_r(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec4 v_uv;
#endif
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;vec2 pattern_size=vec2(display_size.x/u_tile_units_to_pixels,display_size.y);float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float pattern_x=v_linesofar/pattern_size.x*aspect;float x=mod(pattern_x,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);
#ifdef RENDER_LINE_TRIM_OFFSET
highp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {if (line_progress <=trim_end && line_progress >=trim_start) {color=vec4(0,0,0,0);}}
#endif
#ifdef LIGHTING_3D_MODE
color=apply_lighting_ground(color);
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
color=applyCutout(color);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec4 a_packed;
#endif
in float a_linesofar;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
out highp vec4 v_uv;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
float a_uv_x=a_packed[0];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];v_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),raster:_r(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_raster_array.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
in float v_split_fade;
#endif
uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;
#ifndef RASTER_ARRAY
uniform sampler2D u_image0;uniform sampler2D u_image1;
#endif
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;
#endif
void main() {vec4 color0,color1,color;vec2 value;
#ifdef RASTER_COLOR
#ifdef RASTER_ARRAY
#ifdef RASTER_ARRAY_LINEAR
value=mix(
raTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#else
value=mix(
raTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#endif
if (value.y > 0.0) value.x/=value.y;
#else
color=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);
#endif
color=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;
#else
color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;
#ifdef GLOBE_POLES
color.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);
#endif
vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef PROJECTION_GLOBE_VIEW
glFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));
#endif
#ifdef RENDER_CUTOFF
glFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;in vec2 a_texture_pos;
#endif
out vec2 v_pos0;out vec2 v_pos1;out float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
out float v_split_fade;
#endif
void main() {vec2 uv;
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);
#endif
#else
float w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    
v_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;
#ifdef RENDER_CUTOFF
v_depth=gl_Position.z;
#endif
}`),rasterParticle:_r(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;vec2 uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
vec2 uv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),rasterParticleDraw:_r("precision highp float;uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",`precision highp float;
#include "_prelude_raster_array.glsl"
#include "_prelude_raster_particle.glsl"
in vec3 a_pos;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {vec2 pos=a_pos.xy+u_tile_offset;vec2 tex_coords=fract(pos);gl_PointSize=1.0;vec2 velocity=lookup_velocity(tex_coords);if (velocity==INVALID_VELOCITY) {v_particle_speed=0.0;gl_Position=vec4(2.0,2.0,2.0,1.0);} else {v_particle_speed=length(velocity);gl_Position=vec4(2.0*pos-vec2(1.0),0.0,1.0);}}`),rasterParticleTexture:_r("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {v_tex_pos=0.5*a_pos+vec2(0.5);gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:_r("void main() {}",`#include "_prelude_raster_array.glsl"
#include "_prelude_raster_particle.glsl"
in vec3 a_pos;uniform float u_speed_factor;uniform float u_lifetime_delta;uniform float u_rand_seed;out vec3 v_new_particle;const vec3 rand_constants=vec3(12.9898,78.233,4375.85453);float rand(const vec2 co) {float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {float lifetime=a_pos.z;vec2 pos=a_pos.xy;vec2 uv=clamp(pos,vec2(0.0),vec2(1.0));vec2 velocity=lookup_velocity(uv);float next_lifetime=lifetime-u_lifetime_delta;float t=step(0.0,next_lifetime);
#ifdef DATA_FORMAT_UINT32
vec2 dp=vec2(0);
#else
vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;
#endif
vec2 seed=pos*u_rand_seed;vec2 next_pos=pos+dp;vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));v_new_particle=vec3(
vec2(mix(random_pos,next_pos,t)),mix(1.0,next_lifetime,t)
);}`),symbolIcon:_r(`#include "_prelude_lighting.glsl"
uniform sampler2D u_texture;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
in float v_fade_opacity;in vec2 v_tex_a;
#ifdef ICON_TRANSITION
in vec2 v_tex_b;
#endif
uniform mediump float u_icon_saturation;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float emissive_strength
lowp float alpha=opacity*v_fade_opacity;vec4 out_color;
#ifdef ICON_TRANSITION
vec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b)*alpha;
#else
out_color=texture(u_texture,v_tex_a)*alpha;
#endif
#ifdef SATURATION
vec3 luma=vec3(dot(out_color.rgb,vec3(0.2126,0.7152,0.0722)));out_color.rgb=mix(luma,out_color.rgb,u_icon_saturation);
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
in vec2 a_texb;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform vec3 u_up_vector;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out vec2 v_tex_a;
#ifdef ICON_TRANSITION
out vec2 v_tex_b;
#endif
out float v_fade_opacity;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float emissive_strength
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjected_point;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetProjected_point=u_matrix*vec4(a_globe_anchor+displacement,1);
#else
offsetProjected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);
#endif
vec2 a=projected_point.xy/projected_point.w;vec2 b=offsetProjected_point.xy/offsetProjected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change))*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);
#endif
v_tex_a=a_tex/u_texsize;
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
v_fade_opacity=out_fade_opacity;}`),symbolSDF:_r(`#include "_prelude_lighting.glsl"
#define SDF_PX 8.0
uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;in float v_draw_halo;in vec2 v_data0;in vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out float v_draw_halo;out vec2 v_data0;out vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);
#endif
vec2 a=projected_point.xy/projected_point.w;vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);
#endif
float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,out_fade_opacity);}`),symbolTextAndIcon:_r(`#include "_prelude_lighting.glsl"
#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_halo;in float v_draw_halo;in vec4 v_data0;in vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out float v_draw_halo;out vec4 v_data0;out vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offset_projected_point=u_matrix*vec4(a_pos+vec2(1,0),0,1);vec2 a=projected_point.xy/projected_point.w;vec2 b=offset_projected_point.xy/offset_projected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*font_scale);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
float out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);
#endif
float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,out_fade_opacity,is_sdf);}`),terrainRaster:_r(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;in vec2 v_pos0;
#ifdef FOG
in float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
float cutoffOpacity=1.0;
#ifdef RENDER_CUTOFF
cutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);
#endif
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
vec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));
#endif
#else
float lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;
#ifdef FOG
out float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);
#endif
}`),terrainDepth:_r("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}`),skybox:_r(`#include "_prelude_fog.fragment.glsl"
in lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,Kl),skyboxGradient:_r(`#include "_prelude_fog.fragment.glsl"
in highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,Kl),skyboxCapture:_r(`
in highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}`,"in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:_r(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);vec3 dir=normalize(ray_dir);vec3 closest_point=dot(u_globe_pos,dir)*dir;float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
raster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(raster.rgb*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;
#endif
out vec2 v_pos0;void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:_r(`#include "_prelude_fog.fragment.glsl"
uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
glFragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
glFragColor=vec4(1,1,1,1);
#else
glFragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;
#ifndef NATIVE
c=dither(c,gl_FragCoord.xy+u_temporal_offset);
#endif
glFragColor=vec4(c*t,t);
#endif
}`,`in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:_r(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef OCCLUSION_TEXTURE_TRANSFORM
uniform vec4 u_occlusionTextureTransform;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
in lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
in highp float v_depth;uniform sampler2D u_depthTexture;uniform vec2 u_inv_depth_size;bool isOccluded() {vec2 coord=gl_FragCoord.xy*u_inv_depth_size;highp float depth=unpack_depth(texture(u_depthTexture,coord));return v_depth > depth+0.0005;}
#endif
#define saturate(_x) clamp(_x,0.,1.)
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
if(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}
#endif
return vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
#ifdef OCCLUSION_TEXTURE_TRANSFORM
vec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;
#else
vec2 uv=uv_2f;
#endif
ao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);color=mix(color,v_color_mix.rgb,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
vec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));
#endif
#ifdef RENDER_CUTOFF
finalColor*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor);
#endif
glFragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
out vec4 v_position_height;out lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
out highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
out lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=u_matrix*pos;pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
v_position_height.w=a_pos_3f.z;
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 shadow_pos=local_pos;
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normalize(normal_3f));shadow_pos+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1);v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:_r(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=u_matrix*pos;
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:_r(`in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
in vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`)};function $o(c,i){const o=c.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let u of o)if(u=u.trim(),u[0]==="#"&&u.includes("if")&&!u.includes("endif")){u=u.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const d=u.split(" ");for(const p of d)i.includes(p)||i.push(p)}}function _r(c,i){const o=/#include\s+"([^"]+)"/g,u=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let d=i.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);d&&(d=d.map(M=>{const I=M.split(" ");return I[I.length-1]}),d=[...new Set(d)]);const p={},g=[],v=[];if(c=c.replace(o,(M,I)=>(v.push(I),"")),(i=i.replace(o,(M,I)=>(g.push(I),""))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let w=[...ra];$o(c,w),$o(i,w);for(const M of[...g,...v])xn[M]||console.error(`Undefined include: ${M}`),ia[M]||(ia[M]=[],$o(xn[M],ia[M])),w=[...w,...ia[M]];return{fragmentSource:c=c.replace(u,(M,I,S,z,R)=>(p[R]=!0,I==="define"?`
#ifndef HAS_UNIFORM_u_${R}
in ${S} ${z} ${R};
#else
uniform ${S} ${z} u_${R};
#endif
`:I==="initialize"?`
#ifdef HAS_UNIFORM_u_${R}
    ${S} ${z} ${R} = u_${R};
#endif
`:I==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${R}
    in ${S} ${z} ${R};
#endif
`:I==="initialize-attribute"?"":void 0)),vertexSource:i=i.replace(u,(M,I,S,z,R)=>{const U=z==="float"?"vec2":z,N=R.match(/color/)?"color":U;return I==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${R}
in ${S} ${z} a_${R};
#endif
`:p[R]?I==="define"?`
#ifndef HAS_UNIFORM_u_${R}
uniform lowp float u_${R}_t;
in ${S} ${U} a_${R};
out ${S} ${z} ${R};
#else
uniform ${S} ${z} u_${R};
#endif
`:I==="initialize"?N==="vec4"?`
#ifndef HAS_UNIFORM_u_${R}
    ${R} = a_${R};
#else
    ${S} ${z} ${R} = u_${R};
#endif
`:`
#ifndef HAS_UNIFORM_u_${R}
    ${R} = unpack_mix_${N}(a_${R}, u_${R}_t);
#else
    ${S} ${z} ${R} = u_${R};
#endif
`:I==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${R}
    in ${S} ${z} a_${R};
    out ${S} ${z} ${R};
#endif
`:I==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${R}
    ${R} = a_${R};
#endif
`:void 0:I==="define"?`
#ifndef HAS_UNIFORM_u_${R}
uniform lowp float u_${R}_t;
in ${S} ${U} a_${R};
#else
uniform ${S} ${z} u_${R};
#endif
`:I==="define-instanced"?N==="mat4"?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${R}0;
in vec4 a_${R}1;
in vec4 a_${R}2;
in vec4 a_${R}3;
#else
uniform ${S} ${z} u_${R};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${S} ${U} a_${R};
#else
uniform ${S} ${z} u_${R};
#endif
`:I==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${R}
    ${S} ${z} ${R} = a_${R};
#endif
`:N==="vec4"?`
#ifndef HAS_UNIFORM_u_${R}
    ${S} ${z} ${R} = a_${R};
#else
    ${S} ${z} ${R} = u_${R};
#endif
`:`
#ifndef HAS_UNIFORM_u_${R}
    ${S} ${z} ${R} = unpack_mix_${N}(a_${R}, u_${R}_t);
#else
    ${S} ${z} ${R} = u_${R};
#endif
`}),staticAttributes:d,usedDefines:w,vertexIncludes:g,fragmentIncludes:v}}class Cu{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(i,o,u,d,p,g,v,w){this.context=i;let M=this.boundPaintVertexBuffers.length!==d.length;for(let S=0;!M&&S<d.length;S++)this.boundPaintVertexBuffers[S]!==d[S]&&(M=!0);let I=this.boundDynamicVertexBuffers.length!==v.length;for(let S=0;!I&&S<v.length;S++)this.boundDynamicVertexBuffers[S]!==v[S]&&(I=!0);if(!this.vao||this.boundProgram!==o||this.boundLayoutVertexBuffer!==u||M||I||this.boundIndexBuffer!==p||this.boundVertexOffset!==g)this.freshBind(o,u,d,p,g,v,w);else{i.bindVertexArrayOES.set(this.vao);for(const S of v)S&&(S.bind(),w&&S.instanceCount&&S.setVertexAttribDivisor(i.gl,o,w));p&&p.dynamicDraw&&p.bind()}}freshBind(i,o,u,d,p,g,v){const w=i.numAttributes,M=this.context,I=M.gl;this.vao&&this.destroy(),this.vao=M.gl.createVertexArray(),M.bindVertexArrayOES.set(this.vao),this.boundProgram=i,this.boundLayoutVertexBuffer=o,this.boundPaintVertexBuffers=u,this.boundIndexBuffer=d,this.boundVertexOffset=p,this.boundDynamicVertexBuffers=g,o.enableAttributes(I,i),o.bind(),o.setVertexAttribPointers(I,i,p);for(const S of u)S.enableAttributes(I,i),S.bind(),S.setVertexAttribPointers(I,i,p);for(const S of g)S&&(S.enableAttributes(I,i),S.bind(),S.setVertexAttribPointers(I,i,p),v&&S.instanceCount&&S.setVertexAttribDivisor(I,i,v));d&&d.bind(),M.currentNumAttributes=w}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function $p(c,i){const o=Math.pow(2,i.canonical.z),u=i.canonical.y;return[new s.L(0,u/o).toLngLat().lat,new s.L(0,(u+1)/o).toLngLat().lat]}function Ql(c,i,o,u,d,p,g){const v=c.context,w=v.gl,M=o.hillshadeFBO;if(!M)return;c.prepareDrawTile();const I=c.isTileAffectedByFog(i),S=c.getOrCreateProgram("hillshade",{overrideFog:I});v.activeTexture.set(w.TEXTURE0),w.bindTexture(w.TEXTURE_2D,M.colorAttachment.get());const z=((V,B,G,K)=>{const q=G.paint.get("hillshade-shadow-color"),J=G.paint.get("hillshade-highlight-color"),j=G.paint.get("hillshade-accent-color"),Q=G.paint.get("hillshade-emissive-strength");let oe=s.bj(G.paint.get("hillshade-illumination-direction"));if(G.paint.get("hillshade-illumination-anchor")==="viewport")oe-=V.transform.angle;else if(V.style&&V.style.enable3dLights()&&V.style.directionalLight){const he=V.style.directionalLight.properties.get("direction"),we=s.bQ(he.x,he.y,he.z);oe=s.bj(we[1])}const le=!V.options.moving;return{u_matrix:K||V.transform.calculateProjMatrix(B.tileID.toUnwrapped(),le),u_image:0,u_latrange:$p(0,B.tileID),u_light:[G.paint.get("hillshade-exaggeration"),oe],u_shadow:q,u_highlight:J,u_emissive_strength:Q,u_accent:j}})(c,o,u,c.terrain?i.projMatrix:null);c.uploadCommonUniforms(v,S,i.toUnwrapped());const{tileBoundsBuffer:R,tileBoundsIndexBuffer:U,tileBoundsSegments:N}=c.getTileBoundsBuffers(o);S.draw(c,w.TRIANGLES,d,p,g,Rt.disabled,z,u.id,R,U,N)}function Ed(c,i,o){if(!i.needsDEMTextureUpload)return;const u=c.context,d=u.gl;u.pixelStoreUnpackPremultiplyAlpha.set(!1),i.demTexture=i.demTexture||c.getTileTexture(o.stride);const p=o.getPixels();i.demTexture?i.demTexture.update(p,{premultiply:!1}):i.demTexture=new s.T(u,p,d.R32F,{premultiply:!1}),i.needsDEMTextureUpload=!1}function Au(c,i,o){const u=c.context,d=u.gl;if(!i.dem)return;const p=i.dem;if(u.activeTexture.set(d.TEXTURE1),Ed(c,i,p),!i.demTexture)return;i.demTexture.bind(d.NEAREST,d.CLAMP_TO_EDGE);const g=p.dim;u.activeTexture.set(d.TEXTURE0);let v=i.hillshadeFBO;if(!v){const z=new s.T(u,{width:g,height:g,data:null},d.RGBA);z.bind(d.LINEAR,d.CLAMP_TO_EDGE),v=i.hillshadeFBO=u.createFramebuffer(g,g,!0,"renderbuffer"),v.colorAttachment.set(z.texture)}u.bindFramebuffer.set(v.framebuffer),u.viewport.set([0,0,g,g]);const{tileBoundsBuffer:w,tileBoundsIndexBuffer:M,tileBoundsSegments:I}=c.getMercatorTileBoundsBuffers(),S=[];c.linearFloatFilteringSupported()&&S.push("TERRAIN_DEM_FLOAT_FORMAT"),c.getOrCreateProgram("hillshadePrepare",{defines:S}).draw(c,d.TRIANGLES,zt.disabled,jt.disabled,rr.unblended,Rt.disabled,((z,R)=>{const U=R.stride,N=s.a6.create();return s.a6.ortho(N,0,s.V,-s.V,0,0,1),s.a6.translate(N,N,[0,-s.V,0]),{u_matrix:N,u_image:1,u_dimension:[U,U],u_zoom:z.overscaledZ}})(i.tileID,p),o.id,w,M,I),i.needsHillshadePrepare=!1}const Md=c=>({u_matrix:new s.bK(c),u_image0:new s.bO(c),u_skirt_height:new s.bN(c),u_ground_shadow_factor:new s.bM(c)}),ec=(c,i,o)=>({u_matrix:c,u_image0:0,u_skirt_height:i,u_ground_shadow_factor:o}),Id=(c,i,o,u,d,p,g,v,w,M,I,S,z,R,U,N)=>({u_proj_matrix:Float32Array.from(c),u_globe_matrix:i,u_normalize_matrix:Float32Array.from(u),u_merc_matrix:o,u_zoom_transition:d,u_merc_center:p,u_image0:0,u_frustum_tl:g,u_frustum_tr:v,u_frustum_br:w,u_frustum_bl:M,u_globe_pos:I,u_globe_radius:S,u_viewport:z,u_grid_matrix:N?Float32Array.from(N):new Float32Array(9),u_skirt_height:R,u_far_z_cutoff:U});function $a(c,i){return c!=null&&i!=null&&!(!c.hasData()||!i.hasData())&&c.demTexture!=null&&i.demTexture!=null&&c.tileID.key!==i.tileID.key}const na=new class{constructor(){this.operations={}}newMorphing(c,i,o,u,d){if(c in this.operations){const p=this.operations[c];p.to.tileID.key!==o.tileID.key&&(p.queued=o)}else this.operations[c]={startTime:u,phase:0,duration:d,from:i,to:o,queued:null}}getMorphValuesForProxy(c){if(!(c in this.operations))return null;const i=this.operations[c];return{from:i.from,to:i.to,phase:i.phase}}update(c){for(const i in this.operations){const o=this.operations[i];for(o.phase=(c-o.startTime)/o.duration;o.phase>=1||!this._validOp(o);)if(!this._nextOp(o,c)){delete this.operations[i];break}}}_nextOp(c,i){return!!c.queued&&(c.from=c.to,c.to=c.queued,c.queued=null,c.phase=0,c.startTime=i,!0)}_validOp(c){return c.from.hasData()&&c.to.hasData()}},Su={0:null,1:"TERRAIN_VERTEX_MORPHING"};function Pu(c,i,o){if(i===0)return 0;const u=i<1&&o===514?.25/i:1;return 6*Math.pow(1.5,22-c)*Math.max(i,1)*u}function oa(c,i){const o=1<<c.z;return!i&&(c.x===0||c.x===o-1)||c.y===0||c.y===o-1}const Lu=c=>({u_matrix:c});function Du(c,i,o,u,d){if(d>0){const p=s.f.now(),g=(p-c.timeAdded)/d,v=i?(p-i.timeAdded)/d:-1,w=o.getSource(),M=u.coveringZoomLevel({tileSize:w.tileSize,roundZoom:w.roundZoom}),I=!i||Math.abs(i.tileID.overscaledZ-M)>Math.abs(c.tileID.overscaledZ-M),S=I&&c.refreshedUponExpiration?1:s.aa(I?g:1-v,0,1);return c.refreshedUponExpiration&&g>=1&&(c.refreshedUponExpiration=!1),i?{opacity:1,mix:1-S}:{opacity:S,mix:0}}return{opacity:1,mix:0}}class qp extends Vn{constructor(i){const o={type:"raster-dem",maxzoom:i.transform.maxZoom},u=new s.bW(s.bX(),null),d=bi("mock-dem",o,u,i.style);super("mock-dem",d,!1),d.setEventedParent(this),this._sourceLoaded=!0}_loadTile(i,o){i.state="loaded",o(null)}}class Wp extends Vn{constructor(i){const o=bi("proxy",{type:"geojson",maxzoom:i.transform.maxZoom},new s.bW(s.bX(),null),i.style);super("proxy",o,!1),o.setEventedParent(this),this.map=this.getSource().map=i,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(i,o,u){if(i.freezeTileCoverage)return;this.transform=i;const d=i.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((p,g)=>{if(p[g.key]="",!this._tiles[g.key]){const v=new Bo(g,this._source.tileSize*g.overscaleFactor(),i.tileZoom);v.state="loaded",this._tiles[g.key]=v}return p},{});for(const p in this._tiles)p in d||(this.freeFBO(p),this._tiles[p].unloadVectorData(),delete this._tiles[p])}freeFBO(i){const o=this.proxyCachedFBO[i];if(o!==void 0){const u=Object.values(o);this.renderCachePool.push(...u),delete this.proxyCachedFBO[i]}}deallocRenderCache(){this.renderCache.forEach(i=>i.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Cd extends s.am{constructor(i,o,u){super(i.overscaledZ,i.wrap,i.canonical.z,i.canonical.x,i.canonical.y),this.proxyTileKey=o,this.projMatrix=u}}class Hp extends s.ck{constructor(i,o){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},i.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),i.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),i.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=i,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[u,d,p]=function(w){const M=new s.aN,I=new s.aw,S=131;M.reserve(17161),I.reserve(33800);const z=s.V/128,R=s.V+z/2,U=R+z;for(let V=-z;V<U;V+=z)for(let B=-z;B<U;B+=z){const G=B<0||B>R||V<0||V>R?24575:0,K=s.aa(Math.round(B),0,s.V),q=s.aa(Math.round(V),0,s.V);M.emplaceBack(K+G,q)}const N=(V,B)=>{const G=B*S+V;I.emplaceBack(G+1,G,G+S),I.emplaceBack(G+S,G+S+1,G+1)};for(let V=1;V<129;V++)for(let B=1;B<129;B++)N(B,V);return[0,129].forEach(V=>{for(let B=0;B<130;B++)N(B,V),N(V,B)}),[M,I,32768]}(),g=i.context;this.gridBuffer=g.createVertexBuffer(u,s.aP.members),this.gridIndexBuffer=g.createIndexBuffer(d),this.gridSegments=s.aB.simpleSegment(0,0,u.length,d.length),this.gridNoSkirtSegments=s.aB.simpleSegment(0,0,u.length,p),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new Wp(o.map),this.orthoMatrix=s.a6.create(),s.a6.ortho(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,s.V,0,s.V,0,1);const v=g.gl;this._overlapStencilMode=new jt({func:v.GEQUAL,mask:255},0,255,v.KEEP,v.KEEP,v.REPLACE),this._previousZoom=i.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=o,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new qp(o.map),this._pendingGroundEffectLayers=[]}set style(i){i.on("data",this._onStyleDataEvent.bind(this)),this._style=i,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(i,o,u){if(i&&i.terrain){this._style!==i&&(this.style=i,this._evaluationZoom=void 0);const d=i.terrain.properties,p=i.terrain.drapeRenderMode===0,g=i.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=s.f.now();const v=i.terrain&&i.terrain.scope,w=d.get("source"),M=p?this._mockSourceCache:i.getSourceCache(w,v);if(!M)return void s.w(`Couldn't find terrain source "${w}".`);if(this.sourceCache=M,this._exaggeration=g?this.calculateExaggeration(o):d.get("exaggeration"),!o.projection.requiresDraping&&g&&this._exaggeration===0)return void this._disable();this.enabled=!0;const I=()=>{this.sourceCache.used&&s.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const S=this.getScaledDemTileSize();this.sourceCache.update(o,S,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,I(),this._initializing=!0),I(),o.updateElevation(!0,u),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(o),this._emptyDEMTextureDirty=!0,this._previousZoom=o.zoom}else this._disable()}calculateExaggeration(i){const o=this._previousCameraAltitude,u=i.getFreeCameraOptions().position.z/i.pixelsPerMeter*i.worldSize;this._previousCameraAltitude=u;const d=o!=null?u-o:Number.MAX_VALUE;if(Math.abs(d)<2)return this._exaggeration;const p=i.zoom,g=this._style.terrain;if(!this._previousUpdateTimestamp)return g.getExaggeration(p);let v=p-this._previousZoom;const w=this._previousUpdateTimestamp;let M=p;this._evaluationZoom!=null&&(M=this._evaluationZoom,Math.abs(p-M)>.5&&(v=.5*(p-M+v)),v*d<0&&(M+=v)),this._evaluationZoom=M;const I=g.getExaggeration(M),S=I===g.getExaggeration(Math.max(0,M-.1));if(S&&Math.abs(I-this._exaggeration)<.01)return I;let z=Math.min(.1,.00375*(this._updateTimestamp-w));return(S||I<.1||Math.abs(v)<1e-4)&&(z=Math.min(.2,4*z)),s.U(this._exaggeration,I,z)}resetTileLookupCache(i){this._findCoveringTileCache[i]={}}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(i){i.coord&&i.dataType==="source"?this._clearRenderCacheForTile(i.sourceCacheId,i.coord):i.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const i in this._style._mergedSourceCaches)this._style._mergedSourceCaches[i].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this._emptyDepthBufferTexture&&this._emptyDepthBufferTexture.destroy(),this.pool.forEach(i=>i.fb.destroy()),this.pool=[],this._depthFBO&&(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this._exaggeration}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const i=2*this.proxySourceCache.getSource().tileSize;return[i,i]}set useVertexMorphing(i){this._useVertexMorphing=i}updateTileBinding(i){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const o=this.proxySourceCache,u=this.painter.transform;this._initializing&&(this._initializing=u._centerAltitude===0&&this.getAtPointOrZero(s.L.fromLngLat(u.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const d=this.proxyCoords=o.getIds().map(w=>{const M=o.getTileByID(w).tileID;return M.projMatrix=u.calculateProjMatrix(M.toUnwrapped()),M});(function(w,M){const I=M.transform.pointCoordinate(M.transform.getCameraPoint()),S=new s.P(I.x,I.y);w.sort((z,R)=>{if(R.overscaledZ-z.overscaledZ)return R.overscaledZ-z.overscaledZ;const U=new s.P(z.canonical.x+(1<<z.canonical.z)*z.wrap,z.canonical.y),N=new s.P(R.canonical.x+(1<<R.canonical.z)*R.wrap,R.canonical.y),V=S.mult(1<<z.canonical.z);return V.x-=.5,V.y-=.5,V.distSqr(U)-V.distSqr(N)})})(d,this.painter);const p=this.proxyToSource||{};this.proxyToSource={},d.forEach(w=>{this.proxyToSource[w.key]={}}),this.terrainTileForTile={};const g=this._style._mergedSourceCaches;for(const w in g){const M=g[w];if(!M.used||(M!==this.sourceCache&&this.resetTileLookupCache(M.id),this._setupProxiedCoordsForOrtho(M,i[w],p),M.usedForTerrain))continue;const I=i[w];M.getSource().reparseOverscaled&&this._assignTerrainTiles(I)}this.proxiedCoords[o.id]=d.map(w=>new Cd(w,w.key,this.orthoMatrix)),this._assignTerrainTiles(d),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(p),this.renderingToTexture=!1;const v={};this._visibleDemTiles=[];for(const w of this.proxyCoords){const M=this.terrainTileForTile[w.key];if(!M)continue;const I=M.tileID.key;I in v||(this._visibleDemTiles.push(M),v[I]=I)}}_assignTerrainTiles(i){this._initializing||i.forEach(o=>{if(this.terrainTileForTile[o.key])return;const u=this._findTileCoveringTileID(o,this.sourceCache);u&&(this.terrainTileForTile[o.key]=u)})}_prepareDEMTextures(){const i=this.painter.context,o=i.gl;for(const u in this.terrainTileForTile){const d=this.terrainTileForTile[u],p=d.dem;!p||d.demTexture&&!d.needsDEMTextureUpload||(i.activeTexture.set(o.TEXTURE1),Ed(this.painter,d,p))}}_prepareDemTileUniforms(i,o,u,d){if(!o||o.demTexture==null)return!1;const p=i.tileID.canonical,g=Math.pow(2,o.tileID.canonical.z-p.z),v=d||"";return u[`u_dem_tl${v}`]=[p.x*g%1,p.y*g%1],u[`u_dem_scale${v}`]=g,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}get emptyDepthBufferTexture(){const i=this.painter.context,o=i.gl;if(!this._emptyDepthBufferTexture){const u=new s.h({width:1,height:1},Uint8Array.of(255,255,255,255));this._emptyDepthBufferTexture=new s.T(i,u,o.RGBA,{premultiply:!1})}return this._emptyDepthBufferTexture}_getLoadedAreaMinimum(){let i=0;const o=this._visibleDemTiles.reduce((u,d)=>{if(!d.dem)return u;const p=d.dem.tree.minimums[0];return p>0&&i++,u+p},0);return i?o/i:0}_updateEmptyDEMTexture(){const i=this.painter.context,o=i.gl;i.activeTexture.set(o.TEXTURE2);const u=this._getLoadedAreaMinimum(),[d,p]=(()=>{const v=new s.cm({width:1,height:1},new Float32Array([u]));return[o.R32F,v]})();this._emptyDEMTextureDirty=!1;let g=this._emptyDEMTexture;return g?g.update(p,{premultiply:!1}):g=this._emptyDEMTexture=new s.T(i,p,d,{premultiply:!1}),g}setupElevationDraw(i,o,u){const d=this.painter.context,p=d.gl,g={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_exaggeration:0};g.u_exaggeration=this.exaggeration();let v=null,w=null,M=1;if(u&&u.morphing&&this._useVertexMorphing){const z=u.morphing.srcDemTile,R=u.morphing.dstDemTile;M=u.morphing.phase,z&&R&&(this._prepareDemTileUniforms(i,z,g,"_prev")&&(w=z),this._prepareDemTileUniforms(i,R,g)&&(v=R))}const I=z=>z&&z.demTexture&&this.painter.linearFloatFilteringSupported()?p.LINEAR:p.NEAREST,S=z=>{g.u_dem_size=z.size[0]===1?1:z.size[0]-2};if(w&&v)d.activeTexture.set(p.TEXTURE2),v.demTexture.bind(I(v),p.CLAMP_TO_EDGE),d.activeTexture.set(p.TEXTURE4),w.demTexture.bind(I(w),p.CLAMP_TO_EDGE),v.demTexture&&S(v.demTexture),g.u_dem_lerp=M;else{v=this.terrainTileForTile[i.tileID.key],d.activeTexture.set(p.TEXTURE2);const z=this._prepareDemTileUniforms(i,v,g)?v.demTexture:this.emptyDEMTexture;z.bind(I(v),p.CLAMP_TO_EDGE),S(z)}if(d.activeTexture.set(p.TEXTURE3),u&&u.useDepthForOcclusion?(this._depthTexture&&this._depthTexture.bind(p.NEAREST,p.CLAMP_TO_EDGE),this._depthFBO&&(g.u_depth_size_inv=[1/this._depthFBO.width,1/this._depthFBO.height])):(this.emptyDepthBufferTexture.bind(p.NEAREST,p.CLAMP_TO_EDGE),g.u_depth_size_inv=[1,1]),u&&u.useMeterToDem&&v){const z=(1<<v.tileID.canonical.z)*s.bl(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;g.u_meter_to_dem=z}if(u&&u.labelPlaneMatrixInv&&(g.u_label_plane_matrix_inv=u.labelPlaneMatrixInv),o.setTerrainUniformValues(d,g),this.painter.transform.projection.name==="globe"){const z=this.globeUniformValues(this.painter.transform,i.tileID.canonical,u&&u.useDenormalizedUpVectorScale);o.setGlobeUniformValues(d,z)}}globeUniformValues(i,o,u){const d=i.projection;return{u_tile_tl_up:d.upVector(o,0,0),u_tile_tr_up:d.upVector(o,s.V,0),u_tile_br_up:d.upVector(o,s.V,s.V),u_tile_bl_up:d.upVector(o,0,s.V),u_tile_up_scale:u?s.cl(1):d.upVectorScale(o,i.center.lat,i.worldSize).metersToTile}}renderToBackBuffer(i){const o=this.painter,u=this.painter.context;i.length!==0&&(u.bindFramebuffer.set(null),u.viewport.set([0,0,o.width,o.height]),o.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(d,p,g,v,w){if(d.transform.projection.name==="globe")(function(M,I,S,z,R){const U=M.context,N=U.gl;let V,B;const G=M.transform,K=s.cd(M,U,G),q=(Ae,Ie)=>{if(B===Ie)return;const Ue=[Su[Ie],"PROJECTION_GLOBE_VIEW"];K&&Ue.push("CUSTOM_ANTIALIASING");const ge=M.isTileAffectedByFog(Ae);V=M.getOrCreateProgram("globeRaster",{defines:Ue,overrideFog:ge}),B=Ie},J=M.colorModeForRenderPass(),j=new zt(N.LEQUAL,zt.ReadWrite,M.depthRangeFor3D);na.update(R);const Q=s.ce(G),oe=[s.a5(G.center.lng),s.ae(G.center.lat)],le=M.globeSharedBuffers,he=[G.width*s.f.devicePixelRatio,G.height*s.f.devicePixelRatio],we=Float32Array.from(G.globeMatrix),me={useDenormalizedUpVectorScale:!0};{const Ae=M.transform,Ie=Pu(Ae.zoom,I.exaggeration(),I.sourceCache._source.tileSize);B=-1;const Ue=N.TRIANGLES;for(const ge of z){const Ee=S.getTile(ge),ue=jt.disabled,ve=I.prevTerrainTileForTile[ge.key],Ve=I.terrainTileForTile[ge.key];$a(ve,Ve)&&na.newMorphing(ge.key,ve,Ve,R,250),U.activeTexture.set(N.TEXTURE0),Ee.texture&&Ee.texture.bind(N.LINEAR,N.CLAMP_TO_EDGE);const Ye=na.getMorphValuesForProxy(ge.key),Xe=Ye?1:0;Ye&&s.j(me,{morphing:{srcDemTile:Ye.from,dstDemTile:Ye.to,phase:s.cc(Ye.phase)}});const ot=s.cf(ge.canonical),yt=s.cg(ot.getCenter().lat),Pt=s.ch(ge.canonical,ot,yt,Ae.worldSize/Ae._pixelsPerMercatorPixel),Tt=s.aT(s.ci(ge.canonical)),It=Id(Ae.expandedFarZProjMatrix,we,Q,Tt,s.S(Ae.zoom),oe,Ae.frustumCorners.TL,Ae.frustumCorners.TR,Ae.frustumCorners.BR,Ae.frustumCorners.BL,Ae.globeCenterInViewSpace,Ae.globeRadius,he,Ie,Ae._farZ,Pt);if(q(ge,Xe),V&&(I.setupElevationDraw(Ee,V,me),M.uploadCommonUniforms(U,V,ge.toUnwrapped()),le)){const[Yt,Vt,qt]=le.getGridBuffers(yt,Ie!==0);V.draw(M,Ue,j,ue,J,Rt.backCCW,It,"globe_raster",Yt,Vt,qt)}}}if(le&&(M.renderDefaultNorthPole||M.renderDefaultSouthPole)){const Ae=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];K&&Ae.push("CUSTOM_ANTIALIASING"),V=M.getOrCreateProgram("globeRaster",{defines:Ae});for(const Ie of z){const{x:Ue,y:ge,z:Ee}=Ie.canonical,ue=ge===0,ve=ge===(1<<Ee)-1,[Ve,Ye,Xe,ot]=le.getPoleBuffers(Ee,!1);if(ot&&(ue||ve)){const yt=S.getTile(Ie);U.activeTexture.set(N.TEXTURE0),yt.texture&&yt.texture.bind(N.LINEAR,N.CLAMP_TO_EDGE);let Pt=s.cj(Ee,Ue,G);const Tt=s.aT(s.ci(Ie.canonical)),It=(Yt,Vt)=>Yt.draw(M,N.TRIANGLES,j,jt.disabled,J,Rt.disabled,Id(G.expandedFarZProjMatrix,Pt,Pt,Tt,0,oe,G.frustumCorners.TL,G.frustumCorners.TR,G.frustumCorners.BR,G.frustumCorners.BL,G.globeCenterInViewSpace,G.globeRadius,he,0,G._farZ),"globe_pole_raster",Vt,Xe,ot);I.setupElevationDraw(yt,V,me),M.uploadCommonUniforms(U,V,Ie.toUnwrapped()),ue&&M.renderDefaultNorthPole&&It(V,Ve),ve&&M.renderDefaultSouthPole&&(Pt=s.a6.scale(s.a6.create(),Pt,[1,-1,1]),It(V,Ye))}}}})(d,p,g,v,w);else{const M=d.context,I=M.gl;let S,z;const R=d.shadowRenderer,U=Zo(d,d.longestCutoffRange),N=J=>{if(z===J)return;const j=[];j.push(Su[J]),U.shouldRenderCutoff&&j.push("RENDER_CUTOFF"),S=d.getOrCreateProgram("terrainRaster",{defines:j}),z=J},V=d.colorModeForRenderPass(),B=new zt(I.LEQUAL,zt.ReadWrite,d.depthRangeFor3D);na.update(w);const G=d.transform,K=Pu(G.zoom,p.exaggeration(),p.sourceCache._source.tileSize);let q=[0,0,0];if(R){const J=d.style.directionalLight,j=d.style.ambientLight;J&&j&&(q=Za(J,j))}{z=-1;const J=I.TRIANGLES,[j,Q]=[p.gridIndexBuffer,p.gridSegments];for(const oe of v){const le=g.getTile(oe),he=jt.disabled,we=p.prevTerrainTileForTile[oe.key],me=p.terrainTileForTile[oe.key];$a(we,me)&&na.newMorphing(oe.key,we,me,w,250),M.activeTexture.set(I.TEXTURE0),le.texture&&le.texture.bind(I.LINEAR,I.CLAMP_TO_EDGE);const Ae=na.getMorphValuesForProxy(oe.key),Ie=Ae?1:0;let Ue;Ae&&(Ue={morphing:{srcDemTile:Ae.from,dstDemTile:Ae.to,phase:s.cc(Ae.phase)}});const ge=ec(oe.projMatrix,oa(oe.canonical,G.renderWorldCopies)?K/10:K,q);if(N(Ie),!S)continue;p.setupElevationDraw(le,S,Ue);const Ee=oe.toUnwrapped();R&&R.setupShadows(Ee,S),d.uploadCommonUniforms(M,S,Ee,null,U),S.draw(d,J,B,he,V,Rt.backCCW,ge,"terrain_raster",p.gridBuffer,j,Q)}}}}(o,this,this.proxySourceCache,i,this._updateTimestamp),this.renderingToTexture=!0,o.gpuTimingDeferredRenderEnd(),i.splice(0,i.length))}renderBatch(i){if(this._drapedRenderBatches.length===0)return i+1;this.renderingToTexture=!0;const o=this.painter,u=this.painter.context,d=this.proxySourceCache,p=this.proxiedCoords[d.id],g=this._drapedRenderBatches.shift(),v=o.style.order,w=[];let M=0;for(const I of p){const S=d.getTileByID(I.proxyTileKey),z=d.proxyCachedFBO[I.key]?d.proxyCachedFBO[I.key][i]:void 0,R=z!==void 0?d.renderCache[z]:this.pool[M++],U=z!==void 0;if(S.texture=R.tex,U&&!R.dirty){w.push(S.tileID);continue}let N;u.bindFramebuffer.set(R.fb.framebuffer),this.renderedToTile=!1,R.dirty&&(u.clear({color:s.ax.transparent,stencil:0}),R.dirty=!1);for(let V=g.start;V<=g.end;++V){const B=o.style._mergedLayers[v[V]];if(B.isHidden(o.transform.zoom))continue;const G=o.style.getLayerSourceCache(B),K=G?this.proxyToSource[I.key][G.id]:[I];if(!K)continue;const q=K;u.viewport.set([0,0,R.fb.width,R.fb.height]),N!==(G?G.id:null)&&(this._setupStencil(R,K,B,G),N=G?G.id:null),o.renderLayer(o,G,B,q)}if(this._drapedRenderBatches.length===0)for(const V of this._pendingGroundEffectLayers){const B=o.style._mergedLayers[v[V]];if(B.isHidden(o.transform.zoom))continue;const G=o.style.getLayerSourceCache(B),K=G?this.proxyToSource[I.key][G.id]:[I];if(!K)continue;const q=K;u.viewport.set([0,0,R.fb.width,R.fb.height]),N!==(G?G.id:null)&&(this._setupStencil(R,K,B,G),N=G?G.id:null),o.renderLayer(o,G,B,q)}this.renderedToTile?(R.dirty=!0,w.push(S.tileID)):U||--M,M===5&&(M=0,this.renderToBackBuffer(w))}return this.renderToBackBuffer(w),this.renderingToTexture=!1,u.bindFramebuffer.set(null),u.viewport.set([0,0,o.width,o.height]),g.end+1}postRender(){}isLayerOrderingCorrect(i){const o=i.order.length;let u=-1,d=o;for(let p=0;p<o;++p)this._style.isLayerDraped(i._mergedLayers[i.order[p]])?u=Math.max(u,p):d=Math.min(d,p);return d>u}getMinElevationBelowMSL(){let i=0;return this._visibleDemTiles.filter(o=>o.dem).forEach(o=>{i=Math.min(i,o.dem.tree.minimums[0])}),i===0?i:(i-30)*this._exaggeration}raycast(i,o,u){if(!this._visibleDemTiles)return null;const d=this._visibleDemTiles.filter(p=>p.dem).map(p=>{const g=p.tileID,v=1<<g.overscaledZ,{x:w,y:M}=g.canonical,I=w/v,S=(w+1)/v,z=M/v,R=(M+1)/v;return{minx:I,miny:z,maxx:S,maxy:R,t:p.dem.tree.raycastRoot(I,z,S,R,i,o,u),tile:p}});d.sort((p,g)=>(p.t!==null?p.t:Number.MAX_VALUE)-(g.t!==null?g.t:Number.MAX_VALUE));for(const p of d){if(p.t==null)return null;const g=p.tile.dem.tree.raycast(p.minx,p.miny,p.maxx,p.maxy,i,o,u);if(g!=null)return g}return null}_createFBO(){const i=this.painter.context,o=i.gl,u=this.drapeBufferSize;i.activeTexture.set(o.TEXTURE0);const d=new s.T(i,{width:u[0],height:u[1],data:null},o.RGBA);d.bind(o.LINEAR,o.CLAMP_TO_EDGE);const p=i.createFramebuffer(u[0],u[1],!0,null);return p.colorAttachment.set(d.texture),p.depthAttachment=new sn(i,p.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=i.createRenderbuffer(i.gl.DEPTH_STENCIL,u[0],u[1]),this._stencilRef=0,p.depthAttachment.set(this._sharedDepthStencil),i.clear({stencil:0})):p.depthAttachment.set(this._sharedDepthStencil),i.extTextureFilterAnisotropic&&o.texParameterf(o.TEXTURE_2D,i.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,i.extTextureFilterAnisotropicMax),{fb:p,tex:d,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(const i in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[i].hasTransition())return!0;return this._style.order.some(i=>{const o=this._style._mergedLayers[i],u=o.isHidden(this.painter.transform.zoom);return o.type==="custom"?!u&&o.shouldRedrape():!u&&o.hasTransition()})}_clearLineLayersFromRenderCache(){let i=!1;for(const u of this._style.getSources())if(u instanceof st){i=!0;break}if(!i)return;const o={};for(let u=0;u<this._style.order.length;++u){const d=this._style._mergedLayers[this._style.order[u]],p=this._style.getLayerSourceCache(d);if(p&&!o[p.id]&&!d.isHidden(this.painter.transform.zoom)&&d.type==="line"&&d.widthExpression()instanceof s.Z){o[p.id]=!0;for(const g of this.proxyCoords){const v=this.proxyToSource[g.key][p.id];if(v)for(const w of v)this._clearRenderCacheForTile(p.id,w)}}}}_clearRasterLayersFromRenderCache(){let i=!1;for(const u in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[u]._source instanceof at){i=!0;break}if(!i)return;const o={};for(let u=0;u<this._style.order.length;++u){const d=this._style._mergedLayers[this._style.order[u]],p=this._style.getLayerSourceCache(d);if(!p||o[p.id]||d.isHidden(this.painter.transform.zoom)||d.type!=="raster")continue;const g=d.paint.get("raster-fade-duration");for(const v of this.proxyCoords){const w=this.proxyToSource[v.key][p.id];if(w)for(const M of w){const I=Du(p.getTile(M),p.findLoadedParent(M,0),p,this.painter.transform,g);(I.opacity!==1||I.mix!==0)&&this._clearRenderCacheForTile(p.id,M)}}}}_setupDrapedRenderBatches(){const i=this._style.order,o=i.length;if(o===0)return;const u=[];this._pendingGroundEffectLayers=[];let d,p=0,g=this._style._mergedLayers[i[p]];for(;!this._style.isLayerDraped(g)&&g.isHidden(this.painter.transform.zoom)&&++p<o;)g=this._style._mergedLayers[i[p]];for(;p<o;++p){const v=this._style._mergedLayers[i[p]];v.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(v)?d===void 0&&(d=p):(v.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(p),d!==void 0&&(u.push({start:d,end:p-1}),d=void 0)))}if(d!==void 0&&u.push({start:d,end:p-1}),u.length!==0){const v=u[u.length-1];this._pendingGroundEffectLayers.every(w=>w>v.end)||s.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=u}_setupRenderCache(i){const o=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,o.renderCache.length>o.renderCachePool.length){const g=Object.values(o.proxyCachedFBO);o.proxyCachedFBO={};for(let v=0;v<g.length;++v){const w=Object.values(g[v]);o.renderCachePool.push(...w)}}return}this._clearRasterLayersFromRenderCache();const u=this.proxyCoords,d=this._tilesDirty;for(let g=u.length-1;g>=0;g--){const v=u[g];if(o.getTileByID(v.key),o.proxyCachedFBO[v.key]!==void 0){const w=i[v.key],M=this.proxyToSource[v.key];let I=0;for(const S in M){const z=M[S],R=w[S];if(!R||R.length!==z.length||z.some((U,N)=>U!==R[N]||d[S]&&d[S].hasOwnProperty(U.key))){I=-1;break}++I}for(const S in o.proxyCachedFBO[v.key])o.renderCache[o.proxyCachedFBO[v.key][S]].dirty=I<0||I!==Object.values(w).length}}const p=[...this._drapedRenderBatches];p.sort((g,v)=>v.end-v.start-(g.end-g.start));for(const g of p)for(const v of u){if(o.proxyCachedFBO[v.key])continue;let w=o.renderCachePool.pop();w===void 0&&o.renderCache.length<50&&(w=o.renderCache.length,o.renderCache.push(this._createFBO())),w!==void 0&&(o.proxyCachedFBO[v.key]={},o.proxyCachedFBO[v.key][g.start]=w,o.renderCache[w].dirty=!0)}this._tilesDirty={}}_setupStencil(i,o,u,d){if(!d||!this._sourceTilesOverlap[d.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const p=this.painter.context,g=p.gl;if(o.length<=1)return void(this._overlapStencilType=!1);let v;if(u.isTileClipped())v=o.length,this._overlapStencilMode.test={func:g.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(o[0].overscaledZ>o[o.length-1].overscaledZ))return void(this._overlapStencilType=!1);v=1,this._overlapStencilMode.test={func:g.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+v>255&&(p.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=v,this._overlapStencilMode.ref=this._stencilRef,u.isTileClipped()&&this._renderTileClippingMasks(o,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(i){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[i.key]),this._overlapStencilMode):jt.disabled}_renderTileClippingMasks(i,o){const u=this.painter,d=this.painter.context,p=d.gl;u._tileClippingMaskIDs={},d.setColorMode(rr.disabled),d.setDepthMode(zt.disabled);const g=u.getOrCreateProgram("clippingMask");for(const v of i){const w=u._tileClippingMaskIDs[v.key]=--o;g.draw(u,p.TRIANGLES,zt.disabled,new jt({func:p.ALWAYS,mask:0},w,255,p.KEEP,p.KEEP,p.REPLACE),rr.disabled,Rt.disabled,Lu(v.projMatrix),"$clipping",u.tileExtentBuffer,u.quadTriangleIndexBuffer,u.tileExtentSegments)}}pointCoordinate(i){const o=this.painter.transform;if(i.x<0||i.x>o.width||i.y<0||i.y>o.height)return null;const u=[i.x,i.y,1,1];s.a7.transformMat4(u,u,o.pixelMatrixInverse),s.a7.scale(u,u,1/u[3]),u[0]/=o.worldSize,u[1]/=o.worldSize;const d=o._camera.position,p=s.bl(1,o.center.lat),g=[d[0],d[1],d[2]/p,0],v=s.N.subtract([],u.slice(0,3),g);s.N.normalize(v,v);const w=this.raycast(g,v,this._exaggeration);return w!==null&&w?(s.N.scaleAndAdd(g,g,v,w),g[3]=g[2],g[2]*=p,g):null}drawDepth(){const i=this.painter,o=i.context,u=this.proxySourceCache,d=Math.ceil(i.width),p=Math.ceil(i.height);if(!this._depthFBO||this._depthFBO.width===d&&this._depthFBO.height===p||(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),!this._depthFBO){const g=o.gl,v=o.createFramebuffer(d,p,!0,"renderbuffer");o.activeTexture.set(g.TEXTURE0);const w=new s.T(o,{width:d,height:p,data:null},g.RGBA);w.bind(g.NEAREST,g.CLAMP_TO_EDGE),v.colorAttachment.set(w.texture);const M=o.createRenderbuffer(o.gl.DEPTH_COMPONENT16,d,p);v.depthAttachment.set(M),this._depthFBO=v,this._depthTexture=w}o.bindFramebuffer.set(this._depthFBO.framebuffer),o.viewport.set([0,0,d,p]),function(g,v,w,M){if(g.transform.projection.name==="globe")return;const I=g.context,S=I.gl;I.clear({depth:1});const z=g.getOrCreateProgram("terrainDepth"),R=new zt(S.LESS,zt.ReadWrite,g.depthRangeFor3D);for(const U of M){const N=w.getTile(U),V=ec(U.projMatrix,0,[0,0,0]);v.setupElevationDraw(N,z),z.draw(g,S.TRIANGLES,R,jt.disabled,rr.unblended,Rt.backCCW,V,"terrain_depth",v.gridBuffer,v.gridIndexBuffer,v.gridNoSkirtSegments)}}(i,this,u,this.proxyCoords)}_setupProxiedCoordsForOrtho(i,o,u){if(i.getSource()instanceof s.ap)return this._setupProxiedCoordsForImageSource(i,o,u);this._findCoveringTileCache[i.id]=this._findCoveringTileCache[i.id]||{};const d=this.proxiedCoords[i.id]=[],p=this.proxyCoords;for(let w=0;w<p.length;w++){const M=p[w],I=this._findTileCoveringTileID(M,i);if(I){const S=this._createProxiedId(M,I,u[M.key]&&u[M.key][i.id]);d.push(S),this.proxyToSource[M.key][i.id]=[S]}}let g=!1;const v=new Set;for(let w=0;w<o.length;w++){const M=i.getTile(o[w]);if(!M||!M.hasData())continue;const I=this._findTileCoveringTileID(M.tileID,this.proxySourceCache);if(I&&I.tileID.canonical.z!==M.tileID.canonical.z){const S=this.proxyToSource[I.tileID.key][i.id],z=this._createProxiedId(I.tileID,M,u[I.tileID.key]&&u[I.tileID.key][i.id]);S?S.splice(S.length-1,0,z):this.proxyToSource[I.tileID.key][i.id]=[z];const R=this.proxyToSource[I.tileID.key][i.id];v.has(R)||v.add(R),d.push(z),g=!0}}if(this._sourceTilesOverlap[i.id]=g,g&&this._debugParams.sortTilesHiZFirst)for(const w of v)w.sort((M,I)=>I.overscaledZ-M.overscaledZ)}_setupProxiedCoordsForImageSource(i,o,u){if(!i.getSource().loaded())return;const d=this.proxiedCoords[i.id]=[],p=this.proxyCoords,g=i.getSource(),v=g.tileID;if(!v)return;const w=new s.P(v.x,v.y)._div(1<<v.z),M=g.coordinates.map(s.L.fromLngLat).reduce((S,z)=>(S.min.x=Math.min(S.min.x,z.x-w.x),S.min.y=Math.min(S.min.y,z.y-w.y),S.max.x=Math.max(S.max.x,z.x-w.x),S.max.y=Math.max(S.max.y,z.y-w.y),S),{min:new s.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new s.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),I=(S,z)=>{const R=S.wrap+S.canonical.x/(1<<S.canonical.z),U=S.canonical.y/(1<<S.canonical.z),N=s.V/(1<<S.canonical.z),V=z.wrap+z.canonical.x/(1<<z.canonical.z),B=z.canonical.y/(1<<z.canonical.z);return R+N<V+M.min.x||R>V+M.max.x||U+N<B+M.min.y||U>B+M.max.y};for(let S=0;S<p.length;S++){const z=p[S];for(let R=0;R<o.length;R++){const U=i.getTile(o[R]);if(!U||!U.hasData()||I(z,U.tileID))continue;const N=this._createProxiedId(z,U,u[z.key]&&u[z.key][i.id]),V=this.proxyToSource[z.key][i.id];V?V.push(N):this.proxyToSource[z.key][i.id]=[N],d.push(N)}}}_createProxiedId(i,o,u){let d=this.orthoMatrix;if(u){const p=u.find(g=>g.key===o.tileID.key);if(p)return p}if(o.tileID.key!==i.key){const p=i.canonical.z-o.tileID.canonical.z;let g,v,w;d=s.a6.create();const M=o.tileID.wrap-i.wrap<<i.overscaledZ;p>0?(g=s.V>>p,v=g*((o.tileID.canonical.x<<p)-i.canonical.x+M),w=g*((o.tileID.canonical.y<<p)-i.canonical.y)):(g=s.V<<-p,v=s.V*(o.tileID.canonical.x-(i.canonical.x+M<<-p)),w=s.V*(o.tileID.canonical.y-(i.canonical.y<<-p))),s.a6.ortho(d,0,g,0,g,0,1),s.a6.translate(d,d,[v,w,0])}return new Cd(o.tileID,i.key,d)}_findTileCoveringTileID(i,o){let u=o.getTile(i);if(u&&u.hasData())return u;const d=this._findCoveringTileCache[o.id],p=d[i.key];if(u=p?o.getTileByID(p):null,u&&u.hasData()||p===null)return u;let g=u?u.tileID:i,v=g.overscaledZ;const w=o.getSource().minzoom,M=[];if(!p){const S=o.getSource().maxzoom;if(i.canonical.z>=S){const z=i.canonical.z-S;o.getSource().reparseOverscaled?(v=Math.max(i.canonical.z+2,o.transform.tileZoom),g=new s.am(v,i.wrap,S,i.canonical.x>>z,i.canonical.y>>z)):z!==0&&(v=S,g=new s.am(v,i.wrap,S,i.canonical.x>>z,i.canonical.y>>z))}g.key!==i.key&&(M.push(g.key),u=o.getTile(g))}const I=S=>{M.forEach(z=>{d[z]=S}),M.length=0};for(v-=1;v>=w&&(!u||!u.hasData());v--){u&&I(u.tileID.key);const S=g.calculateScaledKey(v);if(u=o.getTileByID(S),u&&u.hasData())break;const z=d[S];if(z===null)break;z===void 0?M.push(S):u=o.getTileByID(z)}return I(u?u.tileID.key:null),u&&u.hasData()?u:null}findDEMTileFor(i){return this.enabled?this._findTileCoveringTileID(i,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(i,o){let u=this._tilesDirty[i];u||(u=this._tilesDirty[i]={}),u[o.key]=!0}}function zu(c,i,o){const u=function(v,w,M){const I=s.N.dot(w,v),S=s.N.dot(M,[.2126,.7152,.0722]),z=(U,N,V)=>(1-V)*U+V*N,R=z(1-.3*Math.min(S,1),1,Math.min(I+1,1));return z(.92,1,Math.asin(s.aa(w[2],-1,1))/Math.PI+.5)*R}(c,[0,0,1],i),d=[0,0,0];s.N.scale(d,o.slice(0,3),u);const p=[0,0,0];s.N.scale(p,i.slice(0,3),c[2]);const g=[0,0,0];return s.N.add(g,d,p),s.bU(g)}const Ru=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],Ad=["stars","fillExtrusion","fillExtrusionGroundEffect","model","symbolSDF","symbolIcon","symbolTextAndIcon"];class Ou{static cacheKey(i,o,u,d){let p=`${o}${d?d.cacheKey:""}`;for(const g of u)i.usedDefines.includes(g)&&(p+=`/${g}`);return p}constructor(i,o,u,d,p,g,v){const w=i.gl;this.program=w.createProgram(),this.configuration=d,this.name=o,this.fixedDefines=[...g];const M=d?d.getBinderAttributes():[],I=(u.staticAttributes||[]).concat(M);let S=d?d.defines():[];S=S.concat(g.map(B=>`#define ${B}`));const z=`#version 300 es
`;let R=z+S.concat("precision mediump float;",Jl,Mu.fragmentSource).join(`
`);for(const B of u.fragmentIncludes)R+=`
${xn[B]}`;R+=`
${u.fragmentSource}`;let U=z+S.concat("precision highp float;",Jl,Mu.vertexSource).join(`
`);for(const B of u.vertexIncludes)U+=`
${xn[B]}`;U+=`
${u.vertexSource}`;const N=w.createShader(w.FRAGMENT_SHADER);if(w.isContextLost())return void(this.failedToCreate=!0);w.shaderSource(N,R),w.compileShader(N),w.attachShader(this.program,N);const V=w.createShader(w.VERTEX_SHADER);if(w.isContextLost())this.failedToCreate=!0;else{w.shaderSource(V,U),w.compileShader(V),w.attachShader(this.program,V),this.attributes={},this.numAttributes=I.length;for(let B=0;B<this.numAttributes;B++)if(I[B]){const G=I[B].startsWith("a_")?I[B]:`a_${I[B]}`;w.bindAttribLocation(this.program,B,G),this.attributes[G]=B}v&&v.shaderVaryings.length>0&&w.transformFeedbackVaryings(this.program,v.shaderVaryings,v.bufferMode),w.linkProgram(this.program),w.deleteShader(V),w.deleteShader(N),this.fixedUniforms=p(i),this.binderUniforms=d?d.getUniforms(i):[],g.includes("TERRAIN")&&(this.terrainUniforms=(B=>({u_dem:new s.bO(B),u_dem_prev:new s.bO(B),u_dem_tl:new s.bL(B),u_dem_scale:new s.bN(B),u_dem_tl_prev:new s.bL(B),u_dem_scale_prev:new s.bN(B),u_dem_size:new s.bN(B),u_dem_lerp:new s.bN(B),u_exaggeration:new s.bN(B),u_depth:new s.bO(B),u_depth_size_inv:new s.bL(B),u_meter_to_dem:new s.bN(B),u_label_plane_matrix_inv:new s.bK(B)}))(i)),g.includes("GLOBE")&&(this.globeUniforms=(B=>({u_tile_tl_up:new s.bM(B),u_tile_tr_up:new s.bM(B),u_tile_br_up:new s.bM(B),u_tile_bl_up:new s.bM(B),u_tile_up_scale:new s.bN(B)}))(i)),g.includes("FOG")&&(this.fogUniforms=(B=>({u_fog_matrix:new s.bK(B),u_fog_range:new s.bL(B),u_fog_color:new s.bP(B),u_fog_horizon_blend:new s.bN(B),u_fog_vertical_limit:new s.bL(B),u_fog_temporal_offset:new s.bN(B),u_frustum_tl:new s.bM(B),u_frustum_tr:new s.bM(B),u_frustum_br:new s.bM(B),u_frustum_bl:new s.bM(B),u_globe_pos:new s.bM(B),u_globe_radius:new s.bN(B),u_globe_transition:new s.bN(B),u_is_globe:new s.bO(B),u_viewport:new s.bL(B)}))(i)),g.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(B=>({u_cutoff_params:new s.bP(B)}))(i)),g.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(B=>({u_lighting_ambient_color:new s.bM(B),u_lighting_directional_dir:new s.bM(B),u_lighting_directional_color:new s.bM(B),u_ground_radiance:new s.bM(B)}))(i)),g.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(B=>({u_light_matrix_0:new s.bK(B),u_light_matrix_1:new s.bK(B),u_fade_range:new s.bL(B),u_shadow_normal_offset:new s.bM(B),u_shadow_intensity:new s.bN(B),u_shadow_texel_size:new s.bN(B),u_shadow_map_resolution:new s.bN(B),u_shadow_direction:new s.bM(B),u_shadow_bias:new s.bM(B),u_shadowmap_0:new s.bO(B),u_shadowmap_1:new s.bO(B)}))(i))}}setTerrainUniformValues(i,o){if(!this.terrainUniforms)return;const u=this.terrainUniforms;if(!this.failedToCreate){i.program.set(this.program);for(const d in o)u[d]&&u[d].set(this.program,d,o[d])}}setGlobeUniformValues(i,o){if(!this.globeUniforms)return;const u=this.globeUniforms;if(!this.failedToCreate){i.program.set(this.program);for(const d in o)u[d]&&u[d].set(this.program,d,o[d])}}setFogUniformValues(i,o){if(!this.fogUniforms)return;const u=this.fogUniforms;if(!this.failedToCreate){i.program.set(this.program);for(const d in o)u[d].set(this.program,d,o[d])}}setCutoffUniformValues(i,o){if(!this.cutoffUniforms)return;const u=this.cutoffUniforms;if(!this.failedToCreate){i.program.set(this.program);for(const d in o)u[d].set(this.program,d,o[d])}}setLightsUniformValues(i,o){if(!this.lightsUniforms)return;const u=this.lightsUniforms;if(!this.failedToCreate){i.program.set(this.program);for(const d in o)u[d].set(this.program,d,o[d])}}setShadowUniformValues(i,o){if(this.failedToCreate||!this.shadowUniforms)return;const u=this.shadowUniforms;i.program.set(this.program);for(const d in o)u[d].set(this.program,d,o[d])}_drawDebugWireframe(i,o,u,d,p,g,v,w,M,I){const S=i.options.wireframe;if(S.terrain===!1&&S.layers2D===!1&&S.layers3D===!1)return;const z=i.context;if(!(!(!S.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!S.layers2D||i._terrain&&i._terrain.renderingToTexture||!Ru.includes(this.name))||!(!S.layers3D||!Ad.includes(this.name))))return;const R=z.gl,U=i.wireframeDebugCache.getLinesFromTrianglesBuffer(i.frameCounter,p,z);if(!U)return;const N=[...this.fixedDefines];N.push("DEBUG_WIREFRAME");const V=i.getOrCreateProgram(this.name,{config:this.configuration,defines:N});z.program.set(V.program);const B=(q,J,j)=>{if(J[q]&&j[q])for(const Q in J[q])j[q][Q]&&j[q][Q].set(j.program,Q,J[q][Q].current)};M&&M.setUniforms(V.program,z,V.binderUniforms,v,{zoom:w}),B("fixedUniforms",this,V),B("terrainUniforms",this,V),B("globeUniforms",this,V),B("fogUniforms",this,V),B("lightsUniforms",this,V),B("shadowUniforms",this,V),U.bind(),z.setColorMode(new rr([R.ONE,R.ONE_MINUS_SRC_ALPHA,R.ZERO,R.ONE],s.ax.transparent,[!0,!0,!0,!1])),z.setDepthMode(new zt(o.func===R.LESS?R.LEQUAL:o.func,zt.ReadOnly,o.range)),z.setStencilMode(jt.disabled);const G=3*g.primitiveLength*2,K=3*g.primitiveOffset*2*2;I&&I>1?R.drawElementsInstanced(R.LINES,G,R.UNSIGNED_SHORT,K,I):R.drawElements(R.LINES,G,R.UNSIGNED_SHORT,K),p.bind(),z.program.set(this.program),z.setDepthMode(o),z.setStencilMode(u),z.setColorMode(d)}draw(i,o,u,d,p,g,v,w,M,I,S,z,R,U,N,V,B){const G=i.context,K=G.gl;if(this.failedToCreate)return;G.program.set(this.program),G.setDepthMode(u),G.setStencilMode(d),G.setColorMode(p),G.setCullFace(g);for(const Q of Object.keys(this.fixedUniforms))this.fixedUniforms[Q].set(this.program,Q,v[Q]);U&&U.setUniforms(this.program,G,this.binderUniforms,z,{zoom:R});const q={[K.POINTS]:1,[K.LINES]:2,[K.TRIANGLES]:3,[K.LINE_STRIP]:1}[o],J=B&&B.length>0;if(J){for(const Q of B)K.bindBufferBase(K.TRANSFORM_FEEDBACK_BUFFER,Q.targetIndex,Q.buffer.buffer);K.beginTransformFeedback(o)}const j=V&&V>0?1:void 0;for(const Q of S.get()){const oe=Q.vaos||(Q.vaos={});(oe[w]||(oe[w]=new Cu)).bind(G,this,M,U?U.getPaintVertexBuffers():[],I,Q.vertexOffset,N||[],j),V&&V>1?K.drawElementsInstanced(o,Q.primitiveLength*q,K.UNSIGNED_SHORT,Q.primitiveOffset*q*2,V):I?K.drawElements(o,Q.primitiveLength*q,K.UNSIGNED_SHORT,Q.primitiveOffset*q*2):K.drawArrays(o,Q.vertexOffset,Q.vertexLength),o===K.TRIANGLES&&I&&this._drawDebugWireframe(i,u,d,p,I,Q,z,R,U,V)}J&&K.endTransformFeedback()}}function ku(c,i){const o=Math.pow(2,i.tileID.overscaledZ),u=i.tileSize*Math.pow(2,c.transform.tileZoom)/o,d=u*(i.tileID.canonical.x+i.tileID.wrap*o),p=u*i.tileID.canonical.y;return{u_image:0,u_texsize:i.imageAtlasTexture?i.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/s.a3(i,1,c.transform.tileZoom),u_pixel_coord_upper:[d>>16,p>>16],u_pixel_coord_lower:[65535&d,65535&p]}}const Sd=s.a6.create(),Bu=(c,i,o,u,d,p,g,v,w,M,I,S,z,R,U,N)=>{const V=i.style.light,B=V.properties.get("position"),G=[B.x,B.y,B.z],K=s.co.create();V.properties.get("anchor")==="viewport"&&(s.co.fromRotation(K,-i.transform.angle),s.N.transformMat3(G,G,K));const q=V.properties.get("color"),J=i.transform,j={u_matrix:c,u_lightpos:G,u_lightintensity:V.properties.get("intensity"),u_lightcolor:[q.r,q.g,q.b],u_vertical_gradient:+o,u_opacity:u,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Sd,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_ao:d,u_edge_radius:p,u_flood_light_color:S,u_vertical_scale:z,u_flood_light_intensity:R,u_ground_shadow_factor:U,u_emissive_strength:N};return J.projection.name==="globe"&&(j.u_tile_id=[g.canonical.x,g.canonical.y,1<<g.canonical.z],j.u_zoom_transition=w,j.u_inv_rot_matrix=I,j.u_merc_center=M,j.u_up_dir=J.projection.upVector(new s.bs(0,0,0),M[0]*s.V,M[1]*s.V),j.u_height_lift=v),j},Fu=(c,i,o)=>({u_matrix:c,u_edge_radius:i,u_vertical_scale:o}),vs=(c,i,o,u,d,p,g,v,w,M,I,S,z,R)=>{const U=Bu(c,i,o,u,d,p,g,w,M,I,S,z,R,1,[0,0,0],0),N={u_height_factor:-Math.pow(2,g.overscaledZ)/v.tileSize/8};return s.e(U,ku(i,v),N)},sa=(c,i)=>({u_matrix:c,u_emissive_strength:i}),Nu=(c,i,o,u)=>s.e(sa(c,i),ku(o,u)),bs=(c,i,o)=>({u_matrix:c,u_world:o,u_emissive_strength:i}),Pd=(c,i,o,u,d)=>s.e(Nu(c,i,o,u),{u_world:d}),tc=(c,i,o,u)=>{const d=s.V/o.tileSize;return{u_matrix:c,u_camera_to_center_distance:i.getCameraToCenterDistance(u),u_extrude_scale:[i.pixelsToGLUnits[0]/d,i.pixelsToGLUnits[1]/d]}},Uu=(c,i,o=1)=>({u_matrix:c,u_color:i,u_overlay:0,u_overlay_scale:o}),Ld=s.a6.create(),Vu=(c,i,o,u,d,p,g)=>{const v=c.transform,w=v.projection.name==="globe",M=w?s.cp(v.zoom,i.canonical)*v._pixelsPerMercatorPixel:s.a3(o,1,p),I={u_matrix:i.projMatrix,u_extrude_scale:M,u_intensity:g,u_inv_rot_matrix:Ld,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(w){I.u_inv_rot_matrix=u,I.u_merc_center=d,I.u_tile_id=[i.canonical.x,i.canonical.y,1<<i.canonical.z],I.u_zoom_transition=s.S(v.zoom);const S=d[0]*s.V,z=d[1]*s.V;I.u_up_dir=v.projection.upVector(new s.bs(0,0,0),S,z)}return I};function rc(c,[i,o,u,d],[p,g]){if(p===g)return[0,0,0,0];const v=255*(c-1)/(c*(g-p));return[i*v,o*v,u*v,d*v]}function Dd(c,i,[o,u]){return o===u?0:.5/c+(i-o)*(c-1)/(c*(u-o))}const ju=(c,i,o,u,d,p,g,v,w,M,I,S,z,R,U,N,V,B,G,K,q)=>{return{u_matrix:c,u_normalize_matrix:i,u_globe_matrix:o,u_merc_matrix:u,u_grid_matrix:d,u_tl_parent:p,u_scale_parent:M,u_fade_t:I.mix,u_opacity:I.opacity*S.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:S.paint.get("raster-brightness-min"),u_brightness_high:S.paint.get("raster-brightness-max"),u_saturation_factor:(j=S.paint.get("raster-saturation"),j>0?1-1/(1.001-j):-j),u_contrast_factor:(J=S.paint.get("raster-contrast"),J>0?1/(1-J):1+J),u_spin_weights:qa(S.paint.get("raster-hue-rotate")),u_perspective_transform:z,u_raster_elevation:R,u_zoom_transition:g,u_merc_center:v,u_cutoff_params:w,u_colorization_mix:rc(s.cq,N,B),u_colorization_offset:Dd(s.cq,V,B),u_color_ramp:U,u_texture_offset:[K/(G+2*K),G/(G+2*K)],u_texture_res:[G+2*K,G+2*K],u_emissive_strength:q};var J,j};function qa(c){c*=Math.PI/180;const i=Math.sin(c),o=Math.cos(c);return[(2*o+1)/3,(-Math.sqrt(3)*i-o+1)/3,(Math.sqrt(3)*i-o+1)/3]}const Xp=(c,i,o,u,d,p,g,v,w,M,I,S)=>({u_matrix:c,u_normalize_matrix:i,u_globe_matrix:o,u_merc_matrix:u,u_grid_matrix:d,u_tl_parent:p,u_scale_parent:M,u_fade_t:I.mix,u_opacity:I.opacity,u_image0:0,u_image1:1,u_raster_elevation:S,u_zoom_transition:g,u_merc_center:v,u_cutoff_params:w}),Yp=(c,i,o,u,d,p,g,v)=>({u_tile_offset:c,u_velocity:i,u_color_ramp:u,u_velocity_res:o,u_max_speed:d,u_texture_offset:p,u_data_scale:g,u_data_offset:v}),zd=(c,i,o,u,d,p,g,v)=>({u_velocity:c,u_velocity_res:i,u_max_speed:o,u_speed_factor:u,u_lifetime_delta:d,u_rand_seed:Math.random(),u_texture_offset:p,u_data_scale:g,u_data_offset:v}),Rd=s.a6.create(),ic=(c,i,o,u,d,p,g,v,w,M,I,S,z,R,U,N,V,B)=>{const G=d.transform,K={u_is_size_zoom_constant:+(c==="constant"||c==="source"),u_is_size_feature_constant:+(c==="constant"||c==="camera"),u_size_t:i?i.uSizeT:0,u_size:i?i.uSize:0,u_camera_to_center_distance:G.getCameraToCenterDistance(N),u_rotate_symbol:+o,u_aspect_ratio:G.width/G.height,u_fade_change:d.options.fadeDuration?d.symbolFadeChange:1,u_matrix:p,u_label_plane_matrix:g,u_coord_matrix:v,u_is_text:+w,u_pitch_with_map:+u,u_texsize:M,u_texture:0,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Rd,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Rd,u_up_vector:[0,-1,0],u_icon_transition:B||0,u_icon_saturation:V};return N.name==="globe"&&(K.u_tile_id=[I.canonical.x,I.canonical.y,1<<I.canonical.z],K.u_zoom_transition=S,K.u_inv_rot_matrix=R,K.u_merc_center=z,K.u_camera_forward=G._camera.forward(),K.u_ecef_origin=s.cr(G.globeMatrix,I.toUnwrapped()),K.u_tile_matrix=Float32Array.from(G.globeMatrix),K.u_up_vector=U),K},Wa=(c,i,o,u,d,p,g,v,w,M,I,S,z,R,U,N,V)=>s.e(ic(c,i,o,u,d,p,g,v,w,M,S,z,R,U,N,V,1),{u_gamma_scale:u?d.transform.getCameraToCenterDistance(V)*Math.cos(d.terrain?0:d.transform._pitch):1,u_device_pixel_ratio:s.f.devicePixelRatio,u_is_halo:+I,undefined:void 0}),nc=(c,i,o,u,d,p,g,v,w,M,I,S,z,R,U,N)=>s.e(Wa(c,i,o,u,d,p,g,v,!0,w,!0,I,S,z,R,U,N),{u_texsize_icon:M,u_texture_icon:1}),Zu=(c,i,o,u)=>({u_matrix:c,u_emissive_strength:i,u_opacity:o,u_color:u}),Ha=(c,i,o,u,d,p,g)=>s.e(function(v,w,M,I){const S=M.imageManager.getPattern(v.toString(),w),{width:z,height:R}=M.imageManager.getPixelSize(w),U=Math.pow(2,I.tileID.overscaledZ),N=I.tileSize*Math.pow(2,M.transform.tileZoom)/U,V=N*(I.tileID.canonical.x+I.tileID.wrap*U),B=N*I.tileID.canonical.y;return{u_image:0,u_pattern_tl:S.tl,u_pattern_br:S.br,u_texsize:[z,R],u_pattern_size:S.displaySize,u_tile_units_to_pixels:1/s.a3(I,1,M.transform.tileZoom),u_pixel_coord_upper:[V>>16,B>>16],u_pixel_coord_lower:[65535&V,65535&B]}}(d,p,u,g),{u_matrix:c,u_emissive_strength:i,u_opacity:o}),oc=(c,i,o,u,d,p,g,v,w,M,I,S,z=[0,0,0],R)=>{const U=u.style.light,N=U.properties.get("position"),V=[-N.x,-N.y,N.z],B=s.co.create();U.properties.get("anchor")==="viewport"&&(s.co.fromRotation(B,-u.transform.angle),s.N.transformMat3(V,V,B));const G=M.alphaMode==="MASK",K=U.properties.get("color"),q=S.paint.get("model-ambient-occlusion-intensity"),J=S.paint.get("model-color").constantOr(s.ax.white),j=S.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:c,u_lighting_matrix:i,u_normal_matrix:o,u_lightpos:V,u_lightintensity:U.properties.get("intensity"),u_lightcolor:[K.r,K.g,K.b],u_camera_pos:z,u_opacity:d,u_baseTextureIsAlpha:0,u_alphaMask:+G,u_alphaCutoff:M.alphaCutoff,u_baseColorFactor:[p.r,p.g,p.b,p.a],u_emissiveFactor:[g[0],g[1],g[2],1],u_metallicFactor:v,u_roughnessFactor:w,u_baseColorTexture:ji.BaseColor,u_metallicRoughnessTexture:ji.MetallicRoughness,u_normalTexture:ji.Normal,u_occlusionTexture:ji.Occlusion,u_emissionTexture:ji.Emission,u_color_mix:[J.r,J.g,J.b,j],u_aoIntensity:q,u_emissive_strength:I,u_occlusionTextureTransform:R||[0,0,0,0]}},Xa=new Float32Array(16),Ya=(c,i=Xa,o=Xa)=>({u_matrix:c,u_instance:i,u_node_matrix:o}),Kp={fillExtrusion:c=>({u_matrix:new s.bK(c),u_lightpos:new s.bM(c),u_lightintensity:new s.bN(c),u_lightcolor:new s.bM(c),u_vertical_gradient:new s.bN(c),u_opacity:new s.bN(c),u_edge_radius:new s.bN(c),u_ao:new s.bL(c),u_tile_id:new s.bM(c),u_zoom_transition:new s.bN(c),u_inv_rot_matrix:new s.bK(c),u_merc_center:new s.bL(c),u_up_dir:new s.bM(c),u_height_lift:new s.bN(c),u_flood_light_color:new s.bM(c),u_vertical_scale:new s.bN(c),u_flood_light_intensity:new s.bN(c),u_ground_shadow_factor:new s.bM(c),u_emissive_strength:new s.bN(c)}),fillExtrusionDepth:c=>({u_matrix:new s.bK(c),u_edge_radius:new s.bN(c),u_vertical_scale:new s.bN(c)}),fillExtrusionPattern:c=>({u_matrix:new s.bK(c),u_lightpos:new s.bM(c),u_lightintensity:new s.bN(c),u_lightcolor:new s.bM(c),u_vertical_gradient:new s.bN(c),u_height_factor:new s.bN(c),u_edge_radius:new s.bN(c),u_ao:new s.bL(c),u_tile_id:new s.bM(c),u_zoom_transition:new s.bN(c),u_inv_rot_matrix:new s.bK(c),u_merc_center:new s.bL(c),u_up_dir:new s.bM(c),u_height_lift:new s.bN(c),u_image:new s.bO(c),u_texsize:new s.bL(c),u_pixel_coord_upper:new s.bL(c),u_pixel_coord_lower:new s.bL(c),u_tile_units_to_pixels:new s.bN(c),u_opacity:new s.bN(c)}),fillExtrusionGroundEffect:c=>({u_matrix:new s.bK(c),u_opacity:new s.bN(c),u_ao_pass:new s.bN(c),u_meter_to_tile:new s.bN(c),u_ao:new s.bL(c),u_flood_light_intensity:new s.bN(c),u_flood_light_color:new s.bM(c),u_attenuation:new s.bN(c),u_edge_radius:new s.bN(c),u_fb:new s.bO(c),u_fb_size:new s.bN(c)}),fill:c=>({u_matrix:new s.bK(c),u_emissive_strength:new s.bN(c)}),fillPattern:c=>({u_matrix:new s.bK(c),u_emissive_strength:new s.bN(c),u_image:new s.bO(c),u_texsize:new s.bL(c),u_pixel_coord_upper:new s.bL(c),u_pixel_coord_lower:new s.bL(c),u_tile_units_to_pixels:new s.bN(c)}),fillOutline:c=>({u_matrix:new s.bK(c),u_emissive_strength:new s.bN(c),u_world:new s.bL(c)}),fillOutlinePattern:c=>({u_matrix:new s.bK(c),u_emissive_strength:new s.bN(c),u_world:new s.bL(c),u_image:new s.bO(c),u_texsize:new s.bL(c),u_pixel_coord_upper:new s.bL(c),u_pixel_coord_lower:new s.bL(c),u_tile_units_to_pixels:new s.bN(c)}),circle:s.cs,collisionBox:c=>({u_matrix:new s.bK(c),u_camera_to_center_distance:new s.bN(c),u_extrude_scale:new s.bL(c)}),collisionCircle:c=>({u_matrix:new s.bK(c),u_inv_matrix:new s.bK(c),u_camera_to_center_distance:new s.bN(c),u_viewport_size:new s.bL(c)}),debug:c=>({u_color:new s.ca(c),u_matrix:new s.bK(c),u_overlay:new s.bO(c),u_overlay_scale:new s.bN(c)}),clippingMask:c=>({u_matrix:new s.bK(c)}),heatmap:c=>({u_extrude_scale:new s.bN(c),u_intensity:new s.bN(c),u_matrix:new s.bK(c),u_inv_rot_matrix:new s.bK(c),u_merc_center:new s.bL(c),u_tile_id:new s.bM(c),u_zoom_transition:new s.bN(c),u_up_dir:new s.bM(c)}),heatmapTexture:c=>({u_image:new s.bO(c),u_color_ramp:new s.bO(c),u_opacity:new s.bN(c)}),hillshade:c=>({u_matrix:new s.bK(c),u_image:new s.bO(c),u_latrange:new s.bL(c),u_light:new s.bL(c),u_shadow:new s.ca(c),u_highlight:new s.ca(c),u_emissive_strength:new s.bN(c),u_accent:new s.ca(c)}),hillshadePrepare:c=>({u_matrix:new s.bK(c),u_image:new s.bO(c),u_dimension:new s.bL(c),u_zoom:new s.bN(c)}),line:s.ct,linePattern:s.cu,raster:c=>({u_matrix:new s.bK(c),u_normalize_matrix:new s.bK(c),u_globe_matrix:new s.bK(c),u_merc_matrix:new s.bK(c),u_grid_matrix:new s.cb(c),u_tl_parent:new s.bL(c),u_scale_parent:new s.bN(c),u_fade_t:new s.bN(c),u_opacity:new s.bN(c),u_image0:new s.bO(c),u_image1:new s.bO(c),u_brightness_low:new s.bN(c),u_brightness_high:new s.bN(c),u_saturation_factor:new s.bN(c),u_contrast_factor:new s.bN(c),u_spin_weights:new s.bM(c),u_perspective_transform:new s.bL(c),u_raster_elevation:new s.bN(c),u_zoom_transition:new s.bN(c),u_merc_center:new s.bL(c),u_cutoff_params:new s.bP(c),u_colorization_mix:new s.bP(c),u_colorization_offset:new s.bN(c),u_color_ramp:new s.bO(c),u_texture_offset:new s.bL(c),u_texture_res:new s.bL(c),u_emissive_strength:new s.bN(c)}),rasterParticle:c=>({u_matrix:new s.bK(c),u_normalize_matrix:new s.bK(c),u_globe_matrix:new s.bK(c),u_merc_matrix:new s.bK(c),u_grid_matrix:new s.cb(c),u_tl_parent:new s.bL(c),u_scale_parent:new s.bN(c),u_fade_t:new s.bN(c),u_opacity:new s.bN(c),u_image0:new s.bO(c),u_image1:new s.bO(c),u_raster_elevation:new s.bN(c),u_zoom_transition:new s.bN(c),u_merc_center:new s.bL(c),u_cutoff_params:new s.bP(c)}),rasterParticleTexture:c=>({u_texture:new s.bO(c),u_opacity:new s.bN(c)}),rasterParticleDraw:c=>({u_tile_offset:new s.bL(c),u_velocity:new s.bO(c),u_color_ramp:new s.bO(c),u_velocity_res:new s.bL(c),u_max_speed:new s.bN(c),u_texture_offset:new s.bL(c),u_data_scale:new s.bP(c),u_data_offset:new s.bN(c)}),rasterParticleUpdate:c=>({u_velocity:new s.bO(c),u_velocity_res:new s.bL(c),u_max_speed:new s.bN(c),u_speed_factor:new s.bN(c),u_lifetime_delta:new s.bN(c),u_rand_seed:new s.bN(c),u_texture_offset:new s.bL(c),u_data_scale:new s.bP(c),u_data_offset:new s.bN(c)}),symbolIcon:c=>({u_is_size_zoom_constant:new s.bO(c),u_is_size_feature_constant:new s.bO(c),u_size_t:new s.bN(c),u_size:new s.bN(c),u_camera_to_center_distance:new s.bN(c),u_rotate_symbol:new s.bO(c),u_aspect_ratio:new s.bN(c),u_fade_change:new s.bN(c),u_matrix:new s.bK(c),u_label_plane_matrix:new s.bK(c),u_coord_matrix:new s.bK(c),u_is_text:new s.bO(c),u_pitch_with_map:new s.bO(c),u_texsize:new s.bL(c),u_tile_id:new s.bM(c),u_zoom_transition:new s.bN(c),u_inv_rot_matrix:new s.bK(c),u_merc_center:new s.bL(c),u_camera_forward:new s.bM(c),u_tile_matrix:new s.bK(c),u_up_vector:new s.bM(c),u_ecef_origin:new s.bM(c),u_texture:new s.bO(c),u_icon_transition:new s.bN(c),u_icon_saturation:new s.bN(c)}),symbolSDF:c=>({u_is_size_zoom_constant:new s.bO(c),u_is_size_feature_constant:new s.bO(c),u_size_t:new s.bN(c),u_size:new s.bN(c),u_camera_to_center_distance:new s.bN(c),u_rotate_symbol:new s.bO(c),u_aspect_ratio:new s.bN(c),u_fade_change:new s.bN(c),u_matrix:new s.bK(c),u_label_plane_matrix:new s.bK(c),u_coord_matrix:new s.bK(c),u_is_text:new s.bO(c),u_pitch_with_map:new s.bO(c),u_texsize:new s.bL(c),u_texture:new s.bO(c),u_gamma_scale:new s.bN(c),u_device_pixel_ratio:new s.bN(c),u_tile_id:new s.bM(c),u_zoom_transition:new s.bN(c),u_inv_rot_matrix:new s.bK(c),u_merc_center:new s.bL(c),u_camera_forward:new s.bM(c),u_tile_matrix:new s.bK(c),u_up_vector:new s.bM(c),u_ecef_origin:new s.bM(c),u_is_halo:new s.bO(c)}),symbolTextAndIcon:c=>({u_is_size_zoom_constant:new s.bO(c),u_is_size_feature_constant:new s.bO(c),u_size_t:new s.bN(c),u_size:new s.bN(c),u_camera_to_center_distance:new s.bN(c),u_rotate_symbol:new s.bO(c),u_aspect_ratio:new s.bN(c),u_fade_change:new s.bN(c),u_matrix:new s.bK(c),u_label_plane_matrix:new s.bK(c),u_coord_matrix:new s.bK(c),u_is_text:new s.bO(c),u_pitch_with_map:new s.bO(c),u_texsize:new s.bL(c),u_texsize_icon:new s.bL(c),u_texture:new s.bO(c),u_texture_icon:new s.bO(c),u_gamma_scale:new s.bN(c),u_device_pixel_ratio:new s.bN(c),u_is_halo:new s.bO(c)}),background:c=>({u_matrix:new s.bK(c),u_emissive_strength:new s.bN(c),u_opacity:new s.bN(c),u_color:new s.ca(c)}),backgroundPattern:c=>({u_matrix:new s.bK(c),u_emissive_strength:new s.bN(c),u_opacity:new s.bN(c),u_image:new s.bO(c),u_pattern_tl:new s.bL(c),u_pattern_br:new s.bL(c),u_texsize:new s.bL(c),u_pattern_size:new s.bL(c),u_pixel_coord_upper:new s.bL(c),u_pixel_coord_lower:new s.bL(c),u_tile_units_to_pixels:new s.bN(c)}),terrainRaster:Md,terrainDepth:Md,skybox:c=>({u_matrix:new s.bK(c),u_sun_direction:new s.bM(c),u_cubemap:new s.bO(c),u_opacity:new s.bN(c),u_temporal_offset:new s.bN(c)}),skyboxGradient:c=>({u_matrix:new s.bK(c),u_color_ramp:new s.bO(c),u_center_direction:new s.bM(c),u_radius:new s.bN(c),u_opacity:new s.bN(c),u_temporal_offset:new s.bN(c)}),skyboxCapture:c=>({u_matrix_3f:new s.cb(c),u_sun_direction:new s.bM(c),u_sun_intensity:new s.bN(c),u_color_tint_r:new s.bP(c),u_color_tint_m:new s.bP(c),u_luminance:new s.bN(c)}),globeRaster:c=>({u_proj_matrix:new s.bK(c),u_globe_matrix:new s.bK(c),u_normalize_matrix:new s.bK(c),u_merc_matrix:new s.bK(c),u_zoom_transition:new s.bN(c),u_merc_center:new s.bL(c),u_image0:new s.bO(c),u_grid_matrix:new s.cb(c),u_skirt_height:new s.bN(c),u_far_z_cutoff:new s.bN(c),u_frustum_tl:new s.bM(c),u_frustum_tr:new s.bM(c),u_frustum_br:new s.bM(c),u_frustum_bl:new s.bM(c),u_globe_pos:new s.bM(c),u_globe_radius:new s.bN(c),u_viewport:new s.bL(c)}),globeAtmosphere:c=>({u_frustum_tl:new s.bM(c),u_frustum_tr:new s.bM(c),u_frustum_br:new s.bM(c),u_frustum_bl:new s.bM(c),u_horizon:new s.bN(c),u_transition:new s.bN(c),u_fadeout_range:new s.bN(c),u_color:new s.bP(c),u_high_color:new s.bP(c),u_space_color:new s.bP(c),u_temporal_offset:new s.bN(c),u_horizon_angle:new s.bN(c)}),model:c=>({u_matrix:new s.bK(c),u_lighting_matrix:new s.bK(c),u_normal_matrix:new s.bK(c),u_lightpos:new s.bM(c),u_lightintensity:new s.bN(c),u_lightcolor:new s.bM(c),u_camera_pos:new s.bM(c),u_opacity:new s.bN(c),u_baseColorFactor:new s.bP(c),u_emissiveFactor:new s.bP(c),u_metallicFactor:new s.bN(c),u_roughnessFactor:new s.bN(c),u_baseTextureIsAlpha:new s.bO(c),u_alphaMask:new s.bO(c),u_alphaCutoff:new s.bN(c),u_baseColorTexture:new s.bO(c),u_metallicRoughnessTexture:new s.bO(c),u_normalTexture:new s.bO(c),u_occlusionTexture:new s.bO(c),u_emissionTexture:new s.bO(c),u_color_mix:new s.bP(c),u_aoIntensity:new s.bN(c),u_emissive_strength:new s.bN(c),u_occlusionTextureTransform:new s.bP(c)}),modelDepth:c=>({u_matrix:new s.bK(c),u_instance:new s.bK(c),u_node_matrix:new s.bK(c)}),groundShadow:c=>({u_matrix:new s.bK(c),u_ground_shadow_factor:new s.bM(c)}),stars:c=>({u_matrix:new s.bK(c),u_up:new s.bM(c),u_right:new s.bM(c),u_intensity_multiplier:new s.bN(c)})};let Gn;function $n(c,i,o,u,d,p,g){const v=c.context,w=v.gl,M=c.transform,I=c.getOrCreateProgram("collisionBox"),S=[];let z=0,R=0;for(let q=0;q<u.length;q++){const J=u[q],j=i.getTile(J),Q=j.getBucket(o);if(!Q)continue;const oe=uu(J,Q,M);let le=oe;d[0]===0&&d[1]===0||(le=c.translatePosMatrix(oe,j,d,p));const he=g?Q.textCollisionBox:Q.iconCollisionBox,we=Q.collisionCircleArray;if(we.length>0){const me=s.a6.create(),Ae=le;s.a6.mul(me,Q.placementInvProjMatrix,M.glCoordMatrix),s.a6.mul(me,me,Q.placementViewportMatrix),S.push({circleArray:we,circleOffset:R,transform:Ae,invTransform:me,projection:Q.getProjection()}),z+=we.length/4,R=z}he&&(c.terrain&&c.terrain.setupElevationDraw(j,I),I.draw(c,w.LINES,zt.disabled,jt.disabled,c.colorModeForRenderPass(),Rt.disabled,tc(le,M,j,Q.getProjection()),o.id,he.layoutVertexBuffer,he.indexBuffer,he.segments,null,M.zoom,null,[he.collisionVertexBuffer,he.collisionVertexBufferExt]))}if(!g||!S.length)return;const U=c.getOrCreateProgram("collisionCircle"),N=new s.cv;N.resize(4*z),N._trim();let V=0;for(const q of S)for(let J=0;J<q.circleArray.length/4;J++){const j=4*J,Q=q.circleArray[j+0],oe=q.circleArray[j+1],le=q.circleArray[j+2],he=q.circleArray[j+3];N.emplace(V++,Q,oe,le,he,0),N.emplace(V++,Q,oe,le,he,1),N.emplace(V++,Q,oe,le,he,2),N.emplace(V++,Q,oe,le,he,3)}(!Gn||Gn.length<2*z)&&(Gn=function(q){const J=2*q,j=new s.aw;j.resize(J),j._trim();for(let Q=0;Q<J;Q++){const oe=6*Q;j.uint16[oe+0]=4*Q+0,j.uint16[oe+1]=4*Q+1,j.uint16[oe+2]=4*Q+2,j.uint16[oe+3]=4*Q+2,j.uint16[oe+4]=4*Q+3,j.uint16[oe+5]=4*Q+0}return j}(z));const B=v.createIndexBuffer(Gn,!0),G=v.createVertexBuffer(N,s.cw.members,!0);for(const q of S){const J={u_matrix:q.transform,u_inv_matrix:q.invTransform,u_camera_to_center_distance:(K=M).getCameraToCenterDistance(q.projection),u_viewport_size:[K.width,K.height]};U.draw(c,w.TRIANGLES,zt.disabled,jt.disabled,c.colorModeForRenderPass(),Rt.disabled,J,o.id,G,B,s.aB.simpleSegment(0,2*q.circleOffset,q.circleArray.length,q.circleArray.length/2),null,M.zoom)}var K;G.destroy(),B.destroy()}const yo=s.a6.create();function Ka(c){const i=c._camera.getWorldToCamera(c.worldSize,1),o=s.a6.multiply([],i,c.globeMatrix);s.a6.invert(o,o);const u=[0,0,0],d=[0,1,0,0];return s.a7.transformMat4(d,d,o),u[0]=d[0],u[1]=d[1],u[2]=d[2],s.N.normalize(u,u),u}function mt({width:c,height:i,anchor:o,textOffset:u,textScale:d},p){const{horizontalAlign:g,verticalAlign:v}=s.bf(o),w=-(g-.5)*c,M=-(v-.5)*i,I=s.bd(o,u);return new s.P((w/d+I[0])*p,(M/d+I[1])*p)}function Od(c,i,o,u,d,p,g,v,w,M,I){const S=c.text.placedSymbolArray,z=c.text.dynamicLayoutVertexArray,R=c.icon.dynamicLayoutVertexArray,U={},N=c.getProjection(),V=Ba(v,N,p),B=p.elevation,G=N.upVectorScale(v.canonical,p.center.lat,p.worldSize).metersToTile;z.clear();for(let K=0;K<S.length;K++){const q=S.get(K),{tileAnchorX:J,tileAnchorY:j,numGlyphs:Q}=q,oe=q.hidden||!q.crossTileID||c.allowVerticalPlacement&&!q.placedOrientation?null:u[q.crossTileID];if(oe){let le=0,he=0,we=0;if(B){const Ve=B?B.getAtTileOffset(v,J,j):0,[Ye,Xe,ot]=N.upVector(v.canonical,J,j);le=Ve*Ye*G,he=Ve*Xe*G,we=Ve*ot*G}let[me,Ae,Ie,Ue]=Sn(q.projectedAnchorX+le,q.projectedAnchorY+he,q.projectedAnchorZ+we,o?V:g);const ge=pd(p.getCameraToCenterDistance(N),Ue);let Ee=d.evaluateSizeForFeature(c.textSizeData,M,q)*ge/s.bc;o&&(Ee*=c.tilePixelRatio/w);const ue=mt(oe,Ee);o?({x:me,y:Ae,z:Ie}=N.projectTilePoint(J+ue.x,j+ue.y,v.canonical),[me,Ae,Ie]=Sn(me+le,Ae+he,Ie+we,g)):(i&&ue._rotate(-p.angle),me+=ue.x,Ae+=ue.y,Ie=0);const ve=c.allowVerticalPlacement&&q.placedOrientation===s.b6.vertical?Math.PI/2:0;for(let Ve=0;Ve<Q;Ve++)s.b9(z,me,Ae,Ie,ve);I&&q.associatedIconIndex>=0&&(U[q.associatedIconIndex]={x:me,y:Ae,z:Ie,angle:ve})}else Vo(Q,z)}if(I){R.clear();const K=c.icon.placedSymbolArray;for(let q=0;q<K.length;q++){const J=K.get(q),{numGlyphs:j}=J,Q=U[q];if(J.hidden||!Q)Vo(j,R);else{const{x:oe,y:le,z:he,angle:we}=Q;for(let me=0;me<j;me++)s.b9(R,oe,le,he,we)}}c.icon.dynamicLayoutVertexBuffer.updateData(R)}c.text.dynamicLayoutVertexBuffer.updateData(z)}function sc(c,i,o,u,d,p,g={}){const v=o.paint.get("icon-translate"),w=o.paint.get("text-translate"),M=o.paint.get("icon-translate-anchor"),I=o.paint.get("text-translate-anchor"),S=o.layout.get("icon-rotation-alignment"),z=o.layout.get("text-rotation-alignment"),R=o.layout.get("icon-pitch-alignment"),U=o.layout.get("text-pitch-alignment"),N=o.layout.get("icon-keep-upright"),V=o.layout.get("text-keep-upright"),B=o.paint.get("icon-color-saturation"),G=c.context,K=G.gl,q=c.transform,J=S==="map",j=z==="map",Q=R==="map",oe=U==="map",le=o.layout.get("symbol-sort-key").constantOr(1)!==void 0;let he=!1;const we=c.depthModeForSublayer(0,zt.ReadOnly),me=[s.a5(q.center.lng),s.ae(q.center.lat)],Ae=o.layout.get("text-variable-anchor"),Ie=q.projection.name==="globe",Ue=[],ge=[0,-1,0];for(const Ee of u){const ue=i.getTile(Ee),ve=ue.getBucket(o);if(!ve||ve.projection.name==="mercator"&&Ie||ve.fullyClipped)continue;const Ve=ve.projection.name==="globe",Ye=Ve?s.S(q.zoom):0,Xe=Ba(Ee,ve.getProjection(),q),ot=q.calculatePixelsToTileUnitsMatrix(ue),yt=Ae&&ve.hasTextData(),Pt=ve.hasIconTextFit()&&yt&&ve.hasIconData(),Tt=ve.getProjection().createInversionMatrix(q,Ee.canonical),It=()=>{const ri=J&&o.layout.get("symbol-placement")!=="point",or=[],yr=ri||Pt,sr=o.paint.get("icon-image-cross-fade").constantOr(0);c.terrainRenderModeElevated()&&Q&&or.push("PITCH_WITH_MAP_TERRAIN"),Ve&&(or.push("PROJECTION_GLOBE_VIEW"),yr&&or.push("PROJECTED_POS_ON_VIEWPORT")),sr>0&&or.push("ICON_TRANSITION"),ve.icon.zOffsetVertexBuffer&&or.push("Z_OFFSET"),B<1&&or.push("SATURATION");const gr=ve.icon.programConfigurations.get(o.id),Gr=c.getOrCreateProgram(ve.sdfIcons?"symbolSDF":"symbolIcon",{config:gr,defines:or});let Tr;const Pi=ue.imageAtlasTexture?ue.imageAtlasTexture.size:[0,0],Zi=ve.iconSizeData,cn=s.b5(Zi,q.zoom),no=Q||q.pitch!==0,un=Oa(Xe,ue.tileID.canonical,Q,J,q,ve.getProjection(),ot),Li=iu(Xe,ue.tileID.canonical,Q,J,q,ve.getProjection(),ot),wi=c.translatePosMatrix(Li,ue,v,M,!0),Xi=c.translatePosMatrix(Xe,ue,v,M),tn=yr?yo:un,hn=J&&!Q&&!ri;let oo=ge;!Ie&&!q.mercatorFromTransition||J||(oo=Ka(q));const es=Ve?oo:ge;Tr=ve.sdfIcons&&!ve.iconsInText?Wa(Zi.kind,cn,hn,Q,c,Xi,tn,wi,!1,Pi,!0,Ee,Ye,me,Tt,es,ve.getProjection()):ic(Zi.kind,cn,hn,Q,c,Xi,tn,wi,!1,Pi,Ee,Ye,me,Tt,es,ve.getProjection(),B,sr);const Is=ue.imageAtlasTexture?ue.imageAtlasTexture:null,_l=o.layout.get("icon-size").constantOr(0)!==1||ve.iconsNeedLinear,gl=ve.sdfIcons||c.options.rotating||c.options.zooming||_l||no?K.LINEAR:K.NEAREST,xh=ve.sdfIcons&&o.paint.get("icon-halo-width").constantOr(1)!==0,yl=c.terrain&&Q&&ri?s.a6.invert(s.a6.create(),un):yo;if(ri&&ve.icon){const ha=q.elevation,_c=ha?ha.getAtTileOffsetFunc(Ee,q.center.lat,q.worldSize,ve.getProjection()):null,wo=ru(Xe,ue.tileID.canonical,Q,J,q,ve.getProjection(),ot);ou(ve,Xe,c,!1,wo,Li,Q,N,_c,Ee)}return{program:Gr,buffers:ve.icon,uniformValues:Tr,atlasTexture:Is,atlasTextureIcon:null,atlasInterpolation:gl,atlasInterpolationIcon:null,isSDF:ve.sdfIcons,hasHalo:xh,tile:ue,labelPlaneMatrixInv:yl}},Yt=()=>{const ri=j&&o.layout.get("symbol-placement")!=="point",or=[],yr=ri||Ae||Pt;c.terrainRenderModeElevated()&&oe&&or.push("PITCH_WITH_MAP_TERRAIN"),Ve&&(or.push("PROJECTION_GLOBE_VIEW"),yr&&or.push("PROJECTED_POS_ON_VIEWPORT")),ve.text.zOffsetVertexBuffer&&or.push("Z_OFFSET");const sr=ve.text.programConfigurations.get(o.id),gr=c.getOrCreateProgram(ve.iconsInText?"symbolTextAndIcon":"symbolSDF",{config:sr,defines:or});let Gr,Tr=[0,0],Pi=null;const Zi=ve.textSizeData;ve.iconsInText&&(Tr=ue.imageAtlasTexture?ue.imageAtlasTexture.size:[0,0],Pi=ue.imageAtlasTexture?ue.imageAtlasTexture:null,Gr=oe||q.pitch!==0||c.options.rotating||c.options.zooming||Zi.kind==="composite"||Zi.kind==="camera"?K.LINEAR:K.NEAREST);const cn=ue.glyphAtlasTexture?ue.glyphAtlasTexture.size:[0,0],no=s.b5(Zi,q.zoom),un=Oa(Xe,ue.tileID.canonical,oe,j,q,ve.getProjection(),ot),Li=iu(Xe,ue.tileID.canonical,oe,j,q,ve.getProjection(),ot),wi=c.translatePosMatrix(Li,ue,w,I,!0),Xi=c.translatePosMatrix(Xe,ue,w,I),tn=yr?yo:un,hn=j&&!oe&&!ri;let oo=ge;!Ie&&!q.mercatorFromTransition||j||(oo=Ka(q));const es=Ve?oo:ge;let Is;Is=ve.iconsInText?nc(Zi.kind,no,hn,oe,c,Xi,tn,wi,cn,Tr,Ee,Ye,me,Tt,es,ve.getProjection()):Wa(Zi.kind,no,hn,oe,c,Xi,tn,wi,!0,cn,!0,Ee,Ye,me,Tt,es,ve.getProjection());const _l=ue.glyphAtlasTexture?ue.glyphAtlasTexture:null,gl=K.LINEAR,xh=o.paint.get("text-halo-width").constantOr(1)!==0,yl=c.terrain&&oe&&ri?s.a6.invert(s.a6.create(),un):yo;if(ri&&ve.text){const ha=q.elevation,_c=ha?ha.getAtTileOffsetFunc(Ee,q.center.lat,q.worldSize,ve.getProjection()):null,wo=ru(Xe,ue.tileID.canonical,oe,j,q,ve.getProjection(),ot);ou(ve,Xe,c,!0,wo,Li,oe,V,_c,Ee)}return{program:gr,buffers:ve.text,uniformValues:Is,atlasTexture:_l,atlasTextureIcon:Pi,atlasInterpolation:gl,atlasInterpolationIcon:Gr,isSDF:!0,hasHalo:xh,tile:ue,labelPlaneMatrixInv:yl}},Vt=ve.icon.segments.get().length,qt=ve.text.segments.get().length,$t=Vt&&!g.onlyText?It():null,fr=qt&&!g.onlyIcons?Yt():null,Vr=o.paint.get("icon-opacity").constantOr(1),nr=o.paint.get("text-opacity").constantOr(1);if(le&&ve.canOverlap){he=!0;const ri=Vr&&!g.onlyText?ve.icon.segments.get():[],or=nr&&!g.onlyIcons?ve.text.segments.get():[];for(const yr of ri)Ue.push({segments:new s.aB([yr]),sortKey:yr.sortKey,state:$t});for(const yr of or)Ue.push({segments:new s.aB([yr]),sortKey:yr.sortKey,state:fr})}else g.onlyText||Ue.push({segments:Vr?ve.icon.segments:new s.aB([]),sortKey:0,state:$t}),g.onlyIcons||Ue.push({segments:nr?ve.text.segments:new s.aB([]),sortKey:0,state:fr})}he&&Ue.sort((Ee,ue)=>Ee.sortKey-ue.sortKey);for(const Ee of Ue){const ue=Ee.state;if(ue)if(c.terrain&&c.terrain.setupElevationDraw(ue.tile,ue.program,{useDepthForOcclusion:q.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:ue.labelPlaneMatrixInv}),G.activeTexture.set(K.TEXTURE0),ue.atlasTexture&&ue.atlasTexture.bind(ue.atlasInterpolation,K.CLAMP_TO_EDGE,!0),ue.atlasTextureIcon&&(G.activeTexture.set(K.TEXTURE1),ue.atlasTextureIcon&&ue.atlasTextureIcon.bind(ue.atlasInterpolationIcon,K.CLAMP_TO_EDGE,!0)),c.uploadCommonLightUniforms(c.context,ue.program),ue.hasHalo){const ve=ue.uniformValues;ve.u_is_halo=1,qo(ue.buffers,Ee.segments,o,c,ue.program,we,d,p,ve,2),ve.u_is_halo=0}else{if(ue.isSDF){const ve=ue.uniformValues;ue.hasHalo&&(ve.u_is_halo=1,qo(ue.buffers,Ee.segments,o,c,ue.program,we,d,p,ve,1)),ve.u_is_halo=0}qo(ue.buffers,Ee.segments,o,c,ue.program,we,d,p,ue.uniformValues,1)}}}function qo(c,i,o,u,d,p,g,v,w,M){const I=[c.dynamicLayoutVertexBuffer,c.opacityVertexBuffer,c.iconTransitioningVertexBuffer,c.globeExtVertexBuffer,c.zOffsetVertexBuffer];d.draw(u,u.context.gl.TRIANGLES,p,g,v,Rt.disabled,w,o.id,c.layoutVertexBuffer,c.indexBuffer,i,o.paint,u.transform.zoom,c.programConfigurations.get(o.id),I,M)}function ws(c,i,o,u,d,p,g){const v=c.context.gl,w=o.paint.get("fill-pattern"),M=w&&w.constantOr(1);let I,S,z,R,U;g?(S=M&&!o.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",I=v.LINES):(S=M?"fillPattern":"fill",I=v.TRIANGLES);for(const N of u){const V=i.getTile(N);if(M&&!V.patternsLoaded())continue;const B=V.getBucket(o);if(!B)continue;c.prepareDrawTile();const G=B.programConfigurations.get(o.id),K=c.isTileAffectedByFog(N),q=c.getOrCreateProgram(S,{config:G,overrideFog:K});M&&(c.context.activeTexture.set(v.TEXTURE0),V.imageAtlasTexture&&V.imageAtlasTexture.bind(v.LINEAR,v.CLAMP_TO_EDGE),G.updatePaintBuffers());const J=w.constantOr(null);if(J&&V.imageAtlas){const oe=V.imageAtlas.patternPositions[J.toString()];oe&&G.setConstantPatternPositions(oe)}const j=c.translatePosMatrix(N.projMatrix,V,o.paint.get("fill-translate"),o.paint.get("fill-translate-anchor")),Q=o.paint.get("fill-emissive-strength");if(g){R=B.indexBuffer2,U=B.segments2;const oe=c.terrain&&c.terrain.renderingToTexture?c.terrain.drapeBufferSize:[v.drawingBufferWidth,v.drawingBufferHeight];z=S==="fillOutlinePattern"&&M?Pd(j,Q,c,V,oe):bs(j,Q,oe)}else R=B.indexBuffer,U=B.segments,z=M?Nu(j,Q,c,V):sa(j,Q);c.uploadCommonUniforms(c.context,q,N.toUnwrapped()),q.draw(c,I,d,c.stencilModeForClipping(N),p,Rt.disabled,z,o.id,B.layoutVertexBuffer,R,U,o.paint,c.transform.zoom,G,void 0)}}function bt(c,i,o,u,d,p,g,v){o.resetLayerRenderingStats(c);const w=c.context,M=w.gl,I=c.transform,S=o.paint.get("fill-extrusion-pattern"),z=S.constantOr(1),R=o.paint.get("fill-extrusion-opacity"),U=c.style.enable3dLights(),N=o.paint.get(U&&!z?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),V=[o.paint.get("fill-extrusion-ambient-occlusion-intensity"),N],B=o.layout.get("fill-extrusion-edge-radius"),G=B>0&&!o.paint.get("fill-extrusion-rounded-roof"),K=G?0:B,q=I.projection.name==="globe"?s.cF():0,J=I.projection.name==="globe",j=J?s.S(I.zoom):0,Q=[s.a5(I.center.lng),s.ae(I.center.lat)],oe=o.paint.get("fill-extrusion-flood-light-color").toArray01().slice(0,3),le=o.paint.get("fill-extrusion-flood-light-intensity"),he=o.paint.get("fill-extrusion-vertical-scale"),we=Zo(c,o.paint.get("fill-extrusion-cutoff-fade-range")),me=o.paint.get("fill-extrusion-emissive-strength"),Ae=[];let Ie;J&&Ae.push("PROJECTION_GLOBE_VIEW"),V[0]>0&&Ae.push("FAUX_AO"),G&&Ae.push("ZERO_ROOF_RADIUS"),v&&Ae.push("HAS_CENTROID"),le>0&&Ae.push("FLOOD_LIGHT"),we.shouldRenderCutoff&&Ae.push("RENDER_CUTOFF");const Ue=c.renderPass==="shadow",ge=c.shadowRenderer,Ee=Ue&&!!ge;c.shadowRenderer&&(c.shadowRenderer.useNormalOffset=!0);let ue=[0,0,0];if(ge){const Ye=c.style.directionalLight,Xe=c.style.ambientLight;Ye&&Xe&&(ue=Za(Ye,Xe)),Ie=Ae.concat(["SHADOWS_SINGLE_CASCADE"])}const ve=Ee?"fillExtrusionDepth":z?"fillExtrusionPattern":"fillExtrusion",Ve=o.getLayerRenderingStats();for(const Ye of u){const Xe=i.getTile(Ye),ot=Xe.getBucket(o);if(!ot||ot.projection.name!==I.projection.name)continue;let yt=!1;ge&&(yt=ge.getMaxCascadeForTile(Ye.toUnwrapped())===0);const Pt=c.isTileAffectedByFog(Ye),Tt=ot.programConfigurations.get(o.id),It=c.getOrCreateProgram(ve,{config:Tt,defines:yt?Ie:Ae,overrideFog:Pt});if(c.terrain&&c.terrain.setupElevationDraw(Xe,It,{useMeterToDem:!0}),!ot.centroidVertexBuffer){const Vr=It.attributes.a_centroid_pos;Vr!==void 0&&M.vertexAttrib2f(Vr,0,0)}!Ue&&ge&&ge.setupShadows(Xe.tileID.toUnwrapped(),It,"vector-tile",Xe.tileID.overscaledZ),z&&(c.context.activeTexture.set(M.TEXTURE0),Xe.imageAtlasTexture&&Xe.imageAtlasTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE),Tt.updatePaintBuffers());const Yt=S.constantOr(null);if(Yt&&Xe.imageAtlas){const Vr=Xe.imageAtlas.patternPositions[Yt.toString()];Vr&&Tt.setConstantPatternPositions(Vr)}const Vt=o.paint.get("fill-extrusion-vertical-gradient");let qt;if(Ue&&ge){if(Bd(Xe.tileID,ot,c))continue;const Vr=ge.calculateShadowPassMatrixFromTile(Xe.tileID.toUnwrapped());qt=Fu(Vr,K,he)}else{const Vr=c.translatePosMatrix(Ye.expandedProjMatrix,Xe,o.paint.get("fill-extrusion-translate"),o.paint.get("fill-extrusion-translate-anchor")),nr=I.projection.createInversionMatrix(I,Ye.canonical);qt=z?vs(Vr,c,Vt,R,V,K,Ye,Xe,q,j,Q,nr,oe,he):Bu(Vr,c,Vt,R,V,K,Ye,q,j,Q,nr,oe,he,le,ue,me)}c.uploadCommonUniforms(w,It,Ye.toUnwrapped(),null,we);let $t=ot.segments;if(I.projection.name==="mercator"&&!Ue&&($t=ot.getVisibleSegments(Xe.tileID,c.terrain,c.transform.getFrustum(0)),!$t.get().length))continue;if(Ve)if(Ue)for(const Vr of $t.get())Ve.numRenderedVerticesInShadowPass+=Vr.primitiveLength;else for(const Vr of $t.get())Ve.numRenderedVerticesInTransparentPass+=Vr.primitiveLength;const fr=[];(c.terrain||v)&&fr.push(ot.centroidVertexBuffer),J&&fr.push(ot.layoutVertexExtBuffer),It.draw(c,w.gl.TRIANGLES,d,p,g,Rt.backCCW,qt,o.id,ot.layoutVertexBuffer,ot.indexBuffer,$t,o.paint,c.transform.zoom,Tt,fr)}c.shadowRenderer&&(c.shadowRenderer.useNormalOffset=!1)}function Wo(c,i,o,u,d,p,g,v,w,M,I,S,z,R,U,N,V,B,G){const K=c.context,q=K.gl,J=c.transform,j=c.transform.zoom,Q=[],oe=Zo(c,o.paint.get("fill-extrusion-cutoff-fade-range"));M==="clear"?(Q.push("CLEAR_SUBPASS"),G&&(Q.push("CLEAR_FROM_TEXTURE"),K.activeTexture.set(q.TEXTURE0),G.bind(q.LINEAR,q.CLAMP_TO_EDGE))):M==="sdf"&&Q.push("SDF_SUBPASS"),V&&Q.push("HAS_CENTROID"),oe.shouldRenderCutoff&&Q.push("RENDER_CUTOFF");const le=o.layout.get("fill-extrusion-edge-radius"),he=(we,me,Ae,Ie,Ue)=>{const ge=me.programConfigurations.get(o.id),Ee=c.isTileAffectedByFog(we),ue=c.getOrCreateProgram("fillExtrusionGroundEffect",{config:ge,defines:Q,overrideFog:Ee}),ve=((Ye,Xe,ot,yt,Pt,Tt,It,Yt,Vt,qt,$t)=>({u_matrix:Xe,u_opacity:ot,u_ao_pass:yt?1:0,u_meter_to_tile:Pt,u_ao:Tt,u_flood_light_intensity:It,u_flood_light_color:Yt,u_attenuation:Vt,u_edge_radius:qt,u_fb:0,u_fb_size:$t}))(0,Ie,I,w,Ue,[S,z*Ue],R,U,N,j>=17?0:le*Ue,G?G.size[0]:0),Ve=[];V&&Ve.push(me.hiddenByLandmarkVertexBuffer),c.uploadCommonUniforms(K,ue,we.toUnwrapped(),null,oe),ue.draw(c,K.gl.TRIANGLES,d,p,g,v,ve,o.id,me.vertexBuffer,me.indexBuffer,Ae,o.paint,j,ge,Ve)};for(const we of u){const me=i.getTile(we),Ae=me.getBucket(o);if(!Ae||Ae.projection.name!==J.projection.name||!Ae.groundEffect||Ae.groundEffect&&!Ae.groundEffect.hasData())continue;const Ie=Ae.groundEffect,Ue=1/Ae.tileToMeter;{const ge=c.translatePosMatrix(we.projMatrix,me,o.paint.get("fill-extrusion-translate"),o.paint.get("fill-extrusion-translate-anchor")),Ee=Ie.getDefaultSegment();he(we,Ie,Ee,ge,Ue)}if(B)for(let ge=0;ge<4;ge++){const Ee=s.cG[ge](we),ue=i.getTile(Ee);if(!ue)continue;const ve=ue.getBucket(o);if(!ve||ve.projection.name!==J.projection.name||!ve.groundEffect||ve.groundEffect&&!ve.groundEffect.hasData())continue;const Ve=ve.groundEffect;let Ye,Xe;ge===0?(Ye=[-s.V,0,0],Xe=1):ge===1?(Ye=[s.V,0,0],Xe=0):ge===2?(Ye=[0,-s.V,0],Xe=3):(Ye=[0,s.V,0],Xe=2);const ot=Ve.regionSegments[Xe];if(!ot)continue;const yt=new Float32Array(16);s.a6.translate(yt,we.projMatrix,Ye),he(we,Ve,ot,c.translatePosMatrix(yt,me,o.paint.get("fill-extrusion-translate"),o.paint.get("fill-extrusion-translate-anchor")),Ue)}}}function Jp(c,i,o,u,d,p,g){u.centroidVertexArray.length===0&&u.createCentroidsBuffer();const v=p?p.findDEMTileFor(o):null;if(!(v&&v.dem||g))return;const w=B=>new s.P(Math.ceil((B+s.cJ)*s.cK),0),M=B=>{const G=i.getSource().minzoom,K=J=>{const j=i.getTileByID(J);if(j&&j.hasData())return j.getBucket(d)},q=[0,-1,1];for(const J of q){if(B.overscaledZ+J<G)continue;const j=K(B.calculateScaledKey(B.overscaledZ+J));if(j)return j}},I=[0,0,0],S=(B,G)=>(I[0]=Math.min(B.min.y,G.min.y),I[1]=Math.max(B.max.y,G.max.y),I[2]=s.V-G.min.x>B.max.x?G.min.x-s.V:B.max.x,I),z=(B,G)=>(I[0]=Math.min(B.min.x,G.min.x),I[1]=Math.max(B.max.x,G.max.x),I[2]=s.V-G.min.y>B.max.y?G.min.y-s.V:B.max.y,I),R=[(B,G)=>S(B,G),(B,G)=>S(G,B),(B,G)=>z(B,G),(B,G)=>z(G,B)],U=(B,G,K,q,J,j,Q)=>{if(!p)return 0;const oe=[[j?K:B,j?B:K,0],[j?K:G,j?G:K,0]],le=Q<0?s.V+Q:Q,he=[j?le:(B+G)/2,j?(B+G)/2:le,0];return K===0&&Q<0||K!==0&&Q>0?p.getForTilePoints(J,[he],!0,q):oe.push(he),p.getForTilePoints(o,oe,!0,v),Math.max(oe[0][2],oe[1][2],he[2])/p.exaggeration()};for(let B=0;B<4;B++){const G=u.borderFeatureIndices[B];if(G.length===0)continue;const K=s.cG[B](o),q=M(K);if(!(q&&q instanceof s.cH)||u.borderDoneWithNeighborZ[B]===q.canonical.z)continue;q.centroidVertexArray.length===0&&q.createCentroidsBuffer();const J=p?p.findDEMTileFor(K):null;if(!(J&&J.dem||g))continue;const j=(B<2?1:5)-B,Q=q.borderDoneWithNeighborZ[j]!==u.canonical.z,oe=q.borderFeatureIndices[j];let le=0;if(u.canonical.z!==q.canonical.z){for(const he of G)u.showCentroid(u.featuresOnBorder[he]);if(Q)for(const he of oe)q.showCentroid(q.featuresOnBorder[he]);u.borderDoneWithNeighborZ[B]=q.canonical.z,q.borderDoneWithNeighborZ[j]=u.canonical.z}for(const he of G){const we=u.featuresOnBorder[he],me=u.centroidData[we.centroidDataIndex],Ae=we.borders[B];let Ie;for(;le<oe.length;){Ie=q.featuresOnBorder[oe[le]];const Ue=Ie.borders[j];if(Ue[1]>Ae[0]+3||Ue[0]>Ae[0]-3)break;q.showCentroid(Ie),le++}if(Ie&&le<oe.length){const Ue=le;let ge=0;for(;!(Ie.borders[j][0]>Ae[1]-3)&&(ge++,++le!==oe.length);)Ie=q.featuresOnBorder[oe[le]];if(Ie=q.featuresOnBorder[oe[Ue]],ge>1){const ve=Ie.borders[j];Math.abs(Ae[0]-ve[0])<3&&Math.abs(Ae[1]-ve[1])<3&&(ge=1,le=Ue+1)}else if(ge===0){u.showCentroid(we);continue}const Ee=q.centroidData[Ie.centroidDataIndex];g&&ge===1&&(((N=me).flags|(V=Ee).flags)&s.cI?(N.flags|=s.cI,V.flags|=s.cI):(N.flags&=~s.cI,V.flags&=~s.cI));const ue=we.intersectsCount()>1||Ie.intersectsCount()>1;if(ge>1)le=Ue,me.centroidXY=Ee.centroidXY=new s.P(0,0);else if(J&&J.dem&&!ue){const ve=R[B](me,Ee),Ve=B%2?s.V-1:0,Ye=U(ve[0],Math.min(s.V-1,ve[1]),Ve,J,K,B<2,ve[2]);me.centroidXY=Ee.centroidXY=w(Ye)}else ue?me.centroidXY=Ee.centroidXY=new s.P(0,0):(me.centroidXY=u.encodeBorderCentroid(we),Ee.centroidXY=q.encodeBorderCentroid(Ie));u.writeCentroidToBuffer(me),q.writeCentroidToBuffer(Ee)}else u.showCentroid(we)}u.borderDoneWithNeighborZ[B]=q.canonical.z,q.borderDoneWithNeighborZ[j]=u.canonical.z}var N,V;(u.needsCentroidUpdate||!u.centroidVertexBuffer&&u.centroidVertexArray.length!==0)&&u.uploadCentroid(c)}const Qp=[1,0,0],Gu=[0,1,0],kd=[0,0,1];function Bd(c,i,o){const u=o.transform,d=o.shadowRenderer;if(!d)return!0;const p=c.toUnwrapped(),g=u.tileSize*d._cascades[o.currentShadowCascade].scale;let v=i.maxHeight;if(u.elevation){const N=u.elevation.getMinMaxForTile(c);N&&(v+=N.max)}const w=[...d.shadowDirection];w[2]=-w[2];const M=d.computeSimplifiedTileShadowVolume(p,v,g,w);if(!M)return!1;const I=[Qp,Gu,kd,w,[w[0],0,w[2]],[0,w[1],w[2]]],S=u.projection.name==="globe",z=u.scaleZoom(g),R=s.bq.fromInvProjectionMatrix(u.invProjMatrix,u.worldSize,z,!S),U=d.getCurrentCascadeFrustum();return R.intersectsPrecise(M.vertices,M.planes,I)===0||U.intersectsPrecise(M.vertices,M.planes,I)===0}function Fd(c){return[c[0]*s.cL,c[1]*s.cL,c[2]*s.cL,0]}function $u(c,i,o,u,d,p,g,v,w){const M=u.getSource(),I=o.globeSharedBuffers;if(!I)return;let S,z,R;if(i&&(S=u.getTile(i)),M instanceof s.ap?(z=M.texture,R=s.cj(0,0,o.transform)):S&&i&&(z=S.texture,R=s.cj(i.canonical.z,i.canonical.x,o.transform)),!z||!R)return;c||(R=s.a6.scale(s.a6.create(),R,[1,-1,1]));const U=o.context,N=U.gl,V=d.paint.get("raster-resampling")==="nearest"?N.NEAREST:N.LINEAR,B=o.colorModeForDrapableLayerRenderPass(p),G=g.defines;G.push("GLOBE_POLES");const K=new zt(N.LEQUAL,zt.ReadWrite,o.depthRangeFor3D),q=Float32Array.from(o.transform.expandedFarZProjMatrix),J=Float32Array.from(s.aT(s.ci(new s.bs(0,0,0))));o.terrain&&o.terrain.prepareDrawTile(),U.activeTexture.set(N.TEXTURE0),z.bind(V,N.CLAMP_TO_EDGE),U.activeTexture.set(N.TEXTURE1),z.bind(V,N.CLAMP_TO_EDGE),z.useMipmap&&U.extTextureFilterAnisotropic&&o.transform.pitch>20&&N.texParameterf(N.TEXTURE_2D,U.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,U.extTextureFilterAnisotropicMax);const[j,Q,oe,le]=i?I.getPoleBuffers(i.canonical.z,!1):I.getPoleBuffers(0,!0),he=d.paint.get("raster-elevation");let we;c?(we=j,o.renderDefaultNorthPole=he!==0):(we=Q,o.renderDefaultSouthPole=he!==0);const me=Fd(g.mix),Ae=((Ue,ge,Ee,ue,ve,Ve,Ye,Xe,ot,yt,Pt,Tt,It)=>ju(Ue,ge,Ee,new Float32Array(16),new Float32Array(9),[0,0],ue,[0,0],[0,0,0,0],1,{opacity:1,mix:0},Ve,[0,0],Xe,2,yt,Pt,Tt,1,0,It))(q,J,R,s.S(o.transform.zoom),0,d,0,he,0,me,g.offset,g.range,p),Ie=o.getOrCreateProgram("raster",{defines:G});o.uploadCommonUniforms(U,Ie,null),Ie.draw(o,N.TRIANGLES,K,w,B,v,Ae,d.id,we,oe,le)}function qu(c){const i=c._nearZ,o=c.projection.farthestPixelDistance(c),u=o-i,d=.2*c.height,p=i+d;return[i,o,(p-d-i)/u,(p-i)/u]}function Wu(c,i,o,u){if(c)return i instanceof Qe&&c instanceof ps?i.getTextureDescriptor(c,o,!0):{texture:c.texture,mix:Fd(u.mix),offset:u.offset,buffer:0,tileSize:1}}function Hu(c,i,o){if(!c)return null;const u=i.getTextureDescriptor(c,o,!0);if(!u)return null;let{texture:d,mix:p,offset:g,tileSize:v,buffer:w,format:M}=u;if(!d||!M)return null;let I=!1;return M==="uint32"&&(I=!0,p[3]=0,p=rc(s.cM,p,[0,o.paint.get("raster-particle-max-speed")]),g=Dd(s.cM,g,[0,o.paint.get("raster-particle-max-speed")])),{texture:d,textureOffset:[w/(v+2*w),v/(v+2*w)],tileSize:v,scalarData:I,scale:p,offset:g,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[M]]}}function Xu(c){const i=c._nearZ,o=c.projection.farthestPixelDistance(c),u=o-i,d=.2*c.height,p=i+d;return[i,o,(p-d-i)/u,(p-i)/u]}const an=new s.ax(1,0,0,1),Ho=new s.ax(0,1,0,1),Nd=new s.ax(0,0,1,1),Yu=new s.ax(1,0,1,1),Ku=new s.ax(0,1,1,1);function Xo(c,i,o,u,d,p,g){const v=c.context,w=c.transform,M=v.gl,I=w.projection.name==="globe",S=I?["PROJECTION_GLOBE_VIEW"]:[];let z=s.a6.clone(o.projMatrix);if(I&&s.S(w.zoom)>0){const me=s.aS(o.canonical,w),Ae=s.cN(me);z=s.a6.multiply(new Float32Array(16),w.globeMatrix,Ae),s.a6.multiply(z,w.projMatrix,z)}const R=s.a6.create();R[12]+=2*d/(s.f.devicePixelRatio*w.width),R[13]+=2*p/(s.f.devicePixelRatio*w.height),s.a6.multiply(z,R,z);const U=c.getOrCreateProgram("debug",{defines:S}),N=i.getTileByID(o.key);c.terrain&&c.terrain.setupElevationDraw(N,U);const V=zt.disabled,B=jt.disabled,G=c.colorModeForRenderPass(),K="$debug";v.activeTexture.set(M.TEXTURE0),c.emptyTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE),I?N._makeGlobeTileDebugBuffers(c.context,w):N._makeDebugTileBoundsBuffers(c.context,w.projection);const q=N._tileDebugBuffer||c.debugBuffer,J=N._tileDebugIndexBuffer||c.debugIndexBuffer,j=N._tileDebugSegments||c.debugSegments;if(U.draw(c,M.LINE_STRIP,V,B,G,Rt.disabled,Uu(z,u),K,q,J,j,null,null,null,[N._globeTileDebugBorderBuffer]),g){const me=N.latestRawTileData,Ae=Math.floor((me&&me.byteLength||0)/1024);let Ie=o.canonical.toString();o.overscaledZ!==o.canonical.z&&(Ie+=` => ${o.overscaledZ}`),Ie+=` ${N.state}`,Ie+=` ${Ae}kb`,function(Ue,ge){Ue.initDebugOverlayCanvas();const Ee=Ue.debugOverlayCanvas,ue=Ue.context.gl,ve=Ue.debugOverlayCanvas.getContext("2d");ve.clearRect(0,0,Ee.width,Ee.height),ve.shadowColor="white",ve.shadowBlur=2,ve.lineWidth=1.5,ve.strokeStyle="white",ve.textBaseline="top",ve.font="bold 36px Open Sans, sans-serif",ve.fillText(ge,5,5),ve.strokeText(ge,5,5),Ue.debugOverlayTexture.update(Ee),Ue.debugOverlayTexture.bind(ue.LINEAR,ue.CLAMP_TO_EDGE)}(c,Ie)}const Q=i.getTile(o).tileSize,oe=512/Math.min(Q,512)*(o.overscaledZ/w.zoom)*.5,le=N._tileDebugTextBuffer||c.debugBuffer,he=N._tileDebugTextIndexBuffer||c.quadTriangleIndexBuffer,we=N._tileDebugTextSegments||c.debugSegments;U.draw(c,M.TRIANGLES,V,B,rr.alphaBlended,Rt.disabled,Uu(z,s.ax.transparent,oe),K,le,he,we,null,null,null,[N._globeTileDebugTextBuffer])}function Ju(c,i,o,u){ei(c,0,i+o/2,c.transform.width,o,u)}function vn(c,i,o,u){ei(c,i-o/2,0,o,c.transform.height,u)}function ei(c,i,o,u,d,p){const g=c.context,v=g.gl;v.enable(v.SCISSOR_TEST),v.scissor(i*s.f.devicePixelRatio,o*s.f.devicePixelRatio,u*s.f.devicePixelRatio,d*s.f.devicePixelRatio),g.clear({color:p}),v.disable(v.SCISSOR_TEST)}const ac=s.ay([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:Qu}=ac;function xo(c,i,o,u){c.emplaceBack(i,o,u)}class eh{constructor(i){this.vertexArray=new s.az,this.indices=new s.aw,xo(this.vertexArray,-1,-1,1),xo(this.vertexArray,1,-1,1),xo(this.vertexArray,-1,1,1),xo(this.vertexArray,1,1,1),xo(this.vertexArray,-1,-1,-1),xo(this.vertexArray,1,-1,-1),xo(this.vertexArray,-1,1,-1),xo(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=i.createVertexBuffer(this.vertexArray,Qu),this.indexBuffer=i.createIndexBuffer(this.indices),this.segment=s.aB.simpleSegment(0,0,36,12)}}function Ts(c,i,o,u,d,p){const g=c.context.gl,v=i.paint.get("sky-atmosphere-color"),w=i.paint.get("sky-atmosphere-halo-color"),M=i.paint.get("sky-atmosphere-sun-intensity"),I=((S,z,R,U,N)=>({u_matrix_3f:S,u_sun_direction:z,u_sun_intensity:R,u_color_tint_r:[U.r,U.g,U.b,U.a],u_color_tint_m:[N.r,N.g,N.b,N.a],u_luminance:5e-5}))(s.co.fromMat4(s.co.create(),u),d,M,v,w);g.framebufferTexture2D(g.FRAMEBUFFER,g.COLOR_ATTACHMENT0,g.TEXTURE_CUBE_MAP_POSITIVE_X+p,i.skyboxTexture,0),o.draw(c,g.TRIANGLES,zt.disabled,jt.disabled,rr.unblended,Rt.frontCW,I,"skyboxCapture",i.skyboxGeometry.vertexBuffer,i.skyboxGeometry.indexBuffer,i.skyboxGeometry.segment)}const em=s.ay([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class aa{constructor(i){const o=new s.cO;o.emplaceBack(-1,1,1,0,0),o.emplaceBack(1,1,1,1,0),o.emplaceBack(1,-1,1,1,1),o.emplaceBack(-1,-1,1,0,1);const u=new s.aw;u.emplaceBack(0,1,2),u.emplaceBack(2,3,0),this.vertexBuffer=i.createVertexBuffer(o,em.members),this.indexBuffer=i.createIndexBuffer(u),this.segments=s.aB.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const Ja=s.ay([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class Je{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class Lt{constructor(i){this.colorModeAlphaBlendedWriteRGB=new rr([1,ko,1,ko],s.ax.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new rr([1,0,1,0],s.ax.transparent,[!1,!1,!1,!0]),this.params=new Je,this.updateNeeded=!0,i.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},()=>{this.updateNeeded=!0}),i.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),i.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0}),i.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0})}update(i){const o=i.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new aa(o);const u=this.params.sizeRange,d=this.params.intensityRange,p=function(I){const S=s.aA(30),z=[];for(let R=0;R<I;++R){const U=2*Math.PI*S(),N=Math.acos(1-2*S())-.5*Math.PI;z.push(s.N.fromValues(Math.cos(N)*Math.cos(U),Math.cos(N)*Math.sin(U),Math.sin(N)))}return z}(this.params.starsCount),g=s.aA(300),v=new s.cP,w=new s.aw;let M=0;for(let I=0;I<p.length;++I){const S=s.N.scale([],p[I],200),z=Math.max(0,1+.01*u*(1*g()-.5)),R=Math.max(0,1+.01*d*(1*g()-.5));v.emplaceBack(S[0],S[1],S[2],-1,-1,z,R),v.emplaceBack(S[0],S[1],S[2],1,-1,z,R),v.emplaceBack(S[0],S[1],S[2],1,1,z,R),v.emplaceBack(S[0],S[1],S[2],-1,1,z,R),w.emplaceBack(M+0,M+1,M+2),w.emplaceBack(M+0,M+2,M+3),M+=4}this.starsVx=o.createVertexBuffer(v,Ja.members),this.starsIdx=o.createIndexBuffer(w),this.starsSegments=s.aB.simpleSegment(0,0,v.length,w.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(i,o){const u=i.context,d=u.gl,p=i.transform,g=new zt(d.LEQUAL,zt.ReadOnly,[0,1]),v=s.S(p.zoom),w=o.properties.get("color").toArray01(),M=o.properties.get("high-color").toArray01(),I=o.properties.get("space-color").toArray01PremultipliedAlpha(),S=5e-4,z=s.cQ(o.properties.get("horizon-blend"),0,1,S,.25),R=s.cd(i,u,p)&&z===S?p.worldSize/(2*Math.PI*1.025)-1:p.globeRadius,U=i.frameCounter/1e3%1,N=s.N.length(p.globeCenterInViewSpace),V=Math.sqrt(Math.pow(N,2)-Math.pow(R,2)),B=Math.acos(V/N),G=K=>{const q=p.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];K&&q.push("ALPHA_PASS");const J=i.getOrCreateProgram("globeAtmosphere",{defines:q}),j=((oe,le,he,we,me,Ae,Ie,Ue,ge,Ee,ue,ve)=>({u_frustum_tl:oe,u_frustum_tr:le,u_frustum_br:he,u_frustum_bl:we,u_horizon:me,u_transition:Ae,u_fadeout_range:Ie,u_color:Ue,u_high_color:ge,u_space_color:Ee,u_temporal_offset:ue,u_horizon_angle:ve}))(p.frustumCorners.TL,p.frustumCorners.TR,p.frustumCorners.BR,p.frustumCorners.BL,p.frustumCorners.horizon,v,z,w,M,I,U,B);i.uploadCommonUniforms(u,J);const Q=this.atmosphereBuffer;Q&&J.draw(i,d.TRIANGLES,g,jt.disabled,K?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Rt.backCW,j,K?"atmosphere_glow_alpha":"atmosphere_glow",Q.vertexBuffer,Q.indexBuffer,Q.segments)};G(!1),G(!0)}drawStars(i,o){const u=s.aa(o.properties.get("star-intensity"),0,1);if(u===0)return;const d=i.context,p=d.gl,g=i.transform,v=i.getOrCreateProgram("stars"),w=s.bi.identity([]);s.bi.rotateX(w,w,-g._pitch),s.bi.rotateZ(w,w,-g.angle),s.bi.rotateX(w,w,s.bj(g._center.lat)),s.bi.rotateY(w,w,-s.bj(g._center.lng));const M=s.a6.fromQuat(new Float32Array(16),w),I=s.a6.multiply([],g.starsProjMatrix,M),S=s.co.fromMat4([],M),z=s.co.invert([],S),R=[0,1,0];s.N.transformMat3(R,R,z),s.N.scale(R,R,this.params.sizeMultiplier);const U=[1,0,0];s.N.transformMat3(U,U,z),s.N.scale(U,U,this.params.sizeMultiplier);const N=(V=R,B=U,G=u,{u_matrix:Float32Array.from(I),u_up:V,u_right:B,u_intensity_multiplier:G});var V,B,G;i.uploadCommonUniforms(d,v),this.starsVx&&this.starsIdx&&v.draw(i,p.TRIANGLES,zt.disabled,jt.disabled,this.colorModeAlphaBlendedWriteRGB,Rt.disabled,N,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function Es(c,i){const o=[...c],u=i.cameraWorldSizeForFog/i.worldSize,d=s.a6.identity([]);return s.a6.scale(d,d,[u,u,1]),s.a6.multiply(o,d,o),s.a6.multiply(o,i.worldToFogMatrix,o),o}function ti(c,i,o,u){const d=o.material,p=u.context,{baseColorTexture:g,metallicRoughnessTexture:v}=d.pbrMetallicRoughness,{normalTexture:w,occlusionTexture:M,emissionTexture:I}=d;function S(z,R,U){if(z&&(c.push(R),p.activeTexture.set(p.gl.TEXTURE0+U),z.gfxTexture)){const{minFilter:N,magFilter:V,wrapS:B,wrapT:G}=z.sampler;z.gfxTexture.bindExtraParam(N,V,B,G)}}S(g,"HAS_TEXTURE_u_baseColorTexture",ji.BaseColor),S(v,"HAS_TEXTURE_u_metallicRoughnessTexture",ji.MetallicRoughness),S(w,"HAS_TEXTURE_u_normalTexture",ji.Normal),S(M,"HAS_TEXTURE_u_occlusionTexture",ji.Occlusion),S(I,"HAS_TEXTURE_u_emissionTexture",ji.Emission),o.texcoordBuffer&&(c.push("HAS_ATTRIBUTE_a_uv_2f"),i.push(o.texcoordBuffer)),o.colorBuffer&&(c.push(o.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),i.push(o.colorBuffer)),o.normalBuffer&&(c.push("HAS_ATTRIBUTE_a_normal_3f"),i.push(o.normalBuffer)),o.pbrBuffer&&(c.push("HAS_ATTRIBUTE_a_pbr"),c.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),i.push(o.pbrBuffer)),d.alphaMode!=="OPAQUE"&&d.alphaMode!=="MASK"||c.push("UNPREMULT_TEXTURE_IN_SHADER"),d.defined||c.push("DIFFUSE_SHADED"),c.push("USE_STANDARD_DERIVATIVES")}function Qa(c,i,o,u,d,p){const g=o.paint.get("model-opacity"),v=i.context,w=new zt(i.context.gl.LEQUAL,zt.ReadWrite,i.depthRangeFor3D),M=i.transform,I=c.mesh,S=I.material,z=S.pbrMetallicRoughness,R=i.style.fog;let U;U=i.transform.projection.zAxisUnit==="pixels"?[...c.nodeModelMatrix]:s.a6.multiply([],u.zScaleMatrix,c.nodeModelMatrix),s.a6.multiply(U,u.negCameraPosMatrix,U);const N=s.a6.invert([],U);s.a6.transpose(N,N);const V=o.paint.get("model-emissive-strength").constantOr(0),B=oc(new Float32Array(c.worldViewProjection),new Float32Array(U),new Float32Array(N),i,g,z.baseColorFactor,S.emissiveFactor,z.metallicFactor,z.roughnessFactor,S,V,o),G={defines:[]},K=[];ti(G.defines,K,I,i);const q=i.shadowRenderer;q&&(q.useNormalOffset=!1);let J=null;if(R){const oe=Es(c.nodeModelMatrix,i.transform);if(J=new Float32Array(oe),M.projection.name!=="globe"){const le=I.aabb.min,he=I.aabb.max,[we,me]=R.getOpacityForBounds(oe,le[0],le[1],he[0],he[1]);G.overrideFog=we>=Pr||me>=Pr}}const j=Zo(i,o.paint.get("model-cutoff-fade-range"));j.shouldRenderCutoff&&G.defines.push("RENDER_CUTOFF");const Q=i.getOrCreateProgram("model",G);i.uploadCommonUniforms(v,Q,null,J,j),i.renderPass!=="shadow"&&q&&q.setupShadowsFromMatrix(c.nodeModelMatrix,Q),Q.draw(i,v.gl.TRIANGLES,w,d,p,I.material.doubleSided?Rt.disabled:Rt.backCCW,B,o.id,I.vertexBuffer,I.indexBuffer,I.segments,o.paint,i.transform.zoom,void 0,K)}function el(c,i,o,u,d,p,g){let v;v=c.projection.name==="globe"?s.cS(o,c):[...o],s.a6.multiply(v,v,i.matrix);const w=s.a6.multiply([],u,v);if(i.meshes)for(const M of i.meshes){if(M.material.alphaMode!=="BLEND"){g.push({mesh:M,depth:0,modelIndex:d,worldViewProjection:w,nodeModelMatrix:v});continue}const I=s.N.transformMat4([],M.centroid,w);I[2]>0&&p.push({mesh:M,depth:I[2],modelIndex:d,worldViewProjection:w,nodeModelMatrix:v})}if(i.children)for(const M of i.children)el(c,M,o,u,d,p,g)}function be(c,i,o,u){const d=o.shadowRenderer;if(!d)return;const p=d.getShadowPassDepthMode(),g=d.getShadowPassColorMode(),v=d.calculateShadowPassMatrixFromMatrix(i),w=Ya(v);o.getOrCreateProgram("modelDepth",{defines:o._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(o,o.context.gl.TRIANGLES,p,jt.disabled,g,Rt.backCCW,w,u.id,c.vertexBuffer,c.indexBuffer,c.segments,u.paint,o.transform.zoom,void 0,void 0)}function th(c,i,o){const u=i.updateZoomBasedPaintProperties(),d=function(p,g,v){let w,M,I,S=p.terrain?p.terrain.exaggeration():0;if(p.terrain&&S>0){const z=p.terrain,R=z.findDEMTileFor(v);R&&R.dem?w=s.cU.create(z,v,R):S=0}if(S===0&&(g.terrainElevationMin=0,g.terrainElevationMax=0),S===g.validForExaggeration&&(S===0||w&&w._demTile&&w._demTile.tileID===g.validForDEMTile.id&&w._dem._timestamp===g.validForDEMTile.timestamp))return!1;for(const z in g.instancesPerModel){const R=g.instancesPerModel[z];for(let U=0;U<R.instancedDataArray.length;++U){const N=(w?S*w.getElevationAt(0|R.instancedDataArray.float32[16*U],0|R.instancedDataArray.float32[16*U+1],!0,!0):0)+R.instancesEvaluatedElevation[U];R.instancedDataArray.float32[16*U+6]=N,M=M?Math.min(g.terrainElevationMin,N):N,I=I?Math.max(g.terrainElevationMax,N):N}}return g.terrainElevationMin=M||0,g.terrainElevationMax=I||0,g.validForExaggeration=S,g.validForDEMTile=w&&w._demTile?{id:w._demTile.tileID,timestamp:w._dem._timestamp}:{id:void 0,timestamp:0},!0}(c,i,o);(u||d)&&(i.uploaded=!1,i.upload(c.context))}const bn={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new s.bS([0,0,0],[s.V,s.V,0])};function Ud(c,i){const o=1<<c.canonical.z,u=i.getFreeCameraOptions().position,d=i.elevation,p=c.canonical.x/o,g=(c.canonical.x+1)/o,v=c.canonical.y/o,w=(c.canonical.y+1)/o;let M=i._centerAltitude;if(d){const R=d.getMinMaxForTile(c);R&&R.max>M&&(M=R.max)}const I=s.aa(u.x,p,g)-u.x,S=s.aa(u.y,v,w)-u.y,z=s.bl(M,i.center.lat)-u.z;return i._zoomFromMercatorZ(Math.sqrt(I*I+S*S+z*z))}function rh(c,i,o,u,d,p,g){const v=c.context,w=c.renderPass==="shadow",M=c.shadowRenderer,I=w&&M?M.getShadowPassDepthMode():new zt(v.gl.LEQUAL,zt.ReadWrite,c.depthRangeFor3D),S=c.isTileAffectedByFog(p);if(o.meshes)for(const z of o.meshes){const R=["MODEL_POSITION_ON_GPU"],U=[];let N,V,B;u.instancedDataArray.length>20&&R.push("INSTANCED_ARRAYS");const G=Zo(c,i.paint.get("model-cutoff-fade-range"));if(G.shouldRenderCutoff&&R.push("RENDER_CUTOFF"),w&&M)N=c.getOrCreateProgram("modelDepth",{defines:R}),V=Ya(g.shadowTileMatrix,g.shadowTileMatrix,Float32Array.from(o.matrix)),B=M.getShadowPassColorMode();else{ti(R,U,z,c),N=c.getOrCreateProgram("model",{defines:R,overrideFog:S});const q=z.material,J=q.pbrMetallicRoughness,j=i.paint.get("model-opacity"),Q=i.paint.get("model-emissive-strength").constantOr(0);V=oc(p.expandedProjMatrix,Float32Array.from(o.matrix),new Float32Array(16),c,j,J.baseColorFactor,q.emissiveFactor,J.metallicFactor,J.roughnessFactor,q,Q,i,d),M&&(g.shadowUniformsInitialized?N.setShadowUniformValues(v,M.getShadowUniformValues()):(M.setupShadows(p.toUnwrapped(),N,"model-tile",p.overscaledZ),g.shadowUniformsInitialized=!0)),B=G.shouldRenderCutoff||j<1||q.alphaMode!=="OPAQUE"?rr.alphaBlended:rr.unblended}c.uploadCommonUniforms(v,N,p.toUnwrapped(),null,G);const K=z.material.doubleSided?Rt.disabled:Rt.backCCW;if(u.instancedDataArray.length>20)U.push(u.instancedDataBuffer),N.draw(c,v.gl.TRIANGLES,I,jt.disabled,B,K,V,i.id,z.vertexBuffer,z.indexBuffer,z.segments,i.paint,c.transform.zoom,void 0,U,u.instancedDataArray.length);else{const q=w?"u_instance":"u_normal_matrix";for(let J=0;J<u.instancedDataArray.length;++J)V[q]=new Float32Array(u.instancedDataArray.arrayBuffer,64*J,16),N.draw(c,v.gl.TRIANGLES,I,jt.disabled,B,K,V,i.id,z.vertexBuffer,z.indexBuffer,z.segments,i.paint,c.transform.zoom,void 0,U)}}if(o.children)for(const z of o.children)rh(c,i,z,u,d,p,g)}const la=[1,-1,1];function tm(c,i,o,u){if(!o.modelManager)return!0;const d=o.modelManager;if(!o.shadowRenderer)return!0;const p=o.shadowRenderer,g=i.aabb;let v=!0,w=c.maxHeight;if(w===0){let I=0;for(const S in c.instancesPerModel){const z=d.getModel(S,u);z?I=Math.max(I,Math.max(Math.max(z.aabb.max[0],z.aabb.max[1]),z.aabb.max[2])):v=!1}w=c.maxScale*I*1.41+c.maxVerticalOffset,v&&(c.maxHeight=w)}g.max[2]=w,g.min[2]+=c.terrainElevationMin,g.max[2]+=c.terrainElevationMax,s.N.transformMat4(g.min,g.min,i.tileMatrix),s.N.transformMat4(g.max,g.max,i.tileMatrix);const M=g.intersects(p.getCurrentCascadeFrustum());return o.currentShadowCascade===0&&(c.isInsideFirstShadowMapFrustum=M===2),M===0}class rm{}class Vd{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(i,o,u){{const S=this._storage.get(o.id);if(S)return S.lastUsedFrameIdx=i,S.buf}const d=u.gl,p=d.getBufferParameter(d.ELEMENT_ARRAY_BUFFER,d.BUFFER_SIZE),g=new ArrayBuffer(p),v=new Int16Array(g);d.getBufferSubData(d.ELEMENT_ARRAY_BUFFER,0,new Int16Array(g));const w=new s.cW;for(let S=0;S<p/2;S+=3){const z=v[S],R=v[S+1],U=v[S+2];w.emplaceBack(z,R),w.emplaceBack(R,U),w.emplaceBack(U,z)}const M=u.bindVertexArrayOES.current,I=new rm;return I.buf=new jr(u,w),I.lastUsedFrameIdx=i,this._storage.set(o.id,I),u.bindVertexArrayOES.set(M),I.buf}update(i){for(const[o,u]of this._storage)i-u.lastUsedFrameIdx>30&&(u.buf.destroy(),this._storage.delete(o))}destroy(){for(const[i,o]of this._storage)o.buf.destroy(),this._storage.delete(i)}}class tl{registerParameter(i,o,u,d,p){}registerButton(i,o,u){}}const rl={symbol:function(c,i,o,u,d){if(c.renderPass!=="translucent")return;const p=jt.disabled,g=c.colorModeForRenderPass();o.layout.get("text-variable-anchor")&&function(M,I,S,z,R,U,N){const V=I.transform,B=R==="map",G=U==="map";for(const K of M){const q=z.getTile(K),J=q.getBucket(S);if(!J||!J.text||!J.text.segments.get().length)continue;const j=s.b5(J.textSizeData,V.zoom),Q=Ba(K,J.getProjection(),V),oe=V.calculatePixelsToTileUnitsMatrix(q),le=Oa(Q,q.tileID.canonical,G,B,V,J.getProjection(),oe),he=J.hasIconTextFit()&&J.hasIconData();if(j){const we=Math.pow(2,V.zoom-q.tileID.overscaledZ);Od(J,B,G,N,s.cx,V,le,K,we,j,he)}}}(u,c,o,i,o.layout.get("text-rotation-alignment"),o.layout.get("text-pitch-alignment"),d);const v=o.paint.get("icon-opacity").constantOr(1)!==0,w=o.paint.get("text-opacity").constantOr(1)!==0;o.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(v||w)?sc(c,i,o,u,p,g):(v&&sc(c,i,o,u,p,g,{onlyIcons:!0}),w&&sc(c,i,o,u,p,g,{onlyText:!0})),i.map.showCollisionBoxes&&($n(c,i,o,u,o.paint.get("text-translate"),o.paint.get("text-translate-anchor"),!0),$n(c,i,o,u,o.paint.get("icon-translate"),o.paint.get("icon-translate-anchor"),!1))},circle:function(c,i,o,u){if(c.renderPass!=="translucent")return;const d=o.paint.get("circle-opacity"),p=o.paint.get("circle-stroke-width"),g=o.paint.get("circle-stroke-opacity"),v=o.layout.get("circle-sort-key").constantOr(1)!==void 0,w=o.paint.get("circle-emissive-strength");if(d.constantOr(1)===0&&(p.constantOr(1)===0||g.constantOr(1)===0))return;const M=c.context,I=M.gl,S=c.transform,z=c.depthModeForSublayer(0,zt.ReadOnly),R=jt.disabled,U=c.colorModeForDrapableLayerRenderPass(w),N=S.projection.name==="globe",V=[s.a5(S.center.lng),s.ae(S.center.lat)],B=[];for(let K=0;K<u.length;K++){const q=u[K],J=i.getTile(q),j=J.getBucket(o);if(!j||j.projection.name!==S.projection.name)continue;const Q=j.programConfigurations.get(o.id),oe=s.cy(o),le=c.isTileAffectedByFog(q);N&&oe.push("PROJECTION_GLOBE_VIEW");const he=c.getOrCreateProgram("circle",{config:Q,defines:oe,overrideFog:le}),we=j.layoutVertexBuffer,me=j.globeExtVertexBuffer,Ae=j.indexBuffer,Ie=S.projection.createInversionMatrix(S,q.canonical),Ue={programConfiguration:Q,program:he,layoutVertexBuffer:we,globeExtVertexBuffer:me,indexBuffer:Ae,uniformValues:s.cz(c,q,J,Ie,V,o),tile:J};if(v){const ge=j.segments.get();for(const Ee of ge)B.push({segments:new s.aB([Ee]),sortKey:Ee.sortKey,state:Ue})}else B.push({segments:j.segments,sortKey:0,state:Ue})}v&&B.sort((K,q)=>K.sortKey-q.sortKey);const G={useDepthForOcclusion:S.depthOcclusionForSymbolsAndCircles};for(const K of B){const{programConfiguration:q,program:J,layoutVertexBuffer:j,globeExtVertexBuffer:Q,indexBuffer:oe,uniformValues:le,tile:he}=K.state,we=K.segments;c.terrain&&c.terrain.setupElevationDraw(he,J,G),c.uploadCommonUniforms(M,J,he.tileID.toUnwrapped()),J.draw(c,I.TRIANGLES,z,R,U,Rt.disabled,le,o.id,j,oe,we,o.paint,S.zoom,q,[Q])}},heatmap:function(c,i,o,u){if(o.paint.get("heatmap-opacity")!==0)if(c.renderPass==="offscreen"){const d=c.context,p=d.gl,g=jt.disabled,v=new rr([p.ONE,p.ONE,p.ONE,p.ONE],s.ax.transparent,[!0,!0,!0,!0]);(function(R,U,N,V){const B=R.gl,G=U.width*V,K=U.height*V;R.activeTexture.set(B.TEXTURE1),R.viewport.set([0,0,G,K]);let q=N.heatmapFbo;if(!q||q&&(q.width!==G||q.height!==K)){q&&q.destroy();const J=B.createTexture();B.bindTexture(B.TEXTURE_2D,J),B.texParameteri(B.TEXTURE_2D,B.TEXTURE_WRAP_S,B.CLAMP_TO_EDGE),B.texParameteri(B.TEXTURE_2D,B.TEXTURE_WRAP_T,B.CLAMP_TO_EDGE),B.texParameteri(B.TEXTURE_2D,B.TEXTURE_MIN_FILTER,B.LINEAR),B.texParameteri(B.TEXTURE_2D,B.TEXTURE_MAG_FILTER,B.LINEAR),q=N.heatmapFbo=R.createFramebuffer(G,K,!0,null),function(j,Q,oe,le,he,we){const me=j.gl;me.texImage2D(me.TEXTURE_2D,0,j.extRenderToTextureHalfFloat?me.RGBA16F:me.RGBA,he,we,0,me.RGBA,j.extRenderToTextureHalfFloat?me.HALF_FLOAT:me.UNSIGNED_BYTE,null),le.colorAttachment.set(oe)}(R,0,J,q,G,K)}else B.bindTexture(B.TEXTURE_2D,q.colorAttachment.get()),R.bindFramebuffer.set(q.framebuffer)})(d,c,o,c.transform.projection.name==="globe"?.5:.25),d.clear({color:s.ax.transparent});const w=c.transform,M=w.projection.name==="globe",I=M?["PROJECTION_GLOBE_VIEW"]:[],S=M?Rt.frontCCW:Rt.disabled,z=[s.a5(w.center.lng),s.ae(w.center.lat)];for(let R=0;R<u.length;R++){const U=u[R];if(i.hasRenderableParent(U))continue;const N=i.getTile(U),V=N.getBucket(o);if(!V||V.projection.name!==w.projection.name)continue;const B=c.isTileAffectedByFog(U),G=V.programConfigurations.get(o.id),K=c.getOrCreateProgram("heatmap",{config:G,defines:I,overrideFog:B}),{zoom:q}=c.transform;c.terrain&&c.terrain.setupElevationDraw(N,K),c.uploadCommonUniforms(d,K,U.toUnwrapped());const J=w.projection.createInversionMatrix(w,U.canonical);K.draw(c,p.TRIANGLES,zt.disabled,g,v,S,Vu(c,U,N,J,z,q,o.paint.get("heatmap-intensity")),o.id,V.layoutVertexBuffer,V.indexBuffer,V.segments,o.paint,c.transform.zoom,G,M?[V.globeExtVertexBuffer]:null)}d.viewport.set([0,0,c.width,c.height])}else c.renderPass==="translucent"&&(c.context.setColorMode(c.colorModeForRenderPass()),function(d,p){const g=d.context,v=g.gl,w=p.heatmapFbo;if(!w)return;g.activeTexture.set(v.TEXTURE0),v.bindTexture(v.TEXTURE_2D,w.colorAttachment.get()),g.activeTexture.set(v.TEXTURE1);let M=p.colorRampTexture;M||(M=p.colorRampTexture=new s.T(g,p.colorRamp,v.RGBA)),M.bind(v.LINEAR,v.CLAMP_TO_EDGE),d.getOrCreateProgram("heatmapTexture").draw(d,v.TRIANGLES,zt.disabled,jt.disabled,d.colorModeForRenderPass(),Rt.disabled,((I,S,z,R)=>({u_image:0,u_color_ramp:1,u_opacity:S.paint.get("heatmap-opacity")}))(0,p),p.id,d.viewportBuffer,d.quadTriangleIndexBuffer,d.viewportSegments,p.paint,d.transform.zoom)}(c,o))},line:function(c,i,o,u){if(c.renderPass!=="translucent")return;const d=o.paint.get("line-opacity"),p=o.paint.get("line-width");if(d.constantOr(1)===0||p.constantOr(1)===0)return;const g=o.paint.get("line-emissive-strength"),v=c.depthModeForSublayer(0,zt.ReadOnly),w=c.colorModeForDrapableLayerRenderPass(g),M=c.terrain&&c.terrain.renderingToTexture?1:s.f.devicePixelRatio,I=o.paint.get("line-dasharray"),S=I.constantOr(1),z=o.layout.get("line-cap"),R=o.paint.get("line-pattern"),U=R.constantOr(1),N=o.paint.get("line-pattern").constantOr(1),V=o.paint.get("line-opacity").constantOr(1)!==1;let B=!N&&V;const G=o.paint.get("line-gradient"),K=U?"linePattern":"line",q=c.context,J=q.gl,j=s.cA(o);c.terrain&&c.terrain.clipOrMaskOverlapStencilType()&&(B=!1);for(const Q of u){const oe=i.getTile(Q);if(U&&!oe.patternsLoaded())continue;const le=oe.getBucket(o);if(!le)continue;c.prepareDrawTile();const he=le.programConfigurations.get(o.id),we=c.isTileAffectedByFog(Q),me=c.getOrCreateProgram(K,{config:he,defines:j,overrideFog:we}),Ae=R.constantOr(null);if(Ae&&oe.imageAtlas){const Ye=oe.imageAtlas.patternPositions[Ae.toString()];Ye&&he.setConstantPatternPositions(Ye)}const Ie=I.constantOr(null),Ue=z.constantOr(null);if(!U&&Ie&&Ue&&oe.lineAtlas){const Ye=oe.lineAtlas.getDash(Ie,Ue);Ye&&he.setConstantPatternPositions(Ye)}let[ge,Ee]=o.paint.get("line-trim-offset");(Ue==="round"||Ue==="square")&&ge!==Ee&&(ge===0&&(ge-=1),Ee===1&&(Ee+=1));const ue=c.terrain?Q.projMatrix:null,ve=U?s.cB(c,oe,o,ue,M,[ge,Ee]):s.cC(c,oe,o,ue,le.lineClipsArray.length,M,[ge,Ee]);if(G){const Ye=le.gradients[o.id];let Xe=Ye.texture;if(o.gradientVersion!==Ye.version){let ot=256;if(o.stepInterpolant){const yt=i.getSource().maxzoom,Pt=Q.canonical.z===yt?Math.ceil(1<<c.transform.maxZoom-Q.canonical.z):1;ot=s.aa(s.cD(le.maxLineLength/s.V*1024*Pt),256,q.maxTextureSize)}Ye.gradient=s.cE({expression:o.gradientExpression(),evaluationKey:"lineProgress",resolution:ot,image:Ye.gradient||void 0,clips:le.lineClipsArray}),Ye.texture?Ye.texture.update(Ye.gradient):Ye.texture=new s.T(q,Ye.gradient,J.RGBA),Ye.version=o.gradientVersion,Xe=Ye.texture}q.activeTexture.set(J.TEXTURE1),Xe.bind(o.stepInterpolant?J.NEAREST:J.LINEAR,J.CLAMP_TO_EDGE)}S&&(q.activeTexture.set(J.TEXTURE0),oe.lineAtlasTexture&&oe.lineAtlasTexture.bind(J.LINEAR,J.REPEAT),he.updatePaintBuffers()),U&&(q.activeTexture.set(J.TEXTURE0),oe.imageAtlasTexture&&oe.imageAtlasTexture.bind(J.LINEAR,J.CLAMP_TO_EDGE),he.updatePaintBuffers()),c.uploadCommonUniforms(q,me,Q.toUnwrapped());const Ve=Ye=>{me.draw(c,J.TRIANGLES,v,Ye,w,Rt.disabled,ve,o.id,le.layoutVertexBuffer,le.indexBuffer,le.segments,o.paint,c.transform.zoom,he,[le.layoutVertexBuffer2])};if(B){const Ye=c.stencilModeForClipping(Q).ref;Ye===0&&c.terrain&&q.clear({stencil:0});const Xe={func:J.EQUAL,mask:255};ve.u_alpha_discard_threshold=.8,Ve(new jt(Xe,Ye,255,J.KEEP,J.KEEP,J.INVERT)),ve.u_alpha_discard_threshold=0,Ve(new jt(Xe,Ye,255,J.KEEP,J.KEEP,J.KEEP))}else Ve(c.stencilModeForClipping(Q))}B&&(c.resetStencilClippingMasks(),c.terrain&&q.clear({stencil:0}))},fill:function(c,i,o,u){const d=o.paint.get("fill-color"),p=o.paint.get("fill-opacity");if(p.constantOr(1)===0)return;const g=o.paint.get("fill-emissive-strength"),v=c.colorModeForDrapableLayerRenderPass(g),w=o.paint.get("fill-pattern"),M=c.opaquePassEnabledForLayer()&&!w.constantOr(1)&&d.constantOr(s.ax.transparent).a===1&&p.constantOr(0)===1?"opaque":"translucent";if(c.renderPass===M){const I=c.depthModeForSublayer(1,c.renderPass==="opaque"?zt.ReadWrite:zt.ReadOnly);ws(c,i,o,u,I,v,!1)}if(c.renderPass==="translucent"&&o.paint.get("fill-antialias")){const I=c.depthModeForSublayer(o.getPaintProperty("fill-outline-color")?2:0,zt.ReadOnly);ws(c,i,o,u,I,v,!0)}},"fill-extrusion":function(c,i,o,u){const d=o.paint.get("fill-extrusion-opacity"),p=c.context,g=p.gl,v=c.terrain,w=v&&v.renderingToTexture;if(d===0)return;const M=c.conflationActive&&c.layerUsedInConflation(o,i.getSource());if(M&&function(I,S,z,R){for(const U of R){const N=S.getTile(U).getBucket(z);N&&(N.updateReplacement(U,I.replacementSource),N.uploadCentroid(I.context))}}(c,i,o,u),v||M)for(const I of u){const S=i.getTile(I).getBucket(o);S&&Jp(c.context,i,I,S,o,v,M)}if(c.renderPass==="shadow"&&c.shadowRenderer){const I=c.shadowRenderer;if(v&&d<.65&&o._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof s.Z)return;const S=I.getShadowPassDepthMode(),z=I.getShadowPassColorMode();bt(c,i,o,u,S,jt.disabled,z,M)}else if(c.renderPass==="translucent"){const I=!o.paint.get("fill-extrusion-pattern").constantOr(1),S=o.paint.get("fill-extrusion-color").constantOr(s.ax.white);if(!w&&S.a!==0){const z=new zt(c.context.gl.LEQUAL,zt.ReadWrite,c.depthRangeFor3D);d===1&&I?bt(c,i,o,u,z,jt.disabled,rr.unblended,M):(bt(c,i,o,u,z,jt.disabled,rr.disabled,M),bt(c,i,o,u,z,c.stencilModeFor3D(),c.colorModeForRenderPass(),M),c.resetStencilClippingMasks())}if(c.style.enable3dLights()&&I&&(!v&&c.transform.projection.name!=="globe"||w)){const z=o.paint.get("fill-extrusion-opacity"),R=o.paint.get("fill-extrusion-ambient-occlusion-intensity"),U=o.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),N=o.paint.get("fill-extrusion-flood-light-intensity"),V=o.paint.get("fill-extrusion-flood-light-color").toArray01().slice(0,3),B=R>0&&U>0,G=N>0,K=(J,j,Q)=>(1-Q)*J+Q*j,q=J=>{const j=c.depthModeForSublayer(1,zt.ReadOnly,g.LEQUAL,!0),Q=o.paint.get(J?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),oe=K(.1,3,Q),le=c._showOverdrawInspector;if(!le){const he=new jt({func:g.ALWAYS,mask:255},255,255,g.KEEP,g.KEEP,g.REPLACE),we=new rr([g.ONE,g.ONE,g.ONE,g.ONE],s.ax.transparent,[!1,!1,!1,!0],g.MIN);Wo(c,i,o,u,j,he,we,Rt.disabled,J,"sdf",z,R,U,N,V,oe,M,!1)}{const he=le?jt.disabled:new jt({func:g.EQUAL,mask:255},255,255,g.KEEP,g.DECR,g.DECR),we=le?c.colorModeForRenderPass():new rr([g.ONE_MINUS_DST_ALPHA,g.DST_ALPHA,g.ONE,g.ONE],s.ax.transparent,[!0,!0,!0,!0]);Wo(c,i,o,u,j,he,we,Rt.disabled,J,"color",z,R,U,N,V,oe,M,!1)}};if(w){const J=(j,Q,oe)=>{const le=c.depthModeForSublayer(1,zt.ReadOnly,g.LEQUAL,!1),he=o.paint.get(j?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),we=K(.1,3,he);{const me=new rr([g.ONE,g.ONE,g.ONE,g.ONE],s.ax.transparent,[!1,!1,!1,!0]);Wo(c,i,o,u,le,jt.disabled,me,Rt.disabled,j,"clear",z,R,U,N,V,we,M,Q)}{const me=new jt({func:g.ALWAYS,mask:255},255,255,g.KEEP,g.KEEP,g.REPLACE),Ae=new rr([g.ONE,g.ONE,g.ONE,g.ONE],s.ax.transparent,[!1,!1,!1,!0],g.MIN);Wo(c,i,o,u,le,me,Ae,Rt.disabled,j,"sdf",z,R,U,N,V,we,M,Q)}{const me=j?g.ZERO:g.ONE_MINUS_DST_ALPHA,Ae=new jt({func:g.EQUAL,mask:255},255,255,g.KEEP,g.DECR,g.DECR),Ie=new rr([me,g.DST_ALPHA,g.ONE_MINUS_DST_ALPHA,g.ZERO],s.ax.transparent,[!0,!0,!0,!0]);Wo(c,i,o,u,le,Ae,Ie,Rt.disabled,j,"color",z,R,U,N,V,we,M,Q)}{const me=new rr([g.ONE,g.ONE,g.ONE,j?g.ZERO:g.ONE],s.ax.transparent,[!1,!1,!1,!0],j?g.FUNC_ADD:g.MAX);Wo(c,i,o,u,le,jt.disabled,me,Rt.disabled,j,"clear",z,R,U,N,V,we,M,Q,oe)}};if(B||G){let j;if(c.prepareDrawTile(),v){const Q=v.drapeBufferSize[0],oe=v.drapeBufferSize[1];j=v.framebufferCopyTexture,j&&(!j||j.size[0]===Q&&j.size[1]===oe)||(j&&j.destroy(),j=v.framebufferCopyTexture=new s.T(p,new s.h({width:Q,height:oe}),g.RGBA)),j.bind(g.LINEAR,g.CLAMP_TO_EDGE),g.copyTexImage2D(g.TEXTURE_2D,0,g.RGBA,0,0,Q,oe,0)}B&&J(!0,!1,j),G&&J(!1,!0,j)}}else B&&q(!0),G&&q(!1)}}},hillshade:function(c,i,o,u){if(c.renderPass!=="offscreen"&&c.renderPass!=="translucent"||c.style.disableElevatedTerrain)return;const d=c.context,p=c.terrain&&c.terrain.renderingToTexture,[g,v]=c.renderPass!=="translucent"||p?[{},u]:c.stencilConfigForOverlap(u);for(const w of v){const M=i.getTile(w);if(M.needsHillshadePrepare&&c.renderPass==="offscreen")Au(c,M,o);else if(c.renderPass==="translucent"){const I=c.depthModeForSublayer(0,zt.ReadOnly),S=o.paint.get("hillshade-emissive-strength"),z=c.colorModeForDrapableLayerRenderPass(S),R=p&&c.terrain?c.terrain.stencilModeForRTTOverlap(w):g[w.overscaledZ];Ql(c,w,M,o,I,R,z)}}d.viewport.set([0,0,c.width,c.height]),c.resetStencilClippingMasks()},raster:function(c,i,o,u,d,p){if(c.renderPass!=="translucent"||o.paint.get("raster-opacity")===0)return;const g=c.transform.projection.name==="globe",v=o.paint.get("raster-elevation")!==0,w=v&&g;if(c.renderElevatedRasterBackface&&!w)return;const M=c.context,I=M.gl,S=i.getSource(),z=function(j,Q,oe,le){const he=Q.paint.get("raster-color"),we=j.type==="raster-array",me=[],Ae=Q.paint.get("raster-resampling"),Ie=Q.paint.get("raster-color-mix");let Ue=Q.paint.get("raster-color-range");const ge=[Ie[0],Ie[1],Ie[2],0],Ee=Ie[3];let ue=Ae==="nearest"?le.NEAREST:le.LINEAR;if(we&&(me.push("RASTER_ARRAY"),he||me.push("RASTER_COLOR"),Ae==="linear"&&me.push("RASTER_ARRAY_LINEAR"),ue=le.NEAREST,!Ue&&j.rasterLayers)){const ve=j.rasterLayers.find(({id:Ve})=>Ve===Q.sourceLayer);ve&&ve.fields&&ve.fields.range&&(Ue=ve.fields.range)}if(Ue=Ue||[0,1],he){me.push("RASTER_COLOR"),oe.activeTexture.set(le.TEXTURE2),Q.updateColorRamp(Ue);let ve=Q.colorRampTexture;ve||(ve=Q.colorRampTexture=new s.T(oe,Q.colorRamp,le.RGBA)),ve.bind(le.LINEAR,le.CLAMP_TO_EDGE)}return{mix:ge,range:Ue,offset:Ee,defines:me,resampling:ue}}(S,o,M,I);if(S instanceof s.ap&&!u.length&&!g)return;const R=o.paint.get("raster-emissive-strength"),U=c.colorModeForDrapableLayerRenderPass(R),N=c.terrain&&c.terrain.renderingToTexture,V=!c.options.moving,B=o.paint.get("raster-resampling")==="nearest"?I.NEAREST:I.LINEAR;if(S instanceof s.ap&&!u.length&&(S.onNorthPole||S.onSouthPole)){const j=v?c.stencilModeFor3D():jt.disabled;return void $u(!!S.onNorthPole,null,c,i,o,R,z,Rt.disabled,j)}if(!u.length)return;const[G,K]=S instanceof s.ap||N?[{},u]:c.stencilConfigForOverlap(u),q=K[K.length-1].overscaledZ;w&&z.defines.push("PROJECTION_GLOBE_VIEW"),v&&z.defines.push("RENDER_CUTOFF");const J=(j,Q,oe)=>{for(const le of j){const he=le.toUnwrapped(),we=i.getTile(le);if(N&&(!we||!we.hasData()))continue;M.activeTexture.set(I.TEXTURE0);const me=Wu(we,S,o,z);if(!me||!me.texture)continue;const{texture:Ae,mix:Ie,offset:Ue,tileSize:ge,buffer:Ee}=me;let ue,ve;N?(ue=zt.disabled,ve=le.projMatrix):v?(ue=new zt(I.LEQUAL,zt.ReadWrite,c.depthRangeFor3D),ve=g?Float32Array.from(c.transform.expandedFarZProjMatrix):c.transform.calculateProjMatrix(he,V)):(ue=c.depthModeForSublayer(le.overscaledZ-q,o.paint.get("raster-opacity")===1?zt.ReadWrite:zt.ReadOnly,I.LESS),ve=c.transform.calculateProjMatrix(he,V));const Ve=c.terrain&&N?c.terrain.stencilModeForRTTOverlap(le):G[le.overscaledZ],Ye=p?0:o.paint.get("raster-fade-duration");we.registerFadeDuration(Ye);const Xe=i.findLoadedParent(le,0),ot=Du(we,Xe,i,c.transform,Ye);let yt,Pt;c.terrain&&c.terrain.prepareDrawTile(),M.activeTexture.set(I.TEXTURE0),Ae.bind(B,I.CLAMP_TO_EDGE),M.activeTexture.set(I.TEXTURE1),Xe?(Xe.texture&&Xe.texture.bind(B,I.CLAMP_TO_EDGE),yt=Math.pow(2,Xe.tileID.overscaledZ-we.tileID.overscaledZ),Pt=[we.tileID.canonical.x*yt%1,we.tileID.canonical.y*yt%1]):Ae.bind(B,I.CLAMP_TO_EDGE),Ae.useMipmap&&M.extTextureFilterAnisotropic&&c.transform.pitch>20&&I.texParameterf(I.TEXTURE_2D,M.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,M.extTextureFilterAnisotropicMax);const Tt=c.transform;let It;const Yt=v?qu(Tt):[0,0,0,0];let Vt,qt,$t,fr,Vr,nr=0;if(w&&S instanceof s.ap&&S.coordinates.length>3)Vt=Float32Array.from(s.aT(s.ci(new s.bs(0,0,0)))),qt=Float32Array.from(Tt.globeMatrix),$t=Float32Array.from(s.ce(Tt)),fr=[s.a5(Tt.center.lng),s.ae(Tt.center.lat)],It=S.elevatedGlobePerspectiveTransform,Vr=S.elevatedGlobeGridMatrix||new Float32Array(9);else if(w){const sr=s.cf(le.canonical);nr=s.cg(sr.getCenter().lat),Vt=Float32Array.from(s.aT(s.ci(le.canonical))),qt=Float32Array.from(Tt.globeMatrix),$t=Float32Array.from(s.ce(Tt)),fr=[s.a5(Tt.center.lng),s.ae(Tt.center.lat)],It=[0,0],Vr=Float32Array.from(s.ch(le.canonical,sr,nr,Tt.worldSize/Tt._pixelsPerMercatorPixel))}else It=S instanceof s.ap?S.perspectiveTransform:[0,0],Vt=new Float32Array(16),qt=new Float32Array(9),$t=new Float32Array(16),fr=[0,0],Vr=new Float32Array(9);const ri=ju(ve,Vt,qt,$t,Vr,Pt||[0,0],s.S(c.transform.zoom),fr,Yt,yt||1,ot,o,It,v?o.paint.get("raster-elevation"):0,2,Ie,Ue,z.range,ge,Ee,R),or=c.isTileAffectedByFog(le),yr=c.getOrCreateProgram("raster",{defines:z.defines,overrideFog:or});if(c.uploadCommonUniforms(M,yr,he),S instanceof s.ap){const sr=S.elevatedGlobeVertexBuffer,gr=S.elevatedGlobeIndexBuffer;if(N||!g)S.boundsBuffer&&S.boundsSegments&&yr.draw(c,I.TRIANGLES,ue,jt.disabled,U,Rt.disabled,ri,o.id,S.boundsBuffer,c.quadTriangleIndexBuffer,S.boundsSegments);else if(sr&&gr){const Gr=Tt.zoom<=s.bG?S.elevatedGlobeSegments:S.getSegmentsForLongitude(Tt.center.lng);Gr&&yr.draw(c,I.TRIANGLES,ue,jt.disabled,U,Q,ri,o.id,sr,gr,Gr)}}else if(w){ue=new zt(I.LEQUAL,zt.ReadOnly,c.depthRangeFor3D);const sr=c.globeSharedBuffers;if(sr){const[gr,Gr,Tr]=sr.getGridBuffers(nr,!1);yr.draw(c,I.TRIANGLES,ue,oe||Ve,c.colorModeForRenderPass(),Q,ri,o.id,gr,Gr,Tr)}}else{const{tileBoundsBuffer:sr,tileBoundsIndexBuffer:gr,tileBoundsSegments:Gr}=c.getTileBoundsBuffers(we);yr.draw(c,I.TRIANGLES,ue,Ve,U,Rt.disabled,ri,o.id,sr,gr,Gr)}}if(!(S instanceof s.ap)&&w)for(const le of j){const he=le.canonical.y===(1<<le.canonical.z)-1;le.canonical.y===0&&$u(!0,le,c,i,o,R,z,Q,oe||jt.disabled),he&&$u(!1,le,c,i,o,R,z,Q===Rt.frontCW?Rt.backCW:Rt.frontCW,oe||jt.disabled)}};w?J(K,c.renderElevatedRasterBackface?Rt.backCW:Rt.frontCW,c.stencilModeFor3D()):J(K,Rt.disabled,void 0),c.resetStencilClippingMasks()},"raster-particle":function(c,i,o,u,d,p){c.renderPass==="offscreen"&&function(g,v,w,M){if(!M.length)return;const I=g.context,S=I.gl,z=v.getSource();if(!(z instanceof Qe))return;const R=[];for(const V of M){const B=v.getTile(V);if(!(B instanceof ps))continue;const G=Hu(B,z,w);if(!G)continue;const K=[G.tileSize,G.tileSize];let q=w.tileFramebuffer;q||(q=w.tileFramebuffer=I.createFramebuffer(K[0],K[1],!0,null));let J=B.rasterParticleState;const j=w.paint.get("raster-particle-count");J||(J=B.rasterParticleState=new vi(I,V,K,j));const Q=J.update(w.lastInvalidatedAt);J.numParticles!==j&&J.setNumParticles(V,j);const oe=J.targetColorTexture;J.targetColorTexture=J.backgroundColorTexture,J.backgroundColorTexture=oe;const le=J.particleVertices0;J.particleVertices0=J.particleVertices1,J.particleVertices1=le,R.push([V,G,J,Q])}if(R.length===0)return;const U=s.f.now(),N=w.previousDrawTimestamp?.001*(U-w.previousDrawTimestamp):.0167;if(w.previousDrawTimestamp=U,w.hasColorMap()){I.activeTexture.set(S.TEXTURE0+2);let V=w.colorRampTexture;V||(V=w.colorRampTexture=new s.T(I,w.colorRamp,S.RGBA)),V.bind(S.LINEAR,S.CLAMP_TO_EDGE)}I.bindFramebuffer.set(w.tileFramebuffer.framebuffer),I.activeTexture.set(S.TEXTURE0),function(V,B,G){const K=V.context,q=K.gl,J=B.tileFramebuffer;K.activeTexture.set(q.TEXTURE0);const j={u_texture:0,u_opacity:1.05*(oe=B.paint.get("raster-particle-fade-opacity-factor"))/(oe+.05)},Q=V.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var oe;for(const le of G){const[,,he,we]=le;J.colorAttachment.set(he.targetColorTexture.texture),K.viewport.set([0,0,J.width,J.height]),K.clear({color:s.ax.transparent}),we&&(he.backgroundColorTexture.bind(q.NEAREST,q.CLAMP_TO_EDGE),Q.draw(V,q.TRIANGLES,zt.disabled,jt.disabled,rr.alphaBlended,Rt.disabled,j,B.id,V.viewportBuffer,V.quadTriangleIndexBuffer,V.viewportSegments))}}(g,w,R),function(V,B,G,K){const q=V.context.gl,J=G.tileFramebuffer,j=V.transform.projection.name==="globe",Q=G.paint.get("raster-particle-max-speed");for(const oe of K){const[le,he,we]=oe;he.texture.bind(q.LINEAR,q.CLAMP_TO_EDGE),J.colorAttachment.set(we.targetColorTexture.texture);const me=V.getOrCreateProgram("rasterParticleDraw",{defines:he.defines,overrideFog:!1}),Ae=he.scalarData?[]:[0,1,2,3].map(ge=>s.cG[ge](le));Ae.push(le);const Ie=le.canonical.x,Ue=le.canonical.y;for(const ge of Ae){const Ee=B.getTile(j?ge.wrapped():ge);if(!Ee)continue;const ue=Ee.rasterParticleState;if(!ue)continue;const ve=Yp([ge.canonical.x+(1<<ge.canonical.z)*(ge.wrap-le.wrap)-Ie,ge.canonical.y-Ue],0,he.texture.size,2,Q,he.textureOffset,he.scale,he.offset);me.draw(V,q.POINTS,zt.disabled,jt.disabled,rr.alphaBlended,Rt.disabled,ve,G.id,ue.particleVertices0,void 0,ue.particleSegment)}}}(g,v,w,R),function(V,B,G,K){const q=V.context.gl;let J=B.transformFeedbackObject;J||(J=B.transformFeedbackObject=q.createTransformFeedback()),q.bindTransformFeedback(q.TRANSFORM_FEEDBACK,B.transformFeedbackObject);const j=B.paint.get("raster-particle-max-speed"),Q=K*B.paint.get("raster-particle-speed-factor")*.3,oe=(le=B.paint.get("raster-particle-reset-rate-factor"),Math.pow(le,6));var le;for(const he of G){const[,we,me]=he;we.texture.bind(q.LINEAR,q.CLAMP_TO_EDGE);const Ae=zd(0,we.texture.size,j,Q,oe,we.textureOffset,we.scale,we.offset);V.getOrCreateProgram("rasterParticleUpdate",{defines:we.defines,transformFeedback:{bufferMode:q.SEPARATE_ATTRIBS,shaderVaryings:["v_new_particle"]}}).draw(V,q.POINTS,zt.disabled,jt.disabled,rr.disabled,Rt.disabled,Ae,B.id,me.particleVertices0,void 0,me.particleSegment,{},void 0,void 0,void 0,void 0,[{buffer:me.particleVertices1,targetIndex:0}])}q.bindTransformFeedback(q.TRANSFORM_FEEDBACK,null)}(g,w,R,N)}(c,i,o,u),c.renderPass==="translucent"&&(function(g,v,w,M,I){const S=g.context,z=S.gl,R=!g.options.moving,U=g.transform.projection.name==="globe";if(!M.length)return;const[N,V]=g.stencilConfigForOverlap(M),B=[];U&&B.push("PROJECTION_GLOBE_VIEW");for(const G of V){const K=G.toUnwrapped(),q=v.getTile(G);if(!q.rasterParticleState)continue;const J=q.rasterParticleState,j=100;q.registerFadeDuration(j);const Q=v.findLoadedParent(G,0),oe=Du(q,Q,v,g.transform,j);let le,he;g.terrain&&g.terrain.prepareDrawTile(),S.activeTexture.set(z.TEXTURE0),J.targetColorTexture.bind(z.LINEAR,z.CLAMP_TO_EDGE),S.activeTexture.set(z.TEXTURE1),Q&&Q.rasterParticleState?(Q.rasterParticleState.targetColorTexture.bind(z.LINEAR,z.CLAMP_TO_EDGE),le=Math.pow(2,Q.tileID.overscaledZ-q.tileID.overscaledZ),he=[q.tileID.canonical.x*le%1,q.tileID.canonical.y*le%1]):J.targetColorTexture.bind(z.LINEAR,z.CLAMP_TO_EDGE);const we=U?Float32Array.from(g.transform.expandedFarZProjMatrix):g.transform.calculateProjMatrix(K,R),me=g.transform,Ae=Xu(me),Ie=s.cf(G.canonical),Ue=s.cg(Ie.getCenter().lat);let ge,Ee,ue,ve,Ve;U?(ge=Float32Array.from(s.aT(s.ci(G.canonical))),Ee=Float32Array.from(me.globeMatrix),ue=Float32Array.from(s.ce(me)),ve=[s.a5(me.center.lng),s.ae(me.center.lat)],Ve=Float32Array.from(s.ch(G.canonical,Ie,Ue,me.worldSize/me._pixelsPerMercatorPixel))):(ge=new Float32Array(16),Ee=new Float32Array(9),ue=new Float32Array(16),ve=[0,0],Ve=new Float32Array(9));const Ye=Xp(we,ge,Ee,ue,Ve,he||[0,0],s.S(g.transform.zoom),ve,Ae,le||1,oe,250),Xe=g.isTileAffectedByFog(G),ot=g.getOrCreateProgram("rasterParticle",{defines:B,overrideFog:Xe});if(g.uploadCommonUniforms(S,ot,K),U){const yt=new zt(z.LEQUAL,zt.ReadWrite,g.depthRangeFor3D),Pt=0,Tt=g.globeSharedBuffers;if(Tt){const[It,Yt,Vt]=Tt.getGridBuffers(Ue,Pt!==0);ot.draw(g,z.TRIANGLES,yt,jt.disabled,rr.alphaBlended,Rt.backCCW,Ye,w.id,It,Yt,Vt)}}else{const yt=g.depthModeForSublayer(0,zt.ReadOnly),Pt=N[G.overscaledZ],{tileBoundsBuffer:Tt,tileBoundsIndexBuffer:It,tileBoundsSegments:Yt}=g.getTileBoundsBuffers(q);ot.draw(g,z.TRIANGLES,yt,Pt,rr.alphaBlended,Rt.disabled,Ye,w.id,Tt,It,Yt)}}g.resetStencilClippingMasks()}(c,i,o,u),c.style.map.triggerRepaint())},background:function(c,i,o,u){const d=o.paint.get("background-color"),p=o.paint.get("background-opacity"),g=o.paint.get("background-emissive-strength");if(p===0)return;const v=c.context,w=v.gl,M=c.transform,I=M.tileSize,S=o.paint.get("background-pattern");if(c.isPatternMissing(S,o.scope))return;const z=!S&&d.a===1&&p===1&&c.opaquePassEnabledForLayer()?"opaque":"translucent";if(c.renderPass!==z)return;const R=jt.disabled,U=c.depthModeForSublayer(0,z==="opaque"?zt.ReadWrite:zt.ReadOnly),N=c.colorModeForDrapableLayerRenderPass(g),V=S?"backgroundPattern":"background";let B,G=u;G||(B=c.getBackgroundTiles(),G=Object.values(B).map(K=>K.tileID)),S&&(v.activeTexture.set(w.TEXTURE0),c.imageManager.bind(c.context,o.scope));for(const K of G){const q=c.isTileAffectedByFog(K),J=c.getOrCreateProgram(V,{overrideFog:q}),j=K.toUnwrapped(),Q=u?K.projMatrix:c.transform.calculateProjMatrix(j);c.prepareDrawTile();const oe=i?i.getTile(K):B?B[K.key]:new Bo(K,I,M.zoom,c),le=S?Ha(Q,g,p,c,S,o.scope,{tileID:K,tileSize:I}):Zu(Q,g,p,d);c.uploadCommonUniforms(v,J,j);const{tileBoundsBuffer:he,tileBoundsIndexBuffer:we,tileBoundsSegments:me}=c.getTileBoundsBuffers(oe);J.draw(c,w.TRIANGLES,U,R,N,Rt.disabled,le,o.id,he,we,me)}},sky:function(c,i,o){const u=c._atmosphere?s.S(c.transform.zoom):1,d=o.paint.get("sky-opacity")*u;if(d===0)return;const p=c.context,g=o.paint.get("sky-type"),v=new zt(p.gl.LEQUAL,zt.ReadOnly,[0,1]),w=c.frameCounter/1e3%1;g==="atmosphere"?c.renderPass==="offscreen"?o.needsSkyboxCapture(c)&&(function(M,I,S,z){const R=M.context,U=R.gl;let N=I.skyboxFbo;if(!N){N=I.skyboxFbo=R.createFramebuffer(32,32,!0,null),I.skyboxGeometry=new eh(R),I.skyboxTexture=R.gl.createTexture(),U.bindTexture(U.TEXTURE_CUBE_MAP,I.skyboxTexture),U.texParameteri(U.TEXTURE_CUBE_MAP,U.TEXTURE_WRAP_S,U.CLAMP_TO_EDGE),U.texParameteri(U.TEXTURE_CUBE_MAP,U.TEXTURE_WRAP_T,U.CLAMP_TO_EDGE),U.texParameteri(U.TEXTURE_CUBE_MAP,U.TEXTURE_MIN_FILTER,U.LINEAR),U.texParameteri(U.TEXTURE_CUBE_MAP,U.TEXTURE_MAG_FILTER,U.LINEAR);for(let K=0;K<6;++K)U.texImage2D(U.TEXTURE_CUBE_MAP_POSITIVE_X+K,0,U.RGBA,32,32,0,U.RGBA,U.UNSIGNED_BYTE,null)}R.bindFramebuffer.set(N.framebuffer),R.viewport.set([0,0,32,32]);const V=I.getCenter(M,!0),B=M.getOrCreateProgram("skyboxCapture"),G=new Float64Array(16);s.a6.identity(G),s.a6.rotateY(G,G,.5*-Math.PI),Ts(M,I,B,G,V,0),s.a6.identity(G),s.a6.rotateY(G,G,.5*Math.PI),Ts(M,I,B,G,V,1),s.a6.identity(G),s.a6.rotateX(G,G,.5*-Math.PI),Ts(M,I,B,G,V,2),s.a6.identity(G),s.a6.rotateX(G,G,.5*Math.PI),Ts(M,I,B,G,V,3),s.a6.identity(G),Ts(M,I,B,G,V,4),s.a6.identity(G),s.a6.rotateY(G,G,Math.PI),Ts(M,I,B,G,V,5),R.viewport.set([0,0,M.width,M.height])}(c,o),o.markSkyboxValid(c)):c.renderPass==="sky"&&function(M,I,S,z,R){const U=M.context,N=U.gl,V=M.transform,B=M.getOrCreateProgram("skybox");U.activeTexture.set(N.TEXTURE0),N.bindTexture(N.TEXTURE_CUBE_MAP,I.skyboxTexture);const G=((K,q,J,j,Q)=>({u_matrix:K,u_sun_direction:q,u_cubemap:0,u_opacity:j,u_temporal_offset:Q}))(V.skyboxMatrix,I.getCenter(M,!1),0,z,R);M.uploadCommonUniforms(U,B),B.draw(M,N.TRIANGLES,S,jt.disabled,M.colorModeForRenderPass(),Rt.backCW,G,"skybox",I.skyboxGeometry.vertexBuffer,I.skyboxGeometry.indexBuffer,I.skyboxGeometry.segment)}(c,o,v,d,w):g==="gradient"&&c.renderPass==="sky"&&function(M,I,S,z,R){const U=M.context,N=U.gl,V=M.transform,B=M.getOrCreateProgram("skyboxGradient");I.skyboxGeometry||(I.skyboxGeometry=new eh(U)),U.activeTexture.set(N.TEXTURE0);let G=I.colorRampTexture;G||(G=I.colorRampTexture=new s.T(U,I.colorRamp,N.RGBA)),G.bind(N.LINEAR,N.CLAMP_TO_EDGE);const K=((q,J,j,Q,oe)=>({u_matrix:q,u_color_ramp:0,u_center_direction:J,u_radius:s.bj(j),u_opacity:Q,u_temporal_offset:oe}))(V.skyboxMatrix,I.getCenter(M,!1),I.paint.get("sky-gradient-radius"),z,R);M.uploadCommonUniforms(U,B),B.draw(M,N.TRIANGLES,S,jt.disabled,M.colorModeForRenderPass(),Rt.backCW,K,"skyboxGradient",I.skyboxGeometry.vertexBuffer,I.skyboxGeometry.indexBuffer,I.skyboxGeometry.segment)}(c,o,v,d,w)},debug:function(c,i,o,u,d,p){for(let g=0;g<o.length;g++)if(d){const M=new s.ax(u.r*.8,u.g*.8,u.b*.8,1);Xo(c,i,o[g],u,-1,-1,p),Xo(c,i,o[g],u,-1,1,p),Xo(c,i,o[g],u,1,1,p),Xo(c,i,o[g],u,1,-1,p),Xo(c,i,o[g],M,0,0,p)}else Xo(c,i,o[g],u,0,0,p)},custom:function(c,i,o,u){const d=c.context,p=o.implementation;if(!c.transform.projection.unsupportedLayers||!c.transform.projection.unsupportedLayers.includes("custom")||c.terrain&&(c.terrain.renderingToTexture||c.renderPass==="offscreen")&&o.isLayerDraped(i)){if(c.renderPass==="offscreen"){const g=p.prerender;if(g){if(c.setCustomLayerDefaults(),d.setColorMode(c.colorModeForRenderPass()),c.transform.projection.name==="globe"){const v=c.transform.pointMerc;g.call(p,d.gl,c.transform.customLayerMatrix(),c.transform.getProjection(),c.transform.globeToMercatorMatrix(),s.S(c.transform.zoom),[v.x,v.y],c.transform.pixelsPerMeterRatio)}else g.call(p,d.gl,c.transform.customLayerMatrix());d.setDirty(),c.setBaseState()}}else if(c.renderPass==="translucent"){if(c.terrain&&c.terrain.renderingToTexture){const v=p.renderToTile;if(v){const w=u[0].canonical,M=new s.L(w.x+u[0].wrap*(1<<w.z),w.y,w.z);d.setDepthMode(zt.disabled),d.setStencilMode(jt.disabled),d.setColorMode(c.colorModeForRenderPass()),c.setCustomLayerDefaults(),v.call(p,d.gl,M),d.setDirty(),c.setBaseState()}return}c.setCustomLayerDefaults(),d.setColorMode(c.colorModeForRenderPass()),d.setStencilMode(jt.disabled);const g=p.renderingMode==="3d"?new zt(c.context.gl.LEQUAL,zt.ReadWrite,c.depthRangeFor3D):c.depthModeForSublayer(0,zt.ReadOnly);if(d.setDepthMode(g),c.transform.projection.name==="globe"){const v=c.transform.pointMerc;p.render(d.gl,c.transform.customLayerMatrix(),c.transform.getProjection(),c.transform.globeToMercatorMatrix(),s.S(c.transform.zoom),[v.x,v.y],c.transform.pixelsPerMeterRatio)}else p.render(d.gl,c.transform.customLayerMatrix());d.setDirty(),c.setBaseState(),d.bindFramebuffer.set(null)}}else s.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(c,i,o,u){if(c.renderPass==="opaque")return;const d=o.paint.get("model-opacity");if(d===0)return;const p=o.paint.get("model-cast-shadows");if(c.renderPass==="shadow"&&(!p||c.terrain&&d<.65&&o._transitionablePaint._values["model-opacity"].value.expression instanceof s.Z))return;const g=c.shadowRenderer,v=o.paint.get("model-receive-shadows");g&&(g.useNormalOffset=!0,v||(g.enabled=!1));const w=()=>{g&&(g.useNormalOffset=!0,v||(g.enabled=!0))},M=i.getSource();if(c.renderPass==="light-beam"&&M.type!=="batched-model")return;if(M.type==="vector"||M.type==="geojson")return function(B,G,K,q){const J=B.transform;if(J.projection.name!=="mercator")return void s.w(`Drawing 3D models for ${J.projection.name} projection is not yet implemented`);const j=J.getFreeCameraOptions().position;if(!B.modelManager)return;const Q=B.modelManager;K.modelManager=Q;const oe=B.shadowRenderer;if(!K._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const le=K._unevaluatedLayout._values["model-id"],he={...K.layout.get("model-id").parameters};for(const we of q){const me=G.getTile(we).getBucket(K);if(!me||me.projection.name!==J.projection.name)continue;const Ae=Ud(we,J);he.zoom=Ae;const Ie=le.possiblyEvaluate(he);if(th(B,me,we),bn.shadowUniformsInitialized=!1,bn.useSingleShadowCascade=!!oe&&oe.getMaxCascadeForTile(we.toUnwrapped())===0,B.renderPass==="shadow"&&oe){if(B.currentShadowCascade===1&&me.isInsideFirstShadowMapFrustum)continue;const Ee=J.calculatePosMatrix(we.toUnwrapped(),J.worldSize);if(bn.tileMatrix.set(Ee),bn.shadowTileMatrix=Float32Array.from(oe.calculateShadowPassMatrixFromMatrix(Ee)),bn.aabb.min.fill(0),bn.aabb.max[0]=bn.aabb.max[1]=s.V,bn.aabb.max[2]=0,tm(me,bn,B,K.scope))continue}const Ue=1<<we.canonical.z,ge=[((j.x-we.wrap)*Ue-we.canonical.x)*s.V,(j.y*Ue-we.canonical.y)*s.V,j.z*Ue*s.V];for(let Ee in me.instancesPerModel){const ue=me.instancesPerModel[Ee];ue.features.length>0&&(Ee=Ie.evaluate(ue.features[0].feature,{}));const ve=Q.getModel(Ee,K.scope);if(ve&&ve.uploaded)for(const Ve of ve.nodes)rh(B,K,Ve,ue,ge,we,bn)}}}(c,i,o,u),void w();if(!M.loaded())return;if(M.type==="batched-model")return function(B,G,K,q){K.resetLayerRenderingStats(B);const J=B.context,j=B.transform,Q=B.style.fog,oe=B.shadowRenderer;if(j.projection.name!=="mercator")return void s.w(`Drawing 3D landmark models for ${j.projection.name} projection is not yet implemented`);const le=B.transform.getFreeCameraOptions().position,he=s.N.scale([],[le.x,le.y,le.z],B.transform.worldSize);s.N.negate(he,he);const we=s.a6.identity([]),me=s.cR(j.center.lat,j.zoom),Ae=s.a6.fromScaling([],[1,1,1/me]);s.a6.translate(we,we,he);const Ie=K.paint.get("model-opacity"),Ue=new zt(J.gl.LEQUAL,zt.ReadWrite,B.depthRangeFor3D),ge=new zt(J.gl.LEQUAL,zt.ReadOnly,B.depthRangeFor3D),Ee=new s.bS([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),ue=B.renderPass==="shadow",ve=ue&&oe?oe.getCurrentCascadeFrustum():j.getFrustum(j.scaleZoom(j.worldSize)),Ve=K.getLayerRenderingStats(),Ye=function(Xe,ot){for(const yt of q){const Pt=G.getTile(yt).getBucket(K);if(!Pt||!Pt.uploaded)continue;let Tt=!1;oe&&(Tt=oe.getMaxCascadeForTile(yt.toUnwrapped())===0);const It=j.calculatePosMatrix(yt.toUnwrapped(),j.worldSize),Yt=Pt.modelTraits;for(const Vt of Pt.getNodesInfo()){if(Vt.hiddenByReplacement||!Vt.node.meshes)continue;const qt=Vt.evaluatedScale,$t=Vt.node;let fr=0;if(B.terrain&&$t.elevation&&(fr=$t.elevation*B.terrain.exaggeration()),qt[0]<=1&&qt[1]<=1&&qt[2]<=1&&(()=>{const Gr=Vt.getLocalBounds();return Ee.min=[...Gr.min],Ee.max=[...Gr.max],Ee.min[2]+=fr,Ee.max[2]+=fr,s.N.transformMat4(Ee.min,Ee.min,It),s.N.transformMat4(Ee.max,Ee.max,It),Ee})().intersects(ve)===0)continue;const Vr=B.renderPass==="light-beam",nr=[...It];s.a6.translate(nr,nr,[($t.anchor?$t.anchor[0]:0)*(qt[0]-1),($t.anchor?$t.anchor[1]:0)*(qt[1]-1),fr]),s.N.exactEquals(qt,s.cT)||s.a6.scale(nr,nr,qt),s.a6.multiply(nr,nr,$t.matrix);const ri=s.a6.multiply([],Ae,nr);s.a6.multiply(ri,we,ri);const or=s.a6.invert([],ri);s.a6.transpose(or,or),s.a6.scale(or,or,la);const yr=s.a6.multiply([],j.expandedFarZProjMatrix,nr),sr=Yt&s.cV.HasMapboxMeshFeatures,gr=sr?0:Vt.evaluatedRMEA[0][2];for(let Gr=0;Gr<$t.meshes.length;++Gr){const Tr=$t.meshes[Gr],Pi=Gr===$t.lightMeshIndex;if(Pi){if(!Vr&&!B.terrain&&B.shadowRenderer){B.currentLayer<B.firstLightBeamLayer&&(B.firstLightBeamLayer=B.currentLayer);continue}}else if(Vr)continue;const Zi={defines:[]},cn=[];if(ti(Zi.defines,cn,Tr,B),sr||Zi.defines.push("DIFFUSE_SHADED"),Tt&&Zi.defines.push("SHADOWS_SINGLE_CASCADE"),Ve&&(ue?Ve.numRenderedVerticesInShadowPass+=Tr.vertexArray.length:Ve.numRenderedVerticesInTransparentPass+=Tr.vertexArray.length),ue){be(Tr,nr,B,K);continue}let no=null;if(Q){const hn=Es(nr,B.transform);if(no=new Float32Array(hn),j.projection.name!=="globe"){const oo=Tr.aabb.min,es=Tr.aabb.max,[Is,_l]=Q.getOpacityForBounds(hn,oo[0],oo[1],es[0],es[1]);Zi.overrideFog=Is>=Pr||_l>=Pr}}const un=Tr.material;let Li;un.occlusionTexture&&un.occlusionTexture.offsetScale&&(Li=un.occlusionTexture.offsetScale,Zi.defines.push("OCCLUSION_TEXTURE_TRANSFORM")),!ue&&oe&&(oe.useNormalOffset=!!Tr.normalBuffer);const wi=B.getOrCreateProgram("model",Zi);!ue&&oe&&oe.setupShadowsFromMatrix(nr,wi,oe.useNormalOffset),B.uploadCommonUniforms(J,wi,yt.toUnwrapped(),no);const Xi=un.pbrMetallicRoughness;Xi.metallicFactor=.9,Xi.roughnessFactor=.5;const tn=oc(new Float32Array(yr),new Float32Array(ri),new Float32Array(or),B,Ie,Xi.baseColorFactor,un.emissiveFactor,Xi.metallicFactor,Xi.roughnessFactor,un,gr,K,[0,0,0],Li);wi.draw(B,J.gl.TRIANGLES,ot&&!Pi?Ue:ge,jt.disabled,Xe?Pi||Ie<1||Vt.hasTranslucentParts?rr.alphaBlended:rr.unblended:rr.disabled,Rt.backCCW,tn,K.id,Tr.vertexBuffer,Tr.indexBuffer,Tr.segments,K.paint,B.transform.zoom,void 0,cn)}}}};(function(Xe,ot,yt,Pt){const Tt=Xe.terrain?Xe.terrain.exaggeration():0,It=Xe.transform.zoom;for(const Yt of Pt){const Vt=ot.getTile(Yt).getBucket(yt);Vt&&(Xe.conflationActive&&Vt.updateReplacement(Yt,Xe.replacementSource),Vt.evaluateScale(Xe,yt),Xe.terrain&&Tt>0&&Vt.elevationUpdate(Xe.terrain,Tt,Yt,yt.source),Vt.needsReEvaluation(Xe,It,yt)&&Vt.evaluate(yt))}})(B,G,K,q),Ie===1?Ye(!0,!0):(Ye(!1,!0),Ye(!0,!1))}(c,i,o,u),void w();const I=M.getModels(),S=[],z=c.transform.getFreeCameraOptions().position,R=s.N.scale([],[z.x,z.y,z.z],c.transform.worldSize);s.N.negate(R,R);const U=[],N=[];let V=0;for(const B of I){const G=o.paint.get("model-rotation").constantOr(null),K=o.paint.get("model-scale").constantOr(null),q=o.paint.get("model-translation").constantOr(null);B.computeModelMatrix(c,G,K,q,!0,!0,!1);const J=s.a6.identity([]),j=s.cR(B.position.lat,c.transform.zoom),Q=s.a6.fromScaling([],[1,1,1/j]);s.a6.translate(J,J,R),S.push({zScaleMatrix:Q,negCameraPosMatrix:J});for(const oe of B.nodes)el(c.transform,oe,B.matrix,c.transform.expandedFarZProjMatrix,V,U,N);V++}if(U.sort((B,G)=>G.depth-B.depth),c.renderPass!=="shadow"){if(d===1)for(const B of N)Qa(B,c,o,S[B.modelIndex],jt.disabled,c.colorModeForRenderPass());else{for(const B of N)Qa(B,c,o,S[B.modelIndex],jt.disabled,rr.disabled);for(const B of N)Qa(B,c,o,S[B.modelIndex],c.stencilModeFor3D(),c.colorModeForRenderPass());c.resetStencilClippingMasks()}for(const B of U)Qa(B,c,o,S[B.modelIndex],jt.disabled,c.colorModeForRenderPass());w()}else{for(const B of N)be(B.mesh,B.nodeModelMatrix,c,o);for(const B of U)be(B.mesh,B.nodeModelMatrix,c,o);w()}}},ih={model:function(c,i,o){const u=c.scope,d=i.getSource();if(!d.loaded())return;if(d.type==="vector"||d.type==="geojson")return void(o.modelManager&&o.modelManager.upload(o,u));if(d.type==="batched-model")return;const p=d.getModels();for(const g of p)g.upload(o.context)},raster:function(c,i,o){const u=i.getSource();if(!(u instanceof Qe&&u.loaded()))return;const d=c.sourceLayer||u.rasterLayerIds&&u.rasterLayerIds[0];if(!d)return;const p=c.paint.get("raster-array-band")||u.getInitialBand(d);if(p==null)return;const g=i.getIds().map(v=>i.getTileByID(v));for(const v of g)v.updateNeeded(d,p)&&u.prepareTile(v,d,p)},"raster-particle":function(c,i,o){const u=i.getSource();if(!(u instanceof Qe&&u.loaded()))return;const d=c.sourceLayer||u.rasterLayerIds&&u.rasterLayerIds[0];if(!d)return;const p=c.paint.get("raster-particle-array-band")||u.getInitialBand(d);if(p==null)return;const g=i.getIds().map(v=>i.getTileByID(v));for(const v of g)v.updateNeeded(d,p)&&u.prepareTile(v,d,p)}};class jd{constructor(i,o,u,d){this.context=new hd(i,o),this.transform=u,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=d,this._debugParams={showTerrainProxyTiles:!1},d.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),this.setup(),this.numSublayers=Vn.maxUnderzooming+Vn.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new s.cX,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new vu(this),this._wireframeDebugCache=new Vd,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0}updateTerrain(i,o){const u=!!i&&!!i.terrain&&this.transform.projection.supportsTerrain;if(!(u||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Hp(this,i));const d=this._terrain;this.transform.elevation=u?d:null,d.update(i,this.transform,o),this.transform.elevation&&!d.enabled&&(this.transform.elevation=null)}_updateFog(i){const o=i.fog;if(!o||this.transform.projection.name==="globe"||o.getOpacity(this.transform.pitch)<1||o.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[u,d]=o.getFovAdjustedRange(this.transform._fov);if(u>d)return void(this.transform.fogCullDistSq=null);const p=u+.78*(d-u);this.transform.fogCullDistSq=p*p}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled?this._terrain:null}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(i,o){if(this.width=i*s.f.devicePixelRatio,this.height=o*s.f.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const u of this.style.order)this.style._mergedLayers[u].resize()}setup(){const i=this.context,o=new s.aN;o.emplaceBack(0,0),o.emplaceBack(s.V,0),o.emplaceBack(0,s.V),o.emplaceBack(s.V,s.V),this.tileExtentBuffer=i.createVertexBuffer(o,s.aP.members),this.tileExtentSegments=s.aB.simpleSegment(0,0,4,2);const u=new s.aN;u.emplaceBack(0,0),u.emplaceBack(s.V,0),u.emplaceBack(0,s.V),u.emplaceBack(s.V,s.V),this.debugBuffer=i.createVertexBuffer(u,s.aP.members),this.debugSegments=s.aB.simpleSegment(0,0,4,5);const d=new s.aN;d.emplaceBack(-1,-1),d.emplaceBack(1,-1),d.emplaceBack(-1,1),d.emplaceBack(1,1),this.viewportBuffer=i.createVertexBuffer(d,s.aP.members),this.viewportSegments=s.aB.simpleSegment(0,0,4,2);const p=new s.av;p.emplaceBack(0,0,0,0),p.emplaceBack(s.V,0,s.V,0),p.emplaceBack(0,s.V,0,s.V),p.emplaceBack(s.V,s.V,s.V,s.V),this.mercatorBoundsBuffer=i.createVertexBuffer(p,s.aR.members),this.mercatorBoundsSegments=s.aB.simpleSegment(0,0,4,2);const g=new s.aw;g.emplaceBack(0,1,2),g.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=i.createIndexBuffer(g);const v=new s.aO;for(const M of[0,1,3,2,0])v.emplaceBack(M);this.debugIndexBuffer=i.createIndexBuffer(v),this.emptyTexture=new s.T(i,new s.h({width:1,height:1},Uint8Array.of(0,0,0,0)),i.gl.RGBA),this.identityMat=s.a6.create();const w=this.context.gl;this.stencilClearMode=new jt({func:w.ALWAYS,mask:0},0,255,w.ZERO,w.ZERO,w.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(i){return i._makeTileBoundsBuffers(this.context,this.transform.projection),i._tileBoundsBuffer?{tileBoundsBuffer:i._tileBoundsBuffer,tileBoundsIndexBuffer:i._tileBoundsIndexBuffer,tileBoundsSegments:i._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const i=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,i.TRIANGLES,zt.disabled,this.stencilClearMode,rr.disabled,Rt.disabled,Lu(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(i,o,u){if(!o||this.currentStencilSource===o.id||!i.isTileClipped()||!u||u.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let v=!1;for(const w of u)if(this._tileClippingMaskIDs[w.key]===void 0){v=!0;break}if(!v)return}this.currentStencilSource=o.id;const d=this.context,p=d.gl;this.nextStencilID+u.length>256&&this.clearStencil(),d.setColorMode(rr.disabled),d.setDepthMode(zt.disabled);const g=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const v of u){const w=o.getTile(v),M=this._tileClippingMaskIDs[v.key]=this.nextStencilID++,{tileBoundsBuffer:I,tileBoundsIndexBuffer:S,tileBoundsSegments:z}=this.getTileBoundsBuffers(w);g.draw(this,p.TRIANGLES,zt.disabled,new jt({func:p.ALWAYS,mask:0},M,255,p.KEEP,p.KEEP,p.REPLACE),rr.disabled,Rt.disabled,Lu(v.projMatrix),"$clipping",I,S,z)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const i=this.nextStencilID++,o=this.context.gl;return new jt({func:o.NOTEQUAL,mask:255},i,255,o.KEEP,o.KEEP,o.REPLACE)}stencilModeForClipping(i){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(i);const o=this.context.gl;return new jt({func:o.EQUAL,mask:255},this._tileClippingMaskIDs[i.key],0,o.KEEP,o.KEEP,o.REPLACE)}stencilConfigForOverlap(i){const o=this.context.gl,u=i.sort((g,v)=>v.overscaledZ-g.overscaledZ),d=u[u.length-1].overscaledZ,p=u[0].overscaledZ-d+1;if(p>1){this.currentStencilSource=void 0,this.nextStencilID+p>256&&this.clearStencil();const g={};for(let v=0;v<p;v++)g[v+d]=new jt({func:o.GEQUAL,mask:255},v+this.nextStencilID,255,o.KEEP,o.KEEP,o.REPLACE);return this.nextStencilID+=p,[g,u]}return[{[d]:jt.disabled},u]}colorModeForRenderPass(){const i=this.context.gl;return this._showOverdrawInspector?new rr([i.CONSTANT_COLOR,i.ONE,i.CONSTANT_COLOR,i.ONE],new s.ax(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?rr.unblended:rr.alphaBlended}colorModeForDrapableLayerRenderPass(i){const o=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?new rr([o.ONE,o.ONE_MINUS_SRC_ALPHA,o.CONSTANT_ALPHA,o.ONE_MINUS_SRC_ALPHA],new s.ax(0,0,0,i===void 0?0:i),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(i,o,u,d=!1){if(!this.opaquePassEnabledForLayer()&&!d)return zt.disabled;const p=1-((1+this.currentLayer)*this.numSublayers+i)*this.depthEpsilon;return new zt(u||this.context.gl.LEQUAL,o,[p,p])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(i,o){this._wireframeDebugCache.update(this.frameCounter),this.style=i,this.options=o;const u=this.style._mergedLayers,d=this.style.order,p=d.map(j=>u[j]),g=this.style._mergedSourceCaches;this.imageManager=i.imageManager,this.modelManager=i.modelManager,this.symbolFadeChange=i.placement.symbolFadeChange(s.f.now()),this.imageManager.beginFrame();let v=0,w=!1;for(const j in g){const Q=g[j];Q.used&&(Q.prepare(this.context),Q.getSource().usedInConflation&&++v)}for(const j of p)j.isHidden(this.transform.zoom)||this.prepareLayer(j);const M={},I={},S={},z={},R={};for(const j in g){const Q=g[j];M[j]=Q.getVisibleCoordinates(),I[j]=M[j].slice().reverse(),S[j]=Q.getVisibleCoordinates(!0).reverse(),z[j]=Q.getShadowCasterCoordinates(),R[j]=Q.sortCoordinatesByDistance(M[j])}const U=j=>{const Q=this.style.getLayerSourceCache(j);return Q&&Q.used?Q.getSource():null};if(v){const j=[];for(const Q of p)this.layerUsedInConflation(Q,U(Q))&&j.push(Q);if(j&&j.length>1){const Q=[];for(const oe of j){const le=this.style.getLayerSourceCache(oe);le&&le.used&&le.getSource().usedInConflation&&Q.push({layer:oe.fqid,cache:le})}this.replacementSource.setSources(Q),w=!0}}w||this.replacementSource.clear(),this.conflationActive=w,this.minCutoffZoom=0,this.longestCutoffRange=0;for(const j of p){const Q=j.cutoffRange();if(this.longestCutoffRange=Math.max(Q,this.longestCutoffRange),Q>0){const oe=U(j);oe&&(this.minCutoffZoom=Math.max(oe.minzoom,this.minCutoffZoom)),j.minzoom&&(this.minCutoffZoom=Math.max(j.minzoom,this.minCutoffZoom))}}this.opaquePassCutoff=1/0;for(let j=0;j<p.length;j++)if(p[j].is3D()){this.opaquePassCutoff=j;break}const N=this.style&&this.style.fog;N?(this._fogVisible=N.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=N.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(S),this.opaquePassCutoff=0);const V=this._shadowRenderer;if(V){V.updateShadowParameters(this.transform,this.style.directionalLight);for(const j in g)for(const Q of M[j]){let oe={min:0,max:0};this.terrain&&(oe=this.terrain.getMinMaxForTile(Q)||oe),V.addShadowReceiver(Q.toUnwrapped(),oe.min,oe.max)}}if(this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new s.cY(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new Lt(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),!s.cZ(this.context.gl))return;this.renderPass="offscreen";for(const j of p){const Q=i.getLayerSourceCache(j);if(!j.hasOffscreenPass()||j.isHidden(this.transform.zoom))continue;const oe=Q?I[Q.id]:void 0;(j.type==="custom"||j.type==="raster"||j.type==="raster-particle"||j.isSky()||oe&&oe.length)&&this.renderLayer(this,Q,j,oe)}this.depthRangeFor3D=[0,1-(p.length+2)*this.numSublayers*this.depthEpsilon];const B=this.terrain;B&&(this.style.hasSymbolLayers()||this.style.hasCircleLayers())&&!this.transform.isOrthographic&&B.drawDepth(),this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,z)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const G=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),K=(()=>{if(o.showOverdrawInspector)return s.ax.black;if(this.style.fog&&this.transform.projection.supportsFog&&!G){const j=this.style.fog.properties.get("color").toArray01();return new s.ax(...j)}if(this.style.fog&&this.transform.projection.supportsFog&&G){const j=this.style.fog.properties.get("space-color").toArray01();return new s.ax(...j)}return s.ax.transparent})();if(this.context.clear({color:K,depth:1}),this.clearStencil(),this._showOverdrawInspector=o.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&G&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=d.length-1;this.currentLayer>=0;this.currentLayer--){const j=p[this.currentLayer],Q=i.getLayerSourceCache(j);if(j.isSky())continue;const oe=Q?(j.is3D()?R:I)[Q.id]:void 0;this._renderTileClippingMasks(j,Q,oe),this.renderLayer(this,Q,j,oe)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&G&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||s.S(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<d.length;this.currentLayer++){const j=p[this.currentLayer],Q=i.getLayerSourceCache(j);j.isSky()&&this.renderLayer(this,Q,j,Q?I[Q.id]:void 0)}function q(j,Q){let oe;return Q&&(oe=(j.type==="symbol"?S:j.is3D()?R:I)[Q.id]),oe}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<d.length;){const j=p[this.currentLayer];if(j.type==="raster"){const Q=i.getLayerSourceCache(j);this.renderLayer(this,Q,j,q(j,Q))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let J=0;for(V&&(J=V.getShadowCastingLayerCount());this.currentLayer<d.length;){const j=p[this.currentLayer],Q=i.getLayerSourceCache(j);if(j.isSky())++this.currentLayer;else if(B&&this.style.isLayerDraped(j)){if(j.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=B.renderBatch(this.currentLayer)}else{if(this._renderTileClippingMasks(j,Q,Q?M[Q.id]:void 0),this.renderLayer(this,Q,j,q(j,Q)),!B&&V&&J>0&&j.hasShadowPass()&&--J==0&&(V.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){const oe=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=oe;this.currentLayer++){const le=p[this.currentLayer];if(!le.hasLightBeamPass())continue;const he=i.getLayerSourceCache(le);this.renderLayer(this,he,le,he?I[he.id]:void 0)}this.currentLayer=oe,this.renderPass="translucent"}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let j=null;p.forEach(Q=>{const oe=i.getLayerSourceCache(Q);oe&&!Q.isHidden(this.transform.zoom)&&oe.getVisibleCoordinates().length&&(!j||j.getSource().maxzoom<oe.getSource().maxzoom)&&(j=oe)}),j&&this.options.showTileBoundaries&&rl.debug(this,j,j.getVisibleCoordinates(),s.ax.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&rl.debug(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new s.ax(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(j){const Q=j.transform.padding;Ju(j,j.transform.height-(Q.top||0),3,an),Ju(j,Q.bottom||0,3,Ho),vn(j,Q.left||0,3,Nd),vn(j,j.transform.width-(Q.right||0),3,Yu);const oe=j.transform.centerPoint;(function(le,he,we,me){ei(le,he-1,we-10,2,20,me),ei(le,he-10,we-1,20,2,me)})(j,oe.x,j.transform.height-oe.y,Ku)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),w||(this.conflationActive=!1)}prepareLayer(i){this.gpuTimingStart(i);const{unsupportedLayers:o}=this.transform.projection,u=!o||!o.includes(i.type);if(ih[i.type]&&(u||this.terrain&&i.type==="custom")){const d=this.style.getLayerSourceCache(i);ih[i.type](i,d,this)}this.gpuTimingEnd()}renderLayer(i,o,u,d){u.isHidden(this.transform.zoom)||(u.type==="background"||u.type==="sky"||u.type==="custom"||u.type==="model"||u.type==="raster"||u.type==="raster-particle"||d&&d.length)&&(this.id=u.id,this.gpuTimingStart(u),(!i.transform.projection.unsupportedLayers||!i.transform.projection.unsupportedLayers.includes(u.type)||i.terrain&&u.type==="custom")&&rl[u.type](i,o,u,d,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(i){if(!this.options.gpuTiming)return;const o=this.context.extTimerQuery,u=this.context.gl;let d=this.gpuTimers[i.id];d||(d=this.gpuTimers[i.id]={calls:0,cpuTime:0,query:u.createQuery()}),d.calls++,u.beginQuery(o.TIME_ELAPSED_EXT,d.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const i=this.context.extTimerQuery,o=this.context.gl,u=o.createQuery();this.deferredRenderGpuTimeQueries.push(u),o.beginQuery(i.TIME_ELAPSED_EXT,u)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const i=this.gpuTimers;return this.gpuTimers={},i}collectDeferredRenderGpuQueries(){const i=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],i}queryGpuTimers(i){const o={};for(const u in i){const d=i[u],p=this.context.extTimerQuery,g=p.getQueryParameter(d.query,this.context.gl.QUERY_RESULT)/1e6;p.deleteQueryEXT(d.query),o[u]=g}return o}queryGpuTimeDeferredRender(i){if(!this.options.gpuTimingDeferredRender)return 0;const o=this.context.extTimerQuery,u=this.context.gl;let d=0;for(const p of i)d+=o.getQueryParameter(p,u.QUERY_RESULT)/1e6,o.deleteQueryEXT(p);return d}translatePosMatrix(i,o,u,d,p){if(!u[0]&&!u[1])return i;const g=p?d==="map"?this.transform.angle:0:d==="viewport"?-this.transform.angle:0;if(g){const M=Math.sin(g),I=Math.cos(g);u=[u[0]*I-u[1]*M,u[0]*M+u[1]*I]}const v=[p?u[0]:s.a3(o,u[0],this.transform.zoom),p?u[1]:s.a3(o,u[1],this.transform.zoom),0],w=new Float32Array(16);return s.a6.translate(w,i,v),w}saveTileTexture(i){const o=i.size[0],u=this._tileTextures[o];u?u.push(i):this._tileTextures[o]=[i]}getTileTexture(i){const o=this._tileTextures[i];return o&&o.length>0?o.pop():null}isPatternMissing(i,o){return i===null||i!==void 0&&!this.imageManager.getPattern(i.toString(),o)}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(i,o,u){const d=u===void 0?this.terrain&&this.terrain.renderingToTexture:u,p=this.terrain&&this.terrain.exaggeration()===0,g=[];return this.style&&this.style.enable3dLights()&&(i==="globeRaster"||i==="terrainRaster"?(g.push("LIGHTING_3D_MODE"),g.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):d||g.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"?this._shadowMapDebug||g.push("DEPTH_TEXTURE"):this.shadowRenderer&&(this.shadowRenderer.useNormalOffset?g.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"):g.push("RENDER_SHADOWS","DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(g.push("TERRAIN"),this.linearFloatFilteringSupported()&&g.push("TERRAIN_DEM_FLOAT_FORMAT"),p&&g.push("ZERO_EXAGGERATION")),this.transform.projection.name==="globe"&&g.push("GLOBE"),!this._fogVisible||d||o!==void 0&&!o||g.push("FOG","FOG_DITHERING"),d&&g.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&g.push("OVERDRAW_INSPECTOR"),g}getOrCreateProgram(i,o){this.cache=this.cache||{};const u=o&&o.defines||[],d=o&&o.config,p=o&&o.transformFeedback,g=this.currentGlobalDefines(i,o&&o.overrideFog,o&&o.overrideRtt).concat(u),v=Ou.cacheKey(Iu[i],i,g,d);return this.cache[v]||(this.cache[v]=new Ou(this.context,i,Iu[i],d,Kp[i],g,p)),this.cache[v]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const i=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(i.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new s.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(i,o){if(this.style.enable3dLights()){const u=this.style.directionalLight,d=this.style.ambientLight;if(u&&d){const p=((g,v)=>{const w=g.properties.get("direction"),M=g.properties.get("color").toArray01(),I=g.properties.get("intensity"),S=v.properties.get("color").toArray01(),z=v.properties.get("intensity"),R=[w.x,w.y,w.z],U=s.cn(S,z),N=s.cn(M,I);return{u_lighting_ambient_color:U,u_lighting_directional_dir:R,u_lighting_directional_color:N,u_ground_radiance:zu(R,N,U)}})(u,d);o.setLightsUniformValues(i,p)}}}uploadCommonUniforms(i,o,u,d,p){if(this.uploadCommonLightUniforms(i,o),this.terrain&&this.terrain.renderingToTexture)return;const g=this.style.fog;if(g){const v=g.getOpacity(this.transform.pitch),w=((M,I,S,z,R,U,N,V,B,G,K,q)=>{const J=M.transform,j=I.properties.get("color").toArray01();j[3]=z;const Q=M.frameCounter/1e3%1,[oe,le]=I.properties.get("vertical-range");return{u_fog_matrix:S?J.calculateFogTileMatrix(S):q||M.identityMat,u_fog_range:I.getFovAdjustedRange(J._fov),u_fog_color:j,u_fog_horizon_blend:I.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(oe,le),le],u_fog_temporal_offset:Q,u_frustum_tl:R,u_frustum_tr:U,u_frustum_br:N,u_frustum_bl:V,u_globe_pos:B,u_globe_radius:G,u_viewport:K,u_globe_transition:s.S(J.zoom),u_is_globe:+(J.projection.name==="globe")}})(this,g,u,v,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*s.f.devicePixelRatio,this.transform.height*s.f.devicePixelRatio],d);o.setFogUniformValues(i,w)}p&&o.setCutoffUniformValues(i,p.uniformValues)}setTileLoadedFlag(i){this.tileLoaded=i}saveCanvasCopy(){const i=this.canvasCopy();i&&(this.frameCopies.push(i),this.tileLoaded=!1)}canvasCopy(){const i=this.context.gl,o=i.createTexture();return i.bindTexture(i.TEXTURE_2D,o),i.copyTexImage2D(i.TEXTURE_2D,0,i.RGBA,0,0,i.drawingBufferWidth,i.drawingBufferHeight,0),o}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const i=this.style&&this.style.fog;return!!i&&i.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const i=this._backgroundTiles,o=this._backgroundTiles={},u=this.transform.coveringTiles({tileSize:512});for(const d of u)o[d.key]=i[d.key]||new Bo(d,512,this.transform.tileZoom,this);return o}clearBackgroundTiles(){this._backgroundTiles={}}layerUsedInConflation(i,o){return!(!i.is3D()||i.minzoom&&i.minzoom>this.transform.zoom||i.sourceLayer!=="building"&&(!o||o.type!=="batched-model"))}isTileAffectedByFog(i){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let o=this._cachedTileFogOpacities[i.key];return o||(this._cachedTileFogOpacities[i.key]=o=this.style.fog.getOpacityForTile(i)),o[0]>=Pr||o[1]>=Pr}}function il(c,i){let o=!1,u=null;const d=()=>{u=null,o&&(c(),u=setTimeout(d,i),o=!1)};return()=>(o=!0,u||d(),u)}class lc{constructor(i){this._hashName=i&&encodeURIComponent(i),s.aY(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=il(this._updateHashUnthrottled.bind(this),300)}addTo(i){return this._map=i,window.addEventListener("hashchange",this._onHashChange,!1),i.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const i=this._map;if(!i)return"";const o=nh(i);if(this._hashName){const u=this._hashName;let d=!1;const p=location.hash.slice(1).split("&").map(g=>{const v=g.split("=")[0];return v===u?(d=!0,`${v}=${o}`):g}).filter(g=>g);return d||p.push(`${u}=${o}`),`#${p.join("&")}`}return`#${o}`}_getCurrentHash(){const i=location.hash.replace("#","");if(this._hashName){let o;return i.split("&").map(u=>u.split("=")).forEach(u=>{u[0]===this._hashName&&(o=u)}),(o&&o[1]||"").split("/")}return i.split("/")}_onHashChange(){const i=this._map;if(!i)return!1;const o=this._getCurrentHash();if(o.length>=3&&!o.some(u=>isNaN(u))){const u=i.dragRotate.isEnabled()&&i.touchZoomRotate.isEnabled()?+(o[3]||0):i.getBearing();return i.jumpTo({center:[+o[2],+o[1]],zoom:+o[0],bearing:u,pitch:+(o[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function nh(c,i){const o=c.getCenter(),u=Math.round(100*c.getZoom())/100,d=Math.ceil((u*Math.LN2+Math.log(512/360/.5))/Math.LN10),p=Math.pow(10,d),g=Math.round(o.lng*p)/p,v=Math.round(o.lat*p)/p,w=c.getBearing(),M=c.getPitch();let I=i?`/${g}/${v}/${u}`:`${u}/${v}/${g}`;return(w||M)&&(I+="/"+Math.round(10*w)/10),M&&(I+=`/${Math.round(M)}`),I}const nl={linearity:.3,easing:s.c_(0,0,.3,1)},ln=s.e({deceleration:2500,maxSpeed:1400},nl),im=s.e({deceleration:20,maxSpeed:1400},nl),cc=s.e({deceleration:1e3,maxSpeed:360},nl),Xr=s.e({deceleration:1e3,maxSpeed:90},nl);class Dr{constructor(i){this._map=i,this.clear()}clear(){this._inertiaBuffer=[]}record(i){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:s.f.now(),settings:i})}_drainInertiaBuffer(){const i=this._inertiaBuffer,o=s.f.now();for(;i.length>0&&o-i[0].time>160;)i.shift()}_onMoveEnd(i){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const o={zoom:0,bearing:0,pitch:0,pan:new s.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:p}of this._inertiaBuffer)o.zoom+=p.zoomDelta||0,o.bearing+=p.bearingDelta||0,o.pitch+=p.pitchDelta||0,p.panDelta&&o.pan._add(p.panDelta),p.around&&(o.around=p.around),p.pinchAround&&(o.pinchAround=p.pinchAround);const u=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,d={};if(o.pan.mag()){const p=qn(o.pan.mag(),u,s.e({},ln,i||{}));d.offset=o.pan.mult(p.amount/o.pan.mag()),d.center=this._map.transform.center,ol(d,p)}if(o.zoom){const p=qn(o.zoom,u,im);d.zoom=this._map.transform.zoom+p.amount,ol(d,p)}if(o.bearing){const p=qn(o.bearing,u,cc);d.bearing=this._map.transform.bearing+s.aa(p.amount,-179,179),ol(d,p)}if(o.pitch){const p=qn(o.pitch,u,Xr);d.pitch=this._map.transform.pitch+p.amount,ol(d,p)}if(d.zoom||d.bearing){const p=o.pinchAround===void 0?o.around:o.pinchAround;d.around=p?this._map.unproject(p):this._map.getCenter()}return this.clear(),d.noMoveStart=!0,d}}function ol(c,i){(!c.duration||c.duration<i.duration)&&(c.duration=i.duration,c.easing=i.easing)}function qn(c,i,o){const{maxSpeed:u,linearity:d,deceleration:p}=o,g=s.aa(c*d/(i/1e3),-u,u),v=Math.abs(g)/(p*d);return{easing:o.easing,duration:1e3*v,amount:g*(v/2)}}class en extends s.b{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(i,o,u,d={}){const p=lr(o.getCanvasContainer(),u),g=o.unproject(p);super(i,s.e({point:p,lngLat:g,originalEvent:u},d)),this._defaultPrevented=!1,this.target=o}}class vo extends s.b{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(i,o,u){const d=i==="touchend"?u.changedTouches:u.touches,p=Lr(o.getCanvasContainer(),d),g=p.map(w=>o.unproject(w)),v=p.reduce((w,M,I,S)=>w.add(M.div(S.length)),new s.P(0,0));super(i,{points:p,point:v,lngLats:g,lngLat:o.unproject(v),originalEvent:u}),this._defaultPrevented=!1}}class oh extends s.b{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(i,o,u){super(i,{originalEvent:u}),this._defaultPrevented=!1}}class sh{constructor(i,o){this._map=i,this._clickTolerance=o.clickTolerance}reset(){this._mousedownPos=void 0}wheel(i){return this._firePreventable(new oh(i.type,this._map,i))}mousedown(i,o){return this._mousedownPos=o,this._firePreventable(new en(i.type,this._map,i))}mouseup(i){this._map.fire(new en(i.type,this._map,i))}preclick(i){const o=s.e({},i);o.type="preclick",this._map.fire(new en(o.type,this._map,o))}click(i,o){this._mousedownPos&&this._mousedownPos.dist(o)>=this._clickTolerance||(this.preclick(i),this._map.fire(new en(i.type,this._map,i)))}dblclick(i){return this._firePreventable(new en(i.type,this._map,i))}mouseover(i){this._map.fire(new en(i.type,this._map,i))}mouseout(i){this._map.fire(new en(i.type,this._map,i))}touchstart(i){return this._firePreventable(new vo(i.type,this._map,i))}touchmove(i){this._map.fire(new vo(i.type,this._map,i))}touchend(i){this._map.fire(new vo(i.type,this._map,i))}touchcancel(i){this._map.fire(new vo(i.type,this._map,i))}_firePreventable(i){if(this._map.fire(i),i.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Yo{constructor(i){this._map=i}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(i){this._map.fire(new en(i.type,this._map,i))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new en("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(i){this._delayContextMenu?this._contextMenuEvent=i:this._map.fire(new en(i.type,this._map,i)),this._map.listens("contextmenu")&&i.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Ko{constructor(i,o){this._map=i,this._el=i.getCanvasContainer(),this._container=i.getContainer(),this._clickTolerance=o.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(i,o){this.isEnabled()&&i.shiftKey&&i.button===0&&($e(),this._startPos=this._lastPos=o,this._active=!0)}mousemoveWindow(i,o){if(!this._active)return;const u=o,d=this._startPos,p=this._lastPos;if(!d||!p||p.equals(u)||!this._box&&u.dist(d)<this._clickTolerance)return;this._lastPos=u,this._box||(this._box=_e("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",i));const g=Math.min(d.x,u.x),v=Math.max(d.x,u.x),w=Math.min(d.y,u.y),M=Math.max(d.y,u.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${g}px,${w}px)`,this._box.style.width=v-g+"px",this._box.style.height=M-w+"px")})}mouseupWindow(i,o){if(!this._active)return;const u=this._startPos,d=o;if(u&&i.button===0){if(this.reset(),Ot(),u.x!==d.x||u.y!==d.y)return this._map.fire(new s.b("boxzoomend",{originalEvent:i})),{cameraAnimation:p=>p.fitScreenCoordinates(u,d,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",i)}}keydown(i){this._active&&i.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",i))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),ft(),delete this._startPos,delete this._lastPos}_fireEvent(i,o){return this._map.fire(new s.b(i,{originalEvent:o}))}}function ca(c,i){const o={};for(let u=0;u<c.length;u++)o[c[u].identifier]=i[u];return o}class uc{constructor(i){this.reset(),this.numTouches=i.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(i,o,u){(this.centroid||u.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=i.timeStamp),u.length===this.numTouches&&(this.centroid=function(d){const p=new s.P(0,0);for(const g of d)p._add(g);return p.div(d.length)}(o),this.touches=ca(u,o)))}touchmove(i,o,u){if(this.aborted||!this.centroid)return;const d=ca(u,o);for(const p in this.touches){const g=d[p];(!g||g.dist(this.touches[p])>30)&&(this.aborted=!0)}}touchend(i,o,u){if((!this.centroid||i.timeStamp-this.startTime>500)&&(this.aborted=!0),u.length===0){const d=!this.aborted&&this.centroid;if(this.reset(),d)return d}}}class sl{constructor(i){this.singleTap=new uc(i),this.numTaps=i.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(i,o,u){this.singleTap.touchstart(i,o,u)}touchmove(i,o,u){this.singleTap.touchmove(i,o,u)}touchend(i,o,u){const d=this.singleTap.touchend(i,o,u);if(d){const p=i.timeStamp-this.lastTime<500,g=!this.lastTap||this.lastTap.dist(d)<30;if(p&&g||this.reset(),this.count++,this.lastTime=i.timeStamp,this.lastTap=d,this.count===this.numTaps)return this.reset(),d}}}class ah{constructor(){this._zoomIn=new sl({numTouches:1,numTaps:2}),this._zoomOut=new sl({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(i,o,u){this._zoomIn.touchstart(i,o,u),this._zoomOut.touchstart(i,o,u)}touchmove(i,o,u){this._zoomIn.touchmove(i,o,u),this._zoomOut.touchmove(i,o,u)}touchend(i,o,u){const d=this._zoomIn.touchend(i,o,u),p=this._zoomOut.touchend(i,o,u);return d?(this._active=!0,i.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:g=>g.easeTo({duration:300,zoom:g.getZoom()+1,around:g.unproject(d)},{originalEvent:i})}):p?(this._active=!0,i.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:g=>g.easeTo({duration:300,zoom:g.getZoom()-1,around:g.unproject(p)},{originalEvent:i})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const lh={0:1,2:2};class io{constructor(i){this.reset(),this._clickTolerance=i.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(i,o){return!1}_move(i,o){return{}}mousedown(i,o){if(this._lastPoint)return;const u=Er(i);this._correctButton(i,u)&&(this._lastPoint=o,this._eventButton=u)}mousemoveWindow(i,o){const u=this._lastPoint;if(u){if(i.preventDefault(),this._eventButton!=null&&function(d,p){const g=lh[p];return d.buttons===void 0||(d.buttons&g)!==g}(i,this._eventButton))this.reset();else if(this._moved||!(o.dist(u)<this._clickTolerance))return this._moved=!0,this._lastPoint=o,this._move(u,o)}}mouseupWindow(i){this._lastPoint&&Er(i)===this._eventButton&&(this._moved&&Ot(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class ch extends io{mousedown(i,o){super.mousedown(i,o),this._lastPoint&&(this._active=!0)}_correctButton(i,o){return o===0&&!i.ctrlKey}_move(i,o){return{around:o,panDelta:o.sub(i)}}}class al extends io{_correctButton(i,o){return o===0&&i.ctrlKey||o===2}_move(i,o){const u=.8*(o.x-i.x);if(u)return this._active=!0,{bearingDelta:u}}contextmenu(i){i.preventDefault()}}class hc extends io{_correctButton(i,o){return o===0&&i.ctrlKey||o===2}_move(i,o){const u=-.5*(o.y-i.y);if(u)return this._active=!0,{pitchDelta:u}}contextmenu(i){i.preventDefault()}}class uh{constructor(i,o){this._map=i,this._el=i.getCanvasContainer(),this._minTouches=1,this._clickTolerance=o.clickTolerance||1,this.reset(),s.aY(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new s.P(0,0)}touchstart(i,o,u){return this._calculateTransform(i,o,u)}touchmove(i,o,u){if(this._active&&!(u.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(u.length===1&&!s.c$())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return i.cancelable&&i.preventDefault(),this._calculateTransform(i,o,u)}}touchend(i,o,u){this._calculateTransform(i,o,u),this._active&&u.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(i,o,u){u.length>0&&(this._active=!0);const d=ca(u,o),p=new s.P(0,0),g=new s.P(0,0);let v=0;for(const M in d){const I=d[M],S=this._touches[M];S&&(p._add(I),g._add(I.sub(S)),v++,d[M]=I)}if(this._touches=d,v<this._minTouches||!g.mag())return;const w=g.div(v);return this._sum._add(w),this._sum.mag()<this._clickTolerance?void 0:{around:p.div(v),panDelta:w}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=_e("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class Si{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(i){}_move(i,o,u){return{}}touchstart(i,o,u){this._firstTwoTouches||u.length<2||(this._firstTwoTouches=[u[0].identifier,u[1].identifier],this._start([o[0],o[1]]))}touchmove(i,o,u){const d=this._firstTwoTouches;if(!d)return;i.preventDefault();const[p,g]=d,v=ua(u,o,p),w=ua(u,o,g);if(!v||!w)return;const M=this._aroundCenter?null:v.add(w).div(2);return this._move([v,w],M,i)}touchend(i,o,u){if(!this._firstTwoTouches)return;const[d,p]=this._firstTwoTouches,g=ua(u,o,d),v=ua(u,o,p);g&&v||(this._active&&Ot(),this.reset())}touchcancel(){this.reset()}enable(i){this._enabled=!0,this._aroundCenter=!!i&&i.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function ua(c,i,o){for(let u=0;u<c.length;u++)if(c[u].identifier===o)return i[u]}function dc(c,i){return Math.log(c/i)/Math.LN2}class ll extends Si{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(i){this._startDistance=this._distance=i[0].dist(i[1])}_move(i,o){const u=this._distance;if(this._distance=i[0].dist(i[1]),this._active||!(Math.abs(dc(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:dc(this._distance,u),pinchAround:o}}}function Jo(c,i){return 180*c.angleWith(i)/Math.PI}class hh extends Si{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(i){this._startVector=this._vector=i[0].sub(i[1]),this._minDiameter=i[0].dist(i[1])}_move(i,o){const u=this._vector;if(this._vector=i[0].sub(i[1]),u&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:Jo(this._vector,u),pinchAround:o}}_isBelowThreshold(i){this._minDiameter=Math.min(this._minDiameter,i.mag());const o=25/(Math.PI*this._minDiameter)*360,u=this._startVector;if(!u)return!1;const d=Jo(i,u);return Math.abs(d)<o}}function cl(c){return Math.abs(c.y)>Math.abs(c.x)}class dh extends Si{constructor(i){super(),this._map=i}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(i){this._lastPoints=i,cl(i[0].sub(i[1]))&&(this._valid=!1)}_move(i,o,u){const d=this._lastPoints;if(!d)return;const p=i[0].sub(d[0]),g=i[1].sub(d[1]);return this._map._cooperativeGestures&&!s.c$()&&u.touches.length<3||(this._valid=this.gestureBeginsVertically(p,g,u.timeStamp),!this._valid)?void 0:(this._lastPoints=i,this._active=!0,{pitchDelta:(p.y+g.y)/2*-.5})}gestureBeginsVertically(i,o,u){if(this._valid!==void 0)return this._valid;const d=i.mag()>=2,p=o.mag()>=2;if(!d&&!p)return;if(!d||!p)return this._firstMove==null&&(this._firstMove=u),u-this._firstMove<100&&void 0;const g=i.y>0==o.y>0;return cl(i)&&cl(o)&&g}}const Ms={panStep:100,bearingStep:15,pitchStep:10};class ul{constructor(){const i=Ms;this._panStep=i.panStep,this._bearingStep=i.bearingStep,this._pitchStep=i.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(i){if(i.altKey||i.ctrlKey||i.metaKey)return;let o=0,u=0,d=0,p=0,g=0;switch(i.keyCode){case 61:case 107:case 171:case 187:o=1;break;case 189:case 109:case 173:o=-1;break;case 37:i.shiftKey?u=-1:(i.preventDefault(),p=-1);break;case 39:i.shiftKey?u=1:(i.preventDefault(),p=1);break;case 38:i.shiftKey?d=1:(i.preventDefault(),g=-1);break;case 40:i.shiftKey?d=-1:(i.preventDefault(),g=1);break;default:return}return this._rotationDisabled&&(u=0,d=0),{cameraAnimation:v=>{const w=v.getZoom();v.easeTo({duration:300,easeId:"keyboardHandler",easing:fh,zoom:o?Math.round(w)+o*(i.shiftKey?2:1):w,bearing:v.getBearing()+u*this._bearingStep,pitch:v.getPitch()+d*this._pitchStep,offset:[-p*this._panStep,-g*this._panStep],center:v.getCenter()},{originalEvent:i})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function fh(c){return c*(2-c)}const hl=4.000244140625,ph=1/450;class Zd{constructor(i,o){this._map=i,this._el=i.getCanvasContainer(),this._handler=o,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=ph,s.aY(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(i){this._defaultZoomRate=i}setWheelZoomRate(i){this._wheelZoomRate=i}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(i){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!i&&i.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(i){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(i.ctrlKey||i.metaKey||this.isZooming()||s.c$()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let o=i.deltaMode===WheelEvent.DOM_DELTA_LINE?40*i.deltaY:i.deltaY;const u=s.f.now(),d=u-(this._lastWheelEventTime||0);this._lastWheelEventTime=u,o!==0&&o%hl==0?this._type="wheel":o!==0&&Math.abs(o)<4?this._type="trackpad":d>400?(this._type=null,this._lastValue=o,this._timeout=setTimeout(this._onTimeout,40,i)):this._type||(this._type=Math.abs(d*o)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,o+=this._lastValue)),i.shiftKey&&o&&(o/=4),this._type&&(this._lastWheelEvent=i,this._delta-=o,this._active||this._start(i)),i.preventDefault()}_onTimeout(i){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(i)}_start(i){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const o=lr(this._el,i);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:o,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const i=this._map.transform;this._type==="wheel"&&i.projection.wrap&&(i._center.lng>=180||i._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const o=()=>i._terrainEnabled()&&this._aroundCoord?i.computeZoomRelativeTo(this._aroundCoord):i.zoom;if(this._delta!==0){const M=this._type==="wheel"&&Math.abs(this._delta)>hl?this._wheelZoomRate:this._defaultZoomRate;let I=2/(1+Math.exp(-Math.abs(this._delta*M)));this._delta<0&&I!==0&&(I=1/I);const S=o(),z=Math.pow(2,S),R=typeof this._targetZoom=="number"?i.zoomScale(this._targetZoom):z;this._targetZoom=Math.min(i.maxZoom,Math.max(i.minZoom,i.scaleZoom(R*I))),this._type==="wheel"&&(this._startZoom=S,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const u=typeof this._targetZoom=="number"?this._targetZoom:o(),d=this._startZoom,p=this._easing;let g,v=!1;if(this._type==="wheel"&&d&&p){const M=Math.min((s.f.now()-this._lastWheelEventTime)/200,1),I=p(M);g=s.U(d,u,I),M<1?this._frameId||(this._frameId=!0):v=!0}else g=u,v=!0;this._active=!0,v&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let w=g-o();return w*this._lastDelta<0&&(w=0),{noInertia:!0,needsRenderFrame:!v,zoomDelta:w,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(i){let o=s.d0;if(this._prevEase){const u=this._prevEase,d=(s.f.now()-u.start)/u.duration,p=u.easing(d+.01)-u.easing(d),g=.27/Math.sqrt(p*p+1e-4)*.01,v=Math.sqrt(.0729-g*g);o=s.c_(g,v,.25,1)}return this._prevEase={start:s.f.now(),duration:i,easing:o},o}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=_e("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class Gd{constructor(i,o){this._clickZoom=i,this._tapZoom=o}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class $d{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(i,o){return i.preventDefault(),{cameraAnimation:u=>{u.easeTo({duration:300,zoom:u.getZoom()+(i.shiftKey?-1:1),around:u.unproject(o)},{originalEvent:i})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class qd{constructor(){this._tap=new sl({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(i,o,u){this._swipePoint||(this._tapTime&&i.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?u.length>0&&(this._swipePoint=o[0],this._swipeTouch=u[0].identifier):this._tap.touchstart(i,o,u))}touchmove(i,o,u){if(this._tapTime){if(this._swipePoint){if(u[0].identifier!==this._swipeTouch)return;const d=o[0],p=d.y-this._swipePoint.y;return this._swipePoint=d,i.preventDefault(),this._active=!0,{zoomDelta:p/128}}}else this._tap.touchmove(i,o,u)}touchend(i,o,u){this._tapTime?this._swipePoint&&u.length===0&&this.reset():this._tap.touchend(i,o,u)&&(this._tapTime=i.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Wd{constructor(i,o,u){this._el=i,this._mousePan=o,this._touchPan=u}enable(i){this._inertiaOptions=i||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Hd{constructor(i,o,u){this._pitchWithRotate=i.pitchWithRotate,this._mouseRotate=o,this._mousePitch=u}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class Xd{constructor(i,o,u,d){this._el=i,this._touchZoom=o,this._touchRotate=u,this._tapDragZoom=d,this._rotationDisabled=!1,this._enabled=!0}enable(i){this._touchZoom.enable(i),this._rotationDisabled||this._touchRotate.enable(i),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const dl=c=>c.zoom||c.drag||c.pitch||c.rotate;class Yd extends s.b{}class Kd{constructor(){this.constants=[1,1,.01],this.radius=0}setup(i,o){const u=s.N.sub([],o,i);this.radius=s.N.length(u[2]<0?s.N.div([],u,this.constants):[u[0],u[1],0])}projectRay(i){s.N.div(i,i,this.constants),s.N.normalize(i,i),s.N.mul(i,i,this.constants);const o=s.N.scale([],i,this.radius);if(o[2]>0){const u=s.N.scale([],[0,0,1],s.N.dot(o,[0,0,1])),d=s.N.scale([],s.N.normalize([],[o[0],o[1],0]),this.radius),p=s.N.add([],o,s.N.scale([],s.N.sub([],s.N.add([],d,u),o),2));o[0]=p[0],o[1]=p[1]}return o}}function fl(c){return c.panDelta&&c.panDelta.mag()||c.zoomDelta||c.bearingDelta||c.pitchDelta}class nm{constructor(i,o){this._map=i,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Dr(i),this._bearingSnap=o.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Kd,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(o),s.aY(["handleEvent","handleWindowEvent"],this);const u=this._el;this._listeners=[[u,"touchstart",{passive:!0}],[u,"touchmove",{passive:!1}],[u,"touchend",void 0],[u,"touchcancel",void 0],[u,"mousedown",void 0],[u,"mousemove",void 0],[u,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[u,"mouseover",void 0],[u,"mouseout",void 0],[u,"dblclick",void 0],[u,"click",void 0],[u,"keydown",{capture:!1}],[u,"keyup",void 0],[u,"wheel",{passive:!1}],[u,"contextmenu",void 0],[window,"blur",void 0]];for(const[d,p,g]of this._listeners){const v=d===document?this.handleWindowEvent:this.handleEvent;d.addEventListener(p,v,g)}}destroy(){for(const[i,o,u]of this._listeners){const d=i===document?this.handleWindowEvent:this.handleEvent;i.removeEventListener(o,d,u)}}_addDefaultHandlers(i){const o=this._map,u=o.getCanvasContainer();this._add("mapEvent",new sh(o,i));const d=o.boxZoom=new Ko(o,i);this._add("boxZoom",d);const p=new ah,g=new $d;o.doubleClickZoom=new Gd(g,p),this._add("tapZoom",p),this._add("clickZoom",g);const v=new qd;this._add("tapDragZoom",v);const w=o.touchPitch=new dh(o);this._add("touchPitch",w);const M=new al(i),I=new hc(i);o.dragRotate=new Hd(i,M,I),this._add("mouseRotate",M,["mousePitch"]),this._add("mousePitch",I,["mouseRotate"]);const S=new ch(i),z=new uh(o,i);o.dragPan=new Wd(u,S,z),this._add("mousePan",S),this._add("touchPan",z,["touchZoom","touchRotate"]);const R=new hh,U=new ll;o.touchZoomRotate=new Xd(u,U,R,v),this._add("touchRotate",R,["touchPan","touchZoom"]),this._add("touchZoom",U,["touchPan","touchRotate"]),this._add("blockableMapEvent",new Yo(o));const N=o.scrollZoom=new Zd(o,this);this._add("scrollZoom",N,["mousePan"]);const V=o.keyboard=new ul;this._add("keyboard",V);for(const B of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])i.interactive&&i[B]&&o[B].enable(i[B])}_add(i,o,u){this._handlers.push({handlerName:i,handler:o,allowed:u}),this._handlersById[i]=o}stop(i){if(!this._updatingCamera){for(const{handler:o}of this._handlers)o.reset();this._inertia.clear(),this._fireEvents({},{},i),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:i}of this._handlers)if(i.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!dl(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(i,o,u){for(const d in i)if(d!==u&&(!o||o.indexOf(d)<0))return!0;return!1}handleWindowEvent(i){this.handleEvent(i,`${i.type}Window`)}_getMapTouches(i){const o=[];for(const u of i)this._el.contains(u.target)&&o.push(u);return o}handleEvent(i,o){this._updatingCamera=!0;const u=i.type==="renderFrame",d=u?void 0:i,p={needsRenderFrame:!1},g={},v={},w=i.touches?this._getMapTouches(i.touches):void 0,M=w?Lr(this._el,w):u?void 0:lr(this._el,i);for(const{handlerName:z,handler:R,allowed:U}of this._handlers){if(!R.isEnabled())continue;let N;this._blockedByActive(v,U,z)?R.reset():R[o||i.type]&&(N=R[o||i.type](i,M,w),this.mergeHandlerResult(p,g,N,z,d),N&&N.needsRenderFrame&&this._triggerRenderFrame()),(N||R.isActive())&&(v[z]=R)}const I={};for(const z in this._previousActiveHandlers)v[z]||(I[z]=d);this._previousActiveHandlers=v,(Object.keys(I).length||fl(p))&&(this._changes.push([p,g,I]),this._triggerRenderFrame()),(Object.keys(v).length||fl(p))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:S}=p;S&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],S(this._map))}mergeHandlerResult(i,o,u,d,p){if(!u)return;s.e(i,u);const g={handlerName:d,originalEvent:u.originalEvent||p};u.zoomDelta!==void 0&&(o.zoom=g),u.panDelta!==void 0&&(o.drag=g),u.pitchDelta!==void 0&&(o.pitch=g),u.bearingDelta!==void 0&&(o.rotate=g)}_applyChanges(){const i={},o={},u={};for(const[d,p,g]of this._changes)d.panDelta&&(i.panDelta=(i.panDelta||new s.P(0,0))._add(d.panDelta)),d.zoomDelta&&(i.zoomDelta=(i.zoomDelta||0)+d.zoomDelta),d.bearingDelta&&(i.bearingDelta=(i.bearingDelta||0)+d.bearingDelta),d.pitchDelta&&(i.pitchDelta=(i.pitchDelta||0)+d.pitchDelta),d.around!==void 0&&(i.around=d.around),d.aroundCoord!==void 0&&(i.aroundCoord=d.aroundCoord),d.pinchAround!==void 0&&(i.pinchAround=d.pinchAround),d.noInertia&&(i.noInertia=d.noInertia),s.e(o,p),s.e(u,g);this._updateMapTransform(i,o,u),this._changes=[]}_updateMapTransform(i,o,u){const d=this._map,p=d.transform,g=G=>[G.x,G.y,G.z];if((G=>{const K=this._eventsInProgress.drag;return K&&!this._handlersById[K.handlerName].isActive()})()&&!fl(i)){const G=p.zoom;p.cameraElevationReference="sea",this._originalZoom!=null&&p._orthographicProjectionAtLowPitch&&p.projection.name!=="globe"&&p.pitch===0?(p.cameraElevationReference="ground",p.zoom=this._originalZoom):(p.recenterOnTerrain(),p.cameraElevationReference="ground"),G!==p.zoom&&this._map._update(!0)}if(p._isCameraConstrained&&d._stop(!0),!fl(i))return void this._fireEvents(o,u,!0);let{panDelta:v,zoomDelta:w,bearingDelta:M,pitchDelta:I,around:S,aroundCoord:z,pinchAround:R}=i;p._isCameraConstrained&&(w>0&&(w=0),p._isCameraConstrained=!1),R!==void 0&&(S=R),(w||(G=>o[G]&&!this._eventsInProgress[G])("drag"))&&S&&(this._dragOrigin=g(p.pointCoordinate3D(S)),this._originalZoom=p.zoom,this._trackingEllipsoid.setup(p._camera.position,this._dragOrigin)),p.cameraElevationReference="sea",d._stop(!0),S=S||d.transform.centerPoint,M&&(p.bearing+=M),I&&(p.pitch+=I),p._updateCameraState();const U=[0,0,0];if(v)if(p.projection.name==="mercator"){const G=this._trackingEllipsoid.projectRay(p.screenPointToMercatorRay(S).dir),K=this._trackingEllipsoid.projectRay(p.screenPointToMercatorRay(S.sub(v)).dir);U[0]=K[0]-G[0],U[1]=K[1]-G[1]}else{const G=p.pointCoordinate(S);if(p.projection.name==="globe"){v=v.rotate(-p.angle);const K=p._pixelsPerMercatorPixel/p.worldSize;U[0]=-v.x*s.d1(s.au(G.y))*K,U[1]=-v.y*s.d1(p.center.lat)*K}else{const K=p.pointCoordinate(S.sub(v));G&&K&&(U[0]=K.x-G.x,U[1]=K.y-G.y)}}const N=p.zoom,V=[0,0,0];if(w){const G=g(z||p.pointCoordinate3D(S)),K={dir:s.N.normalize([],s.N.sub([],G,p._camera.position))};if(K.dir[2]<0){const q=p.zoomDeltaToMovement(G,w);s.N.scale(V,K.dir,q)}}const B=s.N.add(U,U,V);p._translateCameraConstrained(B),w&&Math.abs(p.zoom-N)>1e-4&&p.recenterOnTerrain(),p.cameraElevationReference="ground",this._map._update(),i.noInertia||this._inertia.record(i),this._fireEvents(o,u,!0)}_fireEvents(i,o,u){const d=dl(this._eventsInProgress),p=dl(i),g={};for(const I in i){const{originalEvent:S}=i[I];this._eventsInProgress[I]||(g[`${I}start`]=S),this._eventsInProgress[I]=i[I]}!d&&p&&this._fireEvent("movestart",p.originalEvent);for(const I in g)this._fireEvent(I,g[I]);p&&this._fireEvent("move",p.originalEvent);for(const I in i){const{originalEvent:S}=i[I];this._fireEvent(I,S)}const v={};let w;for(const I in this._eventsInProgress){const{handlerName:S,originalEvent:z}=this._eventsInProgress[I];this._handlersById[S].isActive()||(delete this._eventsInProgress[I],w=o[S]||z,v[`${I}end`]=w)}for(const I in v)this._fireEvent(I,v[I]);const M=dl(this._eventsInProgress);if(u&&(d||p)&&!M){this._updatingCamera=!0;const I=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),S=z=>z!==0&&-this._bearingSnap<z&&z<this._bearingSnap;I?(S(I.bearing||this._map.getBearing())&&(I.bearing=0),this._map.easeTo(I,{originalEvent:w})):(this._map.fire(new s.b("moveend",{originalEvent:w})),S(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(i,o){this._map.fire(new s.b(i,o?{originalEvent:o}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(i=>{this._frameId=void 0,this.handleEvent(new Yd("renderFrame",{timeStamp:i})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const Jd="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class ci extends s.E{constructor(i,o){super(),this._moving=!1,this._zooming=!1,this.transform=i,this._bearingSnap=o.bearingSnap,this._respectPrefersReducedMotion=o.respectPrefersReducedMotion!==!1,s.aY(["_renderFrameCallback"],this)}getCenter(){return new s.bn(this.transform.center.lng,this.transform.center.lat)}setCenter(i,o){return this.jumpTo({center:i},o)}panBy(i,o,u){return i=s.P.convert(i).mult(-1),this.panTo(this.transform.center,s.e({offset:i},o),u)}panTo(i,o,u){return this.easeTo(s.e({center:i},o),u)}getZoom(){return this.transform.zoom}setZoom(i,o){return this.jumpTo({zoom:i},o),this}zoomTo(i,o,u){return this.easeTo(s.e({zoom:i},o),u)}zoomIn(i,o){return this.zoomTo(this.getZoom()+1,i,o),this}zoomOut(i,o){return this.zoomTo(this.getZoom()-1,i,o),this}getBearing(){return this.transform.bearing}setBearing(i,o){return this.jumpTo({bearing:i},o),this}getPadding(){return this.transform.padding}setPadding(i,o){return this.jumpTo({padding:i},o),this}rotateTo(i,o,u){return this.easeTo(s.e({bearing:i},o),u)}resetNorth(i,o){return this.rotateTo(0,s.e({duration:1e3},i),o),this}resetNorthPitch(i,o){return this.easeTo(s.e({bearing:0,pitch:0,duration:1e3},i),o),this}snapToNorth(i,o){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(i,o):this}getPitch(){return this.transform.pitch}setPitch(i,o){return this.jumpTo({pitch:i},o),this}cameraForBounds(i,o){i=s.ad.convert(i);const u=o&&o.bearing||0,d=o&&o.pitch||0,p=i.getNorthWest(),g=i.getSouthEast();return this._cameraForBounds(this.transform,p,g,u,d,o)}_extendCameraOptions(i){const o={top:0,bottom:0,right:0,left:0};if(typeof(i=s.e({padding:o,offset:[0,0],maxZoom:this.transform.maxZoom},i)).padding=="number"){const u=i.padding;i.padding={top:u,bottom:u,right:u,left:u}}return i.padding=s.e(o,i.padding),i}_minimumAABBFrustumDistance(i,o){const u=o.max[0]-o.min[0],d=o.max[1]-o.min[1];return u/d>i.aspect?u/(2*Math.tan(.5*i.fovX)*i.aspect):d/(2*Math.tan(.5*i.fovY)*i.aspect)}_cameraForBoundsOnGlobe(i,o,u,d,p,g){const v=i.clone(),w=this._extendCameraOptions(g);v.bearing=d,v.pitch=p;const M=s.bn.convert(o),I=s.bn.convert(u),S=.5*(M.lat+I.lat),z=.5*(M.lng+I.lng),R=s.d2(S,z),U=s.N.normalize([],R),N=s.N.normalize([],s.N.cross([],U,[0,1,0])),V=s.N.cross([],N,U),B=[N[0],N[1],N[2],0,V[0],V[1],V[2],0,U[0],U[1],U[2],0,0,0,0,1],G=[R,s.d2(M.lat,M.lng),s.d2(I.lat,M.lng),s.d2(I.lat,I.lng),s.d2(M.lat,I.lng),s.d2(S,M.lng),s.d2(S,I.lng),s.d2(M.lat,z),s.d2(I.lat,z)];let K=s.bS.fromPoints(G.map(ve=>[s.N.dot(N,ve),s.N.dot(V,ve),s.N.dot(U,ve)]));const q=s.N.transformMat4([],K.center,B);s.N.squaredLength(q)===0&&s.N.set(q,0,0,1),s.N.normalize(q,q),s.N.scale(q,q,s.ab),v.center=s.d3(q);const J=v.getWorldToCameraMatrix(),j=s.a6.invert(new Float64Array(16),J);K=s.bS.applyTransform(K,s.a6.multiply([],J,B)),s.N.transformMat4(q,q,J);const Q=.5*(K.max[2]-K.min[2]),oe=this._minimumAABBFrustumDistance(v,K),le=s.N.scale([],[0,0,1],Q),he=s.N.add(le,q,le),we=oe+(v.pitch===0?0:s.N.distance(q,he)),me=v.globeCenterInViewSpace,Ae=s.N.sub([],q,[me[0],me[1],me[2]]);s.N.normalize(Ae,Ae),s.N.scale(Ae,Ae,we);const Ie=s.N.add([],q,Ae);s.N.transformMat4(Ie,Ie,j);const Ue=s.d4/s.ab,ge=s.N.length(Ie),Ee=s.bl(Math.max(ge*Ue-s.d4,Number.EPSILON),0),ue=Math.min(v.zoomFromMercatorZAdjusted(Ee),w.maxZoom);return ue>.5*(s.bG+s.bx)?(v.setProjection({name:"mercator"}),v.zoom=ue,this._cameraForBounds(v,o,u,d,p,g)):{center:v.center,zoom:ue,bearing:d,pitch:p}}queryTerrainElevation(i,o){const u=this.transform.elevation;return u?(o=s.e({},{exaggerated:!0},o),u.getAtPoint(s.L.fromLngLat(i),null,o.exaggerated)):null}_cameraForBounds(i,o,u,d,p,g){if(i.projection.name==="globe")return this._cameraForBoundsOnGlobe(i,o,u,d,p,g);const v=i.clone(),w=this._extendCameraOptions(g),M=v.padding;v.bearing=d,v.pitch=p;const I=s.bn.convert(o),S=s.bn.convert(u),z=new s.bn(I.lng,S.lat),R=new s.bn(S.lng,I.lat),U=v.project(I),N=v.project(S),V=this.queryTerrainElevation(I),B=this.queryTerrainElevation(S),G=this.queryTerrainElevation(z),K=this.queryTerrainElevation(R),q=[[U.x,U.y,Math.min(V||0,B||0,G||0,K||0)],[N.x,N.y,Math.max(V||0,B||0,G||0,K||0)]];let J=s.bS.fromPoints(q);const j=v.getWorldToCameraMatrix(),Q=s.a6.invert(new Float64Array(16),j);J=s.bS.applyTransform(J,j);const oe=s.N.sub([],J.max,J.min),le=M.left||0,he=M.right||0,we=M.bottom||0,me=M.top||0,{left:Ae,right:Ie,top:Ue,bottom:ge}=w.padding,Ee=.5*(le+he),ue=.5*(me+we),ve=Math.min(v.scaleZoom(v.scale*Math.min((v.width-(le+he+Ae+Ie))/oe[0],(v.height-(we+me+ge+Ue))/oe[1])),w.maxZoom),Ve=v.scale/v.zoomScale(ve);J=new s.bS([J.min[0]-(Ae+Ee)*Ve,J.min[1]-(ge+ue)*Ve,J.min[2]],[J.max[0]+(Ie+Ee)*Ve,J.max[1]+(Ue+ue)*Ve,J.max[2]]);const Ye=.5*oe[2],Xe=this._minimumAABBFrustumDistance(v,J),ot=[0,0,1,0];s.a7.transformMat4(ot,ot,j),s.a7.normalize(ot,ot);const yt=s.N.scale([],ot,Xe+Ye),Pt=s.N.add([],J.center,yt),Tt=(typeof w.offset.x=="number"&&typeof w.offset.y=="number"?new s.P(w.offset.x,w.offset.y):s.P.convert(w.offset)).rotate(-s.bj(d));J.center[0]-=Tt.x*Ve,J.center[1]+=Tt.y*Ve,s.N.transformMat4(J.center,J.center,Q),s.N.transformMat4(Pt,Pt,Q);const It=[J.center[0],J.center[1],Pt[2]*v.pixelsPerMeter];s.N.scale(It,It,1/v.worldSize);const Yt=s.at(It[0]),Vt=s.au(It[1]),qt=Math.min(v._zoomFromMercatorZ(It[2]),w.maxZoom),$t=new s.bn(Yt,Vt);return v.mercatorFromTransition&&qt<.5*(s.bG+s.bx)?(v.setProjection({name:"globe"}),v.zoom=qt,this._cameraForBounds(v,o,u,d,p,g)):{center:$t,zoom:qt,bearing:d,pitch:p}}fitBounds(i,o,u){const d=this.cameraForBounds(i,o);return this._fitInternal(d,o,u)}fitScreenCoordinates(i,o,u,d,p){const g=s.P.convert(i),v=s.P.convert(o),w=new s.P(Math.min(g.x,v.x),Math.min(g.y,v.y)),M=new s.P(Math.max(g.x,v.x),Math.max(g.y,v.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(g,v))return this;const I=this.transform.pointLocation3D(w),S=this.transform.pointLocation3D(M),z=this.transform.pointLocation3D(new s.P(w.x,M.y)),R=this.transform.pointLocation3D(new s.P(M.x,w.y)),U=[Math.min(I.lng,S.lng,z.lng,R.lng),Math.min(I.lat,S.lat,z.lat,R.lat)],N=[Math.max(I.lng,S.lng,z.lng,R.lng),Math.max(I.lat,S.lat,z.lat,R.lat)],V=d&&d.pitch?d.pitch:this.getPitch(),B=this._cameraForBounds(this.transform,U,N,u,V,d);return this._fitInternal(B,d,p)}_fitInternal(i,o,u){return i?(delete(o=s.e(i,o)).padding,o.linear?this.easeTo(o,u):this.flyTo(o,u)):this}jumpTo(i,o){this.stop();const u=i.preloadOnly?this.transform.clone():this.transform;let d=!1,p=!1,g=!1;return"zoom"in i&&u.zoom!==+i.zoom&&(d=!0,u.zoom=+i.zoom),i.center!==void 0&&(u.center=s.bn.convert(i.center)),"bearing"in i&&u.bearing!==+i.bearing&&(p=!0,u.bearing=+i.bearing),"pitch"in i&&u.pitch!==+i.pitch&&(g=!0,u.pitch=+i.pitch),i.padding==null||u.isPaddingEqual(i.padding)||(u.padding=i.padding),i.preloadOnly?(this._preloadTiles(u),this):(this.fire(new s.b("movestart",o)).fire(new s.b("move",o)),d&&this.fire(new s.b("zoomstart",o)).fire(new s.b("zoom",o)).fire(new s.b("zoomend",o)),p&&this.fire(new s.b("rotatestart",o)).fire(new s.b("rotate",o)).fire(new s.b("rotateend",o)),g&&this.fire(new s.b("pitchstart",o)).fire(new s.b("pitch",o)).fire(new s.b("pitchend",o)),this.fire(new s.b("moveend",o)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||s.w(Jd),this.transform.getFreeCameraOptions()}setFreeCameraOptions(i,o){const u=this.transform;if(!u.projection.supportsFreeCamera)return s.w(Jd),this;this.stop();const d=u.zoom,p=u.pitch,g=u.bearing;u.setFreeCameraOptions(i);const v=d!==u.zoom,w=p!==u.pitch,M=g!==u.bearing;return this.fire(new s.b("movestart",o)).fire(new s.b("move",o)),v&&this.fire(new s.b("zoomstart",o)).fire(new s.b("zoom",o)).fire(new s.b("zoomend",o)),M&&this.fire(new s.b("rotatestart",o)).fire(new s.b("rotate",o)).fire(new s.b("rotateend",o)),w&&this.fire(new s.b("pitchstart",o)).fire(new s.b("pitch",o)).fire(new s.b("pitchend",o)),this.fire(new s.b("moveend",o)),this}easeTo(i,o){this._stop(!1,i.easeId),((i=s.e({offset:[0,0],duration:500,easing:s.d0},i)).animate===!1||this._prefersReducedMotion(i))&&(i.duration=0);const u=this.transform,d=this.getZoom(),p=this.getBearing(),g=this.getPitch(),v=this.getPadding(),w="zoom"in i?+i.zoom:d,M="bearing"in i?this._normalizeBearing(i.bearing,p):p,I="pitch"in i?+i.pitch:g,S="padding"in i?i.padding:u.padding,z=s.P.convert(i.offset);let R,U,N;if(u.projection.name==="globe"){const le=s.L.fromLngLat(u.center),he=z.rotate(-u.angle);le.x+=he.x/u.worldSize,le.y+=he.y/u.worldSize;const we=le.toLngLat(),me=s.bn.convert(i.center||we);this._normalizeCenter(me),R=u.centerPoint.add(he),U=new s.P(le.x,le.y).mult(u.worldSize),N=new s.P(s.a5(me.lng),s.ae(me.lat)).mult(u.worldSize).sub(U)}else{R=u.centerPoint.add(z);const le=u.pointLocation(R),he=s.bn.convert(i.center||le);this._normalizeCenter(he),U=u.project(le),N=u.project(he).sub(U)}const V=u.zoomScale(w-d);let B,G;i.around&&(B=s.bn.convert(i.around),G=u.locationPoint(B));const K=this._zooming||w!==d,q=this._rotating||p!==M,J=this._pitching||I!==g,j=!u.isPaddingEqual(S),Q=le=>he=>{if(K&&(le.zoom=s.U(d,w,he)),q&&(le.bearing=s.U(p,M,he)),J&&(le.pitch=s.U(g,I,he)),j&&(le.interpolatePadding(v,S,he),R=le.centerPoint.add(z)),B)le.setLocationAtPoint(B,G);else{const we=le.zoomScale(le.zoom-d),me=w>d?Math.min(2,V):Math.max(.5,V),Ae=Math.pow(me,1-he),Ie=le.unproject(U.add(N.mult(he*Ae)).mult(we));le.setLocationAtPoint(le.renderWorldCopies?Ie.wrap():Ie,R)}return i.preloadOnly||this._fireMoveEvents(o),le};if(i.preloadOnly){const le=this._emulate(Q,i.duration,u);return this._preloadTiles(le),this}const oe={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=K,this._rotating=q,this._pitching=J,this._easeId=i.easeId,this._prepareEase(o,i.noMoveStart,oe),this._ease(Q(u),le=>{u.cameraElevationReference==="sea"&&u.recenterOnTerrain(),this._afterEase(o,le)},i),this}_prepareEase(i,o,u={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),o||u.moving||this.fire(new s.b("movestart",i)),this._zooming&&!u.zooming&&this.fire(new s.b("zoomstart",i)),this._rotating&&!u.rotating&&this.fire(new s.b("rotatestart",i)),this._pitching&&!u.pitching&&this.fire(new s.b("pitchstart",i))}_fireMoveEvents(i){this.fire(new s.b("move",i)),this._zooming&&this.fire(new s.b("zoom",i)),this._rotating&&this.fire(new s.b("rotate",i)),this._pitching&&this.fire(new s.b("pitch",i))}_afterEase(i,o){if(this._easeId&&o&&this._easeId===o)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const u=this._zooming,d=this._rotating,p=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,u&&this.fire(new s.b("zoomend",i)),d&&this.fire(new s.b("rotateend",i)),p&&this.fire(new s.b("pitchend",i)),this.fire(new s.b("moveend",i))}flyTo(i,o){if(this._prefersReducedMotion(i)){const ge=s.ac(i,["center","zoom","bearing","pitch","around"]);return this.jumpTo(ge,o)}this.stop(),i=s.e({offset:[0,0],speed:1.2,curve:1.42,easing:s.d0},i);const u=this.transform,d=this.getZoom(),p=this.getBearing(),g=this.getPitch(),v="zoom"in i?s.aa(+i.zoom,u.minZoom,u.maxZoom):d,w="bearing"in i?this._normalizeBearing(i.bearing,p):p,M="pitch"in i?+i.pitch:g,I=u.zoomScale(v-d),S=s.P.convert(i.offset),z=u.centerPoint.add(S),R=u.pointLocation(z);let U=i.center;if(U&&i.padding){const ge=this._cameraForBounds(this.transform,U,U,w,M,i);ge&&(U=ge.center)}U=s.bn.convert(U||R),this._normalizeCenter(U);const N=u.project(R),V=u.project(U).sub(N);let B=i.curve;const G=Math.max(u.width,u.height),K=G/I,q=V.mag();if("minZoom"in i){const ge=s.aa(Math.min(i.minZoom,d,v),u.minZoom,u.maxZoom),Ee=G/u.zoomScale(ge-d);B=Math.sqrt(Ee/q*2)}const J=B*B;function j(ge){const Ee=(K*K-G*G+(ge?-1:1)*J*J*q*q)/(2*(ge?K:G)*J*q);return Math.log(Math.sqrt(Ee*Ee+1)-Ee)}function Q(ge){return(Math.exp(ge)-Math.exp(-ge))/2}function oe(ge){return(Math.exp(ge)+Math.exp(-ge))/2}const le=j(0);let he=function(ge){return oe(le)/oe(le+B*ge)},we=function(ge){return G*((oe(le)*(Q(Ee=le+B*ge)/oe(Ee))-Q(le))/J)/q;var Ee},me=(j(1)-le)/B;if(Math.abs(q)<1e-6||!isFinite(me)){if(Math.abs(G-K)<1e-6)return this.easeTo(i,o);const ge=K<G?-1:1;me=Math.abs(Math.log(K/G))/B,we=function(){return 0},he=function(Ee){return Math.exp(ge*B*Ee)}}i.duration="duration"in i?+i.duration:1e3*me/("screenSpeed"in i?+i.screenSpeed/B:+i.speed),i.maxDuration&&i.duration>i.maxDuration&&(i.duration=0);const Ae=p!==w,Ie=M!==g,Ue=ge=>Ee=>{const ue=Ee*me,ve=1/he(ue);ge.zoom=Ee===1?v:d+ge.scaleZoom(ve),Ae&&(ge.bearing=s.U(p,w,Ee)),Ie&&(ge.pitch=s.U(g,M,Ee));const Ve=Ee===1?U:ge.unproject(N.add(V.mult(we(ue))).mult(ve));return ge.setLocationAtPoint(ge.renderWorldCopies?Ve.wrap():Ve,z),ge._updateCameraOnTerrain(),i.preloadOnly||this._fireMoveEvents(o),ge};if(i.preloadOnly){const ge=this._emulate(Ue,i.duration,u);return this._preloadTiles(ge),this}return this._zooming=!0,this._rotating=Ae,this._pitching=Ie,this._prepareEase(o,!1),this._ease(Ue(u),()=>this._afterEase(o),i),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(i,o){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const u=this._onEaseEnd;this._onEaseEnd=void 0,u.call(this,o)}if(!i){const u=this.handlers;u&&u.stop(!1)}return this}_ease(i,o,u){u.animate===!1||u.duration===0?(i(1),o()):(this._easeStart=s.f.now(),this._easeOptions=u,this._onEaseFrame=i,this._onEaseEnd=o,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const i=Math.min((s.f.now()-this._easeStart)/this._easeOptions.duration,1),o=this._onEaseFrame;o&&o(this._easeOptions.easing(i)),i<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(i,o){i=s.bh(i,-180,180);const u=Math.abs(i-o);return Math.abs(i-360-o)<u&&(i-=360),Math.abs(i+360-o)<u&&(i+=360),i}_normalizeCenter(i){const o=this.transform;if(o.maxBounds||o.projection.name!=="globe"&&!o.renderWorldCopies)return;const u=i.lng-o.center.lng;i.lng+=u>180?-360:u<-180?360:0}_prefersReducedMotion(i){return this._respectPrefersReducedMotion&&s.f.prefersReducedMotion&&!(i&&i.essential)}_emulate(i,o,u){const d=Math.ceil(15*o/1e3),p=[],g=i(u.clone());for(let v=0;v<=d;v++){const w=g(v/d);p.push(w.clone())}return p}}class mh{constructor(i={}){this.options=i,s.aY(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(i){const o=this.options&&this.options.compact;return this._map=i,this._container=_e("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=_e("button","mapboxgl-ctrl-attrib-button",this._container),_e("span","mapboxgl-ctrl-icon",this._compactButton).setAttribute("aria-hidden","true"),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=_e("div","mapboxgl-ctrl-attrib-inner",this._container),o&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),o===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_setElementTitle(i,o){const u=this._map._getUIString(`AttributionControl.${o}`);i.removeAttribute("title"),i.firstElementChild&&i.firstElementChild.setAttribute("title",u)}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let i=this._editLink;i||(i=this._editLink=this._container.querySelector(".mapbox-improve-map"));const o=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||s.d5.ACCESS_TOKEN}];if(i){const u=o.reduce((d,p,g)=>(p.value&&(d+=`${p.key}=${p.value}${g<o.length-1?"&":""}`),d),"?");i.href=`${s.d5.FEEDBACK_URL}/${u}#${nh(this._map,!0)}`,i.rel="noopener nofollow",this._setElementTitle(i,"MapFeedback")}}_updateData(i){!i||i.sourceDataType!=="metadata"&&i.sourceDataType!=="visibility"&&i.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let i=[];if(this._map.style.stylesheet){const d=this._map.style.stylesheet;this.styleOwner=d.owner,this.styleId=d.id}const o=this._map.style._mergedSourceCaches;for(const d in o){const p=o[d];if(p.used){const g=p.getSource();g.attribution&&i.indexOf(g.attribution)<0&&i.push(g.attribution)}}i.sort((d,p)=>d.length-p.length),i=i.filter((d,p)=>{for(let g=p+1;g<i.length;g++)if(i[g].indexOf(d)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?i=[...this.options.customAttribution,...i]:i.unshift(this.options.customAttribution));const u=i.join(" | ");u!==this._attribHTML&&(this._attribHTML=u,i.length?(this._innerContainer.innerHTML=u,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Qd{constructor(){s.aY(["_updateLogo","_updateCompact"],this)}onAdd(i){this._map=i,this._container=_e("div","mapboxgl-ctrl");const o=_e("a","mapboxgl-ctrl-logo");return o.target="_blank",o.rel="noopener nofollow",o.href="https://www.mapbox.com/",o.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),o.setAttribute("rel","noopener nofollow"),this._container.appendChild(o),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(i){i&&i.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const i=this._map.style._sourceCaches;if(Object.entries(i).length===0)return!0;for(const o in i){const u=i[o].getSource();if(u.hasOwnProperty("mapbox_logo")&&!u.mapbox_logo)return!1}return!0}_updateCompact(){const i=this._container.children;if(i.length){const o=i[0];this._map.getCanvasContainer().offsetWidth<250?o.classList.add("mapboxgl-compact"):o.classList.remove("mapboxgl-compact")}}}class ef{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(i){const o=++this._id;return this._queue.push({callback:i,id:o,cancelled:!1}),o}remove(i){const o=this._currentlyRunning,u=o?this._queue.concat(o):this._queue;for(const d of u)if(d.id===i)return void(d.cancelled=!0)}run(i=0){const o=this._currentlyRunning=this._queue;this._queue=[];for(const u of o)if(!u.cancelled&&(u.callback(i),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}function pl(c,i,o){if(c=new s.bn(c.lng,c.lat),i){const u=new s.bn(c.lng-360,c.lat),d=new s.bn(c.lng+360,c.lat),p=360*Math.ceil(Math.abs(c.lng-o.center.lng)/360),g=o.locationPoint(c).distSqr(i),v=i.x<0||i.y<0||i.x>o.width||i.y>o.height;o.locationPoint(u).distSqr(i)<g&&(v||Math.abs(u.lng-o.center.lng)<p)?c=u:o.locationPoint(d).distSqr(i)<g&&(v||Math.abs(d.lng-o.center.lng)<p)&&(c=d)}for(;Math.abs(c.lng-o.center.lng)>180;){const u=o.locationPoint(c);if(u.x>=0&&u.y>=0&&u.x<=o.width&&u.y<=o.height)break;c.lng>o.center.lng?c.lng-=360:c.lng+=360}return c}const fc={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class _h extends s.E{constructor(i,o){if(super(),(i instanceof HTMLElement||o)&&(i=s.e({element:i},o)),s.aY(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=i&&i.anchor||"center",this._color=i&&i.color||"#3FB1CE",this._scale=i&&i.scale||1,this._draggable=i&&i.draggable||!1,this._clickTolerance=i&&i.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=i&&i.rotation||0,this._rotationAlignment=i&&i.rotationAlignment||"auto",this._pitchAlignment=i&&i.pitchAlignment&&i.pitchAlignment||"auto",this._updateMoving=()=>this._update(!0),this._occludedOpacity=i&&i.occludedOpacity||.2,i&&i.element)this._element=i.element,this._offset=s.P.convert(i&&i.offset||[0,0]);else{this._defaultMarker=!0,this._element=_e("div");const p=41,g=27,v=qe("svg",{display:"block",height:p*this._scale+"px",width:g*this._scale+"px",viewBox:`0 0 ${g} ${p}`},this._element),w=qe("radialGradient",{id:"shadowGradient"},qe("defs",{},v));qe("stop",{offset:"10%","stop-opacity":.4},w),qe("stop",{offset:"100%","stop-opacity":.05},w),qe("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},v),qe("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},v),qe("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},v),qe("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},v),this._offset=s.P.convert(i&&i.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",p=>{p.preventDefault()}),this._element.addEventListener("mousedown",p=>{p.preventDefault()});const u=this._element.classList;for(const p in fc)u.remove(`mapboxgl-marker-anchor-${p}`);u.add(`mapboxgl-marker-anchor-${this._anchor}`);const d=i&&i.className?i.className.trim().split(/\s+/):[];u.add(...d),this._popup=null}addTo(i){return i===this._map||(this.remove(),this._map=i,i.getCanvasContainer().appendChild(this._element),i.on("move",this._updateMoving),i.on("moveend",this._update),i.on("remove",this._clearFadeTimer),i._addMarker(this),this.setDraggable(this._draggable),this._update(),i.on("click",this._onMapClick)),this}remove(){const i=this._map;return i&&(i.off("click",this._onMapClick),i.off("move",this._updateMoving),i.off("moveend",this._update),i.off("mousedown",this._addDragHandler),i.off("touchstart",this._addDragHandler),i.off("mouseup",this._onUp),i.off("touchend",this._onUp),i.off("mousemove",this._onMove),i.off("touchmove",this._onMove),i.off("remove",this._clearFadeTimer),i._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(i){return this._lngLat=s.bn.convert(i),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(i){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),i){if(!("offset"in i.options)){const d=Math.sqrt(Math.pow(13.5,2)/2);i.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[d,-1*(38.1-13.5+d)],"bottom-right":[-d,-1*(38.1-13.5+d)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=i,i._marker=this,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(i){const o=i.code,u=i.charCode||i.keyCode;o!=="Space"&&o!=="Enter"&&u!==32&&u!==13||this.togglePopup()}_onMapClick(i){const o=i.originalEvent.target,u=this._element;this._popup&&(o===u||u.contains(o))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const i=this._popup;return i?(i.isOpen()?(i.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(i.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const i=this._map,o=this._pos;if(!i||!o)return!1;const u=i.unproject(o),d=i.getFreeCameraOptions();if(!d.position)return!1;const p=d.position.toLngLat();return p.distanceTo(u)<.9*p.distanceTo(this._lngLat)}_evaluateOpacity(){const i=this._map;if(!i)return;const o=this._pos;if(!o||o.x<0||o.x>i.transform.width||o.y<0||o.y>i.transform.height)return void this._clearFadeTimer();const u=i.unproject(o);let d;i._showingGlobe()&&s.d6(i.transform,this._lngLat)?d=0:(d=1-i._queryFogOpacity(u),i.transform._terrainEnabled()&&i.getTerrain()&&this._behindTerrain()&&(d*=this._occludedOpacity)),this._element.style.opacity=`${d}`,this._element.style.pointerEvents=d>0?"auto":"none",this._popup&&this._popup._setOpacity(d),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const i=this._pos;if(!i||!this._map)return;const o=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${i.x}px,${i.y}px)
            ${fc[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${o.x}px,${o.y}px)
        `}_calculateXYTransform(){const i=this._pos,o=this._map,u=this.getPitchAlignment();if(!o||!i||u!=="map")return"";if(!o._showingGlobe()){const w=o.getPitch();return w?`rotateX(${w}deg)`:""}const d=s.bF(s.d7(o.transform,this._lngLat)),p=i.sub(s.d8(o.transform)),g=Math.abs(p.x)+Math.abs(p.y);if(g===0)return"";const v=d/g;return`rotateX(${-p.y*v}deg) rotateY(${p.x*v}deg)`}_calculateZTransform(){const i=this._pos,o=this._map;if(!o||!i)return"";let u=0;const d=this.getRotationAlignment();if(d==="map")if(o._showingGlobe()){const p=o.project(new s.bn(this._lngLat.lng,this._lngLat.lat+.001)),g=o.project(new s.bn(this._lngLat.lng,this._lngLat.lat-.001)).sub(p);u=s.bF(Math.atan2(g.y,g.x))-90}else u=-o.getBearing();else if(d==="horizon"){const p=s.O(4,6,o.getZoom()),g=s.d8(o.transform);g.y+=p*o.transform.height;const v=i.sub(g),w=s.bF(Math.atan2(v.y,v.x));u=(w>90?w-270:w+90)*(1-p)}return u+=this._rotation,u?`rotateZ(${u}deg)`:""}_update(i){cancelAnimationFrame(this._updateFrameId);const o=this._map;o&&(o.transform.renderWorldCopies&&(this._lngLat=pl(this._lngLat,this._pos,o.transform)),this._pos=o.project(this._lngLat),i===!0?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),o._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(o._showingGlobe()||o.getTerrain()||o.getFog())&&!this._fadeTimer&&(this._fadeTimer=setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(i){return this._offset=s.P.convert(i),this._update(),this}addClassName(i){return this._element.classList.add(i),this}removeClassName(i){return this._element.classList.remove(i),this}toggleClassName(i){return this._element.classList.toggle(i)}_onMove(i){const o=this._map;if(!o)return;const u=this._pointerdownPos,d=this._positionDelta;if(u&&d){if(!this._isDragging){const p=this._clickTolerance||o._clickTolerance;if(i.point.dist(u)<p)return;this._isDragging=!0}this._pos=i.point.sub(d),this._lngLat=o.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new s.b("dragstart"))),this.fire(new s.b("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const i=this._map;i&&(i.off("mousemove",this._onMove),i.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new s.b("dragend")),this._state="inactive"}_addDragHandler(i){const o=this._map,u=this._pos;o&&u&&this._element.contains(i.originalEvent.target)&&(i.preventDefault(),this._positionDelta=i.point.sub(u),this._pointerdownPos=i.point,this._state="pending",o.on("mousemove",this._onMove),o.on("touchmove",this._onMove),o.once("mouseup",this._onUp),o.once("touchend",this._onUp))}setDraggable(i){this._draggable=!!i;const o=this._map;return o&&(i?(o.on("mousedown",this._addDragHandler),o.on("touchstart",this._addDragHandler)):(o.off("mousedown",this._addDragHandler),o.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(i){return this._rotation=i||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(i){return this._rotationAlignment=i||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(i){return this._pitchAlignment=i||"auto",this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(i){return this._occludedOpacity=i||.2,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const tf={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},rf=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function nf(c=new s.P(0,0),i="bottom"){if(typeof c=="number"){const o=Math.round(Math.sqrt(.5*Math.pow(c,2)));switch(i){case"top":return new s.P(0,c);case"top-left":return new s.P(o,o);case"top-right":return new s.P(-o,o);case"bottom":return new s.P(0,-c);case"bottom-left":return new s.P(o,-o);case"bottom-right":return new s.P(-o,-o);case"left":return new s.P(c,0);case"right":return new s.P(-c,0)}return new s.P(0,0)}return c instanceof s.P||Array.isArray(c)?s.P.convert(c):s.P.convert(c[i]||[0,0])}class gh{constructor(i){this.jumpTo(i)}getValue(i){if(i<=this._startTime)return this._start;if(i>=this._endTime)return this._end;const o=s.cc((i-this._startTime)/(this._endTime-this._startTime));return this._start*(1-o)+this._end*o}isEasing(i){return i>=this._startTime&&i<=this._endTime}jumpTo(i){this._startTime=-1/0,this._endTime=-1/0,this._start=i,this._end=i}easeTo(i,o,u){this._start=this.getValue(o),this._end=i,this._startTime=o,this._endTime=o+u}}const ml={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use  + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"},of={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1};class yh{constructor(){this.showOverdrawInspector=!1,this.showTileBoundaries=!1,this.showParseStatus=!1,this.continuousRedraw=!1,this.showTileAABBs=!1,this.showPadding=!1,this.showTerrainWireframe=!1,this.showLayers2DWireframe=!1,this.showLayers3DWireframe=!1}}const pc={showCompass:!0,showZoom:!0,visualizePitch:!1};class bo{constructor(i,o,u=!1){this._clickTolerance=10,this.element=o,this.mouseRotate=new al({clickTolerance:i.dragRotate._mouseRotate._clickTolerance}),this.map=i,u&&(this.mousePitch=new hc({clickTolerance:i.dragRotate._mousePitch._clickTolerance})),s.aY(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),o.addEventListener("mousedown",this.mousedown),o.addEventListener("touchstart",this.touchstart,{passive:!1}),o.addEventListener("touchmove",this.touchmove),o.addEventListener("touchend",this.touchend),o.addEventListener("touchcancel",this.reset)}down(i,o){this.mouseRotate.mousedown(i,o),this.mousePitch&&this.mousePitch.mousedown(i,o),$e()}move(i,o){const u=this.map,d=this.mouseRotate.mousemoveWindow(i,o),p=d&&d.bearingDelta;if(p&&u.setBearing(u.getBearing()+p),this.mousePitch){const g=this.mousePitch.mousemoveWindow(i,o),v=g&&g.pitchDelta;v&&u.setPitch(u.getPitch()+v)}}off(){const i=this.element;i.removeEventListener("mousedown",this.mousedown),i.removeEventListener("touchstart",this.touchstart,{passive:!1}),i.removeEventListener("touchmove",this.touchmove),i.removeEventListener("touchend",this.touchend),i.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){ft(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(i){this.down(s.e({},i,{ctrlKey:!0,preventDefault:()=>i.preventDefault()}),lr(this.element,i)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(i){this.move(i,lr(this.element,i))}mouseup(i){this.mouseRotate.mouseupWindow(i),this.mousePitch&&this.mousePitch.mouseupWindow(i),this.offTemp()}touchstart(i){i.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=Lr(this.element,i.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>i.preventDefault()},this._startPos))}touchmove(i){i.targetTouches.length!==1?this.reset():(this._lastPos=Lr(this.element,i.targetTouches)[0],this.move({preventDefault:()=>i.preventDefault()},this._lastPos))}touchend(i){i.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}const mc={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},Hi={maxWidth:100,unit:"metric"},Qo={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"};return{version:s.dk,supported:ae,setRTLTextPlugin:s.dm,getRTLTextPluginStatus:s.dn,Map:class extends ci{constructor(c){const i=c;if((c=s.e({},of,c)).minZoom!=null&&c.maxZoom!=null&&c.minZoom>c.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(c.minPitch!=null&&c.maxPitch!=null&&c.minPitch>c.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(c.minPitch!=null&&c.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(c.maxPitch!=null&&c.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(c.antialias&&s.d9(window)&&(c.antialias=!1,s.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new ja(c.minZoom,c.maxZoom,c.minPitch,c.maxPitch,c.renderWorldCopies),c),this._repaint=!1,this._interactive=c.interactive,this._minTileCacheSize=c.minTileCacheSize,this._maxTileCacheSize=c.maxTileCacheSize,this._failIfMajorPerformanceCaveat=c.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=c.preserveDrawingBuffer,this._antialias=c.antialias,this._trackResize=c.trackResize,this._bearingSnap=c.bearingSnap,this._refreshExpiredTiles=c.refreshExpiredTiles,this._fadeDuration=c.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=c.crossSourceCollisions,this._collectResourceTiming=c.collectResourceTiming,this._language=this._parseLanguage(c.language),this._worldview=c.worldview,this._renderTaskQueue=new ef,this._domRenderTaskQueue=new ef,this._controls=[],this._markers=[],this._popups=[],this._mapId=s.aC(),this._locale=s.e({},ml,c.locale),this._clickTolerance=c.clickTolerance,this._cooperativeGestures=c.cooperativeGestures,this._performanceMetricsCollection=c.performanceMetricsCollection,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new gh(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._requestManager=new s.da(c.transformRequest,c.accessToken,c.testMode),this._silenceAuthErrors=!!c.testMode,this._contextCreateOptions=c.contextCreateOptions?{...c.contextCreateOptions}:{},typeof c.container=="string"){const o=document.getElementById(c.container);if(!o)throw new Error(`Container '${c.container.toString()}' not found.`);this._container=o}else{if(!(c.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=c.container}if(this._container.childNodes.length>0&&s.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),c.maxBounds&&this.setMaxBounds(c.maxBounds),s.aY(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._debugParams=new yh,this._tp=c.devtools?new tl(this):new tl,this._tp.registerParameter(this._debugParams,["Debug"],"showOverdrawInspector",void 0,()=>{this._update()}),this._tp.registerParameter(this._debugParams,["Debug"],"showTileBoundaries",void 0,()=>{this._update()}),this._tp.registerParameter(this._debugParams,["Debug"],"showParseStatus",void 0,()=>{this._update()}),this._tp.registerParameter(this._debugParams,["Debug"],"continuousRedraw",void 0,o=>{this.repaint=o}),this._tp.registerParameter(this._debugParams,["Debug"],"showTileAABBs",void 0,o=>{this.showTileAABBs=o}),this._tp.registerParameter(this._debugParams,["Debug"],"showPadding",void 0,o=>{this.showPadding=o}),this._tp.registerParameter(this._debugParams,["Debug","Wireframe"],"showTerrainWireframe",void 0,()=>{this._update()}),this._tp.registerParameter(this._debugParams,["Debug","Wireframe"],"showLayers2DWireframe",void 0,()=>{this._update()}),this._tp.registerParameter(this._debugParams,["Debug","Wireframe"],"showLayers3DWireframe",void 0,()=>{this._update()}),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new nm(this,c),this._localFontFamily=c.localFontFamily,this._localIdeographFontFamily=c.localIdeographFontFamily,(c.style||!c.testMode)&&this.setStyle(c.style||s.d5.DEFAULT_STYLE,{localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),c.projection&&this.setProjection(c.projection),c.hash&&(this._hash=new lc(typeof c.hash=="string"&&c.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){i.center==null&&i.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:c.center,zoom:c.zoom,bearing:c.bearing,pitch:c.pitch});const o=c.bounds;o&&(this.resize(),this.fitBounds(o,s.e({},c.fitBoundsOptions,{duration:0})))}this.resize(),c.attributionControl&&this.addControl(new mh({customAttribution:c.customAttribution})),this._logoControl=new Qd,this.addControl(this._logoControl,c.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)}),this.on("data",o=>{this._update(o.dataType==="style"),this.fire(new s.b(`${o.dataType}data`,o))}),this.on("dataloading",o=>{this.fire(new s.b(`${o.dataType}dataloading`,o))})}_getMapId(){return this._mapId}addControl(c,i){if(i===void 0&&(i=c.getDefaultPosition?c.getDefaultPosition():"top-right"),!c||!c.onAdd)return this.fire(new s.a(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const o=c.onAdd(this);this._controls.push(c);const u=this._controlPositions[i];return i.indexOf("bottom")!==-1?u.insertBefore(o,u.firstChild):u.appendChild(o),this}removeControl(c){if(!c||!c.onRemove)return this.fire(new s.a(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const i=this._controls.indexOf(c);return i>-1&&this._controls.splice(i,1),c.onRemove(this),this}hasControl(c){return this._controls.indexOf(c)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(c){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const i=!this._moving;return i&&this.fire(new s.b("movestart",c)).fire(new s.b("move",c)),this.fire(new s.b("resize",c)),i&&this.fire(new s.b("moveend",c)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(c){return this.transform.setMaxBounds(s.ad.convert(c)),this._update()}setMinZoom(c){if((c=c??-2)>=-2&&c<=this.transform.maxZoom)return this.transform.minZoom=c,this._update(),this.getZoom()<c?this.setZoom(c):this.fire(new s.b("zoomstart")).fire(new s.b("zoom")).fire(new s.b("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(c){if((c=c??22)>=this.transform.minZoom)return this.transform.maxZoom=c,this._update(),this.getZoom()>c?this.setZoom(c):this.fire(new s.b("zoomstart")).fire(new s.b("zoom")).fire(new s.b("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(c){if((c=c??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(c>=0&&c<=this.transform.maxPitch)return this.transform.minPitch=c,this._update(),this.getPitch()<c?this.setPitch(c):this.fire(new s.b("pitchstart")).fire(new s.b("pitch")).fire(new s.b("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(c){if((c=c??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(c>=this.transform.minPitch)return this.transform.maxPitch=c,this._update(),this.getPitch()>c?this.setPitch(c):this.fire(new s.b("pitchstart")).fire(new s.b("pitch")).fire(new s.b("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(c){return this.transform.renderWorldCopies=c,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(c){return c==="auto"?navigator.language:Array.isArray(c)?c.length===0?void 0:c.map(i=>i==="auto"?navigator.language:i):c}setLanguage(c){const i=this._parseLanguage(c);if(!this.style||i===this._language)return this;this._language=i,this.style.reloadSources();for(const o of this._controls)o._setLanguage&&o._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(c){return this.style&&c!==this._worldview?(this._worldview=c,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(c){return this._lazyInitEmptyStyle(),c?typeof c=="string"&&(c={name:c}):c=null,this._useExplicitProjection=!!c,this._prioritizeAndUpdateProjection(c,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;const c=this.transform,i=c.projection.name;let o;i==="globe"&&c.zoom>=s.bx?(c.setMercatorFromTransition(),o=!0):i==="mercator"&&c.zoom<s.bx&&(c.setProjection({name:"globe"}),o=!0),o&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(c,i){return this._updateProjection(c||i||{name:"mercator"})}_updateProjection(c){let i;return i=c.name==="globe"&&this.transform.zoom>=s.bx?this.transform.setMercatorFromTransition():this.transform.setProjection(c),this.style.applyProjectionUpdate(),i&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(c){return this.transform.locationPoint3D(s.bn.convert(c))}unproject(c){return this.transform.pointLocation3D(s.P.convert(c))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(c,i,o){if(c==="mouseenter"||c==="mouseover"){let u=!1;const d=g=>{const v=i.filter(M=>this.getLayer(M)),w=v.length?this.queryRenderedFeatures(g.point,{layers:v}):[];w.length?u||(u=!0,o.call(this,new en(c,this,g.originalEvent,{features:w}))):u=!1},p=()=>{u=!1};return{layers:new Set(i),listener:o,delegates:{mousemove:d,mouseout:p}}}if(c==="mouseleave"||c==="mouseout"){let u=!1;const d=g=>{const v=i.filter(w=>this.getLayer(w));(v.length?this.queryRenderedFeatures(g.point,{layers:v}):[]).length?u=!0:u&&(u=!1,o.call(this,new en(c,this,g.originalEvent)))},p=g=>{u&&(u=!1,o.call(this,new en(c,this,g.originalEvent)))};return{layers:new Set(i),listener:o,delegates:{mousemove:d,mouseout:p}}}{const u=d=>{const p=i.filter(v=>this.getLayer(v)),g=p.length?this.queryRenderedFeatures(d.point,{layers:p}):[];g.length&&(d.features=g,o.call(this,d),delete d.features)};return{layers:new Set(i),listener:o,delegates:{[c]:u}}}}on(c,i,o){if(o===void 0)return super.on(c,i);if(Array.isArray(i)||(i=[i]),i){for(const d of i)if(!this._isValidId(d))return this}const u=this._createDelegatedListener(c,i,o);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[c]=this._delegatedListeners[c]||[],this._delegatedListeners[c].push(u);for(const d in u.delegates)this.on(d,u.delegates[d]);return this}once(c,i,o){if(o===void 0)return super.once(c,i);if(Array.isArray(i)||(i=[i]),i){for(const d of i)if(!this._isValidId(d))return this}const u=this._createDelegatedListener(c,i,o);for(const d in u.delegates)this.once(d,u.delegates[d]);return this}off(c,i,o){if(o===void 0)return super.off(c,i);i=new Set(Array.isArray(i)?i:[i]);for(const p of i)if(!this._isValidId(p))return this;const u=(p,g)=>{if(p.size!==g.size)return!1;for(const v of p)if(!g.has(v))return!1;return!0},d=this._delegatedListeners?this._delegatedListeners[c]:void 0;return d&&(p=>{for(let g=0;g<p.length;g++){const v=p[g];if(v.listener===o&&u(v.layers,i)){for(const w in v.delegates)this.off(w,v.delegates[w]);return p.splice(g,1),this}}})(d),this}queryRenderedFeatures(c,i){if(!this.style)return[];if(i!==void 0||c===void 0||c instanceof s.P||Array.isArray(c)||(i=c,c=void 0),c=c||[[0,0],[this.transform.width,this.transform.height]],(i=i||{}).layers&&Array.isArray(i.layers)){for(const o of i.layers)if(!this._isValidId(o))return[]}return this.style.queryRenderedFeatures(c,i,this.transform)}querySourceFeatures(c,i){return this._isValidId(c)?this.style.querySourceFeatures(c,i):[]}isPointOnSurface(c){const{name:i}=this.transform.projection;return i!=="globe"&&i!=="mercator"&&s.w(`${i} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(s.P.convert(c))}setStyle(c,i){return(i=s.e({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},i)).diff!==!1&&i.localIdeographFontFamily===this._localIdeographFontFamily&&i.localFontFamily===this._localFontFamily&&this.style&&c?(this._diffStyle(c,i),this):(this._localIdeographFontFamily=i.localIdeographFontFamily,this._localFontFamily=i.localFontFamily,this._updateStyle(c,i))}_getUIString(c){const i=this._locale[c];if(i==null)throw new Error(`Missing UI string '${c}'`);return i}_updateStyle(c,i){return this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),c&&(this.style=new Zn(this,i||{}),this.style.setEventedParent(this,{style:this.style}),typeof c=="string"?this.style.loadURL(c):this.style.loadJSON(c)),this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Zn(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(c,i){if(typeof c=="string"){const o=this._requestManager.normalizeStyleURL(c),u=this._requestManager.transformRequest(o,s.R.Style);s.g(u,(d,p)=>{d?this.fire(new s.a(d)):p&&this._updateDiff(p,i)})}else typeof c=="object"&&this._updateDiff(c,i)}_updateDiff(c,i){try{this.style.setState(c)&&this._update(!0)}catch(o){s.w(`Unable to perform style diff: ${o.message||o.error||o}.  Rebuilding the style from scratch.`),this._updateStyle(c,i)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(s.w("There is no style added to the map."),!1)}_isValidId(c){return c==null?(this.fire(new s.a(new Error("IDs can't be empty."))),!1):!s.c4(c)||(this.fire(new s.a(new Error(`IDs can't contain special symbols: "${c}".`))),!1)}addSource(c,i){return this._isValidId(c)?(this._lazyInitEmptyStyle(),this.style.addSource(c,i),this._update(!0)):this}isSourceLoaded(c){return!!this._isValidId(c)&&!!this.style&&this.style._isSourceCacheLoaded(c)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(c,i,o){this._lazyInitEmptyStyle(),this.style.addSourceType(c,i,o)}removeSource(c){return this._isValidId(c)?(this.style.removeSource(c),this._updateTerrain(),this._update(!0)):this}getSource(c){return this._isValidId(c)?this.style.getOwnSource(c):null}addImage(c,i,{pixelRatio:o=1,sdf:u=!1,stretchX:d,stretchY:p,content:g}={}){if(this._lazyInitEmptyStyle(),i instanceof HTMLImageElement||ImageBitmap&&i instanceof ImageBitmap){const{width:v,height:w,data:M}=s.f.getImageData(i);this.style.addImage(c,{data:new s.h({width:v,height:w},M),pixelRatio:o,stretchX:d,stretchY:p,content:g,sdf:u,version:0})}else if(i.width===void 0||i.height===void 0)this.fire(new s.a(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:v,height:w}=i,M=i;this.style.addImage(c,{data:new s.h({width:v,height:w},new Uint8Array(M.data)),pixelRatio:o,stretchX:d,stretchY:p,content:g,sdf:u,version:0,userImage:M}),M.onAdd&&M.onAdd(this,c)}}updateImage(c,i){this._lazyInitEmptyStyle();const o=this.style.getImage(c);if(!o)return void this.fire(new s.a(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const u=i instanceof HTMLImageElement||ImageBitmap&&i instanceof ImageBitmap?s.f.getImageData(i):i,{width:d,height:p}=u,g=u.data;if(d===void 0||p===void 0)return void this.fire(new s.a(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(d!==o.data.width||p!==o.data.height)return void this.fire(new s.a(new Error(`The width and height of the updated image (${d}, ${p})
                must be that same as the previous version of the image
                (${o.data.width}, ${o.data.height})`)));const v=!(i instanceof HTMLImageElement||ImageBitmap&&i instanceof ImageBitmap);o.data.replace(g,v),this.style.updateImage(c,o)}hasImage(c){return c?!!this.style&&!!this.style.getImage(c):(this.fire(new s.a(new Error("Missing required image id"))),!1)}removeImage(c){this.style.removeImage(c)}loadImage(c,i){s.d(this._requestManager.transformRequest(c,s.R.Image),(o,u)=>{i(o,u instanceof HTMLImageElement?s.f.getImageData(u):u)})}listImages(){return this.style.listImages()}addModel(c,i){this._lazyInitEmptyStyle(),this.style.addModel(c,i)}hasModel(c){return c?this.style.hasModel(c):(this.fire(new s.a(new Error("Missing required model id"))),!1)}removeModel(c){this.style.removeModel(c)}listModels(){return this.style.listModels()}addLayer(c,i){return this._isValidId(c.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(c,i),this._update(!0)):this}getSlot(c){const i=this.getLayer(c);return i&&i.slot||null}setSlot(c,i){return this.style.setSlot(c,i),this.style.mergeLayers(),this._update(!0)}addImport(c,i){return this.style.addImport(c,i),this}updateImport(c,i){return typeof i!="string"&&i.id!==c?(this.removeImport(c),this.addImport(i)):(this.style.updateImport(c,i),this._update(!0))}removeImport(c){return this.style.removeImport(c),this}moveImport(c,i){return this.style.moveImport(c,i),this._update(!0)}moveLayer(c,i){return this._isValidId(c)?(this.style.moveLayer(c,i),this._update(!0)):this}removeLayer(c){return this._isValidId(c)?(this.style.removeLayer(c),this._update(!0)):this}getLayer(c){return this._isValidId(c)?this.style.getOwnLayer(c):null}setLayerZoomRange(c,i,o){return this._isValidId(c)?(this.style.setLayerZoomRange(c,i,o),this._update(!0)):this}setFilter(c,i,o={}){return this._isValidId(c)?(this.style.setFilter(c,i,o),this._update(!0)):this}getFilter(c){return this._isValidId(c)?this.style.getFilter(c):null}setPaintProperty(c,i,o,u={}){return this._isValidId(c)?(this.style.setPaintProperty(c,i,o,u),this._update(!0)):this}getPaintProperty(c,i){return this._isValidId(c)?this.style.getPaintProperty(c,i):null}setLayoutProperty(c,i,o,u={}){return this._isValidId(c)?(this.style.setLayoutProperty(c,i,o,u),this._update(!0)):this}getLayoutProperty(c,i){return this._isValidId(c)?this.style.getLayoutProperty(c,i):null}getConfigProperty(c,i){return this.style.getConfigProperty(c,i)}setConfigProperty(c,i,o){return this.style.setConfigProperty(c,i,o),this._update(!0)}setLights(c){if(this._lazyInitEmptyStyle(),c&&c.length===1&&c[0].type==="flat"){const i=c[0];i.properties?this.style.setFlatLight(i.properties,i.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(c),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const c=this.style.getLights()||[];return c.length===0&&c.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),c}setLight(c,i={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:c}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(c){return this._lazyInitEmptyStyle(),!c&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(c),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(c){return this._lazyInitEmptyStyle(),this.style.setFog(c),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setCamera(c){return this.style.setCamera(c),this._triggerCameraUpdate(c)}_triggerCameraUpdate(c){return this._update(this.transform.setOrthographicProjectionAtLowPitch(c["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(c){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(s.bn.convert(c),this.transform):0}setFeatureState(c,i){return this._isValidId(c.source)?(this.style.setFeatureState(c,i),this._update()):this}removeFeatureState(c,i){return this._isValidId(c.source)?(this.style.removeFeatureState(c,i),this._update()):this}getFeatureState(c){return this._isValidId(c.source)?this.style.getFeatureState(c):null}_updateContainerDimensions(){if(!this._container)return;const c=this._container.getBoundingClientRect().width||400,i=this._container.getBoundingClientRect().height||300;let o,u,d,p=this._container;for(;p&&(!u||!d);){const g=window.getComputedStyle(p).transform;g&&g!=="none"&&(o=g.match(/matrix.*\((.+)\)/)[1].split(", "),o[0]&&o[0]!=="0"&&o[0]!=="1"&&(u=o[0]),o[3]&&o[3]!=="0"&&o[3]!=="1"&&(d=o[3])),p=p.parentElement}this._containerWidth=u?Math.abs(c/u):c,this._containerHeight=d?Math.abs(i/d):i}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&s.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const c=this._container;c.classList.add("mapboxgl-map"),(this._missingCSSCanary=_e("div","mapboxgl-canary",c)).style.visibility="hidden",this._detectMissingCSS();const i=this._canvasContainer=_e("div","mapboxgl-canvas-container",c);this._canvas=_e("canvas","mapboxgl-canvas",i),this._interactive&&(i.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const o=this._controlContainer=_e("div","mapboxgl-control-container",c),u=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(d=>{u[d]=_e("div",`mapboxgl-ctrl-${d}`,o)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(c,i){const o=s.f.devicePixelRatio||1;this._canvas.width=o*Math.ceil(c),this._canvas.height=o*Math.ceil(i),this._canvas.style.width=`${c}px`,this._canvas.style.height=`${i}px`}_addMarker(c){this._markers.push(c)}_removeMarker(c){const i=this._markers.indexOf(c);i!==-1&&this._markers.splice(i,1)}_addPopup(c){this._popups.push(c)}_removePopup(c){const i=this._popups.indexOf(c);i!==-1&&this._popups.splice(i,1)}_setupPainter(){const c=s.e({},ae.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),i=this._canvas.getContext("webgl2",c);i?(s.db(i,!0),this.painter=new jd(i,this._contextCreateOptions,this.transform,this._tp),this.on("data",o=>{o.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),s.dc.testSupport(i)):this.fire(new s.a(new Error("Failed to initialize WebGL")))}_contextLost(c){c.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new s.b("webglcontextlost",{originalEvent:c}))}_contextRestored(c){this._setupPainter(),this.resize(),this._update(),this.fire(new s.b("webglcontextrestored",{originalEvent:c}))}_onMapScroll(c){if(c.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(c){return this.style?(this._styleDirty=this._styleDirty||c,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(c){return this._update(),this._renderTaskQueue.add(c)}_cancelRenderFrame(c){this._renderTaskQueue.remove(c)}_requestDomTask(c){!this.loaded()||this.loaded()&&!this.isMoving()?c():this._domRenderTaskQueue.add(c)}_render(c){let i;this.fire(new s.b("renderstart"));const o=this.painter.context.extTimerQuery,u=s.f.now(),d=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(i=d.createQuery(),d.beginQuery(o.TIME_ELAPSED_EXT,i)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(c),this._domRenderTaskQueue.run(c),this._removed)return;this._updateProjectionTransition();const p=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const w=this.transform.zoom,M=this.transform.pitch,I=s.f.now(),S=new s.K(w,{now:I,fadeDuration:p,pitch:M,transition:this.style.transition});this.style.update(S)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let g=!1;if(this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),g=this._updateAverageElevation(u),this.style.updateSources(this.transform),this._forceMarkerAndPopupUpdate()):g=this._updateAverageElevation(u),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,p,this._crossSourceCollisions),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries||this._debugParams.showTileBoundaries,showParseStatus:this.showParseStatus||this._debugParams.showParseStatus,wireframe:{terrain:this.showTerrainWireframe||this._debugParams.showTerrainWireframe,layers2D:this.showLayers2DWireframe||this._debugParams.showLayers2DWireframe,layers3D:this.showLayers3DWireframe||this._debugParams.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector||this._debugParams.showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs||this._debugParams.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:p,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding||this._debugParams.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new s.b("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,this.fire(new s.b("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),i){const w=s.f.now()-u;d.endQuery(o.TIME_ELAPSED_EXT),setTimeout(()=>{const M=d.getQueryParameter(i,d.QUERY_RESULT)/1e6;d.deleteQuery(i),this.fire(new s.b("gpu-timing-frame",{cpuTime:w,gpuTime:M}))},50)}if(this.listens("gpu-timing-layer")){const w=this.painter.collectGpuTimers();setTimeout(()=>{const M=this.painter.queryGpuTimers(w);this.fire(new s.b("gpu-timing-layer",{layerTimes:M}))},50)}if(this.listens("gpu-timing-deferred-render")){const w=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{const M=this.painter.queryGpuTimeDeferredRender(w);this.fire(new s.b("gpu-timing-deferred-render",{gpuTime:M}))},50)}const v=this._sourcesDirty||this._styleDirty||this._placementDirty||g;if(v||this._repaint)this.triggerRepaint();else{const w=!this.isMoving()&&this.loaded();if(w&&(g=this._updateAverageElevation(u,!0)),g)this.triggerRepaint();else if(this._triggerFrame(!1),w&&(this.fire(new s.b("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const M=this._calculateSpeedIndex();this.fire(new s.b("speedindexcompleted",{speedIndex:M})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||v||(this._fullyLoaded=!0,this._performanceMetricsCollection&&s.dd(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(c){for(const i of this._markers)c&&!this.getRenderWorldCopies()&&(i._lngLat=i._lngLat.wrap()),i._update();for(const i of this._popups)!c||this.getRenderWorldCopies()||i._trackPointer||(i._lngLat=i._lngLat.wrap()),i._update()}_updateAverageElevation(c,i=!1){const o=d=>(this.transform.averageElevation=d,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&o(0);const u=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(u||(i||c-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(c)){const d=this.transform.averageElevation;let p=this.transform.sampleAverageElevation();this.transform.elevation&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(p)?p=0:this._averageElevationLastSampledAt=c;const g=Math.abs(d-p);if(g>1){if(this._isInitialLoad||u)return this._averageElevation.jumpTo(p),o(p);this._averageElevation.easeTo(p,c,300)}else if(g>1e-4)return this._averageElevation.jumpTo(p),o(p)}return!!this._averageElevation.isEasing(c)&&o(this._averageElevation.getValue(c))}_authenticate(){s.de(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,c=>{if(c&&(c.message===s.df||c.status===401)){const i=this.painter.context.gl;s.db(i,!1),this._logoControl instanceof Qd&&this._logoControl._updateLogo(),i&&i.clear(i.DEPTH_BUFFER_BIT|i.COLOR_BUFFER_BIT|i.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new s.a(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),s.dg(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_updateTerrain(){const c=this._isDragging();this.painter.updateTerrain(this.style,c)}_calculateSpeedIndex(){const c=this.painter.canvasCopy(),i=this.painter.getCanvasCopiesAndTimestamps();i.timeStamps.push(performance.now());const o=this.painter.context.gl,u=o.createFramebuffer();function d(p){o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,p,0);const g=new Uint8Array(o.drawingBufferWidth*o.drawingBufferHeight*4);return o.readPixels(0,0,o.drawingBufferWidth,o.drawingBufferHeight,o.RGBA,o.UNSIGNED_BYTE,g),g}return o.bindFramebuffer(o.FRAMEBUFFER,u),this._canvasPixelComparison(d(c),i.canvasCopies.map(d),i.timeStamps)}_canvasPixelComparison(c,i,o){let u=o[1]-o[0];const d=c.length/4;for(let p=0;p<i.length;p++){const g=i[p];let v=0;for(let w=0;w<g.length;w+=4)g[w]===c[w]&&g[w+1]===c[w+1]&&g[w+2]===c[w+2]&&g[w+3]===c[w+3]&&(v+=1);u+=(o[p+2]-o[p+1])*(1-v/d)}return u}remove(){this._hash&&this._hash.remove();for(const i of this._controls)i.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const c=this.painter.context.gl.getExtension("WEBGL_lose_context");c&&c.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),s.dh(this.painter.context.gl),s.di.remove(),s.dj.remove(),this._removed=!0,this.fire(new s.b("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(c){this._renderNextFrame=this._renderNextFrame||c,this.style&&!this._frame&&(this._frame=s.f.frame(i=>{const o=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,o&&this._render(i)}))}_preloadTiles(c){const i=this.style?Object.values(this.style._sourceCaches):[];return s.b1(i,(o,u)=>o._preloadTiles(c,u),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(c){this._trackResize&&this.resize({originalEvent:c})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(c){this._showTileBoundaries!==c&&(this._showTileBoundaries=c,this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(c){this._showParseStatus!==c&&(this._showParseStatus=c,this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(c){this._showTerrainWireframe!==c&&(this._showTerrainWireframe=c,this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(c){this._showLayers2DWireframe!==c&&(this._showLayers2DWireframe=c,this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(c){this._showLayers3DWireframe!==c&&(this._showLayers3DWireframe=c,this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(c){this._speedIndexTiming!==c&&(this._speedIndexTiming=c,this._update())}get showPadding(){return!!this._showPadding}set showPadding(c){this._showPadding!==c&&(this._showPadding=c,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(c){this._showCollisionBoxes!==c&&(this._showCollisionBoxes=c,c?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(c){this._showOverdrawInspector!==c&&(this._showOverdrawInspector=c,this._update())}get repaint(){return!!this._repaint}set repaint(c){this._repaint!==c&&(this._repaint=c,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(c){this._vertices=c,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(c){this._showTileAABBs!==c&&(this._showTileAABBs=c,c&&this._update())}_setCacheLimits(c,i){s.dl(c,i)}get version(){return s.dk}},NavigationControl:class{constructor(c){this.options=s.e({},pc,c),this._container=_e("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",i=>i.preventDefault()),this.options.showZoom&&(s.aY(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",i=>{this._map&&this._map.zoomIn({},{originalEvent:i})}),_e("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",i=>{this._map&&this._map.zoomOut({},{originalEvent:i})}),_e("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(s.aY(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",i=>{const o=this._map;o&&(this.options.visualizePitch?o.resetNorthPitch({},{originalEvent:i}):o.resetNorth({},{originalEvent:i}))}),this._compassIcon=_e("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const c=this._map;if(!c)return;const i=c.getZoom(),o=i===c.getMaxZoom(),u=i===c.getMinZoom();this._zoomInButton.disabled=o,this._zoomOutButton.disabled=u,this._zoomInButton.setAttribute("aria-disabled",o.toString()),this._zoomOutButton.setAttribute("aria-disabled",u.toString())}_rotateCompassArrow(){const c=this._map;if(!c)return;const i=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(c.transform.pitch*(Math.PI/180)),.5)}) rotateX(${c.transform.pitch}deg) rotateZ(${c.transform.angle*(180/Math.PI)}deg)`:`rotate(${c.transform.angle*(180/Math.PI)}deg)`;c._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=i)})}onAdd(c){return this._map=c,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),c.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&c.on("pitch",this._rotateCompassArrow),c.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new bo(c,this._compass,this.options.visualizePitch)),this._container}onRemove(){const c=this._map;c&&(this._container.remove(),this.options.showZoom&&c.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&c.off("pitch",this._rotateCompassArrow),c.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(c,i){const o=_e("button",c,this._container);return o.type="button",o.addEventListener("click",i),o}_setButtonTitle(c,i){if(!this._map)return;const o=this._map._getUIString(`NavigationControl.${i}`);c.setAttribute("aria-label",o),c.firstElementChild&&c.firstElementChild.setAttribute("title",o)}},GeolocateControl:class extends s.E{constructor(c){super();const i=navigator.geolocation;this.options=s.e({geolocation:i},mc,c),s.aY(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=il(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(c){return this._map=c,this._container=_e("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(c){const i=(o=!!this.options.geolocation)=>{this._supportsGeolocation=o,c(o)};this._supportsGeolocation!==void 0?c(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then(o=>i(o.state!=="denied")).catch(()=>i()):i()}_isOutOfMapMaxBounds(c){const i=this._map.getMaxBounds(),o=c.coords;return!!i&&(o.longitude<i.getWest()||o.longitude>i.getEast()||o.latitude<i.getSouth()||o.latitude>i.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(c){if(this._map){if(this._isOutOfMapMaxBounds(c))return this._setErrorState(),this.fire(new s.b("outofmaxbounds",c)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=c,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(c),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(c),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new s.b("geolocate",c)),this._finish()}}_updateCamera(c){const i=new s.bn(c.coords.longitude,c.coords.latitude),o=c.coords.accuracy,u=this._map.getBearing(),d=s.e({bearing:u},this.options.fitBoundsOptions);this._map.fitBounds(i.toBounds(o),d,{geolocateSource:!0})}_updateMarker(c){if(c){const i=new s.bn(c.coords.longitude,c.coords.latitude);this._accuracyCircleMarker.setLngLat(i).addTo(this._map),this._userLocationDotMarker.setLngLat(i).addTo(this._map),this._accuracy=c.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const c=this._map.transform,i=s.bl(1,c._center.lat)*c.worldSize,o=Math.ceil(2*this._accuracy*i);this._circleElement.style.width=`${o}px`,this._circleElement.style.height=`${o}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(c){if(this._map){if(this.options.trackUserLocation)if(c.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const i=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",i),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",i),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(c.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new s.b("error",c)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(c){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",i=>i.preventDefault()),this._geolocateButton=_e("button","mapboxgl-ctrl-geolocate",this._container),_e("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",c===!1){s.w("Geolocation support is not available so the GeolocateControl will be disabled.");const i=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",i),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",i)}else{const i=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",i),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",i)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=_e("div","mapboxgl-user-location"),this._dotElement.appendChild(_e("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(_e("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new _h({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=_e("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new _h({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",i=>{i.geolocateSource||this._watchState!=="ACTIVE_LOCK"||i.originalEvent&&i.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new s.b("trackuserlocationend")))})}}_onDeviceOrientation(c){this._userLocationDotMarker&&(c.webkitCompassHeading?this._heading=c.webkitCompassHeading:c.absolute===!0&&(this._heading=-1*c.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return s.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new s.b("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new s.b("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new s.b("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let c;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(c={maximumAge:6e5,timeout:0},this._noTimeout=!0):(c=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,c),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const c=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(i=>{i==="granted"&&c()}).catch(console.error):c()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:mh,ScaleControl:class{constructor(c){this.options=s.e({},Hi,c),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),s.aY(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const c=this.options.maxWidth||100,i=this._map,o=i._containerHeight/2,u=i._containerWidth/2-c/2,d=i.unproject([u,o]),p=i.unproject([u+c,o]),g=d.distanceTo(p);if(this.options.unit==="imperial"){const v=3.2808*g;v>5280?this._setScale(c,v/5280,"mile"):this._setScale(c,v,"foot")}else this.options.unit==="nautical"?this._setScale(c,g/1852,"nautical-mile"):g>=1e3?this._setScale(c,g/1e3,"kilometer"):this._setScale(c,g,"meter")}_setScale(c,i,o){this._map._requestDomTask(()=>{const u=function(p){const g=Math.pow(10,`${Math.floor(p)}`.length-1);let v=p/g;return v=v>=10?10:v>=5?5:v>=3?3:v>=2?2:v>=1?1:function(w){const M=Math.pow(10,Math.ceil(-Math.log(w)/Math.LN10));return Math.round(w*M)/M}(v),g*v}(i),d=u/i;this._container.innerHTML=this._isNumberFormatSupported&&o!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:o}).format(u):`${u}&nbsp;${Qo[o]}`,this._container.style.width=c*d+"px"})}onAdd(c){return this._map=c,this._language=c.getLanguage(),this._container=_e("div","mapboxgl-ctrl mapboxgl-ctrl-scale",c.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(c){this._language=c,this._update()}setUnit(c){this.options.unit=c,this._update()}},FullscreenControl:class{constructor(c){this._fullscreen=!1,c&&c.container&&(c.container instanceof HTMLElement?this._container=c.container:s.w("Full screen control 'container' must be a DOM element.")),s.aY(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(c){return this._map=c,this._container||(this._container=this._map.getContainer()),this._controlContainer=_e("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",s.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const c=this._fullscreenButton=_e("button","mapboxgl-ctrl-fullscreen",this._controlContainer);_e("span","mapboxgl-ctrl-icon",c).setAttribute("aria-hidden","true"),c.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const c=this._getTitle();this._fullscreenButton.setAttribute("aria-label",c),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",c)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends s.E{constructor(c){super(),this.options=s.e(Object.create(tf),c),s.aY(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(c&&c.className?c.className.trim().split(/\s+/):[])}addTo(c){return this._map&&this.remove(),this._map=c,this.options.closeOnClick&&c.on("preclick",this._onClose),this.options.closeOnMove&&c.on("move",this._onClose),c.on("remove",this.remove),this._update(),c._addPopup(this),this._focusFirstElement(),this._trackPointer?(c.on("mousemove",this._onMouseEvent),c.on("mouseup",this._onMouseEvent),c._canvasContainer.classList.add("mapboxgl-track-pointer")):c.on("move",this._update),this.fire(new s.b("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const c=this._map;return c&&(c.off("move",this._update),c.off("move",this._onClose),c.off("preclick",this._onClose),c.off("click",this._onClose),c.off("remove",this.remove),c.off("mousemove",this._onMouseEvent),c.off("mouseup",this._onMouseEvent),c.off("drag",this._onMouseEvent),c._canvasContainer&&c._canvasContainer.classList.remove("mapboxgl-track-pointer"),c._removePopup(this),this._map=void 0),this.fire(new s.b("close")),this}getLngLat(){return this._lngLat}setLngLat(c){this._lngLat=s.bn.convert(c),this._pos=null,this._trackPointer=!1,this._update();const i=this._map;return i&&(i.on("move",this._update),i.off("mousemove",this._onMouseEvent),i._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const c=this._map;return c&&(c.off("move",this._update),c.on("mousemove",this._onMouseEvent),c.on("drag",this._onMouseEvent),c._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(c){return this.setDOMContent(document.createTextNode(c))}setHTML(c){const i=document.createDocumentFragment(),o=document.createElement("body");let u;for(o.innerHTML=c;u=o.firstChild,u;)i.appendChild(u);return this.setDOMContent(i)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(c){return this.options.maxWidth=c,this._update(),this}setDOMContent(c){let i=this._content;if(i)for(;i.hasChildNodes();)i.firstChild&&i.removeChild(i.firstChild);else i=this._content=_e("div","mapboxgl-popup-content",this._container||void 0);if(i.appendChild(c),this.options.closeButton){const o=this._closeButton=_e("button","mapboxgl-popup-close-button",i);o.type="button",o.setAttribute("aria-label","Close popup"),o.setAttribute("aria-hidden","true"),o.innerHTML="&#215;",o.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(c){return this._classList.add(c),this._updateClassList(),this}removeClassName(c){return this._classList.delete(c),this._updateClassList(),this}setOffset(c){return this.options.offset=c,this._update(),this}toggleClassName(c){let i;return this._classList.delete(c)?i=!1:(this._classList.add(c),i=!0),this._updateClassList(),i}_onMouseEvent(c){this._update(c.point)}_getAnchor(c){if(this.options.anchor)return this.options.anchor;const i=this._map,o=this._container,u=this._pos;if(!i||!o||!u)return"bottom";const d=o.offsetWidth,p=o.offsetHeight,g=u.x<d/2,v=u.x>i.transform.width-d/2;if(u.y+c<p)return g?"top-left":v?"top-right":"top";if(u.y>i.transform.height-p){if(g)return"bottom-left";if(v)return"bottom-right"}return g?"left":v?"right":"bottom"}_updateClassList(){const c=this._container;if(!c)return;const i=[...this._classList];i.push("mapboxgl-popup"),this._anchor&&i.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&i.push("mapboxgl-popup-track-pointer"),c.className=i.join(" ")}_update(c){const i=this._map,o=this._content;if(!i||!this._lngLat&&!this._trackPointer||!o)return;let u=this._container;if(u||(u=this._container=_e("div","mapboxgl-popup",i.getContainer()),this._tip=_e("div","mapboxgl-popup-tip",u),u.appendChild(o)),this.options.maxWidth&&u.style.maxWidth!==this.options.maxWidth&&(u.style.maxWidth=this.options.maxWidth),i.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=pl(this._lngLat,this._pos,i.transform)),!this._trackPointer||c){const d=this._pos=this._trackPointer&&c?c:i.project(this._lngLat),p=nf(this.options.offset),g=this._anchor=this._getAnchor(p.y),v=nf(this.options.offset,g),w=d.add(v).round();i._requestDomTask(()=>{this._container&&g&&(this._container.style.transform=`${fc[g]} translate(${w.x}px,${w.y}px)`)})}if(!this._marker&&i._showingGlobe()){const d=s.d6(i.transform,this._lngLat)?0:1;this._setOpacity(d)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const c=this._container.querySelector(rf);c&&c.focus()}_onClose(){this.remove()}_setOpacity(c){this._container&&(this._container.style.opacity=`${c}`),this._content&&(this._content.style.pointerEvents=c?"auto":"none")}},Marker:_h,Style:Zn,LngLat:s.bn,LngLatBounds:s.ad,Point:s.P,MercatorCoordinate:s.L,FreeCameraOptions:Ua,Evented:s.E,config:s.d5,prewarm:s.dp,clearPrewarmedResources:s.dq,get accessToken(){return s.d5.ACCESS_TOKEN},set accessToken(c){s.d5.ACCESS_TOKEN=c},get baseApiUrl(){return s.d5.API_URL},set baseApiUrl(c){s.d5.API_URL=c},get workerCount(){return s.dr.workerCount},set workerCount(c){s.dr.workerCount=c},get maxParallelImageRequests(){return s.d5.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(c){s.d5.MAX_PARALLEL_IMAGE_REQUESTS=c},clearStorage(c){s.ds(c)},get workerUrl(){return s.dt.workerUrl},set workerUrl(c){s.dt.workerUrl=c},get workerClass(){return s.dt.workerClass},set workerClass(c){s.dt.workerClass=c},get workerParams(){return s.dt.workerParams},set workerParams(c){s.dt.workerParams=c},get dracoUrl(){return s.du()},set dracoUrl(c){s.dv(c)},get meshoptUrl(){return s.dw()},set meshoptUrl(c){s.dx(c)},setNow:s.f.setNow,restoreNow:s.f.restoreNow}});var ee=Z;return ee})})(Wv);var yP=Wv.exports;const O_=gP(yP);var xP=zl('<div><div id="map" class="svelte-ahycl4"></div> <button class="reset-button svelte-ahycl4">Reset Map</button></div>');function vP(y,E){Pa(E,!1),O_.accessToken="pk.eyJ1Ijoic2VqYWxnIiwiYSI6ImNsdmN0Y21yZTBubmgydmxmNDlmbHVuMXAifQ.G5QWdSQskLQRC0Dw0nYLVw";let A;var L=null,k=ks(E,"zipcode",4,null);const Z=[-71.0589,42.3601],Y=11;Pp(async()=>{A=new O_.Map({container:"map",style:"mapbox://styles/mapbox/streets-v11",center:Z,zoom:Y});const se="/boston-cambridge-zip-codes.geojson",fe=await wp("/lat_long_address.csv");A.on("load",async function(){A.addSource("zip-codes",{type:"geojson",data:se}),A.addLayer({id:"polygons",type:"fill",source:"zip-codes",paint:{"fill-color":["case",["boolean",["feature-state","clicked"],!1],"#949494","#d3d3d3"],"fill-opacity":.8,"fill-outline-color":"#000000"}});const _e={type:"FeatureCollection",features:fe.map(qe=>({type:"Feature",properties:{zipcode:qe["ZIPCODE post (group)"]},geometry:{type:"Point",coordinates:[parseFloat(qe.Longitude),parseFloat(qe.Latitude)]}}))};A.addSource("locations",{type:"geojson",data:_e}),A.addLayer({id:"points",type:"circle",source:"locations",paint:{"circle-radius":6,"circle-color":"#000000","circle-opacity":.4},filter:["==",["get","zipcode"],""]}),A.on("click","polygons",qe=>{let nt=qe.features[0],xt=nt.id;L!==null&&L!==xt&&A.setFeatureState({source:"zip-codes",id:L},{clicked:!1}),A.setFeatureState({source:"zip-codes",id:xt},{clicked:!0}),L=xt,k("0"+L.toString()),A.setFilter("points",["==",["get","zipcode"],k()]);const lt=new O_.LngLatBounds;nt.geometry.coordinates[0].forEach($e=>{lt.extend($e)}),A.fitBounds(lt,{padding:20})})})});function ee(){A.setCenter(Z),A.setZoom(Y),L!==null&&A.setFeatureState({source:"zip-codes",id:L},{clicked:!1}),A.setFilter("points",["==",["get","zipcode"],""]),L=null,k(null)}Aa();var s=Ca(y,!0,xP),te=Os(s),ae=Di(Di(te,!0));B_("click",ae,ee,!1),Ia(y,s),Sa()}var bP=zl('<blockquote scrolly-container="">Through our interactive visualization, we invite you to explore the impact of condo conversions on your community.<br> <newline></newline> Click a greater Boston zip code region on the map to see the impact of condo conversions on the area:</blockquote> <!> <!> <!> <!> <!>',!0);function AP(y,E){Pa(E,!1);const A={};LE(A);const L=()=>zE(k,"$zipcode",A);ld(Zv);let k=OE("");Aa();var Z=J_(y,!0,bP);SE(fe=>{PE.title="Condo Conversions in Greater Boston "});var Y=Q_(Z),ee=Di(Di(Y,!0)),s=Di(Di(ee,!0)),te=Di(Di(s,!0)),ae=Di(Di(te,!0)),se=Di(Di(ae,!0));vP(ee,{class:"graph-container",get zipcode(){return L()},set zipcode(fe){DE(k,fe)}}),oP(s,{class:"graph-container",get query(){return L()}}),mP(te,{class:"graph-container",get query(){return L()}}),cP(ae,{class:"graph-container",get query(){return L()}}),aP(se,{class:"graph-container",get query(){return L()}}),Sp(y,Z),Sa()}export{AP as component};
